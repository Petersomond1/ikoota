<!DOCTYPE html>
<html>
<head>
    <title>Live Frontend API Call Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        .info { background: #d1ecf1; }
        .warning { background: #fff3cd; }
        iframe { width: 100%; height: 400px; border: 1px solid #ccc; margin: 10px 0; }
        textarea { width: 100%; height: 300px; font-family: monospace; }
    </style>
</head>
<body>
    <h1>üîç Live Frontend API Call Analysis</h1>
    <p>This tests what API calls the live frontend is actually making</p>

    <div>
        <button onclick="testLiveSite()">Test Live Site API Calls</button>
        <button onclick="testLogin()">Test Production Login</button>
        <button onclick="testNetworkInspection()">Inspect Network Calls</button>
    </div>

    <div id="results"></div>

    <h3>üì° Network Inspection</h3>
    <p>Open browser dev tools (F12) and watch the Network tab while clicking the buttons above.</p>
    <div id="networkInfo" class="info">
        <strong>What to look for in Network tab:</strong><br>
        1. API calls going to https://api.ikoota.com:8443 (correct) or https://api.ikoota.com:3000 (incorrect)<br>
        2. Authentication requests with JWT tokens<br>
        3. Any failed requests (red entries)<br>
        4. Response payloads missing converse_id
    </div>

    <h3>üåê Live Site Frame (Check Console)</h3>
    <iframe id="liveSiteFrame" src="https://www.ikoota.com/login"></iframe>

    <h3>üìù Test Results</h3>
    <textarea id="results-data" placeholder="Test results and network inspection notes..."></textarea>

    <script>
        const results = document.getElementById('results');
        const resultsData = document.getElementById('results-data');

        function addResult(type, message) {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            results.appendChild(div);

            resultsData.value += `[${new Date().toLocaleTimeString()}] ${message}\n`;
        }

        async function testLiveSite() {
            addResult('info', 'üåê Testing live site accessibility...');

            try {
                // Test if we can reach the live site
                const response = await fetch('https://www.ikoota.com/', {
                    mode: 'no-cors' // Avoid CORS issues
                });
                addResult('success', '‚úÖ Live site is accessible');
            } catch (error) {
                addResult('error', `‚ùå Live site error: ${error.message}`);
            }

            // Test API directly
            try {
                const apiResponse = await fetch('https://api.ikoota.com:8443/api/health');
                if (apiResponse.ok) {
                    addResult('success', '‚úÖ API is responding on port 8443');
                } else {
                    addResult('error', `‚ùå API responded with status: ${apiResponse.status}`);
                }
            } catch (error) {
                addResult('error', `‚ùå API connection error: ${error.message}`);
            }
        }

        async function testLogin() {
            addResult('info', 'üîê Testing production login...');

            try {
                const response = await fetch('https://api.ikoota.com:8443/api/auth/enhanced-login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'petersomond@gmail.com',
                        password: 'abc123'
                    })
                });

                const data = await response.json();

                if (response.ok && data.token) {
                    addResult('success', '‚úÖ Login successful');

                    // Check JWT payload
                    try {
                        const payload = JSON.parse(atob(data.token.split('.')[1]));
                        if (payload.converse_id) {
                            addResult('success', `‚úÖ JWT contains converse_id: ${payload.converse_id}`);
                        } else {
                            addResult('error', '‚ùå JWT missing converse_id field');
                        }

                        resultsData.value += `\nJWT Payload: ${JSON.stringify(payload, null, 2)}\n`;

                    } catch (err) {
                        addResult('error', '‚ùå Failed to decode JWT');
                    }

                } else {
                    addResult('error', `‚ùå Login failed: ${data.message || 'Unknown error'}`);
                }

            } catch (error) {
                addResult('error', `‚ùå Login request error: ${error.message}`);
            }
        }

        function testNetworkInspection() {
            addResult('info', 'üì° Starting network inspection...');
            addResult('warning', '‚ö†Ô∏è Open browser DevTools (F12) ‚Üí Network tab');
            addResult('info', 'üîç Now interact with the live site in the iframe below');

            // Reload the iframe to trigger fresh network calls
            const iframe = document.getElementById('liveSiteFrame');
            iframe.src = iframe.src;

            addResult('info', 'üìã Check Network tab for:');
            addResult('info', '  ‚Ä¢ API calls to :8443 vs :3000');
            addResult('info', '  ‚Ä¢ Failed requests (red entries)');
            addResult('info', '  ‚Ä¢ Authentication token content');
        }

        // Instructions for user
        window.onload = () => {
            addResult('info', 'üöÄ Page loaded. Use buttons above to test different aspects.');
            addResult('warning', '‚ö†Ô∏è Open DevTools (F12) to inspect network calls');
        };
    </script>
</body>
</html>