# React + Vite

This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.

Currently, two official plugins are available:

- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react/README.md) uses [Babel](https://babeljs.io/) for Fast Refresh
- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh


admin-user
username=yahoomond
password=abc123
email=peters_o_mond@yahoo.com

super-admin-user
username=pet
password=abc123
email=petersomond@gmail.com

user
username=abc
password=abc123
email=abc@abc.com 

To find your public IP:   curl ifconfig.me

Test Connection aws RDS mysql db
You can test the connection from your terminal using the MySQL CLI:  mysql -h <RDS_ENDPOINT> -u <DB_USER> -p
Replace <RDS_ENDPOINT>, <DB_USER>, and enter your password when prompted. If this works, your AWS RDS setup is okay. If not:



ping ikoota-db.cvugpfnl4vcp.us-east-1.rds.amazonaws.com    (ping success)


users membership application/signup process.
membership with pending, granted, declined
it will start with 'applied' for moments when new user signs up with profile (email, phone and username) upto their submitting of a pre-requisite survey, till moment of is_member granted/approved or declined. it will be the admin that will vet the survey result/answer submitted by the applicant before decision for is_member granted or declined. 

At this stage of admin granting or declining membership from applicants, admin also have to create some properties or previledges for the user. (1) create a 6-digit alphanumeric letters and avatar that they will henceforth use in place of their profile for all open communication and messages/chats. (2) place user under a mentor by putting the mentor's id into their new user'd profile (a column for mentor 6-digit alphanumeric id#). (3) place the new user in a special demographic class (like classroom or like subject of study in a regular school system). This class is going to be synonymous to the 'audience' that the user can have internal communication/chats with apart from the general communication class which will feature in 'audience' for posting content/chat/messages. I propose that all these three properties will each have a column in the user's table and each of this column will have the three options that admin will need to choose or flip into. while for those applicants that are declined, their column will merely be filled will straight zeros (000000) as nil/null.

Now more about the converse Id system, mentorship system and users classes (audience for posting messages/chat) system.

converse Id system.
upon moment of membership granted, user profile (name/username, email and phone) will be encoded and the real names expunged from the system into an external record system. so a special encoding logic will be needed to convert the profile (email, phone, username and avatar) into a converse 6-digit alphanumeric letters and avatar that will thenceoforth be used for user identification or profile. It will only be the system that can decode/reveal the original id/profile when needed to relate with the real user. So, this is going to be a converse identity system from the moment membership is granted.
every user will have a permanent 6-digit alphanumeric id that will be used in place of their username from the moment membership is granted.

mentorship system.
Every user will have a mentor whose real id might not be known to them. but the mentors will know their mentee
So, user will be placed in a heirachical mentorship system from the moment membership is granted.

content approval
When a content/presentation is posted by a user, there should be content approval step as an admin vetting of the content before contents (messages/presentations) is allowed for public view. meaning every presentation/content posted with 'audience' as 'general'  will remain pending status and notification sent to admin for approval. whereas those posting to individual class or to idividual with will go striaght without approval of an admin. 
....... status` enum('pending','approved','rejected') DEFAULT 'pending',

users classes = audience for messages/chats
users will have a demographic sub-division to be known as classes. This classes will create opportunity for 
messages/chats to have specific audiences within the body of users and general/public as audience for all.

Explanation of Schema

    auth table:
    no need for auth table as all about authentication will be incorporated into columns of the user table.
    
    users table:
        Register, login, update profile, upload avatar to S3.
        Add a is_member column. with status` enum('applied','granted','declined') DEFAULT 'applied',
        Use AWS SDK or @aws-sdk/client-s3 for S3 interactions.
        Contains user profiles and blocking functionality.
        blocked is a JSON array storing IDs of users that a particular user has blocked.
        Add a is_banned column to flag banned users.
        Add a role column. `role` enum('admin','user') DEFAULT 'user',
        Add a class column: moment membership approval is granted, a user will be placed in a specific class.
        ....with 000000(nil_class) for users pending membership and 6-alphanumeric letters used to id class that will be listed out.
        Add a mentor column. to show the id of mentor for every user/mentee.

    chats table:
        Represents a unique chat session (1-to-1 or group chat).
        Create chat sessions.
        Fetch user chats.

    messages table:
        Holds all messages, including media references stored in S3.
        Send and retrieve messages.
        Integrate media uploads to S3 for images, videos, etc.
        Add a is_flagged column for admin-reviewed messages.

    user_chats table:
        Manage metadata for chats (e.g., last message, seen status).
        Links users to chats and includes metadata like the last message and its status.

    admins table:
        Implement admin functionalities

    reports table:
        Implement reporting functionalities

    audit_logs:
        Add audit logging in admin-related actions (e.g., ban user, delete chat).





RESTful API Endpoints

Users

    POST /users - Register a new user.
    GET /users/:id - Fetch user details.
    PUT /users/:id - Update user details (e.g., avatar, username).
    GET /users/:id/block - List blocked users.
    POST /users/:id/block - Block a user.
    DELETE /users/:id/block - Unblock a user.


Chats

    POST /chats - Create a new chat session.
    GET /chats/:chatId - Fetch chat details and participants.
    GET /users/:id/chats - Fetch all chats for a user.
    GET /chats/:id: Get details of a specific chat.
    GET /chats: List all chats the user is a member of.
    PATCH /chats/:id: Update chat details (e.g., group name).
    DELETE /chats/:id: Delete a chat (admin only).

Messages

    POST /messages - Send a new message (text/media).
    GET /messages/:chatId - Fetch/Retrieve all messages in a chat.
    GET /messages/:id: Retrieve a specific message.
    PATCH /messages/:id: Edit a message (if allowed).
    DELETE /messages/:id - Delete a message.

UserChats

    POST /user-chats: Add a user to a chat.
    GET /users/:id/user_chats - Get all chat summaries for a user.
    GET /user-chats/:chat_id: List users in a chat.
    PUT /user_chats/:id - Update chat status (e.g., mark as seen).
    PATCH /user-chats/:id: Update user-chat metadata (e.g., role, mute status).
    DELETE /user-chats/:id: Remove a user from a chat.


Admin Management
Admin Authentication

    POST /admin/login - Admin login to retrieve JWT token.
    POST /admin/logout - Admin logout.

User Management

    GET /admin/users - Fetch all users (with filters: banned, active).
    PUT /admin/users/:id/ban - Ban a user.
    PUT /admin/users/:id/unban - Unban a user.
    DELETE /admin/users/:id - Delete a user (cascades to delete their content).

Chat and Message Management

    GET /admin/chats - Fetch all chats.
    DELETE /admin/chats/:id - Delete a chat.
    GET /admin/messages - Fetch flagged messages.
    PUT /admin/messages/:id/flag - Flag a message as inappropriate.
    DELETE /admin/messages/:id - Delete a message.

Reports

    POST /reports - Report a user, chat, or message (user-side action).
    GET /admin/reports - Fetch all reports (with filters: pending, reviewed).
    PUT /admin/reports/:id/review - Mark a report as reviewed.
    PUT /admin/reports/:id/resolve - Mark a report as resolved.

Audit Logs

    GET /admin/audit-logs - Fetch all audit logs for admin actions (filters: admin_id, date range).


Socket.IO Integration

    Events:
        connect: Initialize user connection.
        join_chat: Join a chat room.
        new_message: Broadcast a new message.
        typing: Notify participants of typing status.
        disconnect: Handle user disconnection.

        report_notification: Notify admins of new reports in real-time.
        user_status_update: Update the admin dashboard when a user is banned/unbanned.
        message_flag_update: Notify admins of flagged messages for immediate action.



S3 folder structure:

        users/avatars/{userId}.jpg
        chats/{chatId}/{messageId}/media.jpg

    
all user signup, login, logout buttons from many pages

admin and system pages Fetch users and contents/messages/chats
Admin Update User properties
Admin present/upload teaching/messages to both front and chat pages.
Admin approve, feature, remove content/messages
Admin ban, unban and grant posting_right (but only admin can post to front and chat, while all users comment/message)
admin reset audience

system display teaching/messages and properties on pages.
users send messages and comments from pages.






Need to know if there's any difference between what developers term as a content, a message and a chat in a typical chatting or teaching app. And if not much, I want the content table and messages table to be merged. and if a message/ content does not have 'title', 'description' or 'media type, the column can be made to be null/nil/000. It should be noted that some messages/content are gonna have more than one media types, so a way to accommodate the media_type to correspond with the media_url for a single message/content having a video and a music and an image urls must be provided.  
I want the column for name in the classes table to contain/store the pre-assigned or designated 6-digit alphanumeric Id-numbers that will double as target "audience" for posting content/messages. 
It should be also noted that comments do contain files or media types with their urls. so accommodation for files and media types/urls should be made in the comments table and if those are not included in a particular comment, the space/column can be nullable.
content table should not have is_public as the column for 'audience' which is target 'class_id' will take care of that as the 'general' class/class_id.
The role column in users table should include a 'super_admin' role for the senior admin that will manage a host of admins. 
consider all of the above, then make and provide adjustments



THe db tables.

1. Users Table

    CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(255) NOT NULL, -- User's full name
    email VARCHAR(255) NOT NULL UNIQUE, -- Email for login
    phone VARCHAR(15) NULL, -- Optional whatsapp phone number
    avatar VARCHAR(255), -- Optional profile image URL to S3
    password_hash VARCHAR(255) NOT NULL, -- Securely hashed password for authentication
    converse_id CHAR(6) UNIQUE, -- 6-digit alphanumeric ID
    mentor_id CHAR(6), -- References another user's converse_id
    class_id INT, -- Foreign key to classes.id
    is_member ENUM('applied', 'granted', 'declined') DEFAULT 'applied',
    role ENUM('super_admin', 'admin', 'user') DEFAULT 'user',  -- Role designation
    blocked JSON DEFAULT '[]', -- Array of blocked user IDs
    is_banned BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (class_id) REFERENCES classes(id) ON DELETE SET NULL
);


2. Classes Table

    CREATE TABLE classes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(6) NOT NULL UNIQUE, -- 6-digit alphanumeric ID for the class
    description TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);


3. Chats Table

    CREATE TABLE chats (
    id VARCHAR(36) PRIMARY KEY,
    is_group BOOLEAN DEFAULT FALSE,
    title VARCHAR(255), -- Optional, for group chats
    created_by VARCHAR(36), -- User ID of creator
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

4. User_Chats Table

   CREATE TABLE user_chats (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL,
    chat_id VARCHAR(36) NOT NULL,
    last_message VARCHAR(255),
    is_seen BOOLEAN DEFAULT FALSE,
    updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (chat_id) REFERENCES chats(id) ON DELETE CASCADE


role: Role of the user in the chat ('admin', 'member', 'owner').
is_muted: Boolean to track if the user has muted the chat.
last_read_message_id: Tracks the last message read by the user for "unread" counts.
joined_at: Timestamp for when the user joined the chat.

   );


5. Messages Table

-- Messages Table
CREATE TABLE messages (
    id INT AUTO_INCREMENT PRIMARY KEY,
    chat_id VARCHAR(36) NOT NULL,
    user_id VARCHAR(36), -- Sender of the message
    class_id INT, -- Target audience for the message
    title VARCHAR(255) NULL, -- Nullable for cases with no title
    summary TEXT NULL, -- Nullable for cases with no description-summary
    text TEXT NOT NULL,-- Text of the message
    approval_status ENUM('pending', 'approved', 'rejected') DEFAULT 'pending',
    media_url1 VARCHAR(255),
    media_type1 ENUM('image', 'video', 'audio', 'file'),
    media_url2 VARCHAR(255),
    media_type2 ENUM('image', 'video', 'audio', 'file'),
    media_url3 VARCHAR(255),
    media_type3 ENUM('image', 'video', 'audio', 'file'),
    is_flagged BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (chat_id) REFERENCES chats(id) ON DELETE CASCADE,
    FOREIGN KEY (class_id) REFERENCES classes(id) ON DELETE SET NULL,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);



6. Comments Table

    CREATE TABLE comments (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL, -- User making the comment
    message_id INT NOT NULL, -- Related message
    comment TEXT NOT NULL, -- Text of the comment
    media_url1 VARCHAR(255) NULL, -- URL for the first media in the comment (if any)
    media_type1 ENUM('image', 'video', 'audio', 'file') DEFAULT NULL, -- Type of the first media
    media_url2 VARCHAR(255) NULL, -- URL for the second media in the comment (if any)
    media_type2 ENUM('image', 'video', 'audio', 'file') DEFAULT NULL, -- Type of the second media
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (message_id) REFERENCES messages(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);


7. Reports Table
   Tracks reports for moderation.

    CREATE TABLE reports (
    id INT AUTO_INCREMENT PRIMARY KEY,
    reporter_id VARCHAR(36) NOT NULL,
    reported_id VARCHAR(36), -- Can be user_id or content_id
    reason TEXT NOT NULL,
    status ENUM('pending', 'reviewed', 'resolved') DEFAULT 'pending',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (reporter_id) REFERENCES users(id) ON DELETE CASCADE
);


8. Audit Logs Table
    Logs admin actions for transparency.

    CREATE TABLE audit_logs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    admin_id VARCHAR(36) NOT NULL,
    action VARCHAR(255) NOT NULL,
    target_id VARCHAR(36), -- User or content ID
    details TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (admin_id) REFERENCES users(id) ON DELETE CASCADE
);

9. surveylog Table
    Logs survey and answers for future reference.

    CREATE TABLE surveylog (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL,
    answers TEXT,
    verified_by VARCHAR(36) NOT NULL,  -- admin_id of the admin that approved
    rating_remarks  VARCHAR(255) NOT NULL,
    approval_status ENUM('pending', 'approved', 'rejected') DEFAULT 'pending',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);





Use of libraries.
- Use `axios` for making HTTP requests.
- Use `@tanstack/react-query` for managing server state, caching, and synchronizing data with your backend.
- Use `zustand` for managing local state in your React application.




Using axios with react-query:
You can use to make HTTP request and react-query to manage the server state.



Iko view-point.
Iko is the inner teaching/presentations and chatting system.
iko view port is partitioned into three layouts.
On the left-side is the listing of the chats/teachings/presentations..it is called chatlists.
On the right-side is the User-chats..that's listing of the chats/teaching that a user have become involved by commenting/signalled to follow.
While at the middle is the main display or render portion of the chatting system. It displays the latest chat/teaching by default, which also tops the listing of the leftside orderly arranged chatlist or these middle render portion display whichever selection that a user makes either from the left side chatlists or from the right side user-chats listings.

The teaching (also called presentation) can be input at the admin page by the admin or at an input terminal that is on the lower portion of the chatting system by the users. That's input of teaching or comments to teaching can be made by regular users at the bottom part of the towncrier viewport. And every of such teaching presentation made by non-admins regular users must be vetted by an Admin before it can go public class audience.
On the right side of the Iko viewport is the user_chats or list of active chats/comments that a user is involved in. It is not every presentation/chat/teaching that a user comments on or follow/watch/tail/track. so those ones that a user have involved on or have signalled to track that becomes the users user_chats are listed on this rightside of the Iko platform viewpoint.

Towncrier Open view port
This is the open home page that is the public teaching broadcast view-port of the website.
the towncrier viewport is divided into two parts; the RevTopic and the RevPresentation.
The RevTopic on the left side like a sidebar has a search bar over its top and displays the list of available presentation/teaching topics in timely order with the latest in topmost position being rendered/displayed by default or a selection amongst the list of topics by clicking render/displays that teaching/presentation on the larger right-hand side portion of the Towncrier screen called RevPresentation.
input of the teaching/presentaion into this open view port of Towncrier occur only from the admin at the Admin page. User cannot make presentation, nor any feedback here. its simply a broadcast screen.

todo list
prepare class_id and provide callup/fetch fxn in admin page

implement approval process of application survey with update on users column.
--fetch survey,update column, generate ID,



Note there are two kinds of teaching/presentation.
Teaching for the open public screen and teaching/presentation otherwise called chats going into the internal membership restricted system.


The content endpoints like in chatservice should be converted to teachings

input teachings to towncrier
--input/upload text, img, vid & emoji. write to s3
--arrange the side of RevTopic list 
--work on the search

input teachings to Iko. ....this is the chat. list of teaching/presentations is the chatlist. 
input comments to a chat/teaching/presentation.

Create Message fetching and saving 

implement username to converse_id in all communication.
--hierachical knowledge. mentor to know mentee, but mentee not to know or identify anyone. user only know mentee

work on profile display page.

properly setup and use socket.io and socket.js

implement search of the topics or summary or texts presnets.


forgot-Password, password-Reset, 

confirm and make sure database in located at the RDS.

use of info messages to alert or as email to user/new user. 

admin controls. ....can go under usermngmt


Abstraction of the real id from the storage system, least it be leaked/hacked. 



 want to also use TowncrierControls.jsx component as place where admin will handle the upload and management of  'teachings'; that will feature as teaching presentation in Towncrier.jsx and also feature as a part of Chat in iko.jsx of which will be stored in database table "teachings". There should be opportunity made for super_admin to edit/update all its content even after posting/saving.


want to use IkoControls.jsx component as place where admin will handle the upload and management of  'messages' that will feature/render/display in iko.jsx layout through all the components linked to Iko.jsx (ListChats.jsx, Chat.jsx, Chatlist.jsx, Comments.jsx ).  this IkoControls.jsx will be associated or linked or embedded into Admin.jsx layout like others. 
Note that when 'messages' is not posted by an admin or super_admin, it is mearnt to initially be in 'pending' mode at the 'approval_status' column of database table "messages", awaiting its approval/update from 'pending' to 'approved' or 'rejected' by site manager with an admin or super_admin role. Also, in IkoControls.jsx, admin should have place to manage  individual stages or status of 'messages' like the fetching and update of all pending, of all approved, of all rejected and of all deleted teachings, and thereby be able to over-turn or edit or change their status as best practices in the management of a chat or teaching app.
Inside this IkoControl.jsx, site managers with admin or super_admin role should also have a place to manage comments featured in "Comments.jsx" and all that can be managed of the posted and featured Comments in Comments.jsx of Iko.jsx like deleting, and editing as stored in the database table of "comments".


export default router;   """  database table "messages" :  columns " id 	chat_id 	user_id 	class_id 	title 	summary 	text 	approval_status 	media_url1 	media_type1 	media_url2 	media_type2 	media_url3 	media_type3 	is_flagged 	created_at 	updatedAt " """  database table "teachings" : with columns " id 	topic 	description 	lessonNumber 	subjectMatter 	audience 	content 	media_url1 	media_type1 	media_url2 	media_type2 	media_url3 	media_type3 	createdAt 	updatedAt " '


how to check reports and actions like ban, etc
dashboard analytics, use of isblocked and isbanned on users table
--work on the search
Mentors sponsors new applicant by creating of application ticket/coupon and issuing to intending applicats that will signup with it. so use of application coupon (number) from a sponsorer like a mentor, which will lead to the mentor first vetting before new user will be allowed to even get access to the signup.


 "is_flagged" in "chat" database table with Chat.jsx part of Iko.jsx (messages/comments is flagged),

 in report table, i have reported_id and the reporter_id, that is used when a user is reporting some other user for some kind of system abuse.

 "isblocked" in "users" table to allow user to block other individual users communication and control/stop one-on-one chatting with other individual users. not to block group or general/public post-chat.

 "isbanned" in "users" table that is there actually against the particular user that have it. it indicate that that particular user is banned from some chatting activities and hence cannot access something, perhaps 1. cannot chat/comment on that particular chat/post. or 2. cannot receive those chat/post again. or 3. will receive chat/post but cannot comment from a class, etc etc



 i need help with the coding and logic to make the data input, upload of files including media files into aws s3 storage and the storing of the s3 path URL into a MySQL database , the fetching of those data and files, and their rendering on the output port for users to see. the site administrator herein called admin through Admin.jsx be able to upload/input and render the fetched data. And also, users should be able to upload/input all files (images, emojis, videos, audio, text, etc ) as done in regular chat or teaching apps. Towncrier.jsx is the public view port to access the teachings and needs the functionality to fetch data from database storage and render it. likewise; Iko.jsx is the name for the chat page and should have the functionality to post/input data files into database storage in it and also to fetch and render those data on it as a chatting page.  Note that "teachings" and "messages" are the two forms of contents that are going to be posted and rendered in this chatting website.  Admin.jsx is admin dashboard to input/post both teaching through TowncrierControls.jsx and input/post/upload 'messages' through IkoControls.jsx. Towncrier.jsx is only to fetch 'teachings'  and render it. While, Iko.jsx like every chat app should have functionalities to both post/upload/input the data herein called "messages" and likewise do fetching the data from database/storage before rendering. 
 want to use  "@tanstack/react-query" for the input/uploading 













First; need to code in for the app to show re-login page the moment it enters a standby mode, after a period of inactivity. Each time it enters a standby mode, it should display login page.

secondly; there should be outlets or page link for users to nevigate from the iko chat page to the towncrier and vice versa with authrization confirmed.



#######

New API Endpoints Available users (continued):

GET /api/users/:user_id - Get specific user profile
GET /api/users/:user_id/activity - Get user's content activity
PUT /api/users/:user_id - Update specific user (admin)
DELETE /api/users/:user_id - Soft delete user (super admin)
GET /api/health - API health check
GET /api/docs - API documentation

Database Schema Compatibility:
Your existing users table structure is perfect for these optimizations:
sql-- Your current users table supports all new features:
- id (primary key)
- username, email, phone (profile fields)
- avatar (profile image)
- converse_id, mentor_id, class_id (relationship fields)
- is_member (membership status: applied, granted, denied, suspended)
- role (user, admin, super_admin, mentor, moderator)
- isblocked, isbanned (moderation fields)
- createdAt, updatedAt (timestamp tracking)
- resetToken, resetTokenExpiry, verificationCode, codeExpiry (auth fields)
Role Hierarchy & Permissions:

super_admin: Full access to all operations
admin: Can manage users but not create other admins
mentor: Limited access to assigned mentees
moderator: Content moderation capabilities
user: Basic profile access only



New Survey API Endpoints:

GET /api/survey/questions - Get survey questions (public)
POST /api/survey/submit - Submit survey (authenticated)
GET /api/survey/my-surveys - Get user's surveys
GET /api/survey/logs - Get all surveys (admin)
GET /api/survey/stats - Survey statistics (admin)
GET /api/survey/:id - Get specific survey
PUT /api/survey/approve - Approve/reject survey (admin)
PUT /api/survey/questions - Update questions (admin)


Key Features Added:
New API Endpoints:

GET /api/communication/templates - Get available templates
GET /api/communication/health - Service health check (admin)
GET /api/communication/stats - Communication statistics (admin)
POST /api/communication/email/send - Send single email
POST /api/communication/email/bulk - Send bulk emails (admin)
POST /api/communication/sms/send - Send single SMS
POST /api/communication/sms/bulk - Send bulk SMS (admin)
POST /api/communication/notification - Combined notifications

Template System:
javascript// Email templates available:
- welcome: New user welcome email
- surveyApproval: Survey approval/rejection
- contentNotification: Content status updates
- passwordReset: Password reset instructions
- adminNotification: Admin alerts

// SMS templates available:
- welcome: Welcome SMS
- surveyApproval: Survey status SMS
- verificationCode: OTP codes
- passwordReset: Password reset alert
- contentNotification: Content updates
- adminAlert: Admin alerts
- maintenance: Maintenance notifications 



New API Endpoints:

GET /api/comments/stats - Comment statistics (admin)
GET /api/comments/:commentId - Get specific comment
PUT /api/comments/:commentId - Update comment
DELETE /api/comments/:commentId - Delete comment 

Authorization Matrix:

Users: Can create, view, update, delete their own comments
Admins: Can view all comments, statistics, and moderate content
Super Admins: Full access to all comment operations




MySQL [ikoota_db]> show tables;
+--------------------------------+
| Tables_in_ikoota_db            |
+--------------------------------+
| admin_membership_overview      |
| all_applications_status        |
| audit_logs                     |
| bulk_email_logs                |
| bulk_sms_logs                  |
| chats                          |
| class_content_access           |
| class_member_counts            |
| classes                        |
| comments                       |
| converse_relationships         |
| email_logs                     |
| email_templates                |
| full_membership_access         |
| full_membership_access_log     |
| full_membership_applications   |
| id_generation_log              |
| identity_masking_audit         |
| membership_review_history      |
| membership_stats               |
| pending_applications_overview  |
| pending_full_memberships       |
| pending_initial_applications   |
| reports                        |
| sms_logs                       |
| sms_templates                  |
| survey_questions               |
| surveylog                      |
| teachings                      |
| user_chats                     |
| user_class_details             |
| user_class_memberships         |
| user_communication_preferences |
| user_profiles                  |
| users                          |
| verification_codes             |
+--------------------------------+
36 rows in set (0.054 sec)

MySQL [ikoota_db]> SELECT
    ->     CONCAT('DESCRIBE ', TABLE_NAME, ';') as describe_commands
    -> FROM INFORMATION_SCHEMA.TABLES
    -> WHERE TABLE_SCHEMA = 'ikoota_db'
    ->     AND TABLE_TYPE = 'BASE TABLE'
    -> ORDER BY TABLE_NAME;
+------------------------------------------+
| describe_commands                        |
+------------------------------------------+
| DESCRIBE audit_logs;                     |
| DESCRIBE bulk_email_logs;                |
| DESCRIBE bulk_sms_logs;                  |
| DESCRIBE chats;                          |
| DESCRIBE class_content_access;           |
| DESCRIBE classes;                        |
| DESCRIBE comments;                       |
| DESCRIBE converse_relationships;         |
| DESCRIBE email_logs;                     |
| DESCRIBE email_templates;                |
| DESCRIBE full_membership_access;         |
| DESCRIBE full_membership_access_log;     |
| DESCRIBE full_membership_applications;   |
| DESCRIBE id_generation_log;              |
| DESCRIBE identity_masking_audit;         |
| DESCRIBE membership_review_history;      |
| DESCRIBE reports;                        |
| DESCRIBE sms_logs;                       |
| DESCRIBE sms_templates;                  |
| DESCRIBE survey_questions;               |
| DESCRIBE surveylog;                      |
| DESCRIBE teachings;                      |
| DESCRIBE user_chats;                     |
| DESCRIBE user_class_memberships;         |
| DESCRIBE user_communication_preferences; |
| DESCRIBE user_profiles;                  |
| DESCRIBE users;                          |
| DESCRIBE verification_codes;             |
+------------------------------------------+
28 rows in set (0.075 sec)

MySQL [ikoota_db]> DESCRIBE users;
+-----------------------------+---------------------------------------------------------------------------------------------+------+-----+-------------------+-------------------+
| Field                       | Type                                                                                        | Null | Key | Default           | Extra             |
+-----------------------------+---------------------------------------------------------------------------------------------+------+-----+-------------------+-------------------+
| id                          | int                                                                                         | NO   | PRI | NULL              | auto_increment    |
| username                    | varchar(255)                                                                                | NO   |     | NULL              |                   |
| email                       | varchar(255)                                                                                | NO   |     | NULL              |                   |
| phone                       | varchar(15)                                                                                 | YES  |     | NULL              |                   |
| avatar                      | varchar(255)                                                                                | YES  |     | NULL              |                   |
| password_hash               | varchar(255)                                                                                | NO   |     | NULL              |                   |
| converse_id                 | varchar(12)                                                                                 | YES  | UNI | NULL              |                   |
| application_ticket          | varchar(20)                                                                                 | YES  | MUL | NULL              |                   |
| mentor_id                   | char(10)                                                                                    | YES  | MUL | NULL              |                   |
| primary_class_id            | varchar(12)                                                                                 | YES  | MUL | NULL              |                   |
| is_member                   | enum('applied','pending','suspended','granted','declined','pre_member','member','rejected') | YES  |     | applied           |                   |
| membership_stage            | enum('none','applicant','pre_member','member')                                              | YES  | MUL | none              |                   |
| full_membership_ticket      | varchar(25)                                                                                 | YES  |     | NULL              |                   |
| full_membership_status      | enum('not_applied','applied','pending','suspended','approved','declined')                   | YES  | MUL | not_applied       |                   |
| full_membership_applied_at  | timestamp                                                                                   | YES  | MUL | NULL              |                   |
| full_membership_reviewed_at | timestamp                                                                                   | YES  |     | NULL              |                   |
| role                        | enum('super_admin','admin','user')                                                          | YES  |     | user              |                   |
| isblocked                   | json                                                                                        | YES  |     | NULL              |                   |
| isbanned                    | tinyint(1)                                                                                  | YES  |     | 0                 |                   |
| createdAt                   | timestamp                                                                                   | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| updatedAt                   | timestamp                                                                                   | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| resetToken                  | varchar(255)                                                                                | YES  |     | NULL              |                   |
| resetTokenExpiry            | bigint                                                                                      | YES  |     | NULL              |                   |
| verification_method         | enum('email','phone')                                                                       | YES  |     | NULL              |                   |
| verification_code           | varchar(10)                                                                                 | YES  |     | NULL              |                   |
| is_verified                 | tinyint(1)                                                                                  | YES  | MUL | 0                 |                   |
| codeExpiry                  | bigint                                                                                      | YES  |     | NULL              |                   |
| converse_avatar             | varchar(255)                                                                                | YES  |     | NULL              |                   |
| is_identity_masked          | tinyint(1)                                                                                  | YES  |     | 0                 |                   |
| total_classes               | int                                                                                         | YES  |     | 0                 |                   |
+-----------------------------+---------------------------------------------------------------------------------------------+------+-----+-------------------+-------------------+
30 rows in set (0.080 sec)

MySQL [ikoota_db]> DESCRIBE surveylog;
+------------------+---------------------------------------------------------------------------+------+-----+---------------------+-----------------------------------------------+
| Field            | Type                                                                      | Null | Key | Default             | Extra                                         |
+------------------+---------------------------------------------------------------------------+------+-----+---------------------+-----------------------------------------------+
| id               | int                                                                       | NO   | PRI | NULL                | auto_increment                                |
| user_id          | char(10)                                                                  | NO   | MUL | NULL                |                                               |
| answers          | text                                                                      | YES  |     | NULL                |                                               |
| verified_by      | char(10)                                                                  | NO   | MUL | NULL                |                                               |
| rating_remarks   | varchar(255)                                                              | NO   |     | NULL                |                                               |
| approval_status  | enum('pending','approved','rejected','under_review','granted','declined') | YES  | MUL | pending             |                                               |
| createdAt        | timestamp                                                                 | YES  |     | CURRENT_TIMESTAMP   | DEFAULT_GENERATED                             |
| updatedAt        | timestamp                                                                 | YES  |     | CURRENT_TIMESTAMP   | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
| processedAt      | timestamp                                                                 | YES  |     | CURRENT_TIMESTAMP   | DEFAULT_GENERATED                             |
| admin_notes      | text                                                                      | YES  |     | NULL                |                                               |
| application_type | enum('initial_application','full_membership')                             | YES  | MUL | initial_application |                                               |
| reviewed_at      | timestamp                                                                 | YES  | MUL | NULL                |                                               |
| reviewed_by      | int                                                                       | YES  | MUL | NULL                |                                               |
+------------------+---------------------------------------------------------------------------+------+-----+---------------------+-----------------------------------------------+
13 rows in set (0.049 sec)

MySQL [ikoota_db]> DESCRIBE full_membership_applications;
+-------------------+---------------------------------------------------+------+-----+-------------------+-------------------+
| Field             | Type                                              | Null | Key | Default           | Extra             |
+-------------------+---------------------------------------------------+------+-----+-------------------+-------------------+
| id                | int                                               | NO   | PRI | NULL              | auto_increment    |
| user_id           | int                                               | NO   | UNI | NULL              |                   |
| membership_ticket | varchar(25)                                       | NO   | MUL | NULL              |                   |
| answers           | json                                              | NO   |     | NULL              |                   |
| status            | enum('pending','suspended','approved','declined') | YES  | MUL | pending           |                   |
| submitted_at      | timestamp                                         | YES  | MUL | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| reviewed_at       | timestamp                                         | YES  |     | NULL              |                   |
| reviewed_by       | int                                               | YES  | MUL | NULL              |                   |
| admin_notes       | text                                              | YES  |     | NULL              |                   |
+-------------------+---------------------------------------------------+------+-----+-------------------+-------------------+
9 rows in set (0.060 sec)

MySQL [ikoota_db]> DESCRIBE full_membership_access;
+-------------------+-----------+------+-----+-------------------+-----------------------------------------------+
| Field             | Type      | Null | Key | Default           | Extra                                         |
+-------------------+-----------+------+-----+-------------------+-----------------------------------------------+
| id                | int       | NO   | PRI | NULL              | auto_increment                                |
| user_id           | int       | NO   | UNI | NULL              |                                               |
| first_accessed_at | timestamp | YES  | MUL | CURRENT_TIMESTAMP | DEFAULT_GENERATED                             |
| last_accessed_at  | timestamp | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
| access_count      | int       | YES  |     | 1                 |                                               |
+-------------------+-----------+------+-----+-------------------+-----------------------------------------------+
5 rows in set (0.052 sec)

MySQL [ikoota_db]> DESCRIBE full_membership_access_log;
+-----------------+-------------+------+-----+-------------------+-----------------------------------------------+
| Field           | Type        | Null | Key | Default           | Extra                                         |
+-----------------+-------------+------+-----+-------------------+-----------------------------------------------+
| id              | int         | NO   | PRI | NULL              | auto_increment                                |
| user_id         | int         | NO   | UNI | NULL              |                                               |
| first_access_at | timestamp   | YES  | MUL | CURRENT_TIMESTAMP | DEFAULT_GENERATED                             |
| total_accesses  | int         | YES  |     | 1                 |                                               |
| last_access_at  | timestamp   | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
| ip_address      | varchar(45) | YES  |     | NULL              |                                               |
| user_agent      | text        | YES  |     | NULL              |                                               |
+-----------------+-------------+------+-----+-------------------+-----------------------------------------------+
7 rows in set (0.079 sec)

MySQL [ikoota_db]> DESCRIBE membership_review_history;
+-------------------+-------------------------------------------------------------+------+-----+-------------------+-------------------+
| Field             | Type                                                        | Null | Key | Default           | Extra             |
+-------------------+-------------------------------------------------------------+------+-----+-------------------+-------------------+
| id                | int                                                         | NO   | PRI | NULL              | auto_increment    |
| user_id           | int                                                         | NO   | MUL | NULL              |                   |
| application_type  | enum('initial_application','full_membership')               | NO   | MUL | NULL              |                   |
| application_id    | int                                                         | YES  |     | NULL              |                   |
| reviewer_id       | int                                                         | YES  | MUL | NULL              |                   |
| previous_status   | enum('pending','suspended','approved','declined')           | YES  |     | NULL              |                   |
| new_status        | enum('pending','suspended','approved','declined')           | YES  |     | NULL              |                   |
| review_notes      | text                                                        | YES  |     | NULL              |                   |
| action_taken      | enum('approve','decline','suspend','request_info','reopen') | NO   |     | NULL              |                   |
| reviewed_at       | timestamp                                                   | YES  | MUL | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| notification_sent | tinyint(1)                                                  | YES  |     | 0                 |                   |
+-------------------+-------------------------------------------------------------+------+-----+-------------------+-------------------+
11 rows in set (0.059 sec)

MySQL [ikoota_db]> DESCRIBE verification_codes;
+-----------+-----------------------+------+-----+-------------------+-------------------+
| Field     | Type                  | Null | Key | Default           | Extra             |
+-----------+-----------------------+------+-----+-------------------+-------------------+
| id        | int                   | NO   | PRI | NULL              | auto_increment    |
| email     | varchar(255)          | NO   | MUL | NULL              |                   |
| phone     | varchar(15)           | YES  |     | NULL              |                   |
| code      | varchar(10)           | NO   |     | NULL              |                   |
| method    | enum('email','phone') | NO   |     | NULL              |                   |
| expiresAt | timestamp             | NO   | MUL | NULL              |                   |
| createdAt | timestamp             | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
+-----------+-----------------------+------+-----+-------------------+-------------------+
7 rows in set (0.061 sec)

MySQL [ikoota_db]>
MySQL [ikoota_db]> -- Admin and communication tables
MySQL [ikoota_db]> DESCRIBE email_templates;
+------------+--------------+------+-----+-------------------+-----------------------------------------------+
| Field      | Type         | Null | Key | Default           | Extra                                         |
+------------+--------------+------+-----+-------------------+-----------------------------------------------+
| id         | int          | NO   | PRI | NULL              | auto_increment                                |
| name       | varchar(100) | NO   | UNI | NULL              |                                               |
| subject    | varchar(500) | NO   |     | NULL              |                                               |
| body_text  | text         | YES  |     | NULL              |                                               |
| body_html  | text         | YES  |     | NULL              |                                               |
| variables  | json         | YES  |     | NULL              |                                               |
| is_active  | tinyint(1)   | YES  | MUL | 1                 |                                               |
| created_by | char(10)     | YES  | MUL | NULL              |                                               |
| createdAt  | timestamp    | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED                             |
| updatedAt  | timestamp    | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
+------------+--------------+------+-----+-------------------+-----------------------------------------------+
10 rows in set (0.045 sec)

MySQL [ikoota_db]> DESCRIBE email_logs;
+---------------+---------------------------------+------+-----+-------------------+-----------------------------------------------+
| Field         | Type                            | Null | Key | Default           | Extra                                         |
+---------------+---------------------------------+------+-----+-------------------+-----------------------------------------------+
| id            | int                             | NO   | PRI | NULL              | auto_increment                                |
| recipient     | varchar(255)                    | NO   | MUL | NULL              |                                               |
| subject       | varchar(500)                    | YES  |     | NULL              |                                               |
| template      | varchar(100)                    | YES  | MUL | NULL              |                                               |
| status        | enum('sent','failed','pending') | YES  | MUL | pending           |                                               |
| message_id    | varchar(255)                    | YES  |     | NULL              |                                               |
| error_message | text                            | YES  |     | NULL              |                                               |
| sender_id     | char(10)                        | YES  | MUL | NULL              |                                               |
| createdAt     | timestamp                       | YES  | MUL | CURRENT_TIMESTAMP | DEFAULT_GENERATED                             |
| updatedAt     | timestamp                       | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
| processedAt   | timestamp                       | YES  |     | NULL              |                                               |
+---------------+---------------------------------+------+-----+-------------------+-----------------------------------------------+
11 rows in set (0.050 sec)

MySQL [ikoota_db]> DESCRIBE sms_templates;
+------------+--------------+------+-----+-------------------+-----------------------------------------------+
| Field      | Type         | Null | Key | Default           | Extra                                         |
+------------+--------------+------+-----+-------------------+-----------------------------------------------+
| id         | int          | NO   | PRI | NULL              | auto_increment                                |
| name       | varchar(100) | NO   | UNI | NULL              |                                               |
| message    | text         | NO   |     | NULL              |                                               |
| variables  | json         | YES  |     | NULL              |                                               |
| is_active  | tinyint(1)   | YES  | MUL | 1                 |                                               |
| created_by | char(10)     | YES  | MUL | NULL              |                                               |
| createdAt  | timestamp    | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED                             |
| updatedAt  | timestamp    | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
+------------+--------------+------+-----+-------------------+-----------------------------------------------+
8 rows in set (0.062 sec)

MySQL [ikoota_db]> DESCRIBE sms_logs;
+---------------+---------------------------------+------+-----+-------------------+-----------------------------------------------+
| Field         | Type                            | Null | Key | Default           | Extra                                         |
+---------------+---------------------------------+------+-----+-------------------+-----------------------------------------------+
| id            | int                             | NO   | PRI | NULL              | auto_increment                                |
| recipient     | varchar(20)                     | NO   | MUL | NULL              |                                               |
| message       | text                            | YES  |     | NULL              |                                               |
| template      | varchar(100)                    | YES  | MUL | NULL              |                                               |
| status        | enum('sent','failed','pending') | YES  | MUL | pending           |                                               |
| sid           | varchar(100)                    | YES  |     | NULL              |                                               |
| error_message | text                            | YES  |     | NULL              |                                               |
| sender_id     | char(10)                        | YES  | MUL | NULL              |                                               |
| createdAt     | timestamp                       | YES  | MUL | CURRENT_TIMESTAMP | DEFAULT_GENERATED                             |
| updatedAt     | timestamp                       | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
| processedAt   | timestamp                       | YES  |     | NULL              |                                               |
+---------------+---------------------------------+------+-----+-------------------+-----------------------------------------------+
11 rows in set (0.046 sec)

MySQL [ikoota_db]> DESCRIBE bulk_email_logs;
+------------------+--------------+------+-----+-------------------+-----------------------------------------------+
| Field            | Type         | Null | Key | Default           | Extra                                         |
+------------------+--------------+------+-----+-------------------+-----------------------------------------------+
| id               | int          | NO   | PRI | NULL              | auto_increment                                |
| recipients_count | int          | NO   |     | NULL              |                                               |
| subject          | varchar(500) | YES  |     | NULL              |                                               |
| template         | varchar(100) | YES  | MUL | NULL              |                                               |
| successful_count | int          | YES  |     | 0                 |                                               |
| failed_count     | int          | YES  |     | 0                 |                                               |
| sender_id        | char(10)     | YES  | MUL | NULL              |                                               |
| createdAt        | timestamp    | YES  | MUL | CURRENT_TIMESTAMP | DEFAULT_GENERATED                             |
| updatedAt        | timestamp    | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
| processedAt      | timestamp    | YES  |     | NULL              |                                               |
+------------------+--------------+------+-----+-------------------+-----------------------------------------------+
10 rows in set (0.043 sec)

MySQL [ikoota_db]> DESCRIBE bulk_sms_logs;
+------------------+--------------+------+-----+-------------------+-----------------------------------------------+
| Field            | Type         | Null | Key | Default           | Extra                                         |
+------------------+--------------+------+-----+-------------------+-----------------------------------------------+
| id               | int          | NO   | PRI | NULL              | auto_increment                                |
| recipients_count | int          | NO   |     | NULL              |                                               |
| message          | text         | YES  |     | NULL              |                                               |
| template         | varchar(100) | YES  | MUL | NULL              |                                               |
| successful_count | int          | YES  |     | 0                 |                                               |
| failed_count     | int          | YES  |     | 0                 |                                               |
| sender_id        | char(10)     | YES  | MUL | NULL              |                                               |
| createdAt        | timestamp    | YES  | MUL | CURRENT_TIMESTAMP | DEFAULT_GENERATED                             |
| updatedAt        | timestamp    | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
| processedAt      | timestamp    | YES  |     | NULL              |                                               |
+------------------+--------------+------+-----+-------------------+-----------------------------------------------+
10 rows in set (0.043 sec)

MySQL [ikoota_db]>
MySQL [ikoota_db]> -- Class and content tables
MySQL [ikoota_db]> DESCRIBE classes;
+---------------+--------------------------------------------------+------+-----+-------------------+-------------------+
| Field         | Type                                             | Null | Key | Default           | Extra             |
+---------------+--------------------------------------------------+------+-----+-------------------+-------------------+
| id            | int                                              | NO   | PRI | NULL              | auto_increment    |
| class_id      | varchar(12)                                      | NO   | UNI | NULL              |                   |
| class_name    | varchar(255)                                     | NO   |     | NULL              |                   |
| public_name   | varchar(255)                                     | YES  |     | NULL              |                   |
| description   | text                                             | YES  |     | NULL              |                   |
| class_type    | enum('demographic','subject','public','special') | YES  | MUL | demographic       |                   |
| is_public     | tinyint(1)                                       | YES  | MUL | 0                 |                   |
| max_members   | int                                              | YES  |     | 50                |                   |
| privacy_level | enum('public','members_only','admin_only')       | YES  |     | members_only      |                   |
| created_by    | int                                              | YES  | MUL | NULL              |                   |
| is_active     | tinyint(1)                                       | YES  | MUL | 1                 |                   |
| createdAt     | timestamp                                        | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| updatedAt     | timestamp                                        | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
+---------------+--------------------------------------------------+------+-----+-------------------+-------------------+
13 rows in set (0.058 sec)

MySQL [ikoota_db]> DESCRIBE teachings;
+---------------+--------------------------------------+------+-----+-------------------+-----------------------------------------------+
| Field         | Type                                 | Null | Key | Default           | Extra                                         |
+---------------+--------------------------------------+------+-----+-------------------+-----------------------------------------------+
| id            | int                                  | NO   | PRI | NULL              | auto_increment                                |
| topic         | varchar(255)                         | NO   |     | NULL              |                                               |
| description   | text                                 | YES  |     | NULL              |                                               |
| lessonNumber  | varchar(255)                         | NO   |     | NULL              |                                               |
| subjectMatter | varchar(255)                         | YES  |     | NULL              |                                               |
| audience      | varchar(255)                         | YES  |     | NULL              |                                               |
| content       | text                                 | YES  |     | NULL              |                                               |
| media_url1    | varchar(255)                         | YES  |     | NULL              |                                               |
| media_type1   | enum('image','video','audio','file') | YES  |     | NULL              |                                               |
| media_url2    | varchar(255)                         | YES  |     | NULL              |                                               |
| media_type2   | enum('image','video','audio','file') | YES  |     | NULL              |                                               |
| media_url3    | varchar(255)                         | YES  |     | NULL              |                                               |
| media_type3   | enum('image','video','audio','file') | YES  |     | NULL              |                                               |
| createdAt     | timestamp                            | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED                             |
| updatedAt     | timestamp                            | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
| user_id       | char(10)                             | NO   | MUL | NULL              |                                               |
| prefixed_id   | varchar(20)                          | YES  | UNI | NULL              |                                               |
+---------------+--------------------------------------+------+-----+-------------------+-----------------------------------------------+
17 rows in set (0.048 sec)

MySQL [ikoota_db]> DESCRIBE class_content_access;
+--------------+----------------------------------------+------+-----+-------------------+-------------------+
| Field        | Type                                   | Null | Key | Default           | Extra             |
+--------------+----------------------------------------+------+-----+-------------------+-------------------+
| id           | int                                    | NO   | PRI | NULL              | auto_increment    |
| content_id   | int                                    | NO   | MUL | NULL              |                   |
| content_type | enum('chat','teaching','announcement') | NO   |     | NULL              |                   |
| class_id     | varchar(12)                            | NO   | MUL | NULL              |                   |
| access_level | enum('read','comment','contribute')    | YES  |     | read              |                   |
| createdAt    | timestamp                              | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
+--------------+----------------------------------------+------+-----+-------------------+-------------------+
6 rows in set (0.042 sec)

MySQL [ikoota_db]> DESCRIBE class_member_counts;
+-----------------+--------------------------------------------------+------+-----+-------------+-------+
| Field           | Type                                             | Null | Key | Default     | Extra |
+-----------------+--------------------------------------------------+------+-----+-------------+-------+
| class_id        | varchar(12)                                      | NO   |     | NULL        |       |
| class_name      | varchar(255)                                     | NO   |     | NULL        |       |
| class_type      | enum('demographic','subject','public','special') | YES  |     | demographic |       |
| is_public       | tinyint(1)                                       | YES  |     | 0           |       |
| total_members   | bigint                                           | NO   |     | 0           |       |
| moderators      | bigint                                           | NO   |     | 0           |       |
| pending_members | bigint                                           | NO   |     | 0           |       |
+-----------------+--------------------------------------------------+------+-----+-------------+-------+
7 rows in set (0.045 sec)

MySQL [ikoota_db]> DESCRIBE user_class_details;
+--------------------+--------------------------------------------------+------+-----+-------------------+-------------------+
| Field              | Type                                             | Null | Key | Default           | Extra             |
+--------------------+--------------------------------------------------+------+-----+-------------------+-------------------+
| user_id            | int                                              | NO   |     | NULL              |                   |
| username           | varchar(255)                                     | NO   |     | NULL              |                   |
| converse_id        | varchar(12)                                      | YES  |     | NULL              |                   |
| class_id           | varchar(12)                                      | NO   |     | NULL              |                   |
| class_name         | varchar(255)                                     | NO   |     | NULL              |                   |
| public_name        | varchar(255)                                     | YES  |     | NULL              |                   |
| class_type         | enum('demographic','subject','public','special') | YES  |     | demographic       |                   |
| is_public          | tinyint(1)                                       | YES  |     | 0                 |                   |
| membership_status  | enum('active','pending','suspended','expired')   | YES  |     | active            |                   |
| role_in_class      | enum('member','moderator','assistant')           | YES  |     | member            |                   |
| can_see_class_name | tinyint(1)                                       | YES  |     | 1                 |                   |
| joined_at          | timestamp                                        | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
+--------------------+--------------------------------------------------+------+-----+-------------------+-------------------+
12 rows in set (0.042 sec)

MySQL [ikoota_db]> DESCRIBE user_class_memberships;
+-----------------------+------------------------------------------------+------+-----+-------------------+-----------------------------------------------+
| Field                 | Type                                           | Null | Key | Default           | Extra                                         |
+-----------------------+------------------------------------------------+------+-----+-------------------+-----------------------------------------------+
| id                    | int                                            | NO   | PRI | NULL              | auto_increment                                |
| user_id               | int                                            | NO   | MUL | NULL              |                                               |
| class_id              | varchar(12)                                    | NO   | MUL | NULL              |                                               |
| membership_status     | enum('active','pending','suspended','expired') | YES  | MUL | active            |                                               |
| role_in_class         | enum('member','moderator','assistant')         | YES  |     | member            |                                               |
| joined_at             | timestamp                                      | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED                             |
| assigned_by           | int                                            | YES  | MUL | NULL              |                                               |
| expires_at            | timestamp                                      | YES  |     | NULL              |                                               |
| can_see_class_name    | tinyint(1)                                     | YES  |     | 1                 |                                               |
| receive_notifications | tinyint(1)                                     | YES  |     | 1                 |                                               |
| createdAt             | timestamp                                      | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED                             |
| updatedAt             | timestamp                                      | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
+-----------------------+------------------------------------------------+------+-----+-------------------+-----------------------------------------------+
12 rows in set (0.068 sec)

MySQL [ikoota_db]>
MySQL [ikoota_db]> -- Chat and social features
MySQL [ikoota_db]> DESCRIBE chats;
+-----------------+---------------------------------------+------+-----+-------------------+-------------------+
| Field           | Type                                  | Null | Key | Default           | Extra             |
+-----------------+---------------------------------------+------+-----+-------------------+-------------------+
| id              | int                                   | NO   | PRI | NULL              | auto_increment    |
| title           | varchar(255)                          | NO   |     | NULL              |                   |
| user_id         | char(10)                              | NO   | MUL | NULL              |                   |
| audience        | varchar(255)                          | YES  |     | NULL              |                   |
| summary         | text                                  | YES  |     | NULL              |                   |
| text            | text                                  | YES  |     | NULL              |                   |
| approval_status | enum('pending','approved','rejected') | YES  |     | pending           |                   |
| media_url1      | varchar(255)                          | YES  |     | NULL              |                   |
| media_type1     | enum('image','video','audio','file')  | YES  |     | NULL              |                   |
| media_url2      | varchar(255)                          | YES  |     | NULL              |                   |
| media_type2     | enum('image','video','audio','file')  | YES  |     | NULL              |                   |
| media_url3      | varchar(255)                          | YES  |     | NULL              |                   |
| is_flagged      | tinyint(1)                            | YES  |     | 0                 |                   |
| media_type3     | enum('image','video','audio','file')  | YES  |     | NULL              |                   |
| createdAt       | timestamp                             | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| updatedAt       | timestamp                             | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| prefixed_id     | varchar(20)                           | YES  | UNI | NULL              |                   |
+-----------------+---------------------------------------+------+-----+-------------------+-------------------+
17 rows in set (0.059 sec)

MySQL [ikoota_db]> DESCRIBE user_chats;
+----------------------+--------------------------------+------+-----+-------------------+-------------------+
| Field                | Type                           | Null | Key | Default           | Extra             |
+----------------------+--------------------------------+------+-----+-------------------+-------------------+
| id                   | int                            | NO   | PRI | NULL              | auto_increment    |
| user_id              | char(10)                       | NO   | MUL | NULL              |                   |
| chat_id              | char(10)                       | NO   |     | NULL              |                   |
| last_message         | varchar(255)                   | YES  |     | NULL              |                   |
| is_seen              | tinyint(1)                     | YES  |     | 0                 |                   |
| role                 | enum('admin','member','owner') | NO   |     | NULL              |                   |
| is_muted             | tinyint(1)                     | YES  |     | 0                 |                   |
| last_read_message_id | varchar(36)                    | YES  |     | NULL              |                   |
| joined_at            | datetime                       | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| updatedAt            | timestamp                      | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
+----------------------+--------------------------------+------+-----+-------------------+-------------------+
10 rows in set (0.058 sec)

MySQL [ikoota_db]> DESCRIBE comments;
+-------------+--------------------------------------+------+-----+-------------------+-------------------+
| Field       | Type                                 | Null | Key | Default           | Extra             |
+-------------+--------------------------------------+------+-----+-------------------+-------------------+
| id          | int                                  | NO   | PRI | NULL              | auto_increment    |
| user_id     | char(10)                             | NO   | MUL | NULL              |                   |
| chat_id     | int                                  | YES  | MUL | NULL              |                   |
| teaching_id | int                                  | YES  | MUL | NULL              |                   |
| comment     | text                                 | NO   |     | NULL              |                   |
| media_url1  | varchar(255)                         | YES  |     | NULL              |                   |
| media_type1 | enum('image','video','audio','file') | YES  |     | NULL              |                   |
| media_url2  | varchar(255)                         | YES  |     | NULL              |                   |
| media_type2 | enum('image','video','audio','file') | YES  |     | NULL              |                   |
| media_url3  | varchar(255)                         | YES  |     | NULL              |                   |
| media_type3 | enum('image','video','audio','file') | YES  |     | NULL              |                   |
| createdAt   | timestamp                            | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| updatedAt   | timestamp                            | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
+-------------+--------------------------------------+------+-----+-------------------+-------------------+
13 rows in set (0.054 sec)

MySQL [ikoota_db]> DESCRIBE converse_relationships;
+--------------------+-------------------------------+------+-----+-------------------+-------------------+
| Field              | Type                          | Null | Key | Default           | Extra             |
+--------------------+-------------------------------+------+-----+-------------------+-------------------+
| id                 | int                           | NO   | PRI | NULL              | auto_increment    |
| mentor_converse_id | varchar(12)                   | YES  | MUL | NULL              |                   |
| mentee_converse_id | varchar(12)                   | YES  | MUL | NULL              |                   |
| relationship_type  | enum('mentor','peer','admin') | YES  |     | mentor            |                   |
| created_at         | timestamp                     | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| is_active          | tinyint(1)                    | YES  |     | 1                 |                   |
+--------------------+-------------------------------+------+-----+-------------------+-------------------+
6 rows in set (0.057 sec)

MySQL [ikoota_db]>
MySQL [ikoota_db]> -- User management tables
MySQL [ikoota_db]> DESCRIBE user_profiles;
+--------------------+--------------+------+-----+-------------------+-------------------+
| Field              | Type         | Null | Key | Default           | Extra             |
+--------------------+--------------+------+-----+-------------------+-------------------+
| id                 | int          | NO   | PRI | NULL              | auto_increment    |
| user_id            | int          | NO   | UNI | NULL              |                   |
| encrypted_username | text         | NO   |     | NULL              |                   |
| encrypted_email    | text         | NO   |     | NULL              |                   |
| encrypted_phone    | text         | YES  |     | NULL              |                   |
| encryption_key     | varchar(255) | YES  |     | NULL              |                   |
| createdAt          | timestamp    | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| updatedAt          | timestamp    | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
+--------------------+--------------+------+-----+-------------------+-------------------+
8 rows in set (0.046 sec)

MySQL [ikoota_db]> DESCRIBE user_communication_preferences;
+-----------------------+-------------+------+-----+-------------------+-----------------------------------------------+
| Field                 | Type        | Null | Key | Default           | Extra                                         |
+-----------------------+-------------+------+-----+-------------------+-----------------------------------------------+
| id                    | int         | NO   | PRI | NULL              | auto_increment                                |
| user_id               | int         | NO   | UNI | NULL              |                                               |
| email_notifications   | tinyint(1)  | YES  |     | 1                 |                                               |
| sms_notifications     | tinyint(1)  | YES  |     | 0                 |                                               |
| marketing_emails      | tinyint(1)  | YES  |     | 1                 |                                               |
| marketing_sms         | tinyint(1)  | YES  |     | 0                 |                                               |
| survey_notifications  | tinyint(1)  | YES  |     | 1                 |                                               |
| content_notifications | tinyint(1)  | YES  |     | 1                 |                                               |
| admin_notifications   | tinyint(1)  | YES  |     | 1                 |                                               |
| preferred_language    | varchar(10) | YES  |     | en                |                                               |
| timezone              | varchar(50) | YES  |     | UTC               |                                               |
| createdAt             | timestamp   | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED                             |
| updatedAt             | timestamp   | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
| converse_id           | char(10)    | YES  | MUL | NULL              |                                               |
+-----------------------+-------------+------+-----+-------------------+-----------------------------------------------+
14 rows in set (0.057 sec)

MySQL [ikoota_db]> DESCRIBE identity_masking_audit;
+--------------------+--------------+------+-----+-------------------+-------------------+
| Field              | Type         | Null | Key | Default           | Extra             |
+--------------------+--------------+------+-----+-------------------+-------------------+
| id                 | int          | NO   | PRI | NULL              | auto_increment    |
| user_id            | int          | NO   | MUL | NULL              |                   |
| converse_id        | varchar(12)  | YES  | MUL | NULL              |                   |
| masked_by_admin_id | varchar(12)  | YES  | MUL | NULL              |                   |
| original_username  | varchar(255) | YES  |     | NULL              |                   |
| createdAt          | timestamp    | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| reason             | text         | YES  |     | NULL              |                   |
+--------------------+--------------+------+-----+-------------------+-------------------+
7 rows in set (0.043 sec)

MySQL [ikoota_db]>
MySQL [ikoota_db]> -- System and audit tables
MySQL [ikoota_db]> DESCRIBE audit_logs;
+-----------+--------------+------+-----+-------------------+-------------------+
| Field     | Type         | Null | Key | Default           | Extra             |
+-----------+--------------+------+-----+-------------------+-------------------+
| id        | int          | NO   | PRI | NULL              | auto_increment    |
| admin_id  | char(10)     | NO   | MUL | NULL              |                   |
| action    | varchar(255) | NO   |     | NULL              |                   |
| target_id | char(10)     | YES  | MUL | NULL              |                   |
| details   | text         | YES  |     | NULL              |                   |
| createdAt | timestamp    | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
+-----------+--------------+------+-----+-------------------+-------------------+
6 rows in set (0.047 sec)

MySQL [ikoota_db]> DESCRIBE reports;
+-------------+---------------------------------------+------+-----+-------------------+-------------------+
| Field       | Type                                  | Null | Key | Default           | Extra             |
+-------------+---------------------------------------+------+-----+-------------------+-------------------+
| id          | int                                   | NO   | PRI | NULL              | auto_increment    |
| reporter_id | char(10)                              | NO   | MUL | NULL              |                   |
| reported_id | char(10)                              | YES  | MUL | NULL              |                   |
| reason      | text                                  | NO   |     | NULL              |                   |
| status      | enum('pending','reviewed','resolved') | YES  |     | pending           |                   |
| createdAt   | timestamp                             | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
+-------------+---------------------------------------+------+-----+-------------------+-------------------+
6 rows in set (0.050 sec)

MySQL [ikoota_db]> DESCRIBE survey_questions;
+----------------+------------+------+-----+-------------------+-----------------------------------------------+
| Field          | Type       | Null | Key | Default           | Extra                                         |
+----------------+------------+------+-----+-------------------+-----------------------------------------------+
| id             | int        | NO   | PRI | NULL              | auto_increment                                |
| question       | text       | NO   |     | NULL              |                                               |
| createdAt      | timestamp  | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED                             |
| updatedAt      | timestamp  | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
| is_active      | tinyint(1) | YES  |     | 1                 |                                               |
| question_order | int        | YES  |     | 0                 |                                               |
+----------------+------------+------+-----+-------------------+-----------------------------------------------+
6 rows in set (0.047 sec)

MySQL [ikoota_db]> DESCRIBE id_generation_log;
+--------------+----------------------+------+-----+-------------------+-------------------+
| Field        | Type                 | Null | Key | Default           | Extra             |
+--------------+----------------------+------+-----+-------------------+-------------------+
| id           | int                  | NO   | PRI | NULL              | auto_increment    |
| generated_id | char(10)             | NO   | MUL | NULL              |                   |
| id_type      | enum('user','class') | NO   | MUL | NULL              |                   |
| generated_by | char(10)             | YES  | MUL | NULL              |                   |
| generated_at | timestamp            | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| purpose      | varchar(100)         | YES  |     | NULL              |                   |
+--------------+----------------------+------+-----+-------------------+-------------------+
6 rows in set (0.052 sec)

MySQL [ikoota_db]> SELECT
    ->     TABLE_NAME,
    ->     TABLE_TYPE,
    ->     ENGINE,
    ->     TABLE_ROWS,
    ->     DATA_LENGTH,
    ->     INDEX_LENGTH
    -> FROM INFORMATION_SCHEMA.TABLES
    -> WHERE TABLE_SCHEMA = 'ikoota_db'
    -> ORDER BY TABLE_NAME;
+--------------------------------+------------+--------+------------+-------------+--------------+
| TABLE_NAME                     | TABLE_TYPE | ENGINE | TABLE_ROWS | DATA_LENGTH | INDEX_LENGTH |
+--------------------------------+------------+--------+------------+-------------+--------------+
| admin_membership_overview      | VIEW       | NULL   |       NULL |        NULL |         NULL |
| all_applications_status        | VIEW       | NULL   |       NULL |        NULL |         NULL |
| audit_logs                     | BASE TABLE | InnoDB |          0 |       16384 |        32768 |
| bulk_email_logs                | BASE TABLE | InnoDB |          0 |       16384 |        49152 |
| bulk_sms_logs                  | BASE TABLE | InnoDB |          0 |       16384 |        49152 |
| chats                          | BASE TABLE | InnoDB |         17 |       16384 |        49152 |
| class_content_access           | BASE TABLE | InnoDB |          0 |       16384 |        49152 |
| class_member_counts            | VIEW       | NULL   |       NULL |        NULL |         NULL |
| classes                        | BASE TABLE | InnoDB |          7 |       16384 |       114688 |
| comments                       | BASE TABLE | InnoDB |         10 |       16384 |        49152 |
| converse_relationships         | BASE TABLE | InnoDB |          0 |       16384 |        49152 |
| email_logs                     | BASE TABLE | InnoDB |          0 |       16384 |        81920 |
| email_templates                | BASE TABLE | InnoDB |         10 |       16384 |        65536 |
| full_membership_access         | BASE TABLE | InnoDB |          0 |       16384 |        32768 |
| full_membership_access_log     | BASE TABLE | InnoDB |          0 |       16384 |        49152 |
| full_membership_applications   | BASE TABLE | InnoDB |          0 |       16384 |        98304 |
| id_generation_log              | BASE TABLE | InnoDB |          1 |       16384 |        49152 |
| identity_masking_audit         | BASE TABLE | InnoDB |          1 |       16384 |        49152 |
| membership_review_history      | BASE TABLE | InnoDB |          0 |       16384 |        65536 |
| membership_stats               | VIEW       | NULL   |       NULL |        NULL |         NULL |
| pending_applications_overview  | VIEW       | NULL   |       NULL |        NULL |         NULL |
| pending_full_memberships       | VIEW       | NULL   |       NULL |        NULL |         NULL |
| pending_initial_applications   | VIEW       | NULL   |       NULL |        NULL |         NULL |
| reports                        | BASE TABLE | InnoDB |          0 |       16384 |        32768 |
| sms_logs                       | BASE TABLE | InnoDB |          0 |       16384 |        81920 |
| sms_templates                  | BASE TABLE | InnoDB |          7 |       16384 |        65536 |
| survey_questions               | BASE TABLE | InnoDB |          0 |       16384 |            0 |
| surveylog                      | BASE TABLE | InnoDB |          3 |       16384 |       114688 |
| teachings                      | BASE TABLE | InnoDB |         15 |       49152 |        49152 |
| user_chats                     | BASE TABLE | InnoDB |          0 |       16384 |        16384 |
| user_class_details             | VIEW       | NULL   |       NULL |        NULL |         NULL |
| user_class_memberships         | BASE TABLE | InnoDB |          0 |       16384 |        98304 |
| user_communication_preferences | BASE TABLE | InnoDB |          3 |       16384 |        49152 |
| user_profiles                  | BASE TABLE | InnoDB |          0 |       16384 |        16384 |
| users                          | BASE TABLE | InnoDB |          3 |       16384 |       147456 |
| verification_codes             | BASE TABLE | InnoDB |          0 |       16384 |        32768 |
+--------------------------------+------------+--------+------------+-------------+--------------+
36 rows in set (0.087 sec)

MySQL [ikoota_db]> SELECT
    ->     TABLE_NAME,
    ->     COLUMN_NAME,
    ->     DATA_TYPE,
    ->     IS_NULLABLE,
    ->     COLUMN_DEFAULT,
    ->     COLUMN_KEY,
    ->     EXTRA,
    ->     COLUMN_COMMENT
    -> FROM INFORMATION_SCHEMA.COLUMNS
    -> WHERE TABLE_SCHEMA = 'ikoota_db'
    -> ORDER BY TABLE_NAME, ORDINAL_POSITION;
+--------------------------------+-----------------------------+------------+-------------+---------------------+------------+-----------------------------------------------+----------------+
| TABLE_NAME                     | COLUMN_NAME                 | DATA_TYPE  | IS_NULLABLE | COLUMN_DEFAULT      | COLUMN_KEY | EXTRA                                         | COLUMN_COMMENT |
+--------------------------------+-----------------------------+------------+-------------+---------------------+------------+-----------------------------------------------+----------------+
| admin_membership_overview      | id                          | int        | NO          | 0                   |            |                                               |                |
| admin_membership_overview      | username                    | varchar    | NO          | NULL                |            |                                               |                |
| admin_membership_overview      | email                       | varchar    | NO          | NULL                |            |                                               |                |
| admin_membership_overview      | converse_id                 | varchar    | YES         | NULL                |            |                                               |                |
| admin_membership_overview      | initial_status              | enum       | YES         | applied             |            |                                               |                |
| admin_membership_overview      | membership_stage            | enum       | YES         | none                |            |                                               |                |
| admin_membership_overview      | initial_ticket              | varchar    | YES         | NULL                |            |                                               |                |
| admin_membership_overview      | full_membership_status      | enum       | YES         | not_applied         |            |                                               |                |
| admin_membership_overview      | full_membership_ticket      | varchar    | YES         | NULL                |            |                                               |                |
| admin_membership_overview      | full_membership_applied_at  | timestamp  | YES         | NULL                |            |                                               |                |
| admin_membership_overview      | initial_submitted           | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| admin_membership_overview      | initial_approval_status     | enum       | YES         | pending             |            |                                               |                |
| admin_membership_overview      | initial_reviewer            | int        | YES         | NULL                |            |                                               |                |
| admin_membership_overview      | initial_reviewed_at         | timestamp  | YES         | NULL                |            |                                               |                |
| admin_membership_overview      | initial_verified_by         | char       | YES         | NULL                |            |                                               |                |
| admin_membership_overview      | initial_admin_notes         | text       | YES         | NULL                |            |                                               |                |
| admin_membership_overview      | full_submitted              | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| admin_membership_overview      | full_application_status     | enum       | YES         | pending             |            |                                               |                |
| admin_membership_overview      | full_reviewed_at            | timestamp  | YES         | NULL                |            |                                               |                |
| admin_membership_overview      | full_reviewer               | int        | YES         | NULL                |            |                                               |                |
| admin_membership_overview      | full_admin_notes            | text       | YES         | NULL                |            |                                               |                |
| admin_membership_overview      | full_reviewer_name          | varchar    | YES         | NULL                |            |                                               |                |
| admin_membership_overview      | user_created                | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| all_applications_status        | application_type            | varchar    | NO          |                     |            |                                               |                |
| all_applications_status        | user_id                     | int        | NO          | 0                   |            |                                               |                |
| all_applications_status        | username                    | varchar    | NO          |                     |            |                                               |                |
| all_applications_status        | email                       | varchar    | NO          |                     |            |                                               |                |
| all_applications_status        | ticket                      | varchar    | YES         | NULL                |            |                                               |                |
| all_applications_status        | status                      | varchar    | YES         | NULL                |            |                                               |                |
| all_applications_status        | submitted_at                | timestamp  | YES         | NULL                |            |                                               |                |
| all_applications_status        | reviewed_at                 | timestamp  | YES         | NULL                |            |                                               |                |
| all_applications_status        | reviewed_by                 | int        | YES         | NULL                |            |                                               |                |
| all_applications_status        | admin_notes                 | mediumtext | YES         | NULL                |            |                                               |                |
| all_applications_status        | reviewer_name               | varchar    | YES         | NULL                |            |                                               |                |
| audit_logs                     | id                          | int        | NO          | NULL                | PRI        | auto_increment                                |                |
| audit_logs                     | admin_id                    | char       | NO          | NULL                | MUL        |                                               |                |
| audit_logs                     | action                      | varchar    | NO          | NULL                |            |                                               |                |
| audit_logs                     | target_id                   | char       | YES         | NULL                | MUL        |                                               |                |
| audit_logs                     | details                     | text       | YES         | NULL                |            |                                               |                |
| audit_logs                     | createdAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| bulk_email_logs                | id                          | int        | NO          | NULL                | PRI        | auto_increment                                |                |
| bulk_email_logs                | recipients_count            | int        | NO          | NULL                |            |                                               |                |
| bulk_email_logs                | subject                     | varchar    | YES         | NULL                |            |                                               |                |
| bulk_email_logs                | template                    | varchar    | YES         | NULL                | MUL        |                                               |                |
| bulk_email_logs                | successful_count            | int        | YES         | 0                   |            |                                               |                |
| bulk_email_logs                | failed_count                | int        | YES         | 0                   |            |                                               |                |
| bulk_email_logs                | sender_id                   | char       | YES         | NULL                | MUL        |                                               |                |
| bulk_email_logs                | createdAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   | MUL        | DEFAULT_GENERATED                             |                |
| bulk_email_logs                | updatedAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |                |
| bulk_email_logs                | processedAt                 | timestamp  | YES         | NULL                |            |                                               |                |
| bulk_sms_logs                  | id                          | int        | NO          | NULL                | PRI        | auto_increment                                |                |
| bulk_sms_logs                  | recipients_count            | int        | NO          | NULL                |            |                                               |                |
| bulk_sms_logs                  | message                     | text       | YES         | NULL                |            |                                               |                |
| bulk_sms_logs                  | template                    | varchar    | YES         | NULL                | MUL        |                                               |                |
| bulk_sms_logs                  | successful_count            | int        | YES         | 0                   |            |                                               |                |
| bulk_sms_logs                  | failed_count                | int        | YES         | 0                   |            |                                               |                |
| bulk_sms_logs                  | sender_id                   | char       | YES         | NULL                | MUL        |                                               |                |
| bulk_sms_logs                  | createdAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   | MUL        | DEFAULT_GENERATED                             |                |
| bulk_sms_logs                  | updatedAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |                |
| bulk_sms_logs                  | processedAt                 | timestamp  | YES         | NULL                |            |                                               |                |
| chats                          | id                          | int        | NO          | NULL                | PRI        | auto_increment                                |                |
| chats                          | title                       | varchar    | NO          | NULL                |            |                                               |                |
| chats                          | user_id                     | char       | NO          | NULL                | MUL        |                                               |                |
| chats                          | audience                    | varchar    | YES         | NULL                |            |                                               |                |
| chats                          | summary                     | text       | YES         | NULL                |            |                                               |                |
| chats                          | text                        | text       | YES         | NULL                |            |                                               |                |
| chats                          | approval_status             | enum       | YES         | pending             |            |                                               |                |
| chats                          | media_url1                  | varchar    | YES         | NULL                |            |                                               |                |
| chats                          | media_type1                 | enum       | YES         | NULL                |            |                                               |                |
| chats                          | media_url2                  | varchar    | YES         | NULL                |            |                                               |                |
| chats                          | media_type2                 | enum       | YES         | NULL                |            |                                               |                |
| chats                          | media_url3                  | varchar    | YES         | NULL                |            |                                               |                |
| chats                          | is_flagged                  | tinyint    | YES         | 0                   |            |                                               |                |
| chats                          | media_type3                 | enum       | YES         | NULL                |            |                                               |                |
| chats                          | createdAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| chats                          | updatedAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| chats                          | prefixed_id                 | varchar    | YES         | NULL                | UNI        |                                               |                |
| class_content_access           | id                          | int        | NO          | NULL                | PRI        | auto_increment                                |                |
| class_content_access           | content_id                  | int        | NO          | NULL                | MUL        |                                               |                |
| class_content_access           | content_type                | enum       | NO          | NULL                |            |                                               |                |
| class_content_access           | class_id                    | varchar    | NO          | NULL                | MUL        |                                               |                |
| class_content_access           | access_level                | enum       | YES         | read                |            |                                               |                |
| class_content_access           | createdAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| class_member_counts            | class_id                    | varchar    | NO          | NULL                |            |                                               |                |
| class_member_counts            | class_name                  | varchar    | NO          | NULL                |            |                                               |                |
| class_member_counts            | class_type                  | enum       | YES         | demographic         |            |                                               |                |
| class_member_counts            | is_public                   | tinyint    | YES         | 0                   |            |                                               |                |
| class_member_counts            | total_members               | bigint     | NO          | 0                   |            |                                               |                |
| class_member_counts            | moderators                  | bigint     | NO          | 0                   |            |                                               |                |
| class_member_counts            | pending_members             | bigint     | NO          | 0                   |            |                                               |                |
| classes                        | id                          | int        | NO          | NULL                | PRI        | auto_increment                                |                |
| classes                        | class_id                    | varchar    | NO          | NULL                | UNI        |                                               |                |
| classes                        | class_name                  | varchar    | NO          | NULL                |            |                                               |                |
| classes                        | public_name                 | varchar    | YES         | NULL                |            |                                               |                |
| classes                        | description                 | text       | YES         | NULL                |            |                                               |                |
| classes                        | class_type                  | enum       | YES         | demographic         | MUL        |                                               |                |
| classes                        | is_public                   | tinyint    | YES         | 0                   | MUL        |                                               |                |
| classes                        | max_members                 | int        | YES         | 50                  |            |                                               |                |
| classes                        | privacy_level               | enum       | YES         | members_only        |            |                                               |                |
| classes                        | created_by                  | int        | YES         | NULL                | MUL        |                                               |                |
| classes                        | is_active                   | tinyint    | YES         | 1                   | MUL        |                                               |                |
| classes                        | createdAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| classes                        | updatedAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| comments                       | id                          | int        | NO          | NULL                | PRI        | auto_increment                                |                |
| comments                       | user_id                     | char       | NO          | NULL                | MUL        |                                               |                |
| comments                       | chat_id                     | int        | YES         | NULL                | MUL        |                                               |                |
| comments                       | teaching_id                 | int        | YES         | NULL                | MUL        |                                               |                |
| comments                       | comment                     | text       | NO          | NULL                |            |                                               |                |
| comments                       | media_url1                  | varchar    | YES         | NULL                |            |                                               |                |
| comments                       | media_type1                 | enum       | YES         | NULL                |            |                                               |                |
| comments                       | media_url2                  | varchar    | YES         | NULL                |            |                                               |                |
| comments                       | media_type2                 | enum       | YES         | NULL                |            |                                               |                |
| comments                       | media_url3                  | varchar    | YES         | NULL                |            |                                               |                |
| comments                       | media_type3                 | enum       | YES         | NULL                |            |                                               |                |
| comments                       | createdAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| comments                       | updatedAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| converse_relationships         | id                          | int        | NO          | NULL                | PRI        | auto_increment                                |                |
| converse_relationships         | mentor_converse_id          | varchar    | YES         | NULL                | MUL        |                                               |                |
| converse_relationships         | mentee_converse_id          | varchar    | YES         | NULL                | MUL        |                                               |                |
| converse_relationships         | relationship_type           | enum       | YES         | mentor              |            |                                               |                |
| converse_relationships         | created_at                  | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| converse_relationships         | is_active                   | tinyint    | YES         | 1                   |            |                                               |                |
| email_logs                     | id                          | int        | NO          | NULL                | PRI        | auto_increment                                |                |
| email_logs                     | recipient                   | varchar    | NO          | NULL                | MUL        |                                               |                |
| email_logs                     | subject                     | varchar    | YES         | NULL                |            |                                               |                |
| email_logs                     | template                    | varchar    | YES         | NULL                | MUL        |                                               |                |
| email_logs                     | status                      | enum       | YES         | pending             | MUL        |                                               |                |
| email_logs                     | message_id                  | varchar    | YES         | NULL                |            |                                               |                |
| email_logs                     | error_message               | text       | YES         | NULL                |            |                                               |                |
| email_logs                     | sender_id                   | char       | YES         | NULL                | MUL        |                                               |                |
| email_logs                     | createdAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   | MUL        | DEFAULT_GENERATED                             |                |
| email_logs                     | updatedAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |                |
| email_logs                     | processedAt                 | timestamp  | YES         | NULL                |            |                                               |                |
| email_templates                | id                          | int        | NO          | NULL                | PRI        | auto_increment                                |                |
| email_templates                | name                        | varchar    | NO          | NULL                | UNI        |                                               |                |
| email_templates                | subject                     | varchar    | NO          | NULL                |            |                                               |                |
| email_templates                | body_text                   | text       | YES         | NULL                |            |                                               |                |
| email_templates                | body_html                   | text       | YES         | NULL                |            |                                               |                |
| email_templates                | variables                   | json       | YES         | NULL                |            |                                               |                |
| email_templates                | is_active                   | tinyint    | YES         | 1                   | MUL        |                                               |                |
| email_templates                | created_by                  | char       | YES         | NULL                | MUL        |                                               |                |
| email_templates                | createdAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| email_templates                | updatedAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |                |
| full_membership_access         | id                          | int        | NO          | NULL                | PRI        | auto_increment                                |                |
| full_membership_access         | user_id                     | int        | NO          | NULL                | UNI        |                                               |                |
| full_membership_access         | first_accessed_at           | timestamp  | YES         | CURRENT_TIMESTAMP   | MUL        | DEFAULT_GENERATED                             |                |
| full_membership_access         | last_accessed_at            | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |                |
| full_membership_access         | access_count                | int        | YES         | 1                   |            |                                               |                |
| full_membership_access_log     | id                          | int        | NO          | NULL                | PRI        | auto_increment                                |                |
| full_membership_access_log     | user_id                     | int        | NO          | NULL                | UNI        |                                               |                |
| full_membership_access_log     | first_access_at             | timestamp  | YES         | CURRENT_TIMESTAMP   | MUL        | DEFAULT_GENERATED                             |                |
| full_membership_access_log     | total_accesses              | int        | YES         | 1                   |            |                                               |                |
| full_membership_access_log     | last_access_at              | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |                |
| full_membership_access_log     | ip_address                  | varchar    | YES         | NULL                |            |                                               |                |
| full_membership_access_log     | user_agent                  | text       | YES         | NULL                |            |                                               |                |
| full_membership_applications   | id                          | int        | NO          | NULL                | PRI        | auto_increment                                |                |
| full_membership_applications   | user_id                     | int        | NO          | NULL                | UNI        |                                               |                |
| full_membership_applications   | membership_ticket           | varchar    | NO          | NULL                | MUL        |                                               |                |
| full_membership_applications   | answers                     | json       | NO          | NULL                |            |                                               |                |
| full_membership_applications   | status                      | enum       | YES         | pending             | MUL        |                                               |                |
| full_membership_applications   | submitted_at                | timestamp  | YES         | CURRENT_TIMESTAMP   | MUL        | DEFAULT_GENERATED                             |                |
| full_membership_applications   | reviewed_at                 | timestamp  | YES         | NULL                |            |                                               |                |
| full_membership_applications   | reviewed_by                 | int        | YES         | NULL                | MUL        |                                               |                |
| full_membership_applications   | admin_notes                 | text       | YES         | NULL                |            |                                               |                |
| id_generation_log              | id                          | int        | NO          | NULL                | PRI        | auto_increment                                |                |
| id_generation_log              | generated_id                | char       | NO          | NULL                | MUL        |                                               |                |
| id_generation_log              | id_type                     | enum       | NO          | NULL                | MUL        |                                               |                |
| id_generation_log              | generated_by                | char       | YES         | NULL                | MUL        |                                               |                |
| id_generation_log              | generated_at                | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| id_generation_log              | purpose                     | varchar    | YES         | NULL                |            |                                               |                |
| identity_masking_audit         | id                          | int        | NO          | NULL                | PRI        | auto_increment                                |                |
| identity_masking_audit         | user_id                     | int        | NO          | NULL                | MUL        |                                               |                |
| identity_masking_audit         | converse_id                 | varchar    | YES         | NULL                | MUL        |                                               |                |
| identity_masking_audit         | masked_by_admin_id          | varchar    | YES         | NULL                | MUL        |                                               |                |
| identity_masking_audit         | original_username           | varchar    | YES         | NULL                |            |                                               |                |
| identity_masking_audit         | createdAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| identity_masking_audit         | reason                      | text       | YES         | NULL                |            |                                               |                |
| membership_review_history      | id                          | int        | NO          | NULL                | PRI        | auto_increment                                |                |
| membership_review_history      | user_id                     | int        | NO          | NULL                | MUL        |                                               |                |
| membership_review_history      | application_type            | enum       | NO          | NULL                | MUL        |                                               |                |
| membership_review_history      | application_id              | int        | YES         | NULL                |            |                                               |                |
| membership_review_history      | reviewer_id                 | int        | YES         | NULL                | MUL        |                                               |                |
| membership_review_history      | previous_status             | enum       | YES         | NULL                |            |                                               |                |
| membership_review_history      | new_status                  | enum       | YES         | NULL                |            |                                               |                |
| membership_review_history      | review_notes                | text       | YES         | NULL                |            |                                               |                |
| membership_review_history      | action_taken                | enum       | NO          | NULL                |            |                                               |                |
| membership_review_history      | reviewed_at                 | timestamp  | YES         | CURRENT_TIMESTAMP   | MUL        | DEFAULT_GENERATED                             |                |
| membership_review_history      | notification_sent           | tinyint    | YES         | 0                   |            |                                               |                |
| membership_stats               | category                    | varchar    | NO          |                     |            |                                               |                |
| membership_stats               | status                      | varchar    | YES         | NULL                |            |                                               |                |
| membership_stats               | count                       | bigint     | NO          | 0                   |            |                                               |                |
| pending_applications_overview  | application_stage           | varchar    | NO          |                     |            |                                               |                |
| pending_applications_overview  | user_id                     | int        | NO          | 0                   |            |                                               |                |
| pending_applications_overview  | username                    | varchar    | NO          |                     |            |                                               |                |
| pending_applications_overview  | email                       | varchar    | NO          |                     |            |                                               |                |
| pending_applications_overview  | ticket                      | varchar    | YES         | NULL                |            |                                               |                |
| pending_applications_overview  | submitted_at                | timestamp  | YES         | NULL                |            |                                               |                |
| pending_applications_overview  | status                      | varchar    | YES         | NULL                |            |                                               |                |
| pending_applications_overview  | days_pending                | bigint     | YES         | NULL                |            |                                               |                |
| pending_applications_overview  | answers                     | mediumtext | YES         | NULL                |            |                                               |                |
| pending_applications_overview  | application_id              | int        | NO          | 0                   |            |                                               |                |
| pending_applications_overview  | notes                       | mediumtext | YES         | NULL                |            |                                               |                |
| pending_full_memberships       | application_stage           | varchar    | NO          |                     |            |                                               |                |
| pending_full_memberships       | user_id                     | int        | NO          | 0                   |            |                                               |                |
| pending_full_memberships       | username                    | varchar    | NO          | NULL                |            |                                               |                |
| pending_full_memberships       | email                       | varchar    | NO          | NULL                |            |                                               |                |
| pending_full_memberships       | ticket                      | varchar    | NO          | NULL                |            |                                               |                |
| pending_full_memberships       | submitted_at                | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| pending_full_memberships       | status                      | enum       | YES         | pending             |            |                                               |                |
| pending_full_memberships       | days_pending                | int        | YES         | NULL                |            |                                               |                |
| pending_full_memberships       | answers                     | text       | NO          | NULL                |            |                                               |                |
| pending_full_memberships       | application_id              | int        | NO          | 0                   |            |                                               |                |
| pending_full_memberships       | notes                       | text       | YES         | NULL                |            |                                               |                |
| pending_initial_applications   | application_stage           | varchar    | NO          |                     |            |                                               |                |
| pending_initial_applications   | user_id                     | int        | NO          | 0                   |            |                                               |                |
| pending_initial_applications   | username                    | varchar    | NO          | NULL                |            |                                               |                |
| pending_initial_applications   | email                       | varchar    | NO          | NULL                |            |                                               |                |
| pending_initial_applications   | ticket                      | varchar    | YES         | NULL                |            |                                               |                |
| pending_initial_applications   | submitted_at                | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| pending_initial_applications   | status                      | enum       | YES         | pending             |            |                                               |                |
| pending_initial_applications   | days_pending                | int        | YES         | NULL                |            |                                               |                |
| pending_initial_applications   | answers                     | text       | YES         | NULL                |            |                                               |                |
| pending_initial_applications   | application_id              | int        | NO          | 0                   |            |                                               |                |
| pending_initial_applications   | notes                       | text       | YES         | NULL                |            |                                               |                |
| reports                        | id                          | int        | NO          | NULL                | PRI        | auto_increment                                |                |
| reports                        | reporter_id                 | char       | NO          | NULL                | MUL        |                                               |                |
| reports                        | reported_id                 | char       | YES         | NULL                | MUL        |                                               |                |
| reports                        | reason                      | text       | NO          | NULL                |            |                                               |                |
| reports                        | status                      | enum       | YES         | pending             |            |                                               |                |
| reports                        | createdAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| sms_logs                       | id                          | int        | NO          | NULL                | PRI        | auto_increment                                |                |
| sms_logs                       | recipient                   | varchar    | NO          | NULL                | MUL        |                                               |                |
| sms_logs                       | message                     | text       | YES         | NULL                |            |                                               |                |
| sms_logs                       | template                    | varchar    | YES         | NULL                | MUL        |                                               |                |
| sms_logs                       | status                      | enum       | YES         | pending             | MUL        |                                               |                |
| sms_logs                       | sid                         | varchar    | YES         | NULL                |            |                                               |                |
| sms_logs                       | error_message               | text       | YES         | NULL                |            |                                               |                |
| sms_logs                       | sender_id                   | char       | YES         | NULL                | MUL        |                                               |                |
| sms_logs                       | createdAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   | MUL        | DEFAULT_GENERATED                             |                |
| sms_logs                       | updatedAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |                |
| sms_logs                       | processedAt                 | timestamp  | YES         | NULL                |            |                                               |                |
| sms_templates                  | id                          | int        | NO          | NULL                | PRI        | auto_increment                                |                |
| sms_templates                  | name                        | varchar    | NO          | NULL                | UNI        |                                               |                |
| sms_templates                  | message                     | text       | NO          | NULL                |            |                                               |                |
| sms_templates                  | variables                   | json       | YES         | NULL                |            |                                               |                |
| sms_templates                  | is_active                   | tinyint    | YES         | 1                   | MUL        |                                               |                |
| sms_templates                  | created_by                  | char       | YES         | NULL                | MUL        |                                               |                |
| sms_templates                  | createdAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| sms_templates                  | updatedAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |                |
| survey_questions               | id                          | int        | NO          | NULL                | PRI        | auto_increment                                |                |
| survey_questions               | question                    | text       | NO          | NULL                |            |                                               |                |
| survey_questions               | createdAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| survey_questions               | updatedAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |                |
| survey_questions               | is_active                   | tinyint    | YES         | 1                   |            |                                               |                |
| survey_questions               | question_order              | int        | YES         | 0                   |            |                                               |                |
| surveylog                      | id                          | int        | NO          | NULL                | PRI        | auto_increment                                |                |
| surveylog                      | user_id                     | char       | NO          | NULL                | MUL        |                                               |                |
| surveylog                      | answers                     | text       | YES         | NULL                |            |                                               |                |
| surveylog                      | verified_by                 | char       | NO          | NULL                | MUL        |                                               |                |
| surveylog                      | rating_remarks              | varchar    | NO          | NULL                |            |                                               |                |
| surveylog                      | approval_status             | enum       | YES         | pending             | MUL        |                                               |                |
| surveylog                      | createdAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| surveylog                      | updatedAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |                |
| surveylog                      | processedAt                 | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| surveylog                      | admin_notes                 | text       | YES         | NULL                |            |                                               |                |
| surveylog                      | application_type            | enum       | YES         | initial_application | MUL        |                                               |                |
| surveylog                      | reviewed_at                 | timestamp  | YES         | NULL                | MUL        |                                               |                |
| surveylog                      | reviewed_by                 | int        | YES         | NULL                | MUL        |                                               |                |
| teachings                      | id                          | int        | NO          | NULL                | PRI        | auto_increment                                |                |
| teachings                      | topic                       | varchar    | NO          | NULL                |            |                                               |                |
| teachings                      | description                 | text       | YES         | NULL                |            |                                               |                |
| teachings                      | lessonNumber                | varchar    | NO          | NULL                |            |                                               |                |
| teachings                      | subjectMatter               | varchar    | YES         | NULL                |            |                                               |                |
| teachings                      | audience                    | varchar    | YES         | NULL                |            |                                               |                |
| teachings                      | content                     | text       | YES         | NULL                |            |                                               |                |
| teachings                      | media_url1                  | varchar    | YES         | NULL                |            |                                               |                |
| teachings                      | media_type1                 | enum       | YES         | NULL                |            |                                               |                |
| teachings                      | media_url2                  | varchar    | YES         | NULL                |            |                                               |                |
| teachings                      | media_type2                 | enum       | YES         | NULL                |            |                                               |                |
| teachings                      | media_url3                  | varchar    | YES         | NULL                |            |                                               |                |
| teachings                      | media_type3                 | enum       | YES         | NULL                |            |                                               |                |
| teachings                      | createdAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| teachings                      | updatedAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |                |
| teachings                      | user_id                     | char       | NO          | NULL                | MUL        |                                               |                |
| teachings                      | prefixed_id                 | varchar    | YES         | NULL                | UNI        |                                               |                |
| user_chats                     | id                          | int        | NO          | NULL                | PRI        | auto_increment                                |                |
| user_chats                     | user_id                     | char       | NO          | NULL                | MUL        |                                               |                |
| user_chats                     | chat_id                     | char       | NO          | NULL                |            |                                               |                |
| user_chats                     | last_message                | varchar    | YES         | NULL                |            |                                               |                |
| user_chats                     | is_seen                     | tinyint    | YES         | 0                   |            |                                               |                |
| user_chats                     | role                        | enum       | NO          | NULL                |            |                                               |                |
| user_chats                     | is_muted                    | tinyint    | YES         | 0                   |            |                                               |                |
| user_chats                     | last_read_message_id        | varchar    | YES         | NULL                |            |                                               |                |
| user_chats                     | joined_at                   | datetime   | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| user_chats                     | updatedAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| user_class_details             | user_id                     | int        | NO          | NULL                |            |                                               |                |
| user_class_details             | username                    | varchar    | NO          | NULL                |            |                                               |                |
| user_class_details             | converse_id                 | varchar    | YES         | NULL                |            |                                               |                |
| user_class_details             | class_id                    | varchar    | NO          | NULL                |            |                                               |                |
| user_class_details             | class_name                  | varchar    | NO          | NULL                |            |                                               |                |
| user_class_details             | public_name                 | varchar    | YES         | NULL                |            |                                               |                |
| user_class_details             | class_type                  | enum       | YES         | demographic         |            |                                               |                |
| user_class_details             | is_public                   | tinyint    | YES         | 0                   |            |                                               |                |
| user_class_details             | membership_status           | enum       | YES         | active              |            |                                               |                |
| user_class_details             | role_in_class               | enum       | YES         | member              |            |                                               |                |
| user_class_details             | can_see_class_name          | tinyint    | YES         | 1                   |            |                                               |                |
| user_class_details             | joined_at                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| user_class_memberships         | id                          | int        | NO          | NULL                | PRI        | auto_increment                                |                |
| user_class_memberships         | user_id                     | int        | NO          | NULL                | MUL        |                                               |                |
| user_class_memberships         | class_id                    | varchar    | NO          | NULL                | MUL        |                                               |                |
| user_class_memberships         | membership_status           | enum       | YES         | active              | MUL        |                                               |                |
| user_class_memberships         | role_in_class               | enum       | YES         | member              |            |                                               |                |
| user_class_memberships         | joined_at                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| user_class_memberships         | assigned_by                 | int        | YES         | NULL                | MUL        |                                               |                |
| user_class_memberships         | expires_at                  | timestamp  | YES         | NULL                |            |                                               |                |
| user_class_memberships         | can_see_class_name          | tinyint    | YES         | 1                   |            |                                               |                |
| user_class_memberships         | receive_notifications       | tinyint    | YES         | 1                   |            |                                               |                |
| user_class_memberships         | createdAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| user_class_memberships         | updatedAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |                |
| user_communication_preferences | id                          | int        | NO          | NULL                | PRI        | auto_increment                                |                |
| user_communication_preferences | user_id                     | int        | NO          | NULL                | UNI        |                                               |                |
| user_communication_preferences | email_notifications         | tinyint    | YES         | 1                   |            |                                               |                |
| user_communication_preferences | sms_notifications           | tinyint    | YES         | 0                   |            |                                               |                |
| user_communication_preferences | marketing_emails            | tinyint    | YES         | 1                   |            |                                               |                |
| user_communication_preferences | marketing_sms               | tinyint    | YES         | 0                   |            |                                               |                |
| user_communication_preferences | survey_notifications        | tinyint    | YES         | 1                   |            |                                               |                |
| user_communication_preferences | content_notifications       | tinyint    | YES         | 1                   |            |                                               |                |
| user_communication_preferences | admin_notifications         | tinyint    | YES         | 1                   |            |                                               |                |
| user_communication_preferences | preferred_language          | varchar    | YES         | en                  |            |                                               |                |
| user_communication_preferences | timezone                    | varchar    | YES         | UTC                 |            |                                               |                |
| user_communication_preferences | createdAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| user_communication_preferences | updatedAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |                |
| user_communication_preferences | converse_id                 | char       | YES         | NULL                | MUL        |                                               |                |
| user_profiles                  | id                          | int        | NO          | NULL                | PRI        | auto_increment                                |                |
| user_profiles                  | user_id                     | int        | NO          | NULL                | UNI        |                                               |                |
| user_profiles                  | encrypted_username          | text       | NO          | NULL                |            |                                               |                |
| user_profiles                  | encrypted_email             | text       | NO          | NULL                |            |                                               |                |
| user_profiles                  | encrypted_phone             | text       | YES         | NULL                |            |                                               |                |
| user_profiles                  | encryption_key              | varchar    | YES         | NULL                |            |                                               |                |
| user_profiles                  | createdAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| user_profiles                  | updatedAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| users                          | id                          | int        | NO          | NULL                | PRI        | auto_increment                                |                |
| users                          | username                    | varchar    | NO          | NULL                |            |                                               |                |
| users                          | email                       | varchar    | NO          | NULL                |            |                                               |                |
| users                          | phone                       | varchar    | YES         | NULL                |            |                                               |                |
| users                          | avatar                      | varchar    | YES         | NULL                |            |                                               |                |
| users                          | password_hash               | varchar    | NO          | NULL                |            |                                               |                |
| users                          | converse_id                 | varchar    | YES         | NULL                | UNI        |                                               |                |
| users                          | application_ticket          | varchar    | YES         | NULL                | MUL        |                                               |                |
| users                          | mentor_id                   | char       | YES         | NULL                | MUL        |                                               |                |
| users                          | primary_class_id            | varchar    | YES         | NULL                | MUL        |                                               |                |
| users                          | is_member                   | enum       | YES         | applied             |            |                                               |                |
| users                          | membership_stage            | enum       | YES         | none                | MUL        |                                               |                |
| users                          | full_membership_ticket      | varchar    | YES         | NULL                |            |                                               |                |
| users                          | full_membership_status      | enum       | YES         | not_applied         | MUL        |                                               |                |
| users                          | full_membership_applied_at  | timestamp  | YES         | NULL                | MUL        |                                               |                |
| users                          | full_membership_reviewed_at | timestamp  | YES         | NULL                |            |                                               |                |
| users                          | role                        | enum       | YES         | user                |            |                                               |                |
| users                          | isblocked                   | json       | YES         | NULL                |            |                                               |                |
| users                          | isbanned                    | tinyint    | YES         | 0                   |            |                                               |                |
| users                          | createdAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| users                          | updatedAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
| users                          | resetToken                  | varchar    | YES         | NULL                |            |                                               |                |
| users                          | resetTokenExpiry            | bigint     | YES         | NULL                |            |                                               |                |
| users                          | verification_method         | enum       | YES         | NULL                |            |                                               |                |
| users                          | verification_code           | varchar    | YES         | NULL                |            |                                               |                |
| users                          | is_verified                 | tinyint    | YES         | 0                   | MUL        |                                               |                |
| users                          | codeExpiry                  | bigint     | YES         | NULL                |            |                                               |                |
| users                          | converse_avatar             | varchar    | YES         | NULL                |            |                                               |                |
| users                          | is_identity_masked          | tinyint    | YES         | 0                   |            |                                               |                |
| users                          | total_classes               | int        | YES         | 0                   |            |                                               |                |
| verification_codes             | id                          | int        | NO          | NULL                | PRI        | auto_increment                                |                |
| verification_codes             | email                       | varchar    | NO          | NULL                | MUL        |                                               |                |
| verification_codes             | phone                       | varchar    | YES         | NULL                |            |                                               |                |
| verification_codes             | code                        | varchar    | NO          | NULL                |            |                                               |                |
| verification_codes             | method                      | enum       | NO          | NULL                |            |                                               |                |
| verification_codes             | expiresAt                   | timestamp  | NO          | NULL                | MUL        |                                               |                |
| verification_codes             | createdAt                   | timestamp  | YES         | CURRENT_TIMESTAMP   |            | DEFAULT_GENERATED                             |                |
+--------------------------------+-----------------------------+------------+-------------+---------------------+------------+-----------------------------------------------+----------------+
378 rows in set (0.138 sec)

MySQL [ikoota_db]> SELECT
    ->     t.TABLE_NAME,
    ->     GROUP_CONCAT(k.COLUMN_NAME ORDER BY k.ORDINAL_POSITION) as PRIMARY_KEY_COLUMNS
    -> FROM INFORMATION_SCHEMA.TABLES t
    -> LEFT JOIN INFORMATION_SCHEMA.KEY_COLUMN_USAGE k
    ->     ON t.TABLE_SCHEMA = k.TABLE_SCHEMA
    ->     AND t.TABLE_NAME = k.TABLE_NAME
    ->     AND k.CONSTRAINT_NAME = 'PRIMARY'
    -> WHERE t.TABLE_SCHEMA = 'ikoota_db'
    ->     AND t.TABLE_TYPE = 'BASE TABLE'
    -> GROUP BY t.TABLE_NAME
    -> ORDER BY t.TABLE_NAME;
+--------------------------------+---------------------+
| TABLE_NAME                     | PRIMARY_KEY_COLUMNS |
+--------------------------------+---------------------+
| audit_logs                     | id                  |
| bulk_email_logs                | id                  |
| bulk_sms_logs                  | id                  |
| chats                          | id                  |
| class_content_access           | id                  |
| classes                        | id                  |
| comments                       | id                  |
| converse_relationships         | id                  |
| email_logs                     | id                  |
| email_templates                | id                  |
| full_membership_access         | id                  |
| full_membership_access_log     | id                  |
| full_membership_applications   | id                  |
| id_generation_log              | id                  |
| identity_masking_audit         | id                  |
| membership_review_history      | id                  |
| reports                        | id                  |
| sms_logs                       | id                  |
| sms_templates                  | id                  |
| survey_questions               | id                  |
| surveylog                      | id                  |
| teachings                      | id                  |
| user_chats                     | id                  |
| user_class_memberships         | id                  |
| user_communication_preferences | id                  |
| user_profiles                  | id                  |
| users                          | id                  |
| verification_codes             | id                  |
+--------------------------------+---------------------+
28 rows in set (0.109 sec)

MySQL [ikoota_db]> SELECT 'ACTUAL TABLES' as type;
+---------------+
| type          |
+---------------+
| ACTUAL TABLES |
+---------------+
1 row in set (0.073 sec)

MySQL [ikoota_db]> SELECT TABLE_NAME
    -> FROM INFORMATION_SCHEMA.TABLES
    -> WHERE TABLE_SCHEMA = 'ikoota_db'
    ->     AND TABLE_TYPE = 'BASE TABLE'
    -> ORDER BY TABLE_NAME;
+--------------------------------+
| TABLE_NAME                     |
+--------------------------------+
| audit_logs                     |
| bulk_email_logs                |
| bulk_sms_logs                  |
| chats                          |
| class_content_access           |
| classes                        |
| comments                       |
| converse_relationships         |
| email_logs                     |
| email_templates                |
| full_membership_access         |
| full_membership_access_log     |
| full_membership_applications   |
| id_generation_log              |
| identity_masking_audit         |
| membership_review_history      |
| reports                        |
| sms_logs                       |
| sms_templates                  |
| survey_questions               |
| surveylog                      |
| teachings                      |
| user_chats                     |
| user_class_memberships         |
| user_communication_preferences |
| user_profiles                  |
| users                          |
| verification_codes             |
+--------------------------------+
28 rows in set (0.069 sec)

MySQL [ikoota_db]>
MySQL [ikoota_db]> -- Show only views
MySQL [ikoota_db]> SELECT 'VIEWS' as type;
+-------+
| type  |
+-------+
| VIEWS |
+-------+
1 row in set (0.047 sec)

MySQL [ikoota_db]> SELECT TABLE_NAME
    -> FROM INFORMATION_SCHEMA.TABLES
    -> WHERE TABLE_SCHEMA = 'ikoota_db'
    ->     AND TABLE_TYPE = 'VIEW'
    -> ORDER BY TABLE_NAME;
+-------------------------------+
| TABLE_NAME                    |
+-------------------------------+
| admin_membership_overview     |
| all_applications_status       |
| class_member_counts           |
| membership_stats              |
| pending_applications_overview |
| pending_full_memberships      |
| pending_initial_applications  |
| user_class_details            |
+-------------------------------+
8 rows in set (0.042 sec)

MySQL [ikoota_db]> SELECT 'MEMBERSHIP SYSTEM TABLES' as category;
+--------------------------+
| category                 |
+--------------------------+
| MEMBERSHIP SYSTEM TABLES |
+--------------------------+
1 row in set (0.050 sec)

MySQL [ikoota_db]>
MySQL [ikoota_db]> DESCRIBE users;
+-----------------------------+---------------------------------------------------------------------------------------------+------+-----+-------------------+-------------------+
| Field                       | Type                                                                                        | Null | Key | Default           | Extra             |
+-----------------------------+---------------------------------------------------------------------------------------------+------+-----+-------------------+-------------------+
| id                          | int                                                                                         | NO   | PRI | NULL              | auto_increment    |
| username                    | varchar(255)                                                                                | NO   |     | NULL              |                   |
| email                       | varchar(255)                                                                                | NO   |     | NULL              |                   |
| phone                       | varchar(15)                                                                                 | YES  |     | NULL              |                   |
| avatar                      | varchar(255)                                                                                | YES  |     | NULL              |                   |
| password_hash               | varchar(255)                                                                                | NO   |     | NULL              |                   |
| converse_id                 | varchar(12)                                                                                 | YES  | UNI | NULL              |                   |
| application_ticket          | varchar(20)                                                                                 | YES  | MUL | NULL              |                   |
| mentor_id                   | char(10)                                                                                    | YES  | MUL | NULL              |                   |
| primary_class_id            | varchar(12)                                                                                 | YES  | MUL | NULL              |                   |
| is_member                   | enum('applied','pending','suspended','granted','declined','pre_member','member','rejected') | YES  |     | applied           |                   |
| membership_stage            | enum('none','applicant','pre_member','member')                                              | YES  | MUL | none              |                   |
| full_membership_ticket      | varchar(25)                                                                                 | YES  |     | NULL              |                   |
| full_membership_status      | enum('not_applied','applied','pending','suspended','approved','declined')                   | YES  | MUL | not_applied       |                   |
| full_membership_applied_at  | timestamp                                                                                   | YES  | MUL | NULL              |                   |
| full_membership_reviewed_at | timestamp                                                                                   | YES  |     | NULL              |                   |
| role                        | enum('super_admin','admin','user')                                                          | YES  |     | user              |                   |
| isblocked                   | json                                                                                        | YES  |     | NULL              |                   |
| isbanned                    | tinyint(1)                                                                                  | YES  |     | 0                 |                   |
| createdAt                   | timestamp                                                                                   | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| updatedAt                   | timestamp                                                                                   | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| resetToken                  | varchar(255)                                                                                | YES  |     | NULL              |                   |
| resetTokenExpiry            | bigint                                                                                      | YES  |     | NULL              |                   |
| verification_method         | enum('email','phone')                                                                       | YES  |     | NULL              |                   |
| verification_code           | varchar(10)                                                                                 | YES  |     | NULL              |                   |
| is_verified                 | tinyint(1)                                                                                  | YES  | MUL | 0                 |                   |
| codeExpiry                  | bigint                                                                                      | YES  |     | NULL              |                   |
| converse_avatar             | varchar(255)                                                                                | YES  |     | NULL              |                   |
| is_identity_masked          | tinyint(1)                                                                                  | YES  |     | 0                 |                   |
| total_classes               | int                                                                                         | YES  |     | 0                 |                   |
+-----------------------------+---------------------------------------------------------------------------------------------+------+-----+-------------------+-------------------+
30 rows in set (0.053 sec)

MySQL [ikoota_db]> SELECT '';
+--+
|  |
+--+
|  |
+--+
1 row in set (0.050 sec)

MySQL [ikoota_db]> DESCRIBE surveylog;
+------------------+---------------------------------------------------------------------------+------+-----+---------------------+-----------------------------------------------+
| Field            | Type                                                                      | Null | Key | Default             | Extra                                         |
+------------------+---------------------------------------------------------------------------+------+-----+---------------------+-----------------------------------------------+
| id               | int                                                                       | NO   | PRI | NULL                | auto_increment                                |
| user_id          | char(10)                                                                  | NO   | MUL | NULL                |                                               |
| answers          | text                                                                      | YES  |     | NULL                |                                               |
| verified_by      | char(10)                                                                  | NO   | MUL | NULL                |                                               |
| rating_remarks   | varchar(255)                                                              | NO   |     | NULL                |                                               |
| approval_status  | enum('pending','approved','rejected','under_review','granted','declined') | YES  | MUL | pending             |                                               |
| createdAt        | timestamp                                                                 | YES  |     | CURRENT_TIMESTAMP   | DEFAULT_GENERATED                             |
| updatedAt        | timestamp                                                                 | YES  |     | CURRENT_TIMESTAMP   | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
| processedAt      | timestamp                                                                 | YES  |     | CURRENT_TIMESTAMP   | DEFAULT_GENERATED                             |
| admin_notes      | text                                                                      | YES  |     | NULL                |                                               |
| application_type | enum('initial_application','full_membership')                             | YES  | MUL | initial_application |                                               |
| reviewed_at      | timestamp                                                                 | YES  | MUL | NULL                |                                               |
| reviewed_by      | int                                                                       | YES  | MUL | NULL                |                                               |
+------------------+---------------------------------------------------------------------------+------+-----+---------------------+-----------------------------------------------+
13 rows in set (0.059 sec)

MySQL [ikoota_db]> SELECT '';
+--+
|  |
+--+
|  |
+--+
1 row in set (0.050 sec)

MySQL [ikoota_db]> DESCRIBE full_membership_applications;
+-------------------+---------------------------------------------------+------+-----+-------------------+-------------------+
| Field             | Type                                              | Null | Key | Default           | Extra             |
+-------------------+---------------------------------------------------+------+-----+-------------------+-------------------+
| id                | int                                               | NO   | PRI | NULL              | auto_increment    |
| user_id           | int                                               | NO   | UNI | NULL              |                   |
| membership_ticket | varchar(25)                                       | NO   | MUL | NULL              |                   |
| answers           | json                                              | NO   |     | NULL              |                   |
| status            | enum('pending','suspended','approved','declined') | YES  | MUL | pending           |                   |
| submitted_at      | timestamp                                         | YES  | MUL | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| reviewed_at       | timestamp                                         | YES  |     | NULL              |                   |
| reviewed_by       | int                                               | YES  | MUL | NULL              |                   |
| admin_notes       | text                                              | YES  |     | NULL              |                   |
+-------------------+---------------------------------------------------+------+-----+-------------------+-------------------+
9 rows in set (0.070 sec)

MySQL [ikoota_db]> SELECT '';
+--+
|  |
+--+
|  |
+--+
1 row in set (0.057 sec)

MySQL [ikoota_db]> DESCRIBE full_membership_access;
+-------------------+-----------+------+-----+-------------------+-----------------------------------------------+
| Field             | Type      | Null | Key | Default           | Extra                                         |
+-------------------+-----------+------+-----+-------------------+-----------------------------------------------+
| id                | int       | NO   | PRI | NULL              | auto_increment                                |
| user_id           | int       | NO   | UNI | NULL              |                                               |
| first_accessed_at | timestamp | YES  | MUL | CURRENT_TIMESTAMP | DEFAULT_GENERATED                             |
| last_accessed_at  | timestamp | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
| access_count      | int       | YES  |     | 1                 |                                               |
+-------------------+-----------+------+-----+-------------------+-----------------------------------------------+
5 rows in set (0.047 sec)

MySQL [ikoota_db]> SELECT '';
+--+
|  |
+--+
|  |
+--+
1 row in set (0.050 sec)

MySQL [ikoota_db]> DESCRIBE membership_review_history;
+-------------------+-------------------------------------------------------------+------+-----+-------------------+-------------------+
| Field             | Type                                                        | Null | Key | Default           | Extra             |
+-------------------+-------------------------------------------------------------+------+-----+-------------------+-------------------+
| id                | int                                                         | NO   | PRI | NULL              | auto_increment    |
| user_id           | int                                                         | NO   | MUL | NULL              |                   |
| application_type  | enum('initial_application','full_membership')               | NO   | MUL | NULL              |                   |
| application_id    | int                                                         | YES  |     | NULL              |                   |
| reviewer_id       | int                                                         | YES  | MUL | NULL              |                   |
| previous_status   | enum('pending','suspended','approved','declined')           | YES  |     | NULL              |                   |
| new_status        | enum('pending','suspended','approved','declined')           | YES  |     | NULL              |                   |
| review_notes      | text                                                        | YES  |     | NULL              |                   |
| action_taken      | enum('approve','decline','suspend','request_info','reopen') | NO   |     | NULL              |                   |
| reviewed_at       | timestamp                                                   | YES  | MUL | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| notification_sent | tinyint(1)                                                  | YES  |     | 0                 |                   |
+-------------------+-------------------------------------------------------------+------+-----+-------------------+-------------------+
11 rows in set (0.059 sec)

MySQL [ikoota_db]> SELECT '';
+--+
|  |
+--+
|  |
+--+
1 row in set (0.047 sec)

MySQL [ikoota_db]> DESCRIBE verification_codes;
+-----------+-----------------------+------+-----+-------------------+-------------------+
| Field     | Type                  | Null | Key | Default           | Extra             |
+-----------+-----------------------+------+-----+-------------------+-------------------+
| id        | int                   | NO   | PRI | NULL              | auto_increment    |
| email     | varchar(255)          | NO   | MUL | NULL              |                   |
| phone     | varchar(15)           | YES  |     | NULL              |                   |
| code      | varchar(10)           | NO   |     | NULL              |                   |
| method    | enum('email','phone') | NO   |     | NULL              |                   |
| expiresAt | timestamp             | NO   | MUL | NULL              |                   |
| createdAt | timestamp             | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
+-----------+-----------------------+------+-----+-------------------+-------------------+
7 rows in set (0.054 sec)

MySQL [ikoota_db]> SELECT
    ->     TABLE_NAME,
    ->     COLUMN_NAME,
    ->     CONSTRAINT_NAME,
    ->     REFERENCED_TABLE_NAME,
    ->     REFERENCED_COLUMN_NAME
    -> FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE
    -> WHERE TABLE_SCHEMA = 'ikoota_db'
    ->     AND REFERENCED_TABLE_NAME IS NOT NULL
    -> ORDER BY TABLE_NAME, COLUMN_NAME;
+--------------------------------+------------------+---------------------------------------+-----------------------+------------------------+
| TABLE_NAME                     | COLUMN_NAME      | CONSTRAINT_NAME                       | REFERENCED_TABLE_NAME | REFERENCED_COLUMN_NAME |
+--------------------------------+------------------+---------------------------------------+-----------------------+------------------------+
| class_content_access           | class_id         | class_content_access_ibfk_1           | classes               | class_id               |
| classes                        | created_by       | classes_ibfk_1                        | users                 | id                     |
| comments                       | chat_id          | comments_ibfk_2                       | chats                 | id                     |
| comments                       | teaching_id      | comments_ibfk_3                       | teachings             | id                     |
| full_membership_access         | user_id          | full_membership_access_ibfk_1         | users                 | id                     |
| full_membership_access_log     | user_id          | full_membership_access_log_ibfk_1     | users                 | id                     |
| full_membership_applications   | reviewed_by      | full_membership_applications_ibfk_2   | users                 | id                     |
| full_membership_applications   | user_id          | full_membership_applications_ibfk_1   | users                 | id                     |
| membership_review_history      | reviewer_id      | membership_review_history_ibfk_2      | users                 | id                     |
| membership_review_history      | user_id          | membership_review_history_ibfk_1      | users                 | id                     |
| surveylog                      | reviewed_by      | fk_surveylog_reviewed_by              | users                 | id                     |
| surveylog                      | reviewed_by      | surveylog_ibfk_1                      | users                 | id                     |
| user_class_memberships         | assigned_by      | user_class_memberships_ibfk_2         | users                 | id                     |
| user_class_memberships         | class_id         | user_class_memberships_ibfk_3         | classes               | class_id               |
| user_class_memberships         | user_id          | user_class_memberships_ibfk_1         | users                 | id                     |
| user_communication_preferences | user_id          | user_communication_preferences_ibfk_1 | users                 | id                     |
| user_profiles                  | user_id          | fk_user_profiles_user_id              | users                 | id                     |
| user_profiles                  | user_id          | user_profiles_ibfk_1                  | users                 | id                     |
| users                          | primary_class_id | users_ibfk_1                          | classes               | class_id               |
+--------------------------------+------------------+---------------------------------------+-----------------------+------------------------+
19 rows in set (0.063 sec)

MySQL [ikoota_db]> SELECT
    ->     TABLE_NAME,
    ->     TABLE_ROWS,
    ->     ROUND(((DATA_LENGTH + INDEX_LENGTH) / 1024 / 1024), 2) AS "Size (MB)",
    ->     ENGINE
    -> FROM INFORMATION_SCHEMA.TABLES
    -> WHERE TABLE_SCHEMA = 'ikoota_db'
    ->     AND TABLE_TYPE = 'BASE TABLE'
    -> ORDER BY (DATA_LENGTH + INDEX_LENGTH) DESC;
+--------------------------------+------------+-----------+--------+
| TABLE_NAME                     | TABLE_ROWS | Size (MB) | ENGINE |
+--------------------------------+------------+-----------+--------+
| users                          |          3 |      0.16 | InnoDB |
| classes                        |          7 |      0.13 | InnoDB |
| surveylog                      |          3 |      0.13 | InnoDB |
| user_class_memberships         |          0 |      0.11 | InnoDB |
| full_membership_applications   |          0 |      0.11 | InnoDB |
| teachings                      |         15 |      0.09 | InnoDB |
| email_logs                     |          0 |      0.09 | InnoDB |
| sms_logs                       |          0 |      0.09 | InnoDB |
| sms_templates                  |          7 |      0.08 | InnoDB |
| email_templates                |         10 |      0.08 | InnoDB |
| membership_review_history      |          0 |      0.08 | InnoDB |
| bulk_email_logs                |          0 |      0.06 | InnoDB |
| user_communication_preferences |          3 |      0.06 | InnoDB |
| identity_masking_audit         |          1 |      0.06 | InnoDB |
| id_generation_log              |          1 |      0.06 | InnoDB |
| full_membership_access_log     |          0 |      0.06 | InnoDB |
| converse_relationships         |          0 |      0.06 | InnoDB |
| comments                       |         10 |      0.06 | InnoDB |
| class_content_access           |          0 |      0.06 | InnoDB |
| chats                          |         17 |      0.06 | InnoDB |
| bulk_sms_logs                  |          0 |      0.06 | InnoDB |
| reports                        |          0 |      0.05 | InnoDB |
| full_membership_access         |          0 |      0.05 | InnoDB |
| audit_logs                     |          0 |      0.05 | InnoDB |
| verification_codes             |          0 |      0.05 | InnoDB |
| user_chats                     |          0 |      0.03 | InnoDB |
| user_profiles                  |          0 |      0.03 | InnoDB |
| survey_questions               |          0 |      0.02 | InnoDB |
+--------------------------------+------------+-----------+--------+
28 rows in set (0.058 sec)

MySQL [ikoota_db]>


ikootaclient\node_modules
ikootaclient\public
ikootaclient\public\arrowDown.png
ikootaclient\public\arrowUp.png
ikootaclient\public\avatar.png
ikootaclient\public\bg.jpg
ikootaclient\public\camera.png
ikootaclient\public\download.png
ikootaclient\public\edit.png
ikootaclient\public\emoji.png
ikootaclient\public\favicon.png
ikootaclient\public\iko background4.png
ikootaclient\public\img.png
ikootaclient\public\info.png
ikootaclient\public\mic.png
ikootaclient\public\minus.png
ikootaclient\public\more.png
ikootaclient\public\palmTree.png
ikootaclient\public\palmTree2.png
ikootaclient\public\palmTree3.png
ikootaclient\public\phone.png
ikootaclient\public\plus.png
ikootaclient\public\public
ikootaclient\public\search.png
ikootaclient\public\sky.png
ikootaclient\public\theme.png
ikootaclient\public\video.png
ikootaclient\src
ikootaclient\src\assets
ikootaclient\src\assets\react.svg
ikootaclient\src\components
ikootaclient\src\components\admin
ikootaclient\src\components\admin\admin.css
ikootaclient\src\components\admin\Admin.jsx
ikootaclient\src\components\admin\Analytics.jsx
ikootaclient\src\components\admin\audienceclassmgr.css
ikootaclient\src\components\admin\AudienceClassMgr.jsx
ikootaclient\src\components\admin\converseId.css
ikootaclient\src\components\admin\Dashboard.jsx
ikootaclient\src\components\admin\KeyStats.jsx
ikootaclient\src\components\admin\navbar.css
ikootaclient\src\components\admin\Navbar.jsx
ikootaclient\src\components\admin\PendingReports.jsx
ikootaclient\src\components\admin\Reports.jsx
ikootaclient\src\components\admin\sidbar.css
ikootaclient\src\components\admin\Sidebar.jsx
ikootaclient\src\components\admin\userManagement.css
ikootaclient\src\components\admin\UserManagement.jsx
ikootaclient\src\components\auth
ikootaclient\src\components\auth\AdminRoute.jsx
ikootaclient\src\components\auth\applicationsurvey.css
ikootaclient\src\components\auth\Applicationsurvey.jsx
ikootaclient\src\components\auth\authControls.css
ikootaclient\src\components\auth\AuthControls.jsx
ikootaclient\src\components\auth\LandingPage.css
ikootaclient\src\components\auth\LandingPage.jsx
ikootaclient\src\components\auth\login.css
ikootaclient\src\components\auth\Login.jsx
ikootaclient\src\components\auth\LoginForm.jsx
ikootaclient\src\components\auth\NavigationWrapper.css
ikootaclient\src\components\auth\NavigationWrapper.jsx
ikootaclient\src\components\auth\passwordreset.css
ikootaclient\src\components\auth\Passwordreset.jsx
ikootaclient\src\components\auth\ProtectedRoute.jsx
ikootaclient\src\components\auth\signup.css
ikootaclient\src\components\auth\Signup.jsx
ikootaclient\src\components\auth\userManagement.css
ikootaclient\src\components\auth\UserManagement.jsx
ikootaclient\src\components\auth\UserStatus.jsx
ikootaclient\src\components\iko
ikootaclient\src\components\iko\chat.css
ikootaclient\src\components\iko\Chat.jsx
ikootaclient\src\components\iko\iko.css
ikootaclient\src\components\iko\Iko.jsx
ikootaclient\src\components\iko\ikocontrols.css
ikootaclient\src\components\iko\IkoControls.jsx
ikootaclient\src\components\iko\list.css
ikootaclient\src\components\iko\List.jsx
ikootaclient\src\components\iko\listchats.css
ikootaclient\src\components\iko\ListChats.jsx
ikootaclient\src\components\iko\listcomments.css
ikootaclient\src\components\iko\ListComments.jsx
ikootaclient\src\components\iko\MediaGallery.jsx
ikootaclient\src\components\iko\userinfo.css
ikootaclient\src\components\iko\Userinfo.jsx
ikootaclient\src\components\info
ikootaclient\src\components\info\applicationThankyou.css
ikootaclient\src\components\info\ApplicationThankYou.jsx
ikootaclient\src\components\info\approveverifyinfo.css
ikootaclient\src\components\info\Approveverifyinfo.jsx
ikootaclient\src\components\info\pendverifyinfo.css
ikootaclient\src\components\info\Pendverifyinfo.jsx
ikootaclient\src\components\info\surveySubmitted.css
ikootaclient\src\components\info\SurveySubmitted.jsx
ikootaclient\src\components\info\suspendedverifyinfo.css
ikootaclient\src\components\info\Suspendedverifyinfo.jsx
ikootaclient\src\components\info\Thankyou.jsx
ikootaclient\src\components\info\verifysurvey.css
ikootaclient\src\components\info\VerifySurvey.jsx
ikootaclient\src\components\membership
ikootaclient\src\components\membership\FullMembershipDeclined.jsx
ikootaclient\src\components\membership\FullMembershipInfo.jsx
ikootaclient\src\components\membership\FullMembershipSubmitted.jsx
ikootaclient\src\components\membership\FullMembershipSurvey.jsx
ikootaclient\src\components\search
ikootaclient\src\components\search\searchcontrols.css
ikootaclient\src\components\search\SearchControls.jsx
ikootaclient\src\components\service
ikootaclient\src\components\service\api.js
ikootaclient\src\components\service\commentServices.js
ikootaclient\src\components\service\idGenerationService.js
ikootaclient\src\components\service\surveypageservice.js
ikootaclient\src\components\service\useFetchChats.js
ikootaclient\src\components\service\useFetchComments.js
ikootaclient\src\components\service\useFetchTeachings.js
ikootaclient\src\components\towncrier
ikootaclient\src\components\towncrier\revTeaching.css
ikootaclient\src\components\towncrier\RevTeaching.jsx
ikootaclient\src\components\towncrier\revtopics.css
ikootaclient\src\components\towncrier\RevTopics.jsx
ikootaclient\src\components\towncrier\StepsForm.jsx
ikootaclient\src\components\towncrier\teaching.css
ikootaclient\src\components\towncrier\Teaching.jsx
ikootaclient\src\components\towncrier\towncrier.css
ikootaclient\src\components\towncrier\Towncrier.jsx
ikootaclient\src\components\towncrier\TowncrierControls.jsx
ikootaclient\src\components\user
ikootaclient\src\components\user\UserDashboard.jsx
ikootaclient\src\components\utils
ikootaclient\src\components\utils\apiDebugHelper.js
ikootaclient\src\components\utils\DebugWrapper.jsx
ikootaclient\src\components\utils\IdDisplay.jsx
ikootaclient\src\hooks
ikootaclient\src\hooks\useAuth.js
ikootaclient\src\hooks\useUpload.js
ikootaclient\src\hooks\useUploadCommentFiles.js
ikootaclient\src\App.css
ikootaclient\src\App.jsx
ikootaclient\src\dummyData.js
ikootaclient\src\main.jsx
ikootaclient\src\Test.jsx
ikootaclient\.env
ikootaclient\.gitignore
ikootaclient\eslint.config.js
ikootaclient\index.html
ikootaclient\package-lock.json
ikootaclient\package.json
ikootaclient\README.md
ikootaclient\vite.config.js




ikootaapi\config
ikootaapi\config\db.js
ikootaapi\config\ikoota_db.sql
ikootaapi\config\s3.js
ikootaapi\controllers
ikootaapi\controllers\adminControllers.js
ikootaapi\controllers\authControllers.js
ikootaapi\controllers\chatControllers.js
ikootaapi\controllers\classControllers.js
ikootaapi\controllers\commentControllers.js
ikootaapi\controllers\communicationControllers.js
ikootaapi\controllers\identityController.js
ikootaapi\controllers\membershipControllers.js
ikootaapi\controllers\surveyControllers.js
ikootaapi\controllers\teachingsControllers.js
ikootaapi\controllers\userControllers.js
ikootaapi\logs
ikootaapi\logs\app.log
ikootaapi\middlewares
ikootaapi\middlewares\auth.middleware.js
ikootaapi\middlewares\upload.middleware.js
ikootaapi\node_modules
ikootaapi\routes
ikootaapi\routes\adminRoutes.js
ikootaapi\routes\authRoutes.js
ikootaapi\routes\chatRoutes.js
ikootaapi\routes\classRoutes.js
ikootaapi\routes\commentRoutes.js
ikootaapi\routes\communicationRoutes.js
ikootaapi\routes\identityRoutes.js
ikootaapi\routes\index.js
ikootaapi\routes\membershipRoutes.js
ikootaapi\routes\surveyRoutes.js
ikootaapi\routes\teachingsRoutes.js
ikootaapi\routes\userRoutes.js
ikootaapi\services
ikootaapi\services\adminServices.js
ikootaapi\services\authServices.js
ikootaapi\services\chatServices.js
ikootaapi\services\classServices.js
ikootaapi\services\commentServices.js
ikootaapi\services\communicationServices.js
ikootaapi\services\identityMaskingService.js
ikootaapi\services\s3Service.js
ikootaapi\services\surveyServices.js
ikootaapi\services\teachingsServices.js
ikootaapi\services\userServices.js
ikootaapi\utils
ikootaapi\utils\CustomError.js
ikootaapi\utils\email.js
ikootaapi\utils\errorHandler.js
ikootaapi\utils\idGenerator.js
ikootaapi\utils\jwt.js
ikootaapi\utils\logger.js
ikootaapi\utils\notifications.js
ikootaapi\utils\responseHandler.js
ikootaapi\utils\sms.js
ikootaapi\.env
ikootaapi\.gitignore
ikootaapi\app.js
ikootaapi\package-lock.json
ikootaapi\package.json
ikootaapi\server.js
ikootaapi\socket.js
ikootaapi\testDBConnection.js




# Admin Components API Analysis

## Component: UserManagement.jsx (Comprehensive Admin User Management)

### API Calls:

#### Two-Stage Membership System APIs:
1. **GET /membership/admin/membership-overview**
   - **Purpose**: Fetch comprehensive membership system statistics
   - **Expected Route**: `/membership/admin/membership-overview`
   - **Controller**: `MembershipController.getMembershipOverview()`
   - **Service**: `MembershipService.getSystemOverview()`

2. **GET /membership/admin/pending-applications**
   - **Purpose**: Fetch pending membership applications with pagination
   - **Query Parameters**: `page`, `limit`, `search`, `sortBy`, `sortOrder`
   - **Expected Route**: `/membership/admin/pending-applications`
   - **Controller**: `MembershipController.getPendingApplications()`
   - **Service**: `MembershipService.getPaginatedApplications(filters)`

3. **POST /membership/admin/bulk-approve**
   - **Purpose**: Bulk approve/reject multiple applications
   - **Data**: `{ userIds: Array, action: String, adminNotes: String }`
   - **Expected Route**: `/membership/admin/bulk-approve`
   - **Controller**: `MembershipController.bulkApproveApplications()`
   - **Service**: `MembershipService.processBulkApplications(userIds, action, notes)`

4. **PUT /membership/admin/update-user-status/:userId**
   - **Purpose**: Update individual application status
   - **Data**: `{ status: String, adminNotes: String }`
   - **Expected Route**: `/membership/admin/update-user-status/:userId`
   - **Controller**: `MembershipController.updateApplicationStatus()`
   - **Service**: `MembershipService.updateUserStatus(userId, status, notes)`

#### Legacy User Management APIs:
5. **GET /admin/users**
   - **Purpose**: Fetch all users in the system
   - **Expected Route**: `/admin/users`
   - **Controller**: `AdminController.getUsers()`
   - **Service**: `UserService.getAllUsers()`

6. **GET /classes**
   - **Purpose**: Fetch all available classes/categories
   - **Expected Route**: `/classes`
   - **Controller**: `ClassController.getClasses()`
   - **Service**: `ClassService.getAllClasses()`

7. **GET /admin/mentors**
   - **Purpose**: Fetch all mentors in the system
   - **Expected Route**: `/admin/mentors`
   - **Controller**: `AdminController.getMentors()`
   - **Service**: `MentorService.getAllMentors()`

8. **GET /admin/reports**
   - **Purpose**: Fetch user reports for admin review
   - **Expected Route**: `/admin/reports`
   - **Controller**: `AdminController.getReports()`
   - **Service**: `ReportService.getAllReports()`

#### User Operations APIs:
9. **PUT /admin/update-user/:id**
   - **Purpose**: Update user information
   - **Data**: FormData with user updates
   - **Expected Route**: `/admin/update-user/:id`
   - **Controller**: `AdminController.updateUser()`
   - **Service**: `UserService.updateUser(id, formData)`

10. **POST /admin/mask-identity**
    - **Purpose**: Apply identity masking with converse IDs
    - **Data**: `{ userId, adminConverseId, mentorConverseId, classId }`
    - **Expected Route**: `/admin/mask-identity`
    - **Controller**: `AdminController.maskUserIdentity()`
    - **Service**: `IdentityService.maskUser(userId, converseIds, classId)`

11. **DELETE /admin/delete-user/:userId**
    - **Purpose**: Delete user from system
    - **Expected Route**: `/admin/delete-user/:userId`
    - **Controller**: `AdminController.deleteUser()`
    - **Service**: `UserService.deleteUser(userId)`

12. **POST /admin/create-user**
    - **Purpose**: Create new user account
    - **Data**: User creation data
    - **Expected Route**: `/admin/create-user`
    - **Controller**: `AdminController.createUser()`
    - **Service**: `UserService.createUser(userData)`

#### Notification & Report Management:
13. **POST /admin/send-notification**
    - **Purpose**: Send notification to specific user
    - **Data**: `{ userId, message, type }`
    - **Expected Route**: `/admin/send-notification`
    - **Controller**: `AdminController.sendNotification()`
    - **Service**: `NotificationService.sendToUser(userId, message, type)`

14. **PUT /admin/update-report/:reportId**
    - **Purpose**: Update report status and add admin notes
    - **Data**: `{ status, adminNotes }`
    - **Expected Route**: `/admin/update-report/:reportId`
    - **Controller**: `AdminController.updateReport()`
    - **Service**: `ReportService.updateReportStatus(reportId, status, notes)`

15. **GET /admin/export-users**
    - **Purpose**: Export user data with filters
    - **Query Parameters**: Various filter options
    - **Expected Route**: `/admin/export-users`
    - **Controller**: `AdminController.exportUsers()`
    - **Service**: `UserService.exportUserData(filters)`

### React Query Features:
- **Error Boundaries**: Comprehensive error handling with fallback UI
- **Retry Logic**: Automatic retries with exponential backoff
- **Cache Management**: Query invalidation and refresh mechanisms
- **Safe Data Access**: Memoized filtered data with error protection

---

## Component: Dashboard.jsx (Admin Analytics Dashboard)

### API Calls:
1. **GET /membership/admin/analytics**
   - **Purpose**: Fetch membership analytics and conversion funnels
   - **Query Parameters**: `period`, `detailed`
   - **Expected Route**: `/membership/admin/analytics`
   - **Controller**: `MembershipController.getAnalytics()`
   - **Service**: `AnalyticsService.getMembershipAnalytics(period, detailed)`

2. **GET /membership/admin/membership-stats**
   - **Purpose**: Fetch current membership statistics
   - **Expected Route**: `/membership/admin/membership-stats`
   - **Controller**: `MembershipController.getMembershipStats()`
   - **Service**: `AnalyticsService.getMembershipStats()`

3. **GET /admin/audit-logs**
   - **Purpose**: Fetch system audit logs for admin review
   - **Expected Route**: `/admin/audit-logs`
   - **Controller**: `AdminController.getAuditLogs()`
   - **Service**: `AuditService.getAdminLogs()`

### Analytics Features:
- **Conversion Funnel Tracking**: Registration → Application → Approval → Full Member
- **Time Series Analysis**: Registration and approval trends over time
- **Performance Metrics**: Average approval times and conversion rates
- **Error Resilience**: Graceful degradation when analytics are unavailable

---

## Component: AudienceClassMgr.jsx (Class Management)

### API Calls:
1. **GET /classes**
   - **Purpose**: Fetch all existing classes
   - **Expected Route**: `/classes`
   - **Controller**: `ClassController.getClasses()`
   - **Service**: `ClassService.getAllClasses()`

2. **POST /classes**
   - **Purpose**: Create new class
   - **Data**: `{ class_id, name, description }`
   - **Expected Route**: `/classes`
   - **Controller**: `ClassController.createClass()`
   - **Service**: `ClassService.createClass(classData)`

3. **PUT /classes/:id**
   - **Purpose**: Update existing class
   - **Data**: `{ class_id, name, description }`
   - **Expected Route**: `/classes/:id`
   - **Controller**: `ClassController.updateClass()`
   - **Service**: `ClassService.updateClass(id, classData)`

### ID Generation Features:
- **Unique ID Generation**: Uses `generateUniqueClassId()` service
- **Format Validation**: Validates `OTU#XXXXXX` format (10 characters)
- **Collision Prevention**: Ensures class IDs are unique

---

## Component: Admin.jsx (Main Admin Layout)

### No Direct API Calls:
- **Layout Management**: Handles responsive sidebar and mobile navigation
- **Route Management**: Uses React Router Outlet for nested routes
- **State Management**: Manages mobile menu state and selected items

### Navigation Features:
- **Responsive Design**: Mobile-first approach with collapsible sidebar
- **Route Synchronization**: Updates selected item based on current route
- **Accessibility**: Keyboard navigation and ARIA labels

---

## Component: Sidebar.jsx (Admin Navigation)

### No Direct API Calls:
- **Navigation Only**: Pure navigation component with routing links

### Navigation Items:
- Dashboard
- Towncrier & Towncrier Controls
- Iko & Iko Controls
- AuthControls
- SearchControls
- Reports
- UserManagement
- AudienceClassMgr

---

## Component: Navbar.jsx (Admin Header)

### No Direct API Calls:
- **UI Only**: Displays time, user info, and navigation actions

### Features:
- **Real-time Clock**: Updates every minute
- **User Information**: Shows current admin user
- **Action Buttons**: Notifications, settings, logout

---

## Component: Analytics.jsx (Chart Component)

### No Direct API Calls:
- **Visualization Only**: Uses Chart.js for data visualization
- **Static Data**: Currently displays sample data

---

## Backend Route Summary

### Membership Administration:
- `GET /membership/admin/membership-overview` - System overview stats
- `GET /membership/admin/pending-applications` - Paginated applications
- `POST /membership/admin/bulk-approve` - Bulk application processing
- `PUT /membership/admin/update-user-status/:userId` - Individual status updates
- `GET /membership/admin/analytics` - Membership analytics
- `GET /membership/admin/membership-stats` - Current statistics

### User Administration:
- `GET /admin/users` - All users listing
- `PUT /admin/update-user/:id` - User updates
- `DELETE /admin/delete-user/:userId` - User deletion
- `POST /admin/create-user` - User creation
- `POST /admin/mask-identity` - Identity masking
- `GET /admin/export-users` - User data export

### System Administration:
- `GET /admin/mentors` - Mentor management
- `GET /admin/reports` - User reports
- `PUT /admin/update-report/:reportId` - Report status updates
- `POST /admin/send-notification` - User notifications
- `GET /admin/audit-logs` - System audit trails

### Class Management:
- `GET /classes` - Class listing
- `POST /classes` - Class creation
- `PUT /classes/:id` - Class updates

---

## Database Interactions

### User Management Tables:
- **users**: Main user records
- **membership_applications**: Application tracking
- **user_reports**: User-generated reports
- **audit_logs**: System activity logging

### Membership System Tables:
- **membership_analytics**: Conversion funnel data
- **application_status_history**: Status change tracking
- **admin_actions**: Administrative action logs

### Class System Tables:
- **classes**: Class/category definitions
- **converse_identities**: Identity masking records
- **mentor_assignments**: Mentor-user relationships

### Analytics Tables:
- **conversion_funnels**: Membership conversion tracking
- **time_series_data**: Trend analysis data
- **system_metrics**: Performance indicators

## Security Features:
- **Role-based Access**: Admin-only endpoints
- **Input Validation**: Server-side validation for all inputs
- **Audit Trailing**: Comprehensive logging of admin actions
- **Identity Protection**: Converse ID masking system

This analysis covers the comprehensive admin management system in your React application. Key highlights include:

**Two-Stage Membership System**: Advanced membership application management with bulk operations, pagination, and detailed analytics.

**Comprehensive User Management**: Full CRUD operations for users, including identity masking, role management, and export capabilities.

**Analytics Dashboard**: Real-time membership conversion funnels, trend analysis, and system performance metrics.

**Class Management System**: Structured class creation with unique ID generation and format validation.

**Admin Infrastructure**: 
- Responsive design with mobile-first approach
- Route synchronization and navigation management
- Error boundaries and graceful degradation
- Comprehensive audit logging

**Security & Identity Features**:
- Converse ID masking system for user privacy
- Role-based access control
- Comprehensive audit trails
- Secure admin operations

**Advanced React Patterns**:
- React Query for server state management
- Memoized computations for performance
- Error boundaries and fallback UI
- Responsive design patterns

The admin system demonstrates enterprise-level features with sophisticated user management, membership processing, and system analytics capabilities.




# Additional Authentication Components API Analysis

## Component: LandingPage.jsx

### API Calls:
- **No direct API calls** - purely presentational component

### Navigation Patterns:
- **Authentication Check**: Uses UserStatus context to redirect authenticated users
- **Smart Routing**: Redirects based on user status via `getDefaultRoute()`

### useEffects:
- **Authentication Redirect**: Automatically redirects authenticated users to appropriate dashboard
- **Scroll Effect**: Manages navbar scroll styling (client-side only)
- **Feature Auto-rotation**: Cycles through feature highlights (client-side only)

### Route Interactions:
- Navigates users to `/signup`, `/login`, `/towncrier` based on actions
- Uses context-based routing for authenticated users

---

## Component: AuthControls.jsx (Admin Survey Management)

### API Calls:
1. **GET /survey/questions**
   - **Purpose**: Fetch current survey questions for editing
   - **Trigger**: useQuery on component mount
   - **Expected Route**: `/survey/questions`
   - **Controller**: `SurveyController.getQuestions()`
   - **Service**: `SurveyService.getQuestions()`

2. **GET /survey/logs**
   - **Purpose**: Fetch all submitted survey applications for review
   - **Trigger**: useQuery on component mount
   - **Expected Route**: `/survey/logs`
   - **Controller**: `SurveyController.getSurveyLogs()`
   - **Service**: `SurveyService.getAllSubmissions()`

3. **PUT /survey/questions**
   - **Purpose**: Update survey questions (admin functionality)
   - **Data**: `{ questions: Array }`
   - **Expected Route**: `/survey/questions`
   - **Controller**: `SurveyController.updateQuestions()`
   - **Service**: `SurveyService.updateQuestions(questions)`

4. **PUT /survey/approve**
   - **Purpose**: Approve or decline user applications
   - **Data**: `{ surveyId, userId, status }`
   - **Expected Route**: `/survey/approve`
   - **Controller**: `SurveyController.updateApprovalStatus()`
   - **Service**: `SurveyService.updateApplicationStatus(surveyId, userId, status)`

5. **PUT /users/role**
   - **Purpose**: Update user role (admin privilege management)
   - **Data**: `{ userId, role }`
   - **Expected Route**: `/users/role`
   - **Controller**: `UserController.updateRole()`
   - **Service**: `UserService.updateUserRole(userId, role)`

6. **POST /email/send**
   - **Purpose**: Send email notifications to users about application status
   - **Data**: `{ email, template, status }`
   - **Expected Route**: `/email/send`
   - **Controller**: `EmailController.sendNotification()`
   - **Service**: `EmailService.sendTemplateEmail(email, template, status)`

### useQueries and Mutations:
- **React Query**: Uses useQuery for data fetching and useMutation for updates
- **Auto-refetch**: Automatically refreshes data after mutations
- **Error Handling**: Built-in error handling for failed operations

---

## Component: ApplicationSurvey.jsx

### API Calls:
1. **GET /membership/survey/check-status**
   - **Purpose**: Check if user has already submitted application
   - **Trigger**: useEffect on component mount
   - **Headers**: Authorization Bearer token
   - **Expected Route**: `/membership/survey/check-status`
   - **Controller**: `MembershipController.checkApplicationStatus()`
   - **Service**: `MembershipService.getUserApplicationStatus(user_id)`

2. **POST /membership/survey/submit-application**
   - **Purpose**: Submit completed membership application
   - **Data**: `{ answers: Array, applicationTicket: String }`
   - **Expected Route**: `/membership/survey/submit-application`
   - **Controller**: `MembershipController.submitApplication()`
   - **Service**: `MembershipService.createApplication(user_id, answers, ticket)`

### Advanced Features:
- **Auto-save Functionality**: Saves form data to localStorage every 2 seconds
- **Multi-step Form**: 4-step application process with validation
- **Progress Persistence**: Saves current step and resumes from last position
- **Data Recovery**: Loads saved data on component mount

### useEffects:
- **Authentication Check**: Redirects unauthenticated users to login
- **Data Loading**: Loads saved application data from localStorage
- **Application Status Check**: Verifies if user needs to complete application
- **Auto-save Debouncing**: Implements debounced auto-save functionality

### Local Storage Operations:
- **Save Data**: `localStorage.setItem()` for form persistence
- **Load Data**: `localStorage.getItem()` for data recovery
- **Clear Data**: `localStorage.removeItem()` after successful submission

### Form Validation:
- **Step-by-step Validation**: Different validation rules per step
- **Required Fields**: Enforces mandatory field completion
- **Data Types**: Validates emails, dates, checkboxes, arrays

---

## Component: AdminRoute.jsx

### API Calls:
- **No direct API calls** - uses JWT token validation only

### Token Operations:
- **JWT Decoding**: Extracts role information from token
- **Multi-source Token Check**: localStorage and cookie fallback
- **Role Validation**: Checks for `admin` role or `isAdmin` flag

### Protection Logic:
- **Admin Access**: Only allows admin users to access wrapped components
- **Fallback Redirect**: Non-admin users redirected to `/iko`
- **Token Validation**: Handles token expiration and invalid tokens

---

## Backend Route Summary

### Survey Management Routes:
- `GET /survey/questions` - Get current survey questions
- `PUT /survey/questions` - Update survey questions (admin only)
- `GET /survey/logs` - Get all survey submissions (admin only)
- `PUT /survey/approve` - Approve/decline applications (admin only)

### User Management Routes:
- `PUT /users/role` - Update user roles (admin only)

### Email Service Routes:
- `POST /email/send` - Send notification emails

### Application Routes:
- `GET /membership/survey/check-status` - Check application status
- `POST /membership/survey/submit-application` - Submit new application

---

## Database Interactions

### Survey System Tables:
- **survey_questions**: Stores dynamic survey questions
- **survey_submissions**: Stores user application submissions
- **survey_logs**: Tracks application review history

### Application Processing:
- **applications**: Main application records
- **application_status**: Status tracking (pending, approved, declined)
- **application_tickets**: Unique application identifiers

### Email Notifications:
- **email_templates**: Template storage for different notification types
- **email_logs**: Track sent notifications

### User Role Management:
- **users.role**: User role updates
- **role_history**: Audit trail for role changes

---

## Application Flow Summary

### User Application Process:
1. **Check Status** → Verify if application already submitted
2. **Auto-save Progress** → Continuously save form data locally
3. **Multi-step Validation** → Validate each step before proceeding
4. **Final Submission** → Submit complete application with ticket
5. **Cleanup** → Clear saved data and redirect to status page

### Admin Review Process:
1. **Fetch Applications** → Load all pending applications
2. **Review Submissions** → Examine user responses
3. **Make Decision** → Approve or decline applications
4. **Send Notifications** → Email users about decision
5. **Update Roles** → Grant appropriate access levels

### Security Features:
- **Token-based Authentication**: JWT validation for all protected routes
- **Role-based Access**: Different permissions for users, admins
- **Data Persistence**: Local storage with encryption considerations
- **Auto-cleanup**: Remove sensitive data after operations

### Client-side Data Management:
- **localStorage**: Form persistence and recovery
- **React Query**: Server state management and caching
- **Context Providers**: Global user state management
- **Auto-save**: Debounced data persistence.

This analysis covers the remaining authentication and application management components. Key highlights include:

**Application Management System**: The ApplicationSurvey component implements a sophisticated multi-step form with auto-save functionality, local storage persistence, and comprehensive validation.

**Admin Survey Management**: AuthControls provides complete admin functionality for managing survey questions, reviewing applications, and updating user roles.

**Advanced Client-side Features**:
- Auto-save with debouncing (every 2 seconds)
- Progress persistence across browser sessions
- Multi-step form validation
- Data recovery mechanisms

**Email Notification System**: Integrated email service for sending application status updates to users.

**Security Layers**:
- JWT token validation at multiple levels
- Role-based route protection
- Admin-only functionality separation

**Database Design**: The system appears to use a comprehensive survey and application management schema with proper audit trails and status tracking.

**User Experience Features**:
- Seamless auto-save without user intervention
- Progress indicators and step validation
- Graceful error handling and recovery
- Smart routing based on application status

This completes the comprehensive analysis of your frontend API interactions with the backend system. The application demonstrates a well-architected membership management system with sophisticated user experience features and robust security measures.





# Authentication Components API Analysis

## Component: UserStatus.jsx (Context Provider)

### API Calls:
1. **GET /membership/dashboard**
   - **Purpose**: Fetch user's membership dashboard data and detailed status
   - **Trigger**: fetchMembershipStatus() function in updateUser()
   - **Headers**: Authorization Bearer token
   - **Expected Route**: `/membership/dashboard`
   - **Controller**: `MembershipController.getDashboard()`
   - **Service**: `MembershipService.getUserDashboard(user_id)`

2. **GET /membership/survey/check-status**
   - **Purpose**: Fallback check for membership survey completion status
   - **Trigger**: When dashboard endpoint fails
   - **Expected Route**: `/membership/survey/check-status`
   - **Controller**: `MembershipController.checkSurveyStatus()`
   - **Service**: `MembershipService.checkUserSurveyStatus(user_id)`

### useEffects:
- **Token Initialization**: Validates and decodes JWT from localStorage/cookies
- **User Status Update**: Fetches membership data and determines user permissions
- **Storage Change Listener**: Monitors token changes across browser tabs
- **Error Cleanup Timer**: Auto-clears error messages after 10 seconds

### Key Functions:
- **determineUserStatus()**: Business logic for user role/membership determination
- **getUserFromToken()**: JWT validation and extraction
- **updateUser()**: Complete user data refresh cycle

---

## Component: Signup.jsx

### API Calls:
1. **POST /api/auth/send-verification**
   - **Purpose**: Send verification code via email or SMS
   - **Data**: `{ email, phone, method, username }`
   - **Expected Route**: `/api/auth/send-verification`
   - **Controller**: `AuthController.sendVerification()`
   - **Service**: `AuthService.sendVerificationCode()`

2. **POST /api/auth/register**
   - **Purpose**: Complete user registration after verification
   - **Data**: `{ username, email, password, phone, verificationCode, verificationMethod }`
   - **Expected Route**: `/api/auth/register`
   - **Controller**: `AuthController.register()`
   - **Service**: `AuthService.createUser()`

### Multi-Step Process:
1. **Form Submission**: Collect user data and send verification code
2. **Code Verification**: Verify code and complete registration
3. **Success Redirect**: Generate application ticket and navigate to next step

### Database Interactions:
- **User Creation**: Insert new user into users table
- **Verification Tracking**: Store/validate verification codes
- **Application Tracking**: Generate application ticket for membership process

---

## Component: Login.jsx

### API Calls:
1. **POST /api/membership/auth/login**
   - **Purpose**: Authenticate user and receive JWT token
   - **Data**: `{ email, password }`
   - **Expected Route**: `/api/membership/auth/login`
   - **Controller**: `MembershipController.authenticateUser()` or `AuthController.login()`
   - **Service**: `AuthService.authenticateUser(email, password)`

2. **GET /api/membership/survey/check-status**
   - **Purpose**: Check if user needs to complete membership survey
   - **Trigger**: After successful login for regular users
   - **Headers**: Authorization Bearer token
   - **Expected Route**: `/api/membership/survey/check-status`
   - **Controller**: `MembershipController.checkSurveyStatus()`
   - **Service**: `MembershipService.checkUserSurveyStatus(user_id)`

### Complex Routing Logic:
- **Admin Users**: Direct to `/admin`
- **Full Members**: Direct to `/iko`
- **Survey Required**: Direct to `/applicationsurvey`
- **Pending Applications**: Direct to `/towncrier`
- **Access Matrix Fallback**: Use `getUserAccess()` for complex cases

### Error Handling:
- **401**: Invalid credentials
- **403**: Banned users or access denied
- **404**: Account not found

---

## Component: RoleProtectedRoute.jsx

### API Calls:
- **No direct API calls** - relies on JWT token validation

### useEffects:
- **Access Validation**: Decodes JWT and validates role/membership requirements
- **Route Protection**: Redirects unauthorized users

### Token Operations:
- **JWT Decoding**: Extract user payload from token
- **Role Verification**: Check against requiredRole parameter
- **Membership Verification**: Check against requiredMembership parameter

---

## Component: ProtectedRoute.jsx

### API Calls:
- **No direct API calls** - purely client-side JWT validation

### Token Operations:
- **Multi-source Token Check**: localStorage and cookie fallback
- **Token Expiration Validation**: Automatic cleanup of expired tokens
- **Role-based Redirects**: Smart routing based on user status

### Protection Layers:
1. **Public Routes**: Landing page access
2. **Authentication Required**: Basic login check
3. **Member Routes**: Iko chat access
4. **Admin Routes**: Admin panel access

---

## Component: Passwordreset.jsx

### API Calls:
1. **POST /api/auth/passwordreset/request**
   - **Purpose**: Request password reset link/code
   - **Data**: `{ emailOrPhone }`
   - **Expected Route**: `/api/auth/passwordreset/request`
   - **Controller**: `AuthController.requestPasswordReset()`
   - **Service**: `AuthService.sendPasswordResetCode()`

2. **POST /api/auth/passwordreset/reset**
   - **Purpose**: Submit new password
   - **Data**: `{ emailOrPhone, newPassword, confirmNewPassword }`
   - **Expected Route**: `/api/auth/passwordreset/reset`
   - **Controller**: `AuthController.resetPassword()`
   - **Service**: `AuthService.updatePassword()`

3. **POST /api/auth/passwordreset/verify**
   - **Purpose**: Verify reset with confirmation code
   - **Data**: `{ emailOrPhone, verificationCode }`
   - **Expected Route**: `/api/auth/passwordreset/verify`
   - **Controller**: `AuthController.verifyPasswordReset()`
   - **Service**: `AuthService.verifyResetCode()`

### Multi-Step Process:
1. **Request Reset**: Send reset code to user
2. **Set New Password**: Collect and validate new password
3. **Verify Reset**: Confirm with verification code

---

## Component: NavigationWrapper.jsx

### API Calls:
- **No direct API calls** - uses UserStatus context

### Navigation Logic:
- **Path Validation**: Check if current path is allowed for user status
- **Auto-redirect**: Smart routing based on user permissions
- **Status-based Access**: Different allowed paths per user type

### Allowed Paths by Status:
- **Guest**: `['/', '/login', '/signup', '/towncrier']`
- **Pending**: `['/towncrier', '/applicationsurvey', '/thankyou']`
- **Member**: `['/iko', '/iko/*']`
- **Admin**: `['/admin', '/admin/*', '/iko', '/iko/*', '/towncrier']`

---

## Component: accessMatrix.js (Configuration)

### No API Calls - Pure Configuration

### Access Control Matrix:
- **super_admin**: Full system access
- **admin**: Administrative access excluding system settings
- **member**: Full member access to Iko and teachings
- **pre_member**: Limited access, preparing for membership
- **applicant**: Very limited access during application
- **guest**: Public access only

### Helper Functions:
- **checkUserAccess()**: Determine user's access level
- **getUserAccess()**: Get specific access permissions

---

## Backend Route Summary

### Authentication Routes:
- `POST /api/auth/send-verification` - Send email/SMS verification
- `POST /api/auth/register` - Complete user registration
- `POST /api/membership/auth/login` - User authentication
- `POST /api/auth/passwordreset/request` - Request password reset
- `POST /api/auth/passwordreset/reset` - Set new password
- `POST /api/auth/passwordreset/verify` - Verify password reset

### Membership Routes:
- `GET /membership/dashboard` - User membership dashboard
- `GET /membership/survey/check-status` - Survey completion status

### Security Patterns:
1. **JWT Token Management**: localStorage with cookie fallback
2. **Multi-step Verification**: Email/SMS confirmation flows
3. **Role-based Access**: Admin, member, pre-member, applicant, guest
4. **Route Protection**: Client-side and server-side validation
5. **Token Expiration**: Automatic cleanup and re-authentication

### Database Interactions:
- **users table**: User account management
- **membership_applications**: Application tracking
- **verification_codes**: Email/SMS verification
- **password_resets**: Reset code management
- **user_sessions**: Token/session management

### Authentication Flow:
1. **Registration**: Verify → Register → Generate Application Ticket
2. **Login**: Authenticate → Check Survey Status → Smart Routing
3. **Password Reset**: Request → Reset → Verify
4. **Session Management**: JWT validation → Role checking → Route protection.



This analysis covers all the authentication and authorization components in your React application. The key findings include:

**Authentication Architecture**: Your app uses a sophisticated multi-layered authentication system with JWT tokens, role-based access control, and membership status verification.

**Smart Routing System**: The application implements intelligent routing based on user roles, membership status, and survey completion, ensuring users land on the appropriate pages.

**Multi-step Processes**: Registration and password reset follow secure multi-step verification flows using email/SMS codes.

**Access Control Matrix**: A comprehensive permission system that defines exactly what each user type can access, from guest users to super admins.

**Security Features**:
- Token expiration handling
- Multi-source token storage (localStorage + cookies)
- Automatic cleanup of expired tokens
- Role and membership validation at multiple levels

**User Status Hierarchy**:
- Super Admin → Admin → Member → Pre-Member → Applicant → Guest

The backend appears to have a well-structured membership management system that tracks application status, survey completion, and progressive membership stages.





# Frontend API Calls & Backend Route Analysis

## Component: Userinfo.jsx

### API Calls:
1. **GET /users/profile**
   - **Purpose**: Fetch authenticated user's profile information
   - **Trigger**: useEffect when user_id is available
   - **Headers**: Authorization Bearer token
   - **Expected Backend Route**: `/users/profile`
   - **Controller**: Likely `UserController.getProfile()`
   - **Service**: `UserService.getUserProfile(user_id)`

### useEffects:
- **Token Extraction**: Decodes JWT from localStorage or cookies to get user_id
- **User Data Fetching**: Fetches user profile when user_id changes
- **Active Time Tracker**: Updates user active time every minute (client-side only)

---

## Component: IkoControls.jsx

### API Calls:
1. **GET /api/messages?status=${filter}**
   - **Purpose**: Fetch messages based on status filter (pending, approved, rejected, deleted)
   - **Expected Route**: `/api/messages`
   - **Controller**: `MessageController.getMessages()`
   - **Service**: `MessageService.getMessagesByStatus(status)`

2. **GET /api/comments?status=${filter}**
   - **Purpose**: Fetch comments based on status filter
   - **Expected Route**: `/api/comments`
   - **Controller**: `CommentController.getComments()`
   - **Service**: `CommentService.getCommentsByStatus(status)`

3. **GET /api/chats**
   - **Purpose**: Fetch all chats for admin management
   - **Expected Route**: `/api/chats`
   - **Controller**: `ChatController.getChats()`
   - **Service**: `ChatService.getAllChats()`

4. **PUT /api/${type}/${id}**
   - **Purpose**: Update status of messages, comments, or chats (approve, reject, delete)
   - **Expected Routes**: 
     - `/api/messages/:id`
     - `/api/comments/:id`
     - `/api/chats/:id`
   - **Controllers**: 
     - `MessageController.updateMessage()`
     - `CommentController.updateComment()`
     - `ChatController.updateChat()`
   - **Services**: 
     - `MessageService.updateMessageStatus()`
     - `CommentService.updateCommentStatus()`
     - `ChatService.updateChatStatus()`

### useEffects:
- **Data Fetching**: Fetches messages, comments, and chats when filter changes

---

## Component: ListComments.jsx

### API Calls:
1. **useFetchParentChatsAndTeachingsWithComments(user_id)**
   - **Purpose**: Fetch chats, teachings, and their associated comments
   - **Custom Hook**: This likely makes multiple API calls:
     - GET for chats with comments
     - GET for teachings with comments
   - **Expected Routes**: 
     - `/chats/with-comments`
     - `/teachings/with-comments`
   - **Controllers**: 
     - `ChatController.getChatsWithComments()`
     - `TeachingController.getTeachingsWithComments()`
   - **Services**: 
     - `ChatService.getChatsWithComments(user_id)`
     - `TeachingService.getTeachingsWithComments(user_id)`

### useEffects:
- **Token Extraction**: Decodes JWT to get user_id
- **Data Fetching**: Triggered by user_id change

---

## Component: ListChats.jsx

### API Calls:
1. **GET /chats/combinedcontent**
   - **Purpose**: Fetch combined content (chats and teachings)
   - **Expected Route**: `/chats/combinedcontent`
   - **Controller**: `ChatController.getCombinedContent()`
   - **Service**: `ChatService.getCombinedContent()`

2. **GET /comments/all**
   - **Purpose**: Fetch all comments
   - **Expected Route**: `/comments/all`
   - **Controller**: `CommentController.getAllComments()`
   - **Service**: `CommentService.getAllComments()`

### useEffects:
- **Combined Data Fetching**: Fetches both combined content and comments on component mount

---

## Component: Iko.jsx

### API Calls (via custom hooks):
1. **useFetchChats()**
   - **Purpose**: Fetch all chats
   - **Expected Route**: `/chats`
   - **Controller**: `ChatController.getChats()`
   - **Service**: `ChatService.getChats()`

2. **useFetchComments()**
   - **Purpose**: Fetch all comments
   - **Expected Route**: `/comments`
   - **Controller**: `CommentController.getComments()`
   - **Service**: `CommentService.getComments()`

3. **useFetchTeachings()**
   - **Purpose**: Fetch all teachings
   - **Expected Route**: `/teachings`
   - **Controller**: `TeachingController.getTeachings()`
   - **Service**: `TeachingService.getTeachings()`

### useEffects:
- **Admin Context Detection**: Checks if component is in admin layout
- **Active Item Management**: Sets default active item when chats load

---

## Component: Chat.jsx

### API Calls:
1. **useFetchParentChatsAndTeachingsWithComments(activeItem?.user_id)**
   - **Purpose**: Fetch comments for the active content item
   - **Same as ListComments component**

2. **Chat Creation (via useUpload hook)**
   - **Route**: `/chats`
   - **Method**: POST with FormData
   - **Purpose**: Create new chat with media files
   - **Controller**: `ChatController.createChat()`
   - **Service**: `ChatService.createChat(formData)`

3. **Comment Creation (via multiple hooks)**
   - **useUploadCommentFiles**: Upload comment media files
   - **useUpload("/comments")**: Upload comment with media
   - **postComment()**: Post comment data
   - **Expected Routes**:
     - `/comments/upload` (for media)
     - `/comments` (for comment creation)
   - **Controllers**: 
     - `CommentController.uploadFiles()`
     - `CommentController.createComment()`
   - **Services**: 
     - `CommentService.uploadCommentFiles()`
     - `CommentService.createComment()`

### Form Submissions:
- **handleSendChat**: Creates new chat with title, summary, audience, text, and media
- **handleSendComment**: Creates comment with text and media files

---

## MediaGallery.jsx

### API Calls:
- **No direct API calls** - purely presentational component for media display

---

## List.jsx

### API Calls:
- **No direct API calls** - composition component that renders other components

---

## Summary of Backend Route Map

### Authentication Routes:
- **JWT Token Processing**: All components extract user_id from JWT tokens

### User Routes:
- `GET /users/profile` - Get user profile information

### Chat Routes:
- `GET /chats` - Get all chats
- `GET /chats/combinedcontent` - Get combined chats and teachings
- `GET /chats/with-comments` - Get chats with their comments
- `POST /chats` - Create new chat with media

### Teaching Routes:
- `GET /teachings` - Get all teachings
- `GET /teachings/with-comments` - Get teachings with their comments

### Comment Routes:
- `GET /comments` - Get all comments
- `GET /comments/all` - Get all comments (different endpoint)
- `GET /comments?status=${filter}` - Get comments by status
- `POST /comments` - Create new comment
- `POST /comments/upload` - Upload comment media files
- `PUT /comments/:id` - Update comment status

### Message Routes (Admin):
- `GET /api/messages?status=${filter}` - Get messages by status
- `PUT /api/messages/:id` - Update message status

### Admin Management Routes:
- `PUT /api/chats/:id` - Update chat status
- `PUT /api/comments/:id` - Update comment status
- `PUT /api/messages/:id` - Update message status

## Database Interactions

Based on the API calls, the backend likely interacts with these database tables:
- **users** - User profile information
- **chats** - Chat/discussion content
- **teachings** - Teaching/lesson content
- **comments** - Comments on chats and teachings
- **messages** - System messages (admin managed)
- **media/files** - File uploads for chats and comments

## File Upload Patterns

The application uses FormData for file uploads with support for:
- **3 media files per chat** (media1, media2, media3)
- **3 media files per comment** (media1, media2, media3)
- **Multiple file types**: images, videos, audio files



Based on the frontend components you've provided, I'll analyze and map out all the CRUD operations, API calls, useEffects, and their interactions with the backend. Here's a comprehensive summary of the route maps and call points:This analysis provides a comprehensive overview of all the frontend-to-backend interactions in your React components. The key patterns I've identified include:

**Authentication Flow**: All components use JWT token extraction to identify users and make authenticated requests.

**CRUD Operations**: 
- **Create**: New chats and comments with media uploads
- **Read**: Multiple GET endpoints for different data combinations
- **Update**: Status updates for admin management
- **Delete**: Through status updates rather than hard deletes

**File Upload Strategy**: Uses FormData with support for multiple media files per content item.

**Custom Hooks**: Several components use custom hooks that abstract API calls, suggesting a well-structured service layer.

The backend appears to follow RESTful conventions with additional specialized endpoints for combined data fetching and admin management functionality.






# Frontend to Backend API Route Map - Part 4

## Application Status Information Components Analysis

---

## 1. Suspendedverifyinfo Component
**File:** `ikootaclient/src/components/info/Suspendedverifyinfo.jsx`

### API Calls:
**None** - This is a static information page that:
- Displays suspended application status
- Provides instructions for resolution
- Shows contact information
- No direct backend communication
- Uses user data from context/props only

---

## 2. SurveySubmitted Component
**File:** `ikootaclient/src/components/info/SurveySubmitted.jsx`

### API Calls:
**None** - This is a confirmation page that:
- Shows successful survey submission
- Displays application ticket from navigation state
- Provides timeline of review process
- Shows current access restrictions
- No direct backend communication

### Key Features:
- Clipboard functionality for ticket copying
- Visual timeline display
- Contact information for urgent requests
- Navigation options to other pages

---

## 3. Pendverifyinfo Component
**File:** `ikootaclient/src/components/info/Pendverifyinfo.jsx`

### API Calls:
**None** - This is a status information page that:
- Shows pending application status
- Lists current access limitations
- Provides urgent contact options
- Displays review timeline
- No backend API calls

---

## 4. Approveverifyinfo Component
**File:** `ikootaclient/src/components/info/Approveverifyinfo.jsx`

### API Calls:
**None** - This is a celebration/success page that:
- Shows approved application status
- Displays new pre-member benefits
- Provides navigation to Towncrier
- Shows path to full membership
- No backend communication

### useEffect Calls:
- **Confetti Animation:** Triggers celebration animation on mount
- **Timer Cleanup:** Clears animation after 3 seconds
- **Dependencies:** Empty array (runs once)

---

## 5. ApplicationThankyou Component
**File:** `ikootaclient/src/components/info/ApplicationThankyou.jsx`

### API Calls:
**None** - This is a post-registration welcome page that:
- Thanks user for signing up
- Shows application ticket if available
- Guides to next steps (survey)
- Explains membership levels
- No backend API calls

### useEffect Calls:
- **Data Retrieval:** Gets ticket/username from navigation state
- **Dependencies:** `[location.state, user]`

---

## Summary of Information Components

These five components form the **Application Status Information System** with:

### No Direct API Calls
All components are purely presentational, displaying:
- Application status information
- User guidance and instructions
- Contact information
- Navigation options

### Data Sources:
1. **Navigation State:** Passed via React Router
2. **User Context:** From `useUser` hook
3. **Local State:** For UI interactions

### Component Roles:

#### Status Display Components:
- **Pendverifyinfo:** Shows pending review status
- **Suspendedverifyinfo:** Shows suspended status with requirements
- **Approveverifyinfo:** Shows approval celebration

#### Confirmation Components:
- **SurveySubmitted:** Post-survey submission confirmation
- **ApplicationThankyou:** Post-registration welcome

### Common UI Patterns:

1. **Status Badges:**
   ```javascript
   <span className="status-badge pending">Pending Review</span>
   <span className="status-badge approved">Approved</span>
   <span className="status-badge suspended">Suspended</span>
   ```

2. **Timeline Visualization:**
   - Application received
   - Under review
   - Decision notification
   - Platform access

3. **Access Level Indicators:**
   - ❌ Restricted features
   - ✅ Available features
   - 🔓 Future access

4. **Contact Methods:**
   - Email: admin@ikoota.com, support@ikoota.com
   - SMS/WhatsApp: +1 (555) 123-4567
   - Urgent request handling

### Navigation Flow:

```
Registration → ApplicationThankyou → Survey → SurveySubmitted
                                                    ↓
                                              Pendverifyinfo
                                                    ↓
                        Approveverifyinfo ← Review → Suspendedverifyinfo
```

### Key Information Displayed:

1. **Application Tickets:** Format varies by component
2. **Review Timeline:** 3-5 business days standard
3. **Access Restrictions:** During each status phase
4. **Next Steps:** Clear guidance for users
5. **Contact Options:** For urgent matters

### No Backend Dependencies:
These components can be rendered without API calls, making them:
- Fast loading
- Reliable during network issues
- Easy to test
- Cacheable

### Integration Points:
While these components don't make API calls themselves, they:
- Receive data from navigation state
- Use authenticated user context
- Guide users to components that do make API calls
- Display results of API operations from other components







# Frontend to Backend API Route Map - Part 3

## Full Membership System Components Analysis

---

## 1. SearchControls Component
**File:** `ikootaclient/src/components/search/SearchControls.jsx`

### API Calls:
**None** - This is a pure UI component that:
- Manages local search query state
- Calls parent `onSearch` callback
- No direct backend communication
- Used for client-side filtering only

---

## 2. FullMembershipSurvey Component
**File:** `ikootaclient/src/components/membership/FullMembershipSurvey.jsx`

### API Calls:

#### 2.1 Check Full Membership Status
- **Frontend Call:** `api.get('/membership/full-membership-status')`
- **Purpose:** Verifies if user has already submitted a full membership application
- **Authentication:** Bearer token required
- **Backend Route:** `GET /membership/full-membership-status`
- **Expected Response:**
  ```javascript
  {
    hasSubmitted: boolean,
    hasAccessed: boolean,
    status: string, // 'pending', 'approved', 'declined', 'suspended'
    isPreMember: boolean
  }
  ```
- **Error Handling:** Redirects to login if not authenticated

#### 2.2 Submit Full Membership Application
- **Frontend Call:** `api.post('/membership/submit-full-membership', data)`
- **Purpose:** Submits the 8-question full membership application survey
- **Authentication:** Bearer token required
- **Backend Route:** `POST /membership/submit-full-membership`
- **Request Body:**
  ```javascript
  {
    answers: string[],           // Array of 8 survey responses
    membershipTicket: string,    // Generated ticket like "FMUSREMA241209"
    userId: string,
    userEmail: string,
    username: string,
    applicationType: 'full_membership'
  }
  ```
- **Success Response:** Status 200/201 with confirmation
- **Post-Success:** Navigates to submission confirmation page

### useEffect Calls:
- **Authentication Check:** Runs on mount to verify user is logged in
- **Submission Status Check:** Calls `checkSubmissionStatus()` on mount
- **Dependencies:** `[isAuthenticated, navigate]`

### Local Functions:
- `generateMembershipTicket()`: Creates unique ticket ID format:
  - Format: `FM[USERNAME_PREFIX][EMAIL_PREFIX][YYMMDD][HHMM]`
  - Example: `FMJOHEMA2412091430`

---

## 3. FullMembershipInfo Component
**File:** `ikootaclient/src/components/membership/FullMembershipInfo.jsx`

### API Calls:

#### 3.1 Check Full Membership Status (Same as 2.1)
- **Frontend Call:** `api.get('/membership/full-membership-status')`
- **Purpose:** Checks eligibility and existing application status
- **Used to determine:** If user is pre-member and eligible to apply

#### 3.2 Log Full Membership Access
- **Frontend Call:** `api.post('/membership/log-full-membership-access')`
- **Purpose:** Records first-time access to full membership info page
- **Authentication:** Bearer token required
- **Backend Route:** `POST /membership/log-full-membership-access`
- **Condition:** Only called if `hasAccessed === false`
- **No request body required**

### useEffect Calls:
- **Eligibility Check:** Runs on mount to verify pre-member status
- **Dependencies:** `[isAuthenticated, navigate]`

### Component States:
- Shows different UI based on application status:
  - No application: Shows benefits and application button
  - Pending: Shows review timeline
  - Suspended: Shows "additional info required" message
  - Approved: Shows access to Iko chat
  - Declined: Shows feedback link

---

## 4. FullMembershipSubmitted Component
**File:** `ikootaclient/src/components/membership/FullMembershipSubmitted.jsx`

### API Calls:
**None** - This is a confirmation page that:
- Displays submission confirmation
- Shows membership ticket from navigation state
- Provides timeline of review process
- Offers navigation options
- No direct backend communication

### Key Features:
- Clipboard copy functionality for ticket number
- Visual timeline of review process
- Explanation of possible outcomes
- Current access level display

---

## 5. FullMembershipDeclined Component
**File:** `ikootaclient/src/components/membership/FullMembershipDeclined.jsx`

### API Calls:
**None** - This is an informational page that:
- Displays declined status
- Directs user to email for detailed feedback
- Explains reapplication guidelines
- Maintains pre-member access
- No direct backend communication

---

## Complete Full Membership API Routes Summary

### Status & Access Routes
- `GET /membership/full-membership-status` - Check application status and eligibility
- `POST /membership/log-full-membership-access` - Record first access to info page

### Application Routes
- `POST /membership/submit-full-membership` - Submit full membership application

---

## Full Membership Application Flow

### 1. **Pre-Member Eligibility Check**
```
User navigates to full membership → 
Check authentication → 
GET /membership/full-membership-status → 
Verify isPreMember === true
```

### 2. **Information Page Access**
```
First time access detected → 
POST /membership/log-full-membership-access → 
Display benefits and expectations
```

### 3. **Survey Submission**
```
8-step form completion → 
Generate unique ticket → 
POST /membership/submit-full-membership → 
Navigate to confirmation page
```

### 4. **Status Tracking**
```
Return visit → 
GET /membership/full-membership-status → 
Display appropriate status UI
```

---

## Survey Structure

### 8 Required Questions:
1. **Professional Experience** - Current role and background
2. **Educational Expertise** - Specializations and passions
3. **Community Contribution** - Planned contributions
4. **Problem Solving** - Educational challenge example
5. **Collaboration Philosophy** - Approach to teamwork
6. **Development Goals** - Professional growth plans
7. **Conflict Resolution** - Handling disagreements
8. **Additional Information** - Optional extra details

### Validation:
- Questions 1-7 are required
- Minimum 50 characters recommended
- All answers stored in array
- Progress tracking with visual indicators

---

## State Management

### Application Status States:
- `pending` - Under review
- `suspended` - Additional info needed
- `approved` - Full member access granted
- `declined` - Not approved, can reapply

### Access Control:
- Pre-members only can apply
- One application per user
- 90-day wait for reapplication if declined

---

## Ticket Generation Algorithm
```javascript
FM + [First 3 chars of username] + [First 3 chars of email] + [YYMMDD] + [HHMM]
```
Example: User "johndoe" with email "john@email.com" on Dec 9, 2024 at 2:30 PM
Result: `FMJOHEMA2412091430`

---

## Error Handling
- Not authenticated → Redirect to login
- Not pre-member → Alert and redirect to Towncrier
- Already submitted → Show status page
- API errors → Display user-friendly messages






# Frontend to Backend API Route Map - Part 2

## Service Layer Components Analysis

---

## 1. ID Generation Service
**File:** `ikootaclient/src/components/service/idGenerationService.js`

### API Calls:

#### 1.1 Generate Unique Converse ID
- **Frontend Call:** `api.post('/admin/generate-converse-id')`
- **Purpose:** Generates a unique user ID (OTO#XXXXXX format) from backend
- **Authentication:** Required (admin endpoint)
- **Backend Route:** `POST /admin/generate-converse-id`
- **Expected Response:** `{ converseId: "OTO#ABC123" }`
- **Fallback:** Generates local preview ID if API fails

#### 1.2 Generate Unique Class ID
- **Frontend Call:** `api.post('/admin/generate-class-id')`
- **Purpose:** Generates a unique class ID (OTU#XXXXXX format) from backend
- **Authentication:** Required (admin endpoint)
- **Backend Route:** `POST /admin/generate-class-id`
- **Expected Response:** `{ classId: "OTU#XYZ789" }`
- **Fallback:** Generates local preview ID if API fails

### Local Functions (No API calls):
- `generatePreviewConverseId()`: Local ID generation for UI preview
- `generatePreviewClassId()`: Local class ID generation for UI preview
- `validateIdFormat()`: Client-side ID validation
- `getEntityTypeFromId()`: Determines if ID is user or class type

---

## 2. Comment Services
**File:** `ikootaclient/src/components/service/commentServices.js`

### API Calls:

#### 2.1 Post New Comment
- **Frontend Call:** `api.post("/comments", data)`
- **Purpose:** Creates a new comment on a chat or teaching
- **Backend Route:** `POST /comments`
- **Request Body:**
  ```javascript
  {
    userId: string,
    chatId: string,
    comment: string,
    media: mediaData // Structured media data
  }
  ```
- **Expected Response:** Created comment object with ID

#### 2.2 Get Comment Data
- **Frontend Call:** `api.get('/comments/${commentId}')`
- **Purpose:** Fetches a specific comment by ID
- **Backend Route:** `GET /comments/:commentId`
- **Expected Response:** Single comment object with all details

---

## 3. Survey Service
**File:** `ikootaclient/src/components/service/surveypageservice.js`

### API Calls:

#### 3.1 Submit Application Survey
- **Frontend Call:** `api.post('/survey/submit_applicationsurvey', answers)`
- **Purpose:** Submits membership application survey responses
- **Backend Route:** `POST /survey/submit_applicationsurvey`
- **Request Options:** `{ withCredentials: true }` - Includes cookies
- **Request Body:** Survey answers object
- **Uses:** React Query mutation for optimistic updates

---

## 4. Chat Fetching Service
**File:** `ikootaclient/src/components/service/useFetchChats.js`

### API Calls:

#### 4.1 Fetch All Chats
- **Frontend Call:** `api.get("/chats")`
- **Purpose:** Retrieves all chat conversations
- **Backend Route:** `GET /chats`
- **Query Key:** `["chats"]`
- **Expected Response:** Array of chat objects

---

## 5. Comments Fetching Service
**File:** `ikootaclient/src/components/service/useFetchComments.js`

### API Calls:

#### 5.1 Fetch Parent Comments with Context
- **Frontend Call:** `api.get('/comments/parent-comments')`
- **Purpose:** Gets parent chats/teachings with their comments
- **Backend Route:** `GET /comments/parent-comments`
- **Query Params:** `{ user_id }`
- **Query Key:** `["parent-comments", user_id]`
- **Enabled:** Only when user_id exists

#### 5.2 Fetch Comments by User
- **Frontend Call:** `api.get('/comments/parent')`
- **Purpose:** Gets comments for a specific user
- **Backend Route:** `GET /comments/parent`
- **Query Params:** `{ user_id }`
- **Query Key:** `["comments", user_id]`
- **Enabled:** Only when user_id exists

#### 5.3 Fetch All Comments
- **Frontend Call:** `api.get('/comments/all')`
- **Purpose:** Retrieves all comments in the system
- **Backend Route:** `GET /comments/all`
- **Query Key:** `["all-comments"]`
- **No parameters required**

---

## 6. Teachings Fetching Service
**File:** `ikootaclient/src/components/service/useFetchTeachings.js`

### API Calls:

#### 6.1 Fetch Teachings with Enhanced Processing
- **Frontend Call:** `api.get('/teachings')`
- **Purpose:** Fetches all teachings with normalization and enhancement
- **Backend Route:** `GET /teachings`
- **Query Configuration:**
  - `staleTime`: 5 minutes
  - `cacheTime`: 10 minutes
  - `retry`: 3 times (except for 4xx errors)
  - `retryDelay`: Exponential backoff
- **Processing Pipeline:**
  1. Debug API response
  2. Normalize response structure
  3. Enhance each teaching with consistent fields
  4. Sort by most recent first
- **Error Handling:** Detailed error logging with response inspection

---

## 7. API Base Configuration
**File:** `ikootaclient/src/components/service/api.js`

### Configuration:
- **Base URL:** `http://localhost:3000/api`
- **Default Headers:** `Content-Type: 'application/json'`

### Interceptors:

#### Request Interceptor:
- Adds Bearer token from localStorage/sessionStorage
- Logs all outgoing requests
- Handles both localStorage and sessionStorage tokens

#### Response Interceptor:
- Logs successful responses
- Enhanced error logging
- Detects HTML responses (routing issues)
- Provides detailed error context

---

## Complete API Routes Summary

### Admin Routes
- `POST /admin/generate-converse-id` - Generate unique user ID
- `POST /admin/generate-class-id` - Generate unique class ID

### Comment Routes
- `GET /comments/all` - Fetch all comments
- `GET /comments/parent` - Fetch user's comments
- `GET /comments/parent-comments` - Fetch with parent context
- `GET /comments/:commentId` - Get specific comment
- `POST /comments` - Create new comment

### Survey Routes
- `POST /survey/submit_applicationsurvey` - Submit application survey

### Content Routes
- `GET /chats` - Fetch all chats
- `GET /teachings` - Fetch all teachings

---

## React Query Patterns

### Query Keys Structure:
```javascript
["chats"]                        // All chats
["teachings"]                    // All teachings
["comments", user_id]           // User-specific comments
["parent-comments", user_id]    // Parent context comments
["all-comments"]                // System-wide comments
```

### Common Query Options:
- **staleTime**: 5 minutes (teachings)
- **cacheTime**: 10 minutes (teachings)
- **enabled**: Conditional fetching based on user_id
- **retry**: Smart retry with exponential backoff
- **onError/onSuccess**: Detailed logging callbacks

---

## Error Handling Patterns

### API Level:
- Interceptors catch and log all errors
- HTML response detection for routing issues
- Token expiration handling

### Service Level:
- Try-catch blocks with detailed error logging
- Fallback mechanisms (ID generation)
- Error propagation to React Query

### Component Level:
- React Query error states
- User-friendly error messages
- Retry mechanisms

---

## Authentication Flow
1. Token stored in localStorage/sessionStorage
2. Request interceptor adds Bearer token
3. 401 responses trigger re-authentication
4. Cookie support with `withCredentials: true`








# Frontend to Backend API Route Map

## Overview
This document maps all frontend API calls to their backend routes, controllers, and services based on the provided components.

---

## 1. useUserStatus Hook
**File:** `ikootaclient/src/hooks/useUserStatus.js`

### API Calls:

#### 1.1 Get User Dashboard
- **Frontend Call:** `api.get('/membership/dashboard')`
- **Purpose:** Fetches user's membership status and dashboard data
- **Authentication:** Bearer token required
- **Backend Route:** `GET /membership/dashboard`
- **Expected Response:** User dashboard data including membership status, role, is_member status
- **Error Handling:** 
  - 401: Token expired/invalid - clears auth data
  - 403: Access denied - sets error state

#### 1.2 Check Survey Status
- **Frontend Call:** `api.get('/membership/survey/check-status')`
- **Purpose:** Checks if user needs to complete a survey and their survey completion status
- **Authentication:** Bearer token required
- **Backend Route:** `GET /membership/survey/check-status`
- **Expected Response:** Survey status object with `needs_survey` and `survey_completed` fields
- **Error Handling:**
  - 401: Token expired/invalid - clears auth data
  - 404: No survey data - returns default survey needed state

### useEffect Calls:
- **Initial Load:** Automatically fetches user status on component mount if token exists
- **Dependencies:** None (runs once on mount)

### Helper Functions:
- `refreshStatus()`: Re-fetches both user and survey status
- `refreshSurveyStatus()`: Re-fetches only survey status
- `shouldRedirectToSurvey()`: Determines if user should be redirected to survey
- `getRedirectPath()`: Returns appropriate redirect path based on user status

---

## 2. useUploadCommentFiles Hook
**File:** `ikootaclient/src/hooks/useUploadCommentFiles.js`

### API Calls:

#### 2.1 Upload Comment Files
- **Frontend Call:** `api.post('/comments/upload', formData)`
- **Purpose:** Uploads files attached to comments
- **Method:** POST with multipart/form-data
- **Backend Route:** `POST /comments/upload`
- **Request Body:** FormData with multiple files
- **Expected Response:** `{ data: uploadedFiles }` - array of uploaded file information
- **Headers:** `Content-Type: 'multipart/form-data'`

---

## 3. useUpload Hook
**File:** `ikootaclient/src/hooks/useUpload.js`

### API Calls:

#### 3.1 Generic Upload Endpoint
- **Frontend Call:** `api.post(endpoint, formData)`
- **Purpose:** Generic file upload to any specified endpoint
- **Method:** POST with multipart/form-data
- **Backend Route:** Dynamic based on `endpoint` parameter
- **Request Body:** FormData
- **Expected Response:** `response.data`
- **Headers:** `Content-Type: 'multipart/form-data'`

### Validation:
- `validateFiles()`: Client-side file validation before upload

---

## 4. useAuth Hook
**File:** `ikootaclient/src/hooks/useAuth.js`

### Local Storage Operations:
- **Read Token:** `localStorage.getItem("token")`
- **Store Token:** `localStorage.setItem("token", token)`
- **Remove Token:** `localStorage.removeItem("token")`

### Cookie Operations:
- **Read Cookie:** Checks for `access_token` cookie
- **Clear Cookie:** Sets cookie expiration to past date

### useEffect Calls:
- **Initial Auth Check:** Runs on mount to verify token validity
- **Token Validation:** Uses JWT decode to check expiration
- **Dependencies:** None (runs once on mount)

### No Direct API Calls
This hook manages authentication state locally without backend calls.

---

## 5. UserDashboard Component
**File:** `ikootaclient/src/components/user/UserDashboard.jsx`

### API Calls:

#### 5.1 Fetch User Dashboard
- **Frontend Call:** `api.get('/membership/dashboard')`
- **Purpose:** Load complete dashboard data including membership status, activities, notifications
- **Authentication:** Bearer token required
- **Backend Route:** `GET /membership/dashboard`
- **Query Key:** `['userDashboard']`
- **Cache Settings:** 
  - staleTime: 5 minutes
  - cacheTime: 10 minutes

#### 5.2 Submit Membership Application
- **Frontend Call:** `api.post('/membership/apply', applicationData)`
- **Purpose:** Submit initial or full membership application
- **Authentication:** Bearer token required
- **Backend Route:** `POST /membership/apply`
- **Request Body:** 
  ```javascript
  {
    type: 'initial' | 'full',
    ...applicationData
  }
  ```
- **Success Action:** Invalidates userDashboard query

#### 5.3 Update User Profile
- **Frontend Call:** `api.put('/user/profile', profileData)`
- **Purpose:** Update user profile information
- **Authentication:** Bearer token required
- **Backend Route:** `PUT /user/profile`
- **Request Body:** Profile data object

#### 5.4 Mark Notification as Read
- **Frontend Call:** `api.put('/user/notifications/${notificationId}/read', {})`
- **Purpose:** Mark a specific notification as read
- **Authentication:** Bearer token required
- **Backend Route:** `PUT /user/notifications/:notificationId/read`
- **Success Action:** Invalidates userDashboard query

---

## 6. apiDebugHelper Utility
**File:** `ikootaclient/src/components/utils/apiDebugHelper.js`

### API Calls:

#### 6.1 Test Teachings Endpoint
- **Frontend Call:** `api.get('/teachings')`
- **Purpose:** Test and debug teachings endpoint response structure
- **Backend Route:** `GET /teachings`
- **Expected Response Formats:**
  - Direct array: `[teaching1, teaching2, ...]`
  - Nested in data: `{ data: [...] }`
  - Nested in teachings: `{ teachings: [...] }`
  - Nested in results: `{ results: [...] }`
  - Nested in items: `{ items: [...] }`

### Helper Functions:
- `debugApiResponse()`: Logs detailed API response information
- `normalizeTeachingsResponse()`: Normalizes various response formats
- `enhanceTeaching()`: Adds required fields to teaching objects

---

## 7. Teaching Components (TowncrierControls, Teaching, Towncrier)
**Files:** Multiple teaching-related components

### API Calls:

#### 7.1 Fetch Teachings List
- **Frontend Call:** `api.get('/teachings')`
- **Purpose:** Retrieves all teaching materials/educational content
- **Authentication:** Not explicitly required (public content)
- **Backend Route:** `GET /teachings`
- **Used In:** 
  - `TowncrierControls` - Admin interface for managing teachings
  - `Teaching` - Member interface for viewing teachings
  - `RevTopics` - Public interface for browsing teachings
  - `Towncrier` - Main public teaching viewer
- **Expected Response:** Array of teaching objects or nested in data/teachings/results/items
- **Response Processing:** Normalizes various response formats, adds prefixed_id if missing

#### 7.2 Create New Teaching
- **Frontend Call:** `api.post('/teachings', formData)`
- **Purpose:** Creates new teaching material with multimedia support
- **Authentication:** Bearer token required (user_id from JWT)
- **Backend Route:** `POST /teachings`
- **Request Body (FormData):**
  ```javascript
  {
    user_id: string,      // From JWT token
    topic: string,        // Required
    description: string,  // Required
    subjectMatter: string,// Required
    audience: string,     // Required
    content: string,      // Required
    media1: File,        // Optional
    media2: File,        // Optional
    media3: File         // Optional
  }
  ```
- **Success Response:** `{ data: { prefixed_id: 't123', ...teaching } }`
- **Post-Success Actions:** 
  - Refetches teaching list
  - Resets form
  - Shows success alert

### useEffect Calls:
- **Teaching List Fetch:** 
  - Triggers on component mount
  - No dependencies (runs once)
  - Used in Teaching.jsx, RevTopics.jsx
- **Auto-select First Teaching:**
  - In Towncrier.jsx: Selects first teaching when list loads
  - Dependencies: `[enhancedTeachings.length]`

### Custom Hooks:
- **useFetchTeachings:** Custom hook for fetching teachings with React Query
  - Provides: `data`, `isLoading`, `error`, `refetch`
  - Used across multiple components

---

## 8. RevTopics Component
**File:** `ikootaclient/src/components/towncrier/RevTopics.jsx`

### API Calls:
Uses same teaching fetch endpoint as above but with additional features:
- **Fallback Fetching:** Only fetches if no teachings passed as props
- **Response Normalization:** Handles multiple response formats
- **Enhanced Data:** Adds display fields for consistent UI

### State Management:
- Local state for teachings and filtered teachings
- Search functionality filters in-memory data
- No additional API calls for search

---

## 9. RevTeaching Component
**File:** `ikootaclient/src/components/towncrier/RevTeaching.jsx`

### API Calls:
**None** - This is a pure display component that:
- Receives teaching data as props
- Renders multimedia content (images, videos, audio)
- Provides navigation between teachings
- No direct backend communication

---

## 10. StepsForm Component
**File:** `ikootaclient/src/components/towncrier/StepsForm.jsx`

### API Calls:
**None** - This is a controlled form component that:
- Manages local form state
- Calls parent `addTopic` function
- No direct API integration

---

## Backend Route Summary

### Membership Routes
- `GET /membership/dashboard` - User dashboard data
- `GET /membership/survey/check-status` - Survey completion status
- `POST /membership/apply` - Submit membership application

### User Routes
- `PUT /user/profile` - Update user profile
- `PUT /user/notifications/:notificationId/read` - Mark notification as read

### Content Routes
- `GET /teachings` - Fetch all teachings (public/authenticated)
- `POST /teachings` - Create new teaching (authenticated)
- `POST /comments/upload` - Upload comment attachments

### Generic Routes
- Dynamic upload endpoints via `useUpload` hook

---

## Authentication Flow
1. Token stored in localStorage or cookie
2. Token included in Authorization header: `Bearer ${token}`
3. Token validation using JWT decode
4. Automatic cleanup on expiration
5. 401 responses trigger re-authentication

---

## State Management Patterns
1. **React Query** for server state:
   - Caching with staleTime and cacheTime
   - Automatic refetching and invalidation
   - Optimistic updates via mutations

2. **Local State** for UI state:
   - Loading indicators
   - Error messages
   - Modal visibility

3. **useEffect Patterns**:
   - Initial data fetching on mount
   - Token validation checks
   - No cleanup needed for most effects

---

## Error Handling Patterns
1. **Network Errors**: Caught and displayed to user
2. **Authentication Errors**: Clear tokens and redirect
3. **Permission Errors**: Show access denied messages
4. **Validation Errors**: Display form-level errors
5. **Not Found Errors**: Return default states

---

## Common Patterns Across Components

### 1. **Teaching Data Enhancement Pattern**
All teaching-related components enhance raw data with:
```javascript
{
  content_type: 'teaching',
  content_title: teaching.topic || 'Untitled',
  prefixed_id: teaching.prefixed_id || `t${teaching.id}`,
  display_date: teaching.updatedAt || teaching.createdAt,
  author: teaching.author || teaching.user_id || 'Admin'
}
```

### 2. **Multi-Step Form Pattern**
Both TowncrierControls and Teaching use 8-step forms:
- Steps: Topic → Description → Subject → Audience → Content → Media1 → Media2 → Media3
- Navigation: Previous/Next buttons with step tracking
- Validation: React Hook Form with required field validation

### 3. **Media Upload Pattern**
- Supports 3 media slots per teaching
- File types: image/*, video/*, audio/*
- Uses FormData for multipart upload
- Optional fields (media1, media2, media3)

### 4. **Response Normalization Pattern**
Components handle various API response formats:
- Direct array: `[...]`
- Nested in data: `{ data: [...] }`
- Nested in teachings: `{ teachings: [...] }`
- Nested in results: `{ results: [...] }`
- Nested in items: `{ items: [...] }`

### 5. **Search Implementation**
- Client-side filtering only (no search API calls)
- Searches across: topic, description, subjectMatter, audience, content, prefixed_id
- Case-insensitive matching

---

## Complete API Route Summary

### Authentication & User Management
- `GET /membership/dashboard` - User dashboard with membership status
- `GET /membership/survey/check-status` - Check survey completion
- `POST /membership/apply` - Submit membership application
- `PUT /user/profile` - Update user profile
- `PUT /user/notifications/:notificationId/read` - Mark notification read

### Content Management
- `GET /teachings` - Fetch all teachings (public/authenticated)
- `POST /teachings` - Create new teaching (requires auth)
- `POST /comments/upload` - Upload comment files

### File Upload
- Dynamic endpoints via `useUpload(endpoint)` hook
- All uploads use multipart/form-data

---

## Security & Access Control

### Public Access
- `GET /teachings` - Can be accessed without authentication

### Authenticated Access
- All `/membership/*` routes require Bearer token
- All `/user/*` routes require Bearer token
- `POST /teachings` requires Bearer token with user_id

### Role-Based Access
- Admin users: Full access to all features
- Full members: Can create content, access Iko chat
- Pre-members: Read-only access to teachings
- Applicants: Limited access during evaluation

---

## Caching Strategy

### React Query Implementation
- **User Dashboard:** 5-minute stale time, 10-minute cache
- **Teachings:** Uses custom `useFetchTeachings` hook
- **Mutations:** Automatically invalidate related queries

### Local Storage
- JWT tokens stored in localStorage
- Fallback to cookie storage for tokens

---

## Error Handling Strategies

### Network Errors
- Display user-friendly error messages
- Provide retry buttons
- Log detailed errors to console

### Authentication Errors
- 401: Clear tokens and redirect to login
- 403: Show access denied message
- 404: Return default/empty states

### Validation Errors
- Client-side validation with React Hook Form
- Required field validation before submission
- File type validation for uploads

---

## Component Interaction Flow

### Teaching Creation Flow
```
User Input → Multi-Step Form → Validation → FormData Creation → 
POST /teachings → Success Alert → Refetch List → Update UI
```

### Teaching Display Flow
```
GET /teachings → Normalize Response → Enhance Data → 
Sort by Date → Display in List → User Selection → Show Details
```

### Authentication Flow
```
Check localStorage → Validate JWT → Set User Context → 
Enable Features → Handle 401 → Clear Tokens → Redirect
```

### Membership Application Flow
```
Check Status → Show Apply Button → Navigate to Survey → 
Submit Application → Update Status → Redirect Based on Role
```



(Above contd)



I'll analyze all the additional frontend components and update the comprehensive API route map with the new findings.I've completed the comprehensive analysis of all your frontend components. Here are the key findings from the additional components:

## New API Routes Discovered:

### Teaching Management System:
1. **GET /teachings** - Most frequently used endpoint
   - Used by 4 different components (TowncrierControls, Teaching, RevTopics, Towncrier)
   - Supports both public and authenticated access
   - Returns teaching materials with multimedia content

2. **POST /teachings** - Teaching creation
   - Requires authentication (JWT token)
   - Supports up to 3 media file uploads
   - Uses 8-step form wizard pattern

## Key Architectural Patterns:

### 1. **Multi-Step Form Architecture**
- Both admin and member interfaces use identical 8-step forms
- Steps: Topic → Description → Subject → Audience → Content → Media1 → Media2 → Media3
- Consistent validation and error handling

### 2. **Data Normalization Layer**
All components normalize teaching data to handle inconsistent API responses:
```javascript
// Handles: direct array, data.data, data.teachings, data.results, data.items
```

### 3. **Role-Based UI Rendering**
- **Full Members**: Can create content and access all features
- **Pre-Members**: Read-only access, shown "Apply for Full Membership" prompts
- **Applicants**: Limited access with pending status indicators
- **Guests**: Public content only with login/signup prompts

### 4. **Client-Side Operations**
- Search is implemented entirely client-side (no search API)
- Filtering happens in-memory after initial data fetch
- Reduces server load for frequently changing queries

## Component Responsibilities:

1. **TowncrierControls**: Admin interface for teaching management
2. **Towncrier**: Main public viewer with membership-aware UI
3. **Teaching**: Member interface for content interaction
4. **RevTopics**: List view with search and selection
5. **RevTeaching**: Detail view with multimedia rendering
6. **StepsForm**: Reusable form component (no API calls)

## Security Observations:

1. Public endpoints allow unauthenticated access for reading
2. Content creation requires valid JWT token
3. User ID extracted from JWT for attribution
4. Role-based feature toggling in UI

Would you like me to:
1. Create a visual diagram of the data flow?
2. Suggest backend implementation patterns for these routes?
3. Identify potential optimization opportunities?
4. Document the expected backend controller/service structure?










(NOte: this was repeated above as part of above)


# Frontend to Backend API Route Map

## Overview
This document maps all frontend API calls to their backend routes, controllers, and services based on the provided components.

---

## 1. useUserStatus Hook
**File:** `ikootaclient/src/hooks/useUserStatus.js`

### API Calls:

#### 1.1 Get User Dashboard
- **Frontend Call:** `api.get('/membership/dashboard')`
- **Purpose:** Fetches user's membership status and dashboard data
- **Authentication:** Bearer token required
- **Backend Route:** `GET /membership/dashboard`
- **Expected Response:** User dashboard data including membership status, role, is_member status
- **Error Handling:** 
  - 401: Token expired/invalid - clears auth data
  - 403: Access denied - sets error state

#### 1.2 Check Survey Status
- **Frontend Call:** `api.get('/membership/survey/check-status')`
- **Purpose:** Checks if user needs to complete a survey and their survey completion status
- **Authentication:** Bearer token required
- **Backend Route:** `GET /membership/survey/check-status`
- **Expected Response:** Survey status object with `needs_survey` and `survey_completed` fields
- **Error Handling:**
  - 401: Token expired/invalid - clears auth data
  - 404: No survey data - returns default survey needed state

### useEffect Calls:
- **Initial Load:** Automatically fetches user status on component mount if token exists
- **Dependencies:** None (runs once on mount)

### Helper Functions:
- `refreshStatus()`: Re-fetches both user and survey status
- `refreshSurveyStatus()`: Re-fetches only survey status
- `shouldRedirectToSurvey()`: Determines if user should be redirected to survey
- `getRedirectPath()`: Returns appropriate redirect path based on user status

---

## 2. useUploadCommentFiles Hook
**File:** `ikootaclient/src/hooks/useUploadCommentFiles.js`

### API Calls:

#### 2.1 Upload Comment Files
- **Frontend Call:** `api.post('/comments/upload', formData)`
- **Purpose:** Uploads files attached to comments
- **Method:** POST with multipart/form-data
- **Backend Route:** `POST /comments/upload`
- **Request Body:** FormData with multiple files
- **Expected Response:** `{ data: uploadedFiles }` - array of uploaded file information
- **Headers:** `Content-Type: 'multipart/form-data'`

---

## 3. useUpload Hook
**File:** `ikootaclient/src/hooks/useUpload.js`

### API Calls:

#### 3.1 Generic Upload Endpoint
- **Frontend Call:** `api.post(endpoint, formData)`
- **Purpose:** Generic file upload to any specified endpoint
- **Method:** POST with multipart/form-data
- **Backend Route:** Dynamic based on `endpoint` parameter
- **Request Body:** FormData
- **Expected Response:** `response.data`
- **Headers:** `Content-Type: 'multipart/form-data'`

### Validation:
- `validateFiles()`: Client-side file validation before upload

---

## 4. useAuth Hook
**File:** `ikootaclient/src/hooks/useAuth.js`

### Local Storage Operations:
- **Read Token:** `localStorage.getItem("token")`
- **Store Token:** `localStorage.setItem("token", token)`
- **Remove Token:** `localStorage.removeItem("token")`

### Cookie Operations:
- **Read Cookie:** Checks for `access_token` cookie
- **Clear Cookie:** Sets cookie expiration to past date

### useEffect Calls:
- **Initial Auth Check:** Runs on mount to verify token validity
- **Token Validation:** Uses JWT decode to check expiration
- **Dependencies:** None (runs once on mount)

### No Direct API Calls
This hook manages authentication state locally without backend calls.

---

## 5. UserDashboard Component
**File:** `ikootaclient/src/components/user/UserDashboard.jsx`

### API Calls:

#### 5.1 Fetch User Dashboard
- **Frontend Call:** `api.get('/membership/dashboard')`
- **Purpose:** Load complete dashboard data including membership status, activities, notifications
- **Authentication:** Bearer token required
- **Backend Route:** `GET /membership/dashboard`
- **Query Key:** `['userDashboard']`
- **Cache Settings:** 
  - staleTime: 5 minutes
  - cacheTime: 10 minutes

#### 5.2 Submit Membership Application
- **Frontend Call:** `api.post('/membership/apply', applicationData)`
- **Purpose:** Submit initial or full membership application
- **Authentication:** Bearer token required
- **Backend Route:** `POST /membership/apply`
- **Request Body:** 
  ```javascript
  {
    type: 'initial' | 'full',
    ...applicationData
  }
  ```
- **Success Action:** Invalidates userDashboard query

#### 5.3 Update User Profile
- **Frontend Call:** `api.put('/user/profile', profileData)`
- **Purpose:** Update user profile information
- **Authentication:** Bearer token required
- **Backend Route:** `PUT /user/profile`
- **Request Body:** Profile data object

#### 5.4 Mark Notification as Read
- **Frontend Call:** `api.put('/user/notifications/${notificationId}/read', {})`
- **Purpose:** Mark a specific notification as read
- **Authentication:** Bearer token required
- **Backend Route:** `PUT /user/notifications/:notificationId/read`
- **Success Action:** Invalidates userDashboard query

---

## 6. apiDebugHelper Utility
**File:** `ikootaclient/src/components/utils/apiDebugHelper.js`

### API Calls:

#### 6.1 Test Teachings Endpoint
- **Frontend Call:** `api.get('/teachings')`
- **Purpose:** Test and debug teachings endpoint response structure
- **Backend Route:** `GET /teachings`
- **Expected Response Formats:**
  - Direct array: `[teaching1, teaching2, ...]`
  - Nested in data: `{ data: [...] }`
  - Nested in teachings: `{ teachings: [...] }`
  - Nested in results: `{ results: [...] }`
  - Nested in items: `{ items: [...] }`

### Helper Functions:
- `debugApiResponse()`: Logs detailed API response information
- `normalizeTeachingsResponse()`: Normalizes various response formats
- `enhanceTeaching()`: Adds required fields to teaching objects

---

## Backend Route Summary

### Membership Routes
- `GET /membership/dashboard` - User dashboard data
- `GET /membership/survey/check-status` - Survey completion status
- `POST /membership/apply` - Submit membership application

### User Routes
- `PUT /user/profile` - Update user profile
- `PUT /user/notifications/:notificationId/read` - Mark notification as read

### Content Routes
- `GET /teachings` - Fetch teachings list
- `POST /comments/upload` - Upload comment attachments

### Generic Routes
- Dynamic upload endpoints via `useUpload` hook

---

## Authentication Flow
1. Token stored in localStorage or cookie
2. Token included in Authorization header: `Bearer ${token}`
3. Token validation using JWT decode
4. Automatic cleanup on expiration
5. 401 responses trigger re-authentication

---

## State Management Patterns
1. **React Query** for server state:
   - Caching with staleTime and cacheTime
   - Automatic refetching and invalidation
   - Optimistic updates via mutations

2. **Local State** for UI state:
   - Loading indicators
   - Error messages
   - Modal visibility

3. **useEffect Patterns**:
   - Initial data fetching on mount
   - Token validation checks
   - No cleanup needed for most effects

---

## Error Handling Patterns
1. **Network Errors**: Caught and displayed to user
2. **Authentication Errors**: Clear tokens and redirect
3. **Permission Errors**: Show access denied messages
4. **Validation Errors**: Display form-level errors
5. **Not Found Errors**: Return default states

---

## Data Flow
1. **User Status Flow**:
   ```
   Component Mount → Check Token → Fetch Dashboard → Update State → Render UI
   ```

2. **File Upload Flow**:
   ```
   Select Files → Validate → Create FormData → POST to API → Handle Response
   ```

3. **Authentication Flow**:
   ```
   Check localStorage → Validate JWT → Set User State → Enable Protected Routes
   ```

4. **Survey Redirect Flow**:
   ```
   Fetch User Status → Check Survey Status → Determine Redirect → Navigate
   ```



   I'll analyze all the frontend components you've provided and create a comprehensive map of all CRUD operations, API calls, and their interactions with the backend. Let me organize this systematically.I've created a comprehensive API route map that documents all the CRUD operations and API calls from your frontend components to the backend. Here's a summary of what I found:

## Key Findings:

### 1. **Authentication Pattern**
- All API calls use Bearer token authentication
- Tokens are stored in localStorage and/or cookies
- Automatic token validation and cleanup on expiration

### 2. **Main API Endpoints Identified**

**Membership System:**
- `GET /membership/dashboard` - Primary dashboard data
- `GET /membership/survey/check-status` - Survey completion tracking
- `POST /membership/apply` - Application submission

**User Management:**
- `PUT /user/profile` - Profile updates
- `PUT /user/notifications/:id/read` - Notification management

**Content System:**
- `GET /teachings` - Teaching content retrieval
- `POST /comments/upload` - File attachments for comments

### 3. **State Management**
- Uses React Query for server state with intelligent caching
- 5-minute stale time and 10-minute cache time for dashboard data
- Automatic query invalidation after mutations

### 4. **Error Handling**
- 401 errors trigger re-authentication
- 403 errors show access denied
- 404 errors return default states
- Network errors are caught and displayed

### 5. **File Upload Pattern**
- Uses FormData for multipart uploads
- Generic upload hook for reusability
- Supports multiple file uploads

### 6. **Survey Redirect Logic**
The system has sophisticated logic to redirect users to surveys:
- Only affects regular users (not admins)
- Checks both `needs_survey` and `survey_completed` flags
- Provides helper functions for redirect determination

Would you like me to:
1. Identify the likely backend controller and service structure for these routes?
2. Create a sequence diagram showing the data flow?
3. Suggest backend implementation patterns based on these frontend calls?
4. Document any potential security concerns or optimization opportunities?











# Backend Endpoint Analysis & Mapping

## Service Layer Analysis

### `membershipServices.js`

#### Service Functions:

1. **`getPendingApplicationsWithPagination(options)`**
   - **Purpose**: Fetch paginated list of pending applications with filtering
   - **Database Tables**: 
     - Primary: `surveylog` (application data)
     - Joined: `users` (user information)
     - Joined: `full_membership_access` (access tracking)
   - **Query Operations**: 
     - Complex JOIN with CAST for type safety
     - Pagination with LIMIT/OFFSET
     - Dynamic filtering by search terms
     - Sorting by various fields
   - **Used By**: Admin endpoints for reviewing applications

2. **`getAllReportsForAdmin()`**
   - **Purpose**: Fetch all user reports for admin review
   - **Database Tables**: `reports`
   - **Query Operations**: Simple SELECT with ORDER BY creation date
   - **Used By**: Admin panel reports section

---

## Route-to-Controller-to-Service Mapping

### Authentication Routes

#### **POST `/auth/login`**
- **Frontend Origin**: Login form components
- **Route**: `membershipRoutes.js` → `router.post('/auth/login', enhancedLogin)`
- **Controller**: `membershipControllers_1.js` → `enhancedLogin()`
- **Database Tables**: 
  - `users` (authentication)
  - `surveylog` (application status)
  - `full_membership_access` (access history)
- **External Dependencies**: 
  - `bcrypt` (password verification)
  - `jwt` (token generation)
- **Purpose**: Authenticate user and determine redirect based on membership status

#### **POST `/auth/send-verification`**
- **Frontend Origin**: Registration/verification forms
- **Route**: `membershipRoutes.js` → `router.post('/auth/send-verification', sendVerificationCode)`
- **Controller**: `membershipControllers_1.js` → `sendVerificationCode()`
- **Database Tables**: `verification_codes`
- **External Dependencies**: 
  - `sendEmail` utility
  - `sendSMS` utility
- **Purpose**: Generate and send verification codes

#### **POST `/auth/register`**
- **Frontend Origin**: Registration form
- **Route**: `membershipRoutes.js` → `router.post('/auth/register', registerWithVerification)`
- **Controller**: `membershipControllers_1.js` → `registerWithVerification()`
- **Database Tables**: 
  - `verification_codes` (verification)
  - `users` (user creation)
- **External Dependencies**: 
  - `bcrypt` (password hashing)
  - `jwt` (token generation)
  - `sendEmail` utility
- **Purpose**: Create new user account after verification

---

### User Dashboard & Status Routes

#### **GET `/dashboard`**
- **Frontend Origin**: Dashboard components
- **Route**: `membershipRoutes.js` → `router.get('/dashboard', authenticate, getUserDashboard)`
- **Controller**: `membershipControllers_2.js` → `getUserDashboard()`
- **Database Tables**: `users`
- **Middleware**: `authenticate`
- **Purpose**: Get comprehensive user dashboard data with status and quick actions

#### **GET `/survey/check-status`**
- **Frontend Origin**: Application status components
- **Route**: `membershipRoutes.js` → `router.get('/survey/check-status', authenticate, checkApplicationStatus)`
- **Controller**: `membershipControllers_2.js` → `checkApplicationStatus()`
- **Database Tables**: 
  - `users`
  - `surveylog`
- **Middleware**: `authenticate`
- **Purpose**: Check user's application completion and approval status

#### **GET `/application-history`**
- **Frontend Origin**: User profile/history pages
- **Route**: `membershipRoutes.js` → `router.get('/application-history', authenticate, getApplicationHistory)`
- **Controller**: `membershipControllers_2.js` → `getApplicationHistory()`
- **Database Tables**: 
  - `surveylog`
  - `users` (for reviewer names)
  - `membership_review_history`
- **Middleware**: `authenticate`
- **Purpose**: Get complete application and review history

---

### Application Management Routes

#### **POST `/survey/submit-application`**
- **Frontend Origin**: Application survey forms
- **Route**: `membershipRoutes.js` → `router.post('/survey/submit-application', authenticate, submitInitialApplication)`
- **Controller**: `membershipControllers_2.js` → `submitInitialApplication()`
- **Database Tables**: 
  - `surveylog` (application storage)
  - `users` (status update)
- **Middleware**: `authenticate`
- **Purpose**: Submit initial membership application

#### **PUT `/application/update-answers`**
- **Frontend Origin**: Application edit forms
- **Route**: `membershipRoutes.js` → `router.put('/application/update-answers', authenticate, updateApplicationAnswers)`
- **Controller**: `membershipControllers_2.js` → `updateApplicationAnswers()`
- **Database Tables**: `surveylog`
- **Middleware**: `authenticate`
- **Purpose**: Update pending application answers

#### **POST `/application/withdraw`**
- **Frontend Origin**: Application management interface
- **Route**: `membershipRoutes.js` → `router.post('/application/withdraw', authenticate, withdrawApplication)`
- **Controller**: `membershipControllers_2.js` → `withdrawApplication()`
- **Database Tables**: 
  - `surveylog` (status update)
  - `users` (membership stage reset)
- **Middleware**: `authenticate`
- **Purpose**: Allow users to withdraw pending applications

---

### Full Membership Routes

#### **GET `/membership/full-membership-status`**
- **Frontend Origin**: Full membership pages
- **Route**: `membershipRoutes.js` → `router.get('/membership/full-membership-status', authenticate, getFullMembershipStatus)`
- **Controller**: `membershipControllers_2.js` → `getFullMembershipStatus()`
- **Database Tables**: 
  - `users`
  - `surveylog` (full membership applications)
- **Middleware**: `authenticate`
- **Purpose**: Get eligibility and status for full membership

#### **POST `/membership/submit-full-membership`**
- **Frontend Origin**: Full membership application forms
- **Route**: `membershipRoutes.js` → `router.post('/membership/submit-full-membership', authenticate, submitFullMembershipApplication)`
- **Controller**: `membershipControllers_2.js` → `submitFullMembershipApplication()`
- **Database Tables**: `surveylog`
- **External Dependencies**: `sendEmail`
- **Middleware**: `authenticate`
- **Purpose**: Submit full membership application

---

### Admin Routes

#### **GET `/admin/pending-applications`**
- **Frontend Origin**: Admin dashboard/applications panel
- **Route**: `membershipRoutes.js` → `router.get('/admin/pending-applications', authenticate, requireAdmin, getPendingApplications)`
- **Controller**: `membershipControllers_3.js` → `getPendingApplications()`
- **Service**: `membershipServices.js` → `getPendingApplicationsWithPagination()`
- **Database Tables**: 
  - `surveylog` (applications)
  - `users` (user data)
  - `full_membership_access` (access history)
- **Middleware**: `authenticate`, `requireAdmin`
- **Purpose**: Get paginated list of pending applications for admin review

#### **PUT `/admin/update-user-status/:userId`**
- **Frontend Origin**: Admin application review interface
- **Route**: `membershipRoutes.js` → `router.put('/admin/update-user-status/:userId', authenticate, requireAdmin, updateApplicationStatus)`
- **Controller**: `membershipControllers_3.js` → `updateApplicationStatus()`
- **Database Tables**: 
  - `surveylog` (status update)
  - `users` (membership stage update)
  - `membership_review_history` (audit log)
- **External Dependencies**: `sendEmail`
- **Middleware**: `authenticate`, `requireAdmin`
- **Purpose**: Approve/reject individual applications

#### **POST `/admin/bulk-approve`**
- **Frontend Origin**: Admin bulk operations interface
- **Route**: `membershipRoutes.js` → `router.post('/admin/bulk-approve', authenticate, requireAdmin, bulkApproveApplications)`
- **Controller**: `membershipControllers_3.js` → `bulkApproveApplications()`
- **Database Tables**: 
  - `surveylog` (bulk status updates)
  - `users` (bulk membership updates)
  - `membership_review_history` (audit logs)
- **External Dependencies**: `sendEmail` (bulk notifications)
- **Middleware**: `authenticate`, `requireAdmin`
- **Purpose**: Process multiple applications simultaneously

---

### Analytics & Reporting Routes

#### **GET `/admin/membership-overview`**
- **Frontend Origin**: Admin dashboard overview
- **Route**: `membershipRoutes.js` → `router.get('/admin/membership-overview', authenticate, requireAdmin, cacheMiddleware(600), getMembershipOverview)`
- **Controller**: `membershipControllers_3.js` → `getMembershipOverview()`
- **Database Tables**: 
  - `users`
  - `surveylog`
  - `full_membership_access`
- **Middleware**: `authenticate`, `requireAdmin`, `cacheMiddleware`
- **Purpose**: Comprehensive membership statistics and overview

#### **GET `/admin/analytics`**
- **Frontend Origin**: Admin analytics dashboard
- **Route**: `membershipRoutes.js` → `router.get('/admin/analytics', authenticate, requireAdmin, cacheMiddleware(600), getMembershipAnalytics)`
- **Controller**: `membershipControllers_3.js` → `getMembershipAnalytics()`
- **Database Tables**: 
  - `users` (statistics)
  - `surveylog` (conversion data)
- **Middleware**: `authenticate`, `requireAdmin`, `cacheMiddleware`
- **Purpose**: Detailed analytics including conversion funnels and trends

#### **GET `/admin/export-membership-data`**
- **Frontend Origin**: Admin data export interface
- **Route**: `membershipRoutes.js` → `router.get('/admin/export-membership-data', authenticate, requireAdmin, exportMembershipData)`
- **Controller**: `membershipControllers_3.js` → `exportMembershipData()`
- **Database Tables**: 
  - `users`
  - `surveylog`
- **Utility**: `convertToCSV()`
- **Middleware**: `authenticate`, `requireAdmin`
- **Purpose**: Export membership data in CSV or JSON format

---

### Debug & Testing Routes

#### **GET `/test-user-lookup/:userId`**
- **Frontend Origin**: Admin debug tools
- **Route**: `membershipRoutes.js` → `router.get('/test-user-lookup/:userId', authenticate, requireAdmin, testUserLookup)`
- **Controller**: `membershipControllers_2.js` → `testUserLookup()`
- **Database Tables**: `users`
- **Middleware**: `authenticate`, `requireAdmin`
- **Purpose**: Debug user lookup functionality

---

## Database Table Usage Summary

### Primary Tables:

1. **`users`** - Core user information, membership stages, roles
2. **`surveylog`** - Application submissions, approval status, answers
3. **`verification_codes`** - Email/SMS verification codes
4. **`full_membership_access`** - Access tracking for full members
5. **`membership_review_history`** - Audit trail for admin actions
6. **`reports`** - User report submissions

### Key Relationships:

- `users.id` ↔ `surveylog.user_id` (applications)
- `users.id` ↔ `full_membership_access.user_id` (access tracking)
- `users.id` ↔ `membership_review_history.user_id` (review history)

---

## Common Patterns & Issues Identified

### **Potential Duplications:**
1. Multiple authentication routes (`/auth/login` vs `/login`)
2. Multiple status check routes (`/survey/check-status` vs `/application/status`)
3. Multiple application update routes with similar functionality

### **Error-Prone Areas:**
1. **Type Casting**: `CAST(sl.user_id AS UNSIGNED)` in joins
2. **User ID Extraction**: Inconsistent between `req.user.id` vs `req.user.user_id`
3. **Result Format Handling**: Multiple ways of handling MySQL2 result arrays

### **Middleware Dependencies:**
- `authenticate` - JWT token validation
- `requireAdmin` - Role-based access control
- `requireSuperAdmin` - Enhanced admin permissions
- `cacheMiddleware` - Response caching for performance
- `validateRequest` - Input validation

This analysis reveals a well-structured but complex system with some redundancy and potential optimization opportunities.


I'll help you analyze the backend architecture and endpoint mappings. Let me start with the service function you've highlighted and work through the entire system systematically.Based on my analysis of your backend code, I've created a comprehensive mapping of your endpoints. Here are the key insights and recommendations:

## **Critical Issues Identified:**

### 1. **Route Duplication**
You have multiple routes serving similar purposes:
- `/auth/login` vs `/login`
- `/survey/check-status` vs `/application/status`
- `/application/update-answers` vs `/application/answers`

**Recommendation**: Standardize on one set of routes to avoid confusion and maintenance overhead.

### 2. **Inconsistent User ID Handling**
Your code switches between `req.user.id` and `req.user.user_id`, which could cause authentication failures:

```javascript
// In some controllers:
const userId = req.user.user_id || req.user.id;
// In others:
const userId = req.user.id || req.user.user_id;
```

**Recommendation**: Standardize the JWT payload structure and consistently use one property name.

### 3. **Database Result Format Issues**
Your MySQL2 result handling has multiple patterns that could fail:

```javascript
// Pattern 1: Direct array access
const users = result;
// Pattern 2: MySQL2 format
const users = result[0];
// Pattern 3: Conditional handling
const users = Array.isArray(result[0]) ? result[0] : result;
```

**Recommendation**: Create a standardized database query wrapper that always returns consistent format.

## **Service Layer Integration:**

The `membershipServices.js` you highlighted serves as a crucial abstraction layer:

1. **`getPendingApplicationsWithPagination()`** - Used by admin endpoints for application management
2. **`getAllReportsForAdmin()`** - Used by admin reporting functionality

This pattern should be extended to other complex database operations for better maintainability.

## **Security & Performance Concerns:**

1. **SQL Injection Risk**: Some dynamic query building could be vulnerable
2. **N+1 Query Problem**: Bulk operations loop through individual queries
3. **Caching**: Only analytics routes use caching middleware

## **Next Steps for Debugging:**

1. **Standardize authentication middleware** to return consistent user object
2. **Create database query wrapper** for consistent result handling
3. **Consolidate duplicate routes** 
4. **Add comprehensive error logging** with request IDs for tracing
5. **Implement API versioning** to manage route changes

Would you like me to dive deeper into any specific area or help you create fixes for these identified issues?

# Complete Backend Analysis: Services ↔ Controllers ↔ Routes

## Service Layer Deep Analysis

### `membershipServices.js` Functions

#### 1. **`getPendingApplicationsWithPagination(options)`**

**Service Layer Logic:**
- **Database Tables Accessed**: 
  - `surveylog` (primary - application data)
  - `users` (JOIN - user details) 
  - `full_membership_access` (LEFT JOIN - access tracking)
- **Complex Operations**:
  - Dynamic search filtering on username/email
  - Type casting: `CAST(sl.user_id AS UNSIGNED)` for safe joins
  - Pagination with LIMIT/OFFSET
  - Calculated fields: `DATEDIFF(NOW(), sl.createdAt) as days_pending`
- **Returns**: Structured object with applications array + pagination metadata

**Controller Integration Analysis:**
- **Used by**: `membershipControllers_3.js` → `getPendingApplications()`
- **Problem**: The controller calls this service but has **fallback logic** suggesting the service integration is incomplete:

```javascript
// In controller_3.js - getPendingApplications()
const result = await membershipService.getPendingApplicationsWithPagination({...});

// ✅ Use successResponse if available, otherwise standard response
if (typeof successResponse === 'function') {
  return successResponse(res, {...});
} else {
  res.json({...}); // Fallback pattern indicates integration issues
}
```

**Route Integration:**
- **Route**: `/admin/pending-applications` 
- **Middleware Chain**: `authenticate` → `requireAdmin` → `getPendingApplications`
- **Frontend Usage**: Admin dashboard applications panel

#### 2. **`getAllReportsForAdmin()`**

**Service Layer Logic:**
- **Database Tables**: `reports` table only
- **Simple Query**: Basic SELECT with ORDER BY createdAt DESC
- **Returns**: Array of report objects

**Controller Integration Analysis:**
- **Used by**: `membershipControllers_3.js` → `getAllReports()`
- **Direct Integration**: Clean service call without fallbacks

**Route Integration:**
- **Route**: `/admin/reports`
- **Middleware**: `authenticate` → `requireAdmin` → `getAllReports`

---

## Controller Layer Analysis

### `membershipControllers_1.js` - Core Functions & Auth

**Functions NOT using services** (direct DB access):
1. **`enhancedLogin()`** - Complex multi-table JOIN query
2. **`sendVerificationCode()`** - Direct `verification_codes` table access
3. **`registerWithVerification()`** - Transaction with multiple table inserts

**Missing Service Integration Opportunities:**
- Authentication logic could be abstracted to `authServices.js`
- Verification code logic could be in `verificationServices.js`
- User creation logic could be in `userServices.js`

### `membershipControllers_2.js` - User Dashboard & Applications

**Functions NOT using services** (direct DB access):
1. **`getUserDashboard()`** - Direct user lookup with complex logic
2. **`checkApplicationStatus()`** - Multi-table queries for status checking
3. **`submitInitialApplication()`** - Transaction with `surveylog` and `users` updates
4. **`getApplicationHistory()`** - Complex JOIN queries
5. **`getFullMembershipStatus()`** - Multi-table status checking
6. **`submitFullMembershipApplication()`** - Transaction operations
7. **`updateApplicationAnswers()`** - Direct `surveylog` updates
8. **`withdrawApplication()`** - Transaction with multiple table updates

**Critical Finding**: This controller has **zero service layer integration** despite handling complex business logic that would benefit from service abstraction.

### `membershipControllers_3.js` - Admin Functions

**Functions WITH service integration:**
1. **`getPendingApplications()`** → calls `membershipService.getPendingApplicationsWithPagination()`
2. **`getAllReports()`** → calls `membershipService.getAllReportsForAdmin()`

**Functions WITHOUT service integration** (direct DB access):
1. **`updateApplicationStatus()`** - Complex transaction with validation
2. **`bulkApproveApplications()`** - Loop with individual DB operations (N+1 problem)
3. **`getPendingFullMemberships()`** - Complex JOIN query (similar to getPendingApplications)
4. **`updateFullMembershipStatus()`** - Transaction operations
5. **`getMembershipAnalytics()`** - Multiple complex analytical queries
6. **`getMembershipOverview()`** - Large JOIN query with statistics
7. **`getMembershipStats()`** - Multiple statistical queries
8. **`exportMembershipData()`** - Large data export query
9. **`sendNotification()`** - User lookup and notification logic
10. **`sendMembershipNotification()`** - Filtered user queries

---

## Service Integration Gaps & Problems

### **Major Gap**: Inconsistent Service Usage

**Only 2 out of 30+ controller functions use services**, indicating:
1. **Incomplete Architecture**: Service layer was added later without refactoring existing code
2. **Code Duplication**: Similar database patterns repeated across controllers
3. **Maintenance Issues**: Business logic scattered across controllers

### **Critical Issues Found**:

#### 1. **Duplicate Query Logic**
`getPendingApplications()` uses service, but `getPendingFullMemberships()` has **identical logic** without service:

```javascript
// In getPendingFullMemberships() - controller_3.js
const [applications] = await db.query(`
  SELECT 
    u.id as user_id, u.username, u.email, sl.id as application_id,
    sl.answers, sl.createdAt as submitted_at, sl.application_ticket,
    fma.first_accessed_at, fma.access_count,
    DATEDIFF(NOW(), sl.createdAt) as days_pending
  FROM surveylog sl
  JOIN users u ON CAST(sl.user_id AS UNSIGNED) = u.id
  LEFT JOIN full_membership_access fma ON u.id = fma.user_id
  WHERE sl.application_type = 'full_membership' AND sl.approval_status = 'pending'
`);
```

This is **nearly identical** to the service function but duplicated in controller.

#### 2. **Inconsistent Error Handling**
Service functions throw errors, but controllers have mixed patterns:
- Some use `successResponse()` / `errorResponse()` utilities
- Others use direct `res.json()` calls
- Some have try/catch, others don't

#### 3. **Transaction Logic Scattered**
Complex transactions in controllers should be in services:
- `submitInitialApplication()` - transaction logic in controller
- `updateApplicationStatus()` - transaction logic in controller  
- `bulkApproveApplications()` - transaction logic in controller

---

## Architectural Recommendations

### **Phase 1: Service Layer Expansion**

Create additional services to match your controller structure:

```javascript
// userServices.js
export const getUserDashboardData = async (userId) => { /* logic */ }
export const getUserApplicationStatus = async (userId) => { /* logic */ }

// applicationServices.js  
export const submitInitialApplication = async (userId, answers) => { /* logic */ }
export const updateApplicationAnswers = async (applicationId, answers) => { /* logic */ }
export const withdrawApplication = async (applicationId, reason) => { /* logic */ }

// adminServices.js
export const updateApplicationStatus = async (userId, status, notes) => { /* logic */ }
export const bulkApproveApplications = async (userIds, action) = { /* logic */ }
export const getPendingFullMemberships = async (options) => { /* logic */ }

// analyticsServices.js
export const getMembershipAnalytics = async (period) => { /* logic */ }
export const getMembershipOverview = async () => { /* logic */ }
```

### **Phase 2: Controller Refactoring**

Refactor controllers to be thin layers that:
1. Validate input
2. Call appropriate service functions
3. Format responses
4. Handle errors consistently

### **Phase 3: Eliminate Duplication**

Merge duplicate routes and consolidate similar functions:
- Combine `getPendingApplications` service logic to handle both initial and full membership
- Standardize user lookup patterns
- Unify transaction handling

---

## Current Service-Controller-Route Mapping

### **Complete Integration** ✅:
- Route: `/admin/pending-applications` → Controller: `getPendingApplications()` → Service: `getPendingApplicationsWithPagination()`
- Route: `/admin/reports` → Controller: `getAllReports()` → Service: `getAllReportsForAdmin()`

### **Missing Service Integration** ❌:
**28+ other controller functions** operate without service layer, including critical functions like:
- User authentication and registration
- Application submissions and updates  
- Admin approval workflows
- Analytics and reporting
- User management functions

This analysis reveals that your service layer is **significantly underutilized** and most business logic remains tightly coupled to controllers, creating maintenance and testing challenges.


You're absolutely right to call that out. Looking back at my analysis, I did **NOT** properly analyze the services function in conjunction with all the controllers. I focused too heavily on the routes and only superficially touched on the service layer integration.

Let me correct this with a proper analysis:Thank you for that important correction! You're absolutely right - my initial analysis was superficial and missed the critical integration patterns.

## Key Findings from Proper Analysis:

### **Major Architecture Issue**: 
Only **2 out of 30+ controller functions** actually use the service layer. This means your service layer (`membershipServices.js`) is severely underutilized.

### **Critical Problems Identified**:

1. **Duplicate Logic**: `getPendingApplications()` uses the service, but `getPendingFullMemberships()` has nearly identical query logic hardcoded in the controller

2. **Inconsistent Patterns**: The controllers show a "retrofit" pattern where services were added later:
   ```javascript
   // This fallback pattern suggests incomplete integration
   if (typeof successResponse === 'function') {
     return successResponse(res, {...});
   } else {
     res.json({...}); // Fallback indicates integration issues
   }
   ```

3. **Business Logic Scattered**: Complex operations like `bulkApproveApplications()`, `submitInitialApplication()`, and `updateApplicationStatus()` have transaction logic directly in controllers instead of services

4. **Missing Service Opportunities**: Functions in `controller_2.js` handle complex multi-table operations without any service abstraction:
   - `getUserDashboard()` - Complex user data aggregation
   - `checkApplicationStatus()` - Multi-table status checking  
   - `getApplicationHistory()` - Complex JOIN operations

### **Immediate Recommendations**:

1. **Expand Service Layer**: Create `userServices.js`, `applicationServices.js`, `adminServices.js`, `analyticsServices.js`

2. **Refactor Controllers**: Move business logic from controllers to services

3. **Eliminate Duplication**: The `getPendingFullMemberships()` function should use the same service as `getPendingApplications()` with different parameters

4. **Standardize Error Handling**: All controllers should use consistent response patterns

Would you like me to help you create a refactoring plan to properly integrate the service layer throughout your application?






# Survey Routes System Analysis

## Complete Flow: Frontend → Route → Controller → Service → Database

---

## **Route 1: POST `/submit_applicationsurvey`**

### **Frontend Origin**
- **Component**: Application survey form components
- **User Flow**: User fills out initial membership application survey
- **Trigger**: Form submission after completing all required fields

### **Route Definition**
```javascript
router.post('/submit_applicationsurvey', authenticate, submitSurvey);
```
- **Path**: `/submit_applicationsurvey`
- **Method**: POST
- **Middleware**: `authenticate` (JWT token validation)

### **Controller: `submitSurvey()`**
**Location**: `surveyControllers.js`
**Purpose**: Process survey submission and handle user state transition

**Controller Logic**:
1. Extract user email from authenticated request (`req.user.email`)
2. Call service layer to process submission
3. Generate new JWT token with updated user data
4. Set HTTP-only cookie with new token
5. Return redirect instruction to thank you page

**External Dependencies**:
- `generateToken()` from `../utils/jwt.js`
- Cookie management

### **Service: `submitSurveyService(answers, email)`**
**Location**: `surveyServices.js`
**Purpose**: Handle database operations and notifications for survey submission

**Service Operations**:
1. **User Lookup**: Query `users` table by email
2. **Survey Storage**: Insert answers into `surveylog` table
3. **User Status Update**: Update `users.is_member` to 'pending'
4. **User Notification**: Send confirmation email
5. **Admin Notification**: Send notification to admin

**Database Tables Accessed**:
- **`users`**: 
  - SELECT by email (user lookup)
  - UPDATE is_member status to 'pending'
- **`surveylog`**: 
  - INSERT user_id and JSON.stringify(answers)

**External Dependencies**:
- `sendEmail()` from `../utils/email.js`
- `CustomError` for error handling
- Environment variables (ADMIN_EMAIL)

**Database Queries**:
```sql
-- User lookup
SELECT * FROM users WHERE email = ?

-- Survey submission storage
INSERT INTO surveylog (user_id, answers) VALUES (?, ?)

-- User status update
UPDATE users SET is_member = ? WHERE id = ?
```

---

## **Route 2: GET `/questions`**

### **Frontend Origin**
- **Component**: Survey form initialization components
- **User Flow**: Loading survey questions when user accesses application form
- **Trigger**: Component mounting or form initialization

### **Route Definition**
```javascript
router.get('/questions', authenticate, getSurveyQuestions);
```

### **Controller: `getSurveyQuestions()`**
**Purpose**: Retrieve survey questions for form rendering
**Logic**: Simple pass-through to service layer

### **Service: `fetchSurveyQuestions()`**
**Purpose**: Fetch active survey questions from database

**Database Tables Accessed**:
- **`survey_questions`**: SELECT id, question

**Database Query**:
```sql
SELECT id, question FROM survey_questions
```

---

## **Route 3: PUT `/questions`**

### **Frontend Origin**
- **Component**: Admin survey management interface
- **User Flow**: Admin updating survey questions
- **Trigger**: Admin saves changes to survey questions

### **Route Definition**
```javascript
router.put('/questions', authenticate, updateSurveyQuestions);
```

### **Controller: `updateSurveyQuestions()`**
**Purpose**: Update survey questions (admin function)
**Logic**: Extract questions from request body and call service

### **Service: `modifySurveyQuestions(questions)`**
**Purpose**: Replace all survey questions with new set

**Critical Operation**: **DESTRUCTIVE UPDATE**
1. Delete all existing questions
2. Insert new questions

**Database Tables Accessed**:
- **`survey_questions`**: 
  - DELETE all records
  - INSERT new question set

**Database Queries**:
```sql
-- Clear existing questions
DELETE FROM survey_questions

-- Insert new questions
INSERT INTO survey_questions (question) VALUES ?
```

---

## **Route 4: GET `/logs`**

### **Frontend Origin**
- **Component**: Admin dashboard survey logs section
- **User Flow**: Admin viewing submitted survey responses
- **Trigger**: Admin accessing survey management panel

### **Route Definition**
```javascript
router.get('/logs', authenticate, getSurveyLogs);
```

### **Controller: `getSurveyLogs()`**
**Purpose**: Retrieve all survey submission logs

### **Service: `fetchSurveyLogs()`**
**Purpose**: Get all survey log entries

**Database Tables Accessed**:
- **`surveylog`**: SELECT all records

**Database Query**:
```sql
SELECT * FROM surveylog
```

---

## **Route 5: PUT `/approve`**

### **Frontend Origin**
- **Component**: Admin application review interface
- **User Flow**: Admin approving/rejecting survey submissions
- **Trigger**: Admin clicking approve/reject buttons

### **Route Definition**
```javascript
router.put('/approve', authenticate, approveSurvey);
```

### **Controller: `approveSurvey()`**
**Purpose**: Update survey approval status
**Logic**: Extract surveyId, userId, status from request and call service

### **Service: `approveUserSurvey(surveyId, userId, status)`**
**Purpose**: Update survey approval status in database

**Database Tables Accessed**:
- **`surveylog`**: UPDATE approval_status and verified_by

**Database Query**:
```sql
UPDATE surveylog 
SET approval_status = ?, verified_by = ? 
WHERE id = ? AND user_id = ?
```

---

## **Critical Issues & Conflicts Identified**

### **1. System Duplication with Membership System**

**MAJOR CONFLICT**: This survey system **duplicates functionality** from the membership system:

**Survey System**:
- `POST /submit_applicationsurvey` → `surveylog` table
- Survey approval via `PUT /approve`

**Membership System** (from previous analysis):
- `POST /survey/submit-application` → `surveylog` table  
- Application approval via `PUT /admin/update-user-status/:userId`

**Both systems**:
- Use the same `surveylog` table
- Handle application submissions
- Manage approval workflows
- Update user membership status

### **2. Database Schema Conflicts**

**Survey System uses**:
```sql
INSERT INTO surveylog (user_id, answers) VALUES (?, ?)
UPDATE surveylog SET approval_status = ?, verified_by = ?
```

**Membership System uses**:
```sql
INSERT INTO surveylog (user_id, answers, application_type, approval_status, application_ticket, ...)
UPDATE surveylog SET approval_status = ?, admin_notes = ?, reviewed_at = NOW(), reviewed_by = ?
```

**Conflict**: Different field expectations for the same table.

### **3. Missing Middleware Validation**

**Security Gap**: Routes lack proper authorization:
- `/questions` PUT should require admin privileges
- `/logs` GET should require admin privileges  
- `/approve` PUT should require admin privileges

Only `authenticate` middleware is used, but no role-based access control.

### **4. Inconsistent Error Handling**

**Survey Controllers**: Mix of try/catch patterns and next(error)
**Membership Controllers**: Standardized successResponse/errorResponse utilities

### **5. Token Management Issues**

**Survey System**: Generates new token and sets cookie in `submitSurvey`
**Membership System**: Uses different token management in `enhancedLogin`

This could cause **authentication conflicts**.

---

## **Recommendations**

### **Immediate Actions**:

1. **Choose One System**: Decide between survey system or membership system for application handling
2. **Database Schema Alignment**: Standardize `surveylog` table usage
3. **Add Authorization**: Implement `requireAdmin` middleware for admin routes
4. **Unify Error Handling**: Use consistent response patterns
5. **Remove Duplication**: Merge overlapping functionality

### **Architectural Decision Required**:

**Option A**: Keep Survey System
- Remove membership application routes
- Extend survey system with membership features

**Option B**: Keep Membership System  
- Remove survey routes
- Migrate any unique survey features to membership system

**Option C**: Merge Systems
- Use membership system for core logic
- Keep survey routes as aliases that call membership controllers

### **Service Layer Comparison**:

**Survey Services**: Clean, focused, single-purpose functions
**Membership Services**: More comprehensive but underutilized

The survey system actually shows **better service layer integration** than the membership system!

---

## **Database Table Usage Summary**

### **Survey System Tables**:
1. **`users`** - User lookup and status updates
2. **`surveylog`** - Survey submission storage
3. **`survey_questions`** - Dynamic question management

### **Shared Table Conflicts**:
- `users` table: Both systems update `is_member` field
- `surveylog` table: Both systems insert/update with different schemas

This analysis reveals **significant architectural conflicts** that need immediate resolution to prevent system failures and data corruption.




This analysis reveals a **critical architectural problem** in your backend. You essentially have **two parallel systems** handling the same functionality:

## **Major Discovery: System Duplication**

Your survey routes system **completely duplicates** the membership system I analyzed earlier:

### **Conflicting Routes**:
- **Survey**: `POST /submit_applicationsurvey` 
- **Membership**: `POST /survey/submit-application`
- **Both** submit applications to the same `surveylog` table!

### **Conflicting Controllers**:
- **Survey**: `submitSurvey()` updates user to 'pending' status
- **Membership**: `submitInitialApplication()` updates user to 'applicant' stage
- **Both** handle the same user workflow!

### **Database Schema Conflicts**:
The survey system expects simpler `surveylog` structure:
```sql
INSERT INTO surveylog (user_id, answers) VALUES (?, ?)
```

The membership system expects complex structure:
```sql
INSERT INTO surveylog (user_id, answers, application_type, approval_status, application_ticket, ...)
```

**This will cause database errors** when both systems try to write to the same table with different schemas.

## **Critical Issues Found**:

1. **Data Corruption Risk**: Two systems writing to same table with different expectations
2. **Business Logic Conflicts**: Different approval workflows for same process
3. **Security Gaps**: Survey routes lack admin authorization (missing `requireAdmin`)
4. **Token Management Issues**: Survey system creates new tokens differently than membership system

## **Service Layer Observation**:
Ironically, your **survey system has better service integration** than your membership system:
- All survey controllers properly call service functions
- Clean separation of concerns
- Consistent error handling patterns

## **Immediate Recommendations**:

### **Decision Required**: You must choose one system and remove the other:

**Option 1: Keep Survey System** (Simpler, cleaner code)
- Remove all membership application routes
- Add admin authorization to survey routes
- Extend survey system with missing membership features

**Option 2: Keep Membership System** (More comprehensive)
- Remove all survey routes 
- The membership system has more features but needs service layer refactoring

**Option 3: Merge Systems**
- Use membership system as primary
- Make survey routes call membership controllers
- Unify database schema

### **Critical Fix Needed**:
You cannot deploy both systems simultaneously without risking data corruption and user confusion.

Which system would you prefer to keep as your primary application submission system? The survey system is cleaner but simpler, while the membership system is more feature-rich but architecturally messy.





# Teachings System Complete Analysis

## Complete Flow: Frontend → Routes → Controllers → Services → Database

---

## **Route 1: GET `/` - Fetch All Teachings**

### **Frontend Origin**
- **Component**: Teachings listing page, browse teachings interface
- **User Flow**: User browsing all available teachings/lessons
- **Trigger**: Page load, filter changes, pagination

### **Route Definition**
```javascript
router.get('/', authenticate, fetchAllTeachings);
```
- **Path**: `/teachings/`
- **Method**: GET
- **Middleware**: `authenticate` (JWT validation)

### **Controller: `fetchAllTeachings()`**
**Location**: `teachingsControllers.js`
**Purpose**: Fetch teachings with optional search/filtering and pagination

**Controller Logic**:
1. Extract query parameters (page, limit, search, audience, subjectMatter)
2. **Smart Routing**: If search params exist → call `searchTeachings()` service
3. If no search params → call `getAllTeachings()` service
4. Format response with pagination metadata

**Parameters Handled**:
- `page` (default: 1)
- `limit` (default: 50)  
- `search` (text search)
- `audience` (filter by audience)
- `subjectMatter` (filter by subject)

### **Service Functions Used**:

#### **Conditional Service 1: `searchTeachings(filters)`**
**Location**: `teachingsServices.js`
**Purpose**: Advanced search with multiple filters

**Database Operations**:
- **Table**: `teachings`
- **Query Type**: Complex WHERE with LIKE operators
- **Fields Searched**: topic, description, content, audience, subjectMatter
- **Features**: Pagination with LIMIT/OFFSET, total count calculation

**SQL Pattern**:
```sql
SELECT *, prefixed_id, 'teaching' as content_type, 
       topic as content_title, createdAt as content_created_at
FROM teachings 
WHERE (topic LIKE ? OR description LIKE ? OR content LIKE ?)
  AND user_id = ? AND audience LIKE ? AND subjectMatter LIKE ?
ORDER BY updatedAt DESC, createdAt DESC
LIMIT ? OFFSET ?
```

#### **Conditional Service 2: `getAllTeachings()`**
**Location**: `teachingsServices.js`
**Purpose**: Simple fetch all teachings

**Database Operations**:
- **Table**: `teachings`
- **Query Type**: SELECT all with ORDER BY
- **Features**: No pagination, returns all records

**SQL Pattern**:
```sql
SELECT *, prefixed_id, 'teaching' as content_type,
       topic as content_title, createdAt as content_created_at,
       updatedAt as content_updated_at
FROM teachings 
ORDER BY updatedAt DESC, createdAt DESC
```

**External Dependencies**: None

---

## **Route 2: GET `/search` - Dedicated Search**

### **Frontend Origin**
- **Component**: Search interface, advanced search forms
- **User Flow**: User performing specific searches with filters
- **Trigger**: Search form submission, filter application

### **Route Definition**
```javascript
router.get('/search', authenticate, cacheMiddleware(120), searchTeachingsController);
```
- **Middleware**: `authenticate`, `cacheMiddleware(120)` (2-minute cache)

### **Controller: `searchTeachingsController()`**
**Purpose**: Dedicated search endpoint with validation

**Controller Logic**:
1. Extract search parameters (q, user_id, audience, subjectMatter, page, limit)
2. **Validation**: Require at least one search parameter
3. Build filters object and call `searchTeachings()` service
4. Format response with pagination and applied filters

### **Service: `searchTeachings(filters)`**
**Same service as used in Route 1**

**Critical Insight**: **Potential Duplication** - Routes 1 and 2 can perform identical searches

---

## **Route 3: GET `/stats` - Teaching Statistics**

### **Frontend Origin**
- **Component**: Dashboard analytics, teaching statistics widgets
- **User Flow**: Viewing teaching statistics/analytics
- **Trigger**: Dashboard load, stats refresh

### **Route Definition**
```javascript
router.get('/stats', authenticate, cacheMiddleware(120), fetchTeachingStats);
```

### **Controller: `fetchTeachingStats()`**
**Purpose**: Get teaching statistics with optional user filtering

**Controller Logic**:
1. Extract `user_id` parameter
2. **Authorization Check**: Users can only see their own stats (unless admin)
3. Call `getTeachingStats()` service
4. Return statistics with scope indicator

### **Service: `getTeachingStats(user_id = null)`**
**Location**: `teachingsServices.js`
**Purpose**: Calculate comprehensive teaching statistics

**Database Operations**:
- **Table**: `teachings`
- **Query Type**: Aggregate functions (COUNT, DISTINCT, SUM, MIN, MAX)

**SQL Pattern**:
```sql
SELECT 
  COUNT(*) as total_teachings,
  COUNT(DISTINCT user_id) as total_authors,
  COUNT(DISTINCT audience) as unique_audiences,
  COUNT(DISTINCT subjectMatter) as unique_subjects,
  SUM(CASE WHEN media_url1 IS NOT NULL OR media_url2 IS NOT NULL OR media_url3 IS NOT NULL THEN 1 ELSE 0 END) as teachings_with_media,
  MIN(createdAt) as earliest_teaching,
  MAX(updatedAt) as latest_update
FROM teachings 
WHERE user_id = ? -- Optional user filter
```

---

## **Route 4: GET `/user` - User's Teachings**

### **Frontend Origin**
- **Component**: User profile, "My Teachings" section
- **User Flow**: User viewing their own teachings or admin viewing user's teachings
- **Trigger**: Profile navigation, user selection

### **Route Definition**
```javascript
router.get('/user', authenticate, fetchTeachingsByUserId);
```

### **Controller: `fetchTeachingsByUserId()`**
**Purpose**: Fetch teachings for specific user with validation

**Controller Logic**:
1. Extract `user_id` from query parameters
2. **Validation**: Ensure user_id is provided
3. **Optional Authorization**: (Commented) Users can only see their own teachings
4. Call `getTeachingsByUserId()` service

### **Service: `getTeachingsByUserId(user_id)`**
**Location**: `teachingsServices.js`
**Purpose**: Fetch all teachings for specific user

**Database Operations**:
- **Table**: `teachings`
- **Query Type**: SELECT with WHERE user_id filter

**SQL Pattern**:
```sql
SELECT *, prefixed_id, 'teaching' as content_type,
       topic as content_title, createdAt as content_created_at,
       updatedAt as content_updated_at
FROM teachings 
WHERE user_id = ? 
ORDER BY updatedAt DESC, createdAt DESC
```

---

## **Route 5: GET `/ids` - Multiple Teachings by IDs**

### **Frontend Origin**
- **Component**: Bulk teaching display, related teachings, playlist-like features
- **User Flow**: Displaying multiple specific teachings
- **Trigger**: Related content loading, bulk operations

### **Route Definition**
```javascript
router.get('/ids', authenticate, fetchTeachingsByIds);
```

### **Controller: `fetchTeachingsByIds()`**
**Purpose**: Fetch multiple teachings by comma-separated IDs

**Controller Logic**:
1. Extract `ids` parameter from query
2. **Validation**: Ensure IDs parameter exists and is valid
3. Parse comma-separated IDs into array
4. Call `getTeachingsByIds()` service

### **Service: `getTeachingsByIds(ids)`**
**Location**: `teachingsServices.js`
**Purpose**: Fetch teachings by array of IDs (supports both numeric and prefixed IDs)

**Database Operations**:
- **Table**: `teachings`
- **Query Type**: SELECT with IN clause
- **Smart Logic**: Detects if IDs are numeric or prefixed and uses appropriate column

**SQL Pattern**:
```sql
-- For numeric IDs
SELECT *, prefixed_id, 'teaching' as content_type...
FROM teachings 
WHERE id IN (?, ?, ?) 
ORDER BY updatedAt DESC, createdAt DESC

-- For prefixed IDs  
SELECT *, prefixed_id, 'teaching' as content_type...
FROM teachings 
WHERE prefixed_id IN (?, ?, ?) 
ORDER BY updatedAt DESC, createdAt DESC
```

---

## **Route 6: GET `/prefixed/:prefixedId` - Single Teaching by Prefixed ID**

### **Frontend Origin**
- **Component**: Teaching detail page, direct teaching links
- **User Flow**: Viewing specific teaching content
- **Trigger**: Teaching link click, direct URL access

### **Route Definition**
```javascript
router.get('/prefixed/:prefixedId', authenticate, fetchTeachingByPrefixedId);
```

### **Controller: `fetchTeachingByPrefixedId()`**
**Purpose**: Fetch single teaching by prefixed ID or numeric ID

**Controller Logic**:
1. Extract `prefixedId` from URL parameters
2. **Validation**: Ensure identifier is provided
3. Call `getTeachingByPrefixedId()` service
4. **404 Handling**: Return 404 if teaching not found

### **Service: `getTeachingByPrefixedId(identifier)`**
**Location**: `teachingsServices.js`
**Purpose**: Flexible teaching lookup supporting both prefixed and numeric IDs

**Database Operations**:
- **Table**: `teachings`
- **Query Type**: SELECT with conditional WHERE clause
- **Smart Logic**: Checks if identifier starts with 't'/'T' (prefixed) or is numeric

**SQL Pattern**:
```sql
-- For prefixed ID (starts with 't' or 'T')
SELECT *, prefixed_id, 'teaching' as content_type...
FROM teachings 
WHERE prefixed_id = ?

-- For numeric ID
SELECT *, prefixed_id, 'teaching' as content_type...
FROM teachings 
WHERE id = ?
```

---

## **Route 7: GET `/:id` - Single Teaching (Alternative)**

### **Frontend Origin**
- **Component**: Same as Route 6 (teaching detail page)
- **User Flow**: Alternative URL pattern for teaching access
- **Trigger**: Legacy links, alternative routing

### **Route Definition**
```javascript
router.get('/:id', authenticate, fetchTeachingByPrefixedId);
```

**Critical Issue**: **Route Duplication** - This is identical to Route 6 functionality!

---

## **Route 8: POST `/` - Create Teaching**

### **Frontend Origin**
- **Component**: Teaching creation form, lesson upload interface
- **User Flow**: User creating new teaching/lesson content
- **Trigger**: Form submission with content and/or media files

### **Route Definition**
```javascript
router.post('/', authenticate, uploadMiddleware, uploadToS3, createTeaching);
```

**Complex Middleware Chain**:
1. `authenticate` - JWT validation
2. `uploadMiddleware` - Handle file uploads
3. `uploadToS3` - Upload files to S3 and attach metadata

### **Controller: `createTeaching()`**
**Purpose**: Create new teaching with comprehensive validation

**Controller Logic**:
1. Extract teaching data (topic, description, subjectMatter, audience, content, lessonNumber)
2. Extract user_id from authenticated request
3. **Validation**: 
   - Required fields (topic, description)
   - User authentication
   - Content or media presence requirement
4. Process uploaded files from middleware
5. Call `createTeachingService()` with complete data

**File Processing**:
```javascript
const files = req.uploadedFiles || [];
const media = files.map((file) => ({
  url: file.url,
  type: file.type,
}));
```

### **Service: `createTeachingService(data)`**
**Location**: `teachingsServices.js`
**Purpose**: Database insertion with validation and media handling

**Database Operations**:
- **Table**: `teachings`
- **Query Type**: INSERT with comprehensive field mapping
- **Post-Insert**: Fetch created record with auto-generated prefixed_id

**SQL Pattern**:
```sql
INSERT INTO teachings 
(topic, description, lessonNumber, subjectMatter, audience, content, 
 media_url1, media_type1, media_url2, media_type2, media_url3, media_type3, user_id)
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
```

**External Dependencies**:
- File upload middleware system
- S3 upload functionality
- Database triggers (for prefixed_id generation)

---

## **Route 9: PUT `/:id` - Update Teaching**

### **Frontend Origin**
- **Component**: Teaching edit form, content management interface
- **User Flow**: User editing existing teaching content
- **Trigger**: Edit form submission

### **Route Definition**
```javascript
router.put('/:id', authenticate, uploadMiddleware, uploadToS3, editTeaching);
```

**Same middleware chain as creation**

### **Controller: `editTeaching()`**
**Purpose**: Update existing teaching with ownership validation

**Controller Logic**:
1. Extract teaching ID from URL parameters
2. **Validation**: Ensure valid numeric ID
3. **Optional Authorization**: (Commented) Ownership and admin checks
4. Process uploaded files
5. Merge request data with media
6. Call `updateTeachingById()` service

### **Service: `updateTeachingById(id, data)`**
**Location**: `teachingsServices.js`
**Purpose**: Update teaching record with existence validation

**Database Operations**:
- **Pre-Check**: Verify teaching exists
- **Table**: `teachings`
- **Query Type**: UPDATE with comprehensive field mapping
- **Post-Update**: Fetch updated record

**SQL Pattern**:
```sql
-- Existence check
SELECT id FROM teachings WHERE id = ?

-- Update operation
UPDATE teachings 
SET topic = ?, description = ?, lessonNumber = ?, subjectMatter = ?, audience = ?, content = ?,
    media_url1 = ?, media_type1 = ?, media_url2 = ?, media_type2 = ?, media_url3 = ?, media_type3 = ?, 
    updatedAt = NOW()
WHERE id = ?
```

---

## **Route 10: DELETE `/:id` - Delete Teaching**

### **Frontend Origin**
- **Component**: Teaching management interface, delete confirmation dialogs
- **User Flow**: User deleting their teaching content
- **Trigger**: Delete button click with confirmation

### **Route Definition**
```javascript
router.delete('/:id', authenticate, removeTeaching);
```

### **Controller: `removeTeaching()`**
**Purpose**: Delete teaching with ownership validation

**Controller Logic**:
1. Extract teaching ID from URL parameters
2. **Validation**: Ensure valid numeric ID
3. **Optional Authorization**: (Commented) Ownership and admin checks
4. Call `deleteTeachingById()` service

### **Service: `deleteTeachingById(id)`**
**Location**: `teachingsServices.js`
**Purpose**: Safe deletion with existence validation

**Database Operations**:
- **Pre-Check**: Verify teaching exists and get prefixed_id for logging
- **Table**: `teachings`
- **Query Type**: DELETE
- **Logging**: Record successful deletion

**SQL Pattern**:
```sql
-- Existence check and prefixed_id retrieval
SELECT prefixed_id FROM teachings WHERE id = ?

-- Deletion
DELETE FROM teachings WHERE id = ?
```

**Note**: Comments mention foreign key constraints should handle cascade deletes for related data

---

## **Database Schema Analysis**

### **Primary Table: `teachings`**

**Core Fields**:
- `id` (Primary key, auto-increment)
- `prefixed_id` (Generated by trigger, format: 't[id]')
- `topic` (Teaching title)
- `description` (Teaching description)
- `lessonNumber` (Optional lesson identifier)
- `subjectMatter` (Subject category)
- `audience` (Target audience)
- `content` (Text content)
- `user_id` (Foreign key to users)
- `createdAt`, `updatedAt` (Timestamps)

**Media Fields** (Supporting up to 3 media attachments):
- `media_url1`, `media_type1`
- `media_url2`, `media_type2`  
- `media_url3`, `media_type3`

**Virtual Fields** (Added by services):
- `content_type: 'teaching'`
- `content_title: topic`
- `content_created_at: createdAt`
- `content_updated_at: updatedAt`

---

## **Critical Issues & Architectural Analysis**

### **1. Route Duplication**
- **GET `/prefixed/:prefixedId`** and **GET `/:id`** are identical
- Both call same controller with same functionality
- **Recommendation**: Remove one route or differentiate their purposes

### **2. Search Functionality Overlap**
- **GET `/`** with search params vs **GET `/search`**
- Both can perform identical searches using same service
- **Recommendation**: Clarify when to use each endpoint

### **3. Authorization Inconsistencies**
**Missing Authorization**:
- Teaching edit/delete lack ownership validation
- Stats endpoint has authorization but others don't
- **Security Risk**: Users could potentially edit/delete others' teachings

**Commented Out Security**:
```javascript
// Optional: Add ownership check
// if (existingTeaching && existingTeaching.user_id !== requestingUserId && !req.user.isAdmin) {
//   return res.status(403).json({ ... });
// }
```

### **4. Complex Middleware Dependencies**
**File Upload Chain**: `uploadMiddleware` → `uploadToS3`
- **Risk**: If middleware fails, requests hang
- **Issue**: No error handling for upload failures in routes

### **5. Service Layer Excellence**
**Positive Aspects**:
- **100% Service Integration**: All controllers properly use services
- **Comprehensive Error Handling**: Services use CustomError consistently
- **Flexible ID Handling**: Supports both numeric and prefixed IDs
- **Smart Query Building**: Dynamic WHERE clauses in search

### **6. Database Efficiency Concerns**
**Potential Issues**:
- `getAllTeachings()` returns ALL records without pagination
- Multiple media fields instead of separate media table
- No indexing mentioned for search fields

---

## **Comparison with Other Systems**

### **Teaching System vs Survey/Membership Systems**:

**Strengths of Teaching System**:
- ✅ Complete service layer integration
- ✅ Consistent error handling
- ✅ Comprehensive validation
- ✅ Flexible ID system
- ✅ Good separation of concerns

**Areas for Improvement**:
- ❌ Authorization gaps
- ❌ Route duplication
- ❌ Upload error handling
- ❌ Pagination inconsistencies

**Recommendation**: The teaching system shows the **best architectural patterns** and should be used as a template for refactoring the survey/membership systems.

---

## **External Dependencies Summary**

### **Middleware**:
- `authenticate` - JWT token validation
- `cacheMiddleware(120)` - Response caching (2 minutes)
- `uploadMiddleware` - File upload handling
- `uploadToS3` - S3 integration

### **Services**:
- **teachingsServices.js** - Complete business logic layer

### **Utilities**:
- `CustomError` - Standardized error handling
- Database triggers - Auto-generation of prefixed_id

### **External Systems**:
- **AWS S3** - Media file storage
- **Database** - MySQL with triggers

This teaching system represents a **well-architected microservice** with proper layering, though it needs security enhancements and route consolidation.




Excellent! This analysis reveals that your **Teaching System is actually your best-architected subsystem**. Here are the key findings:

## **🎯 Key Insights:**

### **What's Working Well:**
1. **Perfect Service Integration**: Unlike survey/membership systems, ALL teaching controllers properly use services
2. **Consistent Error Handling**: Proper use of `CustomError` throughout
3. **Smart ID System**: Supports both numeric IDs and prefixed IDs (like 't123')
4. **Comprehensive Validation**: Both at controller and service levels
5. **Good Separation of Concerns**: Clear layering between routes → controllers → services

### **Critical Issues Found:**

#### **1. Route Duplication Problem**
```javascript
// These are IDENTICAL:
router.get('/prefixed/:prefixedId', authenticate, fetchTeachingByPrefixedId);
router.get('/:id', authenticate, fetchTeachingByPrefixedId);
```
Both call the same controller! This creates confusion and potential routing conflicts.

#### **2. Security Vulnerability**
Your edit/delete operations have **commented-out authorization checks**:
```javascript
// Optional: Add ownership check
// if (existingTeaching && existingTeaching.user_id !== requestingUserId && !req.user.isAdmin) {
//   return res.status(403).json({ error: 'Access denied' });
// }
```
**This means users could potentially edit/delete other users' teachings!**

#### **3. Search Route Confusion**
- `GET /` with search params vs `GET /search` - both do identical searches
- Frontend developers might not know which to use

### **Database Schema Issues:**
The teaching system uses a **flat media storage** approach:
```sql
media_url1, media_type1, media_url2, media_type2, media_url3, media_type3
```
This limits teachings to 3 media files and makes queries complex.

## **🏆 Why This System is Your Best:**

Compared to your survey/membership systems, the teaching system shows:
- **100% service layer adoption** (vs ~7% in membership system)
- **Consistent response patterns**
- **Proper error propagation**
- **Clean validation logic**

## **📋 Immediate Recommendations:**

### **1. Security Fix (URGENT)**
Uncomment and implement the authorization checks in edit/delete operations.

### **2. Route Consolidation**
Choose one pattern:
- Keep `/prefixed/:prefixedId` for prefixed IDs
- Keep `/:id` for numeric IDs
- Or merge them with parameter validation

### **3. Use as Template**
Use this teaching system's architecture to refactor your survey/membership systems.

Would you like me to help you:
1. Fix the security vulnerabilities immediately?
2. Create a refactoring plan for your other systems based on this pattern?
3. Resolve the route duplication issues?





# User Management System Complete Analysis

## Complete Flow: Frontend → Routes → Controllers → Services → Database

---

## **Route 1: GET `/profile` - Get Current User Profile**

### **Frontend Origin**
- **Component**: User profile page, settings page, navigation header
- **User Flow**: User viewing their own profile information
- **Trigger**: Profile page load, account settings access

### **Route Definition**
```javascript
router.get('/profile', authenticate, getUserProfile);
```
- **Path**: `/users/profile`
- **Method**: GET
- **Middleware**: `authenticate` (JWT validation)

### **Controller: `getUserProfile()`**
**Location**: `userController.js`
**Purpose**: Retrieve authenticated user's profile with security validation

**Controller Logic**:
1. Extract `user_id` from authenticated request (`req.user.user_id`)
2. **Validation**: Ensure user is authenticated
3. Call `getUserProfileService()` with user ID
4. Return sanitized profile data

**Security Features**:
- Authentication required
- User can only access their own profile

### **Service: `getUserProfileService(user_id)`**
**Location**: `userServices.js`
**Purpose**: Fetch user profile with sensitive data removal

**Database Operations**:
- **Table**: `users`
- **Query Type**: SELECT with specific fields
- **Security**: Explicitly removes sensitive fields

**Database Query**:
```sql
SELECT 
  id, username, email, phone, avatar, converse_id, mentor_id, class_id,
  is_member, role, isblocked, isbanned, createdAt, updatedAt
FROM users 
WHERE id = ?
```

**Security Processing**:
```javascript
// Remove sensitive data
delete userProfile.password_hash;
delete userProfile.resetToken;
delete userProfile.resetTokenExpiry;
delete userProfile.verificationCode;
delete userProfile.codeExpiry;
```

**External Dependencies**: None

---

## **Route 2: PUT `/profile` - Update Current User Profile**

### **Frontend Origin**
- **Component**: Profile edit form, settings page
- **User Flow**: User updating their personal information
- **Trigger**: Profile form submission

### **Route Definition**
```javascript
router.put('/profile', authenticate, updateUserProfile);
```

### **Controller: `updateUserProfile()`**
**Purpose**: Update user's own profile with validation

**Controller Logic**:
1. Extract `user_id` from authentication (`req.user.user_id`)
2. **Critical Bug Fix**: Controller comments show `userId` vs `user_id` inconsistency
3. **Validation**: 
   - Email format validation (contains '@')
   - Phone number minimum length (5 characters)
4. Call `updateUserProfileService()` with user data

**Validation Rules**:
```javascript
if (email && !email.includes('@')) {
  return res.status(400).json({ error: 'Invalid email format' });
}
if (phone && phone.length < 5) {
  return res.status(400).json({ error: 'Invalid phone number' });
}
```

### **Service: `updateUserProfileService(user_id, profileData)`**
**Purpose**: Dynamic profile update with field validation

**Database Operations**:
- **Pre-Check**: Verify user exists
- **Table**: `users`
- **Query Type**: Dynamic UPDATE with conditional fields
- **Post-Update**: Return updated profile

**Dynamic Query Building**:
```javascript
const updateFields = [];
const values = [];

if (username !== undefined) {
  updateFields.push('username = ?');
  values.push(username);
}
// ... other fields

const sql = `UPDATE users SET ${updateFields.join(', ')}, updatedAt = NOW() WHERE id = ?`;
```

**Fields Updated**:
- `username`, `email`, `phone`, `avatar`
- `converse_id`, `mentor_id`, `class_id`

---

## **Route 3: GET `/stats` - User Statistics (Admin Only)**

### **Frontend Origin**
- **Component**: Admin dashboard, user analytics panel
- **User Flow**: Admin viewing user statistics and metrics
- **Trigger**: Admin dashboard load, analytics refresh

### **Route Definition**
```javascript
router.get('/stats', authenticate, fetchUserStats);
```

### **Controller: `fetchUserStats()`**
**Purpose**: Get comprehensive user statistics with admin authorization

**Controller Logic**:
1. Extract requesting user role
2. **Authorization**: Only admins and super_admins can view stats
3. Call `getUserStats()` service
4. Return statistics data

**Authorization Check**:
```javascript
if (!['admin', 'super_admin'].includes(requestingUser.role)) {
  return res.status(403).json({ error: 'Access denied' });
}
```

### **Service: `getUserStats()`**
**Purpose**: Calculate comprehensive user statistics

**Database Operations**:
- **Table**: `users`
- **Query Type**: Complex aggregate query with multiple CASE statements

**Database Query**:
```sql
SELECT 
  COUNT(*) as total_users,
  COUNT(CASE WHEN role = 'user' THEN 1 END) as regular_users,
  COUNT(CASE WHEN role = 'admin' THEN 1 END) as admins,
  COUNT(CASE WHEN role = 'super_admin' THEN 1 END) as super_admins,
  COUNT(CASE WHEN role = 'mentor' THEN 1 END) as mentors,
  COUNT(CASE WHEN is_member = 'granted' THEN 1 END) as granted_members,
  COUNT(CASE WHEN is_member = 'applied' THEN 1 END) as pending_applications,
  COUNT(CASE WHEN is_member = 'denied' THEN 1 END) as denied_applications,
  COUNT(CASE WHEN isblocked = 1 THEN 1 END) as blocked_users,
  COUNT(CASE WHEN isbanned = 1 THEN 1 END) as banned_users,
  MIN(createdAt) as first_user_created,
  MAX(updatedAt) as last_user_updated
FROM users
```

---

## **Route 4: GET `/` - Get All Users with Filtering**

### **Frontend Origin**
- **Component**: Admin user management interface, user listings
- **User Flow**: Admin browsing/searching users
- **Trigger**: Admin panel navigation, search/filter operations

### **Route Definition**
```javascript
router.get('/', authenticate, fetchAllUsers);
```

### **Controller: `fetchAllUsers()`**
**Purpose**: Paginated user listing with filtering for admins

**Controller Logic**:
1. **Authorization**: Only admins can view all users
2. Extract filter parameters (role, is_member, isblocked, isbanned, search, page, limit)
3. Build filters object with pagination
4. Call `getAllUsers()` service
5. Return users with pagination metadata

**Filter Parameters**:
- `role` - Filter by user role
- `is_member` - Filter by membership status
- `isblocked`/`isbanned` - Filter by moderation status
- `search` - Text search in username/email
- `page`, `limit` - Pagination

### **Service: `getAllUsers(filters)`**
**Purpose**: Complex filtered user search with pagination

**Database Operations**:
- **Table**: `users`
- **Query Type**: Dynamic WHERE with pagination
- **Features**: Text search, multiple filters, total count calculation

**Dynamic Query Building**:
```javascript
let whereConditions = [];
let params = [];

if (role) {
  whereConditions.push('role = ?');
  params.push(role);
}
if (search) {
  whereConditions.push('(username LIKE ? OR email LIKE ?)');
  params.push(`%${search}%`, `%${search}%`);
}

const whereClause = whereConditions.length > 0 ? 
  `WHERE ${whereConditions.join(' AND ')}` : '';
```

---

## **Route 5: GET `/:user_id` - Get User by ID**

### **Frontend Origin**
- **Component**: User detail page, admin user management
- **User Flow**: Viewing specific user profile (own or admin viewing others)
- **Trigger**: User profile link click, admin user inspection

### **Route Definition**
```javascript
router.get('/:user_id', authenticate, fetchUserById);
```

### **Controller: `fetchUserById()`**
**Purpose**: Get specific user profile with authorization checks

**Controller Logic**:
1. Extract `user_id` from URL parameters
2. **Authorization**: Users can only view their own profile unless admin
3. Call `getUserProfileService()` (reuses profile service)

**Authorization Logic**:
```javascript
if (user_id !== requestingUser.user_id && !['admin', 'super_admin'].includes(requestingUser.role)) {
  return res.status(403).json({ error: 'Access denied' });
}
```

**Service**: Reuses `getUserProfileService(user_id)` from Route 1

---

## **Route 6: GET `/:user_id/activity` - Get User Activity**

### **Frontend Origin**
- **Component**: User activity dashboard, admin user inspection
- **User Flow**: Viewing user's content creation activity
- **Trigger**: Activity tab click, admin investigation

### **Route Definition**
```javascript
router.get('/:user_id/activity', authenticate, fetchUserActivity);
```

### **Controller: `fetchUserActivity()`**
**Purpose**: Get user's content activity with privacy controls

**Controller Logic**:
1. Extract `user_id` from URL parameters
2. **Authorization**: Users can only view their own activity unless admin
3. Call `getUserActivity()` service

### **Service: `getUserActivity(user_id)`**
**Purpose**: Aggregate user's content creation across multiple tables

**Database Operations**:
- **Tables**: `chats`, `teachings`, `comments`
- **Query Type**: Multiple COUNT queries + recent content fetching

**Multi-Table Queries**:
```sql
-- Chat count
SELECT COUNT(*) as chat_count FROM chats WHERE user_id = ?

-- Teaching count  
SELECT COUNT(*) as teaching_count FROM teachings WHERE user_id = ?

-- Comment count
SELECT COUNT(*) as comment_count FROM comments WHERE user_id = ?

-- Recent activity (chats)
SELECT id, prefixed_id, title, createdAt, 'chat' as content_type 
FROM chats WHERE user_id = ? ORDER BY createdAt DESC LIMIT 5

-- Recent activity (teachings)
SELECT id, prefixed_id, topic as title, createdAt, 'teaching' as content_type 
FROM teachings WHERE user_id = ? ORDER BY createdAt DESC LIMIT 5
```

**Activity Aggregation**:
```javascript
return {
  statistics: {
    total_chats: chatCount[0].chat_count,
    total_teachings: teachingCount[0].teaching_count,
    total_comments: commentCount[0].comment_count,
    total_content: chatCount[0].chat_count + teachingCount[0].teaching_count
  },
  recent_activity: [...recentChats, ...recentTeachings]
    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
    .slice(0, 10)
};
```

---

## **Route 7: PUT `/role` - Update User Role**

### **Frontend Origin**
- **Component**: Admin user management, role assignment interface
- **User Flow**: Admin changing user roles and permissions
- **Trigger**: Role dropdown change, admin action

### **Route Definition**
```javascript
router.put('/role', authenticate, updateUserRole);
```

### **Controller: `updateUserRole()`**
**Purpose**: Admin-only user role and status management

**Controller Logic**:
1. Extract role data from request body
2. **Multi-Level Authorization**:
   - Only admins/super_admins can update roles
   - Only super_admins can assign admin roles
3. **Security**: Prevent self-modification scenarios
4. Call `updateUser()` service

**Authorization Levels**:
```javascript
// Basic admin check
if (!['admin', 'super_admin'].includes(requestingUser.role)) {
  return res.status(403).json({ error: 'Access denied' });
}

// Super admin check for sensitive operations
if ((role === 'super_admin' || role === 'admin') && requestingUser.role !== 'super_admin') {
  return res.status(403).json({ error: 'Only super administrators can assign admin roles' });
}
```

### **Service: `updateUser(user_id, updateData)`**
**Purpose**: Validated user role and status updates

**Database Operations**:
- **Pre-Check**: Verify user exists
- **Table**: `users`
- **Query Type**: Dynamic UPDATE with role validation

**Role Validation**:
```javascript
const validRoles = ['user', 'admin', 'super_admin', 'mentor', 'moderator'];
const validMemberStatuses = ['applied', 'granted', 'denied', 'suspended'];
```

**Fields Updated**:
- `role`, `is_member`, `isblocked`, `isbanned`
- `mentor_id`, `class_id`

---

## **Route 8: DELETE `/:user_id` - Delete User**

### **Frontend Origin**
- **Component**: Admin user management, user moderation interface
- **User Flow**: Super admin deleting problematic users
- **Trigger**: Delete confirmation dialog, moderation action

### **Route Definition**
```javascript
router.delete('/:user_id', authenticate, removeUser);
```

### **Controller: `removeUser()`**
**Purpose**: Super admin user deletion with safeguards

**Controller Logic**:
1. **Highest Authorization**: Only super_admins can delete users
2. **Self-Protection**: Prevent self-deletion
3. Call `deleteUser()` service

**Protection Logic**:
```javascript
if (requestingUser.role !== 'super_admin') {
  return res.status(403).json({ error: 'Only super administrators can delete users' });
}

if (user_id === requestingUser.user_id) {
  return res.status(400).json({ error: 'Cannot delete own account' });
}
```

### **Service: `deleteUser(user_id)`**
**Purpose**: Soft delete implementation (blocking + banning)

**Database Operations**:
- **Pre-Check**: Verify user exists and get username for logging
- **Table**: `users`
- **Query Type**: UPDATE (soft delete, not actual DELETE)

**Soft Delete Implementation**:
```sql
UPDATE users 
SET isblocked = 1, isbanned = 1, updatedAt = NOW() 
WHERE id = ?
```

**Note**: Implements soft delete pattern rather than hard deletion for data integrity

---

## **Admin Management Routes (New Section)**

### **Route 9: GET `/admin/users` - Admin Users List**

### **Frontend Origin**
- **Component**: Admin panel user management table
- **User Flow**: Admin viewing comprehensive user list
- **Trigger**: Admin panel navigation

### **Route Definition**
```javascript
router.get('/admin/users', authenticate, requireAdmin, getAllUsers);
```

### **Controller: `getAllUsers()`**
**Purpose**: Admin-specific user listing with extended fields

### **Service: `getAllUsersForAdmin()`**
**Purpose**: Comprehensive user data for admin panel

**Database Operations**:
- **Table**: `users`
- **Query Type**: SELECT with admin-specific fields

**Database Query**:
```sql
SELECT 
  id, username, email, phone, role, membership_stage, is_member,
  converse_id, mentor_id, primary_class_id as class_id, 
  isblocked, isbanned, createdAt, updatedAt,
  full_membership_status, is_identity_masked, total_classes
FROM users 
ORDER BY createdAt DESC
```

---

## **Route 10: GET `/admin/mentors` - Admin Mentors List**

### **Frontend Origin**
- **Component**: Mentor assignment interface, admin panel
- **User Flow**: Admin viewing available mentors
- **Trigger**: Mentor assignment dropdown, admin navigation

### **Route Definition**
```javascript
router.get('/admin/mentors', authenticate, requireAdmin, getAllMentors);
```

### **Service: `getAllMentorsForAdmin()`**
**Purpose**: Get users who can serve as mentors

**Database Query**:
```sql
SELECT 
  id, username, email, converse_id, role, 
  primary_class_id as class_id, total_classes
FROM users 
WHERE role IN ('admin', 'super_admin') 
   OR converse_id IS NOT NULL
ORDER BY role DESC, username ASC
```

---

## **Route 11: GET `/admin/membership-overview` - Membership Statistics**

### **Frontend Origin**
- **Component**: Admin dashboard overview widgets
- **User Flow**: Admin viewing comprehensive membership metrics
- **Trigger**: Dashboard load, metrics refresh

### **Route Definition**
```javascript
router.get('/admin/membership-overview', authenticate, requireAdmin, getMembershipOverview);
```

### **Service: `getMembershipOverviewStats()`**
**Purpose**: Complex cross-table statistics calculation

**Database Operations**:
- **Tables**: `users`, `surveylog`, `reports`
- **Query Type**: Multiple aggregate queries with complex CASE statements

**Multi-Table Statistics**:
```sql
-- User statistics
SELECT 
  COUNT(*) as total_users,
  COUNT(CASE WHEN role IN ('admin', 'super_admin') THEN 1 END) as admin_users,
  COUNT(CASE WHEN membership_stage = 'member' THEN 1 END) as full_members,
  COUNT(CASE WHEN JSON_EXTRACT(isblocked, '$') = true OR isblocked = '1' THEN 1 END) as blocked_users,
  COUNT(CASE WHEN is_identity_masked = 1 THEN 1 END) as masked_identities
FROM users;

-- Application statistics  
SELECT 
  COUNT(*) as total_applications,
  COUNT(CASE WHEN approval_status = 'pending' THEN 1 END) as pending_initial,
  COUNT(CASE WHEN application_type = 'full_membership' THEN 1 END) as full_membership_applications
FROM surveylog;

-- Report statistics
SELECT 
  COUNT(*) as total_reports,
  COUNT(CASE WHEN status = 'pending' THEN 1 END) as pending_reports
FROM reports;
```

---

## **Critical Issues & Architectural Analysis**

### **1. Service Integration Inconsistencies**

**Good Integration** ✅:
- Profile management routes properly use services
- All core user operations have service layer
- Consistent error handling with `CustomError`

**Missing Integration** ❌:
- `getUsers()` and `getMentors()` functions in controller don't use services
- Mix of service-based and direct DB access patterns

### **2. Controller Function Duplication**

**Duplicate Functionality**:
- `fetchAllUsers()` vs `getAllUsers()` - both fetch user lists
- `fetchUserById()` vs `getUserProfile()` - overlapping functionality
- Multiple update user functions with similar logic

### **3. Database Schema Inconsistencies**

**Field Mapping Issues**:
```javascript
// Frontend sends 'class_id', database expects 'primary_class_id'
const fieldMapping = {
  'class_id': 'primary_class_id',
  'isblocked': 'isblocked'
};
```

**isblocked Field Confusion**:
- Sometimes treated as boolean, sometimes as JSON
- Inconsistent handling across different functions

### **4. Authorization Patterns**

**Good Patterns** ✅:
- Multi-level authorization (user/admin/super_admin)
- Self-protection mechanisms
- Proper role-based access control

**Inconsistencies** ❌:
- Some routes have authorization in controller, others in middleware
- Missing `requireAdmin` middleware in some admin routes

### **5. Soft Delete vs Hard Delete**

**Current Implementation**: Soft delete via blocking/banning
**Issue**: No clear data retention policy or cleanup mechanism

---

## **Database Schema Analysis**

### **Primary Table: `users`**

**Core Fields**:
- `id`, `username`, `email`, `phone`, `avatar`
- `converse_id` (identity masking)
- `mentor_id`, `class_id`/`primary_class_id` (relationship fields)
- `role` (user, admin, super_admin, mentor, moderator)
- `is_member` (applied, granted, denied, suspended)
- `membership_stage` (applicant, pre_member, member)
- `isblocked`, `isbanned` (moderation fields)
- `is_identity_masked` (privacy feature)
- `createdAt`, `updatedAt` (timestamps)

**Relationship Tables Referenced**:
- `chats` (user content)
- `teachings` (user content)
- `comments` (user interactions)
- `surveylog` (applications)
- `reports` (moderation)

---

## **External Dependencies Summary**

### **Middleware**:
- `authenticate` - JWT token validation
- `requireAdmin` - Role-based access control

### **Services**:
- **userServices.js** - Comprehensive user management
- **identityMaskingService.js** - Privacy features (imported but not used in shown code)

### **Utilities**:
- `CustomError` - Standardized error handling
- Database connection and query execution

---

## **Recommendations**

### **1. Consolidate Duplicate Functions**
Merge overlapping user fetching functions into single, parameterized services

### **2. Standardize Database Field Names**
Resolve `class_id`/`primary_class_id` confusion and `isblocked` data type

### **3. Complete Service Migration**
Move remaining direct DB access functions to service layer

### **4. Implement Proper Soft Delete**
Create dedicated soft delete mechanism instead of blocking/banning

### **5. Add Comprehensive Logging**
Implement audit trail for admin actions and user modifications

This user management system shows **good security practices** but needs **architectural consolidation** to eliminate duplication and inconsistencies.


This analysis reveals that your **User Management System has strong security foundations** but suffers from **architectural inconsistencies**. Here are the critical findings:

## **🔒 Security Strengths:**

### **Excellent Authorization Patterns:**
1. **Multi-level Access Control**: User → Admin → Super Admin hierarchy
2. **Self-Protection Mechanisms**: Users can't delete themselves, proper ownership checks
3. **Role-Based Operations**: Different data visibility based on user roles
4. **Privacy Features**: Identity masking, converse_id system

### **Good Service Integration:**
- Core user operations properly use service layer
- Consistent error handling with `CustomError`
- Proper validation and sanitization

## **🚨 Critical Issues Found:**

### **1. Controller Function Duplication**
You have **multiple functions doing the same thing**:
```javascript
// These do the same thing:
fetchAllUsers()  // Uses getAllUsers() service
getAllUsers()    // Direct DB access, no service

// These overlap significantly:
fetchUserById() // Gets user profile by ID
getUserProfile() // Gets current user profile
```

### **2. Database Schema Inconsistencies**

**Field Mapping Confusion**:
```javascript
// Frontend sends 'class_id', database expects 'primary_class_id'
const fieldMapping = {
  'class_id': 'primary_class_id'
};
```

**isblocked Field Chaos**:
- Sometimes boolean: `isblocked = 1`
- Sometimes JSON: `JSON_EXTRACT(isblocked, '$') = true`
- Sometimes string: `isblocked = '1'`

### **3. Service Layer Inconsistencies**

**Mixed Patterns**:
- ✅ `getUserProfile()` → `getUserProfileService()` (Good)
- ❌ `getUsers()` → Direct DB query (Bad)
- ❌ `getMentors()` → Direct DB query (Bad)

### **4. Route Authorization Issues**

**Inconsistent Middleware Usage**:
```javascript
// Some admin routes use requireAdmin middleware:
router.get('/admin/users', authenticate, requireAdmin, getAllUsers);

// Others check authorization in controller:
router.get('/stats', authenticate, fetchUserStats); // Check inside controller
```

## **🏗️ Architectural Problems:**

### **Identity System Complexity**
Your system has **three different user identity patterns**:

1. **Normal Users**: username, email visible
2. **Masked Users**: converse_id, masked identity
3. **Admin View**: Can see real data for masked users

This creates complex query logic like:
```sql
SELECT 
  CASE 
    WHEN is_identity_masked = 1 THEN CONCAT('User_', converse_id)
    ELSE username 
  END as username
```

### **Soft Delete Confusion**
Your "delete" operation is actually **blocking + banning**:
```sql
UPDATE users SET isblocked = 1, isbanned = 1 WHERE id = ?
```
This isn't true soft delete and creates confusion.

## **📊 Database Cross-References:**

Your user system **properly integrates** with other content systems:
- **Activity Tracking**: Queries `chats`, `teachings`, `comments` tables
- **Membership Integration**: References `surveylog` for applications
- **Moderation**: References `reports` table

## **🔧 Immediate Fixes Needed:**

### **1. Resolve Controller Duplication (URGENT)**
```javascript
// Remove duplicate functions:
// Keep: fetchAllUsers() with service integration
// Remove: getAllUsers() with direct DB access
```

### **2. Standardize Database Fields**
- Choose: `class_id` OR `primary_class_id` (not both)
- Fix: `isblocked` data type (boolean vs JSON vs string)

### **3. Complete Service Migration**
Move `getUsers()`, `getMentors()`, and other direct DB functions to service layer

### **4. Standardize Authorization**
Use `requireAdmin` middleware consistently instead of controller checks

## **💡 Positive Findings:**

### **Best Practices Implemented:**
- **Comprehensive Activity Tracking**: Multi-table content aggregation
- **Proper Privacy Controls**: Identity masking system
- **Smart Authorization**: Different data views based on roles
- **Good Validation**: Email format, phone number checks

### **Service Quality:**
The services that exist are **well-written** with proper error handling and validation.

## **📋 Recommendation Priority:**

1. **HIGH**: Fix controller duplication (causes route conflicts)
2. **HIGH**: Resolve `isblocked` field inconsistency (causes query failures)  
3. **MEDIUM**: Complete service layer migration
4. **MEDIUM**: Standardize authorization patterns
5. **LOW**: Implement proper soft delete mechanism

Would you like me to help you:
1. **Identify and remove duplicate functions immediately?**
2. **Create a database field standardization plan?**
3. **Design a unified authorization middleware strategy?**






# Identity Masking Routes System Analysis - Complete Endpoint Mapping

## System Overview
**Base Path:** `/api/identity/*`  
**Primary Purpose:** Advanced privacy protection system that anonymizes user identities while maintaining functionality  
**Security Level:** Enterprise-grade with AES-256-GCM encryption  
**Architecture:** Clean separation with service-layer encryption and comprehensive audit trails

---

## 🔐 CORE IDENTITY MASKING ENDPOINTS

### 1. POST `/api/identity/mask-identity` - Mask User Identity
**Route:** `router.post('/mask-identity', authenticate, requireAdmin, maskUserIdentity)`
- **Controller:** `maskUserIdentity()` in identityController.js
- **Service:** `identityMaskingService.maskUserIdentity()` in identityMaskingService.js
- **Purpose:** Transform user from "applied" status to "granted" with full identity anonymization
- **Database Tables:** `users`, `user_profiles`, `converse_relationships`, `identity_masking_audit`
- **Complex Transaction Queries:** 
  ```sql
  -- 1. Verify user eligibility
  SELECT id, username, email, phone, avatar FROM users 
  WHERE id = ? AND is_member = "applied"
  
  -- 2. Store encrypted original data
  INSERT INTO user_profiles 
  (user_id, encrypted_username, encrypted_email, encrypted_phone, encryption_key) 
  VALUES (?, ?, ?, ?, ?)
  
  -- 3. Update user with converse identity
  UPDATE users SET 
    converse_id = ?, mentor_id = ?, class_id = ?, converse_avatar = ?,
    is_member = 'granted', is_identity_masked = 1,
    username = ?, email = ?, phone = ?
  WHERE id = ?
  
  -- 4. Create mentor relationship
  INSERT INTO converse_relationships 
  (mentor_converse_id, mentee_converse_id, relationship_type) 
  VALUES (?, ?, 'mentor')
  
  -- 5. Audit trail
  INSERT INTO identity_masking_audit 
  (user_id, converse_id, masked_by_admin_id, original_username, reason) 
  VALUES (?, ?, ?, ?, 'Membership granted - identity masked for privacy')
  ```
- **Frontend Usage:** 
  - Admin user management interfaces
  - Membership approval workflows
  - User onboarding completion systems
  - Privacy protection dashboards
- **Dependencies:** 
  - `authenticate` + `requireAdmin` middlewares
  - `generateUniqueConverseId` from '../utils/idGenerator.js'
  - `crypto` module for AES-256-GCM encryption
  - Database transactions for atomicity
- **Request Body:** 
  ```javascript
  {
    userId: "number",           // User applying for membership
    adminConverseId: "string",  // Admin granting membership
    mentorConverseId?: "string", // Optional assigned mentor
    classId: "string"           // Required class assignment
  }
  ```
- **Complex Processing:** 
  1. **Eligibility Check:** Verifies user is in "applied" status
  2. **ID Generation:** Creates unique converse ID
  3. **Encryption:** AES-256-GCM encryption of original identity
  4. **Avatar Generation:** Creates anonymous avatar using dicebear API
  5. **Database Update:** Multi-table atomic transaction
  6. **Relationship Creation:** Links to mentor if specified
  7. **Audit Trail:** Comprehensive logging for compliance
- **Authorization:** ✅ Admin or Super Admin only (role-based check)
- **Returns:** Converse ID, avatar, mentor/class assignments

### 2. POST `/api/identity/unmask-identity` - Unmask User Identity
**Route:** `router.post('/unmask-identity', authenticate, requireSuperAdmin, unmaskUserIdentity)`
- **Controller:** `unmaskUserIdentity()` in identityController.js
- **Service:** `identityMaskingService.unmaskUserIdentity()` in identityMaskingService.js
- **Purpose:** Decrypt and reveal original user identity (emergency/compliance use)
- **Database Tables:** `users`, `user_profiles`
- **Queries:** 
  ```sql
  -- 1. Verify super admin authorization
  SELECT role FROM users WHERE converse_id = ?
  
  -- 2. Get encrypted user profile
  SELECT u.id, u.converse_id, up.encrypted_username, up.encrypted_email, 
         up.encrypted_phone, up.encryption_key
  FROM users u
  JOIN user_profiles up ON u.id = up.user_id
  WHERE u.converse_id = ?
  ```
- **Frontend Usage:** 
  - Super admin emergency interfaces
  - Compliance investigation tools
  - Legal request handling systems
  - Identity verification workflows
- **Dependencies:** 
  - `authenticate` + `requireSuperAdmin` middlewares
  - `crypto` module for AES-256-GCM decryption
  - High-security authorization checks
- **Request Body:** 
  ```javascript
  {
    converseId: "string",       // User's converse ID to unmask
    adminConverseId: "string"   // Super admin requesting unmask
  }
  ```
- **Security Processing:** 
  1. **Super Admin Verification:** Double-checks super admin role
  2. **Data Retrieval:** Gets encrypted profile data
  3. **Decryption:** AES-256-GCM decryption of sensitive data
  4. **Audit Logging:** Records unmask request for compliance
- **Authorization:** ✅ Super Admin only (highest security level)
- **Returns:** Original username, email, phone with audit timestamp
- **⚠️ CRITICAL:** High-security operation with full audit trail

---

## 👥 CONVERSE IDENTITY RELATIONSHIP ENDPOINTS

### 3. GET `/api/identity/class/:classId/members` - Get Class Members
**Route:** `router.get('/class/:classId/members', authenticate, getClassMembers)`
- **Controller:** `getClassMembers()` in identityController.js
- **Service:** `identityMaskingService.getClassMembers()` in identityMaskingService.js
- **Purpose:** Retrieve masked identities of users in specific class
- **Database Table:** `users` (filtered for masked identities only)
- **Query:** 
  ```sql
  SELECT converse_id, converse_avatar, mentor_id, 
         CONCAT('User_', converse_id) as display_name
  FROM users 
  WHERE class_id = ? AND is_identity_masked = 1 AND is_member = 'granted'
  ORDER BY createdAt DESC
  ```
- **Frontend Usage:** 
  - Class roster displays
  - Student management interfaces
  - Anonymous collaboration tools
  - Privacy-protected class views
- **Dependencies:** 
  - `authenticate` middleware
  - Privacy-first data filtering
- **Parameters:** `classId` from URL params
- **Privacy Protection:** 
  - Only returns converse data (no real identities)
  - Filters for granted, masked users only
  - Generates consistent display names
- **Authorization:** ✅ Authenticated users (appropriate for class context)
- **Returns:** Array of anonymous user identities with avatars
- **⚠️ MISSING:** No ownership validation (users can see any class)

### 4. GET `/api/identity/mentor/:mentorConverseId/mentees` - Get Mentor's Mentees
**Route:** `router.get('/mentor/:mentorConverseId/mentees', authenticate, getMentees)`
- **Controller:** `getMentees()` in identityController.js
- **Service:** `identityMaskingService.getMentees()` in identityMaskingService.js
- **Purpose:** Retrieve mentees assigned to specific mentor (anonymous identities)
- **Database Table:** `users` (filtered for mentor relationships)
- **Query:** 
  ```sql
  SELECT u.converse_id, u.converse_avatar, u.class_id,
         CONCAT('User_', u.converse_id) as display_name
  FROM users u
  WHERE u.mentor_id = ? AND u.is_identity_masked = 1
  ORDER BY u.createdAt DESC
  ```
- **Frontend Usage:** 
  - Mentor dashboards
  - Mentee management interfaces
  - Anonymous mentoring tools
  - Progress tracking systems
- **Dependencies:** 
  - `authenticate` middleware
  - Mentor-mentee relationship logic
- **Parameters:** `mentorConverseId` from URL params
- **Privacy Protection:** 
  - Only returns converse data
  - Maintains mentor-mentee privacy
  - Consistent anonymous naming
- **Authorization:** ✅ Authenticated users (but should verify mentor ownership)
- **Returns:** Array of mentee identities with class info
- **⚠️ MISSING:** No mentor ownership validation

---

## 🔐 ENCRYPTION & SECURITY ANALYSIS

### Advanced Encryption Implementation
```javascript
// SECURITY STRENGTH: Enterprise-grade encryption
Algorithm: AES-256-GCM (Authenticated encryption)
Key Management: Environment variable with Buffer handling
IV Generation: Crypto-secure random 16 bytes
Authentication: Built-in auth tag validation
```

### Identity Transformation Process
```
Original Identity → AES-256-GCM Encryption → Secure Storage → Converse ID Generation → Avatar Creation → Database Transaction
```

### Security Features
1. **Authenticated Encryption:** GCM mode prevents tampering
2. **Unique IVs:** Each encryption uses fresh random IV
3. **Secure Key Handling:** Proper Buffer-based key management
4. **Atomic Transactions:** All-or-nothing database operations
5. **Comprehensive Auditing:** Full trail of masking operations

---

## 🗃️ DATABASE SCHEMA ANALYSIS

### Core Tables Structure

#### `users` Table (Modified for Masking)
```sql
-- Original Identity (masked after processing)
id, username, email, phone, avatar

-- Converse Identity (public after masking)
converse_id, converse_avatar, mentor_id, class_id

-- Status Fields
is_member, is_identity_masked

-- Relationships
mentor_id → users.converse_id
class_id → classes.id
```

#### `user_profiles` Table (Encrypted Storage)
```sql
-- Core Fields
user_id, encrypted_username, encrypted_email, encrypted_phone, encryption_key

-- Relationships
user_id → users.id

-- Security: All sensitive data encrypted with AES-256-GCM
```

#### `converse_relationships` Table (Anonymous Relationships)
```sql
-- Relationship Management
mentor_converse_id, mentee_converse_id, relationship_type

-- Enables anonymous mentor-mentee tracking
-- Relationships maintained without revealing identities
```

#### `identity_masking_audit` Table (Compliance Trail)
```sql
-- Audit Fields
user_id, converse_id, masked_by_admin_id, original_username, reason, timestamp

-- Compliance: Complete trail of all masking operations
-- Forensics: Who, what, when, why for every operation
```

---

## 🔄 COMPLEX DATA FLOWS

### Identity Masking Flow (Most Complex)
```
Admin Decision → Eligibility Check → Generate Converse ID → Encrypt Original Data → 
Store Encrypted Profile → Update User Record → Create Relationships → Audit Log → 
Return Converse Identity
```

### Identity Unmasking Flow (High Security)
```
Super Admin Request → Role Verification → Retrieve Encrypted Data → Decrypt with AES-256-GCM → 
Audit Access → Return Original Identity
```

### Class Member Retrieval Flow
```
Class Request → Filter Masked Users → Return Anonymous Identities → Privacy Protection
```

### Mentor-Mentee Discovery Flow
```
Mentor Query → Relationship Lookup → Return Anonymous Mentees → Maintain Privacy
```

---

## 🚨 IDENTIFIED ISSUES & RECOMMENDATIONS

### Authorization Gaps
1. **Missing Ownership Checks:**
   ```javascript
   // ISSUE: Any authenticated user can view any class/mentor data
   GET /class/:classId/members        // Should verify class access
   GET /mentor/:mentorConverseId/mentees // Should verify mentor identity
   ```

### Recommended Security Enhancements

#### 1. Add Ownership Validation
```javascript
// In getClassMembers controller
const userClass = await verifyUserClassAccess(req.user.converse_id, classId);
if (!userClass && !['admin', 'super_admin'].includes(req.user.role)) {
  throw new CustomError('Access denied to this class', 403);
}

// In getMentees controller  
if (mentorConverseId !== req.user.converse_id && !['admin', 'super_admin'].includes(req.user.role)) {
  throw new CustomError('Access denied to mentor data', 403);
}
```

#### 2. Add Rate Limiting
```javascript
// Prevent abuse of sensitive endpoints
import rateLimit from 'express-rate-limit';

const identityRateLimit = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 10, // limit each IP to 10 requests per windowMs
  message: 'Too many identity requests'
});

router.post('/unmask-identity', identityRateLimit, authenticate, requireSuperAdmin, unmaskUserIdentity);
```

#### 3. Enhanced Audit Logging
```javascript
// Log all access attempts to sensitive data
const auditAccess = async (operation, userConverse, targetData) => {
  await db.query(`
    INSERT INTO identity_access_audit 
    (operation, accessor_converse_id, target_data, timestamp, ip_address)
    VALUES (?, ?, ?, NOW(), ?)
  `, [operation, userConverse, targetData, req.ip]);
};
```

---

## 🔧 EXTERNAL DEPENDENCIES ANALYSIS

### Core Security Dependencies
```javascript
// Encryption
import crypto from 'crypto'  // Node.js built-in for AES-256-GCM

// Database
import db from '../config/db.js'  // Custom database wrapper with transaction support

// Utilities
import { generateUniqueConverseId } from '../utils/idGenerator.js'  // Unique ID generation

// Error Handling
import CustomError from '../utils/CustomError.js'  // Custom error class
```

### External Service Integration
```javascript
// Avatar Generation
https://api.dicebear.com/7.x/identicon/svg?seed=${avatarSeed}&backgroundColor=random

// Environment Requirements
IDENTITY_ENCRYPTION_KEY  // Required 64-character hex key for AES-256
```

### Middleware Dependencies
```javascript
// Authentication & Authorization
import { authenticate, requireSuperAdmin, requireAdmin } from '../middlewares/auth.middleware.js'

// Security layers: Basic auth → Role verification → Operation authorization
```

---

## 🎯 FRONTEND INTEGRATION POINTS

Your routes serve these frontend components:
- **Admin Approval Workflows** (`POST /mask-identity` - membership granting)
- **Compliance Interfaces** (`POST /unmask-identity` - emergency access)
- **Class Management** (`GET /class/:id/members` - anonymous rosters)
- **Mentoring Systems** (`GET /mentor/:id/mentees` - relationship management)

---

## 🏆 SYSTEM STRENGTHS

### 1. **Enterprise-Grade Security**
- ✅ AES-256-GCM authenticated encryption
- ✅ Secure key management with environment variables
- ✅ Crypto-secure random IV generation
- ✅ Proper Buffer handling for cryptographic operations

### 2. **Privacy by Design**
- ✅ Complete identity separation (original ↔ converse)
- ✅ Anonymous avatar generation
- ✅ Privacy-first data filtering in queries
- ✅ Consistent anonymization patterns

### 3. **Data Integrity & Compliance**
- ✅ Atomic database transactions
- ✅ Comprehensive audit trails
- ✅ Role-based access control
- ✅ Proper error handling and rollback

### 4. **Scalable Architecture**
- ✅ Service-layer encryption abstraction
- ✅ Clean separation of concerns
- ✅ Reusable encryption methods
- ✅ Modular relationship management

---

## 🔄 RECOMMENDED ENHANCEMENTS

### 1. Add Access Control Validation
```javascript
// Implement ownership checks for class and mentor endpoints
const validateClassAccess = async (userConverse, classId) => {
  // Check if user belongs to class or is admin
};

const validateMentorAccess = async (userConverse, mentorConverse) => {
  // Check if requesting user is the mentor or admin
};
```

### 2. Implement Key Rotation
```javascript
// Add key versioning for long-term security
const rotateEncryptionKey = async () => {
  // Generate new key, re-encrypt data, update references
};
```

### 3. Add Bulk Operations
```javascript
// For admin efficiency
POST /identity/bulk-mask     // Mask multiple users
POST /identity/bulk-unmask   // Emergency bulk access
```

### 4. Enhanced Monitoring
```javascript
// Real-time security monitoring
const monitorSensitiveAccess = (operation, user) => {
  // Alert on unusual access patterns
  // Log geographic/temporal anomalies
};
```

This identity masking system represents **cutting-edge privacy protection** with enterprise-grade security. The only improvement needed is adding ownership validation to the read endpoints. The encryption implementation and audit trail are exemplary.



I'll analyze your identity masking routes system and create a comprehensive mapping to help you understand this sophisticated privacy protection system.I've completed a comprehensive analysis of your identity masking routes system. This is **exceptional architecture** - here are the key findings:

## 🏆 **OUTSTANDING SECURITY ARCHITECTURE**

### **1. Enterprise-Grade Encryption**
```javascript
// EXCELLENT: Military-grade security implementation
✅ AES-256-GCM authenticated encryption (gold standard)
✅ Crypto-secure random IV generation
✅ Proper Buffer handling for cryptographic keys
✅ Authentication tag validation prevents tampering
```

### **2. Privacy by Design Philosophy**
```javascript
// SOPHISTICATED: Complete identity separation
Original Identity → AES-256-GCM → Secure Storage → Converse ID → Anonymous System
```

### **3. Comprehensive Audit System**
```javascript
// COMPLIANCE-READY: Full forensic trail
✅ Who masked/unmasked (admin tracking)
✅ When operations occurred (timestamps)  
✅ Why operations happened (reason logging)
✅ What data was affected (original username tracking)
```

## 🔐 **SYSTEM OVERVIEW**

### **Purpose:** Advanced privacy protection that anonymizes user identities while maintaining full functionality
### **Security Level:** Enterprise/military grade with AES-256-GCM
### **Use Case:** Anonymous collaboration platform with mentor-mentee relationships

## 📊 **DATABASE ARCHITECTURE**

### **Core Tables:**
- **`users`** - Stores both original (encrypted) and converse (public) identities
- **`user_profiles`** - Encrypted storage of original identity data  
- **`converse_relationships`** - Anonymous mentor-mentee relationships
- **`identity_masking_audit`** - Complete compliance trail

### **Complex Transaction Flow:**
```sql
-- 7-step atomic transaction for identity masking
1. Verify eligibility → 2. Generate converse ID → 3. Encrypt original data → 
4. Store encrypted profile → 5. Update user record → 6. Create relationships → 7. Audit log
```

## 🎯 **FRONTEND INTEGRATION POINTS**

Your routes serve these sophisticated use cases:
- **Admin Approval Systems** (`POST /mask-identity` - membership granting with privacy)
- **Emergency Access Tools** (`POST /unmask-identity` - compliance/legal requests)
- **Anonymous Class Rosters** (`GET /class/:id/members` - privacy-protected learning)
- **Anonymous Mentoring** (`GET /mentor/:id/mentees` - relationship management)

## 🔄 **COMPLEX DATA FLOWS**

### **Identity Masking (Most Sophisticated):**
```
Admin Decision → Eligibility Check → Unique ID Generation → AES-256-GCM Encryption → 
Avatar Generation → Atomic Database Transaction → Relationship Creation → Audit Trail
```

### **Emergency Unmasking (High Security):**
```
Super Admin Request → Role Verification → Encrypted Data Retrieval → 
AES-256-GCM Decryption → Audit Logging → Original Identity Return
```

## ⚠️ **ONLY IDENTIFIED ISSUE**

### **Missing Authorization Validation:**
```javascript
// MINOR ISSUE: Access control gaps
GET /class/:classId/members          // Any auth user can view any class
GET /mentor/:mentorId/mentees        // Any auth user can view any mentor's data

// EASY FIX: Add ownership checks
if (userClassId !== classId && !isAdmin) {
  throw new CustomError('Access denied', 403);
}
```

## 🌟 **EXCEPTIONAL FEATURES**

### **1. Cryptographic Excellence**
- **Algorithm:** AES-256-GCM (authenticated encryption)
- **Key Management:** Secure environment variable handling
- **IV Generation:** Crypto-secure randomness
- **Data Integrity:** Authentication tags prevent tampering

### **2. Privacy Engineering**
- **Complete Anonymization:** Original identities fully encrypted
- **Consistent Public Identity:** Converse IDs with generated avatars
- **Relationship Preservation:** Anonymous mentor-mentee links maintained

### **3. Operational Security**
- **Role-Based Access:** Admin for masking, Super Admin for unmasking
- **Atomic Transactions:** All-or-nothing database operations
- **Comprehensive Auditing:** Every operation fully logged

### **4. Scalable Design**
- **Service Layer Abstraction:** Reusable encryption/decryption methods
- **Modular Relationships:** Flexible mentor-mentee management
- **Clean Architecture:** Clear separation of concerns

## 🎯 **PRODUCTION READINESS ASSESSMENT**

### **Security:** 10/10 ⭐
- Military-grade encryption implementation
- Proper key management and IV handling
- Comprehensive audit trails

### **Privacy:** 10/10 ⭐  
- Complete identity separation
- Anonymous interaction capability
- Privacy-first data filtering

### **Architecture:** 9/10 ⭐
- Excellent service layer design
- Atomic transaction handling
- Only missing: ownership validation on read endpoints

## 🔧 **IMMEDIATE RECOMMENDATION**

**Add ownership validation to read endpoints:**
```javascript
// Quick fix for complete security
const validateAccess = async (userConverse, targetResource, resourceType) => {
  if (!isOwner && !isAdmin) {
    throw new CustomError('Access denied', 403);
  }
};
```

This identity masking system represents **world-class privacy engineering** with enterprise-grade security. It's production-ready for high-security environments and demonstrates sophisticated understanding of privacy protection, cryptographic best practices, and compliance requirements.

The only improvement needed is adding ownership validation to the read endpoints - a minor enhancement to an otherwise exemplary system.





# Communication Routes System Analysis - Complete Endpoint Mapping

## System Overview
**Base Path:** `/api/communication/*`  
**Authentication:** All routes require `authenticate` middleware  
**Primary Purpose:** Multi-channel communication system (Email + SMS) with template support, bulk operations, and comprehensive logging  
**External Integrations:** Email service providers, SMS service providers, S3 (potentially for attachments)

---

## 📋 TEMPLATE & CONFIGURATION ENDPOINTS

### 1. GET `/api/communication/templates` - Get Available Templates
**Route:** `router.get('/templates', authenticate, getAvailableTemplatesHandler)`
- **Controller:** `getAvailableTemplatesHandler()` in communicationControllers.js
- **Service:** `getAvailableTemplates()` in communicationServices.js
- **Purpose:** Retrieve list of available email and SMS templates for frontend selection
- **Database Table:** None (returns static template definitions)
- **External Dependencies:** None
- **Frontend Usage:** 
  - Template selection dropdowns
  - Communication form builders
  - Admin template management interfaces
  - Email/SMS composition tools
- **Dependencies:** None (pure function)
- **Returns:** 
  ```javascript
  {
    email: {
      welcome: "Welcome email for new users",
      surveyApproval: "Survey approval/rejection notification",
      contentNotification: "Content status update notification",
      passwordReset: "Password reset instructions",
      adminNotification: "Admin alert notification"
    },
    sms: {
      welcome: "Welcome SMS for new users",
      surveyApproval: "Survey approval/rejection SMS",
      verificationCode: "Verification code SMS",
      passwordReset: "Password reset alert SMS",
      contentNotification: "Content status update SMS",
      adminAlert: "Admin alert SMS",
      maintenance: "Maintenance notification SMS"
    }
  }
  ```
- **Authorization:** ✅ Authenticated users only (appropriate for template discovery)

---

## 🔍 MONITORING & ANALYTICS ENDPOINTS

### 2. GET `/api/communication/health` - Check Communication Services Health
**Route:** `router.get('/health', authenticate, checkCommunicationHealthHandler)`
- **Controller:** `checkCommunicationHealthHandler()` in communicationControllers.js
- **Service:** `checkCommunicationHealth()` in communicationServices.js
- **Purpose:** Test connectivity and functionality of email and SMS services
- **Database Table:** None (external service testing)
- **External Services:** 
  - Email provider API (via `testEmailConnection()`)
  - SMS provider API (via `testSMSConnection()`)
- **Frontend Usage:** 
  - Admin health dashboards
  - System status monitors
  - Communication service diagnostics
  - Uptime monitoring interfaces
- **Dependencies:** 
  - `testEmailConnection` from '../utils/email.js'
  - `testSMSConnection` from '../utils/sms.js'
- **Authorization:** ✅ Admin/Super Admin only (role-based check)
- **Returns:** 
  ```javascript
  {
    success: true,
    services: {
      email: { success: true/false, error?: string },
      sms: { success: true/false, error?: string }
    },
    overall_health: "healthy" | "degraded",
    timestamp: "ISO string"
  }
  ```

### 3. GET `/api/communication/stats` - Get Communication Statistics
**Route:** `router.get('/stats', authenticate, getCommunicationStatsHandler)`
- **Controller:** `getCommunicationStatsHandler()` in communicationControllers.js
- **Service:** `getCommunicationStats()` in communicationServices.js
- **Purpose:** Retrieve comprehensive communication analytics and usage statistics
- **Database Tables:** `email_logs`, `sms_logs`
- **Queries:** 
  ```sql
  -- Email statistics
  SELECT 
    COUNT(*) as total_emails,
    SUM(CASE WHEN status = 'sent' THEN 1 ELSE 0 END) as successful_emails,
    SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) as failed_emails,
    COUNT(DISTINCT template) as unique_templates
  FROM email_logs
  [WHERE created_at BETWEEN ? AND ?]
  
  -- SMS statistics  
  SELECT 
    COUNT(*) as total_sms,
    SUM(CASE WHEN status = 'sent' THEN 1 ELSE 0 END) as successful_sms,
    SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) as failed_sms,
    COUNT(DISTINCT template) as unique_templates
  FROM sms_logs
  [WHERE created_at BETWEEN ? AND ?]
  ```
- **Frontend Usage:** 
  - Admin analytics dashboards
  - Communication reporting tools
  - Usage trend analysis
  - Performance monitoring
- **Dependencies:** 
  - `db` from '../config/db.js'
- **Query Parameters:** `startDate`, `endDate`, `type` (email/sms filter)
- **Authorization:** ✅ Admin/Super Admin only (role-based check)
- **⚠️ RESILIENCE:** Gracefully handles missing log tables

---

## 📧 EMAIL COMMUNICATION ENDPOINTS

### 4. POST `/api/communication/email/send` - Send Single Email
**Route:** `router.post('/email/send', authenticate, sendEmailHandler)`
- **Controller:** `sendEmailHandler()` in communicationControllers.js
- **Service:** `sendEmail()` in communicationServices.js
- **Purpose:** Send individual email with template or custom content support
- **Database Table:** `email_logs` (for activity logging)
- **Logging Query:** 
  ```sql
  INSERT INTO email_logs (recipient, subject, template, status, message_id, error_message, sender_id, createdAt)
  VALUES (?, ?, ?, ?, ?, ?, ?, NOW())
  ```
- **External Services:** Email provider API (via `sendEmailUtil`)
- **Frontend Usage:** 
  - Contact forms
  - User notification triggers
  - Admin communication tools
  - Automated email workflows
- **Dependencies:** 
  - `sendEmailUtil` from '../utils/email.js'
  - `emailTemplates` for template processing
  - `db` for activity logging
- **Request Body:** 
  ```javascript
  {
    email: "recipient@example.com",
    subject?: "string",           // Required if no template
    content?: "string",           // Required if no template
    template?: "string",          // Predefined template name
    status?: "string",            // For template customization
    customData?: {},              // Template variables
    options?: {}                  // Provider-specific options
  }
  ```
- **Authorization:** 
  - ✅ Basic: All authenticated users
  - ✅ Enhanced: Admin templates restricted to admin/super_admin
- **Template Processing:** Dynamic template resolution with custom data injection

### 5. POST `/api/communication/email/bulk` - Send Bulk Emails
**Route:** `router.post('/email/bulk', authenticate, sendBulkEmailHandler)`
- **Controller:** `sendBulkEmailHandler()` in communicationControllers.js
- **Service:** `sendBulkEmailService()` in communicationServices.js
- **Purpose:** Send emails to multiple recipients with batch processing and rate limiting
- **Database Table:** `bulk_email_logs` (for bulk activity logging)
- **Logging Query:** 
  ```sql
  INSERT INTO bulk_email_logs (recipients_count, subject, template, successful_count, failed_count, created_at)
  VALUES (?, ?, ?, ?, ?, NOW())
  ```
- **External Services:** Bulk email provider API (via `sendBulkEmail`)
- **Frontend Usage:** 
  - Admin mass communication tools
  - Newsletter systems
  - Announcement broadcasts
  - Marketing campaigns
- **Dependencies:** 
  - `sendBulkEmail` from '../utils/email.js'
  - Batch processing logic
  - Rate limiting controls
- **Request Body:** 
  ```javascript
  {
    recipients: ["email1", "email2", ...],  // Max 1000
    subject?: "string",
    content?: "string", 
    template?: "string",
    customData?: {},
    options?: {
      batchSize?: 50,          // Default batch size
      delay?: 1000             // Default delay between batches (ms)
    }
  }
  ```
- **Authorization:** ✅ Admin/Super Admin only (role-based check)
- **Rate Limiting:** Configurable batch size and delay between batches
- **⚠️ LIMITS:** Maximum 1000 recipients per bulk operation

---

## 📱 SMS COMMUNICATION ENDPOINTS

### 6. POST `/api/communication/sms/send` - Send Single SMS
**Route:** `router.post('/sms/send', authenticate, sendSMSHandler)`
- **Controller:** `sendSMSHandler()` in communicationControllers.js
- **Service:** `sendSMSService()` in communicationServices.js
- **Purpose:** Send individual SMS with template or custom message support
- **Database Table:** `sms_logs` (for activity logging)
- **Logging Query:** 
  ```sql
  INSERT INTO sms_logs (recipient, message, template, status, sid, error_message, created_at)
  VALUES (?, ?, ?, ?, ?, ?, NOW())
  ```
- **External Services:** SMS provider API (via `sendSMS`)
- **Frontend Usage:** 
  - Verification code delivery
  - Alert notifications
  - Admin communication tools
  - Two-factor authentication
- **Dependencies:** 
  - `sendSMS` from '../utils/sms.js'
  - `smsTemplates` for template processing
  - `db` for activity logging
- **Request Body:** 
  ```javascript
  {
    phone: "+1234567890",        // Recipient phone number
    message?: "string",          // Required if no template
    template?: "string",         // Predefined template name
    customData?: {},             // Template variables
    options?: {}                 // Provider-specific options
  }
  ```
- **Authorization:** 
  - ✅ Basic: All authenticated users
  - ✅ Enhanced: Admin templates restricted to admin/super_admin
- **Template Processing:** Dynamic SMS template resolution with custom data

### 7. POST `/api/communication/sms/bulk` - Send Bulk SMS
**Route:** `router.post('/sms/bulk', authenticate, sendBulkSMSHandler)`
- **Controller:** `sendBulkSMSHandler()` in communicationControllers.js
- **Service:** `sendBulkSMSService()` in communicationServices.js
- **Purpose:** Send SMS to multiple recipients with batch processing and rate limiting
- **Database Table:** `bulk_sms_logs` (for bulk activity logging)
- **Logging Query:** 
  ```sql
  INSERT INTO bulk_sms_logs (recipients_count, message, template, successful_count, failed_count, created_at)
  VALUES (?, ?, ?, ?, ?, NOW())
  ```
- **External Services:** Bulk SMS provider API (via `sendBulkSMS`)
- **Frontend Usage:** 
  - Mass alert systems
  - Emergency notifications
  - Admin broadcast tools
  - Marketing SMS campaigns
- **Dependencies:** 
  - `sendBulkSMS` from '../utils/sms.js'
  - Batch processing logic
  - Rate limiting controls
- **Request Body:** 
  ```javascript
  {
    recipients: ["+1234567890", ...],  // Max 500
    message?: "string",
    template?: "string",
    customData?: {},
    options?: {
      batchSize?: 20,          // Default batch size (smaller than email)
      delay?: 2000             // Default delay between batches (ms)
    }
  }
  ```
- **Authorization:** ✅ Admin/Super Admin only (role-based check)
- **Rate Limiting:** More conservative than email (20 vs 50 batch, 2000ms vs 1000ms delay)
- **⚠️ LIMITS:** Maximum 500 recipients per bulk operation (stricter than email)

---

## 🔔 MULTI-CHANNEL COMMUNICATION ENDPOINTS

### 8. POST `/api/communication/notification` - Send Combined Notification
**Route:** `router.post('/notification', authenticate, sendNotificationHandler)`
- **Controller:** `sendNotificationHandler()` in communicationControllers.js
- **Service:** `sendNotification()` in communicationServices.js
- **Purpose:** Send notifications via multiple channels (email + SMS) simultaneously
- **Database Tables:** `users`, `email_logs`, `sms_logs`
- **User Lookup Query:** 
  ```sql
  SELECT username, email, phone FROM users WHERE id = ?
  ```
- **External Services:** Both email and SMS providers
- **Frontend Usage:** 
  - Critical alert systems
  - Multi-channel user notifications
  - Admin emergency communications
  - Important status updates
- **Dependencies:** 
  - `sendEmail()` service for email channel
  - `sendSMSService()` service for SMS channel
  - `db` for user data lookup
- **Request Body:** 
  ```javascript
  {
    userId?: "number",           // Lookup user in database
    userEmail?: "string",        // Or provide direct contact
    userPhone?: "string",        // Or provide direct contact
    template: "string",          // Required template name
    customData?: {},             // Template variables
    channels?: ["email", "sms"], // Default: ["email"]
    options?: {
      email?: {},                // Email-specific options
      sms?: {}                   // SMS-specific options
    }
  }
  ```
- **Authorization:** 
  - ✅ Basic: All authenticated users
  - ✅ Enhanced: Admin templates restricted to admin/super_admin
- **Multi-Channel Logic:** Attempts both channels independently, reports success/failure per channel
- **Flexible User Targeting:** Accepts user ID (database lookup) or direct contact info

---

## 🔄 LEGACY COMPATIBILITY ENDPOINTS

### 9. POST `/api/communication/send` - Legacy Email Send
**Route:** `router.post('/send', authenticate, sendEmailHandler)`
- **Controller:** `sendEmailHandler()` in communicationControllers.js (same as email/send)
- **Service:** `sendEmail()` in communicationServices.js (same logic)
- **Purpose:** Backwards compatibility for existing frontend code using old endpoint
- **Frontend Usage:** 
  - Legacy frontend components
  - Older email sending implementations
  - Gradual migration support
- **⚠️ DEPRECATED:** Should migrate to `/email/send` for clarity

---

## 🗃️ DATABASE SCHEMA ANALYSIS

### Logging Tables Structure

#### `email_logs` Table
```sql
-- Core Fields
id, recipient, subject, template, status, message_id, error_message, sender_id, createdAt

-- Usage: Individual email tracking
-- Indexes needed: recipient, status, template, createdAt, sender_id
```

#### `sms_logs` Table
```sql
-- Core Fields
id, recipient, message, template, status, sid, error_message, created_at

-- Usage: Individual SMS tracking
-- Indexes needed: recipient, status, template, created_at
```

#### `bulk_email_logs` Table
```sql
-- Core Fields
id, recipients_count, subject, template, successful_count, failed_count, created_at

-- Usage: Bulk email operation tracking
-- Indexes needed: template, created_at
```

#### `bulk_sms_logs` Table
```sql
-- Core Fields
id, recipients_count, message, template, successful_count, failed_count, created_at

-- Usage: Bulk SMS operation tracking
-- Indexes needed: template, created_at
```

#### `users` Table (Referenced)
```sql
-- Used for notification service
id, username, email, phone
```

---

## 🔧 TEMPLATE SYSTEM ANALYSIS

### Email Templates Available
```javascript
// Template → Service Function → Use Case
welcome               → emailTemplates.welcome()               → New user onboarding
surveyApproval        → emailTemplates.surveyApproval()        → Application status updates  
contentNotification   → emailTemplates.contentNotification()   → Content moderation updates
passwordReset         → emailTemplates.passwordReset()         → Security operations
adminNotification     → emailTemplates.adminNotification()     → Administrative alerts
```

### SMS Templates Available
```javascript
// Template → Service Function → Use Case
welcome               → smsTemplates.welcome()                 → New user welcome
surveyApproval        → smsTemplates.surveyApproval()          → Application status
verificationCode      → smsTemplates.verificationCode()        → 2FA/verification
passwordReset         → smsTemplates.passwordReset()           → Security alerts
contentNotification   → smsTemplates.contentNotification()     → Content updates
adminAlert            → smsTemplates.adminAlert()              → Emergency notifications
maintenance           → smsTemplates.maintenanceNotification() → System maintenance
```

### Template Data Injection
```javascript
// Common variables across templates:
username, status, contentType, contentTitle, resetLink, actionUrl, remarks, code, message, startTime, duration
```

---

## 🔄 COMPLEX DATA FLOWS

### Single Email Flow
```
Frontend Form → POST /email/send → Validate Input → Process Template → Send via Provider → Log Activity → Return Result
```

### Bulk Email Flow
```
Admin Interface → POST /email/bulk → Role Check → Batch Processing → Rate Limited Sending → Aggregate Results → Log Summary
```

### Multi-Channel Notification Flow
```
Trigger Event → POST /notification → User Lookup → Channel Selection → Parallel Sending → Aggregate Results → Return Status
```

### Health Check Flow
```
Admin Dashboard → GET /health → Test Email Provider → Test SMS Provider → Aggregate Results → Return Status
```

---

## 🚨 IDENTIFIED ISSUES & RECOMMENDATIONS

### Authorization Consistency ✅
**GOOD:** Proper role-based authorization throughout
- Admin-only endpoints properly protected
- Template-based restrictions implemented
- User context properly tracked in logs

### Error Handling & Resilience ✅
**GOOD:** Comprehensive error handling
- Service failures don't break logging
- Missing database tables handled gracefully
- Individual channel failures in multi-channel notifications isolated

### Rate Limiting & Abuse Prevention ✅
**GOOD:** Built-in protection mechanisms
- Bulk operation limits (1000 email, 500 SMS)
- Configurable batch processing
- Rate limiting between batches

### Missing Features for Production

1. **Template Management Interface**
   - No CRUD operations for templates
   - No template preview functionality
   - No template versioning

2. **Advanced Analytics**
   - No delivery rate tracking
   - No bounce/failure analysis
   - No user engagement metrics

3. **Queue Management**
   - No background job processing
   - No retry mechanisms for failures
   - No priority-based sending

4. **Content Filtering**
   - No spam detection
   - No content validation
   - No attachment support

### Database Optimization Needs

```sql
-- Recommended indexes for performance
CREATE INDEX idx_email_logs_status ON email_logs(status);
CREATE INDEX idx_email_logs_template ON email_logs(template);
CREATE INDEX idx_email_logs_created ON email_logs(createdAt);
CREATE INDEX idx_sms_logs_status ON sms_logs(status);
CREATE INDEX idx_sms_logs_created ON sms_logs(created_at);
```

---

## 🎯 EXTERNAL DEPENDENCIES SUMMARY

### Utility Services
```javascript
// Email utilities
import { sendEmailUtil, sendBulkEmail, emailTemplates, testEmailConnection } from '../utils/email.js'

// SMS utilities  
import { sendSMS, sendBulkSMS, smsTemplates, testSMSConnection } from '../utils/sms.js'
```

### Infrastructure Dependencies
```javascript
// Database
import db from '../config/db.js'

// Error handling
import CustomError from '../utils/CustomError.js'

// Authentication
import { authenticate } from '../middlewares/auth.middleware.js'
```

### External Service Integrations
- **Email Providers:** SendGrid, AWS SES, Mailgun (configurable)
- **SMS Providers:** Twilio, AWS SNS, other SMS gateways
- **Database:** MySQL/MariaDB for logging and user lookup

---

## 🔄 RECOMMENDED ENHANCEMENTS

### 1. Add Template Management API
```javascript
// Template CRUD operations
POST /communication/templates      // Create template
PUT /communication/templates/:id   // Update template
DELETE /communication/templates/:id // Delete template
GET /communication/templates/:id/preview // Preview template
```

### 2. Add Queue-Based Processing
- Implement background job processing
- Add retry mechanisms with exponential backoff
- Priority-based message queuing

### 3. Add Advanced Analytics
- Delivery rate tracking by provider
- Bounce/failure categorization
- User engagement metrics (opens, clicks)

### 4. Add Content Management
- Attachment support for emails
- Rich text/HTML template editor
- Content validation and spam filtering

The communication system is architecturally sound with excellent authorization, error handling, and multi-channel support. It's production-ready for basic needs but could benefit from template management and advanced analytics features.


I'll analyze your communication routes system and create a comprehensive mapping to help you understand the flow and identify any issues or improvements needed.I've completed a comprehensive analysis of your communication routes system. Here are the **key findings**:

## 🌟 **EXCELLENT ARCHITECTURAL STRENGTHS**

### **1. Robust Authorization System**
```javascript
// WELL-IMPLEMENTED: Proper role-based access control
✅ Admin-only endpoints properly protected
✅ Template-based restrictions (admin templates for admins only)
✅ User context tracked in all operations
```

### **2. Multi-Channel Communication**
- **Email + SMS unified interface**
- **Template system with dynamic data injection**
- **Bulk operations with rate limiting**
- **Comprehensive activity logging**

### **3. Production-Ready Error Handling**
```javascript
// RESILIENT: Graceful degradation
✅ Service failures don't break logging
✅ Missing database tables handled gracefully  
✅ Individual channel failures isolated in multi-channel notifications
```

## 📊 **SYSTEM OVERVIEW**

### **Database Integration:**
- **Logging Tables:** `email_logs`, `sms_logs`, `bulk_email_logs`, `bulk_sms_logs`
- **User Lookup:** `users` table for notification service
- **Activity Tracking:** Comprehensive logging of all communication attempts

### **External Service Integration:**
- **Email Providers:** SendGrid, AWS SES, Mailgun (configurable)
- **SMS Providers:** Twilio, AWS SNS, other SMS gateways
- **Health Monitoring:** Built-in connectivity testing

### **Template System:**
```javascript
// Rich template ecosystem
Email: welcome, surveyApproval, contentNotification, passwordReset, adminNotification
SMS: welcome, surveyApproval, verificationCode, passwordReset, contentNotification, adminAlert, maintenance
```

## 🎯 **FRONTEND INTEGRATION POINTS**

Your routes serve these frontend components:
- **Admin Dashboards** (`/health`, `/stats` - monitoring interfaces)
- **Communication Forms** (`/email/send`, `/sms/send` - individual messaging)
- **Bulk Operations** (`/email/bulk`, `/sms/bulk` - mass communications) 
- **Multi-Channel Alerts** (`/notification` - critical notifications)
- **Template Selectors** (`/templates` - template discovery)

## 🔄 **COMPLEX DATA FLOWS**

### **Multi-Channel Notification (Most Sophisticated):**
```
Trigger → User Lookup → Channel Selection → Parallel Email/SMS → Aggregate Results → Comprehensive Logging
```

### **Bulk Operations with Rate Limiting:**
```
Admin Request → Authorization → Batch Processing → Rate Limited Sending → Progress Tracking → Result Aggregation
```

### **Template Processing:**
```
Request → Template Selection → Dynamic Data Injection → Provider-Specific Formatting → Delivery → Status Tracking
```

## 🚨 **SMART DESIGN DECISIONS**

### **1. Conservative Rate Limits**
```javascript
// Well-thought-out limits
Email Bulk: Max 1000 recipients, 50 batch size, 1000ms delay
SMS Bulk:   Max 500 recipients, 20 batch size, 2000ms delay (more conservative)
```

### **2. Flexible User Targeting**
```javascript
// Notification service accepts:
userId (database lookup) OR userEmail + userPhone (direct contact)
```

### **3. Backwards Compatibility**
```javascript
// Legacy route maintained
router.post('/send', authenticate, sendEmailHandler); // Deprecated but functional
```

## ⚠️ **MINOR AREAS FOR IMPROVEMENT**

### **1. Missing Production Features**
- **Template Management Interface** (no CRUD for templates)
- **Advanced Analytics** (no delivery rates, engagement metrics)
- **Queue Management** (no background processing, retry logic)
- **Content Features** (no attachments, rich text editor)

### **2. Database Optimization**
```sql
-- Recommended indexes for performance
CREATE INDEX idx_email_logs_status ON email_logs(status);
CREATE INDEX idx_email_logs_template ON email_logs(template);
CREATE INDEX idx_email_logs_created ON email_logs(createdAt);
```

### **3. Enhanced Template System**
- **Template versioning**
- **Preview functionality**  
- **A/B testing support**

## 🔧 **IMMEDIATE RECOMMENDATIONS**

### **1. Add Template Management (High Value)**
```javascript
POST /communication/templates        // Create template
PUT /communication/templates/:id     // Update template  
GET /communication/templates/:id/preview // Preview template
```

### **2. Implement Background Processing**
- **Queue-based message processing**
- **Retry mechanisms with exponential backoff**
- **Priority-based sending**

### **3. Add Advanced Analytics**
- **Delivery rate tracking by provider**
- **Bounce/failure categorization**
- **User engagement metrics**

## 🏆 **OVERALL ASSESSMENT**

This communication system represents **excellent engineering** with:

### **Strengths:**
- ✅ **Rock-solid security** and authorization
- ✅ **Multi-channel architecture** with unified API
- ✅ **Production-ready error handling** and logging
- ✅ **Smart rate limiting** and abuse prevention
- ✅ **Flexible template system** with dynamic data
- ✅ **Comprehensive monitoring** and health checks

### **Production Readiness:** 
**9/10** - Ready for production use with basic communication needs. The missing features (template management, advanced analytics) are enhancements rather than critical gaps.

The system demonstrates sophisticated understanding of communication infrastructure requirements and implements industry best practices throughout. Would you like me to help design the template management API or background processing system?






# Comment Routes System Analysis - Complete Endpoint Mapping

## System Overview
**Base Path:** `/api/comments/*`  
**Authentication:** All routes require `authenticate` middleware  
**File Upload:** Routes with media support use `uploadMiddleware` + `uploadToS3`  
**Primary Purpose:** Comment system for chats and teachings with media support and comprehensive management

---

## 📊 ADMINISTRATIVE & STATISTICS ENDPOINTS

### 1. GET `/api/comments/stats` - Get Comment Statistics
**Route:** `router.get('/stats', authenticate, fetchCommentStats)`
- **Controller:** `fetchCommentStats()` in commentControllers.js
- **Service:** `getCommentStats()` in commentServices.js
- **Purpose:** Retrieve comprehensive comment analytics and statistics
- **Database Table:** `comments`
- **Query:** 
  ```sql
  SELECT 
    COUNT(*) as total_comments,
    COUNT(CASE WHEN chat_id IS NOT NULL THEN 1 END) as chat_comments,
    COUNT(CASE WHEN teaching_id IS NOT NULL THEN 1 END) as teaching_comments,
    COUNT(DISTINCT user_id) as unique_commenters,
    COUNT(CASE WHEN media_url1 IS NOT NULL OR media_url2 IS NOT NULL OR media_url3 IS NOT NULL THEN 1 END) as comments_with_media,
    MIN(createdAt) as first_comment,
    MAX(createdAt) as latest_comment
  FROM comments [WHERE conditions]
  ```
- **Frontend Usage:** 
  - Admin dashboards
  - Analytics panels
  - Moderation tools
  - Report generation interfaces
- **Dependencies:** 
  - `authenticate` middleware
  - `db` from '../config/db.js'
- **Authorization:** Admin/Super Admin only (role-based check)
- **Query Parameters:** `user_id`, `startDate`, `endDate` (optional filters)
- **Returns:** Comprehensive statistics object with counts and date ranges

### 2. GET `/api/comments/all` - Fetch All Comments
**Route:** `router.get('/all', authenticate, fetchAllComments)`
- **Controller:** `fetchAllComments()` in commentControllers.js
- **Service:** `getAllComments()` in commentServices.js
- **Purpose:** Retrieve all comments in the system for admin review
- **Database Table:** `comments`
- **Query:** 
  ```sql
  SELECT * FROM comments ORDER BY createdAt DESC
  ```
- **Frontend Usage:** 
  - Admin comment management dashboards
  - Moderation interfaces
  - System-wide comment overview
  - Content review tools
- **Dependencies:** 
  - `authenticate` middleware
  - `db` from '../config/db.js'
- **Returns:** Array of all comments (backwards compatible format)
- **⚠️ MISSING:** No authorization check (should be admin-only)

---

## 🔄 COMMENT RELATIONSHIP & PARENT CONTENT ENDPOINTS

### 3. GET `/api/comments/parent-comments` - Fetch Parent Content with Comments
**Route:** `router.get('/parent-comments', authenticate, fetchParentChatsAndTeachingsWithComments)`
- **Controller:** `fetchParentChatsAndTeachingsWithComments()` in commentControllers.js
- **Service:** 
  - `getCommentsByUserId()` → `getChatAndTeachingIdsFromComments()` → `getParentChatsAndTeachingsWithComments()`
- **Purpose:** Get chats and teachings that user has commented on, with all comments
- **Database Tables:** `comments`, `chats`, `teachings`
- **Queries:** 
  ```sql
  -- Get user's comments
  SELECT * FROM comments WHERE user_id = ? ORDER BY createdAt DESC
  
  -- Get parent chats
  SELECT *, prefixed_id FROM chats WHERE id IN (?) ORDER BY updatedAt DESC
  
  -- Get parent teachings  
  SELECT *, prefixed_id FROM teachings WHERE id IN (?) ORDER BY updatedAt DESC
  
  -- Get all comments for parents
  SELECT * FROM comments WHERE chat_id IN (?) OR teaching_id IN (?) ORDER BY createdAt DESC
  ```
- **Frontend Usage:** 
  - User activity feeds
  - "My Comments" sections
  - Comment history views
  - User engagement dashboards
- **Dependencies:** 
  - `authenticate` middleware
  - Complex multi-table join logic
  - `db` from '../config/db.js'
- **Query Parameters:** `user_id` (required)
- **Returns:** Object with `chats`, `teachings`, `comments` arrays + metadata
- **Complex Processing:** Extracts IDs from comments, fetches parent content, aggregates results

### 4. GET `/api/comments/comments` - Fetch Comments by Parent IDs (Legacy)
**Route:** `router.get('/comments', authenticate, fetchCommentsByParentIds)`
- **Controller:** `fetchCommentsByParentIds()` in commentControllers.js
- **Service:** `getCommentsByParentIds()` in commentServices.js
- **Purpose:** Get comments for specific chats and/or teachings (legacy route)
- **Database Table:** `comments`
- **Query:** 
  ```sql
  SELECT * FROM comments WHERE chat_id IN (?) OR teaching_id IN (?) ORDER BY createdAt DESC
  ```
- **Frontend Usage:** 
  - Legacy comment loading systems
  - Specific content comment sections
  - Backwards compatibility
- **Dependencies:** 
  - `authenticate` middleware
  - `db` from '../config/db.js'
- **Query Parameters:** `chatIds`, `teachingIds` (comma-separated strings)
- **Returns:** Array of comments (backwards compatible format)
- **⚠️ ROUTE NAMING:** Confusing route path `/comments/comments`

---

## 👤 USER-SPECIFIC COMMENT ENDPOINTS

### 5. GET `/api/comments/user/:user_id` - Fetch Comments by User ID
**Route:** `router.get('/user/:user_id', authenticate, fetchCommentsByUserId)`
- **Controller:** `fetchCommentsByUserId()` in commentControllers.js
- **Service:** `getCommentsByUserId()` in commentServices.js
- **Purpose:** Retrieve all comments made by specific user
- **Database Table:** `comments`
- **Query:** 
  ```sql
  SELECT * FROM comments WHERE user_id = ? ORDER BY createdAt DESC
  ```
- **Frontend Usage:** 
  - User profile pages
  - Comment history views
  - User activity tracking
  - Personal comment management
- **Dependencies:** 
  - `authenticate` middleware
  - `db` from '../config/db.js'
- **Parameters:** `user_id` from URL params
- **Returns:** Array of user's comments (backwards compatible format)
- **⚠️ MISSING:** No authorization check (users can view others' comments)

---

## 📁 FILE UPLOAD ENDPOINTS

### 6. POST `/api/comments/upload` - Upload Comment Files
**Route:** `router.post('/upload', authenticate, uploadMiddleware, uploadToS3, uploadCommentFiles)`
- **Controller:** `uploadCommentFiles()` in commentControllers.js
- **Service:** `uploadCommentService()` in commentServices.js
- **Purpose:** Upload media files for comments before comment creation
- **Database Table:** None (S3 upload only)
- **External Services:** S3 file storage
- **Frontend Usage:** 
  - Comment creation forms with media
  - File upload components
  - Media attachment interfaces
- **Dependencies:** 
  - `authenticate` middleware
  - `uploadMiddleware` from '../middlewares/upload.middleware.js'
  - `uploadToS3` from '../middlewares/upload.middleware.js'
  - `uploadFileToS3` from '../config/s3.js'
- **Processing:** 
  - Accepts multiple files
  - Uploads to S3
  - Returns file URLs and types
- **Returns:** Array of uploaded file objects with URLs
- **⚠️ DESIGN QUESTION:** Separate upload endpoint vs inline upload during comment creation

---

## ✍️ COMMENT CRUD ENDPOINTS

### 7. POST `/api/comments/` - Create New Comment
**Route:** `router.post('/', authenticate, uploadMiddleware, uploadToS3, createComment)`
- **Controller:** `createComment()` in commentControllers.js
- **Service:** `createCommentService()` in commentServices.js
- **Purpose:** Create new comment on chat or teaching with optional media
- **Database Table:** `comments`
- **Query:** 
  ```sql
  INSERT INTO comments (user_id, chat_id, teaching_id, comment, 
                        media_url1, media_type1, media_url2, media_type2, 
                        media_url3, media_type3)
  VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
  ```
- **Frontend Usage:** 
  - Comment forms under chats/teachings
  - Reply interfaces
  - Media comment creation
- **Dependencies:** 
  - `authenticate` middleware
  - `uploadMiddleware` + `uploadToS3` for media
  - `db.getConnection()` with transactions
  - `CustomError` from '../utils/CustomError.js'
- **Request Body:** 
  ```javascript
  {
    chat_id: "number|null",      // Must have either chat_id or teaching_id
    teaching_id: "number|null",
    comment: "string"
  }
  ```
- **Media Support:** Up to 3 media files (images/videos)
- **Validation:** Requires either `chat_id` or `teaching_id` (not both)
- **Returns:** Comment ID and success message (backwards compatible)

### 8. GET `/api/comments/:commentId` - Get Specific Comment
**Route:** `router.get('/:commentId', authenticate, fetchCommentById)`
- **Controller:** `fetchCommentById()` in commentControllers.js
- **Service:** `getCommentById()` in commentServices.js
- **Purpose:** Retrieve single comment with detailed information
- **Database Tables:** `comments`, `users`, `chats`, `teachings` (JOINed)
- **Query:** 
  ```sql
  SELECT c.*, u.username, u.email,
         ch.title as chat_title, ch.prefixed_id as chat_prefixed_id,
         t.topic as teaching_title, t.prefixed_id as teaching_prefixed_id,
         CASE 
           WHEN c.chat_id IS NOT NULL THEN 'chat'
           WHEN c.teaching_id IS NOT NULL THEN 'teaching'
           ELSE 'unknown'
         END as content_type
  FROM comments c
  LEFT JOIN users u ON c.user_id = u.id
  LEFT JOIN chats ch ON c.chat_id = ch.id
  LEFT JOIN teachings t ON c.teaching_id = t.id
  WHERE c.id = ?
  ```
- **Frontend Usage:** 
  - Comment detail views
  - Comment permalink pages
  - Moderation interfaces
- **Dependencies:** 
  - `authenticate` middleware
  - Complex JOIN query logic
  - `db` from '../config/db.js'
- **Authorization:** Users can only view their own comments (unless admin)
- **Returns:** Enhanced comment object with user and parent content info

### 9. PUT `/api/comments/:commentId` - Update Comment
**Route:** `router.put('/:commentId', authenticate, uploadMiddleware, uploadToS3, updateComment)`
- **Controller:** `updateComment()` in commentControllers.js
- **Service:** `updateCommentById()` in commentServices.js
- **Purpose:** Update existing comment text and media
- **Database Table:** `comments`
- **Query:** 
  ```sql
  UPDATE comments 
  SET comment = ?, 
      media_url1 = ?, media_type1 = ?,
      media_url2 = ?, media_type2 = ?,
      media_url3 = ?, media_type3 = ?,
      updatedAt = NOW()
  WHERE id = ?
  ```
- **Frontend Usage:** 
  - Comment edit forms
  - In-place comment editing
  - Media replacement interfaces
- **Dependencies:** 
  - `authenticate` middleware
  - `uploadMiddleware` + `uploadToS3` for new media
  - Authorization logic (ownership check)
  - `db` from '../config/db.js'
- **Authorization:** Users can only update their own comments (unless admin)
- **Media Handling:** Replaces existing media with new uploads
- **Returns:** Updated comment object with success message

### 10. DELETE `/api/comments/:commentId` - Delete Comment
**Route:** `router.delete('/:commentId', authenticate, deleteComment)`
- **Controller:** `deleteComment()` in commentControllers.js
- **Service:** `deleteCommentById()` in commentServices.js
- **Purpose:** Permanently delete comment
- **Database Table:** `comments`
- **Query:** 
  ```sql
  DELETE FROM comments WHERE id = ?
  ```
- **Frontend Usage:** 
  - Delete buttons on comments
  - Moderation tools
  - User comment management
- **Dependencies:** 
  - `authenticate` middleware
  - Authorization logic (ownership check)
  - `db` from '../config/db.js'
- **Authorization:** Users can only delete their own comments (unless admin)
- **⚠️ MISSING:** No cleanup of associated S3 media files
- **Returns:** Success confirmation with deleted comment ID

---

## 🔍 DATABASE SCHEMA ANALYSIS

### Comments Table Structure
```sql
-- Core Fields
id, user_id, chat_id, teaching_id, comment

-- Media Support (up to 3 files)
media_url1, media_type1, media_url2, media_type2, media_url3, media_type3

-- Timestamps
createdAt, updatedAt

-- Relationships
-- Foreign keys: user_id → users.id, chat_id → chats.id, teaching_id → teachings.id
-- Constraint: Either chat_id OR teaching_id must be set (not both, not neither)
```

### Related Tables (via JOINs)
```sql
-- users table: id, username, email
-- chats table: id, title, prefixed_id, updatedAt
-- teachings table: id, topic, prefixed_id, updatedAt
```

---

## 🔄 COMPLEX DATA FLOW ANALYSIS

### Comment Creation Flow
```
Frontend Form → Upload Media → S3 Storage → POST /comments/ → createComment() 
→ Transaction Start → INSERT comment → Commit → Return ID
```

### Parent Content Discovery Flow
```
Frontend Request → GET /parent-comments?user_id=X → Get User Comments 
→ Extract Chat/Teaching IDs → Fetch Parent Content → Fetch All Comments 
→ Aggregate Response → Return Combined Data
```

### Comment Statistics Flow
```
Admin Dashboard → GET /stats → Role Check → Apply Filters → Complex Aggregation Query 
→ Return Statistics Object
```

### Comment Update Flow
```
Frontend Edit → Upload New Media → PUT /:commentId → Authorization Check 
→ Update Database → Return Updated Comment
```

---

## 🚨 IDENTIFIED ISSUES & CONCERNS

### Authorization Issues
1. **Missing Admin Checks:**
   ```javascript
   // Should be admin-only but no role check
   router.get('/all', authenticate, fetchAllComments);
   ```

2. **Cross-User Access:**
   ```javascript
   // Users can view other users' comments
   router.get('/user/:user_id', authenticate, fetchCommentsByUserId);
   ```

### Route Design Issues
1. **Confusing Route Naming:**
   ```javascript
   // Confusing path
   router.get('/comments', authenticate, fetchCommentsByParentIds);
   ```

2. **Route Order Dependency:**
   ```javascript
   // These must be in specific order to avoid conflicts
   router.get('/stats', ...)        // Must be before /:commentId
   router.get('/all', ...)          // Must be before /:commentId
   router.get('/:commentId', ...)   // Catch-all parameter route
   ```

### Database Query Issues
1. **Complex IN Clause Handling:**
   ```javascript
   // Requires careful parameter spreading for arrays
   const placeholders = chatIds.map(() => '?').join(',');
   queryParams.push(...chatIds);  // Must spread array items
   ```

2. **Mixed Query Patterns:**
   ```javascript
   // Uses both connection transactions and direct db.query
   const connection = await db.getConnection(); // For transactions
   const result = await db.query(...);          // For simple queries
   ```

### Missing Features
1. **No Nested Comments:** No reply-to-comment functionality
2. **No Comment Moderation:** No approval/rejection workflow
3. **No Media Cleanup:** Deleted comments don't clean up S3 files
4. **No Comment Reactions:** No likes/dislikes system
5. **No Comment Search:** No way to search comment content

---

## 📊 EXTERNAL DEPENDENCIES ANALYSIS

### Middleware Dependencies
```javascript
// Authentication
import { authenticate } from '../middlewares/auth.middleware.js'

// File Upload
import { uploadMiddleware, uploadToS3 } from '../middlewares/upload.middleware.js'
```

### Service Dependencies
```javascript
// Database
import db from '../config/db.js'               // Custom wrapper
// Transactions: await db.getConnection()      // For complex operations

// File Storage
import { uploadFileToS3 } from '../config/s3.js'

// Error Handling
import CustomError from '../utils/CustomError.js'

// External API
import axios from 'axios'  // Used but not shown in provided code
```

### Media Storage Integration
```
Client Files → uploadMiddleware → S3 Upload → Store URLs → Database References
```

---

## 🎯 IMMEDIATE FIXES REQUIRED

### 1. Add Missing Authorization (CRITICAL)
```javascript
// Add admin check to stats and all comments
router.get('/all', authenticate, requireAdmin, fetchAllComments);

// Add ownership check to user comments  
router.get('/user/:user_id', authenticate, checkUserAccess, fetchCommentsByUserId);
```

### 2. Fix Route Naming
```javascript
// Rename confusing route
router.get('/by-parents', authenticate, fetchCommentsByParentIds);
```

### 3. Add Media Cleanup
```javascript
// In deleteComment - clean up S3 files
const comment = await getCommentById(commentId);
await cleanupS3Media(comment.media_urls);
await deleteCommentById(commentId);
```

### 4. Standardize Response Formats
```javascript
// Consistent response structure for all endpoints
{
  success: boolean,
  data: any,
  message?: string,
  error?: string
}
```

---

## 🔄 RECOMMENDED ENHANCEMENTS

### 1. Add Comment Threading
- Support for reply-to-comment relationships
- Nested comment display
- Thread-based operations

### 2. Add Comment Moderation
- Admin approval workflow
- Content filtering
- Automated moderation tools

### 3. Add Search & Filtering
- Full-text comment search
- Filter by date, user, content type
- Advanced search operators

### 4. Add Analytics Tracking
- Comment engagement metrics
- User activity patterns
- Content popularity analysis

### 5. Add Real-time Features
- Live comment updates
- WebSocket integration
- Notification system

The comment system is feature-rich with excellent media support and complex relationship handling, but needs authorization fixes and route optimization for production readiness.



I'll analyze your comment routes system and create a comprehensive mapping to help you understand the flow and identify any issues or improvements needed.I've completed a comprehensive analysis of your comment routes system. Here are the **critical findings**:

## 🚨 **CRITICAL SECURITY ISSUES**

### 1. **Missing Authorization Checks**
```javascript
// SECURITY RISK: Anyone authenticated can access all comments
router.get('/all', authenticate, fetchAllComments);  // Should be admin-only

// PRIVACY ISSUE: Users can view other users' comments
router.get('/user/:user_id', authenticate, fetchCommentsByUserId);  // No ownership check
```

### 2. **Inconsistent Authorization Pattern**
```javascript
// GOOD: Proper authorization in newer endpoints
fetchCommentById()    // ✅ Checks ownership or admin role
updateComment()       // ✅ Checks ownership or admin role  
deleteComment()       // ✅ Checks ownership or admin role

// BAD: Missing authorization in older endpoints
fetchAllComments()    // ❌ No role check
fetchCommentsByUserId() // ❌ No ownership check
```

## 🔧 **ARCHITECTURAL STRENGTHS**

### **Excellent Features:**
1. **Comprehensive Media Support** - Up to 3 media files per comment
2. **Transaction Safety** - Uses database transactions for comment creation
3. **Complex Relationship Handling** - Links comments to both chats and teachings
4. **Rich Analytics** - Detailed comment statistics with filtering
5. **Backwards Compatibility** - Maintains existing frontend response formats

### **Smart Route Organization:**
```javascript
// Well-ordered routes (most specific first)
/stats                    // Admin statistics
/all                     // All comments  
/parent-comments         // Complex relationship queries
/user/:user_id          // User-specific comments
/:commentId             // Individual comment operations
```

## 📊 **DATABASE INTERACTION SUMMARY**

### **Primary Table:** `comments`
- **Core Operations:** CRUD operations with media support
- **Relationships:** Links to `users`, `chats`, `teachings` tables
- **Complex Queries:** Multi-table JOINs for enriched comment data
- **Analytics:** Advanced aggregation queries for statistics

### **Query Patterns:**
```sql
-- Simple queries use db.query() wrapper
SELECT * FROM comments WHERE user_id = ?

-- Complex operations use transactions
const connection = await db.getConnection();
await connection.beginTransaction();
-- Multiple operations
await connection.commit();
```

## 🎯 **FRONTEND INTEGRATION POINTS**

Your routes serve these frontend components:
- **Comment Forms** (`POST /` - create with media)
- **Comment Threads** (`GET /comments` - parent content relationships)
- **User Profiles** (`GET /user/:id` - user activity)
- **Admin Dashboards** (`GET /stats`, `/all` - management interfaces)
- **Comment Management** (`PUT/DELETE /:id` - edit/delete operations)

## 🔄 **COMPLEX DATA FLOWS**

### **Parent Content Discovery (Most Complex):**
```
Request User Comments → Extract Parent IDs → Fetch Chats & Teachings → 
Fetch All Related Comments → Aggregate Response
```

### **Comment Creation with Media:**
```
Upload Files → S3 Storage → Database Transaction → Store Comment + Media URLs
```

### **Statistics Generation:**
```
Apply Filters → Complex Aggregation Query → Return Analytics Object
```

## 🚨 **IMMEDIATE FIXES NEEDED**

### **1. Add Authorization (CRITICAL)**
```javascript
// Add admin check for sensitive endpoints
const requireAdmin = (req, res, next) => {
  if (!['admin', 'super_admin'].includes(req.user.role)) {
    return res.status(403).json({ error: 'Admin access required' });
  }
  next();
};

router.get('/all', authenticate, requireAdmin, fetchAllComments);
router.get('/stats', authenticate, requireAdmin, fetchCommentStats);
```

### **2. Add Ownership Validation**
```javascript
// In fetchCommentsByUserId controller
if (user_id !== req.user.user_id && !['admin', 'super_admin'].includes(req.user.role)) {
  return res.status(403).json({ error: 'Access denied' });
}
```

### **3. Fix Route Naming (UX Issue)**
```javascript
// Rename confusing route
router.get('/by-parent-ids', authenticate, fetchCommentsByParentIds);
// Instead of: router.get('/comments', ...)
```

### **4. Add Media Cleanup**
```javascript
// In deleteComment - clean up orphaned S3 files
const comment = await getCommentById(commentId);
if (comment.media_urls) {
  await cleanupS3Files(comment.media_urls);
}
```

## 🔍 **NOTABLE TECHNICAL DECISIONS**

### **Database Pattern Consistency:**
- **Mixed Approach:** Uses both `db.query()` wrapper and `db.getConnection()` transactions
- **Smart Choice:** Transactions for complex operations, simple wrapper for basic queries

### **Backwards Compatibility:**
- **Frontend-Friendly:** Maintains existing response formats while adding enhancements
- **Progressive Enhancement:** New endpoints use modern patterns, old ones preserved

### **Route Parameter Handling:**
- **Flexible Input:** Handles both string and array inputs for parent IDs
- **Type Safety:** Converts and validates parameters appropriately

## 📈 **MISSING FEATURES FOR PRODUCTION**

1. **Comment Threading** - No reply-to-comment functionality
2. **Comment Moderation** - No approval/content filtering workflow  
3. **Real-time Updates** - No WebSocket integration for live comments
4. **Search Functionality** - No way to search comment content
5. **Rate Limiting** - No spam protection for comment creation

The comment system is architecturally sophisticated with excellent media handling and complex relationship management, but needs **immediate security fixes** for authorization before production deployment.

Would you like me to help create secure, fixed versions of the problematic endpoints?







# Class Routes System Analysis - Complete Endpoint Mapping

## System Overview
**Base Path:** `/api/class/*` (assumed)  
**Authentication:** Mixed - some routes require `authenticate`, others are public  
**Primary Purpose:** Class management system for educational/learning platform  
**Architecture:** Clean 3-layer (Routes → Controllers → Services)

---

## 📚 CLASS MANAGEMENT ENDPOINTS

### 1. GET `/api/class/` - Fetch All Classes
**Route:** `router.get('/', getClasses)`
- **Controller:** `getClasses()` in classControllers.js
- **Service:** `fetchClasses()` in classServices.js
- **Purpose:** Retrieve all available classes for display/selection
- **Database Table:** `classes`
- **Query:** 
  ```sql
  SELECT * FROM classes
  ```
- **Frontend Usage:** 
  - Class catalog pages
  - Course selection dropdowns
  - Admin class management dashboards
  - Public class browsing interfaces
- **Dependencies:** 
  - `db` from '../config/db.js'
- **Authentication:** ❌ **NONE - Public endpoint**
- **Returns:** Array of all classes with full details
- **⚠️ SECURITY CONCERN:** No authentication - exposes all class data publicly

### 2. POST `/api/class/` - Create New Class
**Route:** `router.post('/', postClass)`
- **Controller:** `postClass()` in classControllers.js
- **Service:** `createClass()` in classServices.js
- **Purpose:** Create new class/course for the platform
- **Database Table:** `classes`
- **Query:** 
  ```sql
  INSERT INTO classes (class_id, name, description) VALUES (?, ?, ?)
  ```
- **Frontend Usage:** 
  - Admin class creation forms
  - Course management interfaces
  - Teacher/instructor portals
- **Dependencies:** 
  - `db` from '../config/db.js'
- **Authentication:** ❌ **NONE - Public endpoint**
- **Request Body:** 
  ```javascript
  {
    class_id: "string",    // Manual ID assignment
    name: "string",
    description: "string"
  }
  ```
- **⚠️ SECURITY ISSUE:** No authentication - anyone can create classes
- **⚠️ DESIGN ISSUE:** Manual `class_id` assignment could cause conflicts

### 3. PUT `/api/class/:id` - Update Existing Class
**Route:** `router.put('/:id', putClass)`
- **Controller:** `putClass()` in classControllers.js
- **Service:** `updateClass()` in classServices.js
- **Purpose:** Update class information (name, description)
- **Database Table:** `classes`
- **Query:** 
  ```sql
  UPDATE classes SET name = ?, description = ? WHERE class_id = ?
  ```
- **Frontend Usage:** 
  - Admin class editing forms
  - Course information updates
  - Content management systems
- **Dependencies:** 
  - `db` from '../config/db.js'
- **Authentication:** ❌ **NONE - Public endpoint**
- **Parameters:** `id` from URL params (maps to `class_id` in database)
- **Request Body:** 
  ```javascript
  {
    name: "string",
    description: "string"
  }
  ```
- **⚠️ SECURITY ISSUE:** No authentication - anyone can modify classes

---

## 👥 USER-CLASS RELATIONSHIP ENDPOINTS

### 4. POST `/api/class/assign` - Assign User to Class
**Route:** `router.post('/assign', authenticate, assignUserToClass)`
- **Controller:** `assignUserToClass()` in classControllers.js
- **Service:** `assignUserToClassService()` in classServices.js
- **Purpose:** Enroll user in specific class/course
- **Database Table:** `user_classes` (junction table)
- **Query:** 
  ```sql
  INSERT INTO user_classes (user_id, class_id) VALUES (?, ?)
  ```
- **Frontend Usage:** 
  - Course enrollment interfaces
  - Admin user management
  - Student registration systems
  - Class roster management
- **Dependencies:** 
  - `authenticate` middleware from '../middlewares/auth.middleware.js'
  - `db` from '../config/db.js'
- **Authentication:** ✅ **Required**
- **Request Body:** 
  ```javascript
  {
    userId: "number|string",
    classId: "number|string"
  }
  ```
- **⚠️ MISSING VALIDATION:** No check if user/class exists before assignment
- **⚠️ MISSING DUPLICATE HANDLING:** No prevention of duplicate enrollments

### 5. GET `/api/class/:classId/content` - Get Class Content
**Route:** `router.get('/:classId/content', authenticate, getClassContent)`
- **Controller:** `getClassContent()` in classControllers.js
- **Service:** `getClassContentService()` in classServices.js
- **Purpose:** Retrieve all content/materials for specific class
- **Database Table:** `content`
- **Query:** 
  ```sql
  SELECT * FROM content WHERE class_id = ?
  ```
- **Frontend Usage:** 
  - Class learning interfaces
  - Student course content views
  - Content delivery systems
  - Class material browsers
- **Dependencies:** 
  - `authenticate` middleware from '../middlewares/auth.middleware.js'
  - `db` from '../config/db.js'
- **Authentication:** ✅ **Required**
- **Parameters:** `classId` from URL params
- **⚠️ AUTHORIZATION ISSUE:** No check if user is enrolled in class
- **⚠️ MISSING FEATURE:** No content type filtering or organization

---

## 🔍 DATABASE SCHEMA ANALYSIS

### Core Tables Used

#### `classes` Table
```sql
-- Primary class information
class_id     -- Manual ID (string/number)
name         -- Class name
description  -- Class description
-- Missing common fields:
-- created_at, updated_at, status, instructor_id, max_students
```

#### `user_classes` Table (Junction Table)
```sql
-- Many-to-many relationship
user_id      -- Foreign key to users table
class_id     -- Foreign key to classes table
-- Missing useful fields:
-- enrolled_at, completion_status, grade, progress
```

#### `content` Table
```sql
-- Class materials/content
class_id     -- Foreign key to classes table
-- Other fields not specified in queries
-- Likely: id, title, type, url, description, order
```

---

## 🔄 DATA FLOW ANALYSIS

### Class Creation Flow
```
Admin Interface → POST /class/ → postClass() → createClass() 
→ INSERT to classes → Return success
```

### User Enrollment Flow
```
Enrollment Form → POST /class/assign → authenticate → assignUserToClass() 
→ assignUserToClassService() → INSERT to user_classes → Return success
```

### Content Access Flow
```
Class Page → GET /:classId/content → authenticate → getClassContent() 
→ getClassContentService() → SELECT from content → Return materials
```

### Class Browsing Flow
```
Public Catalog → GET /class/ → getClasses() → fetchClasses() 
→ SELECT from classes → Return all classes
```

---

## 🚨 CRITICAL ISSUES IDENTIFIED

### Security Vulnerabilities
1. **No Authentication on Core Routes:**
   ```javascript
   // These should require authentication:
   router.post('/', postClass)      // Anyone can create classes
   router.put('/:id', putClass)     // Anyone can modify classes
   router.get('/', getClasses)      // May expose sensitive class data
   ```

2. **No Authorization Checks:**
   ```javascript
   // User can access any class content:
   GET /:classId/content // No check if user enrolled in class
   
   // User can enroll in any class:
   POST /assign // No validation of enrollment eligibility
   ```

### Data Integrity Issues
1. **Manual ID Assignment:**
   ```javascript
   // Dangerous manual ID assignment
   const { class_id, name, description } = classData;
   INSERT INTO classes (class_id, ...)  // Could cause conflicts
   ```

2. **No Validation:**
   - No check if user exists before assignment
   - No check if class exists before assignment
   - No duplicate enrollment prevention
   - No input sanitization

### Missing Features
1. **No Enrollment Management:**
   - Can't remove user from class
   - Can't list users in class
   - Can't list classes user is enrolled in

2. **No Class Status Management:**
   - No active/inactive classes
   - No enrollment limits
   - No enrollment periods

3. **No Content Organization:**
   - No content ordering
   - No content types/categories
   - No progress tracking

---

## 📊 MISSING ENDPOINTS FOR COMPLETE SYSTEM

### User-Class Relationship Management
```javascript
// GET /class/:classId/users - Get users enrolled in class
// GET /user/:userId/classes - Get classes user is enrolled in  
// DELETE /class/assign - Remove user from class
// GET /class/:classId/enrollment-status - Check if user can enroll
```

### Enhanced Class Management
```javascript
// GET /class/:id - Get single class details
// DELETE /class/:id - Delete class
// GET /class/:classId/stats - Get class statistics
// PUT /class/:classId/status - Activate/deactivate class
```

### Content Management
```javascript
// POST /class/:classId/content - Add content to class
// PUT /class/:classId/content/:contentId - Update class content
// DELETE /class/:classId/content/:contentId - Remove content from class
// GET /class/:classId/content/:contentId - Get specific content item
```

---

## 🔧 EXTERNAL DEPENDENCIES ANALYSIS

### Middleware Dependencies
```javascript
// Authentication
import { authenticate } from '../middlewares/auth.middleware.js'
// Only used on 2 out of 5 routes
```

### Service Dependencies
```javascript
// Database
import db from '../config/db.js'

// Error Handling
import CustomError from '../utils/CustomError.js'
// Imported but never used in the provided code
```

### No External Services
- No file upload capabilities
- No email notifications for enrollments
- No payment processing for paid classes
- No integration with learning management systems

---

## 🎯 IMMEDIATE FIXES REQUIRED

### 1. Add Authentication to Core Routes (CRITICAL)
```javascript
// Secure class management routes
router.post('/', authenticate, authorize(['admin', 'instructor']), postClass);
router.put('/:id', authenticate, authorize(['admin', 'instructor']), putClass);
router.get('/', authenticate, getClasses); // Or keep public but filter sensitive data
```

### 2. Add Authorization Checks
```javascript
// In getClassContent controller
export const getClassContent = async (req, res) => {
  try {
    const { classId } = req.params;
    const userId = req.user.user_id;
    
    // Check if user is enrolled in class
    const enrollment = await checkUserEnrollment(userId, classId);
    if (!enrollment) {
      return res.status(403).json({ error: 'Not enrolled in this class' });
    }
    
    const content = await getClassContentService(classId);
    res.status(200).json(content);
  } catch (error) {
    // ... error handling
  }
};
```

### 3. Fix Database Design Issues
```javascript
// Use auto-incrementing ID instead of manual assignment
export const createClass = async (classData) => {
  const { name, description } = classData;
  const sql = 'INSERT INTO classes (name, description, created_at) VALUES (?, ?, NOW())';
  return await db.query(sql, [name, description]);
};
```

### 4. Add Input Validation
```javascript
// Add validation middleware
import { validateClassData, validateAssignment } from '../middlewares/validation.js';

router.post('/', authenticate, validateClassData, postClass);
router.post('/assign', authenticate, validateAssignment, assignUserToClass);
```

### 5. Add Duplicate Prevention
```javascript
// In assignUserToClassService
export const assignUserToClassService = async (userId, classId) => {
  // Check if already enrolled
  const existing = await db.query(
    'SELECT 1 FROM user_classes WHERE user_id = ? AND class_id = ?', 
    [userId, classId]
  );
  
  if (existing.length > 0) {
    throw new CustomError('User already enrolled in this class', 409);
  }
  
  const sql = 'INSERT INTO user_classes (user_id, class_id, enrolled_at) VALUES (?, ?, NOW())';
  await db.query(sql, [userId, classId]);
};
```

---

## 🔄 RECOMMENDED ARCHITECTURE IMPROVEMENTS

### 1. Add Role-Based Authorization
```javascript
// Different permissions for different roles
const authorize = (roles) => (req, res, next) => {
  if (!roles.includes(req.user.role)) {
    return res.status(403).json({ error: 'Insufficient permissions' });
  }
  next();
};
```

### 2. Implement Comprehensive Enrollment System
- Enrollment status tracking (pending, active, completed, dropped)
- Enrollment date tracking
- Class capacity management
- Prerequisites checking

### 3. Add Content Management Features
- Content ordering and sequencing
- Content type categorization
- Progress tracking
- Completion requirements

### 4. Enhance Error Handling
```javascript
// Use the imported CustomError consistently
if (!classData.name) {
  throw new CustomError('Class name is required', 400);
}
```

The class system has a clean structure but critical security gaps and missing features for a production learning platform. The lack of authentication on core routes is the most urgent issue to address.


I'll analyze your class routes system and create a comprehensive mapping to help you understand the flow and identify any issues or improvements needed.I've completed a comprehensive analysis of your class routes system. Here are the **critical findings**:

## 🚨 **CRITICAL SECURITY VULNERABILITIES**

### 1. **Missing Authentication on Core Routes**
```javascript
// DANGEROUS: Anyone can create/modify classes
router.get('/', getClasses)        // ❌ No auth - exposes all class data
router.post('/', postClass)        // ❌ No auth - anyone can create classes  
router.put('/:id', putClass)       // ❌ No auth - anyone can modify classes

// Only these have authentication:
router.post('/assign', authenticate, assignUserToClass)     // ✅ 
router.get('/:classId/content', authenticate, getClassContent) // ✅
```

### 2. **No Authorization Checks**
Even authenticated routes lack proper authorization:
```javascript
// User can access ANY class content (not just enrolled classes)
GET /:classId/content  // No enrollment verification

// User can enroll in ANY class (no eligibility checks)
POST /assign  // No validation of enrollment rights
```

## 🔍 **DATABASE DESIGN ISSUES**

### 1. **Manual ID Assignment (Conflict Risk)**
```javascript
// Dangerous manual class_id assignment
const { class_id, name, description } = classData;
INSERT INTO classes (class_id, ...)  // Could cause primary key conflicts
```

### 2. **Missing Essential Fields**
```sql
-- classes table lacks:
created_at, updated_at, instructor_id, max_students, status

-- user_classes table lacks:
enrolled_at, completion_status, progress
```

## 📊 **SYSTEM ARCHITECTURE OVERVIEW**

### **Database Tables:**
- **`classes`** - Core class information
- **`user_classes`** - Junction table for enrollments  
- **`content`** - Class materials/resources

### **Authentication Pattern:**
- **Public:** Class browsing, creation, updates (❌ **SECURITY RISK**)
- **Protected:** Content access, user enrollment

### **Missing Features:**
- No enrollment management (can't unenroll users)
- No class roster viewing
- No enrollment eligibility checks
- No duplicate enrollment prevention

## 🎯 **FRONTEND INTEGRATION POINTS**

Your routes serve these frontend components:
- **Public Class Catalogs** (`GET /` - course browsing)
- **Admin Dashboards** (`POST /`, `PUT /:id` - class management)
- **Enrollment Systems** (`POST /assign` - course registration)
- **Learning Interfaces** (`GET /:classId/content` - course materials)

## 🔄 **DATA FLOW ANALYSIS**

### **Class Creation (UNSECURED):**
```
Admin Form → POST /class/ → No Auth Check → Create Class → Success
```

### **User Enrollment:**
```
Student → POST /assign → Authenticate → No Enrollment Check → Add to Junction Table
```

### **Content Access:**
```
Student → GET /:classId/content → Authenticate → No Enrollment Check → Return All Content
```

## 🚨 **IMMEDIATE FIXES REQUIRED**

### **1. Secure Core Routes (CRITICAL)**
```javascript
// Add authentication and authorization
router.post('/', authenticate, authorize(['admin', 'instructor']), postClass);
router.put('/:id', authenticate, authorize(['admin', 'instructor']), putClass);
```

### **2. Add Enrollment Verification**
```javascript
// In getClassContent controller
const enrollment = await checkUserEnrollment(userId, classId);
if (!enrollment) {
  return res.status(403).json({ error: 'Not enrolled in this class' });
}
```

### **3. Fix Database Design**
```javascript
// Use auto-increment instead of manual IDs
const sql = 'INSERT INTO classes (name, description, created_at) VALUES (?, ?, NOW())';
```

### **4. Prevent Duplicate Enrollments**
```javascript
// Check existing enrollment before inserting
const existing = await db.query(
  'SELECT 1 FROM user_classes WHERE user_id = ? AND class_id = ?', 
  [userId, classId]
);
if (existing.length > 0) {
  throw new CustomError('Already enrolled', 409);
}
```

## 📋 **MISSING ENDPOINTS FOR COMPLETE SYSTEM**

```javascript
// Essential missing endpoints:
GET /class/:id                    // Get single class details
DELETE /class/:id                 // Delete class
GET /class/:classId/users         // Get enrolled users
GET /user/:userId/classes         // Get user's classes
DELETE /class/assign              // Unenroll user
GET /class/:classId/enrollment    // Check enrollment status
```

## 🔧 **RECOMMENDED IMPROVEMENTS**

### **1. Add Role-Based Authorization**
- Admin: Full class management
- Instructor: Manage assigned classes
- Student: View enrolled classes only

### **2. Implement Enrollment Management**
- Enrollment status tracking
- Class capacity limits
- Prerequisites checking
- Enrollment periods

### **3. Enhanced Content Organization**
- Content ordering/sequencing
- Progress tracking
- Completion requirements
- Content type categorization

The class system has clean architecture but **critical security gaps**. The lack of authentication on core routes means anyone can create, modify, or view all classes. This needs immediate attention before production deployment.

Would you like me to help create secure, fixed versions of these endpoints with proper authentication and authorization?









# Chat Routes System Analysis - Complete Endpoint Mapping

## System Overview
**Base Path:** `/api/chat/*`  
**Authentication:** All routes require `authenticate` middleware  
**File Upload:** Routes with media support use `uploadMiddleware` + `uploadToS3`  
**Primary Purpose:** Chat/messaging system with media support and content management

---

## 💬 CHAT RETRIEVAL ENDPOINTS

### 1. GET `/api/chat/` - Fetch All Chats
**Route:** `router.get('/', authenticate, fetchAllChats)`
- **Controller:** `fetchAllChats()` in chatControllers.js
- **Service:** `getAllChats()` in chatServices.js
- **Purpose:** Retrieve all chats for dashboard/feed display
- **Database Table:** `chats`
- **Query:** 
  ```sql
  SELECT *, prefixed_id FROM chats ORDER BY updatedAt DESC
  ```
- **Frontend Usage:** Chat feed, main dashboard, chat lists
- **Dependencies:** 
  - `authenticate` middleware from '../middlewares/auth.middleware.js'
  - `db` from '../config/db.js'
- **Returns:** Array of all chats with prefixed IDs

### 2. GET `/api/chat/user` - Fetch Chats by User ID
**Route:** `router.get('/user', authenticate, fetchChatsByUserId)`
- **Controller:** `fetchChatsByUserId()` in chatControllers.js
- **Service:** `getChatsByUserId()` in chatServices.js
- **Purpose:** Get chats created by specific user
- **Database Table:** `chats`
- **Query:** 
  ```sql
  SELECT *, prefixed_id FROM chats WHERE user_id = ? ORDER BY updatedAt DESC
  ```
- **Frontend Usage:** User profile pages, "My Chats" sections
- **Dependencies:** 
  - `authenticate` middleware
  - `db` from '../config/db.js'
- **Parameters:** `user_id` from query string
- **Returns:** User-specific chats with prefixed IDs

### 3. GET `/api/chat/ids` - Fetch Chats by Multiple IDs
**Route:** `router.get('/ids', authenticate, fetchChatsByIds)`
- **Controller:** `fetchChatsByIds()` in chatControllers.js
- **Service:** `getChatsByIds()` in chatServices.js
- **Purpose:** Retrieve specific chats by ID list (bulk fetch)
- **Database Table:** `chats`
- **Query:** 
  ```sql
  -- Dynamic query based on ID type
  SELECT *, prefixed_id FROM chats WHERE id IN (?) ORDER BY updatedAt DESC
  -- OR
  SELECT *, prefixed_id FROM chats WHERE prefixed_id IN (?) ORDER BY updatedAt DESC
  ```
- **Frontend Usage:** Bookmark systems, chat collections, selected chat views
- **Dependencies:** 
  - `authenticate` middleware
  - `db` from '../config/db.js'
- **Parameters:** `ids` as comma-separated string in query
- **Special Feature:** Supports both numeric and prefixed IDs automatically

### 4. GET `/api/chat/prefixed/:prefixedId` - Fetch Chat by Prefixed ID
**Route:** `router.get('/prefixed/:prefixedId', authenticate, fetchChatByPrefixedId)`
- **Controller:** `fetchChatByPrefixedId()` in chatControllers.js
- **Service:** `getChatByPrefixedId()` in chatServices.js
- **Purpose:** Get single chat using prefixed ID system
- **Database Table:** `chats`
- **Query:** 
  ```sql
  SELECT *, prefixed_id FROM chats WHERE prefixed_id = ?
  ```
- **Frontend Usage:** Direct chat links, shared chat URLs, permalink systems
- **Dependencies:** 
  - `authenticate` middleware
  - `db` from '../config/db.js'
- **Parameters:** `prefixedId` from URL params
- **Returns:** Single chat object or 404 if not found

### 5. GET `/api/chat/combinedcontent` - Fetch Combined Content
**Route:** `router.get('/combinedcontent', authenticate, fetchCombinedContent)`
- **Controller:** `fetchCombinedContent()` in chatControllers.js
- **Service:** `getCombinedContent()` in chatServices.js
- **Purpose:** Get unified feed of chats and teachings together
- **Database Tables:** `chats` + `teachings`
- **Queries:** 
  ```sql
  -- Chats query
  SELECT *, prefixed_id, 'chat' as content_type, 
         title as content_title, 
         createdAt as content_createdAt, 
         updatedAt as content_updatedAt
  FROM chats ORDER BY updatedAt DESC
  
  -- Teachings query
  SELECT *, prefixed_id, 'teaching' as content_type,
         topic as content_title,
         createdAt as content_createdAt,
         updatedAt as content_updatedAt
  FROM teachings ORDER BY updatedAt DESC
  ```
- **Frontend Usage:** Unified content feeds, mixed content dashboards
- **Dependencies:** 
  - `authenticate` middleware
  - `db` from '../config/db.js'
- **Processing:** Combines results and sorts by most recent update
- **Returns:** Unified array with content type indicators and counts

### 6. GET `/api/chat/:userId1/:userId2` - Get Chat History Between Users
**Route:** `router.get('/:userId1/:userId2', authenticate, getChatHistory)`
- **Controller:** `getChatHistory()` in chatControllers.js
- **Service:** `getChatHistoryService()` in chatServices.js
- **Purpose:** Retrieve conversation history between two specific users
- **Database Table:** `chats`
- **Query:** 
  ```sql
  SELECT * FROM chats
  WHERE (created_by = ? AND audience = ?)
     OR (created_by = ? AND audience = ?)
  ORDER BY updatedAt ASC
  ```
- **Frontend Usage:** Private messaging interfaces, conversation views
- **Dependencies:** 
  - `authenticate` middleware
  - `db` from '../config/db.js'
- **Parameters:** `userId1` and `userId2` from URL params
- **⚠️ NAMING ISSUE:** Uses `created_by` in query but table uses `user_id`

---

## ✍️ CHAT CREATION & MODIFICATION ENDPOINTS

### 7. POST `/api/chat/` - Create New Chat
**Route:** `router.post('/', authenticate, uploadMiddleware, uploadToS3, createChat)`
- **Controller:** `createChat()` in chatControllers.js
- **Service:** `createChatService()` in chatServices.js
- **Purpose:** Create new chat with optional media attachments
- **Database Table:** `chats`
- **Query:** 
  ```sql
  INSERT INTO chats (title, user_id, audience, summary, text, approval_status, 
                     media_url1, media_type1, media_url2, media_type2, 
                     media_url3, media_type3, is_flagged)
  VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
  ```
- **Frontend Usage:** Chat creation forms, post creation interfaces
- **Dependencies:** 
  - `authenticate` middleware
  - `uploadMiddleware` from '../middlewares/upload.middleware.js'
  - `uploadToS3` from '../middlewares/upload.middleware.js'
  - `db` from '../config/db.js'
- **Media Support:** Up to 3 media files (images/videos)
- **Processing:** Files uploaded to S3, URLs stored in database
- **⚠️ PARAMETER MISMATCH:** Controller sends `created_by` but service expects `user_id`

### 8. PUT `/api/chat/:id` - Update Chat by ID
**Route:** `router.put('/:id', authenticate, editChat)`
- **Controller:** `editChat()` in chatControllers.js
- **Service:** `updateChatById()` in chatServices.js
- **Purpose:** Update existing chat content and metadata
- **Database Table:** `chats`
- **Query:** 
  ```sql
  UPDATE chats
  SET title = ?, summary = ?, text = ?, 
      media_url1 = ?, media_type1 = ?, media_url2 = ?, media_type2 = ?, 
      media_url3 = ?, media_type3 = ?, approval_status = ?, 
      is_flagged = ?, updatedAt = NOW()
  WHERE id = ?
  ```
- **Frontend Usage:** Chat edit forms, content moderation interfaces
- **Dependencies:** 
  - `authenticate` middleware
  - `db` from '../config/db.js'
- **Parameters:** `id` from URL params
- **⚠️ MISSING UPLOAD:** No upload middleware but handles media data

### 9. DELETE `/api/chat/:id` - Delete Chat by ID
**Route:** `router.delete('/:id', authenticate, removeChat)`
- **Controller:** `removeChat()` in chatControllers.js
- **Service:** `deleteChatById()` in chatServices.js
- **Purpose:** Permanently delete chat and associated data
- **Database Table:** `chats`
- **Query:** 
  ```sql
  DELETE FROM chats WHERE id = ?
  ```
- **Frontend Usage:** Delete buttons, admin moderation tools
- **Dependencies:** 
  - `authenticate` middleware
  - `db` from '../config/db.js'
- **Parameters:** `id` from URL params
- **⚠️ MISSING CLEANUP:** No cascade delete for comments or media cleanup

---

## 💭 COMMENT SYSTEM ENDPOINTS

### 10. POST `/api/chat/:chatId/comments` - Add Comment to Chat
**Route:** `router.post('/:chatId/comments', authenticate, uploadMiddleware, uploadToS3, addCommentToChat)`
- **Controller:** `addCommentToChat()` in chatControllers.js
- **Service:** `addCommentToChatService()` in chatServices.js
- **Purpose:** Add comment with optional media to existing chat
- **Database Table:** `comments`
- **Query:** 
  ```sql
  INSERT INTO comments (user_id, chat_id, comment, 
                        media_url1, media_type1, media_url2, media_type2, 
                        media_url3, media_type3)
  VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
  ```
- **Frontend Usage:** Comment forms, chat interaction interfaces
- **Dependencies:** 
  - `authenticate` middleware
  - `uploadMiddleware` from '../middlewares/upload.middleware.js'
  - `uploadToS3` from '../middlewares/upload.middleware.js'
  - `db` from '../config/db.js'
- **Parameters:** `chatId` from URL params
- **Media Support:** Up to 3 media files per comment

---

## 🔍 DATABASE SCHEMA ANALYSIS

### Primary Tables Used

#### `chats` Table
```sql
-- Core Fields
id, prefixed_id, title, user_id, audience, summary, text

-- Media Support (up to 3 files)
media_url1, media_type1, media_url2, media_type2, media_url3, media_type3

-- Moderation
approval_status, is_flagged

-- Timestamps
createdAt, updatedAt
```

#### `comments` Table
```sql
-- Core Fields
id, user_id, chat_id, comment

-- Media Support (up to 3 files)
media_url1, media_type1, media_url2, media_type2, media_url3, media_type3

-- Timestamps
createdAt, updatedAt (assumed)
```

#### `teachings` Table
```sql
-- Used in combined content
id, prefixed_id, topic, createdAt, updatedAt
-- Other fields present but not specified in queries
```

---

## 🔄 DATA FLOW ANALYSIS

### Chat Creation Flow
```
Frontend Form → Upload Files → S3 Storage → POST /chat/ → createChat() 
→ createChatService() → INSERT to chats → Return prefixed_id
```

### Chat Retrieval Flow
```
Frontend Request → GET /chat/ → fetchAllChats() → getAllChats() 
→ SELECT from chats → Return with prefixed_id
```

### Comment Addition Flow
```
Frontend Comment → Upload Media → S3 → POST /:chatId/comments → addCommentToChat() 
→ addCommentToChatService() → INSERT to comments → Return comment data
```

### Combined Content Flow
```
Frontend Dashboard → GET /combinedcontent → fetchCombinedContent() 
→ getCombinedContent() → SELECT from chats + teachings → Merge & Sort → Return unified feed
```

---

## 🚨 IDENTIFIED ISSUES & CONFLICTS

### Critical Parameter Mismatches
1. **Create Chat Field Mapping:**
   ```javascript
   // Controller sends
   created_by: userId
   
   // Service expects and uses
   user_id: created_by  // Wrong field name in INSERT
   ```

2. **Chat History Query Mismatch:**
   ```sql
   -- Uses created_by in WHERE clause
   WHERE (created_by = ? AND audience = ?)
   
   -- But table likely has user_id column
   ```

### Database Query Issues
1. **Inconsistent Array Destructuring:**
   ```javascript
   // Some queries use array destructuring
   const [rows] = await db.query(...)
   
   // Others don't
   const rows = await db.query(...)
   ```

2. **Missing Cascade Deletes:**
   - Chat deletion doesn't remove associated comments
   - No cleanup of S3 media files when deleting chats/comments

### Route Conflicts & Ambiguity
1. **Route Order Issues:**
   ```javascript
   // These routes could conflict:
   router.get('/user', ...) // GET /chat/user
   router.get('/ids', ...)  // GET /chat/ids
   router.get('/:userId1/:userId2', ...) // Could match /chat/user or /chat/ids
   ```

2. **Parameter Ambiguity:**
   - `/chat/:userId1/:userId2` could match other single-param routes
   - No validation to ensure these are actually user IDs

### Missing Features
1. **No Chat Retrieval by Comments:** Can add comments but no endpoint to fetch them
2. **No Pagination:** Large chat lists could cause performance issues
3. **No Search/Filter:** No way to search chats by content
4. **No Real-time Updates:** No WebSocket or polling mechanism

### Security Issues
1. **No Authorization Checks:** Users can access any chat regardless of ownership
2. **No Input Validation:** No validation middleware on any routes
3. **No Rate Limiting:** No protection against spam or abuse

---

## 📊 EXTERNAL DEPENDENCIES ANALYSIS

### Middleware Dependencies
```javascript
// Authentication
import { authenticate } from '../middlewares/auth.middleware.js'

// File Upload
import { uploadMiddleware, uploadToS3 } from '../middlewares/upload.middleware.js'
```

### Service Dependencies
```javascript
// Database
import db from '../config/db.js'

// Error Handling
import CustomError from '../utils/CustomError.js'
```

### Media Storage Flow
```
Client Upload → uploadMiddleware → S3 Upload → Store URLs in DB
```

---

## 🎯 IMMEDIATE FIXES REQUIRED

### 1. Fix Parameter Mismatches (CRITICAL)
```javascript
// In createChatService - fix field mapping
const sql = `
  INSERT INTO chats (title, user_id, audience, summary, text, ...)
  VALUES (?, ?, ?, ?, ?, ...)
`;
// Use created_by as user_id consistently
```

### 2. Fix Query Inconsistencies
```javascript
// Standardize array destructuring based on your db.query() return format
const rows = await db.query(...) // If this is the working format
```

### 3. Add Route Validation
```javascript
// Add parameter validation
router.get('/:userId1/:userId2', 
  authenticate, 
  validateUserIds, // New middleware
  getChatHistory
);
```

### 4. Add Missing Endpoints
```javascript
// Add comment retrieval
router.get('/:chatId/comments', authenticate, fetchChatComments);

// Add pagination
router.get('/', authenticate, addPagination, fetchAllChats);
```

---

## 🔄 RECOMMENDED ARCHITECTURE IMPROVEMENTS

### 1. Add Authorization Layer
- Check if user can access/modify specific chats
- Implement role-based permissions

### 2. Add Input Validation
- Validate chat content length
- Validate media file types and sizes
- Sanitize user input

### 3. Implement Pagination
- Add limit/offset parameters
- Return pagination metadata

### 4. Add Search & Filtering
- Search by title, content, user
- Filter by date, status, media presence

### 5. Improve Error Handling
- Standardize error response format
- Add detailed error logging
- Handle edge cases (empty results, invalid IDs)

### 6. Add Comment Management
- Endpoint to fetch chat comments
- Comment editing/deletion
- Comment moderation

The chat system has solid core functionality but needs parameter fixes and additional features for production readiness. The media upload integration is well-designed, but the route structure could be optimized to prevent conflicts.


I'll analyze your chat routes system and create a comprehensive mapping to help you understand the flow and identify any issues or conflicts.I've completed a comprehensive analysis of your chat routes system. Here are the **critical findings**:

## 🚨 **CRITICAL ISSUES IDENTIFIED**

### 1. **Parameter Mapping Errors (BREAKS FUNCTIONALITY)**
Your chat creation has a critical field mismatch:
```javascript
// Controller sends:
const newChat = await createChatService({
  created_by,  // Field name from request
  ...
});

// But Service INSERT uses:
INSERT INTO chats (title, user_id, ...)  // Different field name!
VALUES (?, created_by, ...)               // Wrong variable mapping
```

### 2. **Database Query Inconsistencies** 
```javascript
// Mixed array destructuring patterns:
const [rows] = await db.query(...)  // Some places
const rows = await db.query(...)    // Other places
```

### 3. **Route Conflict Potential**
```javascript
router.get('/user', ...)                    // /chat/user
router.get('/ids', ...)                     // /chat/ids  
router.get('/:userId1/:userId2', ...)       // Could match above routes!
```

## 📊 **SYSTEM ARCHITECTURE OVERVIEW**

### **Database Tables:**
- **Primary:** `chats` (main content storage)
- **Secondary:** `comments` (chat interactions)
- **Integrated:** `teachings` (combined content feature)

### **Media Handling:**
- **Upload Flow:** `uploadMiddleware` → S3 storage → Database URLs
- **Support:** Up to 3 media files per chat/comment
- **⚠️ Issue:** Edit chat route lacks upload middleware but expects media

### **ID System:**
- **Dual Support:** Both numeric IDs and prefixed IDs
- **Smart Detection:** Automatically determines ID type in queries
- **Frontend Friendly:** Prefixed IDs for public-facing URLs

## 🔄 **DATA FLOW PATTERNS**

### **Content Creation:**
```
Frontend → Upload Media → S3 → Create Chat → Store URLs → Return Prefixed ID
```

### **Content Retrieval:**
```
Frontend → Authenticate → Query Database → Return with Prefixed IDs
```

### **Combined Content Feature:**
```
Frontend Dashboard → Query Chats + Teachings → Merge → Sort by Date → Unified Feed
```

## 🎯 **FRONTEND INTEGRATION POINTS**

Your routes serve these frontend components:
- **Chat Feeds** (`/` - main dashboard)
- **User Profiles** (`/user` - personal chats)
- **Direct Links** (`/prefixed/:id` - shareable URLs)
- **Chat Collections** (`/ids` - bookmark systems)
- **Unified Dashboards** (`/combinedcontent` - mixed content)
- **Messaging Interfaces** (`/:userId1/:userId2` - conversations)
- **Comment Systems** (`/:chatId/comments` - interactions)

## 🚨 **IMMEDIATE FIXES NEEDED**

### **1. Fix Parameter Mapping (CRITICAL)**
```javascript
// In createChatService - align field names
INSERT INTO chats (title, user_id, audience, ...)
VALUES (?, ?, ?, ...)
// Pass created_by as user_id parameter
```

### **2. Standardize Database Queries**
```javascript
// Choose one pattern consistently
const rows = await db.query(...) // If this works
// OR
const [rows] = await db.query(...) // If this works
```

### **3. Add Route Validation**
```javascript
// Prevent route conflicts with validation
router.get('/:userId1/:userId2', 
  validateNumericParams,  // Ensure these are numbers
  authenticate, 
  getChatHistory
);
```

### **4. Add Missing Upload Middleware**
```javascript
// Fix edit route
router.put('/:id', 
  authenticate, 
  uploadMiddleware,    // ADD THIS
  uploadToS3,          // ADD THIS
  editChat
);
```

## 🔧 **MISSING FEATURES FOR PRODUCTION**

1. **Comment Retrieval:** Can add comments but no way to fetch them
2. **Authorization:** No ownership checks - users can access any chat
3. **Pagination:** Could cause performance issues with large datasets
4. **Search/Filter:** No way to find specific chats
5. **Cascade Deletes:** Deleting chats doesn't clean up comments or S3 files

The chat system has excellent media integration and a clever dual-ID system, but the parameter mapping errors could completely break chat creation. Would you like me to help create fixed versions of the problematic endpoints?










# Authentication Routes System Analysis - Complete Endpoint Mapping

## System Overview
**Base Path:** `/api/auth/*`  
**Authentication:** Only `/` route requires `authenticate` middleware  
**Security:** Uses bcrypt for password hashing, JWT for tokens

---

## 🔐 AUTHENTICATION ENDPOINTS

### 1. POST `/api/auth/register` - User Registration
**Route:** `router.post('/register', registerUser)`
- **Controller:** `registerUser()` in authControllers.js
- **Service:** `registerUserService()` in authServices.js
- **Purpose:** Create new user account with email verification
- **Database Table:** `users`
- **Query:** 
  ```sql
  -- Check existing user
  SELECT * FROM users WHERE email = ?
  
  -- Insert new user
  INSERT INTO users (username, email, password_hash, phone, role, is_member) 
  VALUES (?, ?, ?, ?, false, false)
  ```
- **Frontend Usage:** Registration forms, signup pages
- **Dependencies:** 
  - `bcrypt` for password hashing
  - `generateToken` from '../utils/jwt.js'
  - `sendEmail` from '../utils/email.js'
  - `db` from '../config/db.js'
- **External Actions:** 
  - Sends welcome email
  - Sets HTTP-only cookie with JWT token
  - Returns redirect to application survey
- **⚠️ ISSUES:**
  - Variable name mismatch: `user_id` vs `userId` in token generation
  - SQL syntax error in registration query structure

### 2. POST `/api/auth/login` - User Login
**Route:** `router.post('/login', loginUser)`
- **Controller:** `loginUser()` in authControllers.js
- **Service:** `loginUserService()` in authServices.js
- **Purpose:** Authenticate user and generate JWT token
- **Database Table:** `users`
- **Query:** 
  ```sql
  SELECT * FROM users WHERE email = ?
  ```
- **Frontend Usage:** Login forms, authentication modals
- **Dependencies:** 
  - `bcrypt` for password comparison
  - `jwt` for token generation
  - `db` from '../config/db.js'
- **External Actions:** 
  - Sets HTTP-only cookie with JWT token
  - Returns success message and token
- **Token Payload:**
  ```javascript
  {
    user_id: user.id,
    email: user.email,
    role: user.role,
    isVerified: user.isVerified,
    isConfirmed: user.isConfirmed
  }
  ```

### 3. GET `/api/auth/logout` - User Logout
**Route:** `router.get('/logout', logoutUser)`
- **Controller:** `logoutUser()` in authControllers.js
- **Service:** No service layer (direct implementation)
- **Purpose:** Clear authentication cookie and logout user
- **Database Table:** None
- **Frontend Usage:** Logout buttons, session termination
- **Dependencies:** None
- **External Actions:** 
  - Clears 'token' cookie
- **⚠️ ISSUE:** Cookie name mismatch - sets 'access_token' but clears 'token'

---

## 🔄 PASSWORD RESET ENDPOINTS

### 4. POST `/api/auth/passwordreset/request` - Request Password Reset
**Route:** `router.post('/passwordreset/request', requestPasswordReset)`
- **Controller:** `requestPasswordReset()` in authControllers.js
- **Service:** `sendPasswordResetEmailOrSMS()` in authServices.js
- **Purpose:** Send password reset link via email or SMS
- **Database Table:** `users`
- **Queries:** 
  ```sql
  -- Find user by email or phone
  SELECT * FROM users WHERE email = ? 
  -- OR
  SELECT * FROM users WHERE phone = ?
  
  -- Store reset token
  UPDATE users SET resetToken = ?, resetTokenExpiry = ? WHERE id = ?
  ```
- **Frontend Usage:** "Forgot Password" forms, password recovery flows
- **Dependencies:** 
  - `crypto` for token generation
  - `sendEmail` from '../utils/email.js'
  - `sendSMS` from '../utils/sms.js'
  - `db` from '../config/db.js'
- **External Actions:** 
  - Sends email with reset link
  - OR sends SMS with reset link
  - Generates 1-hour expiry token

### 5. POST `/api/auth/passwordreset/reset` - Reset Password
**Route:** `router.post('/passwordreset/reset', resetPassword)`
- **Controller:** `resetPassword()` in authControllers.js
- **Service:** `updatePassword()` + `generateVerificationCode()` in authServices.js
- **Purpose:** Update user password and send verification code to alternate medium
- **Database Table:** `users`
- **Queries:** 
  ```sql
  -- Find user
  SELECT * FROM users WHERE email = ? OR phone = ?
  
  -- Update password
  UPDATE users SET password_hash = ?, resetToken = NULL, resetTokenExpiry = NULL WHERE id = ?
  
  -- Store verification code
  UPDATE users SET verificationCode = ?, codeExpiry = ? WHERE email/phone = ?
  ```
- **Frontend Usage:** Password reset forms, new password submission
- **Dependencies:** 
  - `bcrypt` for password hashing
  - `crypto` for verification code generation
  - `sendEmail` and `sendSMS` for code delivery
  - `db` from '../config/db.js'
- **External Actions:** 
  - Updates password with bcrypt hashing
  - Sends verification code via alternate medium (email→SMS, phone→email)
- **⚠️ ISSUE:** References undefined `user` variable when sending verification

### 6. POST `/api/auth/passwordreset/verify` - Verify Password Reset
**Route:** `router.post('/passwordreset/verify', verifyPasswordReset)`
- **Controller:** `verifyPasswordReset()` in authControllers.js
- **Service:** `verifyResetCode()` in authServices.js
- **Purpose:** Verify the code sent to alternate medium after password reset
- **Database Table:** `users`
- **Queries:** 
  ```sql
  -- Find user
  SELECT * FROM users WHERE email = ? OR phone = ?
  
  -- Clear verification code
  UPDATE users SET verificationCode = NULL, codeExpiry = NULL WHERE id = ?
  ```
- **Frontend Usage:** Verification code input forms, 2FA completion
- **Dependencies:** 
  - `db` from '../config/db.js'
- **External Actions:** 
  - Validates verification code against database
  - Checks code expiry (1 hour limit)
  - Clears verification data on success

---

## ✅ USER VERIFICATION ENDPOINTS

### 7. GET `/api/auth/verify/:token` - Verify User Email
**Route:** `router.get('/verify/:token', verifyUser)`
- **Controller:** `verifyUser()` in authControllers.js
- **Service:** No service layer (direct implementation)
- **Purpose:** Verify user email using token parameter
- **Database Table:** `users`
- **Queries:** 
  ```sql
  -- Find user by email (using token as email)
  SELECT * FROM users WHERE email = ?
  
  -- Update membership status
  UPDATE users SET is_member = 'pending' WHERE email = ?
  ```
- **Frontend Usage:** Email verification links, account activation
- **Dependencies:** 
  - `db` from '../config/db.js'
- **External Actions:** 
  - Redirects to application survey page
- **⚠️ CRITICAL ISSUES:**
  - Uses email as token parameter (security risk)
  - SQL syntax error: `is_member: pending` should be `is_member = 'pending'`
  - No actual token verification mechanism

### 8. GET `/api/auth/` - Get Authenticated User
**Route:** `router.get('/', authenticate, getAuthenticatedUser)`
- **Controller:** `getAuthenticatedUser()` in authControllers.js
- **Service:** No service layer (direct implementation)
- **Purpose:** Return current authenticated user data
- **Database Table:** None (uses token data)
- **Frontend Usage:** User profile pages, authentication state checks
- **Dependencies:** 
  - `authenticate` middleware from '../middlewares/auth.middleware.js'
- **External Actions:** 
  - Sets CORS headers for credentials
  - Returns user data from JWT token

---

## 🔍 DETAILED FLOW ANALYSIS

### Registration Flow
```
Frontend Form → POST /register → registerUser() → registerUserService() 
→ Hash Password → Insert User → Send Welcome Email → Generate JWT → Set Cookie → Redirect to Survey
```

### Login Flow
```
Frontend Form → POST /login → loginUser() → loginUserService() 
→ Validate Password → Generate JWT → Set Cookie → Return Success
```

### Password Reset Flow
```
1. Request: Frontend → POST /passwordreset/request → Generate Reset Token → Send Email/SMS
2. Reset: Frontend → POST /passwordreset/reset → Update Password → Send Verification Code
3. Verify: Frontend → POST /passwordreset/verify → Validate Code → Complete Reset
```

### Authentication Check Flow
```
Frontend Request → GET / → authenticate middleware → getAuthenticatedUser() → Return User Data
```

---

## 🚨 CRITICAL ISSUES IDENTIFIED

### Security Vulnerabilities
1. **Email as Token:** `/verify/:token` uses email address as token (major security risk)
2. **Cookie Inconsistency:** Sets 'access_token' but clears 'token' cookie
3. **No Token Validation:** Email verification has no actual token mechanism
4. **Undefined Variables:** `user` variable referenced but not defined in password reset

### Database Issues
1. **SQL Syntax Error:** `is_member: pending` should be `is_member = 'pending'`
2. **Inconsistent Column Names:** `password_hash` vs potential `password` confusion
3. **Missing Indexes:** No mention of indexes on email/phone for performance

### Architectural Problems
1. **Mixed Service Usage:** Some controllers bypass services entirely
2. **Variable Name Conflicts:** `user_id` vs `userId` mismatch
3. **Inconsistent Error Handling:** Different error response formats
4. **Missing Validation:** No input validation middleware

### Missing Features
1. **Rate Limiting:** No protection against brute force attacks
2. **Account Lockout:** No mechanism for failed login attempts
3. **Token Refresh:** No refresh token mechanism
4. **Audit Logging:** No tracking of authentication events

---

## 📊 DATABASE SCHEMA ANALYSIS

### Users Table Columns Used
```sql
-- Core Authentication
id, username, email, password_hash, phone, role, is_member

-- Verification & Reset
resetToken, resetTokenExpiry, verificationCode, codeExpiry
isVerified, isConfirmed

-- Timestamps
createdAt (assumed)
```

### External Dependencies Summary
```javascript
// Cryptography & Security
import bcrypt from 'bcrypt'
import jwt from 'jsonwebtoken'
import crypto from 'crypto'

// Communication
import nodemailer from 'nodemailer'  // via sendEmail utility
// SMS service via sendSMS utility

// Database & Utils
import db from '../config/db.js'
import { sendEmail } from '../utils/email.js'
import { sendSMS } from '../utils/sms.js'
import { generateToken } from '../utils/jwt.js'
import CustomError from '../utils/CustomError.js'

// Middleware
import { authenticate } from '../middlewares/auth.middleware.js'
```

---

## 🎯 IMMEDIATE FIXES REQUIRED

### 1. Security Fixes (CRITICAL)
```javascript
// Fix email verification - use proper tokens
const verificationToken = crypto.randomBytes(32).toString('hex');
// Store token in database, not email as parameter

// Fix cookie naming consistency
res.clearCookie('access_token'); // Match what's being set
```

### 2. Database Query Fixes
```sql
-- Fix SQL syntax
UPDATE users SET is_member = 'pending' WHERE email = ?
```

### 3. Variable Fixes
```javascript
// Fix variable naming in registerUser
const user = { user_id: userId, email, is_member: false, role: false };
```

### 4. Missing Error Handling
- Add try-catch blocks consistently
- Implement proper error response format
- Add input validation middleware

### 5. Add Missing Features
- Implement proper token-based email verification
- Add rate limiting middleware
- Implement account lockout mechanism
- Add refresh token support

## 🔄 RECOMMENDED REFACTOR PRIORITIES

1. **Fix security vulnerabilities** (email verification token system)
2. **Standardize error handling** across all endpoints
3. **Add input validation** middleware
4. **Implement rate limiting** for auth endpoints
5. **Add comprehensive logging** for security events
6. **Create consistent service layer** for all operations
7. **Add proper token refresh** mechanism
8. **Implement account lockout** after failed attempts



I'll analyze your authentication routes system and create a comprehensive mapping similar to the admin routes analysis. This will help you understand the auth flow and identify any issues.I've completed a comprehensive analysis of your authentication routes system. Here are the **critical findings**:

## 🚨 **CRITICAL SECURITY VULNERABILITIES**

### 1. **Email Verification Security Flaw**
Your `/verify/:token` endpoint uses the **email address as the token parameter**, which is a major security risk:
```javascript
// DANGEROUS: Uses email as token
router.get('/verify/:token', verifyUser)
// In controller: req.params.token contains the email
```
This allows anyone to verify any email if they know the address.

### 2. **Cookie Name Inconsistency**
```javascript
// Sets cookie as 'access_token'
res.cookie('access_token', token, { httpOnly: true });

// But clears cookie as 'token' 
res.clearCookie('token'); // WRONG NAME!
```

### 3. **SQL Syntax Error**
```javascript
// BROKEN SQL
const updateSql = "UPDATE users SET is_member: pending WHERE email=?";
// Should be: is_member = 'pending'
```

## 🔍 **ARCHITECTURAL ISSUES**

### **Inconsistent Service Layer Usage**
- `registerUser` & `loginUser` → Use services ✅
- `verifyUser` & `logoutUser` → Bypass services ❌
- `getAuthenticatedUser` → No service needed ✅

### **Variable Name Conflicts**
```javascript
// In registerUser controller
const userId = await registerUserService(...);
const user = { user_id, email, ... }; // user_id is undefined!
// Should be: { user_id: userId, ... }
```

### **Undefined Variable Reference**
In `resetPassword` controller:
```javascript
await sendSMS(user.phone, message); // 'user' is not defined!
await sendEmail(user.email, subject, text); // 'user' is not defined!
```

## 📊 **Database Interaction Summary**

### **Primary Table:** `users`
- **Registration:** INSERT new user with hashed password
- **Login:** SELECT user for authentication 
- **Password Reset:** UPDATE reset tokens and passwords
- **Verification:** UPDATE membership status

### **Missing Tables/Features:**
- No audit logging for auth events
- No session management table
- No rate limiting tracking
- No account lockout mechanism

## 🔄 **Authentication Flow Analysis**

### **Registration Flow Issues:**
```
Form → Register → Hash Password → Insert DB → Send Email → Generate Token → ❌ Variable Mismatch → Set Cookie
```

### **Login Flow (Working):**
```
Form → Login → Validate Password → Generate JWT → Set Cookie → Success ✅
```

### **Password Reset Flow Issues:**
```
Request → Generate Token → Send Link → ❌ Undefined Variables → Update Password → Send Code → Verify
```

### **Email Verification (BROKEN):**
```
Email Link → ❌ Uses Email as Token → ❌ SQL Syntax Error → Update Status
```

## 🎯 **IMMEDIATE ACTION REQUIRED**

### **1. Fix Security Vulnerabilities (CRITICAL)**
```javascript
// Generate proper verification tokens
const verificationToken = crypto.randomBytes(32).toString('hex');
// Store in database, send in email link
```

### **2. Fix Cookie Inconsistency**
```javascript
res.clearCookie('access_token'); // Match what's being set
```

### **3. Fix SQL Syntax**
```javascript
const updateSql = "UPDATE users SET is_member = 'pending' WHERE email = ?";
```

### **4. Fix Variable References**
```javascript
// In registerUser
const user = { user_id: userId, email, is_member: false, role: false };

// In resetPassword - get user data first
const userData = await getUserByEmailOrPhone(emailOrPhone);
```

## 📋 **Frontend Integration Points**

Your auth routes serve these frontend components:
- **Registration forms** (`/register`)
- **Login pages** (`/login`) 
- **Password reset flows** (`/passwordreset/*`)
- **Email verification links** (`/verify/:token`)
- **Authentication state checks** (`/`)
- **Logout functionality** (`/logout`)

## 🔧 **Dependencies & External Services**

### **Security & Crypto:**
- `bcrypt` - Password hashing ✅
- `jwt` - Token generation ✅ 
- `crypto` - Random token generation ✅

### **Communication:**
- Email service via `sendEmail` utility ✅
- SMS service via `sendSMS` utility ✅

### **Database:**
- MySQL/MariaDB via `db.query()` ✅

The authentication system has **critical security flaws** that need immediate attention. The email verification vulnerability could allow unauthorized account access. Would you like me to help you create secure, fixed versions of these endpoints?









# Admin Routes System Analysis - Complete Endpoint Mapping

## System Overview
**Base Path:** `/api/admin/*`  
**Authentication:** All routes require `authenticate` + `authorize(['admin', 'super_admin'])`  
**Caching:** Some routes use `cacheMiddleware(600)` - 10 minute cache

---

## 🔧 USER MANAGEMENT ENDPOINTS

### 1. GET `/api/admin/users` - Get All Users
**Route:** `router.get('/users', cacheMiddleware(600), getUsers)`
- **Controller:** `getUsers()` in adminControllers.js
- **Service:** `getUsersService()` in adminServices.js
- **Purpose:** Fetch all users for admin dashboard display
- **Database Table:** `users`
- **Query:** 
  ```sql
  SELECT id, username, email, phone, role, membership_stage, is_member,
         converse_id, mentor_id, primary_class_id as class_id, 
         isblocked, isbanned, createdAt, full_membership_status, 
         is_identity_masked, total_classes
  FROM users ORDER BY createdAt DESC
  ```
- **Frontend Usage:** Admin user management dashboard, user listing components
- **Dependencies:** 
  - `db` from '../config/db.js'
  - `cacheMiddleware` from auth.middleware.js

### 2. PUT `/api/admin/users/:id` - Update User Status
**Route:** `router.put('/users/:id', updateUserById)`
- **Controller:** `updateUserById()` in adminControllers.js
- **Service:** `updateUserByIdService()` in adminServices.js
- **Purpose:** Update user blocking/banning status specifically
- **Database Table:** `users`
- **Query:** 
  ```sql
  UPDATE users SET isblocked = ?, isbanned = ? WHERE id = ?
  ```
- **Frontend Usage:** Quick ban/block toggles in user lists
- **Dependencies:** `db` from '../config/db.js'

### 3. POST `/api/admin/users/update` - Enhanced User Update
**Route:** `router.post('/users/update', updateUser)`
- **Controller:** `updateUser()` in adminControllers.js
- **Service:** `updateUserService()` in adminServices.js
- **Purpose:** Update multiple user fields (rating, userclass, etc.)
- **Database Table:** `users`
- **Query:** Dynamic UPDATE based on provided fields
- **Frontend Usage:** User profile editing forms, bulk user updates
- **Dependencies:** `db` from '../config/db.js'
- **⚠️ CONFLICT:** Alternative route `PUT /update-user/:id` does the same thing

### 4. POST `/api/admin/users/ban` - Ban User
**Route:** `router.post('/users/ban', banUser)`
- **Controller:** `banUser()` in adminControllers.js
- **Service:** `banUserService()` in adminServices.js
- **Purpose:** Ban a user with reason
- **Database Table:** `users`
- **Query:** 
  ```sql
  UPDATE users SET isbanned = true, postingRight = "banned", 
         ban_reason = ?, banned_at = NOW() WHERE id = ?
  ```
- **Frontend Usage:** User moderation panels, report handling
- **Dependencies:** `db` from '../config/db.js'
- **⚠️ CONFLICT:** Legacy route `/ban-user/:id` duplicates this

### 5. POST `/api/admin/users/unban` - Unban User
**Route:** `router.post('/users/unban', unbanUser)`
- **Controller:** `unbanUser()` in adminControllers.js
- **Service:** `unbanUserService()` in adminServices.js
- **Purpose:** Remove ban from user
- **Database Table:** `users`
- **Query:** 
  ```sql
  UPDATE users SET isbanned = false, postingRight = "active", 
         ban_reason = NULL, banned_at = NULL WHERE id = ?
  ```
- **Frontend Usage:** User moderation panels, appeals handling
- **Dependencies:** `db` from '../config/db.js'
- **⚠️ CONFLICT:** Legacy route `/unban-user/:id` duplicates this

### 6. POST `/api/admin/users/grant` - Grant Posting Rights
**Route:** `router.post('/users/grant', grantPostingRights)`
- **Controller:** `grantPostingRights()` in adminControllers.js
- **Service:** `grantPostingRightsService()` in adminServices.js
- **Purpose:** Grant posting privileges to users
- **Database Table:** `users`
- **Query:** 
  ```sql
  UPDATE users SET postingRight = "active", 
         posting_rights_granted_at = NOW() WHERE id = ?
  ```
- **Frontend Usage:** User approval workflows, membership management
- **Dependencies:** `db` from '../config/db.js'
- **⚠️ CONFLICT:** Legacy route `/grant-posting-rights/:id` duplicates this

### 7. GET/POST `/api/admin/users/manage` - Bulk User Management
**Route:** `router.get('/users/manage', manageUsers)` & `router.post('/users/manage', manageUsers)`
- **Controller:** `manageUsers()` in adminControllers.js
- **Service:** `manageUsersService()` in adminServices.js
- **Purpose:** 
  - GET: List all users for management
  - POST: Bulk operations (ban, unban, grant/revoke membership)
- **Database Table:** `users`
- **Queries:** Various based on action (bulk_ban, bulk_unban, bulk_grant_membership, etc.)
- **Frontend Usage:** Bulk user management interfaces, admin dashboards
- **Dependencies:** 
  - `db` from '../config/db.js'
  - Calls other services: `banUserService`, `unbanUserService`

### 8. POST `/api/admin/create-user` - Create New User
**Route:** `router.post('/create-user', createUser)`
- **Controller:** `createUser()` in adminControllers.js
- **Service:** Direct database query (no service layer)
- **Purpose:** Admin creation of new user accounts
- **Database Table:** `users`
- **Query:** 
  ```sql
  INSERT INTO users (username, email, password, role, is_member) 
  VALUES (?, ?, ?, ?, ?)
  ```
- **Frontend Usage:** Admin user creation forms
- **Dependencies:** `db` from '../config/db.js'
- **⚠️ SECURITY ISSUE:** Password not hashed before storage

### 9. DELETE `/api/admin/delete-user/:id` - Delete User
**Route:** `router.delete('/delete-user/:id', deleteUser)`
- **Controller:** `deleteUser()` in adminControllers.js
- **Service:** Direct database query (no service layer)
- **Purpose:** Permanently delete user account
- **Database Table:** `users`
- **Query:** `DELETE FROM users WHERE id = ?`
- **Frontend Usage:** User management panels (dangerous operation)
- **Dependencies:** `db` from '../config/db.js'

### 10. POST `/api/admin/mask-identity` - Mask User Identity
**Route:** `router.post('/mask-identity', maskUserIdentity)`
- **Controller:** `maskUserIdentity()` in adminControllers.js
- **Service:** Direct database query (no service layer)
- **Purpose:** Anonymize user for privacy/security
- **Database Table:** `users`
- **Query:** 
  ```sql
  UPDATE users SET converse_id = ?, mentor_id = ?, 
         primary_class_id = ?, is_identity_masked = true WHERE id = ?
  ```
- **Frontend Usage:** Privacy/security management tools
- **Dependencies:** `db` from '../config/db.js'

---

## 📝 CONTENT MANAGEMENT ENDPOINTS

### 11. GET `/api/admin/content/pending` - Get Pending Content
**Route:** `router.get('/content/pending', getPendingContent)`
- **Controller:** `getPendingContent()` in adminControllers.js
- **Service:** `getPendingContentService()` in adminServices.js
- **Purpose:** Fetch content awaiting moderation approval
- **Database Table:** `content`
- **Query:** `SELECT * FROM content WHERE approval_status = "pending"`
- **Frontend Usage:** Content moderation queues, review dashboards
- **Dependencies:** `db` from '../config/db.js'
- **⚠️ CONFLICT:** Legacy route `/pending-content` duplicates this

### 12. GET/POST `/api/admin/content` - Manage Content
**Route:** `router.get('/content', manageContent)` & `router.post('/content/manage', manageContent)`
- **Controller:** `manageContent()` in adminControllers.js
- **Service:** `manageContentService()` in adminServices.js
- **Purpose:** 
  - GET: List all content for management
  - POST: Bulk content operations (approve, reject, delete)
- **Database Table:** `content`
- **Queries:** Various based on action (bulk_approve, bulk_reject, bulk_delete)
- **Frontend Usage:** Content management dashboards, bulk moderation tools
- **Dependencies:** 
  - `db` from '../config/db.js'
  - Calls: `approveContentService`, `rejectContentService`

### 13. POST `/api/admin/content/approve/:id` - Approve Content
**Route:** `router.post('/content/approve/:id', approveContent)`
- **Controller:** `approveContent()` in adminControllers.js
- **Service:** `approveContentService()` in adminServices.js
- **Purpose:** Approve individual content for publication
- **Database Table:** `content`
- **Query:** 
  ```sql
  UPDATE content SET approval_status = "approved", 
         approved_at = NOW(), admin_notes = ? WHERE id = ?
  ```
- **Frontend Usage:** Content review interfaces, moderation tools
- **Dependencies:** `db` from '../config/db.js'
- **⚠️ CONFLICT:** Legacy route `/approve-content/:id` duplicates this

### 14. POST `/api/admin/content/reject/:id` - Reject Content
**Route:** `router.post('/content/reject/:id', rejectContent)`
- **Controller:** `rejectContent()` in adminControllers.js
- **Service:** `rejectContentService()` in adminServices.js
- **Purpose:** Reject content with admin notes
- **Database Table:** `content`
- **Query:** 
  ```sql
  UPDATE content SET approval_status = "rejected", 
         rejected_at = NOW(), admin_notes = ? WHERE id = ?
  ```
- **Frontend Usage:** Content review interfaces, moderation tools
- **Dependencies:** `db` from '../config/db.js'
- **⚠️ CONFLICT:** Legacy route `/reject-content/:id` duplicates this

---

## 📊 REPORTS MANAGEMENT ENDPOINTS

### 15. GET `/api/admin/reports` - Get All Reports
**Route:** `router.get('/reports', cacheMiddleware(600), getReports)`
- **Controller:** `getReports()` in adminControllers.js
- **Service:** `getReportsService()` in adminServices.js
- **Purpose:** Fetch user reports for moderation review
- **Database Table:** `reports`
- **Query:** 
  ```sql
  SELECT id, reported_id, reporter_id, reason, status, createdAt
  FROM reports WHERE status = "pending" ORDER BY createdAt DESC
  ```
- **Frontend Usage:** Report management dashboards, moderation queues
- **Dependencies:** 
  - `db` from '../config/db.js'
  - `cacheMiddleware` from auth.middleware.js

### 16. PUT `/api/admin/update-report/:reportId` - Update Report Status
**Route:** `router.put('/update-report/:reportId', updateReportStatus)`
- **Controller:** `updateReportStatus()` in adminControllers.js
- **Service:** Direct database query (no service layer)
- **Purpose:** Update report status and add admin notes
- **Database Table:** `reports`
- **Query:** 
  ```sql
  UPDATE reports SET status = ?, admin_notes = ? WHERE id = ?
  ```
- **Frontend Usage:** Report handling interfaces, moderation workflows
- **Dependencies:** `db` from '../config/db.js'

---

## 👨‍🏫 MENTORS MANAGEMENT ENDPOINTS

### 17. GET `/api/admin/mentors` - Get All Mentors
**Route:** `router.get('/mentors', getMentors)`
- **Controller:** `getMentors()` in adminControllers.js
- **Service:** `getMentorsService()` in adminServices.js
- **Purpose:** Fetch users with mentor/admin roles
- **Database Table:** `users`
- **Query:** 
  ```sql
  SELECT id, username, email, converse_id, role, 
         primary_class_id as class_id, total_classes, createdAt
  FROM users WHERE role IN ('admin', 'super_admin', 'mentor') 
                OR converse_id IS NOT NULL
  ORDER BY role DESC, username ASC
  ```
- **Frontend Usage:** Mentor management interfaces, assignment tools
- **Dependencies:** `db` from '../config/db.js'

---

## 📋 AUDIT LOGS ENDPOINTS

### 18. GET `/api/admin/audit-logs` - Get Audit Logs
**Route:** `router.get('/audit-logs', getAuditLogs)`
- **Controller:** `getAuditLogs()` in adminControllers.js
- **Service:** `getAuditLogsService()` in adminServices.js
- **Purpose:** Fetch system audit trail for admin actions
- **Database Table:** `audit_logs` (may not exist - returns empty array)
- **Query:** 
  ```sql
  SELECT id, action, target_id, details, createdAt 
  FROM audit_logs ORDER BY createdAt DESC LIMIT 100
  ```
- **Frontend Usage:** System monitoring, compliance tracking
- **Dependencies:** `db` from '../config/db.js'
- **⚠️ ISSUE:** Table may not exist, needs graceful handling

---

## 🔧 UTILITY ENDPOINTS

### 19. POST `/api/admin/send-notification` - Send Notification
**Route:** `router.post('/send-notification', sendNotification)`
- **Controller:** `sendNotification()` in adminControllers.js
- **Service:** No implementation (placeholder)
- **Purpose:** Send notifications to users
- **Database Table:** None (not implemented)
- **Frontend Usage:** Notification management interfaces
- **Dependencies:** None currently
- **⚠️ ISSUE:** Not implemented - just returns success

### 20. GET `/api/admin/export-users` - Export User Data
**Route:** `router.get('/export-users', exportUserData)`
- **Controller:** `exportUserData()` in adminControllers.js
- **Service:** Uses `getUsersService()` then transforms data
- **Purpose:** Export user data for reports/compliance
- **Database Table:** `users` (via getUsersService)
- **Frontend Usage:** Data export tools, reporting interfaces
- **Dependencies:** 
  - `getUsersService` from adminServices.js
  - `db` from '../config/db.js'

---

## 🚨 IDENTIFIED ISSUES & CONFLICTS

### Duplicate Routes (Legacy Compatibility)
1. **User Banning:**
   - `/users/ban` vs `/ban-user/:id`
   - `/users/unban` vs `/unban-user/:id`
   - `/users/grant` vs `/grant-posting-rights/:id`

2. **Content Management:**
   - `/content/pending` vs `/pending-content`
   - `/content/approve/:id` vs `/approve-content/:id`
   - `/content/reject/:id` vs `/reject-content/:id`

3. **User Updates:**
   - `/users/update` vs `/update-user/:id`

### Security Issues
1. **Password Hashing:** `createUser` stores unhashed passwords
2. **Input Validation:** Missing validation in most endpoints
3. **SQL Injection:** Some direct queries without proper sanitization

### Architectural Issues
1. **Inconsistent Service Layer:** Some controllers bypass services
2. **Mixed Responsibilities:** Some services handle multiple concerns
3. **Error Handling:** Inconsistent error response formats
4. **Caching:** Only applied to some GET endpoints

### Database Dependencies
- **Primary Tables:** `users`, `content`, `reports`, `audit_logs`
- **Missing Tables:** `audit_logs` table may not exist
- **Schema Issues:** Mixed column naming conventions

### External Dependencies
```javascript
// Required imports across the system:
import express from 'express'
import db from '../config/db.js'
import { v4 as uuidv4 } from 'uuid'
import { 
  authenticate, 
  authorize, 
  cacheMiddleware 
} from '../middlewares/auth.middleware.js'
```

## 🎯 Recommendations

1. **Remove Duplicate Routes:** Eliminate legacy routes, standardize on one pattern
2. **Implement Security:** Add password hashing, input validation, rate limiting
3. **Standardize Service Layer:** Move all database operations to services
4. **Add Audit Logging:** Implement proper audit trail for all admin actions
5. **Improve Error Handling:** Standardize error response format
6. **Add Input Validation:** Implement request validation middleware
7. **Database Optimization:** Add indexes, optimize queries
8. **Documentation:** Add comprehensive API documentation



I'll analyze your admin routes system and create a comprehensive mapping from routes to services, including their purposes, database interactions, and dependencies. This will help you debug, identify conflicts, and optimize your system.I've created a comprehensive analysis of your admin routes system. Here are the key findings:

## **Major Issues Identified:**

### 🔴 **Critical Conflicts & Duplications**
Your system has **significant route duplication** with legacy compatibility routes that create confusion:
- **3 duplicate user management patterns** (ban/unban/grant)
- **3 duplicate content management patterns** (approve/reject/pending)
- **2 different user update mechanisms**

### 🔴 **Security Vulnerabilities**
1. **Password Storage:** `createUser` stores unhashed passwords directly
2. **Missing Input Validation:** No validation middleware on any routes
3. **Potential SQL Injection:** Some direct queries bypass parameterization

### 🔴 **Architectural Inconsistencies**
1. **Service Layer Bypass:** Several controllers (createUser, deleteUser, maskUserIdentity) skip the service layer entirely
2. **Mixed Database Access:** Some operations go direct to DB, others through services
3. **Inconsistent Error Handling:** Different error response formats across endpoints

## **Database Interaction Summary:**
- **Primary Tables:** `users`, `content`, `reports`, `audit_logs`
- **Main Operations:** CRUD on users, content moderation, report management
- **Missing Infrastructure:** `audit_logs` table may not exist

## **Frontend Integration Points:**
Your routes serve these likely frontend components:
- Admin dashboards (`/users`, `/reports`, `/mentors`)
- User management interfaces (`/users/manage`, bulk operations)
- Content moderation queues (`/content/pending`, `/content/manage`)
- Report handling systems (`/reports`, `/update-report`)

## **Immediate Action Items:**
1. **Remove duplicate routes** - choose one pattern and stick to it
2. **Implement password hashing** in `createUser`
3. **Add input validation middleware** to all routes
4. **Move all DB operations** to service layer
5. **Standardize error responses** across all endpoints
6. **Create audit_logs table** if it doesn't exist

Would you like me to help you create a refactored version that eliminates these conflicts and implements proper security measures?








# Complete API System Analysis - Full Route Architecture Overview

## System Overview
**Base URL:** `/api/*`  
**API Version:** 1.0.0  
**Architecture:** Modular microservice-style with clean separation  
**Database:** MySQL with custom wrapper  
**Security:** JWT-based authentication with role-based authorization

---

## 🏗️ COMPLETE ROUTE ARCHITECTURE

### **Core System Modules** (11 Main Route Groups)

```
/api/
├── auth/           → Authentication & Authorization System
├── membership/     → Membership Application Management  
├── survey/         → Survey & Application Management
├── teachings/      → Educational Content Management
├── users/          → User Profile & Management
├── chats/          → Chat & Communication Content
├── comments/       → Comment System (Cross-module)
├── communication/  → Email & SMS System
├── admin/          → Administrative Functions
├── classes/        → Class Management System
├── identity/       → Identity Masking & Privacy
└── [system]/       → Health, Docs, Info endpoints
```

---

## 📊 COMPLETE ENDPOINT MAPPING SUMMARY

### 1. **Authentication System** (`/api/auth/*`)
**Routes Analyzed:** ✅ **8 endpoints**
- **Purpose:** User authentication, registration, password management
- **Database Tables:** `users`
- **External Services:** Email, SMS for verification
- **Security Issues:** 🚨 Email-as-token vulnerability, cookie name inconsistency
- **Frontend Integration:** Login forms, registration, password reset flows

### 2. **Admin Management System** (`/api/admin/*`)  
**Routes Analyzed:** ✅ **20+ endpoints**
- **Purpose:** User management, content moderation, reporting
- **Database Tables:** `users`, `content`, `reports`, `audit_logs`
- **Security Issues:** 🚨 Duplicate routes, missing input validation
- **Frontend Integration:** Admin dashboards, user management, content moderation

### 3. **Chat System** (`/api/chats/*`)
**Routes Analyzed:** ✅ **11 endpoints**
- **Purpose:** Chat content, combined content feeds, media support
- **Database Tables:** `chats`, `teachings`, `comments`
- **Critical Issues:** 🚨 Parameter mapping errors in creation
- **Frontend Integration:** Chat feeds, content creation, media upload

### 4. **Class Management** (`/api/classes/*`)
**Routes Analyzed:** ✅ **5 endpoints**
- **Purpose:** Educational class management, enrollment
- **Database Tables:** `classes`, `user_classes`, `content`
- **Security Issues:** 🚨 No authentication on core routes
- **Frontend Integration:** Class catalogs, enrollment systems, content delivery

### 5. **Comment System** (`/api/comments/*`)
**Routes Analyzed:** ✅ **10 endpoints**
- **Purpose:** Cross-platform commenting with media support
- **Database Tables:** `comments`, `users`, `chats`, `teachings`
- **Security Issues:** ⚠️ Missing admin authorization on some routes
- **Frontend Integration:** Comment threads, media upload, user activity

### 6. **Communication System** (`/api/communication/*`)
**Routes Analyzed:** ✅ **9 endpoints**
- **Purpose:** Multi-channel email/SMS with templates and bulk operations
- **Database Tables:** `email_logs`, `sms_logs`, `bulk_*_logs`
- **External Services:** Email providers, SMS providers
- **Security Status:** ✅ Excellent authorization and rate limiting
- **Frontend Integration:** Messaging forms, admin communication tools

### 7. **Identity Masking System** (`/api/identity/*`)
**Routes Analyzed:** ✅ **4 endpoints**
- **Purpose:** Privacy protection with encryption and anonymization
- **Database Tables:** `users`, `user_profiles`, `converse_relationships`, `identity_masking_audit`
- **Security Status:** ✅ Enterprise-grade AES-256-GCM encryption
- **Minor Issue:** ⚠️ Missing ownership validation on read endpoints
- **Frontend Integration:** Admin privacy tools, anonymous class systems

---

## 📋 MISSING ROUTE ANALYSIS

### **Routes Referenced but Not Analyzed:**

#### 8. **Membership System** (`/api/membership/*`)
**Status:** 🔍 **Referenced but not provided**
- **Expected Purpose:** Membership application workflow
- **Likely Endpoints:** Application submission, status checking, admin approval
- **Frontend Integration:** Membership application forms, status dashboards

#### 9. **Survey System** (`/api/survey/*`)  
**Status:** 🔍 **Referenced but not provided**
- **Expected Purpose:** Survey management and submission
- **Likely Endpoints:** Survey questions, submission, analytics
- **Frontend Integration:** Survey forms, admin analytics

#### 10. **Teaching System** (`/api/teachings/*`)
**Status:** 🔍 **Referenced but not provided**  
- **Expected Purpose:** Educational content management
- **Likely Endpoints:** Content CRUD, search, statistics
- **Frontend Integration:** Content creation, teaching materials

#### 11. **User System** (`/api/users/*`)
**Status:** 🔍 **Referenced but not provided**
- **Expected Purpose:** User profile and management
- **Likely Endpoints:** Profile management, user statistics
- **Frontend Integration:** User profiles, admin user management

---

## 🔗 CROSS-SYSTEM INTEGRATIONS & DEPENDENCIES

### **Major System Interconnections:**

#### **Comment System Hub** (Central Integration Point)
```
Comments ←→ Chats (chat_id foreign key)
Comments ←→ Teachings (teaching_id foreign key)  
Comments ←→ Users (user_id foreign key)
Comments ←→ Identity (converse_id relationships)
```

#### **User Identity Flow**
```
Auth Registration → Survey Application → Membership Review → Identity Masking → Class Assignment
```

#### **Content Ecosystem**
```
Chats + Teachings → Combined Content API → Comments → Communication Notifications
```

#### **Admin Control Flow**
```
Admin Routes → User Management → Content Moderation → Communication → Identity Management
```

---

## 🔐 SECURITY ARCHITECTURE ANALYSIS

### **Authentication Hierarchy:**
1. **Public Routes:** Health, docs, info, some auth endpoints
2. **Authenticated Routes:** Most user-facing endpoints
3. **Admin Routes:** User/content management, statistics
4. **Super Admin Routes:** Identity unmasking, critical operations

### **Authorization Patterns:**
```javascript
// Pattern 1: Basic Authentication
router.use(authenticate)

// Pattern 2: Role-Based Authorization  
router.use(authenticate, requireAdmin)
router.use(authenticate, requireSuperAdmin)

// Pattern 3: Enhanced Authorization (Communication System)
router.use(authenticate, roleCheck, templateValidation)
```

### **Security Status by Module:**
- ✅ **Communication:** Excellent (proper authorization, rate limiting)
- ✅ **Identity:** Excellent (enterprise-grade encryption)
- ⚠️ **Comments:** Good (needs admin authorization fixes)
- 🚨 **Auth:** Critical issues (email-as-token vulnerability)
- 🚨 **Admin:** Critical issues (duplicate routes, missing validation)
- 🚨 **Classes:** Critical issues (no authentication on core routes)
- ⚠️ **Chats:** Parameter mapping issues

---

## 🗃️ DATABASE SCHEMA OVERVIEW

### **Core Tables by System:**

#### **User Management Tables:**
```sql
users                    -- Core user data with identity masking support
user_profiles           -- Encrypted original identity storage
converse_relationships  -- Anonymous mentoring relationships
identity_masking_audit  -- Privacy operation audit trail
```

#### **Content Management Tables:**
```sql
chats                   -- Chat content with prefixed IDs
teachings              -- Educational content  
content                -- Generic content (used by multiple systems)
comments               -- Cross-system commenting
```

#### **System Management Tables:**
```sql
classes                -- Educational classes
user_classes          -- Enrollment relationships
reports               -- User reporting system
email_logs           -- Communication tracking
sms_logs             -- SMS tracking
bulk_*_logs          -- Bulk operation tracking
```

#### **Missing/Expected Tables:**
```sql
surveys              -- Survey management (referenced but not seen)
survey_responses     -- Survey submissions
membership_applications -- Application workflow
audit_logs           -- General system audit (referenced in admin)
```

---

## 🔄 COMPLEX DATA FLOWS

### **User Onboarding Journey:**
```
1. Registration (Auth) → 
2. Email Verification (Auth + Communication) → 
3. Survey Submission (Survey) → 
4. Admin Review (Admin + Membership) → 
5. Identity Masking (Identity) → 
6. Class Assignment (Classes) → 
7. Anonymous Participation (Chats + Comments)
```

### **Content Interaction Flow:**
```
1. Content Creation (Chats/Teachings) → 
2. Combined Feed (Chat System) → 
3. User Comments (Comment System) → 
4. Admin Moderation (Admin System) → 
5. Notifications (Communication System)
```

### **Privacy Protection Flow:**
```
1. Membership Granted (Admin) → 
2. Identity Encryption (Identity) → 
3. Converse ID Generation (Identity) → 
4. Anonymous Relationships (Identity) → 
5. Privacy-Protected Interactions (All Systems)
```

---

## 🚨 CRITICAL SYSTEM-WIDE ISSUES

### **1. Authentication & Security Vulnerabilities**
```javascript
// CRITICAL: Email-as-token in auth system
GET /auth/verify/:token  // Uses email as token parameter

// CRITICAL: No authentication on class management
POST /classes/           // Anyone can create classes
PUT /classes/:id         // Anyone can modify classes

// CRITICAL: Parameter mapping errors
// Chat creation field mismatches could break functionality
```

### **2. Route Conflicts & Duplications**
```javascript
// Admin route duplications:
/admin/users/ban vs /admin/ban-user/:id
/admin/content/approve/:id vs /admin/approve-content/:id
/admin/users/update vs /admin/update-user/:id
```

### **3. Authorization Inconsistencies**
```javascript
// Inconsistent authorization patterns:
Comments: Some admin-only, some missing checks
Classes: No auth on core operations
Identity: Missing ownership validation
```

---

## 🎯 FRONTEND INTEGRATION MAPPING

### **Frontend Components → API Endpoints:**

#### **Authentication Flows:**
- Login Forms → `POST /auth/login`
- Registration → `POST /auth/register`  
- Password Reset → `POST /auth/passwordreset/*`

#### **User Dashboards:**
- Profile Management → `GET/PUT /users/profile`
- Activity History → `GET /comments/user/:id`
- Membership Status → `GET /membership/dashboard`

#### **Content Interfaces:**
- Content Creation → `POST /chats/`, `POST /teachings/`
- Combined Feeds → `GET /chats/combinedcontent`
- Comment Threads → `GET /comments/parent-comments`

#### **Admin Interfaces:**
- User Management → `GET /admin/users`, `PUT /admin/users/:id`
- Content Moderation → `GET /admin/content/pending`
- Analytics → `GET /admin/reports`, `GET /communication/stats`

#### **Communication Tools:**
- Messaging → `POST /communication/email/send`
- Bulk Operations → `POST /communication/email/bulk`
- Template Selection → `GET /communication/templates`

---

## 🔧 EXTERNAL DEPENDENCIES SUMMARY

### **By System Module:**

#### **Authentication System:**
- `bcrypt` (password hashing)
- `jwt` (token generation)
- `crypto` (reset tokens)
- Email/SMS services

#### **Communication System:**
- Email providers (SendGrid, AWS SES)
- SMS providers (Twilio, AWS SNS)
- Template engines

#### **Identity System:**
- `crypto` (AES-256-GCM encryption)
- Avatar generation API (dicebear)
- Unique ID generation utilities

#### **File Upload Systems:**
- AWS S3 integration
- Upload middleware chains
- Media type validation

---

## 🎯 IMMEDIATE FIXES REQUIRED

### **Priority 1: Critical Security (URGENT)**
1. **Fix email-as-token vulnerability** in auth system
2. **Add authentication** to class management routes
3. **Fix parameter mapping errors** in chat creation
4. **Remove duplicate admin routes**

### **Priority 2: Authorization Consistency (HIGH)**
1. **Add admin checks** to comment system stats/all endpoints
2. **Add ownership validation** to identity system reads
3. **Standardize authorization patterns** across all modules

### **Priority 3: System Optimization (MEDIUM)**
1. **Implement input validation** middleware system-wide
2. **Add rate limiting** to sensitive endpoints
3. **Create unified error response** format
4. **Add comprehensive audit logging**

---

## 🔄 RECOMMENDED SYSTEM ENHANCEMENTS

### **1. Unified Middleware Stack:**
```javascript
// Standardized middleware chain
router.use(requestLogging)
router.use(rateLimiting)  
router.use(inputValidation)
router.use(authenticate)
router.use(authorize(roles))
router.use(auditLogging)
```

### **2. API Gateway Pattern:**
```javascript
// Central request handling
/api/v1/* → Gateway → Route to appropriate microservice
```

### **3. Comprehensive Monitoring:**
```javascript
// System-wide monitoring
- Performance metrics per endpoint
- Error rate tracking  
- Security incident logging
- User activity analytics
```

---

## 🏆 SYSTEM STRENGTHS

### **Excellent Architecture:**
- ✅ Clean modular separation
- ✅ Sophisticated privacy protection (Identity system)
- ✅ Comprehensive communication system
- ✅ Rich commenting with media support
- ✅ Flexible combined content approach

### **Advanced Features:**
- ✅ Enterprise-grade encryption (Identity masking)
- ✅ Multi-channel communication (Email + SMS)
- ✅ Cross-system commenting integration
- ✅ Anonymous collaboration capability
- ✅ Comprehensive audit trails

### **Production-Ready Elements:**
- ✅ Health monitoring endpoints
- ✅ Comprehensive API documentation
- ✅ Proper error handling patterns
- ✅ Role-based security architecture

---

## 📈 OVERALL ASSESSMENT

**Architecture Quality:** 8/10 ⭐  
**Security Implementation:** 6/10 ⚠️ (varies by module)  
**Feature Completeness:** 9/10 ⭐  
**Production Readiness:** 7/10 ⚠️ (needs security fixes)

### **Summary:**
This is a **sophisticated, feature-rich API system** with excellent architectural design and advanced privacy features. The identity masking system represents world-class privacy engineering, and the communication system demonstrates enterprise-grade capabilities.

**Critical Path to Production:**
1. Fix authentication vulnerabilities (auth system)
2. Secure class management routes  
3. Resolve parameter mapping issues (chat system)
4. Standardize authorization patterns
5. Implement comprehensive input validation

With these fixes, this system would be production-ready for a high-security, privacy-focused educational platform with advanced collaboration features.


I'll analyze your main route index file and create a comprehensive system-wide analysis that ties together all the endpoints we've examined. This will give you a complete picture of your API architecture.I've completed a comprehensive analysis of your entire API system based on the main route index and all the individual route systems we've examined. Here are the **key findings**:

## 🏗️ **COMPLETE SYSTEM ARCHITECTURE**

Your API represents a **sophisticated educational/collaboration platform** with 11 main modules:

### **Analyzed Systems (8/11):**
✅ **Authentication** - JWT-based auth with critical security issues  
✅ **Admin** - Comprehensive management with duplicate route issues  
✅ **Chats** - Content system with parameter mapping problems  
✅ **Classes** - Educational management with missing security  
✅ **Comments** - Cross-system integration with minor auth gaps  
✅ **Communication** - Enterprise-grade email/SMS system  
✅ **Identity** - World-class privacy protection with encryption  
✅ **System Routes** - Health, docs, debugging endpoints

### **Referenced but Not Analyzed (3/11):**
🔍 **Membership** - Application workflow management  
🔍 **Survey** - Survey and application system  
🔍 **Teachings** - Educational content management  
🔍 **Users** - User profile management

## 🌟 **EXCEPTIONAL FEATURES**

### **1. Advanced Privacy Architecture**
```javascript
// WORLD-CLASS: Identity masking with AES-256-GCM encryption
Original Identity → AES-256-GCM → Anonymous Converse ID → Privacy-Protected Collaboration
```

### **2. Enterprise Communication System**
```javascript
// PRODUCTION-READY: Multi-channel communication
Email + SMS + Templates + Bulk Operations + Rate Limiting + Comprehensive Logging
```

### **3. Sophisticated Content Ecosystem**
```javascript
// INNOVATIVE: Cross-system integration
Chats + Teachings → Combined API → Comments → Notifications → Identity Protection
```

## 🚨 **CRITICAL ISSUES REQUIRING IMMEDIATE ATTENTION**

### **Priority 1: Security Vulnerabilities (URGENT)**
```javascript
// CRITICAL: Authentication system flaws
❌ Email-as-token vulnerability in /auth/verify/:token
❌ Cookie name inconsistency (sets 'access_token', clears 'token')
❌ SQL syntax errors in verification process

// CRITICAL: Unprotected class management
❌ No authentication on POST /classes/ (anyone can create classes)
❌ No authentication on PUT /classes/:id (anyone can modify)

// CRITICAL: Parameter mapping errors
❌ Chat creation field mismatch (created_by vs user_id)
```

### **Priority 2: System Inconsistencies (HIGH)**
```javascript
// AUTHORIZATION GAPS:
⚠️ Comment system: /all endpoint missing admin check
⚠️ Identity system: Missing ownership validation on reads
⚠️ Admin system: Massive route duplication

// ROUTE CONFLICTS:
⚠️ /admin/users/ban vs /admin/ban-user/:id (3+ duplicate patterns)
```

## 🔄 **COMPLEX DATA FLOWS**

### **User Journey (Most Complex):**
```
Registration → Email Verification → Survey Application → Admin Review → 
Identity Masking → Class Assignment → Anonymous Collaboration
```

### **Content Interaction Flow:**
```
Content Creation → Combined Feeds → Cross-System Comments → 
Admin Moderation → Multi-Channel Notifications
```

### **Privacy Protection Flow:**
```
Membership Grant → AES-256-GCM Encryption → Converse ID → 
Anonymous Relationships → Privacy-Protected Learning
```

## 🎯 **FRONTEND INTEGRATION POINTS**

Your API serves these sophisticated interfaces:
- **Authentication Systems** (login, registration, password management)
- **Admin Dashboards** (user management, content moderation, analytics)
- **Anonymous Learning Platforms** (privacy-protected classes and mentoring)
- **Multi-Channel Communication** (email/SMS with templates)
- **Rich Content Systems** (combined feeds, media upload, commenting)

## 📊 **DATABASE ARCHITECTURE**

### **Core Table Groups:**
- **Identity Management:** `users`, `user_profiles`, `converse_relationships`
- **Content Ecosystem:** `chats`, `teachings`, `comments`, `content`
- **System Operations:** `email_logs`, `sms_logs`, `classes`, `reports`
- **Audit & Compliance:** `identity_masking_audit`, various log tables

## 🏆 **OVERALL ASSESSMENT**

### **Architecture Quality: 9/10** ⭐
- Excellent modular design
- Sophisticated cross-system integration
- Advanced privacy engineering

### **Security Implementation: 6/10** ⚠️
- Varies dramatically by module
- Communication & Identity: Excellent
- Auth & Classes: Critical vulnerabilities

### **Feature Sophistication: 10/10** ⭐
- Enterprise-grade privacy protection
- Multi-channel communication
- Anonymous collaboration capability
- Rich content management

### **Production Readiness: 7/10** ⚠️
- Needs critical security fixes
- Excellent monitoring and documentation
- Strong foundation with fixable issues

## 🎯 **IMMEDIATE ACTION PLAN**

### **Week 1: Critical Security Fixes**
1. Fix email-as-token vulnerability in auth system
2. Add authentication to all class management routes
3. Fix parameter mapping in chat creation
4. Remove duplicate admin routes

### **Week 2: Authorization Standardization**
1. Add admin checks to comment system
2. Add ownership validation to identity reads
3. Implement unified authorization middleware
4. Add comprehensive input validation

### **Week 3: System Optimization**
1. Implement rate limiting system-wide
2. Add unified error response format
3. Enhance audit logging
4. Performance optimization

## 🌟 **CONCLUSION**

This represents **exceptional API engineering** with world-class privacy features and enterprise-grade communication systems. The identity masking system alone demonstrates sophisticated understanding of privacy engineering and cryptographic best practices.

**With the critical security fixes addressed, this system would be production-ready for:**
- High-security educational platforms
- Privacy-protected collaboration tools
- Anonymous mentoring systems
- Enterprise communication platforms

The architecture is sound, the features are advanced, and the foundation is solid. The identified issues are fixable and don't require architectural changes - just security patches and consistency improvements.

Would you like me to help create the specific fixes for the critical security vulnerabilities, or would you prefer to focus on any particular system module?





























/* ikootaclient/src/components/towncrier/towncrier.css - FIXED */

/* ================================================
   MAIN TOWNCRIER CONTAINER - FIXED
   ================================================ */

.towncrier_container {
  display: flex;
  flex-direction: column;
  height: 100vh;
  width: 100%;
  overflow: hidden;
  background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
  position: relative;
}

/* ================================================
   NAVIGATION AND FOOTER
   ================================================ */

.nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 15px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  flex-wrap: wrap;
  gap: 8px;
  flex-shrink: 0;
  z-index: 10;
}

.footnote {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 15px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  font-size: 0.75em;
  flex-wrap: wrap;
  gap: 8px;
  border-top: 1px solid rgba(255,255,255,0.1);
  min-height: 40px;
  flex-shrink: 0;
  z-index: 10;
}

/* ================================================
   MAIN VIEWPORT - FIXED BACKGROUND COVERAGE
   ================================================ */

.towncrier_viewport {
  display: flex;
  flex: 1;
  overflow: hidden;
  background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
  min-height: 0;
  position: relative;
}

/* Ensure background covers entire viewport */
.towncrier_viewport::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
  z-index: -1;
}

/* ================================================
   REVTOPIC CONTAINER
   ================================================ */

.revtopic-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  height: 100%;
  border-right: 2px solid #ddd;
  background: linear-gradient(180deg, #f8f8f8 0%, #e8e8e8 100%);
  overflow: hidden;
  position: relative;
}

/* ================================================
   REVTEACHING CONTAINER - FIXED BACKGROUND
   ================================================ */

.revTeaching-container {
  flex: 3;
  display: flex;
  flex-direction: column;
  height: 100%;
  background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
  overflow: hidden;
  position: relative;
}

/* Ensure RevTeaching background extends fully */
.revTeaching-container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
  z-index: -1;
}

.teaching-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  height: 100%;
  overflow-y: auto;
  padding: 20px;
  background:rgba(0, 0, 0, 0.74); /* Let the container background show */
  position: relative;
  z-index: 1;
}

/* ================================================
   NAVIGATION ELEMENTS
   ================================================ */

.nav-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.nav-right {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

.user-status, .member-status {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.85em;
}

.user-info {
  background: rgba(255,255,255,0.1);
  padding: 3px 6px;
  border-radius: 10px;
  font-size: 0.8em;
}

.status-badge {
  padding: 2px 5px;
  border-radius: 6px;
  font-size: 0.7em;
  font-weight: bold;
}

.status-badge.loading {
  background: #ffa726;
  color: white;
}

.status-badge.error {
  background: #ef5350;
  color: white;
}

.status-badge.member {
  background: #4caf50;
  color: white;
}

.status-badge.pending {
  background: #ff9800;
  color: white;
}

.admin-badge {
  background: #9c27b0;
  color: white;
  padding: 2px 4px;
  border-radius: 6px;
  font-size: 0.7em;
  margin-left: 4px;
}

.content-count {
  background: rgba(255,255,255,0.1);
  padding: 3px 6px;
  border-radius: 6px;
  font-size: 0.75em;
}

.refresh-btn {
  padding: 4px 8px;
  border: none;
  border-radius: 12px;
  background: #607d8b;
  color: white;
  cursor: pointer;
  font-size: 0.7em;
  transition: all 0.2s ease;
}

.refresh-btn:hover {
  background: #455a64;
  transform: scale(1.05);
}

/* ================================================
   MEMBERSHIP BANNERS
   ================================================ */

.membership-banner {
  background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
  color: white;
  padding: 15px;
  margin: 0;
  flex-shrink: 0;
  z-index: 5;
}

.banner-content {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 20px;
  max-width: 1200px;
  margin: 0 auto;
}

.banner-text h3 {
  margin-bottom: 8px;
  font-size: 18px;
}

.banner-text p {
  margin: 0;
  opacity: 0.9;
  font-size: 14px;
  line-height: 1.4;
}

.membership-application-btn {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: 2px solid rgba(255, 255, 255, 0.3);
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  white-space: nowrap;
}

.membership-application-btn:hover {
  background: rgba(255, 255, 255, 0.3);
  border-color: rgba(255, 255, 255, 0.5);
  transform: translateY(-1px);
}

.access-level-info {
  background: rgba(236, 240, 241, 0.95);
  padding: 12px 15px;
  flex-shrink: 0;
  z-index: 5;
}

.access-content {
  max-width: 1200px;
  margin: 0 auto;
}

.full-member-info, .pre-member-info, .applicant-info {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 14px;
}

.access-icon {
  font-size: 20px;
}

.access-btn {
  background: #27ae60;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: 500;
  margin-left: auto;
  transition: background 0.3s ease;
}

.access-btn:hover {
  background: #219a52;
}

.access-restrictions {
  display: flex;
  gap: 15px;
  margin-left: auto;
}

.restriction {
  font-size: 12px;
  color: #e74c3c;
}

/* ================================================
   FOOTER CONTROLS
   ================================================ */

.footer-left, .footer-center, .footer-right {
  display: flex;
  align-items: center;
  gap: 8px;
}

.footer-center {
  flex: 1;
  justify-content: center;
}

.activity-indicator {
  display: flex;
  align-items: center;
  gap: 10px;
}

.online-status {
  background: rgba(76,175,80,0.2);
  padding: 2px 6px;
  border-radius: 8px;
  border: 1px solid #4caf50;
  font-size: 0.7em;
}

.footer-controls {
  display: flex;
  gap: 4px;
  align-items: center;
  flex-wrap: wrap;
}

.footer-btn {
  padding: 3px 6px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.65em;
  font-weight: 500;
  transition: all 0.2s ease;
  white-space: nowrap;
  min-width: auto;
  line-height: 1.2;
  text-align: center;
}

.footer-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
}

.footer-btn:active {
  transform: scale(0.95);
}

/* Button variants */
.footer-btn.iko-btn {
  background: #4caf50;
  color: white;
}

.footer-btn.iko-btn:hover {
  background: #45a049;
}

.footer-btn.membership-btn {
  background: #9c27b0;
  color: white;
}

.footer-btn.membership-btn:hover {
  background: #7b1fa2;
}

.footer-btn.apply-btn {
  background: #2196f3;
  color: white;
}

.footer-btn.apply-btn:hover {
  background: #1976d2;
}

.footer-btn.signout-btn {
  background: #f44336;
  color: white;
}

.footer-btn.signout-btn:hover {
  background: #d32f2f;
}

.footer-btn.login-btn, .footer-btn.signup-btn {
  background: #ff9800;
  color: white;
}

.footer-btn.login-btn:hover, .footer-btn.signup-btn:hover {
  background: #f57c00;
}

/* ================================================
   RESPONSIVE DESIGN
   ================================================ */

@media (max-width: 768px) {
  .towncrier_viewport {
    flex-direction: column;
  }
  
  .revtopic-container {
    flex: none;
    height: 200px;
    border-right: none;
    border-bottom: 2px solid #ddd;
  }
  
  .revTeaching-container {
    flex: 1;
  }
  
  .banner-content {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }
  
  .membership-application-btn {
    width: 100%;
    text-align: center;
  }
  
  .full-member-info, .pre-member-info, .applicant-info {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  
  .access-restrictions {
    margin-left: 0;
    flex-wrap: wrap;
  }
}

@media (max-width: 480px) {
  .nav {
    padding: 6px 10px;
  }
  
  .footnote {
    padding: 4px 10px;
  }
  
  .nav-left, .nav-right {
    gap: 6px;
  }
  
  .user-info {
    font-size: 0.7em;
  }
  
  .membership-banner {
    padding: 10px;
  }
  
  .banner-text h3 {
    font-size: 16px;
  }
  
  .banner-text p {
    font-size: 13px;
  }
  
  .access-level-info {
    padding: 8px 10px;
  }
  
  .footer-controls {
    gap: 2px;
  }
  
  .footer-btn {
    padding: 2px 4px;
    font-size: 0.6em;
  }
}







/* ==================================================
   ikootaclient/src/components/iko/iko.css
   NON-SCROLLABLE
   ================================================== */

/* ===== BASE IKO CONTAINER ===== */
.iko_container {
  display: flex;
  flex-direction: column;
  width: var(--iko-width, 90vw);
  height: var(--iko-height, 90vh);
  border: 3px solid goldenrod;
  border-radius: 5px;
  margin: 10px;
  overflow: hidden;
  position: fixed; /* Keep fixed for standalone use */
  box-sizing: border-box;
}

.iko_container .iko_viewport {
  display: flex;
  flex-direction: row;
  flex-grow: 1;
  overflow: hidden; /* Changed from auto to hidden */
  max-width: 100%;
  max-height: 100%;
}

/* ===== IKO SPECIFIC STYLES ===== */
.iko_container .nav {
  background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
  flex-shrink: 0;
  padding: 8px 15px;
  color: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.iko_container .footnote {
  background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
  flex-shrink: 0;
  padding: 6px 15px;
  color: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.75em;
}

/* ===== NAVIGATION STYLES ===== */
.nav-left, .nav-right, .footer-left, .footer-right {
  display: flex;
  align-items: center;
  gap: 8px;
}

.footer-center {
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: center;
}

.member-status, .user-status {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.85em;
}

.user-info {
  background: rgba(255,255,255,0.1);
  padding: 3px 6px;
  border-radius: 10px;
  font-size: 0.8em;
}

.status-badge {
  padding: 2px 5px;
  border-radius: 6px;
  font-size: 0.7em;
  font-weight: bold;
}

.status-badge.member {
  background: #4caf50;
  color: white;
}

.admin-badge {
  background: #9c27b0;
  color: white;
  padding: 2px 4px;
  border-radius: 6px;
  font-size: 0.7em;
  margin-left: 4px;
}

.chat-count, .teaching-count {
  background: rgba(255,255,255,0.1);
  padding: 3px 6px;
  border-radius: 6px;
  font-size: 0.75em;
}

.online-status {
  background: rgba(76,175,80,0.2);
  padding: 2px 6px;
  border-radius: 8px;
  border: 1px solid #4caf50;
  font-size: 0.7em;
}

/* ===== FOOTER BUTTONS ===== */
.footer-controls {
  display: flex;
  gap: 4px;
  align-items: center;
}

.footer-btn {
  padding: 3px 6px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.65em;
  font-weight: 500;
  transition: all 0.2s ease;
  white-space: nowrap;
}

.footer-btn:hover {
  transform: scale(1.05);
  filter: brightness(1.1);
}

.footer-btn.towncrier-btn {
  background: #673ab7;
  color: white;
}

.footer-btn.admin-btn {
  background: #9c27b0;
  color: white;
}

.footer-btn.refresh-btn {
  background: #607d8b;
  color: white;
}

.footer-btn.signout-btn {
  background: #f44336;
  color: white;
}

/* ===== STATUS STYLES ===== */
.status {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  font-size: 1.2em;
  font-weight: bold;
}

.status.loading {
  color: #ff9800;
  animation: pulse 2s infinite;
}

.status.error {
  color: #f44336;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.7; }
  100% { opacity: 1; }
}

/* ==================================================
   ADMIN LAYOUT OVERRIDES - CRITICAL FIXES
   ================================================== */

/* When Iko is inside admin, completely override its positioning and sizing */
.mainContent .iko_container,
.mainCOntent .iko_container {
  /* CRITICAL: Remove fixed positioning */
  position: static !important;
  
  /* CRITICAL: Override viewport sizing */
  width: 100% !important;
  height: 100% !important;
  max-width: 100% !important;
  max-height: 100% !important;
  
  /* CRITICAL: Remove margins that cause overflow */
  margin: 0 !important;
  padding: 0 !important;
  
  /* CRITICAL: Reset CSS variables */
  --iko-width: 100% !important;
  --iko-height: 100% !important;
  
  /* Ensure proper flex layout */
  display: flex !important;
  flex-direction: column !important;
  overflow: hidden !important;
  box-sizing: border-box !important;
}

/* Fix the viewport container */
.mainContent .iko_viewport,
.mainCOntent .iko_viewport {
  display: flex !important;
  flex: 1 !important;
  width: 100% !important;
  height: 100% !important;
  max-width: 100% !important;
  max-height: 100% !important;
  overflow: hidden !important;
  box-sizing: border-box !important;
  flex-direction: row !important;
}

/* ===== THREE COLUMN LAYOUT WITH PROPER SCROLLING ===== */

/* Left Column: List Chats */
.mainContent .listchats_container,
.mainCOntent .listchats_container {
  flex: 1 !important;
  min-width: 250px !important;
  max-width: 350px !important;
  height: 100% !important;
  max-height: 100% !important;
  
  /* Enable scrolling */
  overflow-y: auto !important;
  overflow-x: hidden !important;
  
  /* Layout */
  display: flex !important;
  flex-direction: column !important;
  
  /* Styling */
  border-right: 3px solid brown !important;
  background: #f8f8f894 !important;
  
  /* Ensure proper sizing */
  box-sizing: border-box !important;
}

/* Middle Column: Chat Container */
.mainContent .chat_container,
.mainCOntent .chat_container {
  flex: 2 !important;
  min-width: 400px !important;
  height: 100% !important;
  max-height: 100% !important;
  
  /* Layout */
  display: flex !important;
  flex-direction: column !important;
  
  /* Styling */
  border: 3px solid red !important;
  
  /* Ensure proper sizing */
  box-sizing: border-box !important;
  overflow: hidden !important;
}

/* Right Column: List Comments */
.mainContent .listcomments_container,
.mainCOntent .listcomments_container {
  flex: 1 !important;
  min-width: 250px !important;
  max-width: 350px !important;
  height: 100% !important;
  max-height: 100% !important;
  
  /* Enable scrolling */
  overflow-y: auto !important;
  overflow-x: hidden !important;
  
  /* Layout */
  display: flex !important;
  flex-direction: column !important;
  
  /* Styling */
  background: #f0f0f0 !important;
  
  /* Ensure proper sizing */
  box-sizing: border-box !important;
}

/* ===== CHAT CONTAINER INTERNAL LAYOUT ===== */

/* Fixed sections in chat container */
.mainContent .chat_container .top,
.mainCOntent .chat_container .top,
.mainContent .chat_container .bottom,
.mainCOntent .chat_container .bottom {
  flex-shrink: 0 !important;
  width: 100% !important;
  max-width: 100% !important;
  box-sizing: border-box !important;
}

/* Scrollable center section */
.mainContent .chat_container .center,
.mainCOntent .chat_container .center {
  flex: 1 !important;
  overflow-y: auto !important;
  overflow-x: hidden !important;
  width: 100% !important;
  max-width: 100% !important;
  box-sizing: border-box !important;
  min-height: 0 !important;
}

/* ===== MEDIA CONTENT FIXES ===== */

.mainContent .media-container,
.mainCOntent .media-container {
  max-width: 100% !important;
  overflow: hidden !important;
  box-sizing: border-box !important;
}

.mainContent .media-container img,
.mainCOntent .media-container img,
.mainContent .media-container video,
.mainCOntent .media-container video {
  max-width: 100% !important;
  height: auto !important;
  object-fit: contain !important;
}

/* ===== SCROLLBAR STYLING ===== */

.mainContent .listchats_container::-webkit-scrollbar,
.mainCOntent .listchats_container::-webkit-scrollbar,
.mainContent .listcomments_container::-webkit-scrollbar,
.mainCOntent .listcomments_container::-webkit-scrollbar,
.mainContent .chat_container .center::-webkit-scrollbar,
.mainCOntent .chat_container .center::-webkit-scrollbar {
  width: 8px;
}

.mainContent .listchats_container::-webkit-scrollbar-thumb,
.mainCOntent .listchats_container::-webkit-scrollbar-thumb,
.mainContent .listcomments_container::-webkit-scrollbar-thumb,
.mainCOntent .listcomments_container::-webkit-scrollbar-thumb,
.mainContent .chat_container .center::-webkit-scrollbar-thumb,
.mainCOntent .chat_container .center::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 4px;
}

.mainContent .listchats_container::-webkit-scrollbar-thumb:hover,
.mainCOntent .listchats_container::-webkit-scrollbar-thumb:hover,
.mainContent .listcomments_container::-webkit-scrollbar-thumb:hover,
.mainCOntent .listcomments_container::-webkit-scrollbar-thumb:hover,
.mainContent .chat_container .center::-webkit-scrollbar-thumb:hover,
.mainCOntent .chat_container .center::-webkit-scrollbar-thumb:hover {
  background: #555;
}

/* ==================================================
   RESPONSIVE DESIGN
   ================================================== */

/* Original responsive styles for standalone Iko */
@media (max-width: 768px) {
  .nav, .footnote {
    flex-direction: column;
    gap: 6px;
    text-align: center;
    padding: 6px 10px;
  }
  
  .nav-left, .nav-right, .footer-left, .footer-right {
    gap: 4px;
  }
  
  .footer-controls {
    gap: 3px;
    justify-content: center;
  }
  
  .footer-btn {
    font-size: 0.6em;
    padding: 2px 4px;
  }
  
  .user-info {
    font-size: 0.75em;
  }
  
  .status-badge {
    font-size: 0.65em;
  }
}

/* Responsive behavior when inside admin */
@media (max-width: 1024px) {
  .mainContent .iko_viewport,
  .mainCOntent .iko_viewport {
    flex-direction: column !important;
  }
  
  .mainContent .listchats_container,
  .mainCOntent .listchats_container,
  .mainContent .chat_container,
  .mainCOntent .chat_container,
  .mainContent .listcomments_container,
  .mainCOntent .listcomments_container {
    max-width: 100% !important;
    min-width: auto !important;
    flex: none !important;
    height: 250px !important;
    max-height: 250px !important;
  }
  
  .mainContent .listchats_container,
  .mainCOntent .listchats_container {
    border-right: none !important;
    border-bottom: 2px solid brown !important;
  }
  
  .mainContent .chat_container,
  .mainCOntent .chat_container {
    flex: 1 !important;
    min-height: 300px !important;
    height: auto !important;
    max-height: none !important;
  }
}

@media (max-width: 768px) {
  .mainContent .listchats_container,
  .mainCOntent .listchats_container,
  .mainContent .listcomments_container,
  .mainCOntent .listcomments_container {
    height: 180px !important;
    max-height: 180px !important;
  }
  
  .mainContent .chat_container,
  .mainCOntent .chat_container {
    min-height: 400px !important;
  }
}

@media (max-width: 480px) {
  .footer-btn {
    font-size: 0.55em;
    padding: 2px 3px;
  }
  
  .footnote {
    font-size: 0.7em;
    padding: 4px 8px;
  }
  
  .footer-controls {
    gap: 2px;
  }
  
  .user-info {
    font-size: 0.7em;
    padding: 2px 4px;
  }
  
  .status-badge {
    font-size: 0.6em;
    padding: 1px 3px;
  }
}



#================================
#=======================EXPLAINATION START
#================================

users membership application/signup process. 

it will start with a user signing up signup with profile (email, phone and username) and instant of signup, User will be directed to 2. Application survey for pre-member. From this pre-member Application survey up to their submitting of this pre-requisite survey or pre-member Application survey. Application submitted stage 3. When application is submitted there is pending application review stage when application is being reviewed by the Admin. All these stages are to be termed 'applied' 4. Admin review application survey and is_member is granted/approved or declined. it will be the admin that logs into the admin dashboard to vet the survey result/answer submitted by the applicant before decision for is_member granted/approved or declined. At this stage of admin granting or declining membership of applicants, status changes from 'applied' to either 'approved' or diclined' (or perhaps i earlier used 'denied' ). 5. If application survey review results to 'approved' , admin also have to create some properties or previledges for the user. (a) converse_id system. create a 6-digit alphanumeric letters and avatar that they will henceforth use in place of their profile for all open communication and messages/chats. (b) mentor/mentee system. Have to also place user under a mentor by putting the mentor's id into their new user'd profile (a column for mentor 6-digit alphanumeric id#). (c) Class system. Admin also have to place the new user in a special demographic class (like classroom or like subject of study in a regular school system). This class is going to be synonymous to the 'audience' that the user can have internal communication/chats with apart from the general communication class which will feature in 'audience' for posting content/chat/messages. I propose that all these three systems or properties will each have a column in the user's table and each of this column will have the three options that admin will need to choose or flip into. 6. Applicants 'declined' or 'denied'. The moment Admin review results in denied or declined, the system will automatically initiate standard prepared communication or info messages to those that are declined/denied. and their status or field column will be filled with special notation like will have straight zeros (000000) as nil/null on their column for converse id, mentor and class. """ review the above process and stages and approval and let's get a clearer systemiced process of enrolment and approval by the Admin that will led users to become pre-member of which grantes access to the Towncrier.jsx viewport and note; not acdess to the Iko.jsx chat viewport that will only come on another different stage of application process that makes users member (full member)



#====================
#===================

SYSTEMIZED MEMBERSHIP PROCESS
STAGE 1: SIGNUP & APPLICATION

User Status: 'applied'
Access Level: Application Survey Only
Signup → Creates profile (email, phone, username)
Immediate Redirect → /applicationsurvey (Pre-member Application Survey)
Survey Completion → Status remains 'applied' (submission stage)
Pending Review → Status remains 'applied' (admin review stage) STAGE 2: ADMIN REVIEW & DECISION
Admin Actions Required:
- Review survey answers
- Make approval/decline decision
- If approved: Setup user properties
Admin Dashboard Flow:
1. Review Application → View survey responses
2. Decision Making → Approve or Decline
3. If Approved → Setup 3 systems:
   * Converse ID (6-digit alphanumeric)
   * Mentor Assignment (mentor ID)
   * Class Assignment (demographic class)
STAGE 3: OUTCOME PROCESSING
📊 APPROVED PATH:

Status: 'applied' → 'approved'
Access: Towncrier.jsx (Pre-member)
Properties: Converse ID + Mentor + Class
❌ DECLINED PATH:

Status: 'applied' → 'declined'
Properties: 000000 (null values)
Auto-notification: Decline message sent
Access: None (back to application)
🗃️ DATABASE SCHEMA UPDATES
Enhanced Database Schema for Membership Process
Code 
-- ===================================================== -- ENHANCED USERS TABLE FOR MEMBERSHIP PROCESS -- ===================================================== ALTER TABLE users ADD COLUMN IF NOT EXISTS ( -- ✅ Core membership tracking is_member
🔧 BACKEND API ENDPOINTS NEEDED
API Endpoints for Membership Process
Code 
// ===================================================== // MEMBERSHIP PROCESS API ENDPOINTS // ikootaapi/controllers/membershipControllers.js // ===================================================== / * ✅ STAGE 1: Submit Pre-member Application S
🔒 UPDATED USERSTATUS LOGIC
Fixed UserStatus.jsx - Correct Route Handling
Code ∙ Version 9 
 // ✅ SYSTEMIZED MEMBERSHIP PROCESS: User status detection const getUserStatus = useCallback(() => { try { if (!user) return 'guest'; if (user.role === 'admin' || user.role === 'super_admin') { return 'admin';
📊 COMPLETE SYSTEMIZED PROCESS SUMMARY
🔄 USER JOURNEY:**

1. SIGNUP → is_member: 'applied', membership_stage: 'none'
2. APPLICATION SURVEY → application_status: 'submitted'
3. ADMIN REVIEW → application_status: 'under_review'
4. ADMIN DECISION:
   ✅ APPROVED → is_member: 'approved', membership_stage: 'pre_member'
                 + converse_id + mentor + class → TOWNCRIER ACCESS
   ❌ DECLINED → is_member: 'declined'
                 + 000000 values → REAPPLY OPTION
🔐 ACCESS CONTROL:
* Applied Users: Application Survey Only
* Pending Users: Pending Verification Page Only
* Approved Pre-Members: Towncrier Access
* Declined Users: Back to Application
* Full Members: Iko Access (future stage)
⚙️ ADMIN TOOLS NEEDED:
1. Application Review Dashboard
2. Approval/Decline Actions
3. Converse ID Generator
4. Mentor Assignment Interface
5. Class Assignment Interface
6. Bulk Action Tools
This systemized approach ensures security, traceability, and proper workflow enforcement throughout the membership process. 




# ================================


#!/bin/bash
# =====================================================
# IKOOTA MEMBERSHIP PROCESS IMPLEMENTATION SCRIPT
# =====================================================

echo "🚀 Setting up Ikoota Membership Process..."

# =====================================================
# BACKEND SETUP CHECKLIST
# =====================================================

echo "📋 BACKEND SETUP CHECKLIST:"
echo "✅ 1. Database Schema Updates"
echo "   - Foreign keys created successfully ✓"
echo "   - notification_templates table populated ✓"
echo "   - New columns added to users/surveylog ✓"

echo "✅ 2. API Endpoints Required:"
echo "   - POST /api/membership/submit-application"
echo "   - GET  /api/membership/pending-applications" 
echo "   - POST /api/membership/approve/:userId"
echo "   - POST /api/membership/decline/:userId"
echo "   - GET  /api/membership/status"
echo "   - GET  /api/membership/admin/mentors"
echo "   - GET  /api/membership/admin/classes"
echo "   - GET  /api/membership/admin/stats"

echo "✅ 3. Environment Variables to Add:"
cat << 'EOF'
# Email Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
FROM_EMAIL=noreply@ikoota.com

# Frontend URLs
FRONTEND_URL=http://localhost:3000

# Membership Process Settings
DEFAULT_MENTOR_MAX_MENTEES=5
DEFAULT_CLASS_MAX_MEMBERS=50
EOF

# =====================================================
# FRONTEND SETUP CHECKLIST
# =====================================================

echo ""
echo "📋 FRONTEND SETUP CHECKLIST:"
echo "✅ 1. Components to Add:"
echo "   - AdminApplicationDashboard.jsx"
echo "   - ApplicationSurveyForm.jsx" 
echo "   - PendingVerificationPage.jsx"
echo "   - MembershipAnalytics.jsx"

echo "✅ 2. Routes to Add to App.jsx:"
cat << 'EOF'
// Add these routes to your React Router
<Route path="/applicationsurvey" element={<ApplicationSurveyForm />} />
<Route path="/pending-verification" element={<PendingVerificationPage />} />
<Route path="/admin/applications" element={<AdminApplicationDashboard />} />
EOF

echo "✅ 3. UserStatus.jsx Updates:"
echo "   - Enhanced status detection logic ✓"
echo "   - New route: /pending-verification ✓"
echo "   - Proper membership flow handling ✓"

# =====================================================
# DATABASE FINAL SETUP SCRIPT
# =====================================================

echo ""
echo "📋 FINAL DATABASE SETUP:"
echo "Run this SQL to complete the setup:"

cat << 'EOF'
-- =====================================================
-- FINAL MEMBERSHIP PROCESS DATABASE SETUP
-- =====================================================

-- 1. Create email_logs table
CREATE TABLE IF NOT EXISTS email_logs (
  id INT AUTO_INCREMENT PRIMARY KEY,
  recipient VARCHAR(255) NOT NULL,
  template_name VARCHAR(50),
  subject VARCHAR(200),
  status ENUM('sent', 'failed', 'pending') DEFAULT 'pending',
  error_message TEXT NULL,
  sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_recipient (recipient),
  INDEX idx_status (status),
  INDEX idx_sent_at (sent_at)
);

-- 2. Create mentors table
CREATE TABLE IF NOT EXISTS mentors (
  id INT AUTO_INCREMENT PRIMARY KEY,
  mentor_converse_id VARCHAR(12) UNIQUE NOT NULL,
  user_id INT NOT NULL,
  current_mentees INT DEFAULT 0,
  max_mentees INT DEFAULT 5,
  specialization VARCHAR(255),
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  INDEX idx_active (is_active),
  INDEX idx_availability (current_mentees, max_mentees)
);

-- 3. Create application_surveys table  
CREATE TABLE IF NOT EXISTS application_surveys (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NOT NULL,
  survey_data JSON NOT NULL,
  submitted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  review_status ENUM('pending', 'approved', 'declined') DEFAULT 'pending',
  reviewer_id INT NULL,
  reviewer_notes TEXT NULL,
  reviewed_at TIMESTAMP NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (reviewer_id) REFERENCES users(id) ON DELETE SET NULL,
  UNIQUE KEY unique_user_application (user_id),
  INDEX idx_review_status (review_status),
  INDEX idx_submitted_at (submitted_at)
);

-- 4. Insert default mentors for existing admins
INSERT IGNORE INTO mentors (mentor_converse_id, user_id, max_mentees, specialization)
SELECT converse_id, id, 10, 'General Mentoring'
FROM users 
WHERE role IN ('admin', 'super_admin') 
  AND converse_id IS NOT NULL 
  AND converse_id != '000000';

-- 5. Create performance indexes
CREATE INDEX IF NOT EXISTS idx_users_membership_process 
ON users(is_member, membership_stage, application_status);

CREATE INDEX IF NOT EXISTS idx_users_application_submitted 
ON users(application_submitted_at);

-- 6. Update existing data
UPDATE users 
SET application_status = 'not_submitted' 
WHERE application_status IS NULL 
  AND is_member = 'applied' 
  AND membership_stage = 'none';

-- 7. Verify setup
SELECT 'Setup Complete!' as status;
SELECT 
  COUNT(*) as total_users,
  COUNT(CASE WHEN is_member = 'applied' THEN 1 END) as applied_users,
  COUNT(CASE WHEN application_status = 'submitted' THEN 1 END) as pending_applications,
  COUNT(CASE WHEN is_member = 'approved' THEN 1 END) as approved_users
FROM users;
EOF

# =====================================================
# TESTING CHECKLIST
# =====================================================

echo ""
echo "🧪 TESTING CHECKLIST:"
echo "✅ 1. User Registration Flow:"
echo "   □ New user signs up → Status: 'applied'"
echo "   □ Redirected to /applicationsurvey"
echo "   □ Can complete and submit survey"
echo "   □ Redirected to /pending-verification"

echo "✅ 2. Admin Review Flow:" 
echo "   □ Admin can see pending applications"
echo "   □ Can approve with mentor/class assignment"
echo "   □ Can decline with reason"
echo "   □ Email notifications sent"

echo "✅ 3. User Experience Flow:"
echo "   □ Approved users → Access to /towncrier"
echo "   □ Declined users → Can reapply"
echo "   □ Status updates work correctly"

echo "✅ 4. Email System:"
echo "   □ SMTP configuration works"
echo "   □ Approval emails sent"
echo "   □ Decline emails sent"
echo "   □ Admin notification emails"

# =====================================================
# FILE STRUCTURE SUMMARY
# =====================================================

echo ""
echo "📁 FILE STRUCTURE SUMMARY:"
cat << 'EOF'
Backend (ikootaapi/):
├── controllers/
│   ├── membershipControllers.js     ✅ Application submission & review
│   └── adminControllers.js          ✅ Admin utilities & stats
├── utils/
│   ├── emailService.js             ✅ Email notification system
│   └── converseIdGenerator.js      ✅ Unique ID generation
├── routes/
│   └── membershipRoutes.js         ✅ API endpoints
└── migrations/
    └── membership_process.sql       ✅ Database setup

Frontend (ikootaclient/src/):
├── components/
│   ├── admin/
│   │   └── AdminApplicationDashboard.jsx    ✅ Admin review interface
│   ├── membership/
│   │   ├── ApplicationSurveyForm.jsx        ✅ Multi-step survey
│   │   ├── PendingVerificationPage.jsx      ✅ Status waiting page
│   │   └── MembershipAnalytics.jsx          ✅ Admin stats
│   └── auth/
│       └── UserStatus.jsx                   ✅ Enhanced routing logic
└── routes/
    └── App.jsx                             ✅ Updated with new routes
EOF

# =====================================================
# PRODUCTION DEPLOYMENT NOTES
# =====================================================

echo ""
echo "🚀 PRODUCTION DEPLOYMENT NOTES:"
echo "✅ 1. Security Considerations:"
echo "   - Validate all survey inputs on backend"
echo "   - Rate limit application submissions"
echo "   - Secure admin endpoints with proper auth"
echo "   - Use environment variables for sensitive data"

echo "✅ 2. Performance Optimizations:"
echo "   - Index database tables for queries"
echo "   - Cache mentor/class lists"
echo "   - Optimize email queue processing"
echo "   - Monitor application processing times"

echo "✅ 3. Monitoring & Logging:"
echo "   - Track application submission rates"
echo "   - Monitor email delivery success"
echo "   - Log admin actions for audit trail"
echo "   - Set up alerts for failed processes"

# =====================================================
# QUICK START COMMANDS
# =====================================================

echo ""
echo "⚡ QUICK START COMMANDS:"
echo "1. Backend Setup:"
echo "   cd ikootaapi && npm install nodemailer"
echo "   # Add environment variables to .env"
echo "   # Run the SQL setup script above"
echo "   # Restart your backend server"

echo ""
echo "2. Frontend Setup:"
echo "   cd ikootaclient && npm install lucide-react"
echo "   # Add the React components from artifacts"
echo "   # Update your routing in App.jsx"
echo "   # Test the complete flow"

echo ""
echo "3. Verification:"
echo "   # Test user registration → survey → admin review"
echo "   # Verify email notifications work"
echo "   # Check database foreign keys"
echo "   # Test both approval and decline flows"

echo ""
echo "🎉 MEMBERSHIP PROCESS IMPLEMENTATION COMPLETE!"
echo "Your systemized membership process is now ready for production!"

# =====================================================
# TROUBLESHOOTING GUIDE
# =====================================================

echo ""
echo "🔧 TROUBLESHOOTING GUIDE:"
cat << 'EOF'
Common Issues & Solutions:

1. Foreign Key Errors:
   - Check collation matches (utf8mb4_general_ci)
   - Verify column types are identical
   - Ensure referenced data exists

2. Email Not Sending:
   - Check SMTP credentials in .env
   - Verify email templates exist in database
   - Check email_logs table for error messages

3. User Status Not Updating:
   - Clear browser cache and cookies
   - Check UserStatus.jsx logic
   - Verify API endpoints return correct data

4. Survey Submission Fails:
   - Check network tab for API errors
   - Verify JWT token is valid
   - Check required field validations

5. Admin Dashboard Issues:
   - Ensure user has admin role
   - Check mentor/class data exists
   - Verify foreign key constraints

For additional help, check the console logs and network requests.
EOF

echo ""
echo "✨ Happy coding! Your membership process is now bulletproof! ✨"








MySQL [ikoota_db]> show tables;
ERROR 2006 (HY000): MySQL server has gone away
No connection. Trying to reconnect...
Connection id:    41214
Current database: ikoota_db

+--------------------------------+
| Tables_in_ikoota_db            |
+--------------------------------+
| admin_membership_overview      |
| all_applications_status        |
| audit_logs                     |
| bulk_email_logs                |
| bulk_sms_logs                  |
| chats                          |
| class_content_access           |
| class_member_counts            |
| classes                        |
| comments                       |
| email_logs                     |
| email_templates                |
| full_membership_access         |
| full_membership_access_log     |
| full_membership_applications   |
| id_generation_log              |
| identity_masking_audit         |
| membership_review_history      |
| membership_stats               |
| mentors                        |
| notification_templates         |
| pending_applications_overview  |
| pending_applications_simple    |
| pending_full_memberships       |
| pending_initial_applications   |
| reports                        |
| sms_logs                       |
| sms_templates                  |
| survey_questions               |
| surveylog                      |
| teachings                      |
| user_chats                     |
| user_class_details             |
| user_class_memberships         |
| user_communication_preferences |
| user_profiles                  |
| users                          |
| verification_codes             |
+--------------------------------+
38 rows in set (0.263 sec)

MySQL [ikoota_db]> describe admin_membership_overview;
+----------------------------+---------------------------------------------------------------------------------------------+------+-----+-------------------+-------------------+
| Field                      | Type                                                                                        | Null | Key | Default           | Extra             |
+----------------------------+---------------------------------------------------------------------------------------------+------+-----+-------------------+-------------------+
| id                         | int                                                                                         | NO   |     | 0                 |                   |
| username                   | varchar(255)                                                                                | NO   |     | NULL              |                   |
| email                      | varchar(255)                                                                                | NO   |     | NULL              |                   |
| converse_id                | varchar(12)                                                                                 | YES  |     | NULL              |                   |
| initial_status             | enum('applied','pending','suspended','granted','declined','pre_member','member','rejected') | YES  |     | applied           |                   |
| membership_stage           | enum('none','applicant','pre_member','member')                                              | YES  |     | none              |                   |
| initial_ticket             | varchar(20)                                                                                 | YES  |     | NULL              |                   |
| full_membership_status     | enum('not_applied','applied','pending','suspended','approved','declined')                   | YES  |     | not_applied       |                   |
| full_membership_ticket     | varchar(25)                                                                                 | YES  |     | NULL              |                   |
| full_membership_applied_at | timestamp                                                                                   | YES  |     | NULL              |                   |
| initial_submitted          | timestamp                                                                                   | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| initial_approval_status    | enum('pending','approved','rejected','under_review','granted','declined')                   | YES  |     | pending           |                   |
| initial_reviewer           | int                                                                                         | YES  |     | NULL              |                   |
| initial_reviewed_at        | timestamp                                                                                   | YES  |     | NULL              |                   |
| initial_verified_by        | char(10)                                                                                    | YES  |     | NULL              |                   |
| initial_admin_notes        | text                                                                                        | YES  |     | NULL              |                   |
| full_submitted             | timestamp                                                                                   | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| full_application_status    | enum('pending','suspended','approved','declined')                                           | YES  |     | pending           |                   |
| full_reviewed_at           | timestamp                                                                                   | YES  |     | NULL              |                   |
| full_reviewer              | int                                                                                         | YES  |     | NULL              |                   |
| full_admin_notes           | text                                                                                        | YES  |     | NULL              |                   |
| full_reviewer_name         | varchar(255)                                                                                | YES  |     | NULL              |                   |
| user_created               | timestamp                                                                                   | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
+----------------------------+---------------------------------------------------------------------------------------------+------+-----+-------------------+-------------------+
23 rows in set (0.071 sec)

MySQL [ikoota_db]> select * from admin_membership_overview;
+----+-----------+-------------------------+-------------+----------------+------------------+----------------------+------------------------+------------------------+----------------------------+---------------------+-------------------------+------------------+---------------------+---------------------+-----------------------------------+----------------+-------------------------+------------------+---------------+------------------+--------------------+---------------------+
| id | username  | email                   | converse_id | initial_status | membership_stage | initial_ticket       | full_membership_status | full_membership_ticket | full_membership_applied_at | initial_submitted   | initial_approval_status | initial_reviewer | initial_reviewed_at | initial_verified_by | initial_admin_notes               | full_submitted | full_application_status | full_reviewed_at | full_reviewer | full_admin_notes | full_reviewer_name | user_created        |
+----+-----------+-------------------------+-------------+----------------+------------------+----------------------+------------------------+------------------------+----------------------------+---------------------+-------------------------+------------------+---------------------+---------------------+-----------------------------------+----------------+-------------------------+------------------+---------------+------------------+--------------------+---------------------+
|  3 | yahoomond | peters_o_mond@yahoo.com | OTO#D003V3  | member         | member           | APP-undefined-mcrf9p | not_applied            | NULL                   | NULL                       | 2025-01-07 06:09:46 | pending                 |             NULL | NULL                |                     | NULL                              | NULL           | NULL                    | NULL             |          NULL | NULL             | NULL               | 2025-01-07 06:09:31 |
|  3 | yahoomond | peters_o_mond@yahoo.com | OTO#D003V3  | member         | member           | APP-undefined-mcrf9p | not_applied            | NULL                   | NULL                       | 2025-07-03 20:48:24 | approved                |                3 | 2025-07-03 20:48:24 |                     | Admin account - development setup | NULL           | NULL                    | NULL             |          NULL | NULL             | NULL               | 2025-01-07 06:09:31 |
|  3 | yahoomond | peters_o_mond@yahoo.com | OTO#D003V3  | member         | member           | APP-undefined-mcrf9p | not_applied            | NULL                   | NULL                       | 2025-07-03 21:38:20 | approved                |                3 | 2025-07-03 21:38:20 |                     | Admin account - development setup | NULL           | NULL                    | NULL             |          NULL | NULL             | NULL               | 2025-01-07 06:09:31 |
|  3 | yahoomond | peters_o_mond@yahoo.com | OTO#D003V3  | member         | member           | APP-undefined-mcrf9p | not_applied            | NULL                   | NULL                       | 2025-07-04 00:17:34 | approved                |                3 | 2025-07-04 00:17:34 |                     | Admin account - development setup | NULL           | NULL                    | NULL             |          NULL | NULL             | NULL               | 2025-01-07 06:09:31 |
|  3 | yahoomond | peters_o_mond@yahoo.com | OTO#D003V3  | member         | member           | APP-undefined-mcrf9p | not_applied            | NULL                   | NULL                       | 2025-07-06 08:40:33 | approved                |                3 | 2025-07-08 13:59:19 | admin               | NULL                              | NULL           | NULL                    | NULL             |          NULL | NULL             | NULL               | 2025-01-07 06:09:31 |
|  2 | pet       | petersomond@gmail.com   | OTO#C002O2  | member         | member           | NULL                 | not_applied            | NULL                   | NULL                       | 2025-01-07 06:08:15 | pending                 |             NULL | NULL                |                     | NULL                              | NULL           | NULL                    | NULL             |          NULL | NULL             | NULL               | 2025-01-07 06:08:01 |
|  2 | pet       | petersomond@gmail.com   | OTO#C002O2  | member         | member           | NULL                 | not_applied            | NULL                   | NULL                       | 2025-07-08 14:38:23 | approved                |                2 | 2025-07-08 14:38:23 | SYSTEM              | Super admin account setup         | NULL           | NULL                    | NULL             |          NULL | NULL             | NULL               | 2025-01-07 06:08:01 |
|  1 | abc       | abc@abc.com             | OTO#B001H1  | member         | member           | NULL                 | not_applied            | NULL                   | NULL                       | 2025-01-07 06:06:56 | approved                |             NULL | NULL                |                     | NULL                              | NULL           | NULL                    | NULL             |          NULL | NULL             | NULL               | 2025-01-07 06:06:41 |
|  1 | abc       | abc@abc.com             | OTO#B001H1  | member         | member           | NULL                 | not_applied            | NULL                   | NULL                       | 2025-07-08 14:38:03 | approved                |                2 | 2025-07-08 14:38:03 | ADMIN               | Bulk approval during system setup | NULL           | NULL                    | NULL             |          NULL | NULL             | NULL               | 2025-01-07 06:06:41 |
+----+-----------+-------------------------+-------------+----------------+------------------+----------------------+------------------------+------------------------+----------------------------+---------------------+-------------------------+------------------+---------------------+---------------------+-----------------------------------+----------------+-------------------------+------------------+---------------+------------------+--------------------+---------------------+
9 rows in set (0.031 sec)

MySQL [ikoota_db]> describe all_applications_status;
+------------------+--------------+------+-----+---------+-------+
| Field            | Type         | Null | Key | Default | Extra |
+------------------+--------------+------+-----+---------+-------+
| application_type | varchar(15)  | NO   |     |         |       |
| user_id          | int          | NO   |     | 0       |       |
| username         | varchar(255) | NO   |     |         |       |
| email            | varchar(255) | NO   |     |         |       |
| ticket           | varchar(25)  | YES  |     | NULL    |       |
| status           | varchar(12)  | YES  |     | NULL    |       |
| submitted_at     | timestamp    | YES  |     | NULL    |       |
| reviewed_at      | timestamp    | YES  |     | NULL    |       |
| reviewed_by      | int          | YES  |     | NULL    |       |
| admin_notes      | mediumtext   | YES  |     | NULL    |       |
| reviewer_name    | varchar(255) | YES  |     | NULL    |       |
+------------------+--------------+------+-----+---------+-------+
11 rows in set (0.022 sec)

MySQL [ikoota_db]> select * from all_applications_status;
+------------------+---------+-----------+-------------------------+----------------------+----------+---------------------+---------------------+-------------+-----------------------------------+---------------+
| application_type | user_id | username  | email                   | ticket               | status   | submitted_at        | reviewed_at         | reviewed_by | admin_notes                       | reviewer_name |
+------------------+---------+-----------+-------------------------+----------------------+----------+---------------------+---------------------+-------------+-----------------------------------+---------------+
| initial          |       2 | pet       | petersomond@gmail.com   | NULL                 | approved | 2025-07-08 14:38:23 | 2025-07-08 14:38:23 |           2 | Super admin account setup         | pet           |
| initial          |       1 | abc       | abc@abc.com             | NULL                 | approved | 2025-07-08 14:38:03 | 2025-07-08 14:38:03 |           2 | Bulk approval during system setup | pet           |
| initial          |       3 | yahoomond | peters_o_mond@yahoo.com | APP-undefined-mcrf9p | approved | 2025-07-06 08:40:33 | 2025-07-08 13:59:19 |           3 | NULL                              | yahoomond     |
| initial          |       3 | yahoomond | peters_o_mond@yahoo.com | APP-undefined-mcrf9p | approved | 2025-07-04 00:17:34 | 2025-07-04 00:17:34 |           3 | Admin account - development setup | yahoomond     |
| initial          |       3 | yahoomond | peters_o_mond@yahoo.com | APP-undefined-mcrf9p | approved | 2025-07-03 21:38:20 | 2025-07-03 21:38:20 |           3 | Admin account - development setup | yahoomond     |
| initial          |       3 | yahoomond | peters_o_mond@yahoo.com | APP-undefined-mcrf9p | approved | 2025-07-03 20:48:24 | 2025-07-03 20:48:24 |           3 | Admin account - development setup | yahoomond     |
| initial          |       3 | yahoomond | peters_o_mond@yahoo.com | APP-undefined-mcrf9p | pending  | 2025-01-07 06:09:46 | NULL                |        NULL | NULL                              | NULL          |
| initial          |       2 | pet       | petersomond@gmail.com   | NULL                 | pending  | 2025-01-07 06:08:15 | NULL                |        NULL | NULL                              | NULL          |
| initial          |       1 | abc       | abc@abc.com             | NULL                 | approved | 2025-01-07 06:06:56 | NULL                |        NULL | NULL                              | NULL          |
+------------------+---------+-----------+-------------------------+----------------------+----------+---------------------+---------------------+-------------+-----------------------------------+---------------+
9 rows in set (0.026 sec)

MySQL [ikoota_db]> describe audit_logs;
+------------+--------------+------+-----+-------------------+-------------------+
| Field      | Type         | Null | Key | Default           | Extra             |
+------------+--------------+------+-----+-------------------+-------------------+
| id         | int          | NO   | PRI | NULL              | auto_increment    |
| user_id    | int          | NO   | MUL | NULL              |                   |
| action     | varchar(255) | NO   | MUL | NULL              |                   |
| resource   | varchar(255) | YES  |     | NULL              |                   |
| details    | json         | YES  |     | NULL              |                   |
| ip_address | varchar(45)  | YES  |     | NULL              |                   |
| user_agent | text         | YES  |     | NULL              |                   |
| createdAt  | timestamp    | YES  | MUL | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
+------------+--------------+------+-----+-------------------+-------------------+
8 rows in set (0.022 sec)

MySQL [ikoota_db]> select * from audit_logs;
+----+---------+---------------------------+-----------------+----------------------------------------------------------------------------------------------------------------------------------------------------+------------+------------+---------------------+
| id | user_id | action                    | resource        | details                                                                                                                                            | ip_address | user_agent | createdAt           |
+----+---------+---------------------------+-----------------+----------------------------------------------------------------------------------------------------------------------------------------------------+------------+------------+---------------------+
|  1 |       1 | LOGIN                     | authentication  | {"method": "email", "success": true}                                                                                                               | NULL       | NULL       | 2025-07-08 14:39:10 |
|  2 |       2 | LOGIN                     | authentication  | {"method": "email", "success": true}                                                                                                               | NULL       | NULL       | 2025-07-08 14:39:10 |
|  3 |       3 | LOGIN                     | authentication  | {"method": "email", "success": true}                                                                                                               | NULL       | NULL       | 2025-07-08 14:39:10 |
|  4 |       3 | VIEW_ADMIN_PANEL          | admin           | {"section": "dashboard"}                                                                                                                           | NULL       | NULL       | 2025-07-08 14:39:10 |
|  5 |       2 | VIEW_ADMIN_PANEL          | admin           | {"section": "users"}                                                                                                                               | NULL       | NULL       | 2025-07-08 14:39:10 |
|  6 |       1 | MEMBERSHIP_STATUS_CHANGED | user_membership | {"updated_by": null, "new_is_member": "member", "old_is_member": "applied", "new_membership_stage": "member", "old_membership_stage": "applicant"} | NULL       | NULL       | 2025-07-08 15:06:58 |
|  7 |       1 | STATUS_AUTO_UPDATED       | user_membership | {"trigger": "survey_approval", "survey_id": 1, "new_status": "approved", "old_status": "pending"}                                                  | NULL       | NULL       | 2025-07-08 15:06:58 |
+----+---------+---------------------------+-----------------+----------------------------------------------------------------------------------------------------------------------------------------------------+------------+------------+---------------------+
7 rows in set (0.034 sec)

MySQL [ikoota_db]> describe bulk_email_logs;
+------------------+--------------+------+-----+-------------------+-----------------------------------------------+
| Field            | Type         | Null | Key | Default           | Extra                                         |
+------------------+--------------+------+-----+-------------------+-----------------------------------------------+
| id               | int          | NO   | PRI | NULL              | auto_increment                                |
| recipients_count | int          | NO   |     | NULL              |                                               |
| subject          | varchar(500) | YES  |     | NULL              |                                               |
| template         | varchar(100) | YES  | MUL | NULL              |                                               |
| successful_count | int          | YES  |     | 0                 |                                               |
| failed_count     | int          | YES  |     | 0                 |                                               |
| sender_id        | char(10)     | YES  | MUL | NULL              |                                               |
| createdAt        | timestamp    | YES  | MUL | CURRENT_TIMESTAMP | DEFAULT_GENERATED                             |
| updatedAt        | timestamp    | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
| processedAt      | timestamp    | YES  |     | NULL              |                                               |
+------------------+--------------+------+-----+-------------------+-----------------------------------------------+
10 rows in set (0.023 sec)

MySQL [ikoota_db]> select * from bulk_email_logs;
Empty set (0.029 sec)

MySQL [ikoota_db]> describe bulk_sms_logs;
+------------------+--------------+------+-----+-------------------+-----------------------------------------------+
| Field            | Type         | Null | Key | Default           | Extra                                         |
+------------------+--------------+------+-----+-------------------+-----------------------------------------------+
| id               | int          | NO   | PRI | NULL              | auto_increment                                |
| recipients_count | int          | NO   |     | NULL              |                                               |
| message          | text         | YES  |     | NULL              |                                               |
| template         | varchar(100) | YES  | MUL | NULL              |                                               |
| successful_count | int          | YES  |     | 0                 |                                               |
| failed_count     | int          | YES  |     | 0                 |                                               |
| sender_id        | char(10)     | YES  | MUL | NULL              |                                               |
| createdAt        | timestamp    | YES  | MUL | CURRENT_TIMESTAMP | DEFAULT_GENERATED                             |
| updatedAt        | timestamp    | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
| processedAt      | timestamp    | YES  |     | NULL              |                                               |
+------------------+--------------+------+-----+-------------------+-----------------------------------------------+
10 rows in set (0.022 sec)

MySQL [ikoota_db]> select * from bulk_sms_logs;
Empty set (0.024 sec)

MySQL [ikoota_db]> describe ByeCtrl-C -- exit!

PS C:\Users\peter>  mysql -h ikootadb.cvugpfnl4vcp.us-east-1.rds.amazonaws.com -P 3306 -u Petersomond -p
Enter password: **********
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 41216
Server version: 8.0.40 Source distribution

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> show databases;
+--------------------+
| Database           |
+--------------------+
| ikoota_db          |
| information_schema |
| mysql              |
| performance_schema |
| phpmyadmin         |
| sys                |
+--------------------+
6 rows in set (0.033 sec)

MySQL [(none)]> use ikoota_db;
Database changed
MySQL [ikoota_db]> describe chats;
+-----------------+---------------------------------------+------+-----+-------------------+-------------------+
| Field           | Type                                  | Null | Key | Default           | Extra             |
+-----------------+---------------------------------------+------+-----+-------------------+-------------------+
| id              | int                                   | NO   | PRI | NULL              | auto_increment    |
| title           | varchar(255)                          | NO   |     | NULL              |                   |
| user_id         | char(10)                              | NO   | MUL | NULL              |                   |
| audience        | varchar(255)                          | YES  |     | NULL              |                   |
| summary         | text                                  | YES  |     | NULL              |                   |
| text            | text                                  | YES  |     | NULL              |                   |
| approval_status | enum('pending','approved','rejected') | YES  |     | pending           |                   |
| media_url1      | varchar(255)                          | YES  |     | NULL              |                   |
| media_type1     | enum('image','video','audio','file')  | YES  |     | NULL              |                   |
| media_url2      | varchar(255)                          | YES  |     | NULL              |                   |
| media_type2     | enum('image','video','audio','file')  | YES  |     | NULL              |                   |
| media_url3      | varchar(255)                          | YES  |     | NULL              |                   |
| is_flagged      | tinyint(1)                            | YES  |     | 0                 |                   |
| media_type3     | enum('image','video','audio','file')  | YES  |     | NULL              |                   |
| createdAt       | timestamp                             | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| updatedAt       | timestamp                             | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| prefixed_id     | varchar(20)                           | YES  | UNI | NULL              |                   |
+-----------------+---------------------------------------+------+-----+-------------------+-------------------+
17 rows in set (0.031 sec)

MySQL [ikoota_db]> describe class_content_access;
+--------------+----------------------------------------+------+-----+-------------------+-------------------+
| Field        | Type                                   | Null | Key | Default           | Extra             |
+--------------+----------------------------------------+------+-----+-------------------+-------------------+
| id           | int                                    | NO   | PRI | NULL              | auto_increment    |
| content_id   | int                                    | NO   | MUL | NULL              |                   |
| content_type | enum('chat','teaching','announcement') | NO   |     | NULL              |                   |
| class_id     | varchar(12)                            | NO   | MUL | NULL              |                   |
| access_level | enum('read','comment','contribute')    | YES  |     | read              |                   |
| createdAt    | timestamp                              | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
+--------------+----------------------------------------+------+-----+-------------------+-------------------+
6 rows in set (0.022 sec)

MySQL [ikoota_db]> select * from class_content_access;
Empty set (0.031 sec)

MySQL [ikoota_db]> describe class_member_counts;
ERROR 2006 (HY000): MySQL server has gone away
No connection. Trying to reconnect...
ERROR 2013 (HY000): Lost connection to MySQL server at 'handshake: reading initial communication packet', system error: 2
ERROR: Can't connect to the server

unknown [ikoota_db]> describe class_member_counts;
No connection. Trying to reconnect...
Connection id:    41247
Current database: ikoota_db

+-----------------+--------------------------------------------------+------+-----+-------------+-------+
| Field           | Type                                             | Null | Key | Default     | Extra |
+-----------------+--------------------------------------------------+------+-----+-------------+-------+
| class_id        | varchar(12)                                      | NO   |     | NULL        |       |
| class_name      | varchar(255)                                     | NO   |     | NULL        |       |
| class_type      | enum('demographic','subject','public','special') | YES  |     | demographic |       |
| is_public       | tinyint(1)                                       | YES  |     | 0           |       |
| total_members   | bigint                                           | NO   |     | 0           |       |
| moderators      | bigint                                           | NO   |     | 0           |       |
| pending_members | bigint                                           | NO   |     | 0           |       |
+-----------------+--------------------------------------------------+------+-----+-------------+-------+
7 rows in set (1.304 sec)

MySQL [ikoota_db]> select * from describe class_member_counts;
ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'describe class_member_counts' at line 1
MySQL [ikoota_db]> select * from class_member_counts;
+------------+------------------------+-------------+-----------+---------------+------------+-----------------+
| class_id   | class_name             | class_type  | is_public | total_members | moderators | pending_members |
+------------+------------------------+-------------+-----------+---------------+------------+-----------------+
| J9L1A7     | Igbanke-33             | subject     |         0 |             0 |          0 |               0 |
| 59QGJ9     | Ika                    | subject     |         0 |             0 |          0 |               0 |
| XMZHFH     | Ottah                  | subject     |         0 |             0 |          0 |               0 |
| OTU#Public | General Community      | public      |         1 |             1 |          0 |               0 |
| OTU#1A2B3C | Advanced Mathematics   | subject     |         0 |             0 |          0 |               0 |
| OTU#4D5E6F | West African History   | demographic |         0 |             0 |          0 |               0 |
| OTU#7G8H9I | Leadership Development | special     |         0 |             0 |          0 |               0 |
+------------+------------------------+-------------+-----------+---------------+------------+-----------------+
7 rows in set (0.421 sec)

MySQL [ikoota_db]> describe classes;
+---------------+--------------------------------------------------+------+-----+-------------------+-------------------+
| Field         | Type                                             | Null | Key | Default           | Extra             |
+---------------+--------------------------------------------------+------+-----+-------------------+-------------------+
| id            | int                                              | NO   | PRI | NULL              | auto_increment    |
| class_id      | varchar(12)                                      | NO   | UNI | NULL              |                   |
| class_name    | varchar(255)                                     | NO   |     | NULL              |                   |
| public_name   | varchar(255)                                     | YES  |     | NULL              |                   |
| description   | text                                             | YES  |     | NULL              |                   |
| class_type    | enum('demographic','subject','public','special') | YES  | MUL | demographic       |                   |
| is_public     | tinyint(1)                                       | YES  | MUL | 0                 |                   |
| max_members   | int                                              | YES  |     | 50                |                   |
| privacy_level | enum('public','members_only','admin_only')       | YES  |     | members_only      |                   |
| created_by    | int                                              | YES  | MUL | NULL              |                   |
| is_active     | tinyint(1)                                       | YES  | MUL | 1                 |                   |
| createdAt     | timestamp                                        | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| updatedAt     | timestamp                                        | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
+---------------+--------------------------------------------------+------+-----+-------------------+-------------------+
13 rows in set (0.107 sec)

MySQL [ikoota_db]> select * from classes;
+----+------------+------------------------+--------------------+---------------------------------------------------------+-------------+-----------+-------------+---------------+------------+-----------+---------------------+---------------------+
| id | class_id   | class_name             | public_name        | description                                             | class_type  | is_public | max_members | privacy_level | created_by | is_active | createdAt           | updatedAt           |
+----+------------+------------------------+--------------------+---------------------------------------------------------+-------------+-----------+-------------+---------------+------------+-----------+---------------------+---------------------+
|  1 | J9L1A7     | Igbanke-33             | NULL               | Indigene of Igbanke-33                                  | subject     |         0 |          50 | members_only  |       NULL |         1 | 2025-01-12 05:37:13 | 2025-01-12 05:37:13 |
|  2 | 59QGJ9     | Ika                    | NULL               | Indigene of Ika                                         | subject     |         0 |          50 | members_only  |       NULL |         1 | 2025-01-12 05:37:54 | 2025-01-12 05:37:54 |
|  3 | XMZHFH     | Ottah                  | NULL               | Indigene of Ottah                                       | subject     |         0 |          50 | members_only  |       NULL |         1 | 2025-01-11 07:21:28 | 2025-01-11 07:21:28 |
|  4 | OTU#Public | General Community      | Public Community   | Universal class for all members - everyone belongs here | public      |         1 |        1000 | public        |       NULL |         1 | 2025-07-01 10:07:25 | 2025-07-01 10:07:25 |
|  9 | OTU#1A2B3C | Advanced Mathematics   | NULL               | Advanced math concepts and problem solving              | subject     |         0 |          50 | members_only  |       NULL |         1 | 2025-07-01 10:46:11 | 2025-07-01 10:46:11 |
| 10 | OTU#4D5E6F | West African History   | NULL               | Pre-colonial and modern West African studies            | demographic |         0 |          50 | members_only  |       NULL |         1 | 2025-07-01 10:46:11 | 2025-07-01 10:46:11 |
| 11 | OTU#7G8H9I | Leadership Development | Leadership Program | Leadership training and mentorship                      | special     |         0 |          50 | members_only  |       NULL |         1 | 2025-07-01 10:46:11 | 2025-07-01 10:46:11 |
+----+------------+------------------------+--------------------+---------------------------------------------------------+-------------+-----------+-------------+---------------+------------+-----------+---------------------+---------------------+
7 rows in set (0.080 sec)

MySQL [ikoota_db]> describe comments;
+-------------+--------------------------------------+------+-----+-------------------+-------------------+
| Field       | Type                                 | Null | Key | Default           | Extra             |
+-------------+--------------------------------------+------+-----+-------------------+-------------------+
| id          | int                                  | NO   | PRI | NULL              | auto_increment    |
| user_id     | char(10)                             | NO   | MUL | NULL              |                   |
| chat_id     | int                                  | YES  | MUL | NULL              |                   |
| teaching_id | int                                  | YES  | MUL | NULL              |                   |
| comment     | text                                 | NO   |     | NULL              |                   |
| media_url1  | varchar(255)                         | YES  |     | NULL              |                   |
| media_type1 | enum('image','video','audio','file') | YES  |     | NULL              |                   |
| media_url2  | varchar(255)                         | YES  |     | NULL              |                   |
| media_type2 | enum('image','video','audio','file') | YES  |     | NULL              |                   |
| media_url3  | varchar(255)                         | YES  |     | NULL              |                   |
| media_type3 | enum('image','video','audio','file') | YES  |     | NULL              |                   |
| createdAt   | timestamp                            | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| updatedAt   | timestamp                            | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
+-------------+--------------------------------------+------+-----+-------------------+-------------------+
13 rows in set (0.078 sec)

MySQL [ikoota_db]> describe email_logs;
+---------------+---------------------------------+------+-----+-------------------+-----------------------------------------------+
| Field         | Type                            | Null | Key | Default           | Extra                                         |
+---------------+---------------------------------+------+-----+-------------------+-----------------------------------------------+
| id            | int                             | NO   | PRI | NULL              | auto_increment                                |
| recipient     | varchar(255)                    | NO   | MUL | NULL              |                                               |
| subject       | varchar(500)                    | YES  |     | NULL              |                                               |
| template      | varchar(100)                    | YES  | MUL | NULL              |                                               |
| status        | enum('sent','failed','pending') | YES  | MUL | pending           |                                               |
| message_id    | varchar(255)                    | YES  |     | NULL              |                                               |
| error_message | text                            | YES  |     | NULL              |                                               |
| sender_id     | char(10)                        | YES  | MUL | NULL              |                                               |
| createdAt     | timestamp                       | YES  | MUL | CURRENT_TIMESTAMP | DEFAULT_GENERATED                             |
| updatedAt     | timestamp                       | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
| processedAt   | timestamp                       | YES  |     | NULL              |                                               |
+---------------+---------------------------------+------+-----+-------------------+-----------------------------------------------+
11 rows in set (0.060 sec)

MySQL [ikoota_db]> select * from email_logs;
Empty set (0.062 sec)

MySQL [ikoota_db]> describe email_templates;
+------------+--------------+------+-----+-------------------+-----------------------------------------------+
| Field      | Type         | Null | Key | Default           | Extra                                         |
+------------+--------------+------+-----+-------------------+-----------------------------------------------+
| id         | int          | NO   | PRI | NULL              | auto_increment                                |
| name       | varchar(100) | NO   | UNI | NULL              |                                               |
| subject    | varchar(500) | NO   |     | NULL              |                                               |
| body_text  | text         | YES  |     | NULL              |                                               |
| body_html  | text         | YES  |     | NULL              |                                               |
| variables  | json         | YES  |     | NULL              |                                               |
| is_active  | tinyint(1)   | YES  | MUL | 1                 |                                               |
| created_by | char(10)     | YES  | MUL | NULL              |                                               |
| createdAt  | timestamp    | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED                             |
| updatedAt  | timestamp    | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
+------------+--------------+------+-----+-------------------+-----------------------------------------------+
10 rows in set (0.085 sec)

MySQL [ikoota_db]> select * from email_templates;
+----+-------------------------------+--------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------+-----------+------------+---------------------+---------------------+
| id | name                          | subject                                                            | body_text                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | body_html                                                                                                                                                                                                                                                                                                                                                                                                                         | variables                                                                                                               | is_active | created_by | createdAt           | updatedAt           |
+----+-------------------------------+--------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------+-----------+------------+---------------------+---------------------+
|  1 | welcome                       | Welcome to Ikoota Platform!                                        | Hello {{username}},

Welcome to the Ikoota platform! We're excited to have you join our community.

Best regards,
The Ikoota Team                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | <h2>Welcome to Ikoota Platform!</h2><p>Hello <strong>{{username}}</strong>,</p><p>Welcome to the Ikoota platform! We're excited to have you join our community.</p><p>Best regards,<br>The Ikoota Team</p>                                                                                                                                                                                                                        | ["username"]                                                                                                            |         1 | NULL       | 2025-06-29 08:15:55 | 2025-06-29 08:15:55 |
|  2 | survey_approval               | Membership Application {{status}}                                  | Hello {{username}},

{{#if approved}}Congratulations! Your membership application has been approved.{{else}}We regret to inform you that your membership application has not been approved at this time.{{/if}}

{{#if remarks}}Remarks: {{remarks}}

{{/if}}Best regards,
The Ikoota Team                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | <h2>Membership Application {{status}}</h2><p>Hello <strong>{{username}}</strong>,</p><p>{{#if approved}}Congratulations! Your membership application has been approved.{{else}}We regret to inform you that your membership application has not been approved at this time.{{/if}}</p>{{#if remarks}}<p><strong>Remarks:</strong> {{remarks}}</p>{{/if}}<p>Best regards,<br>The Ikoota Team</p>                                   | ["username", "status", "approved", "remarks"]                                                                           |         1 | NULL       | 2025-06-29 08:15:55 | 2025-06-29 08:15:55 |
|  3 | content_notification          | Your {{contentType}} has been {{status}}                           | Hello {{username}},

Your {{contentType}} "{{contentTitle}}" has been {{status}}.

Best regards,
The Ikoota Team                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | <h2>Content Update Notification</h2><p>Hello <strong>{{username}}</strong>,</p><p>Your {{contentType}} "<strong>{{contentTitle}}</strong>" has been {{status}}.</p><p>Best regards,<br>The Ikoota Team</p>                                                                                                                                                                                                                        | ["username", "contentType", "contentTitle", "status"]                                                                   |         1 | NULL       | 2025-06-29 08:15:55 | 2025-06-29 08:15:55 |
|  4 | password_reset                | Password Reset Request                                             | Hello {{username}},

You requested a password reset. Click the link below to reset your password:

{{resetLink}}

If you didn't request this, please ignore this email.

Best regards,
The Ikoota Team                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | <h2>Password Reset Request</h2><p>Hello <strong>{{username}}</strong>,</p><p>You requested a password reset. Click the link below to reset your password:</p><p><a href="{{resetLink}}" style="background-color: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">Reset Password</a></p><p>If you didn't request this, please ignore this email.</p><p>Best regards,<br>The Ikoota Team</p> | ["username", "resetLink"]                                                                                               |         1 | NULL       | 2025-06-29 08:15:55 | 2025-06-29 08:15:55 |
|  5 | initial_application_submitted | Application Received - Ticket #{APPLICATION_TICKET}                | Dear {USERNAME},

Thank you for submitting your initial application to Ikoota!

Application Details:
- Ticket Number: {APPLICATION_TICKET}
- Submitted: {SUBMISSION_DATE}
- Review Timeline: 3-5 business days

Your application is now under review by our team. You will receive an email notification once the review is complete.

If you have urgent questions, please contact support@ikoota.com with your ticket number.

Best regards,
The Ikoota Team                                                                                                                                                                                                                                                                                                         | NULL                                                                                                                                                                                                                                                                                                                                                                                                                              | {"USERNAME": "User name", "SUBMISSION_DATE": "Application submission date", "APPLICATION_TICKET": "Application ticket"} |         1 | NULL       | 2025-07-02 18:24:11 | 2025-07-02 18:24:11 |
|  6 | initial_application_approved  | Application Approved - Welcome as Pre-Member!                      | Dear {USERNAME},

Congratulations! Your initial application has been approved and you are now a Pre-Member of Ikoota!

As a Pre-Member, you have access to:
- Browse all educational content in Towncrier
- Read community posts and resources
- Learn from teaching materials

To unlock full membership benefits (including chat access and commenting), you can apply for Full Membership from within your Towncrier dashboard.

Welcome to the Ikoota educational community!

Best regards,
The Ikoota Team                                                                                                                                                                                                                                                        | NULL                                                                                                                                                                                                                                                                                                                                                                                                                              | {"USERNAME": "User name", "APPLICATION_TICKET": "Application ticket"}                                                   |         1 | NULL       | 2025-07-02 18:24:11 | 2025-07-02 18:24:11 |
|  7 | initial_application_rejected  | Application Status Update - Ticket #{APPLICATION_TICKET}           | Dear {USERNAME},

Thank you for your interest in joining Ikoota. After careful review, we regret to inform you that your initial application (Ticket: {APPLICATION_TICKET}) has not been approved at this time.

Feedback:
{ADMIN_NOTES}

You may reapply after addressing the concerns mentioned above. We encourage you to review our community guidelines and resubmit when ready.

Best regards,
The Ikoota Team                                                                                                                                                                                                                                                                                                                                                   | NULL                                                                                                                                                                                                                                                                                                                                                                                                                              | {"USERNAME": "User name", "ADMIN_NOTES": "Admin feedback", "APPLICATION_TICKET": "Application ticket"}                  |         1 | NULL       | 2025-07-02 18:24:11 | 2025-07-02 18:24:11 |
|  8 | full_membership_submitted     | Full Membership Application Received - Ticket #{MEMBERSHIP_TICKET} | Dear {USERNAME},

Thank you for submitting your full membership application to Ikoota!

Application Details:
- Ticket Number: {MEMBERSHIP_TICKET}
- Submitted: {SUBMISSION_DATE}
- Review Timeline: 5-7 business days

Your application is now under review by our membership committee. You will receive an email notification once the review is complete.

During the review period, you continue to have pre-member access to our educational content in Towncrier.

If you have urgent questions, please contact membership@ikoota.com with your ticket number.

Best regards,
The Ikoota Membership Committee                                                                                                                                                    | NULL                                                                                                                                                                                                                                                                                                                                                                                                                              | {"USERNAME": "User name", "SUBMISSION_DATE": "Application submission date", "MEMBERSHIP_TICKET": "Membership ticket"}   |         1 | NULL       | 2025-07-02 18:24:11 | 2025-07-02 18:24:11 |
|  9 | full_membership_approved      | Congratulations! Full Membership Approved - Welcome to Ikoota      | Dear {USERNAME},

Congratulations! Your full membership application has been approved!

You now have complete access to all Ikoota features:
- Iko Chat System - Connect with fellow educators
- Comment and Engage - Participate in discussions
- Create and Share - Contribute educational content
- Community Collaboration - Work with other members

To get started with your full membership:
1. Sign in to your account
2. Access the Iko chat system
3. Explore member-only features
4. Join ongoing discussions

Welcome to the complete Ikoota educational community!

Best regards,
The Ikoota Membership Committee                                                                                                                                         | NULL                                                                                                                                                                                                                                                                                                                                                                                                                              | {"USERNAME": "User name", "MEMBERSHIP_TICKET": "Membership ticket"}                                                     |         1 | NULL       | 2025-07-02 18:24:11 | 2025-07-02 18:24:11 |
| 10 | full_membership_rejected      | Full Membership Application Decision - Ticket #{MEMBERSHIP_TICKET} | Dear {USERNAME},

After careful review by our membership committee, we regret to inform you that your full membership application (Ticket: {MEMBERSHIP_TICKET}) has not been approved at this time.

Feedback:
{FEEDBACK}

This decision does not permanently exclude you from full membership. You may reapply after addressing the areas mentioned above.

Reapplication Guidelines:
- Wait at least 90 days before resubmitting
- Address all concerns mentioned in this feedback
- Demonstrate growth in the identified areas
- Continue engaging as a pre-member

Your pre-member access to Towncrier educational content is maintained.

For questions about this decision, please contact membership@ikoota.com.

Best regards,
The Ikoota Membership Committee | NULL                                                                                                                                                                                                                                                                                                                                                                                                                              | {"FEEDBACK": "Detailed feedback text", "USERNAME": "User name", "MEMBERSHIP_TICKET": "Membership ticket"}               |         1 | NULL       | 2025-07-02 18:24:11 | 2025-07-02 18:24:11 |
+----+-------------------------------+--------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------+-----------+------------+---------------------+---------------------+
10 rows in set (0.123 sec)

MySQL [ikoota_db]> describe full_membership_access;
+-------------------+-----------+------+-----+-------------------+-----------------------------------------------+
| Field             | Type      | Null | Key | Default           | Extra                                         |
+-------------------+-----------+------+-----+-------------------+-----------------------------------------------+
| id                | int       | NO   | PRI | NULL              | auto_increment                                |
| user_id           | int       | NO   | UNI | NULL              |                                               |
| first_accessed_at | timestamp | YES  | MUL | CURRENT_TIMESTAMP | DEFAULT_GENERATED                             |
| last_accessed_at  | timestamp | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
| access_count      | int       | YES  |     | 1                 |                                               |
+-------------------+-----------+------+-----+-------------------+-----------------------------------------------+
5 rows in set (0.084 sec)

MySQL [ikoota_db]> select * from full_membership_access;
+----+---------+---------------------+---------------------+--------------+
| id | user_id | first_accessed_at   | last_accessed_at    | access_count |
+----+---------+---------------------+---------------------+--------------+
|  1 |       3 | 2025-07-03 20:38:42 | 2025-07-04 00:17:34 |            3 |
+----+---------+---------------------+---------------------+--------------+
1 row in set (0.104 sec)

MySQL [ikoota_db]> full_membership_access_log;
ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'full_membership_access_log' at line 1
MySQL [ikoota_db]> describe full_membership_access_log;
+-----------------+-------------+------+-----+-------------------+-----------------------------------------------+
| Field           | Type        | Null | Key | Default           | Extra                                         |
+-----------------+-------------+------+-----+-------------------+-----------------------------------------------+
| id              | int         | NO   | PRI | NULL              | auto_increment                                |
| user_id         | int         | NO   | UNI | NULL              |                                               |
| first_access_at | timestamp   | YES  | MUL | CURRENT_TIMESTAMP | DEFAULT_GENERATED                             |
| total_accesses  | int         | YES  |     | 1                 |                                               |
| last_access_at  | timestamp   | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
| ip_address      | varchar(45) | YES  |     | NULL              |                                               |
| user_agent      | text        | YES  |     | NULL              |                                               |
+-----------------+-------------+------+-----+-------------------+-----------------------------------------------+
7 rows in set (0.074 sec)

MySQL [ikoota_db]> describe full_membership_applications;
+-------------------+---------------------------------------------------+------+-----+-------------------+-------------------+
| Field             | Type                                              | Null | Key | Default           | Extra             |
+-------------------+---------------------------------------------------+------+-----+-------------------+-------------------+
| id                | int                                               | NO   | PRI | NULL              | auto_increment    |
| user_id           | int                                               | NO   | UNI | NULL              |                   |
| membership_ticket | varchar(25)                                       | NO   | MUL | NULL              |                   |
| answers           | json                                              | NO   |     | NULL              |                   |
| status            | enum('pending','suspended','approved','declined') | YES  | MUL | pending           |                   |
| submitted_at      | timestamp                                         | YES  | MUL | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| reviewed_at       | timestamp                                         | YES  |     | NULL              |                   |
| reviewed_by       | int                                               | YES  | MUL | NULL              |                   |
| admin_notes       | text                                              | YES  |     | NULL              |                   |
+-------------------+---------------------------------------------------+------+-----+-------------------+-------------------+
9 rows in set (0.065 sec)

MySQL [ikoota_db]> describe id_generation_log;
+--------------+----------------------+------+-----+-------------------+-------------------+
| Field        | Type                 | Null | Key | Default           | Extra             |
+--------------+----------------------+------+-----+-------------------+-------------------+
| id           | int                  | NO   | PRI | NULL              | auto_increment    |
| generated_id | char(10)             | NO   | MUL | NULL              |                   |
| id_type      | enum('user','class') | NO   | MUL | NULL              |                   |
| generated_by | char(10)             | YES  | MUL | NULL              |                   |
| generated_at | timestamp            | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| purpose      | varchar(100)         | YES  |     | NULL              |                   |
+--------------+----------------------+------+-----+-------------------+-------------------+
6 rows in set (0.058 sec)

MySQL [ikoota_db]> select * from id_generation_log;
+----+--------------+---------+--------------+---------------------+-------------------+
| id | generated_id | id_type | generated_by | generated_at        | purpose           |
+----+--------------+---------+--------------+---------------------+-------------------+
|  1 | OTO#B001H1   | user    | OTO#ADMIN1   | 2025-06-30 13:58:14 | User registration |
+----+--------------+---------+--------------+---------------------+-------------------+
1 row in set (0.109 sec)

MySQL [ikoota_db]> describe identity_masking_audit;
+--------------------+--------------+------+-----+-------------------+-------------------+
| Field              | Type         | Null | Key | Default           | Extra             |
+--------------------+--------------+------+-----+-------------------+-------------------+
| id                 | int          | NO   | PRI | NULL              | auto_increment    |
| user_id            | int          | NO   | MUL | NULL              |                   |
| converse_id        | varchar(12)  | YES  | MUL | NULL              |                   |
| masked_by_admin_id | varchar(12)  | YES  | MUL | NULL              |                   |
| original_username  | varchar(255) | YES  |     | NULL              |                   |
| createdAt          | timestamp    | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| reason             | text         | YES  |     | NULL              |                   |
+--------------------+--------------+------+-----+-------------------+-------------------+
7 rows in set (0.049 sec)

MySQL [ikoota_db]> select * from identity_masking_audit;
+----+---------+-------------+--------------------+-------------------+---------------------+--------------------------------------------------+
| id | user_id | converse_id | masked_by_admin_id | original_username | createdAt           | reason                                           |
+----+---------+-------------+--------------------+-------------------+---------------------+--------------------------------------------------+
|  1 |       1 | OTO#B001H1  | OTO#ADMIN1         | abc               | 2025-06-30 13:58:10 | Membership granted - identity masked for privacy |
+----+---------+-------------+--------------------+-------------------+---------------------+--------------------------------------------------+
1 row in set (0.086 sec)

MySQL [ikoota_db]> describe  membership_review_history;
+-------------------+-------------------------------------------------------------+------+-----+-------------------+-------------------+
| Field             | Type                                                        | Null | Key | Default           | Extra             |
+-------------------+-------------------------------------------------------------+------+-----+-------------------+-------------------+
| id                | int                                                         | NO   | PRI | NULL              | auto_increment    |
| user_id           | int                                                         | NO   | MUL | NULL              |                   |
| application_type  | enum('initial_application','full_membership')               | NO   | MUL | NULL              |                   |
| application_id    | int                                                         | YES  |     | NULL              |                   |
| reviewer_id       | int                                                         | YES  | MUL | NULL              |                   |
| previous_status   | enum('pending','suspended','approved','declined')           | YES  |     | NULL              |                   |
| new_status        | enum('pending','suspended','approved','declined')           | YES  |     | NULL              |                   |
| review_notes      | text                                                        | YES  |     | NULL              |                   |
| action_taken      | enum('approve','decline','suspend','request_info','reopen') | NO   |     | NULL              |                   |
| reviewed_at       | timestamp                                                   | YES  | MUL | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| notification_sent | tinyint(1)                                                  | YES  |     | 0                 |                   |
+-------------------+-------------------------------------------------------------+------+-----+-------------------+-------------------+
11 rows in set (0.077 sec)

MySQL [ikoota_db]> select * from  membership_review_history;
Empty set (0.053 sec)

MySQL [ikoota_db]> describe membership_stats;
+----------+-------------+------+-----+---------+-------+
| Field    | Type        | Null | Key | Default | Extra |
+----------+-------------+------+-----+---------+-------+
| category | varchar(20) | NO   |     |         |       |
| status   | varchar(12) | YES  |     | NULL    |       |
| count    | bigint      | NO   |     | 0       |       |
+----------+-------------+------+-----+---------+-------+
3 rows in set (0.105 sec)

MySQL [ikoota_db]> select * from membership_stats;
+----------------------+----------+-------+
| category             | status   | count |
+----------------------+----------+-------+
| Initial Applications | approved |     7 |
| Initial Applications | pending  |     2 |
| User Stages          | none     |     1 |
| User Stages          | member   |     3 |
+----------------------+----------+-------+
4 rows in set (0.062 sec)

MySQL [ikoota_db]> describe mentors;
+--------------------+-------------------------------+------+-----+-------------------+-------------------+
| Field              | Type                          | Null | Key | Default           | Extra             |
+--------------------+-------------------------------+------+-----+-------------------+-------------------+
| id                 | int                           | NO   | PRI | NULL              | auto_increment    |
| mentor_converse_id | varchar(12)                   | YES  | MUL | NULL              |                   |
| mentee_converse_id | varchar(12)                   | YES  | MUL | NULL              |                   |
| relationship_type  | enum('mentor','peer','admin') | YES  |     | mentor            |                   |
| created_at         | timestamp                     | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| is_active          | tinyint(1)                    | YES  |     | 1                 |                   |
+--------------------+-------------------------------+------+-----+-------------------+-------------------+
6 rows in set (0.116 sec)

MySQL [ikoota_db]> seclect * from mentors;
ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'seclect * from mentors' at line 1
MySQL [ikoota_db]> select * from mentors;
Empty set (0.104 sec)

MySQL [ikoota_db]> describe notification_templates;
+---------------+-------------------------------------------------+------+-----+-------------------+-----------------------------------------------+
| Field         | Type                                            | Null | Key | Default           | Extra                                         |
+---------------+-------------------------------------------------+------+-----+-------------------+-----------------------------------------------+
| id            | int                                             | NO   | PRI | NULL              | auto_increment                                |
| template_name | varchar(50)                                     | NO   | UNI | NULL              |                                               |
| subject       | varchar(200)                                    | YES  |     | NULL              |                                               |
| email_body    | text                                            | YES  |     | NULL              |                                               |
| template_type | enum('approval','decline','admin_notification') | YES  |     | approval          |                                               |
| is_active     | tinyint(1)                                      | YES  |     | 1                 |                                               |
| createdAt     | timestamp                                       | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED                             |
| updatedAt     | timestamp                                       | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
+---------------+-------------------------------------------------+------+-----+-------------------+-----------------------------------------------+
8 rows in set (0.102 sec)

MySQL [ikoota_db]> select * from notification_templates;
+----+-----------------------+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------+-----------+---------------------+---------------------+
| id | template_name         | subject                                   | email_body                                                                                                                                                                                                                      | template_type      | is_active | createdAt           | updatedAt           |
+----+-----------------------+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------+-----------+---------------------+---------------------+
|  1 | pre_member_approval   | Welcome to Ikoota - Application Approved! | Congratulations {{USERNAME}}! Your application has been approved.

Your Details:
- Converse ID: {{CONVERSE_ID}}
- Mentor: {{MENTOR_ID}}
- Class: {{CLASS_ID}}

You now have access to Towncrier.                                | approval           |         1 | 2025-07-21 02:12:43 | 2025-07-21 02:12:43 |
|  2 | pre_member_decline    | Ikoota Application Update                 | Dear {{USERNAME}},

Thank you for your interest in Ikoota. After careful review, we are unable to approve your application at this time.

Reason: {{DECLINE_REASON}}

You may reapply in the future.

Best regards,
Ikoota Team | decline            |         1 | 2025-07-21 02:12:43 | 2025-07-21 02:12:43 |
|  3 | admin_new_application | New Application Pending Review            | A new application requires your review.

Applicant: {{APPLICANT_USERNAME}} ({{APPLICANT_EMAIL}})
Submitted: {{SUBMISSION_DATE}}

Please review in admin dashboard.                                                              | admin_notification |         1 | 2025-07-21 02:12:43 | 2025-07-21 02:12:43 |
+----+-----------------------+-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------+-----------+---------------------+---------------------+
3 rows in set (0.068 sec)

MySQL [ikoota_db]> describe pending_applications_overview;
+-------------------+--------------+------+-----+---------+-------+
| Field             | Type         | Null | Key | Default | Extra |
+-------------------+--------------+------+-----+---------+-------+
| application_stage | varchar(15)  | NO   |     |         |       |
| user_id           | int          | NO   |     | 0       |       |
| username          | varchar(255) | NO   |     |         |       |
| email             | varchar(255) | NO   |     |         |       |
| ticket            | varchar(25)  | YES  |     | NULL    |       |
| submitted_at      | timestamp    | YES  |     | NULL    |       |
| status            | varchar(12)  | YES  |     | NULL    |       |
| days_pending      | bigint       | YES  |     | NULL    |       |
| answers           | mediumtext   | YES  |     | NULL    |       |
| application_id    | int          | NO   |     | 0       |       |
| notes             | mediumtext   | YES  |     | NULL    |       |
+-------------------+--------------+------+-----+---------+-------+
11 rows in set (0.088 sec)

MySQL [ikoota_db]> select * from pending_applications_overview;
+-------------------+---------+-----------+-------------------------+----------------------+---------------------+---------+--------------+---------------------------------------------------------------------+----------------+-------+
| application_stage | user_id | username  | email                   | ticket               | submitted_at        | status  | days_pending | answers                                                             | application_id | notes |
+-------------------+---------+-----------+-------------------------+----------------------+---------------------+---------+--------------+---------------------------------------------------------------------+----------------+-------+
| initial           |       2 | pet       | petersomond@gmail.com   | NULL                 | 2025-01-07 06:08:15 | pending |          195 | ["oloill","yujyujty","yjutyhtrtrh","jjyhrhtsgaeff","gfrgrfewerewr"] |              2 | NULL  |
| initial           |       3 | yahoomond | peters_o_mond@yahoo.com | APP-undefined-mcrf9p | 2025-01-07 06:09:46 | pending |          195 | ["trfrrf","988989","zxxx","iuiuyu","2123ewds"]                      |              3 | NULL  |
+-------------------+---------+-----------+-------------------------+----------------------+---------------------+---------+--------------+---------------------------------------------------------------------+----------------+-------+
2 rows in set (0.098 sec)

MySQL [ikoota_db]> describe pending_applications_simple;
+--------------------------+------------------------------------------------------------------------+------+-----+---------------+-------+
| Field                    | Type                                                                   | Null | Key | Default       | Extra |
+--------------------------+------------------------------------------------------------------------+------+-----+---------------+-------+
| user_id                  | int                                                                    | NO   |     | 0             |       |
| username                 | varchar(255)                                                           | NO   |     | NULL          |       |
| email                    | varchar(255)                                                           | NO   |     | NULL          |       |
| application_submitted_at | timestamp                                                              | YES  |     | NULL          |       |
| application_status       | enum('not_submitted','submitted','under_review','approved','declined') | YES  |     | not_submitted |       |
| answers                  | text                                                                   | YES  |     | NULL          |       |
| application_ticket       | varchar(255)                                                           | YES  |     | NULL          |       |
| survey_id                | int                                                                    | NO   |     | 0             |       |
| days_pending             | int                                                                    | YES  |     | NULL          |       |
+--------------------------+------------------------------------------------------------------------+------+-----+---------------+-------+
9 rows in set (0.095 sec)

MySQL [ikoota_db]> select * from pending_applications_simple;
+---------+-----------+-------------------------+--------------------------+--------------------+---------------------------------------------------------------------+--------------------+-----------+--------------+
| user_id | username  | email                   | application_submitted_at | application_status | answers                                                             | application_ticket | survey_id | days_pending |
+---------+-----------+-------------------------+--------------------------+--------------------+---------------------------------------------------------------------+--------------------+-----------+--------------+
|       2 | pet       | petersomond@gmail.com   | 2025-01-07 06:08:15      | submitted          | ["oloill","yujyujty","yjutyhtrtrh","jjyhrhtsgaeff","gfrgrfewerewr"] | NULL               |         2 |          195 |
|       3 | yahoomond | peters_o_mond@yahoo.com | 2025-01-07 06:09:46      | submitted          | ["trfrrf","988989","zxxx","iuiuyu","2123ewds"]                      | NULL               |         3 |          195 |
+---------+-----------+-------------------------+--------------------------+--------------------+---------------------------------------------------------------------+--------------------+-----------+--------------+
2 rows in set (0.086 sec)

MySQL [ikoota_db]> describe pending_full_memberships;
+-------------------+---------------------------------------------------+------+-----+-------------------+-------------------+
| Field             | Type                                              | Null | Key | Default           | Extra             |
+-------------------+---------------------------------------------------+------+-----+-------------------+-------------------+
| application_stage | varchar(15)                                       | NO   |     |                   |                   |
| user_id           | int                                               | NO   |     | 0                 |                   |
| username          | varchar(255)                                      | NO   |     | NULL              |                   |
| email             | varchar(255)                                      | NO   |     | NULL              |                   |
| ticket            | varchar(25)                                       | NO   |     | NULL              |                   |
| submitted_at      | timestamp                                         | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| status            | enum('pending','suspended','approved','declined') | YES  |     | pending           |                   |
| days_pending      | int                                               | YES  |     | NULL              |                   |
| answers           | text                                              | NO   |     | NULL              |                   |
| application_id    | int                                               | NO   |     | 0                 |                   |
| notes             | text                                              | YES  |     | NULL              |                   |
+-------------------+---------------------------------------------------+------+-----+-------------------+-------------------+
11 rows in set (0.110 sec)

MySQL [ikoota_db]> select * from pending_full_memberships;
Empty set (0.111 sec)

MySQL [ikoota_db]> describe pending_initial_applications;
+-------------------+---------------------------------------------------------------------------+------+-----+-------------------+-------------------+
| Field             | Type                                                                      | Null | Key | Default           | Extra             |
+-------------------+---------------------------------------------------------------------------+------+-----+-------------------+-------------------+
| application_stage | varchar(7)                                                                | NO   |     |                   |                   |
| user_id           | int                                                                       | NO   |     | 0                 |                   |
| username          | varchar(255)                                                              | NO   |     | NULL              |                   |
| email             | varchar(255)                                                              | NO   |     | NULL              |                   |
| ticket            | varchar(20)                                                               | YES  |     | NULL              |                   |
| submitted_at      | timestamp                                                                 | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| status            | enum('pending','approved','rejected','under_review','granted','declined') | YES  |     | pending           |                   |
| days_pending      | int                                                                       | YES  |     | NULL              |                   |
| answers           | text                                                                      | YES  |     | NULL              |                   |
| application_id    | int                                                                       | NO   |     | 0                 |                   |
| notes             | text                                                                      | YES  |     | NULL              |                   |
+-------------------+---------------------------------------------------------------------------+------+-----+-------------------+-------------------+
11 rows in set (0.070 sec)

MySQL [ikoota_db]> select * from pending_initial_applications;
+-------------------+---------+-----------+-------------------------+----------------------+---------------------+---------+--------------+---------------------------------------------------------------------+----------------+-------+
| application_stage | user_id | username  | email                   | ticket               | submitted_at        | status  | days_pending | answers                                                             | application_id | notes |
+-------------------+---------+-----------+-------------------------+----------------------+---------------------+---------+--------------+---------------------------------------------------------------------+----------------+-------+
| initial           |       2 | pet       | petersomond@gmail.com   | NULL                 | 2025-01-07 06:08:15 | pending |          195 | ["oloill","yujyujty","yjutyhtrtrh","jjyhrhtsgaeff","gfrgrfewerewr"] |              2 | NULL  |
| initial           |       3 | yahoomond | peters_o_mond@yahoo.com | APP-undefined-mcrf9p | 2025-01-07 06:09:46 | pending |          195 | ["trfrrf","988989","zxxx","iuiuyu","2123ewds"]                      |              3 | NULL  |
+-------------------+---------+-----------+-------------------------+----------------------+---------------------+---------+--------------+---------------------------------------------------------------------+----------------+-------+
2 rows in set (0.084 sec)

MySQL [ikoota_db]> describe  reports;
+-------------+---------------------------------------+------+-----+-------------------+-------------------+
| Field       | Type                                  | Null | Key | Default           | Extra             |
+-------------+---------------------------------------+------+-----+-------------------+-------------------+
| id          | int                                   | NO   | PRI | NULL              | auto_increment    |
| reporter_id | char(10)                              | NO   | MUL | NULL              |                   |
| reported_id | char(10)                              | YES  | MUL | NULL              |                   |
| reason      | text                                  | NO   |     | NULL              |                   |
| status      | enum('pending','reviewed','resolved') | YES  |     | pending           |                   |
| createdAt   | timestamp                             | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
+-------------+---------------------------------------+------+-----+-------------------+-------------------+
6 rows in set (0.089 sec)

MySQL [ikoota_db]> select * from  reports;
Empty set (0.059 sec)

MySQL [ikoota_db]> describe sms_logs;
+---------------+---------------------------------+------+-----+-------------------+-----------------------------------------------+
| Field         | Type                            | Null | Key | Default           | Extra                                         |
+---------------+---------------------------------+------+-----+-------------------+-----------------------------------------------+
| id            | int                             | NO   | PRI | NULL              | auto_increment                                |
| recipient     | varchar(20)                     | NO   | MUL | NULL              |                                               |
| message       | text                            | YES  |     | NULL              |                                               |
| template      | varchar(100)                    | YES  | MUL | NULL              |                                               |
| status        | enum('sent','failed','pending') | YES  | MUL | pending           |                                               |
| sid           | varchar(100)                    | YES  |     | NULL              |                                               |
| error_message | text                            | YES  |     | NULL              |                                               |
| sender_id     | char(10)                        | YES  | MUL | NULL              |                                               |
| createdAt     | timestamp                       | YES  | MUL | CURRENT_TIMESTAMP | DEFAULT_GENERATED                             |
| updatedAt     | timestamp                       | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
| processedAt   | timestamp                       | YES  |     | NULL              |                                               |
+---------------+---------------------------------+------+-----+-------------------+-----------------------------------------------+
11 rows in set (0.096 sec)

MySQL [ikoota_db]> select * from sms_logs;
Empty set (0.093 sec)

MySQL [ikoota_db]> describe sms_templates;
+------------+--------------+------+-----+-------------------+-----------------------------------------------+
| Field      | Type         | Null | Key | Default           | Extra                                         |
+------------+--------------+------+-----+-------------------+-----------------------------------------------+
| id         | int          | NO   | PRI | NULL              | auto_increment                                |
| name       | varchar(100) | NO   | UNI | NULL              |                                               |
| message    | text         | NO   |     | NULL              |                                               |
| variables  | json         | YES  |     | NULL              |                                               |
| is_active  | tinyint(1)   | YES  | MUL | 1                 |                                               |
| created_by | char(10)     | YES  | MUL | NULL              |                                               |
| createdAt  | timestamp    | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED                             |
| updatedAt  | timestamp    | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
+------------+--------------+------+-----+-------------------+-----------------------------------------------+
8 rows in set (0.063 sec)

MySQL [ikoota_db]> select * from sms_templates;
+----+----------------------+----------------------------------------------------------------------------------------------------------------------------+---------------------------------------+-----------+------------+---------------------+---------------------+
| id | name                 | message                                                                                                                    | variables                             | is_active | created_by | createdAt           | updatedAt           |
+----+----------------------+----------------------------------------------------------------------------------------------------------------------------+---------------------------------------+-----------+------------+---------------------+---------------------+
|  1 | welcome              | Welcome to Ikoota, {{username}}! Your account has been activated. Start exploring our platform today.                      | ["username"]                          |         1 | NULL       | 2025-06-29 08:16:20 | 2025-06-29 08:16:20 |
|  2 | survey_approval      | Hello {{username}}, your membership application has been {{status}}. Check your email for details.                         | ["username", "status"]                |         1 | NULL       | 2025-06-29 08:16:20 | 2025-06-29 08:16:20 |
|  3 | verification_code    | Your Ikoota verification code is: {{code}}. This code expires in 10 minutes.                                               | ["code"]                              |         1 | NULL       | 2025-06-29 08:16:20 | 2025-06-29 08:16:20 |
|  4 | password_reset       | Hello {{username}}, a password reset was requested for your Ikoota account. Check your email for the reset link.           | ["username"]                          |         1 | NULL       | 2025-06-29 08:16:20 | 2025-06-29 08:16:20 |
|  5 | content_notification | Hello {{username}}, your {{contentType}} has been {{status}}. Check the app for details.                                   | ["username", "contentType", "status"] |         1 | NULL       | 2025-06-29 08:16:20 | 2025-06-29 08:16:20 |
|  6 | admin_alert          | Ikoota Admin Alert: {{message}}                                                                                            | ["message"]                           |         1 | NULL       | 2025-06-29 08:16:20 | 2025-06-29 08:16:20 |
|  7 | maintenance          | Ikoota will undergo maintenance starting {{startTime}} for approximately {{duration}}. We apologize for any inconvenience. | ["startTime", "duration"]             |         1 | NULL       | 2025-06-29 08:16:20 | 2025-06-29 08:16:20 |
+----+----------------------+----------------------------------------------------------------------------------------------------------------------------+---------------------------------------+-----------+------------+---------------------+---------------------+
7 rows in set (0.087 sec)

MySQL [ikoota_db]> describe survey_questions;
+----------------+------------+------+-----+-------------------+-----------------------------------------------+
| Field          | Type       | Null | Key | Default           | Extra                                         |
+----------------+------------+------+-----+-------------------+-----------------------------------------------+
| id             | int        | NO   | PRI | NULL              | auto_increment                                |
| question       | text       | NO   |     | NULL              |                                               |
| createdAt      | timestamp  | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED                             |
| updatedAt      | timestamp  | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
| is_active      | tinyint(1) | YES  |     | 1                 |                                               |
| question_order | int        | YES  |     | 0                 |                                               |
+----------------+------------+------+-----+-------------------+-----------------------------------------------+
6 rows in set (0.122 sec)

MySQL [ikoota_db]> select * from survey_questions;
Empty set (0.080 sec)

MySQL [ikoota_db]> describe  surveylog;
+--------------------------+---------------------------------------------------------------------------+------+-----+---------------------+-----------------------------------------------+
| Field                    | Type                                                                      | Null | Key | Default             | Extra                                         |
+--------------------------+---------------------------------------------------------------------------+------+-----+---------------------+-----------------------------------------------+
| id                       | int                                                                       | NO   | PRI | NULL                | auto_increment                                |
| user_id                  | int                                                                       | NO   | MUL | NULL                |                                               |
| answers                  | text                                                                      | YES  |     | NULL                |                                               |
| verified_by              | char(10)                                                                  | NO   | MUL | NULL                |                                               |
| rating_remarks           | varchar(255)                                                              | NO   |     | NULL                |                                               |
| approval_status          | enum('pending','approved','rejected','under_review','granted','declined') | YES  | MUL | pending             |                                               |
| createdAt                | timestamp                                                                 | YES  |     | CURRENT_TIMESTAMP   | DEFAULT_GENERATED                             |
| updatedAt                | timestamp                                                                 | YES  |     | CURRENT_TIMESTAMP   | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
| processedAt              | timestamp                                                                 | YES  |     | CURRENT_TIMESTAMP   | DEFAULT_GENERATED                             |
| admin_notes              | text                                                                      | YES  |     | NULL                |                                               |
| application_type         | enum('initial_application','full_membership')                             | YES  | MUL | initial_application |                                               |
| reviewed_at              | timestamp                                                                 | YES  | MUL | NULL                |                                               |
| reviewed_by              | int                                                                       | YES  | MUL | NULL                |                                               |
| application_ticket       | varchar(255)                                                              | YES  |     | NULL                |                                               |
| mentor_assigned          | varchar(12)                                                               | YES  | MUL | NULL                |                                               |
| class_assigned           | varchar(12)                                                               | YES  | MUL | NULL                |                                               |
| converse_id_generated    | varchar(12)                                                               | YES  |     | NULL                |                                               |
| approval_decision_reason | text                                                                      | YES  |     | NULL                |                                               |
| notification_sent        | tinyint(1)                                                                | YES  |     | 0                   |                                               |
+--------------------------+---------------------------------------------------------------------------+------+-----+---------------------+-----------------------------------------------+
19 rows in set (1.272 sec)

MySQL [ikoota_db]> select * from  surveylog;
+----+---------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------+----------------+-----------------+---------------------+---------------------+---------------------+-----------------------------------+---------------------+---------------------+-------------+------------------------+-----------------+----------------+-----------------------+--------------------------+-------------------+
| id | user_id | answers                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | verified_by | rating_remarks | approval_status | createdAt           | updatedAt           | processedAt         | admin_notes                       | application_type    | reviewed_at         | reviewed_by | application_ticket     | mentor_assigned | class_assigned | converse_id_generated | approval_decision_reason | notification_sent |
+----+---------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------+----------------+-----------------+---------------------+---------------------+---------------------+-----------------------------------+---------------------+---------------------+-------------+------------------------+-----------------+----------------+-----------------------+--------------------------+-------------------+
|  1 |       1 | ["sasa","gfg","ererre","uyuyu","vcvvc"]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |             |                | approved        | 2025-01-07 06:06:56 | 2025-07-08 15:06:58 | NULL                | NULL                              | initial_application | NULL                |        NULL | NULL                   | NULL            | NULL           | NULL                  | NULL                     |                 0 |
|  2 |       2 | ["oloill","yujyujty","yjutyhtrtrh","jjyhrhtsgaeff","gfrgrfewerewr"]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |             |                | pending         | 2025-01-07 06:08:15 | 2025-06-29 06:30:12 | NULL                | NULL                              | initial_application | NULL                |        NULL | NULL                   | NULL            | NULL           | NULL                  | NULL                     |                 0 |
|  3 |       3 | ["trfrrf","988989","zxxx","iuiuyu","2123ewds"]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |             |                | pending         | 2025-01-07 06:09:46 | 2025-06-29 06:30:12 | NULL                | NULL                              | initial_application | NULL                |        NULL | NULL                   | NULL            | NULL           | NULL                  | NULL                     |                 0 |
|  4 |       3 | {"setup": "admin_development"}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |             |                | approved        | 2025-07-03 20:48:24 | 2025-07-03 20:48:24 | 2025-07-03 20:48:24 | Admin account - development setup | initial_application | 2025-07-03 20:48:24 |           3 | NULL                   | NULL            | NULL           | NULL                  | NULL                     |                 0 |
|  5 |       3 | {"setup": "admin_development"}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |             |                | approved        | 2025-07-03 20:48:24 | 2025-07-03 20:48:24 | 2025-07-03 20:48:24 | Admin account - development setup | full_membership     | 2025-07-03 20:48:24 |           3 | NULL                   | NULL            | NULL           | NULL                  | NULL                     |                 0 |
|  6 |       3 | {"setup": "admin_development", "question1": "Admin setup", "question2": "Development purposes"}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |             |                | approved        | 2025-07-03 21:38:20 | 2025-07-03 21:38:20 | 2025-07-03 21:38:20 | Admin account - development setup | initial_application | 2025-07-03 21:38:20 |           3 | NULL                   | NULL            | NULL           | NULL                  | NULL                     |                 0 |
|  7 |       3 | {"setup": "admin_development", "fullMembership": "Admin privileges", "experience": "Development and administration"}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |             |                | approved        | 2025-07-03 21:38:20 | 2025-07-03 21:38:20 | 2025-07-03 21:38:20 | Admin account - development setup | full_membership     | 2025-07-03 21:38:20 |           3 | NULL                   | NULL            | NULL           | NULL                  | NULL                     |                 0 |
|  8 |       3 | {"setup": "admin_development"}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |             |                | approved        | 2025-07-04 00:17:34 | 2025-07-04 00:17:34 | 2025-07-04 00:17:34 | Admin account - development setup | initial_application | 2025-07-04 00:17:34 |           3 | NULL                   | NULL            | NULL           | NULL                  | NULL                     |                 0 |
|  9 |       3 | {"setup": "admin_development"}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |             |                | approved        | 2025-07-04 00:17:34 | 2025-07-04 00:17:34 | 2025-07-04 00:17:34 | Admin account - development setup | full_membership     | 2025-07-04 00:17:34 |           3 | NULL                   | NULL            | NULL           | NULL                  | NULL                     |                 0 |
| 11 |       3 | [{"question":"fullName","answer":"Monday"},{"question":"dateOfBirth","answer":"2001-01-01"},{"question":"nationality","answer":"nigeria"},{"question":"currentLocation","answer":"utah, nigeria"},{"question":"phoneNumber","answer":"+16784208200"},{"question":"highestEducation","answer":"master"},{"question":"fieldOfStudy","answer":"Mechanical"},{"question":"currentInstitution","answer":"University of Africa"},{"question":"graduationYear","answer":"2025"},{"question":"currentOccupation","answer":"Software engineering"},{"question":"workExperience","answer":"16+"},{"question":"professionalSkills","answer":""},{"question":"careerGoals","answer":""},{"question":"howDidYouHear","answer":"friend_referral"},{"question":"reasonForJoining","answer":"Learn and teach"},{"question":"expectedContributions","answer":"storytelling"},{"question":"educationalGoals","answer":"History and developemnt"},{"question":"previousMemberships","answer":""},{"question":"specialSkills","answer":""},{"question":"languagesSpoken","answer":"English, Other"},{"question":"availabilityForEvents","answer":""},{"question":"agreeToTerms","answer":"true"},{"question":"agreeToCodeOfConduct","answer":"true"},{"question":"agreeToDataProcessing","answer":"true"}] | admin       |                | approved        | 2025-07-06 08:40:33 | 2025-07-08 13:59:19 | 2025-07-06 08:40:33 | NULL                              | initial_application | 2025-07-08 13:59:19 |           3 | APP-undefined-mcrf9pz8 | NULL            | NULL           | NULL                  | NULL                     |                 0 |
| 12 |       1 | ["Application approved during setup"]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | ADMIN       |                | approved        | 2025-07-08 14:38:03 | 2025-07-08 14:38:03 | 2025-07-08 14:38:03 | Bulk approval during system setup | initial_application | 2025-07-08 14:38:03 |           2 | NULL                   | NULL            | NULL           | NULL                  | NULL                     |                 0 |
| 13 |       2 | ["Super admin setup"]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | SYSTEM      |                | approved        | 2025-07-08 14:38:23 | 2025-07-08 14:38:23 | 2025-07-08 14:38:23 | Super admin account setup         | initial_application | 2025-07-08 14:38:23 |           2 | NULL                   | NULL            | NULL           | NULL                  | NULL                     |                 0 |
+----+---------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------+----------------+-----------------+---------------------+---------------------+---------------------+-----------------------------------+---------------------+---------------------+-------------+------------------------+-----------------+----------------+-----------------------+--------------------------+-------------------+
12 rows in set (0.074 sec)

MySQL [ikoota_db]> describe teachings;
+---------------+--------------------------------------+------+-----+-------------------+-----------------------------------------------+
| Field         | Type                                 | Null | Key | Default           | Extra                                         |
+---------------+--------------------------------------+------+-----+-------------------+-----------------------------------------------+
| id            | int                                  | NO   | PRI | NULL              | auto_increment                                |
| topic         | varchar(255)                         | NO   |     | NULL              |                                               |
| description   | text                                 | YES  |     | NULL              |                                               |
| lessonNumber  | varchar(255)                         | NO   |     | NULL              |                                               |
| subjectMatter | varchar(255)                         | YES  |     | NULL              |                                               |
| audience      | varchar(255)                         | YES  |     | NULL              |                                               |
| content       | text                                 | YES  |     | NULL              |                                               |
| media_url1    | varchar(255)                         | YES  |     | NULL              |                                               |
| media_type1   | enum('image','video','audio','file') | YES  |     | NULL              |                                               |
| media_url2    | varchar(255)                         | YES  |     | NULL              |                                               |
| media_type2   | enum('image','video','audio','file') | YES  |     | NULL              |                                               |
| media_url3    | varchar(255)                         | YES  |     | NULL              |                                               |
| media_type3   | enum('image','video','audio','file') | YES  |     | NULL              |                                               |
| createdAt     | timestamp                            | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED                             |
| updatedAt     | timestamp                            | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
| user_id       | int                                  | NO   | MUL | NULL              |                                               |
| prefixed_id   | varchar(20)                          | YES  | UNI | NULL              |                                               |
+---------------+--------------------------------------+------+-----+-------------------+-----------------------------------------------+
17 rows in set (0.108 sec)

MySQL [ikoota_db]> describe user_chats;
+----------------------+--------------------------------+------+-----+-------------------+-------------------+
| Field                | Type                           | Null | Key | Default           | Extra             |
+----------------------+--------------------------------+------+-----+-------------------+-------------------+
| id                   | int                            | NO   | PRI | NULL              | auto_increment    |
| user_id              | char(10)                       | NO   | MUL | NULL              |                   |
| chat_id              | char(10)                       | NO   |     | NULL              |                   |
| last_message         | varchar(255)                   | YES  |     | NULL              |                   |
| is_seen              | tinyint(1)                     | YES  |     | 0                 |                   |
| role                 | enum('admin','member','owner') | NO   |     | NULL              |                   |
| is_muted             | tinyint(1)                     | YES  |     | 0                 |                   |
| last_read_message_id | varchar(36)                    | YES  |     | NULL              |                   |
| joined_at            | datetime                       | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| updatedAt            | timestamp                      | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
+----------------------+--------------------------------+------+-----+-------------------+-------------------+
10 rows in set (0.950 sec)

MySQL [ikoota_db]> describe user_class_details;
+--------------------+--------------------------------------------------+------+-----+-------------------+-------------------+
| Field              | Type                                             | Null | Key | Default           | Extra             |
+--------------------+--------------------------------------------------+------+-----+-------------------+-------------------+
| user_id            | int                                              | NO   |     | NULL              |                   |
| username           | varchar(255)                                     | NO   |     | NULL              |                   |
| converse_id        | varchar(12)                                      | YES  |     | NULL              |                   |
| class_id           | varchar(12)                                      | NO   |     | NULL              |                   |
| class_name         | varchar(255)                                     | NO   |     | NULL              |                   |
| public_name        | varchar(255)                                     | YES  |     | NULL              |                   |
| class_type         | enum('demographic','subject','public','special') | YES  |     | demographic       |                   |
| is_public          | tinyint(1)                                       | YES  |     | 0                 |                   |
| membership_status  | enum('active','pending','suspended','expired')   | YES  |     | active            |                   |
| role_in_class      | enum('member','moderator','assistant')           | YES  |     | member            |                   |
| can_see_class_name | tinyint(1)                                       | YES  |     | 1                 |                   |
| joined_at          | timestamp                                        | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
+--------------------+--------------------------------------------------+------+-----+-------------------+-------------------+
12 rows in set (0.533 sec)

MySQL [ikoota_db]> select * from user_class_details;
+---------+----------+-------------+------------+-------------------+------------------+------------+-----------+-------------------+---------------+--------------------+---------------------+
| user_id | username | converse_id | class_id   | class_name        | public_name      | class_type | is_public | membership_status | role_in_class | can_see_class_name | joined_at           |
+---------+----------+-------------+------------+-------------------+------------------+------------+-----------+-------------------+---------------+--------------------+---------------------+
|       7 | Monika   | OTO#8BTB9N  | OTU#Public | General Community | Public Community | public     |         1 | active            | member        |                  1 | 2025-07-20 08:28:13 |
+---------+----------+-------------+------------+-------------------+------------------+------------+-----------+-------------------+---------------+--------------------+---------------------+
1 row in set (0.546 sec)

MySQL [ikoota_db]> describe  user_class_memberships;
+-----------------------+------------------------------------------------+------+-----+-------------------+-----------------------------------------------+
| Field                 | Type                                           | Null | Key | Default           | Extra                                         |
+-----------------------+------------------------------------------------+------+-----+-------------------+-----------------------------------------------+
| id                    | int                                            | NO   | PRI | NULL              | auto_increment                                |
| user_id               | int                                            | NO   | MUL | NULL              |                                               |
| class_id              | varchar(12)                                    | NO   | MUL | NULL              |                                               |
| membership_status     | enum('active','pending','suspended','expired') | YES  | MUL | active            |                                               |
| role_in_class         | enum('member','moderator','assistant')         | YES  |     | member            |                                               |
| joined_at             | timestamp                                      | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED                             |
| assigned_by           | int                                            | YES  | MUL | NULL              |                                               |
| expires_at            | timestamp                                      | YES  |     | NULL              |                                               |
| can_see_class_name    | tinyint(1)                                     | YES  |     | 1                 |                                               |
| receive_notifications | tinyint(1)                                     | YES  |     | 1                 |                                               |
| createdAt             | timestamp                                      | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED                             |
| updatedAt             | timestamp                                      | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
+-----------------------+------------------------------------------------+------+-----+-------------------+-----------------------------------------------+
12 rows in set (0.083 sec)

MySQL [ikoota_db]> select * from  user_class_memberships;
+----+---------+------------+-------------------+---------------+---------------------+-------------+------------+--------------------+-----------------------+---------------------+---------------------+
| id | user_id | class_id   | membership_status | role_in_class | joined_at           | assigned_by | expires_at | can_see_class_name | receive_notifications | createdAt           | updatedAt           |
+----+---------+------------+-------------------+---------------+---------------------+-------------+------------+--------------------+-----------------------+---------------------+---------------------+
|  4 |       7 | OTU#Public | active            | member        | 2025-07-20 08:28:13 |        NULL | NULL       |                  1 |                     1 | 2025-07-20 08:28:13 | 2025-07-20 08:28:13 |
+----+---------+------------+-------------------+---------------+---------------------+-------------+------------+--------------------+-----------------------+---------------------+---------------------+
1 row in set (0.076 sec)

MySQL [ikoota_db]> describe user_communication_preferences;
+-----------------------+-------------+------+-----+-------------------+-----------------------------------------------+
| Field                 | Type        | Null | Key | Default           | Extra                                         |
+-----------------------+-------------+------+-----+-------------------+-----------------------------------------------+
| id                    | int         | NO   | PRI | NULL              | auto_increment                                |
| user_id               | int         | NO   | UNI | NULL              |                                               |
| email_notifications   | tinyint(1)  | YES  |     | 1                 |                                               |
| sms_notifications     | tinyint(1)  | YES  |     | 0                 |                                               |
| marketing_emails      | tinyint(1)  | YES  |     | 1                 |                                               |
| marketing_sms         | tinyint(1)  | YES  |     | 0                 |                                               |
| survey_notifications  | tinyint(1)  | YES  |     | 1                 |                                               |
| content_notifications | tinyint(1)  | YES  |     | 1                 |                                               |
| admin_notifications   | tinyint(1)  | YES  |     | 1                 |                                               |
| preferred_language    | varchar(10) | YES  |     | en                |                                               |
| timezone              | varchar(50) | YES  |     | UTC               |                                               |
| createdAt             | timestamp   | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED                             |
| updatedAt             | timestamp   | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
| converse_id           | char(10)    | YES  | MUL | NULL              |                                               |
+-----------------------+-------------+------+-----+-------------------+-----------------------------------------------+
14 rows in set (0.050 sec)

MySQL [ikoota_db]> select * from user_communication_preferences;
+----+---------+---------------------+-------------------+------------------+---------------+----------------------+-----------------------+---------------------+--------------------+----------+---------------------+---------------------+-------------+
| id | user_id | email_notifications | sms_notifications | marketing_emails | marketing_sms | survey_notifications | content_notifications | admin_notifications | preferred_language | timezone | createdAt           | updatedAt           | converse_id |
+----+---------+---------------------+-------------------+------------------+---------------+----------------------+-----------------------+---------------------+--------------------+----------+---------------------+---------------------+-------------+
|  1 |       1 |                   1 |                 0 |                1 |             0 |                    1 |                     1 |                   1 | en                 | UTC      | 2025-06-29 08:17:05 | 2025-06-29 08:17:05 | NULL        |
|  2 |       2 |                   1 |                 0 |                1 |             0 |                    1 |                     1 |                   1 | en                 | UTC      | 2025-06-29 08:17:05 | 2025-06-29 08:17:05 | NULL        |
|  3 |       3 |                   1 |                 0 |                1 |             0 |                    1 |                     1 |                   1 | en                 | UTC      | 2025-06-29 08:17:05 | 2025-06-29 08:17:05 | NULL        |
+----+---------+---------------------+-------------------+------------------+---------------+----------------------+-----------------------+---------------------+--------------------+----------+---------------------+---------------------+-------------+
3 rows in set (0.097 sec)

MySQL [ikoota_db]> describe user_profiles;
+--------------------+--------------+------+-----+-------------------+-------------------+
| Field              | Type         | Null | Key | Default           | Extra             |
+--------------------+--------------+------+-----+-------------------+-------------------+
| id                 | int          | NO   | PRI | NULL              | auto_increment    |
| user_id            | int          | NO   | UNI | NULL              |                   |
| encrypted_username | text         | NO   |     | NULL              |                   |
| encrypted_email    | text         | NO   |     | NULL              |                   |
| encrypted_phone    | text         | YES  |     | NULL              |                   |
| encryption_key     | varchar(255) | YES  |     | NULL              |                   |
| createdAt          | timestamp    | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| updatedAt          | timestamp    | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
+--------------------+--------------+------+-----+-------------------+-------------------+
8 rows in set (0.095 sec)

MySQL [ikoota_db]> select * from user_profiles;
Empty set (0.093 sec)

MySQL [ikoota_db]> describe users;
+-----------------------------+---------------------------------------------------------------------------------------------+------+-----+-------------------+-------------------+
| Field                       | Type                                                                                        | Null | Key | Default           | Extra             |
+-----------------------------+---------------------------------------------------------------------------------------------+------+-----+-------------------+-------------------+
| id                          | int                                                                                         | NO   | PRI | NULL              | auto_increment    |
| username                    | varchar(255)                                                                                | NO   | MUL | NULL              |                   |
| email                       | varchar(255)                                                                                | NO   | MUL | NULL              |                   |
| phone                       | varchar(15)                                                                                 | YES  |     | NULL              |                   |
| avatar                      | varchar(255)                                                                                | YES  |     | NULL              |                   |
| password_hash               | varchar(255)                                                                                | NO   |     | NULL              |                   |
| converse_id                 | varchar(12)                                                                                 | YES  | UNI | NULL              |                   |
| application_ticket          | varchar(20)                                                                                 | YES  | MUL | NULL              |                   |
| mentor_id                   | char(10)                                                                                    | YES  | MUL | NULL              |                   |
| primary_class_id            | varchar(12)                                                                                 | YES  | MUL | NULL              |                   |
| is_member                   | enum('applied','pending','suspended','granted','declined','pre_member','member','rejected') | YES  | MUL | applied           |                   |
| membership_stage            | enum('none','applicant','pre_member','member')                                              | YES  | MUL | none              |                   |
| full_membership_ticket      | varchar(25)                                                                                 | YES  |     | NULL              |                   |
| full_membership_status      | enum('not_applied','applied','pending','suspended','approved','declined')                   | YES  | MUL | not_applied       |                   |
| full_membership_applied_at  | timestamp                                                                                   | YES  | MUL | NULL              |                   |
| full_membership_reviewed_at | timestamp                                                                                   | YES  |     | NULL              |                   |
| role                        | enum('super_admin','admin','user')                                                          | YES  |     | user              |                   |
| isblocked                   | json                                                                                        | YES  |     | NULL              |                   |
| isbanned                    | tinyint(1)                                                                                  | YES  |     | 0                 |                   |
| createdAt                   | timestamp                                                                                   | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| updatedAt                   | timestamp                                                                                   | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
| resetToken                  | varchar(255)                                                                                | YES  |     | NULL              |                   |
| resetTokenExpiry            | bigint                                                                                      | YES  |     | NULL              |                   |
| verification_method         | enum('email','phone')                                                                       | YES  |     | NULL              |                   |
| verification_code           | varchar(10)                                                                                 | YES  |     | NULL              |                   |
| is_verified                 | tinyint(1)                                                                                  | YES  | MUL | 0                 |                   |
| codeExpiry                  | bigint                                                                                      | YES  |     | NULL              |                   |
| converse_avatar             | varchar(255)                                                                                | YES  |     | NULL              |                   |
| is_identity_masked          | tinyint(1)                                                                                  | YES  |     | 0                 |                   |
| total_classes               | int                                                                                         | YES  |     | 0                 |                   |
| application_status          | enum('not_submitted','submitted','under_review','approved','declined')                      | YES  | MUL | not_submitted     |                   |
| application_submitted_at    | timestamp                                                                                   | YES  |     | NULL              |                   |
| application_reviewed_at     | timestamp                                                                                   | YES  |     | NULL              |                   |
| reviewed_by                 | int                                                                                         | YES  | MUL | NULL              |                   |
| decline_reason              | text                                                                                        | YES  |     | NULL              |                   |
| decline_notification_sent   | tinyint(1)                                                                                  | YES  |     | 0                 |                   |
+-----------------------------+---------------------------------------------------------------------------------------------+------+-----+-------------------+-------------------+
36 rows in set (0.099 sec)

MySQL [ikoota_db]> select * from users;
+----+-----------+-------------------------+------------+--------+--------------------------------------------------------------+-------------+----------------------+-----------+------------------+-----------+------------------+------------------------+------------------------+----------------------------+-----------------------------+-------------+-----------+----------+---------------------+---------------------+------------+------------------+---------------------+-------------------+-------------+------------+-----------------+--------------------+---------------+--------------------+--------------------------+-------------------------+-------------+----------------+---------------------------+
| id | username  | email                   | phone      | avatar | password_hash                                                | converse_id | application_ticket   | mentor_id | primary_class_id | is_member | membership_stage | full_membership_ticket | full_membership_status | full_membership_applied_at | full_membership_reviewed_at | role        | isblocked | isbanned | createdAt           | updatedAt           | resetToken | resetTokenExpiry | verification_method | verification_code | is_verified | codeExpiry | converse_avatar | is_identity_masked | total_classes | application_status | application_submitted_at | application_reviewed_at | reviewed_by | decline_reason | decline_notification_sent |
+----+-----------+-------------------------+------------+--------+--------------------------------------------------------------+-------------+----------------------+-----------+------------------+-----------+------------------+------------------------+------------------------+----------------------------+-----------------------------+-------------+-----------+----------+---------------------+---------------------+------------+------------------+---------------------+-------------------+-------------+------------+-----------------+--------------------+---------------+--------------------+--------------------------+-------------------------+-------------+----------------+---------------------------+
|  1 | abc       | abc@abc.com             | 1234       | NULL   | $2b$10$H6fjXoIqCC79PYlQzsgkLOjxgZh1EFRZfr79ISvFDeTBDcdRes2AK | OTO#B001H1  | NULL                 | NULL      | NULL             | member    | member           | NULL                   | not_applied            | NULL                       | NULL                        | user        | NULL      |        0 | 2025-01-07 06:06:41 | 2025-07-21 02:13:32 | NULL       |             NULL | NULL                | NULL              |           1 |       NULL | NULL            |                  0 |             0 | approved           | 2025-01-07 06:06:56      | NULL                    |        NULL | NULL           |                         0 |
|  2 | pet       | petersomond@gmail.com   | 123456     | NULL   | $2b$10$fUOHFXtTWxRaky0kJ0h5zuxTrBaJbjUpc0MncBcBzbudxaHSlURk6 | OTO#C002O2  | NULL                 | NULL      | NULL             | member    | member           | NULL                   | not_applied            | NULL                       | NULL                        | super_admin | NULL      |        0 | 2025-01-07 06:08:01 | 2025-07-21 02:13:32 | NULL       |             NULL | NULL                | NULL              |           1 |       NULL | NULL            |                  0 |             0 | submitted          | 2025-01-07 06:08:15      | NULL                    |        NULL | NULL           |                         0 |
|  3 | yahoomond | peters_o_mond@yahoo.com | 54321      | NULL   | $2b$10$yRQW/vsAzFOj/NV1KpV7/eSTzpt1caaEtr9BGk/5W84KB5CsbX7/a | OTO#D003V3  | APP-undefined-mcrf9p | NULL      | NULL             | member    | member           | NULL                   | not_applied            | NULL                       | NULL                        | admin       | NULL      |        0 | 2025-01-07 06:09:31 | 2025-07-21 02:13:32 | NULL       |             NULL | NULL                | NULL              |           1 |       NULL | NULL            |                  0 |             0 | submitted          | 2025-01-07 06:09:46      | NULL                    |        NULL | NULL           |                         0 |
|  7 | Monika    | peterslmonika@gmail.com | 7703769866 | NULL   | $2b$12$G8Kn7zUcQVE7hSvQRQW7runqaN2cV5rFeA5dhGDSuN2U34Wwvbjw. | OTO#8BTB9N  | APP-MON-MDBEZSN9-3PV | NULL      | OTU#Public       | applied   | none             | NULL                   | not_applied            | NULL                       | NULL                        | user        | NULL      |        0 | 2025-07-20 08:28:13 | 2025-07-21 02:13:46 | NULL       |             NULL | email               | NULL              |           1 |       NULL | NULL            |                  0 |             1 | not_submitted      | NULL                     | NULL                    |        NULL | NULL           |                         0 |
+----+-----------+-------------------------+------------+--------+--------------------------------------------------------------+-------------+----------------------+-----------+------------------+-----------+------------------+------------------------+------------------------+----------------------------+-----------------------------+-------------+-----------+----------+---------------------+---------------------+------------+------------------+---------------------+-------------------+-------------+------------+-----------------+--------------------+---------------+--------------------+--------------------------+-------------------------+-------------+----------------+---------------------------+
4 rows in set (0.092 sec)

MySQL [ikoota_db]> describe verification_codes;
+-----------+-----------------------+------+-----+-------------------+-------------------+
| Field     | Type                  | Null | Key | Default           | Extra             |
+-----------+-----------------------+------+-----+-------------------+-------------------+
| id        | int                   | NO   | PRI | NULL              | auto_increment    |
| email     | varchar(255)          | NO   | MUL | NULL              |                   |
| phone     | varchar(15)           | YES  |     | NULL              |                   |
| code      | varchar(10)           | NO   |     | NULL              |                   |
| method    | enum('email','phone') | NO   |     | NULL              |                   |
| expiresAt | timestamp             | NO   | MUL | NULL              |                   |
| createdAt | timestamp             | YES  |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED |
+-----------+-----------------------+------+-----+-------------------+-------------------+
7 rows in set (0.095 sec)

MySQL [ikoota_db]> select * from verification_codes;
+----+-------------------------+------------+--------+--------+---------------------+---------------------+
| id | email                   | phone      | code   | method | expiresAt           | createdAt           |
+----+-------------------------+------------+--------+--------+---------------------+---------------------+
| 14 | peterslmonika@gmail.com | 7703769866 | 305902 | email  | 2025-07-20 08:29:40 | 2025-07-20 08:19:40 |
+----+-------------------------+------------+--------+--------+---------------------+---------------------+
1 row in set (0.109 sec)

MySQL [ikoota_db]>










































//  FRONTEND FILES TO COLLATE API calls.

//============================
// HOOKS FOLDER
//===========================

// ikootaclient/src/hooks/useUserStatus.js
import { useState, useEffect } from 'react';
import api from '../components/service/api';

export const useUserStatus = () => {
  const [userStatus, setUserStatus] = useState(null);
  const [surveyStatus, setSurveyStatus] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  // ✅ NEW: Check survey status function
  const checkSurveyStatus = async () => {
    try {
      const token = localStorage.getItem('token');
      if (!token) {
        console.log('🔍 No token found, skipping survey status check');
        return null;
      }

      // Set authorization header
      api.defaults.headers.common['Authorization'] = `Bearer ${token}`;
      
      const response = await api.get('/membership/survey/check-status');
      
      if (response.data) {
        console.log('📋 Survey status fetched:', response.data);
        setSurveyStatus(response.data);
        return response.data;
      }
    } catch (err) {
      console.log('Failed to get survey status:', err);
      
      // Handle specific error cases
      if (err.response?.status === 401) {
        console.log('🔍 Token expired or invalid for survey check');
        localStorage.removeItem('token');
        delete api.defaults.headers.common['Authorization'];
        setSurveyStatus(null);
        return null;
      } else if (err.response?.status === 404) {
        // Survey endpoint doesn't exist or user has no survey
        console.log('🔍 No survey data found for user');
        setSurveyStatus({ needs_survey: true, survey_completed: false });
        return { needs_survey: true, survey_completed: false };
      } else {
        console.warn('⚠️ Survey status check failed:', err.message);
        return null;
      }
    }
  };

  const getUserStatus = async () => {
    try {
      setLoading(true);
      setError(null);
      
      // Check if user is authenticated first
      const token = localStorage.getItem('token');
      if (!token) {
        console.log('🔍 No token found, skipping user status fetch');
        setUserStatus(null);
        setSurveyStatus(null);
        setLoading(false);
        return;
      }

      // Set authorization header
      api.defaults.headers.common['Authorization'] = `Bearer ${token}`;
      
      // ✅ ENHANCED: Fetch both user status and survey status
      const [userResponse, surveyData] = await Promise.allSettled([
        api.get('/membership/dashboard'),
        checkSurveyStatus()
      ]);

      // Handle user status response
      if (userResponse.status === 'fulfilled' && userResponse.value?.data) {
        setUserStatus(userResponse.value.data);
      } else if (userResponse.status === 'rejected') {
        const err = userResponse.reason;
        
        if (err.response?.status === 401) {
          console.log('🔍 Token expired or invalid, clearing auth data');
          localStorage.removeItem('token');
          delete api.defaults.headers.common['Authorization'];
          setUserStatus(null);
          setSurveyStatus(null);
          setError(null);
        } else if (err.response?.status === 403) {
          console.log('🔍 User lacks permission for dashboard');
          setError('Access denied');
        } else {
          setError(err.message || 'Failed to fetch user status');
        }
      }

      // Survey status is already handled in checkSurveyStatus function
      
    } catch (err) {
      console.log('Failed to get user status:', err);
      setError(err.message || 'Failed to fetch user status');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    // Only fetch user status if we have a token
    const token = localStorage.getItem('token');
    if (token) {
      getUserStatus();
    } else {
      setLoading(false);
    }
  }, []);

  const refreshStatus = () => {
    getUserStatus();
  };

  // ✅ NEW: Refresh only survey status
  const refreshSurveyStatus = () => {
    checkSurveyStatus();
  };

  // ✅ NEW: Helper function to determine if user should be redirected to survey
  const shouldRedirectToSurvey = () => {
    if (!userStatus || !surveyStatus) return false;
    
    // Only redirect regular users (not admins) who need to complete survey
    return (
      userStatus.role === 'user' && 
      (surveyStatus.needs_survey || !surveyStatus.survey_completed)
    );
  };

  // ✅ NEW: Helper function to get appropriate redirect path
  const getRedirectPath = () => {
    if (shouldRedirectToSurvey()) {
      return '/applicationsurvey';
    }
    
    // Use existing logic for other redirects
    if (userStatus?.role === 'admin' || userStatus?.role === 'super_admin') {
      return '/admin';
    } else if (userStatus?.is_member === 'granted') {
      return '/iko';
    } else if (userStatus?.is_member === 'applied' || userStatus?.is_member === 'pending') {
      return '/pending-verification';
    } else {
      return '/towncrier';
    }
  };

  return {
    userStatus,
    surveyStatus, // ✅ NEW: Expose survey status
    loading,
    error,
    refreshStatus,
    refreshSurveyStatus, // ✅ NEW: Function to refresh only survey status
    shouldRedirectToSurvey, // ✅ NEW: Helper for survey redirect logic
    getRedirectPath, // ✅ NEW: Helper for getting redirect path
    checkSurveyStatus // ✅ NEW: Expose survey check function
  };
};

// Also provide default export for compatibility
export default useUserStatus;



//==================================  

 //ikootaclient\src\hooks\useUploadCommentFiles.js
 import { useMutation } from "@tanstack/react-query";


export const useUploadCommentFiles = () => {
  const mutation = useMutation(async (files) => {
    const formData = new FormData();
    files.forEach((file) => {
      formData.append('files', file);
    });

    const response = await api.post('/comments/upload', formData, {
      headers: {
        'Content-Type': 'multipart/form-data',
      },
    });

    return response.data;
  });

  return mutation;
};

//=================================

import { useMutation } from "@tanstack/react-query";
import api from "../components/service/api";





const useUpload = (endpoint) => {
  const mutation = useMutation(async (formData) => {
    const response = await api.post(endpoint, formData, {
      headers: {
        'Content-Type': 'multipart/form-data',
      },
    });
    return response.data;
  });

  const validateFiles = (files) => {
    // Add file validation logic if needed
    return true;
  };

  return { validateFiles, mutation };
};

export default useUpload;


//=====================

// ikootaclient/src/hooks/useDynamicLabels.js
// Hook to fetch dynamic question labels for the survey form

import { useState, useEffect } from 'react';
import api from '../components/service/api';

// Default labels - fallback if API fails
const DEFAULT_LABELS = {
  fullName: 'Full Name',
  dateOfBirth: 'Date of Birth',
  nationality: 'Nationality',
  currentLocation: 'Current Location',
  phoneNumber: 'Phone Number',
  highestEducation: 'Highest Level of Education',
  fieldOfStudy: 'Field of Study',
  currentInstitution: 'Current/Most Recent Institution',
  graduationYear: 'Graduation Year',
  currentOccupation: 'Current Occupation',
  workExperience: 'Years of Work Experience',
  professionalSkills: 'Professional Skills',
  careerGoals: 'Career Goals',
  howDidYouHear: 'How did you hear about Ikoota?',
  reasonForJoining: 'Why do you want to join Ikoota?',
  expectedContributions: 'How do you plan to contribute to the community?',
  educationalGoals: 'What are your educational goals?',
  previousMemberships: 'Previous Memberships',
  specialSkills: 'Special Skills',
  languagesSpoken: 'Languages Spoken',
  availabilityForEvents: 'Availability for Events',
  agreeToTerms: 'I agree to the Terms and Conditions',
  agreeToCodeOfConduct: 'I agree to follow the Community Code of Conduct',
  agreeToDataProcessing: 'I consent to processing of my personal data'
};

export const useDynamicLabels = () => {
  const [labels, setLabels] = useState(DEFAULT_LABELS);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const fetchLabels = async () => {
      try {
        console.log('🔍 Fetching dynamic question labels...');
        const response = await api.get('/survey/question-labels');
        
        let fetchedLabels;
        if (response.data?.success && response.data?.data) {
          fetchedLabels = response.data.data;
        } else if (typeof response.data === 'object') {
          fetchedLabels = response.data;
        } else {
          throw new Error('Invalid response format');
        }
        
        // Merge with defaults to ensure all fields have labels
        const mergedLabels = { ...DEFAULT_LABELS, ...fetchedLabels };
        setLabels(mergedLabels);
        console.log('✅ Dynamic labels loaded successfully');
        
      } catch (err) {
        console.warn('⚠️ Failed to fetch dynamic labels, using defaults:', err.message);
        setError(err.message);
        // Keep using default labels
      } finally {
        setLoading(false);
      }
    };

    fetchLabels();
  }, []);

  return { labels, loading, error };
};


//===================

// ikootaclient/src/hooks/useAuth.js
import { useState, useEffect } from 'react';
import { jwtDecode } from 'jwt-decode';

export const useAuth = () => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const checkAuth = () => {
      const token = localStorage.getItem("token");
      
      if (!token) {
        // Check for token in cookies
        const tokenCookie = document.cookie.split("; ").find((row) => row.startsWith("access_token="));
        if (tokenCookie) {
          const cookieToken = tokenCookie.split("=")[1];
          try {
            const decoded = jwtDecode(cookieToken);
            if (decoded.exp * 1000 > Date.now()) {
              setUser(decoded);
            }
          } catch (error) {
            console.error('Invalid token in cookie');
          }
        }
        setLoading(false);
        return;
      }
      
      try {
        const decoded = jwtDecode(token);
        if (decoded.exp * 1000 > Date.now()) {
          setUser(decoded);
        } else {
          localStorage.removeItem("token");
        }
      } catch (error) {
        localStorage.removeItem("token");
      }
      
      setLoading(false);
    };

    checkAuth();
  }, []);

  const login = (token) => {
    localStorage.setItem("token", token);
    try {
      const decoded = jwtDecode(token);
      setUser(decoded);
    } catch (error) {
      console.error('Invalid token provided to login');
    }
  };

  const logout = () => {
    localStorage.removeItem("token");
    document.cookie = "access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
    setUser(null);
  };

  return {
    user,
    loading,
    isAuthenticated: !!user,
    isAdmin: user?.role === 'admin' || user?.isAdmin === true,
    login,
    logout
  };
};

//==============================
//utils FOLDER
//================================


// ikootaclient/src/components/ErrorBoundary.jsx
import React from 'react';

class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false, error: null, errorInfo: null };
  }

  static getDerivedStateFromError(error) {
    // Update state so the next render will show the fallback UI
    return { hasError: true };
  }

  componentDidCatch(error, errorInfo) {
    // Log the error to console
    console.error('ErrorBoundary caught an error:', error, errorInfo);
    
    this.setState({
      error: error,
      errorInfo: errorInfo
    });
  }

  render() {
    if (this.state.hasError) {
      // Fallback UI
      return (
        <div style={{
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          minHeight: '100vh',
          padding: '20px',
          textAlign: 'center',
          backgroundColor: '#f8f9fa'
        }}>
          <div style={{
            background: 'white',
            padding: '40px',
            borderRadius: '12px',
            boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)',
            maxWidth: '500px',
            width: '100%'
          }}>
            <h1 style={{ 
              color: '#e74c3c', 
              fontSize: '2rem', 
              marginBottom: '20px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              gap: '10px'
            }}>
              ⚠️ Something went wrong
            </h1>
            
            <p style={{ 
              color: '#666', 
              marginBottom: '30px',
              lineHeight: '1.6'
            }}>
              We encountered an unexpected error. This usually resolves itself when you refresh the page.
            </p>
            
            <div style={{ display: 'flex', gap: '10px', justifyContent: 'center' }}>
              <button 
                onClick={() => window.location.reload()}
                style={{
                  background: '#667eea',
                  color: 'white',
                  border: 'none',
                  padding: '12px 24px',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontWeight: '600',
                  fontSize: '14px'
                }}
              >
                🔄 Refresh Page
              </button>
              
              <button 
                onClick={() => window.location.href = '/'}
                style={{
                  background: '#f8f9fa',
                  color: '#666',
                  border: '1px solid #ddd',
                  padding: '12px 24px',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontWeight: '600',
                  fontSize: '14px'
                }}
              >
                🏠 Go Home
              </button>
            </div>
            
            {process.env.NODE_ENV === 'development' && this.state.error && (
              <details style={{ 
                marginTop: '30px', 
                textAlign: 'left',
                background: '#f8f8f8',
                padding: '15px',
                borderRadius: '6px',
                fontSize: '12px'
              }}>
                <summary style={{ cursor: 'pointer', fontWeight: 'bold', marginBottom: '10px' }}>
                  🐛 Error Details (Development Only)
                </summary>
                <pre style={{ 
                  whiteSpace: 'pre-wrap',
                  color: '#e74c3c',
                  fontSize: '11px',
                  lineHeight: '1.4'
                }}>
                  {this.state.error && this.state.error.toString()}
                  <br />
                  {this.state.errorInfo.componentStack}
                </pre>
              </details>
            )}
          </div>
        </div>
      );
    }

    return this.props.children;
  }
}

export default ErrorBoundary;



//===============================


// ikootaclient/src/components/utils/IdDisplay.jsx
// Utility component for displaying entity IDs

import React from 'react';
import { validateIdFormat, getEntityTypeFromId } from '../service/idGenerationService';

export const EntityIdDisplay = ({ id, entityName }) => {
  const entityType = getEntityTypeFromId(id);
  const isValid = validateIdFormat(id, entityType);
  
  return (
    <div className="entity-id-display">
      <span className="entity-name">{entityName}:</span>
      <span className={`entity-id ${isValid ? 'valid-id' : 'invalid-id'}`}>
        {id}
      </span>
      <span className="entity-type">
        ({entityType === 'user' ? 'Person' : 'Class'})
      </span>
      {!isValid && <span className="error-indicator"> ⚠️ Invalid format</span>}
    </div>
  );
};

// Hook for bulk ID operations
export const useBulkIdOperations = () => {
  const handleBulkIdGeneration = async (count, type) => {
    try {
      const response = await api.post('/admin/generate-bulk-ids', {
        count,
        type
      });
      
      console.log('Generated IDs:', response.data.ids);
      return response.data.ids;
    } catch (error) {
      console.error('Bulk generation failed:', error);
      throw error;
    }
  };

  return { handleBulkIdGeneration };
};

// Hook for ID format migration
export const useIdMigration = () => {
  const migrateOldIds = (users) => {
    const usersNeedingMigration = users.filter(user => 
      user.converse_id && user.converse_id.length !== 10
    );
    
    usersNeedingMigration.forEach(user => {
      console.log(`User ${user.id} needs ID migration: ${user.converse_id}`);
    });
    
    return usersNeedingMigration;
  };

  return { migrateOldIds };
};

// Example component using utility functions
export const UserIdCard = ({ user }) => {
  return (
    <div className="user-id-card">
      <EntityIdDisplay id={user.converse_id} entityName="User ID" />
      {user.class_id && (
        <EntityIdDisplay id={user.class_id} entityName="Class ID" />
      )}
      {user.mentor_id && (
        <EntityIdDisplay id={user.mentor_id} entityName="Mentor ID" />
      )}
    </div>
  );
};


//=============================


// ikootaclient/src/components/utils/DebugWrapper.jsx
// Temporary debugging component to identify the source of infinite loops

import React, { useEffect, useRef } from 'react';

const DebugWrapper = ({ children, name = 'Component' }) => {
  const renderCount = useRef(0);
  const lastRenderTime = useRef(Date.now());

  useEffect(() => {
    renderCount.current += 1;
    const now = Date.now();
    const timeSinceLastRender = now - lastRenderTime.current;
    
    console.log(`🔍 ${name} rendered ${renderCount.current} times. Time since last render: ${timeSinceLastRender}ms`);
    
    if (timeSinceLastRender < 100 && renderCount.current > 10) {
      console.error(`🚨 INFINITE LOOP DETECTED in ${name}! Rendered ${renderCount.current} times in quick succession.`);
      console.trace('Stack trace:');
    }
    
    lastRenderTime.current = now;
  });

  return children;
};

export default DebugWrapper;


//=======================================

// 1. FRONTEND INTERCEPTOR (ikootaclient/src/utils/apiTracer.js)
// ============================================================================

import axios from 'axios';

class APITracer {
  constructor() {
    this.traces = new Map();
    this.setupInterceptors();
  }

  generateTraceId() {
    return `trace_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  }

  setupInterceptors() {
    // Request interceptor
    axios.interceptors.request.use(
      (config) => {
        const traceId = this.generateTraceId();
        config.headers['X-Trace-Id'] = traceId;
        
        const trace = {
          traceId,
          method: config.method.toUpperCase(),
          url: config.url,
          baseURL: config.baseURL,
          fullUrl: `${config.baseURL || ''}${config.url}`,
          headers: config.headers,
          data: config.data,
          params: config.params,
          timestamp: new Date().toISOString(),
          stages: []
        };

        // Add frontend stage
        trace.stages.push({
          stage: 'FRONTEND_REQUEST',
          timestamp: new Date().toISOString(),
          location: this.getCallerLocation(),
          data: {
            method: config.method,
            url: config.url,
            headers: config.headers,
            payload: config.data
          }
        });

        this.traces.set(traceId, trace);
        
        console.log('🚀 API TRACE STARTED:', {
          traceId,
          method: config.method.toUpperCase(),
          url: config.url,
          timestamp: trace.timestamp
        });

        return config;
      },
      (error) => {
        console.error('❌ REQUEST INTERCEPTOR ERROR:', error);
        return Promise.reject(error);
      }
    );

    // Response interceptor
    axios.interceptors.response.use(
      (response) => {
        const traceId = response.config.headers['X-Trace-Id'];
        const trace = this.traces.get(traceId);

        if (trace) {
          trace.stages.push({
            stage: 'FRONTEND_RESPONSE',
            timestamp: new Date().toISOString(),
            data: {
              status: response.status,
              statusText: response.statusText,
              headers: response.headers,
              data: response.data
            }
          });

          trace.completed = true;
          trace.completedAt = new Date().toISOString();
          trace.duration = Date.now() - new Date(trace.timestamp).getTime();

          this.logCompleteTrace(trace);
        }

        return response;
      },
      (error) => {
        const traceId = error.config?.headers['X-Trace-Id'];
        const trace = this.traces.get(traceId);

        if (trace) {
          trace.stages.push({
            stage: 'FRONTEND_ERROR',
            timestamp: new Date().toISOString(),
            data: {
              error: error.message,
              status: error.response?.status,
              statusText: error.response?.statusText,
              responseData: error.response?.data
            }
          });

          trace.error = true;
          trace.completedAt = new Date().toISOString();
          trace.duration = Date.now() - new Date(trace.timestamp).getTime();

          this.logCompleteTrace(trace);
        }

        return Promise.reject(error);
      }
    );
  }

  getCallerLocation() {
    const stack = new Error().stack;
    const lines = stack.split('\n');
    // Find the line that contains the actual caller (not interceptor)
    for (let i = 2; i < lines.length; i++) {
      if (!lines[i].includes('interceptor') && !lines[i].includes('apiTracer')) {
        return lines[i].trim();
      }
    }
    return 'Unknown location';
  }

  logCompleteTrace(trace) {
    console.group(`📊 COMPLETE API TRACE: ${trace.traceId}`);
    console.log('🎯 Request:', `${trace.method} ${trace.fullUrl}`);
    console.log('⏱️ Duration:', `${trace.duration}ms`);
    console.log('📍 Stages:', trace.stages.length);
    
    trace.stages.forEach((stage, index) => {
      console.group(`${index + 1}. ${stage.stage}`);
      console.log('⏰ Timestamp:', stage.timestamp);
      console.log('📄 Data:', stage.data);
      if (stage.location) console.log('📍 Location:', stage.location);
      console.groupEnd();
    });
    
    console.groupEnd();

    // Store for debugging
    window.apiTraces = window.apiTraces || [];
    window.apiTraces.push(trace);
  }

  getTrace(traceId) {
    return this.traces.get(traceId);
  }

  getAllTraces() {
    return Array.from(this.traces.values());
  }
}

// Initialize tracer
const apiTracer = new APITracer();
export default apiTracer;

//====================================


// ikootaclient/src/components/utils/apiDebugHelper.js
// Utility to help debug API response issues

export const debugApiResponse = (response, endpoint = 'unknown') => {
  console.group(`🔍 API Debug: ${endpoint}`);
  
  console.log('📡 Full Response:', response);
  console.log('📋 Response Status:', response?.status);
  console.log('📄 Response Headers:', response?.headers);
  console.log('💾 Response Data:', response?.data);
  console.log('🔧 Data Type:', typeof response?.data);
  console.log('📏 Is Array:', Array.isArray(response?.data));
  
  if (response?.data && typeof response.data === 'object') {
    console.log('🗂️ Object Keys:', Object.keys(response.data));
    
    // Check for common array properties
    const commonArrayKeys = ['data', 'teachings', 'results', 'items', 'list'];
    commonArrayKeys.forEach(key => {
      if (response.data[key]) {
        console.log(`📂 Found "${key}":`, response.data[key]);
        console.log(`📂 "${key}" is array:`, Array.isArray(response.data[key]));
      }
    });
  }
  
  console.groupEnd();
  return response;
};

export const normalizeTeachingsResponse = (response) => {
  console.log('🔄 Normalizing teachings response...');
  
  let teachingsData = [];
  
  try {
    if (!response || !response.data) {
      console.warn('⚠️ No response data found');
      return [];
    }
    
    const data = response.data;
    
    // Try different possible structures
    if (Array.isArray(data)) {
      console.log('✅ Data is direct array');
      teachingsData = data;
    } else if (data.data && Array.isArray(data.data)) {
      console.log('✅ Data found in data.data');
      teachingsData = data.data;
    } else if (data.teachings && Array.isArray(data.teachings)) {
      console.log('✅ Data found in data.teachings');
      teachingsData = data.teachings;
    } else if (data.results && Array.isArray(data.results)) {
      console.log('✅ Data found in data.results');
      teachingsData = data.results;
    } else if (data.items && Array.isArray(data.items)) {
      console.log('✅ Data found in data.items');
      teachingsData = data.items;
    } else if (typeof data === 'object') {
      console.log('⚠️ Data is object, checking for array properties...');
      
      // Find any array property
      const arrayProp = Object.keys(data).find(key => Array.isArray(data[key]));
      if (arrayProp) {
        console.log(`✅ Found array in property: ${arrayProp}`);
        teachingsData = data[arrayProp];
      } else {
        console.log('⚠️ No array found, wrapping single object');
        teachingsData = [data];
      }
    } else {
      console.error('❌ Unknown data structure:', typeof data);
      teachingsData = [];
    }
    
    console.log(`📊 Normalized to ${teachingsData.length} teachings`);
    return teachingsData;
    
  } catch (error) {
    console.error('❌ Error normalizing response:', error);
    return [];
  }
};

export const enhanceTeaching = (teaching, index = 0) => {
  return {
    ...teaching,
    // Ensure required fields exist
    id: teaching.id || `temp-${index}`,
    content_type: 'teaching',
    content_title: teaching.topic || teaching.title || 'Untitled Teaching',
    prefixed_id: teaching.prefixed_id || `t${teaching.id || index}`,
    display_date: teaching.updatedAt || teaching.createdAt || new Date().toISOString(),
    author: teaching.author || teaching.user_id || teaching.created_by || 'Admin',
    topic: teaching.topic || teaching.title || 'Untitled',
    description: teaching.description || 'No description available',
    subjectMatter: teaching.subjectMatter || teaching.subject || 'Not specified',
    audience: teaching.audience || 'General'
  };
};

// Test function to check API endpoint
export const testTeachingsEndpoint = async (api) => {
  console.group('🧪 Testing Teachings Endpoint');
  
  try {
    console.log('📡 Making request to /teachings...');
    const response = await api.get('/teachings');
    
    debugApiResponse(response, '/teachings');
    
    const normalized = normalizeTeachingsResponse(response);
    console.log('📊 Normalized data:', normalized);
    
    if (normalized.length > 0) {
      console.log('📋 Sample teaching:', normalized[0]);
      console.log('🔧 Enhanced sample:', enhanceTeaching(normalized[0]));
    }
    
    console.log('✅ Endpoint test completed successfully');
    return normalized;
    
  } catch (error) {
    console.error('❌ Endpoint test failed:', error);
    console.error('📋 Error details:', {
      message: error.message,
      status: error.response?.status,
      data: error.response?.data
    });
    return [];
  } finally {
    console.groupEnd();
  }
};

//================================
//user FOLDER
//=================================


// ikootaclient/src/components/user/UserDashboard.jsx - CLEAN VERSION
import React, { useState } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useUser } from '../auth/UserStatus';
import { getUserAccess } from '../config/accessMatrix';
import api from '../service/api'; 
import './UserDashboard.css';
import { useNavigate } from 'react-router-dom';
import axios from 'axios';

// ==================================================
// API FUNCTIONS
// ==================================================

const fetchUserDashboard = async () => {
  const token = localStorage.getItem("token");
  const { data } = await api.get('/membership/dashboard', {
    headers: { Authorization: `Bearer ${token}` }
  });
  return data;
};

const markNotificationAsRead = async (notificationId) => {
  const token = localStorage.getItem("token");
  const { data } = await api.put(`/user/notifications/${notificationId}/read`, {}, {
    headers: { Authorization: `Bearer ${token}` }
  });
  return data;
};

// ==================================================
// COMPONENT SECTIONS
// ==================================================

const MembershipStatus = ({ status, onApplyClick }) => {
  console.log('🔍 MembershipStatus received status:', status);
  
  if (!status) return (
    <div className="membership-status loading">
      <div className="loading-spinner"></div>
      <p>Loading membership status...</p>
    </div>
  );

  const getStatusColor = (statusType) => {
    switch (statusType) {
      case 'member':
      case 'full_member':
      case 'approved_member':
      case 'approved_pre_member':
      case 'approved':
        return 'success';
      case 'pre_member':
        return 'info';
      case 'ready_to_apply':
      case 'not_submitted':
        return 'primary';
      case 'pending':
      case 'under_review':
        return 'warning';
      case 'declined':
      case 'rejected':
        return 'danger';
      default:
        return 'default';
    }
  };

  const getStatusIcon = (statusType) => {
    switch (statusType) {
      case 'member':
      case 'full_member':
      case 'approved_member':
      case 'approved_pre_member':
      case 'approved':
        return '✅';
      case 'pre_member':
        return '👤';
      case 'ready_to_apply':
      case 'not_submitted':
        return '📝';
      case 'pending':
      case 'under_review':
        return '⏳';
      case 'declined':
      case 'rejected':
        return '❌';
      default:
        return '📋';
    }
  };

  // ✅ CRITICAL FIX: Use the new API response structure
  const membershipStage = status.membership_stage || 'none';
  const memberStatus = status.is_member || 'not_applied';
  
  // ✅ NEW: Get application status from the new API structure
  let applicationStatus, applicationStatusDisplay, applicationDescription;
  
  if (status.application_status) {
    // New API structure
    applicationStatus = status.application_status;
    applicationStatusDisplay = status.application_status_display || status.application_status;
    applicationDescription = status.application_description || 'No description available';
  } else {
    // Fallback to legacy structure
    applicationStatus = status.initial_application_status || 'not_submitted';
    applicationStatusDisplay = applicationStatus.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    applicationDescription = 'Application status information';
  }
  
  console.log('🔍 MembershipStatus processing:', {
    membershipStage,
    memberStatus,
    applicationStatus,
    applicationStatusDisplay,
    applicationDescription
  });
  
  return (
    <div className="membership-status">
      <div className="status-header">
        <h3>Membership Status</h3>
        <div className={`status-badge ${getStatusColor(applicationStatus)}`}>
          <span className="status-icon">{getStatusIcon(applicationStatus)}</span>
          <span className="status-text">
            {applicationStatus === 'ready_to_apply' ? 'NEW USER' :
             applicationStatus === 'approved_pre_member' ? 'PRE-MEMBER' :
             applicationStatus === 'approved_member' ? 'FULL MEMBER' :
             applicationStatus === 'pending' ? 'UNDER REVIEW' :
             applicationStatusDisplay.toUpperCase()}
          </span>
        </div>
      </div>

      <div className="status-details">
        <div className="detail-item">
          <strong>Current Status:</strong> 
          <span className={`status-indicator ${getStatusColor(memberStatus)}`}>
            {memberStatus === 'applied' && applicationStatus === 'ready_to_apply' ? 'Ready to Apply' :
             memberStatus === 'applied' ? 'Application Submitted' : 
             memberStatus === 'pre_member' ? 'Pre-Member' :
             memberStatus === 'member' ? 'Full Member' :
             memberStatus.replace(/_/g, ' ')}
          </span>
        </div>
        
        <div className="detail-item">
          <strong>Application Status:</strong> 
          <span className={`status-indicator ${getStatusColor(applicationStatus)}`}>
            {applicationStatusDisplay}
          </span>
        </div>

        {status.user_created && (
          <div className="detail-item">
            <strong>Member Since:</strong> 
            <span>{new Date(status.user_created).toLocaleDateString()}</span>
          </div>
        )}

        {(status.application_ticket || status.survey_ticket) && (
          <div className="detail-item">
            <strong>Application ID:</strong> 
            <span className="application-ticket">
              {status.application_ticket || status.survey_ticket}
            </span>
          </div>
        )}

        {status.application_submittedAt && (
          <div className="detail-item">
            <strong>Submitted:</strong> 
            <span>{new Date(status.application_submittedAt).toLocaleDateString()}</span>
          </div>
        )}

        {status.application_reviewedAt && (
          <div className="detail-item">
            <strong>Reviewed:</strong> 
            <span>{new Date(status.application_reviewedAt).toLocaleDateString()}</span>
          </div>
        )}
      </div>

      <div className="status-actions">
        {/* ✅ ENHANCED: Handle new user status */}
        {applicationStatus === 'ready_to_apply' && (
          <div className="ready-to-apply-message">
            <div className="ready-icon">📝</div>
            <h4>Ready to Apply</h4>
            <p>{applicationDescription}</p>
            <button 
              className="apply-btn"
              onClick={() => window.location.href = '/applicationsurvey'}
            >
              Start Application
            </button>
          </div>
        )}

        {applicationStatus === 'not_submitted' && memberStatus === 'applied' && (
          <div className="not-submitted-message">
            <div className="not-submitted-icon">📝</div>
            <h4>Application Required</h4>
            <p>Complete your membership application to join our community.</p>
            <button 
              className="apply-btn"
              onClick={() => window.location.href = '/applicationsurvey'}
            >
              Submit Application
            </button>
          </div>
        )}

        {(applicationStatus === 'pending' || applicationStatus === 'under_review') && (
          <div className="pending-message">
            <div className="pending-icon">⏳</div>
            <h4>Application Under Review</h4>
            <p>{applicationDescription}</p>
            {status.application_submittedAt && (
              <small>
                Submitted on {new Date(status.application_submittedAt).toLocaleDateString()}
              </small>
            )}
          </div>
        )}

        {(membershipStage === 'member' || applicationStatus === 'approved_member') && (
          <div className="member-benefits">
            <div className="benefits-icon">🎉</div>
            <h4>Full Member Benefits Active</h4>
            <ul>
              <li>✅ Access to Iko Chat</li>
              <li>✅ Full platform access</li>
              <li>✅ Community participation</li>
              <li>✅ Priority support</li>
            </ul>
          </div>
        )}

        {(membershipStage === 'pre_member' || applicationStatus === 'approved_pre_member') && (
          <div className="premember-benefits">
            <div className="benefits-icon">👤</div>
            <h4>Pre-Member Access</h4>
            <ul>
              <li>✅ Towncrier content access</li>
              <li>✅ Limited community features</li>
              <li>📝 Full membership application available</li>
            </ul>
            <button 
              className="upgrade-btn"
              onClick={() => window.location.href = '/full-membership'}
            >
              Apply for Full Membership
            </button>
          </div>
        )}

        {(applicationStatus === 'rejected' || applicationStatus === 'declined') && (
          <div className="rejected-message">
            <div className="rejected-icon">❌</div>
            <h4>Application Not Approved</h4>
            <p>{applicationDescription}</p>
            {status.admin_notes && (
              <div className="admin-feedback">
                <strong>Feedback:</strong> {status.admin_notes}
              </div>
            )}
            <button 
              className="reapply-btn"
              onClick={() => window.location.href = '/applicationsurvey'}
            >
              Reapply
            </button>
          </div>
        )}

        {applicationStatus === 'approved' && !membershipStage && (
          <div className="approved-message">
            <div className="approved-icon">✅</div>
            <h4>Application Approved!</h4>
            <p>{applicationDescription}</p>
          </div>
        )}
      </div>
    </div>
  );
}; 

// ✅ ENHANCED: Quick Actions with admin buttons and smaller size
const QuickActions = ({ actions, user }) => {
  const { getUserStatus } = useUser();
  const userStatus = getUserStatus();
  const userAccess = user ? getUserAccess(user) : null;

  console.log('🔍 QuickActions - User Status:', userStatus);
  console.log('🔍 QuickActions - User Access:', userAccess);

  // ✅ ENHANCED: Dynamic actions based on user status with admin buttons
  const getActionsForUser = () => {
    const baseActions = [
      {
        text: 'View Profile',
        link: '/profile',
        type: 'primary',
        icon: '👤',
        size: 'small'
      }
    ];

    // ✅ ADMIN SPECIFIC ACTIONS
    if (userStatus === 'admin') {
      return [
        ...baseActions,
        {
          text: 'Admin Panel',
          link: '/admin',
          type: 'admin',
          icon: '🔧',
          size: 'small'
        },
        {
          text: 'User Management',
          link: '/admin/usermanagement',
          type: 'admin',
          icon: '👥',
          size: 'small'
        },
        {
          text: 'Applications',
          link: '/admin/authcontrols',
          type: 'admin',
          icon: '📋',
          size: 'small'
        },
        {
          text: 'Reports',
          link: '/admin/reports',
          type: 'admin',
          icon: '📊',
          size: 'small'
        },
        {
          text: 'Iko Chat',
          link: '/iko',
          type: 'info',
          icon: '💬',
          size: 'small'
        },
        {
          text: 'Towncrier',
          link: '/towncrier',
          type: 'secondary',
          icon: '📚',
          size: 'small'
        }
      ];
    }

    // ✅ FULL MEMBER ACTIONS
    if (userStatus === 'full_member') {
      return [
        ...baseActions,
        {
          text: 'Iko Chat',
          link: '/iko',
          type: 'info',
          icon: '💬',
          size: 'small'
        },
        {
          text: 'Towncrier',
          link: '/towncrier',
          type: 'secondary',
          icon: '📚',
          size: 'small'
        }
      ];
    }
    
    // ✅ PRE-MEMBER ACTIONS
    if (userStatus === 'pre_member') {
      return [
        ...baseActions,
        {
          text: 'Towncrier Content',
          link: '/towncrier',
          type: 'secondary',
          icon: '📚',
          size: 'small'
        },
        {
          text: 'Apply for Full Membership',
          link: '/full-membership-application',
          type: 'success',
          icon: '📝',
          size: 'small'
        }
      ];
    }
    
    // ✅ PENDING VERIFICATION ACTIONS
    if (userStatus === 'pending_verification') {
      return [
        ...baseActions,
        {
          text: 'Application Status',
          link: '/pending-verification',
          type: 'warning',
          icon: '⏳',
          size: 'small'
        }
      ];
    }
    
    // ✅ NEEDS APPLICATION ACTIONS
    if (userStatus === 'needs_application') {
      return [
        ...baseActions,
        {
          text: 'Complete Application',
          link: '/applicationsurvey',
          type: 'primary',
          icon: '📝',
          size: 'small'
        }
      ];
    }
    
    return baseActions;
  };

  // ✅ DEFAULT ACTIONS - Made smaller
  const defaultActions = [
    {
      text: 'Help Center',
      link: '/help',
      type: 'info',
      icon: '❓',
      size: 'small'
    },
    {
      text: 'Settings',
      link: '/settings',
      type: 'default',
      icon: '⚙️',
      size: 'small'
    },
    {
      text: 'Home',
      link: '/',
      type: 'secondary',
      icon: '🏠',
      size: 'small'
    }
  ];

  const userSpecificActions = getActionsForUser();
  const allActions = [...userSpecificActions, ...defaultActions, ...(actions || [])];

  // ✅ NEW: Logout function
  const handleLogout = () => {
    localStorage.removeItem('token');
    delete axios.defaults.headers.common['Authorization'];
    window.location.href = '/login';
  };

  return (
    <div className="quick-actions">
      <h3>Quick Actions</h3>
      <div className="actions-grid compact">
        {allActions.map((action, index) => (
          <a 
            key={index} 
            href={action.link} 
            className={`action-btn ${action.type} ${action.size || 'small'}`}
            title={action.description || action.text}
          >
            <div className="action-icon">{action.icon}</div>
            <span className="action-text">{action.text}</span>
            {action.badge && (
              <span className="action-badge">{action.badge}</span>
            )}
          </a>
        ))}
        
        {/* ✅ NEW: Logout Button */}
        <button 
          onClick={handleLogout}
          className="action-btn danger small"
          title="Sign out of your account"
        >
          <div className="action-icon">🚪</div>
          <span className="action-text">Logout</span>
        </button>
      </div>
    </div>
  );
};

const RecentActivities = ({ activities }) => {
  const getActivityIcon = (type) => {
    switch (type) {
      case 'application':
        return '📝';
      case 'approval':
        return '✅';
      case 'course':
        return '📚';
      case 'message':
        return '💬';
      case 'login':
        return '🔐';
      case 'registration':
        return '🎉';
      default:
        return '📋';
    }
  };

  const getActivityColor = (status) => {
    switch (status) {
      case 'completed':
      case 'approved':
        return 'success';
      case 'pending':
        return 'warning';
      case 'failed':
      case 'declined':
        return 'danger';
      default:
        return 'info';
    }
  };

  // Default activities if none provided
  const defaultActivities = [
    {
      type: 'registration',
      title: 'Account Created',
      description: 'Welcome to the Ikoota platform!',
      date: new Date().toISOString(),
      status: 'completed'
    },
    {
      type: 'application',
      title: 'Application Submitted',
      description: 'Your membership application is under review',
      date: new Date().toISOString(),
      status: 'pending'
    }
  ];

  const displayActivities = activities && activities.length > 0 ? activities : defaultActivities;

  return (
    <div className="recent-activities">
      <h3>Recent Activities</h3>
      <div className="activities-list">
        {displayActivities.map((activity, index) => (
          <div key={index} className="activity-item">
            <div className="activity-icon">
              {getActivityIcon(activity.type)}
            </div>
            <div className="activity-content">
              <h4 className="activity-title">{activity.title}</h4>
              <p className="activity-description">{activity.description}</p>
              <div className="activity-meta">
                <span className="activity-date">
                  {new Date(activity.date).toLocaleDateString()}
                </span>
                <span className={`activity-status ${getActivityColor(activity.status)}`}>
                  {activity.status}
                </span>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

const NotificationsSection = ({ notifications, onMarkAsRead }) => {
  if (!notifications || notifications.length === 0) {
    return (
      <div className="notifications-section">
        <h3>Notifications</h3>
        <div className="empty-notifications">
          <div className="empty-icon">🔔</div>
          <p>No new notifications</p>
          <small>You're all caught up!</small>
        </div>
      </div>
    );
  }

  const getNotificationIcon = (type) => {
    switch (type) {
      case 'success':
        return '✅';
      case 'warning':
        return '⚠️';
      case 'error':
        return '❌';
      case 'info':
        return 'ℹ️';
      default:
        return '📢';
    }
  };

  return (
    <div className="notifications-section">
      <h3>Notifications</h3>
      <div className="notifications-list">
        {notifications.map((notification, index) => (
          <div 
            key={notification.id || index} 
            className={`notification ${notification.type} ${notification.read ? 'read' : 'unread'}`}
          >
            <div className="notification-icon">
              {getNotificationIcon(notification.type)}
            </div>
            <div className="notification-content">
              <p className="notification-message">{notification.message}</p>
              <div className="notification-meta">
                <span className="notification-date">
                  {new Date(notification.date || Date.now()).toLocaleDateString()}
                </span>
                {!notification.read && onMarkAsRead && (
                  <button 
                    onClick={() => onMarkAsRead(notification.id)}
                    className="mark-read-btn"
                  >
                    Mark as read
                  </button>
                )}
              </div>
            </div>
            {!notification.read && <div className="unread-indicator"></div>}
          </div>
        ))}
      </div>
    </div>
  );
};

const WelcomeSection = ({ user, dashboardData }) => {
  const getGreeting = () => {
    const hour = new Date().getHours();
    if (hour < 12) return 'Good morning';
    if (hour < 17) return 'Good afternoon';
    return 'Good evening';
  };

  return (
    <div className="welcome-section">
      <div className="welcome-content">
        <h1 className="welcome-title">
          {getGreeting()}, {user?.username || 'User'}! 👋
        </h1>
        <p className="welcome-subtitle">
          {dashboardData?.membershipStatus?.membership_stage === 'member' 
            ? "Welcome back to your member dashboard"
            : "Here's your current status and available actions"
          }
        </p>
      </div>
      <div className="welcome-stats">
        <div className="stat-item">
          <span className="stat-number">{dashboardData?.stats?.coursesCompleted || 0}</span>
          <span className="stat-label">Activities</span>
        </div>
        <div className="stat-item">
          <span className="stat-number">{dashboardData?.stats?.achievementsUnlocked || 0}</span>
          <span className="stat-label">Achievements</span>
        </div>
        <div className="stat-item">
          <span className="stat-number">{dashboardData?.stats?.daysActive || 1}</span>
          <span className="stat-label">Days Active</span>
        </div>
      </div>
    </div>
  );
};

// ==================================================
// MAIN COMPONENT
// ==================================================

const UserDashboard = () => {
  const { user, isAuthenticated, getUserStatus } = useUser();
  const queryClient = useQueryClient();

  // Queries
  const { data: dashboardData, isLoading, error } = useQuery({
    queryKey: ['userDashboard'],
    queryFn: fetchUserDashboard,
    enabled: !!user && isAuthenticated,
    staleTime: 5 * 60 * 1000, // 5 minutes
    cacheTime: 10 * 60 * 1000, // 10 minutes
    retry: 1
  });

  // Mutations
  const markAsReadMutation = useMutation({
    mutationFn: markNotificationAsRead,
    onSuccess: () => {
      queryClient.invalidateQueries(['userDashboard']);
    },
    onError: (error) => {
      console.error('Failed to mark notification as read:', error);
    }
  });

  // Event Handlers
  const handleMarkAsRead = (notificationId) => {
    markAsReadMutation.mutate(notificationId);
  };

  // Loading and Error States
  if (!isAuthenticated) {
    return (
      <div className="dashboard-auth-error">
        <div className="auth-error-container">
          <div className="auth-error-icon">🔐</div>
          <h3>Authentication Required</h3>
          <p>Please log in to view your dashboard</p>
          <a href="/login" className="login-btn">Go to Login</a>
        </div>
      </div>
    );
  }

  if (isLoading) {
    return (
      <div className="dashboard-loading">
        <div className="loading-container">
          <div className="loading-spinner large"></div>
          <h3>Loading your dashboard...</h3>
          <p>Please wait while we fetch your latest information</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="dashboard-error">
        <div className="error-container">
          <div className="error-icon">⚠️</div>
          <h3>Error loading dashboard</h3>
          <p>{error.message}</p>
          <button 
            onClick={() => queryClient.invalidateQueries(['userDashboard'])}
            className="retry-btn"
          >
            Try Again
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="user-dashboard">
      <WelcomeSection user={user} dashboardData={dashboardData} />
      
      <div className="dashboard-grid">
        <MembershipStatus 
          status={dashboardData?.membershipStatus || user} 
        />
        <QuickActions 
          actions={dashboardData?.quickActions}
          user={user}
        />
        <RecentActivities 
          activities={dashboardData?.recentActivities} 
        />
      </div>

      {(dashboardData?.notifications?.length > 0) && (
        <NotificationsSection 
          notifications={dashboardData.notifications}
          onMarkAsRead={handleMarkAsRead}
        />
      )}
    </div>
  );
};

export default UserDashboard;



//===========================================
//towncrier FOLDER
//===========================================


//ikootaclient\src\components\towncrier\TowncrierControls.jsx
import React, { useState } from "react";
import { useForm } from "react-hook-form";
import { jwtDecode } from "jwt-decode";
import useUpload from "../../hooks/useUpload";
import { useFetchTeachings } from "../service/useFetchTeachings";
import "../../components/admin/navbar.css";

const TowncrierControls = () => {
  const { handleSubmit, register, reset, formState: { errors } } = useForm();
  const { validateFiles, mutation } = useUpload("/teachings");
  const { data: teachings = [], isLoading, error, refetch } = useFetchTeachings();
  
  const [step, setStep] = useState(0);
  const [showForm, setShowForm] = useState(false);

  const token = localStorage.getItem("token");
  const user_id = token ? jwtDecode(token).user_id : null;

  const onSubmit = async (data) => {
    try {
      if (!user_id) {
        alert("User not authenticated");
        return;
      }

      const formData = new FormData();
      formData.append("user_id", user_id);
      formData.append("topic", data.topic);
      formData.append("description", data.description);
      formData.append("subjectMatter", data.subjectMatter);
      formData.append("audience", data.audience);
      formData.append("content", data.content);

      ["media1", "media2", "media3"].forEach((file) => {
        if (data[file]?.[0]) {
          formData.append(file, data[file][0]);
        }
      });

      const response = await mutation.mutateAsync(formData);
      console.log("Teaching uploaded successfully with ID:", response.data?.prefixed_id);
      
      reset();
      setStep(0);
      setShowForm(false);
      
      // Refresh the teachings list
      refetch();
      
      alert("Teaching created successfully!");
    } catch (error) {
      console.error("Error uploading teaching material:", error);
      alert("Failed to create teaching. Please try again.");
    }
  };

  const handleNextStep = () => {
    if (step < 7) setStep(step + 1);
  };

  const handlePrevStep = () => {
    if (step > 0) setStep(step - 1);
  };

  const getContentIdentifier = (teaching) => {
    return teaching?.prefixed_id || `t${teaching?.id}` || 'Unknown';
  };

  const formatDate = (dateString) => {
    if (!dateString) return 'Unknown date';
    try {
      return new Date(dateString).toLocaleDateString();
    } catch (error) {
      return 'Invalid date';
    }
  };

  const truncateText = (text, maxLength = 50) => {
    if (!text) return 'Not specified';
    return text.length > maxLength ? `${text.substring(0, maxLength)}...` : text;
  };

  return (
    <div className="towncrier_controls_body">
      <div className="controls-header">
        <h2>Towncrier Controls</h2>
        <div className="header-actions">
          <button 
            onClick={() => {
              setShowForm(!showForm);
              setStep(0);
            }}
            className="toggle-form-btn"
          >
            {showForm ? 'Hide Form' : 'Add New Teaching'}
          </button>
          <button onClick={refetch} className="refresh-btn">
            Refresh List
          </button>
        </div>
      </div>

      {/* Add Teaching Form */}
      {showForm && (
        <div className="teaching-form-container">
          <form onSubmit={handleSubmit(onSubmit)} noValidate>
            <div className="step-indicator">
              Step {step + 1} of 8: {['Topic', 'Description', 'Subject', 'Audience', 'Content', 'Media 1', 'Media 2', 'Media 3'][step]}
            </div>

            <div className="form-content">
              {step === 0 && (
                <div className="form-step">
                  <label>Topic *</label>
                  <input
                    type="text"
                    placeholder="Enter Topic"
                    {...register("topic", { required: "Topic is required" })}
                  />
                  {errors.topic && <span className="error">{errors.topic.message}</span>}
                </div>
              )}

              {step === 1 && (
                <div className="form-step">
                  <label>Description *</label>
                  <textarea
                    placeholder="Enter Description"
                    rows="4"
                    {...register("description", { required: "Description is required" })}
                  />
                  {errors.description && <span className="error">{errors.description.message}</span>}
                </div>
              )}

              {step === 2 && (
                <div className="form-step">
                  <label>Subject Matter *</label>
                  <input
                    type="text"
                    placeholder="Enter Subject Matter"
                    {...register("subjectMatter", { required: "Subject Matter is required" })}
                  />
                  {errors.subjectMatter && <span className="error">{errors.subjectMatter.message}</span>}
                </div>
              )}

              {step === 3 && (
                <div className="form-step">
                  <label>Audience *</label>
                  <input
                    type="text"
                    placeholder="Enter Target Audience"
                    {...register("audience", { required: "Audience is required" })}
                  />
                  {errors.audience && <span className="error">{errors.audience.message}</span>}
                </div>
              )}

              {step === 4 && (
                <div className="form-step">
                  <label>Content *</label>
                  <textarea
                    placeholder="Enter Content (Text, Emoji, URLs)"
                    rows="6"
                    {...register("content", { required: "Content is required" })}
                  />
                  {errors.content && <span className="error">{errors.content.message}</span>}
                </div>
              )}

              {step === 5 && (
                <div className="form-step">
                  <label>Media 1 (Optional)</label>
                  <input
                    type="file"
                    multiple
                    accept="image/*,video/*,audio/*"
                    {...register("media1", { validate: validateFiles })}
                  />
                </div>
              )}

              {step === 6 && (
                <div className="form-step">
                  <label>Media 2 (Optional)</label>
                  <input
                    type="file"
                    multiple
                    accept="image/*,video/*,audio/*"
                    {...register("media2", { validate: validateFiles })}
                  />
                </div>
              )}

              {step === 7 && (
                <div className="form-step">
                  <label>Media 3 (Optional)</label>
                  <input
                    type="file"
                    multiple
                    accept="image/*,video/*,audio/*"
                    {...register("media3", { validate: validateFiles })}
                  />
                </div>
              )}
            </div>

            <div className="form-navigation">
              {step > 0 && (
                <button type="button" onClick={handlePrevStep} className="nav-btn">
                  Previous
                </button>
              )}
              
              {step < 7 && (
                <button type="button" onClick={handleNextStep} className="nav-btn">
                  Next
                </button>
              )}
              
              <button 
                type="submit" 
                className="submit-btn"
                disabled={mutation.isPending}
              >
                {mutation.isPending ? 'Creating...' : 'Add Teaching'}
              </button>
              
              <button 
                type="button" 
                onClick={() => {
                  setShowForm(false);
                  setStep(0);
                  reset();
                }}
                className="cancel-btn"
              >
                Cancel
              </button>
            </div>
          </form>
        </div>
      )}

      {/* Teachings List */}
      <div className="teachings_list">
        <div className="list-header">
          <h3>Existing Teachings ({teachings.length})</h3>
          <div className="list-stats">
            {isLoading && <span>Loading...</span>}
            {error && <span style={{color: 'red'}}>Error: {error.message}</span>}
          </div>
        </div>

        <div className="teachings-grid">
          {isLoading ? (
            <div className="loading-message">
              <p>Loading teachings...</p>
            </div>
          ) : error ? (
            <div className="error-message">
              <p style={{color: 'red'}}>Error: {error.message}</p>
              <button onClick={refetch}>Retry</button>
            </div>
          ) : teachings.length === 0 ? (
            <div className="no-teachings">
              <p>No teachings available. Create your first teaching!</p>
            </div>
          ) : (
            teachings.map((teaching) => (
              <div key={teaching.prefixed_id || `teaching-${teaching.id}`} className="teaching-card">
                <div className="card-header">
                  <span className="content-type-badge">Teaching</span>
                  <span className="content-id">{getContentIdentifier(teaching)}</span>
                </div>
                
                <div className="card-content">
                  <h4 className="teaching-topic">{teaching.topic || 'Untitled'}</h4>
                  <p className="teaching-description">
                    {truncateText(teaching.description, 60)}
                  </p>
                  
                  <div className="teaching-details">
                    <p><strong>Lesson #:</strong> {teaching.lessonNumber || getContentIdentifier(teaching)}</p>
                    <p><strong>Subject:</strong> {truncateText(teaching.subjectMatter, 30)}</p>
                    <p><strong>Audience:</strong> {teaching.audience || 'General'}</p>
                    <p><strong>By:</strong> {teaching.user_id || 'Admin'}</p>
                  </div>
                  
                  <div className="teaching-dates">
                    <p><strong>Created:</strong> {formatDate(teaching.createdAt)}</p>
                    <p><strong>Updated:</strong> {formatDate(teaching.updatedAt)}</p>
                  </div>
                </div>
                
                {/* Media indicators */}
                <div className="media-indicators">
                  {teaching.media_url1 && <span className="media-badge">📷</span>}
                  {teaching.media_url2 && <span className="media-badge">🎥</span>}
                  {teaching.media_url3 && <span className="media-badge">🎵</span>}
                </div>
              </div>
            ))
          )}
        </div>
      </div>
    </div>
  );
};

export default TowncrierControls;


//=============================================


// ikootaclient/src/components/towncrier/Towncrier.jsx
// FIXED: Enhanced debug and correct status detection
import React, { useState, useEffect, useMemo } from "react";
import { useNavigate } from "react-router-dom";
import "./towncrier.css";
import RevTopics from "./RevTopics";
import RevTeaching from "./RevTeaching";
import { useFetchTeachings } from "../service/useFetchTeachings";
import { useUser } from "../auth/UserStatus";

const Towncrier = () => {
  const { data: rawTeachings = [], isLoading, error, refetch } = useFetchTeachings();
  const [selectedTeaching, setSelectedTeaching] = useState(null);
  const { user, logout, isMember, isAuthenticated, isPending, getUserStatus, canAccessIko, canApplyForMembership } = useUser();
  const navigate = useNavigate();

  // ✅ ENHANCED DEBUG: Log all user status values
  useEffect(() => {
    console.log('🔍 Towncrier Debug - Full User State:', {
      user: user,
      isMember: isMember,
      isPending: isPending,
      isAuthenticated: isAuthenticated,
      getUserStatus: getUserStatus(),
      canAccessIko: canAccessIko(),
      canApplyForMembership: canApplyForMembership(),
      userMembershipStage: user?.membership_stage,
      userIsMember: user?.is_member,
      userRole: user?.role,
      userStatus: user?.status,
      userFinalStatus: user?.finalStatus
    });
  }, [user, isMember, isPending, isAuthenticated]);

  // Memoize enhanced teachings to prevent unnecessary recalculations
  const enhancedTeachings = useMemo(() => {
    try {
      const teachingsArray = Array.isArray(rawTeachings) ? rawTeachings : 
                            (rawTeachings?.data && Array.isArray(rawTeachings.data)) ? rawTeachings.data : [];

      if (teachingsArray.length === 0) return [];

      const enhanced = teachingsArray.map(teaching => ({
        ...teaching,
        content_type: 'teaching',
        content_title: teaching.topic || teaching.title || 'Untitled Teaching',
        prefixed_id: teaching.prefixed_id || `t${teaching.id}`,
        display_date: teaching.updatedAt || teaching.createdAt || new Date().toISOString(),
        author: teaching.author || teaching.user_id || teaching.created_by || 'Admin'
      }));
      
      enhanced.sort((a, b) => {
        const aDate = new Date(a.display_date);
        const bDate = new Date(b.display_date);
        return bDate - aDate;
      });
      
      return enhanced;
    } catch (error) {
      console.error('Error processing teachings data:', error);
      return [];
    }
  }, [rawTeachings]);

  // ✅ NEW: Banner detection logic
  const hasBanners = useMemo(() => {
    return isAuthenticated && (isPending || !isMember);
  }, [isAuthenticated, isPending, isMember]);

  useEffect(() => {
    if (enhancedTeachings.length > 0 && !selectedTeaching) {
      setSelectedTeaching(enhancedTeachings[0]);
    }
  }, [enhancedTeachings.length]);

  useEffect(() => {
    if (enhancedTeachings.length === 0) {
      setSelectedTeaching(null);
    }
  }, [enhancedTeachings.length]);

  const handleSelectTeaching = (teaching) => {
    try {
      const enhancedTeaching = {
        ...teaching,
        content_type: 'teaching',
        content_title: teaching.topic || teaching.title || 'Untitled Teaching',
        prefixed_id: teaching.prefixed_id || `t${teaching.id}`,
        display_date: teaching.updatedAt || teaching.createdAt || new Date().toISOString(),
        author: teaching.author || teaching.user_id || teaching.created_by || 'Admin'
      };
      
      setSelectedTeaching(enhancedTeaching);
    } catch (error) {
      console.error('Error selecting teaching:', error);
    }
  };

  const handleRefresh = () => {
    refetch();
  };

  // ✅ FIXED: Navigation handlers with proper membership logic
  const handleNavigateToIko = () => {
    if (!isAuthenticated) {
      alert("Please sign in first to access member features.");
      navigate('/login');
      return;
    }

    // ✅ FIXED: Check actual member status
    const status = getUserStatus();
    
    console.log('🔍 Iko click - User status:', {
      status,
      canAccessIko: canAccessIko(),
      user: {
        membership_stage: user?.membership_stage,
        is_member: user?.is_member
      }
    });

    if (status === 'member' || canAccessIko()) {
      navigate('/iko');
      return;
    }

    // ✅ FIXED: For pre-members, suggest they apply for full membership
    if (status.startsWith('pre_member') || isPending()) {
      alert("Iko Chat is available to full members only. Apply for full membership to gain access to Iko Chat features.");
      return;
    }

    // For users who need initial application
    const shouldApply = window.confirm(
      "You are not yet a member! \n\nTo access the Iko Chat system, you need to become an approved member.\n\nWould you like to go to the application page now?"
    );
    if (shouldApply) {
      navigate('/applicationsurvey');
    }
  };

  const handleSignOut = () => {
    const confirmSignOut = window.confirm("Are you sure you want to sign out?");
    if (confirmSignOut) {
      logout();
      navigate('/');
    }
  };

  const handleApplyForMembership = () => {
    if (!isAuthenticated) {
      alert("Please sign in first to apply for membership.");
      navigate('/login');
      return;
    }
    navigate('/applicationsurvey');
  };

  // ✅ FIXED: Handle Full Membership Application Logic
  const handleApplyForFullMembership = () => {
    if (!isAuthenticated) {
      alert("Please sign in first to apply for full membership.");
      navigate('/login');
      return;
    }

    // ✅ FIXED: Get current user status
    const status = getUserStatus();
    
    console.log('🔍 Full membership click - User status:', {
      status,
      isMember: isMember(),
      isPending: isPending(),
      canAccessIko: canAccessIko(),
      canApplyForMembership: canApplyForMembership(),
      user: {
        membership_stage: user?.membership_stage,
        is_member: user?.is_member,
        membershipApplicationStatus: user?.membershipApplicationStatus
      }
    });

    // ✅ FIXED: If user is already a full member, direct them to Iko
    if (status === 'member' || canAccessIko()) {
      navigate('/iko');
      return;
    }

    // ✅ FIXED: Handle pre-member states correctly
    if (status === 'pre_member_pending_upgrade') {
      alert('Your membership application is currently under review. You will be notified via email once a decision is made.');
      return;
    }

    if (status === 'pre_member_can_reapply') {
      navigate('/full-membership-info');
      return;
    }

    // ✅ FIXED: For regular pre-members who can apply
    if (status === 'pre_member' && canApplyForMembership()) {
      navigate('/full-membership-info');
      return;
    }

    // ✅ FIXED: For pre-members who cannot apply (shouldn't happen, but safety check)
    if (status === 'pre_member') {
      alert('Membership application is not available at this time. Please contact support if you believe this is an error.');
      return;
    }

    // ✅ FIXED: For users who need initial application first
    if (status === 'needs_application' || (!isPending() && !isMember())) {
      alert("You must complete the initial membership application first.");
      navigate('/applicationsurvey');
      return;
    }

    // Fallback
    alert('Unable to process membership application. Please contact support.');
  };

  // ✅ COMPLETELY REWRITTEN: User status determination based on backend values
  const getUserStatusInfo = () => {
    if (!isAuthenticated) {
      return { status: 'guest', label: 'Guest', color: 'gray' };
    }

    // ✅ ENHANCED DEBUG: Log exactly what we're working with
    const debugInfo = {
      userStatus: getUserStatus(),
      isMember: isMember(),
      isPending: isPending(),
      userRole: user?.role,
      userMembershipStage: user?.membership_stage,
      userIsMemberField: user?.is_member,
      userStatusField: user?.status,
      userFinalStatus: user?.finalStatus
    };
    console.log('🔍 getUserStatusInfo Debug:', debugInfo);

    // Get the canonical status from getUserStatus()
    const status = getUserStatus();

    // Admin users
    if (user?.role === 'admin' || user?.role === 'super_admin') {
      return { 
        status: 'admin', 
        label: `👑 ${user.role === 'super_admin' ? 'Super Admin' : 'Admin'}`, 
        color: 'purple' 
      };
    }

    // ✅ FIXED: Status determination based on the actual status string
    switch (status) {
      case 'member':
        return { status: 'full_member', label: '💎 Full Member', color: 'gold' };
      
      case 'pre_member':
      case 'pre_member_pending_upgrade':
      case 'pre_member_can_reapply':
        return { status: 'pre_member', label: '🌟 Pre-Member', color: 'blue' };
      
      case 'pending_verification':
        return { status: 'applicant', label: '⏳ Applicant', color: 'orange' };
      
      case 'denied':
        return { status: 'denied', label: '❌ Denied', color: 'red' };
      
      case 'needs_application':
        return { status: 'needs_application', label: '📝 Needs Application', color: 'orange' };
      
      default:
        return { status: 'authenticated', label: '👤 User', color: 'green' };
    }
  };

  const userStatus = getUserStatusInfo();

  // ✅ ENHANCED DEBUG: Log the final status decision
  console.log('🎯 Final Status Decision:', {
    userStatus,
    shouldShowBanner: isAuthenticated && isPending() && !isMember(),
    bannerConditions: {
      isAuthenticated,
      isPending: isPending(),
      isMember: isMember()
    }
  });

  if (isLoading) {
    return (
      <div className="towncrier_container">
        <div className="nav">
          <div className="nav-left">
            <span>Towncrier - Public Educational Content</span>
            <span className="status-badge loading">Loading...</span>
          </div>
        </div>
        <div className="towncrier_viewport">
          <div className="loading-message">
            <div className="loading-spinner"></div>
            <p>Loading educational content...</p>
          </div>
        </div>
        <div className="footnote">Ikoota Educational Platform</div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="towncrier_container">
        <div className="nav">
          <div className="nav-left">
            <span>Towncrier - Public Educational Content</span>
            <span className="status-badge error">Error</span>
          </div>
        </div>
        <div className="towncrier_viewport">
          <div className="error-message">
            <h3>Unable to Load Content</h3>
            <p style={{color: 'red'}}>Error: {error.message || 'Failed to fetch teachings'}</p>
            <button onClick={handleRefresh} className="retry-btn">
              🔄 Try Again
            </button>
          </div>
        </div>
        <div className="footnote">Ikoota Educational Platform</div>
      </div>
    );
  }

  return (
    <div className="towncrier_container">
      {/* Enhanced Navigation Bar */}
      <div className="nav">
        <div className="nav-left">
          <span>Towncrier - Public Educational Content</span>
          {isAuthenticated && (
            <div className="user-status">
              <span className="user-info">
                👤 {user?.username || user?.email || 'User'} 
                <span className={`status-badge ${userStatus.status}`} style={{color: userStatus.color}}>
                  {userStatus.label}
                </span>
              </span>
            </div>
          )}
        </div>
        
        <div className="nav-right">
          <span className="content-count">
            📚 {enhancedTeachings.length} Resources
          </span>
          <button onClick={handleRefresh} className="refresh-btn">
            🔄
          </button>
        </div>
      </div>

      {/* ✅ FIXED: Show banner only for pre-members (isPending=true, isMember=false) */}
      {isAuthenticated && isPending() && !isMember() && (
        <div className="membership-banner">
          <div className="banner-content">
            <div className="banner-text">
              <h3>🎓 Ready for Full Membership?</h3>
              <p>
                As a pre-member, you can now apply for full membership to unlock the complete Ikoota experience 
                including chat access, commenting, and content creation!
              </p>
            </div>
            <button 
              onClick={handleApplyForFullMembership}
              className="membership-application-btn"
            >
              📝 Apply for Full Membership
            </button>
          </div>
        </div>
      )}
      
      {/* ✅ UPDATED: Viewport with banner detection */}
      <div className={`towncrier_viewport ${hasBanners ? 'with-banners' : ''}`}>
        <RevTopics 
          teachings={enhancedTeachings} 
          onSelect={handleSelectTeaching}
          selectedTeaching={selectedTeaching}
        />
                
        <RevTeaching 
          teaching={selectedTeaching} 
          allTeachings={enhancedTeachings}
          onSelectNext={handleSelectTeaching}
        />
      </div>
      
      {/* Enhanced Footer with Status-Aware Controls */}
      <div className="footnote">
        <div className="footer-left">
          <span>Ikoota Educational Platform</span>
          {selectedTeaching && (
            <span> | {selectedTeaching.prefixed_id}</span>
          )}
        </div>
        
        <div className="footer-center">
          <span>{new Date().toLocaleString()}</span>
          {isAuthenticated && (
            <span className={`user-status-badge ${userStatus.status}`}>
              {userStatus.label}
            </span>
          )}
        </div>
        
        <div className="footer-right">
          <div className="footer-controls">
            {/* ✅ FIXED: Show full membership button only for pre-members who can apply */}
            {isAuthenticated && isPending() && !isMember() && canApplyForMembership() && (
              <button 
                onClick={handleApplyForFullMembership} 
                className="footer-btn membership-btn"
                title="Apply for full membership to unlock all features"
              >
                🎓 Full Member
              </button>
            )}

            <button 
              onClick={handleNavigateToIko} 
              className="footer-btn iko-btn"
              title={isMember() ? "Access Iko Chat" : "Apply for membership to access Iko Chat"}
            >
              💬 {isMember() ? "Iko" : "Join"}
            </button>
            
            {!isAuthenticated ? (
              <>
                <button 
                  onClick={() => navigate('/login')} 
                  className="footer-btn login-btn"
                >
                  🔑 In
                </button>
                <button 
                  onClick={() => navigate('/signup')} 
                  className="footer-btn signup-btn"
                >
                  📝 Up
                </button>
              </>
            ) : (
              <>
                {!isPending() && !isMember() && (
                  <button 
                    onClick={handleApplyForMembership} 
                    className="footer-btn apply-btn"
                  >
                    📋 Apply
                  </button>
                )}
                <button 
                  onClick={() => navigate('/dashboard')} 
                  className="footer-btn membership-btn"
                >
                  📊 Dashboard
                </button>
                <button 
                  onClick={handleSignOut} 
                  className="footer-btn signout-btn"
                >
                  👋 Out
                </button>
              </>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

export default Towncrier;


//===========================================


//ikootaclient\src\components\towncrier\Teaching.jsx
import React, { useState, useEffect } from 'react';
import SearchControls from '../search/SearchControls';
import { useForm } from 'react-hook-form';
import useUpload from '../../hooks/useUpload';
import { jwtDecode } from 'jwt-decode';
import api from '../service/api';
import './teaching.css';

const Teaching = ({ setActiveItem, deactivateListChats }) => {
  const { handleSubmit, register, reset, formState: { errors } } = useForm();
  const { validateFiles, mutation: teachingMutation } = useUpload("/teachings");
  
  const [addMode, setAddMode] = useState(false);
  const [activeItem, setActiveItemState] = useState({ id: null, type: null });
  const [teachings, setTeachings] = useState([]);
  const [filteredTeachings, setFilteredTeachings] = useState([]);
  const [step, setStep] = useState(0);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  const token = localStorage.getItem("token");
  const user_id = token ? jwtDecode(token).user_id : null;

  useEffect(() => {
    const fetchTeachings = async () => {
      try {
        setLoading(true);
        setError(null);
        
        const response = await api.get('/teachings');
        const teachingsData = response.data.map(teaching => ({ 
          ...teaching, 
          content_type: 'teaching',
          content_title: teaching.topic || 'Untitled Teaching',
          // Ensure prefixed_id exists, fallback to generated one
          prefixed_id: teaching.prefixed_id || `t${teaching.id}`,
          // Normalize date fields
          display_date: teaching.updatedAt || teaching.createdAt
        }));
        
        setTeachings(teachingsData);
        setFilteredTeachings(teachingsData);
      } catch (error) {
        console.error('Error fetching teachings:', error);
        setError('Failed to fetch teachings. Please try again.');
      } finally {
        setLoading(false);
      }
    };

    fetchTeachings();
  }, []);

  const handleSearch = (query) => {
    if (!Array.isArray(teachings)) return;
    
    const lowercaseQuery = query.toLowerCase();
    const filtered = teachings.filter(teaching => {
      const searchFields = [
        teaching.topic,
        teaching.description,
        teaching.subjectMatter,
        teaching.prefixed_id,
        teaching.audience,
        teaching.content
      ];
      
      return searchFields.some(field => 
        field && field.toString().toLowerCase().includes(lowercaseQuery)
      );
    });
    
    setFilteredTeachings(filtered);
  };

  const handleItemClick = (teaching) => {
    try {
      if (deactivateListChats) deactivateListChats();
      
      const enhancedTeaching = {
        ...teaching,
        id: teaching.prefixed_id || teaching.id,
        type: 'teaching',
        content_type: 'teaching'
      };
      
      setActiveItemState(enhancedTeaching);
      if (setActiveItem) setActiveItem(enhancedTeaching);
    } catch (error) {
      console.error('Error handling item click:', error);
    }
  };

  const handleNextStep = () => {
    if (step < 7) setStep(step + 1); // Updated to include media3
  };

  const handlePrevStep = () => {
    if (step > 0) setStep(step - 1);
  };

  const handleSendTeaching = async (data) => {
    try {
      if (!user_id) {
        alert("User not authenticated");
        return;
      }

      const formData = new FormData();
      formData.append("user_id", user_id);
      formData.append("topic", data.topic);
      formData.append("description", data.description);
      formData.append("subjectMatter", data.subjectMatter);
      formData.append("audience", data.audience);
      formData.append("content", data.content);

      ["media1", "media2", "media3"].forEach((field) => {
        if (data[field]?.[0]) {
          formData.append(field, data[field][0]);
        }
      });

      const response = await teachingMutation.mutateAsync(formData);
      console.log("Teaching created with prefixed ID:", response.data?.prefixed_id);
      
      reset();
      setStep(0);
      setAddMode(false);
      
      // Refresh teachings list
      const updatedResponse = await api.get('/teachings');
      const updatedTeachings = updatedResponse.data.map(teaching => ({ 
        ...teaching, 
        content_type: 'teaching',
        content_title: teaching.topic || 'Untitled Teaching',
        prefixed_id: teaching.prefixed_id || `t${teaching.id}`,
        display_date: teaching.updatedAt || teaching.createdAt
      }));
      
      setTeachings(updatedTeachings);
      setFilteredTeachings(updatedTeachings);
      
      alert("Teaching created successfully!");
    } catch (error) {
      console.error("Error creating teaching:", error);
      alert("Failed to create teaching. Please try again.");
    }
  };

  // Helper functions
  const getContentIdentifier = (teaching) => {
    return teaching?.prefixed_id || `t${teaching?.id}` || 'Unknown';
  };

  const formatDate = (dateString) => {
    if (!dateString) return 'Unknown date';
    try {
      return new Date(dateString).toLocaleDateString();
    } catch (error) {
      return 'Invalid date';
    }
  };

  const truncateText = (text, maxLength = 100) => {
    if (!text) return 'Not specified';
    return text.length > maxLength ? `${text.substring(0, maxLength)}...` : text;
  };

  if (loading) {
    return (
      <div className='teaching_container'>
        <div className="loading-message">
          <p>Loading teachings...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className='teaching_container'>
        <div className="error-message">
          <p style={{color: 'red'}}>{error}</p>
          <button onClick={() => window.location.reload()}>Retry</button>
        </div>
      </div>
    );
  }

  return (
    <div className='teaching_container'>
      <div className="search">
        <div className="searchbar">
          <img src="./search.png" alt="Search" />
          <SearchControls onSearch={handleSearch} />
        </div>
        <img 
          src={addMode ? "./minus.png" : "./plus.png"} 
          alt="Toggle" 
          className='add' 
          onClick={() => {
            setAddMode(!addMode);
            setStep(0);
          }} 
        />
      </div>

      {/* Add Mode Form */}
      {addMode && (
        <div className="add-teaching-form">
          <form onSubmit={handleSubmit(handleSendTeaching)} noValidate>
            <div className="step-indicator">
              Step {step + 1} of 8: {['Topic', 'Description', 'Subject', 'Audience', 'Content', 'Media 1', 'Media 2', 'Media 3'][step]}
            </div>
            
            {step === 0 && (
              <div>
                <input
                  type="text"
                  placeholder="Enter Topic"
                  {...register("topic", { required: "Topic is required" })}
                />
                {errors.topic && <span style={{color: 'red'}}>{errors.topic.message}</span>}
              </div>
            )}
            {step === 1 && (
              <div>
                <textarea
                  placeholder="Enter Description"
                  rows="3"
                  {...register("description", { required: "Description is required" })}
                />
                {errors.description && <span style={{color: 'red'}}>{errors.description.message}</span>}
              </div>
            )}
            {step === 2 && (
              <div>
                <input
                  type="text"
                  placeholder="Enter Subject Matter"
                  {...register("subjectMatter", { required: "Subject Matter is required" })}
                />
                {errors.subjectMatter && <span style={{color: 'red'}}>{errors.subjectMatter.message}</span>}
              </div>
            )}
            {step === 3 && (
              <div>
                <input
                  type="text"
                  placeholder="Enter Audience"
                  {...register("audience", { required: "Audience is required" })}
                />
                {errors.audience && <span style={{color: 'red'}}>{errors.audience.message}</span>}
              </div>
            )}
            {step === 4 && (
              <div>
                <textarea
                  placeholder="Enter Content"
                  rows="5"
                  {...register("content", { required: "Content is required" })}
                />
                {errors.content && <span style={{color: 'red'}}>{errors.content.message}</span>}
              </div>
            )}
            {step === 5 && (
              <input
                type="file"
                multiple
                accept="image/*,video/*,audio/*"
                {...register("media1", { validate: validateFiles })}
              />
            )}
            {step === 6 && (
              <input
                type="file"
                multiple
                accept="image/*,video/*,audio/*"
                {...register("media2", { validate: validateFiles })}
              />
            )}
            {step === 7 && (
              <input
                type="file"
                multiple
                accept="image/*,video/*,audio/*"
                {...register("media3", { validate: validateFiles })}
              />
            )}
            
            <div className="form-buttons">
              {step < 7 && <button type="button" onClick={handleNextStep}>Next</button>}
              {step > 0 && <button type="button" onClick={handlePrevStep}>Previous</button>}
              <button 
                type="submit" 
                disabled={teachingMutation.isPending}
              >
                {teachingMutation.isPending ? 'Creating...' : 'Create Teaching'}
              </button>
              <button type="button" onClick={() => {setAddMode(false); setStep(0);}}>Cancel</button>
            </div>
          </form>
        </div>
      )}

      {/* Teachings List */}
      {!addMode && filteredTeachings.length === 0 && (
        <p>No teachings available</p>
      )}
      
      {!addMode && filteredTeachings.map((teaching) => (
        <div 
          key={teaching.prefixed_id || `teaching-${teaching.id}`} 
          className={`item ${activeItem?.id === (teaching.prefixed_id || teaching.id) ? 'active' : ''}`}
          onClick={() => handleItemClick(teaching)}
        >
          <div className="texts">
            <div className="teaching-header">
              <span className="content-type-badge">Teaching</span>
              <span className="content-id">{getContentIdentifier(teaching)}</span>
            </div>
            
            <span className="topic">Topic: {teaching.topic || 'No topic'}</span>
            <p className="description">
              Description: {truncateText(teaching.description, 80)}
            </p>
            <p>Lesson#: {teaching.lessonNumber || getContentIdentifier(teaching)}</p>
            <p>Subject Matter: {truncateText(teaching.subjectMatter, 50)}</p>
            <p>Audience: {teaching.audience || 'General'}</p>
            <p>By: {teaching.user_id || 'Admin'}</p>
            <p>Created: {formatDate(teaching.createdAt)}</p>
            <p>Updated: {formatDate(teaching.updatedAt)}</p>
          </div>
        </div>
      ))}
    </div>
  );
};

export default Teaching;

//======================================


// ikootaclient\src\components\towncrier\StepsForm.jsx
import React, { useState } from 'react';

const StepsForm = ({ addTopic}) => {
    const [formData, setFormData] = useState({
      title: '',
      description: '',
      message: '',
      audience: '',
    });
  
    const handleAddTopic = () => {
      const newTopic = { ...formData, id: Date.now() };
      addTopic(newTopic);
      setFormData({ title: '', description: '', message: '', audience: '' });
    };
  
    return (
      <div className="steps-form">
        <input
          type="text"
          placeholder="Enter Title"
          value={formData.title}
          onChange={(e) => setFormData({ ...formData, title: e.target.value })}
        />
        <textarea
          placeholder="Enter Description"
          value={formData.description}
          onChange={(e) => setFormData({ ...formData, description: e.target.value })}
        />
        <button onClick={handleAddTopic}>Add Topic</button>
      </div>
    );
  }
  export default StepsForm;
  


//===========================================


// ikootaclient/src/components/towncrier/RevTopics.jsx - FIXED VERSION
import React, { useState, useEffect, useMemo } from 'react';
import SearchControls from '../search/SearchControls';
import './revtopics.css';
import api from '../service/api';

const RevTopics = ({ teachings: propTeachings = [], onSelect, selectedTeaching }) => {
  const [teachings, setTeachings] = useState([]);
  const [filteredTeachings, setFilteredTeachings] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  // Use prop teachings if available, otherwise fetch
  useEffect(() => {
    if (propTeachings.length > 0) {
      console.log('Using prop teachings:', propTeachings.length, 'items');
      setTeachings(propTeachings);
      setFilteredTeachings(propTeachings);
      setLoading(false);
      return;
    }

    // Only fetch if no prop teachings
    const fetchTeachings = async () => {
      try {
        setLoading(true);
        setError(null);
        
        console.log('Fetching teachings from API...');
        const response = await api.get('/teachings');
        
        // Debug response
        console.log('API Response type:', typeof response.data);
        console.log('API Response:', response.data);
        
        // Normalize response
        let teachingsData = [];
        if (Array.isArray(response.data)) {
          teachingsData = response.data;
        } else if (response.data?.data && Array.isArray(response.data.data)) {
          teachingsData = response.data.data;
        } else if (response.data?.teachings && Array.isArray(response.data.teachings)) {
          teachingsData = response.data.teachings;
        } else {
          console.warn('Unexpected response structure:', response.data);
          teachingsData = [];
        }
        
        const enhancedTeachings = teachingsData.map((teaching, index) => ({
          ...teaching,
          id: teaching.id || `temp-${index}`,
          content_type: 'teaching',
          content_title: teaching.topic || teaching.title || 'Untitled Teaching',
          prefixed_id: teaching.prefixed_id || `t${teaching.id || index}`,
          display_date: teaching.updatedAt || teaching.createdAt || new Date().toISOString(),
          author: teaching.author || teaching.user_id || teaching.created_by || 'Admin',
          topic: teaching.topic || teaching.title || 'Untitled',
          description: teaching.description || 'No description available',
          subjectMatter: teaching.subjectMatter || teaching.subject || 'Not specified',
          audience: teaching.audience || 'General'
        }));
        
        enhancedTeachings.sort((a, b) => new Date(b.display_date) - new Date(a.display_date));
        
        console.log('Processed teachings:', enhancedTeachings.length, 'items');
        setTeachings(enhancedTeachings);
        setFilteredTeachings(enhancedTeachings);
      } catch (error) {
        console.error('Error fetching teachings:', error);
        setError(`Failed to fetch teachings: ${error.message}`);
        setTeachings([]);
        setFilteredTeachings([]);
      } finally {
        setLoading(false);
      }
    };

    fetchTeachings();
  }, [propTeachings.length]); // Only depend on length to avoid infinite loops

  const handleSearch = (query) => {
    if (!Array.isArray(teachings)) return;
    
    const lowercaseQuery = query.toLowerCase();
    const filtered = teachings.filter(teaching => {
      const searchFields = [
        teaching.topic, teaching.title, teaching.description,
        teaching.subjectMatter, teaching.subject, teaching.audience,
        teaching.author, teaching.prefixed_id, teaching.content
      ];
      
      return searchFields.some(field => 
        field && field.toString().toLowerCase().includes(lowercaseQuery)
      );
    });
    
    setFilteredTeachings(filtered);
  };

  const handleTopicClick = (teaching) => {
    try {
      console.log('🔍 Topic clicked:', teaching.id, teaching.topic);
      if (onSelect) {
        onSelect(teaching);
      }
    } catch (error) {
      console.error('Error selecting teaching:', error);
    }
  };

  // Helper functions
  const getContentIdentifier = (teaching) => {
    return teaching?.prefixed_id || `t${teaching?.id}` || 'Unknown';
  };

  const formatDate = (dateString) => {
    if (!dateString) return 'Unknown date';
    try {
      return new Date(dateString).toLocaleString();
    } catch (error) {
      return 'Invalid date';
    }
  };

  const truncateText = (text, maxLength = 100) => {
    if (!text) return 'No description available';
    return text.length > maxLength ? `${text.substring(0, maxLength)}...` : text;
  };

  // ✅ FIXED: Enhanced selection detection
  const isSelected = (teaching) => {
    if (!selectedTeaching || !teaching) return false;
    
    // Try multiple comparison methods
    const matches = [
      selectedTeaching.id === teaching.id,
      selectedTeaching.prefixed_id === teaching.prefixed_id,
      selectedTeaching.id === teaching.prefixed_id,
      selectedTeaching.prefixed_id === teaching.id
    ];
    
    const result = matches.some(match => match);
    console.log('🔍 Selection check:', {
      selectedId: selectedTeaching.id,
      selectedPrefixedId: selectedTeaching.prefixed_id,
      teachingId: teaching.id,
      teachingPrefixedId: teaching.prefixed_id,
      isSelected: result
    });
    
    return result;
  };

  if (loading) {
    return (
      <div className="revtopic-container">
        <div className="loading-message">
          <div className="loading-spinner"></div>
          <p>Loading educational content...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="revtopic-container">
        <div className="error-message">
          <h3>Unable to Load Content</h3>
          <p style={{color: 'red'}}>{error}</p>
          <button onClick={() => window.location.reload()} className="retry-btn">
            🔄 Retry
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="revtopic-container">
      <div className="search">
        <div className="searchbar">
          <img src="./search.png" alt="Search Icon" />
          <SearchControls onSearch={handleSearch} />
        </div>
        <div className="search-stats">
          <span>📖 {filteredTeachings.length} of {teachings.length} resources</span>
        </div>
      </div>

      <div className="topics-list">
        {filteredTeachings.length > 0 ? (
          filteredTeachings.map((teaching, index) => {
            const selected = isSelected(teaching);
            
            return (
              <div 
                key={teaching.prefixed_id || `teaching-${teaching.id || index}`} 
                className={`topic-item ${selected ? 'selected' : ''}`}
                onClick={() => handleTopicClick(teaching)}
              >
                <div className="topic-header">
                  <span className="content-type-badge">📚 Educational Resource</span>
                  <span className="content-id">{getContentIdentifier(teaching)}</span>
                </div>
                
                <div className="texts">
                  <span className="topic-title">
                    {teaching.topic || teaching.title || 'Untitled Resource'}
                  </span>
                  <p className="topic-description">
                    {truncateText(teaching.description, 80)}
                  </p>
                  
                  <div className="topic-meta">
                    <p>📋 Subject: {teaching.subjectMatter || teaching.subject || 'Not specified'}</p>
                    <p>👥 Audience: {teaching.audience || 'General'}</p>
                    <p>✍️ By: {teaching.author}</p>
                  </div>
                  
                  <div className="topic-dates">
                    <p>📅 Created: {formatDate(teaching.createdAt)}</p>
                    {teaching.updatedAt && teaching.updatedAt !== teaching.createdAt && (
                      <p>🔄 Updated: {formatDate(teaching.updatedAt)}</p>
                    )}
                  </div>
                </div>
                
                {selected && (
                  <div className="selected-indicator">
                    <span>▶</span>
                  </div>
                )}
              </div>
            );
          })
        ) : (
          <div className="no-teachings">
            <div className="empty-state">
              <h3>📚 No Educational Content Available</h3>
              <p>
                {teachings.length > 0 
                  ? "No content matches your search. Try adjusting your search terms." 
                  : "No educational resources have been published yet."
                }
              </p>
            </div>
          </div>
        )}
      </div>
      
      <div className="topics-footer">
        <div className="summary-stats">
          <span>📊 Total: {teachings.length} resources</span>
          {filteredTeachings.length !== teachings.length && (
            <span> | 🔍 Showing: {filteredTeachings.length}</span>
          )}
        </div>
      </div>
    </div>
  );
};

export default RevTopics;


//====================================


//ikootaclient\src\components\towncrier\RevTeaching.jsx
import React from "react";
import ReactPlayer from "react-player";
import "./revteaching.css";

const RevTeaching = ({ teaching, allTeachings = [], onSelectNext }) => {
  if (!teaching) {
    return (
      <div className="revTeaching-container">
        <div className="no-selection">
          <p>Select a teaching to view details.</p>
        </div>
      </div>
    );
  }

  // Enhanced media rendering function
  const renderMedia = (url, type, alt = "media", index) => {
    if (!url || !type) return null;

    const commonStyle = { 
      maxWidth: "100%", 
      marginBottom: "15px",
      borderRadius: "8px",
      boxShadow: "0 2px 8px rgba(0,0,0,0.1)"
    };

    switch (type) {
      case "image":
        return (
          <div key={`image-${index}`} className="media-item">
            <img 
              src={url} 
              alt={alt} 
              style={{ 
                ...commonStyle, 
                maxHeight: "400px", 
                objectFit: "contain",
                width: "100%"
              }}
              onError={(e) => {
                e.target.style.display = 'none';
                console.error('Failed to load image:', url);
              }}
            />
          </div>
        );
      case "video":
        return (
          <div key={`video-${index}`} className="media-item">
            <ReactPlayer 
              url={url} 
              controls 
              width="100%" 
              height="300px"
              style={commonStyle}
              onError={(error) => console.error('Video playback error:', error)}
            />
          </div>
        );
      case "audio":
        return (
          <div key={`audio-${index}`} className="media-item">
            <audio controls style={{ width: "100%", ...commonStyle }}>
              <source src={url} type="audio/mpeg" />
              <source src={url} type="audio/wav" />
              <source src={url} type="audio/ogg" />
              Your browser does not support the audio element.
            </audio>
          </div>
        );
      case "file":
        return (
          <div key={`file-${index}`} className="media-item">
            <a 
              href={url} 
              target="_blank" 
              rel="noopener noreferrer"
              style={{ 
                display: "block", 
                padding: "10px", 
                backgroundColor: "#f0f0f0",
                borderRadius: "4px",
                textDecoration: "none",
                color: "#333",
                ...commonStyle
              }}
            >
              📎 Download File
            </a>
          </div>
        );
      default:
        return (
          <div key={`unknown-${index}`} className="media-item">
            <p>Unsupported media type: {type}</p>
          </div>
        );
    }
  };

  // Helper functions
  const getContentIdentifier = (teaching) => {
    return teaching?.prefixed_id || `t${teaching?.id}` || 'Unknown';
  };

  const formatDate = (dateString) => {
    if (!dateString) return 'Unknown date';
    try {
      return new Date(dateString).toLocaleString();
    } catch (error) {
      return 'Invalid date';
    }
  };

  const formatContent = (content) => {
    if (!content) return 'No content available';
    
    // Simple formatting for URLs and line breaks
    return content
      .split('\n')
      .map((line, index) => (
        <p key={index} style={{ marginBottom: '10px' }}>
          {line}
        </p>
      ));
  };

  // Navigation helpers
  const findNextTeaching = () => {
    if (!allTeachings.length) return null;
    const currentIndex = allTeachings.findIndex(t => t.id === teaching.id);
    return currentIndex < allTeachings.length - 1 ? allTeachings[currentIndex + 1] : null;
  };

  const findPrevTeaching = () => {
    if (!allTeachings.length) return null;
    const currentIndex = allTeachings.findIndex(t => t.id === teaching.id);
    return currentIndex > 0 ? allTeachings[currentIndex - 1] : null;
  };

  const nextTeaching = findNextTeaching();
  const prevTeaching = findPrevTeaching();

  return (
    <div className="revTeaching-container">
      <div className="teaching-item">
        {/* Header */}
        <div className="teaching-header">
          <div className="title-section">
            <h2>{teaching.topic || 'Untitled Teaching'}</h2>
            <div className="teaching-meta">
              <span className="content-id">ID: {getContentIdentifier(teaching)}</span>
              <span className="content-type-badge">Teaching</span>
            </div>
          </div>
          
          {/* Navigation buttons */}
          {(prevTeaching || nextTeaching) && (
            <div className="navigation-buttons">
              {prevTeaching && (
                <button 
                  onClick={() => onSelectNext(prevTeaching)}
                  className="nav-btn prev-btn"
                  title={`Previous: ${prevTeaching.topic}`}
                >
                  ← Previous
                </button>
              )}
              {nextTeaching && (
                <button 
                  onClick={() => onSelectNext(nextTeaching)}
                  className="nav-btn next-btn"
                  title={`Next: ${nextTeaching.topic}`}
                >
                  Next →
                </button>
              )}
            </div>
          )}
        </div>

        {/* Content */}
        <div className="teaching-content">
          <div className="teaching-details">
            <p><strong>Description:</strong> {teaching.description || 'No description available'}</p>
            <p><strong>Lesson #:</strong> {teaching.lessonNumber || getContentIdentifier(teaching)}</p>
            <p><strong>Subject Matter:</strong> {teaching.subjectMatter || 'Not specified'}</p>
            <p><strong>Audience:</strong> {teaching.audience || 'General'}</p>
            <p><strong>By:</strong> {teaching.author || teaching.user_id || 'Admin'}</p>
            <p><strong>Created:</strong> {formatDate(teaching.createdAt)}</p>
            <p><strong>Updated:</strong> {formatDate(teaching.updatedAt)}</p>
          </div>

          {/* Main content */}
          {teaching.content && (
            <div className="main-content">
              <h3>Content:</h3>
              <div className="content-text">
                {formatContent(teaching.content)}
              </div>
            </div>
          )}
        </div>

        {/* Media content */}
        <div className="media-container">
          <h3>Media Content:</h3>
          {[
            { url: teaching.media_url1, type: teaching.media_type1 },
            { url: teaching.media_url2, type: teaching.media_type2 },
            { url: teaching.media_url3, type: teaching.media_type3 }
          ].some(media => media.url && media.type) ? (
            <div className="media-grid">
              {renderMedia(teaching.media_url1, teaching.media_type1, "Media 1", 1)}
              {renderMedia(teaching.media_url2, teaching.media_type2, "Media 2", 2)}
              {renderMedia(teaching.media_url3, teaching.media_type3, "Media 3", 3)}
            </div>
          ) : (
            <p className="no-media">No media content available</p>
          )}
        </div>

        {/* Footer with additional info */}
        <div className="teaching-footer">
          <div className="teaching-stats">
            <span>Position: {allTeachings.findIndex(t => t.id === teaching.id) + 1} of {allTeachings.length}</span>
            {teaching.display_date && (
              <span>Last activity: {formatDate(teaching.display_date)}</span>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

export default RevTeaching;


















//=============================
//SERVICE FOLDER
//============================

// ikootaclient/src/components/service/useFetchTeachings.js
import { useQuery } from '@tanstack/react-query';
import api from './api';
//import { normalizeTeachingsResponse, enhanceTeaching, debugApiResponse } from '../../components/utils/apiDebugHelper';

export const useFetchTeachings = () => {
  return useQuery({
    queryKey: ['teachings'],
    queryFn: async () => {
      try {
        console.log('🚀 Fetching teachings...');
        
        const response = await api.get('/teachings');
        
        // Debug the response
        debugApiResponse(response, '/teachings');
        
        // Normalize the response structure
        const teachingsData = normalizeTeachingsResponse(response);
        
        // Enhance each teaching with consistent structure
        const enhancedTeachings = teachingsData.map((teaching, index) => 
          enhanceTeaching(teaching, index)
        );
        
        // Sort by most recent first
        enhancedTeachings.sort((a, b) => {
          const aDate = new Date(a.display_date);
          const bDate = new Date(b.display_date);
          return bDate - aDate;
        });
        
        console.log(`✅ Successfully processed ${enhancedTeachings.length} teachings`);
        return enhancedTeachings;
        
      } catch (error) {
        console.error('❌ Error in useFetchTeachings:', error);
        
        // Enhanced error logging
        console.error('📋 Error details:', {
          message: error.message,
          status: error.response?.status,
          statusText: error.response?.statusText,
          data: error.response?.data,
          url: error.config?.url
        });
        
        // Throw the error for React Query to handle
        throw new Error(`Failed to fetch teachings: ${error.message}`);
      }
    },
    staleTime: 5 * 60 * 1000, // 5 minutes
    cacheTime: 10 * 60 * 1000, // 10 minutes
    retry: (failureCount, error) => {
      // Retry up to 3 times for network errors, but not for 4xx errors
      if (error.response?.status >= 400 && error.response?.status < 500) {
        return false; // Don't retry client errors
      }
      return failureCount < 3;
    },
    retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),
    onError: (error) => {
      console.error('🚨 React Query error in useFetchTeachings:', error);
    },
    onSuccess: (data) => {
      console.log('🎉 useFetchTeachings success:', data?.length, 'teachings loaded');
    }
  });
};


//========================================


//ikootaclient\src\components\service\useFetchComments.js
import { useQuery } from "@tanstack/react-query";
import api from "./api.js";

// Fetch parent chats and teachings along with their comments
export const useFetchParentChatsAndTeachingsWithComments = (user_id) => {
  return useQuery({
    queryKey: ["parent-comments", user_id],
    queryFn: async () => {
      if (!user_id) return [];
      const response = await api.get(`/comments/parent-comments`, {
        params: { user_id }
      });
      return response.data;
    },
    enabled: !!user_id, // Only fetch when user_id is set
  });
};

// Fetch comments by user_id
export const useFetchComments = (user_id) => {
  return useQuery({
    queryKey: ["comments", user_id],
    queryFn: async () => {
      if (!user_id) return [];
      const response = await api.get(`/comments/parent`, {
        params: {
          user_id
        }
      });
      return response.data;
    },
    enabled: !!user_id, // Only fetch when user_id is set
  });
};

// Fetch all comments
export const useFetchAllComments = () => {
  return useQuery({
    queryKey: ["all-comments"],
    queryFn: async () => {
      const response = await api.get(`/comments/all`);
      return response.data;
    }
  });
};


//======================================


//ikootaclient\src\components\service\useFetchChats.js
import { useQuery } from "@tanstack/react-query";
import api from "./api.js";

// Fetch chats
export const useFetchChats = () => {

  return useQuery({
    queryKey: ["chats"], // Corrected to use an array
    queryFn: async () => {
      const response = await api.get("/chats");
      return response.data;
    },
  });
};


//=============================


//ikootaclient\src\components\service\surveypageservice.js
import { useMutation } from '@tanstack/react-query';
import api from './api';

const submitForm = async (answers) => {
  const res = await api.post('/survey/submit_applicationsurvey', answers, { withCredentials: true });
  console.log('res.data', res.data);
  return res.data;
};

export const useSendApplicationsurvey = () => {
    return useMutation({
        mutationFn:submitForm,
    });
  };

  //======================================


  // ikootaclient/src/components/service/idGenerationService.js
// This replaces the old generateRandomId.js

import api from './api';

/**
 * Generates a cryptographically secure 6-character alphanumeric ID
 * @returns {string} A random 6-character alphanumeric ID
 */
const generateSecureRandomId = () => {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result = '';
    
    // Use crypto.getRandomValues for better security in browser
    const array = new Uint8Array(6);
    crypto.getRandomValues(array);
    
    for (let i = 0; i < 6; i++) {
        result += chars[array[i] % chars.length];
    }
    
    return result;
};

/**
 * Generates a preview converse ID for display purposes (not guaranteed unique)
 * Format: OTO#XXXXXX (total 10 characters)
 * @returns {string} A preview converse ID like "OTO#123ABC"
 */
export const generatePreviewConverseId = () => {
    const randomPart = generateSecureRandomId();
    return `OTO#${randomPart}`;
};

/**
 * Generates a preview class ID for display purposes (not guaranteed unique)
 * Format: OTU#XXXXXX (total 10 characters)
 * @returns {string} A preview class ID like "OTU#A1B2C3"
 */
export const generatePreviewClassId = () => {
    const randomPart = generateSecureRandomId();
    return `OTU#${randomPart}`;
};

/**
 * Requests a unique converse ID from the backend
 * @returns {Promise<string>} A unique converse ID from the server
 */
export const generateUniqueConverseId = async () => {
    try {
        const response = await api.post('/admin/generate-converse-id');
        return response.data.converseId;
    } catch (error) {
        console.error('Failed to generate unique converse ID:', error);
        // Fallback to preview ID (should be used carefully)
        return generatePreviewConverseId();
    }
};

/**
 * Requests a unique class ID from the backend
 * @returns {Promise<string>} A unique class ID from the server
 */
export const generateUniqueClassId = async () => {
    try {
        const response = await api.post('/admin/generate-class-id');
        return response.data.classId;
    } catch (error) {
        console.error('Failed to generate unique class ID:', error);
        // Fallback to preview ID (should be used carefully)
        return generatePreviewClassId();
    }
};

/**
 * Legacy function for backward compatibility
 * Generates a preview converse ID
 * @returns {string} A preview converse ID
 */
export const generateRandomId = () => {
    return generatePreviewConverseId();
};

/**
 * Validates if an ID follows the correct format
 * @param {string} id - The ID to validate
 * @param {string} type - Either 'user' or 'class'
 * @returns {boolean} True if valid format
 */
export const validateIdFormat = (id, type = 'user') => {
    if (!id || typeof id !== 'string') return false;
    
    if (type === 'user') {
        // Should be OTO# followed by 6 alphanumeric characters (total 10 chars)
        return /^OTO#[A-Z0-9]{6}$/.test(id);
    } else if (type === 'class') {
        // Should be OTU# followed by 6 alphanumeric characters (total 10 chars)
        return /^OTU#[A-Z0-9]{6}$/.test(id);
    }
    
    return false;
};

/**
 * Extracts the prefix from an ID
 * @param {string} id - The ID to analyze
 * @returns {string|null} The prefix ('OTO#' or 'OTU#') or null if invalid
 */
export const getIdPrefix = (id) => {
    if (!id || typeof id !== 'string' || id.length < 4) return null;
    
    const prefix = id.substring(0, 4);
    return ['OTO#', 'OTU#'].includes(prefix) ? prefix : null;
};

/**
 * Determines the entity type from an ID
 * @param {string} id - The ID to analyze
 * @returns {string|null} 'user', 'class', or null if invalid
 */
export const getEntityTypeFromId = (id) => {
    const prefix = getIdPrefix(id);
    
    if (prefix === 'OTO#') return 'user';
    if (prefix === 'OTU#') return 'class';
    
    return null;
};

/**
 * Extracts the random part from an ID (removes prefix)
 * @param {string} id - The ID to analyze
 * @returns {string|null} The 6-character random part or null if invalid
 */
export const getRandomPart = (id) => {
    if (!validateIdFormat(id, 'user') && !validateIdFormat(id, 'class')) {
        return null;
    }
    
    return id.substring(4); // Remove the 4-character prefix (OTO# or OTU#)
};

/**
 * Formats an ID for display with entity type indicator
 * @param {string} id - The ID to format
 * @returns {string} Formatted display string
 */
export const formatIdForDisplay = (id) => {
    const entityType = getEntityTypeFromId(id);
    
    if (entityType === 'user') {
        return `User ${id}`;
    } else if (entityType === 'class') {
        return `Class ${id}`;
    }
    
    return id; // Fallback to original ID
};

/**
 * Checks if two IDs are of compatible types for operations
 * @param {string} id1 - First ID
 * @param {string} id2 - Second ID
 * @param {string} operation - Type of operation ('mentor-assign', 'class-assign', etc.)
 * @returns {boolean} True if operation is valid
 */
export const validateIdCompatibility = (id1, id2, operation) => {
    const type1 = getEntityTypeFromId(id1);
    const type2 = getEntityTypeFromId(id2);
    
    switch (operation) {
        case 'mentor-assign':
            // Both should be users
            return type1 === 'user' && type2 === 'user';
        case 'class-assign':
            // One user, one class
            return (type1 === 'user' && type2 === 'class') || 
                   (type1 === 'class' && type2 === 'user');
        default:
            return true;
    }
};

/**
 * Generates a batch of preview IDs for testing or demonstration
 * @param {string} type - Either 'user' or 'class'
 * @param {number} count - Number of IDs to generate
 * @returns {string[]} Array of preview IDs
 */
export const generatePreviewIdBatch = (type = 'user', count = 5) => {
    const ids = [];
    
    for (let i = 0; i < count; i++) {
        if (type === 'user') {
            ids.push(generatePreviewConverseId());
        } else if (type === 'class') {
            ids.push(generatePreviewClassId());
        }
    }
    
    return ids;
};

/**
 * Converts old format IDs to new format (migration helper)
 * @param {string} oldId - Old format ID
 * @param {string} type - Entity type ('user' or 'class')
 * @returns {string} New format ID
 */
export const convertToNewFormat = (oldId, type = 'user') => {
    if (!oldId) return null;
    
    // If already in new format, return as is
    if (validateIdFormat(oldId, type)) {
        return oldId;
    }
    
    // Convert old format to new format
    const randomPart = generateSecureRandomId();
    
    if (type === 'user') {
        return `OTO#${randomPart}`;
    } else if (type === 'class') {
        return `OTU#${randomPart}`;
    }
    
    return null;
};


//================================

// ikootaclient/src/components/service/fullMembershipService.js
// Service functions for Full Membership Review Operations
// Parallel to surveypageservice.js but for full membership applications

import { useMutation, useQuery } from '@tanstack/react-query';
import api from './api';

// =====================================================
// SUBMISSION SERVICES (for applicants)
// =====================================================

/**
 * Submit full membership application
 * Used by pre-members applying for full membership
 */
const submitFullMembershipApplication = async (applicationData) => {
  console.log('🔍 Submitting full membership application:', applicationData);
  
  const res = await api.post('/full-membership/submit-full-membership', applicationData, { 
    withCredentials: true 
  });
  
  console.log('✅ Full membership submission response:', res.data);
  return res.data;
};

/**
 * Reapply for full membership (after decline)
 */
const reapplyFullMembership = async (applicationData) => {
  console.log('🔍 Reapplying for full membership:', applicationData);
  
  const res = await api.post('/full-membership/reapply-full-membership', applicationData, { 
    withCredentials: true 
  });
  
  console.log('✅ Full membership reapplication response:', res.data);
  return res.data;
};

/**
 * Get user's full membership status
 */
const getFullMembershipStatus = async (userId) => {
  console.log('🔍 Fetching full membership status for user:', userId);
  
  const res = await api.get(`/full-membership/full-membership-status/${userId}`, { 
    withCredentials: true 
  });
  
  console.log('✅ Full membership status response:', res.data);
  return res.data;
};

// =====================================================
// ADMIN REVIEW SERVICES
// =====================================================

/**
 * Fetch all full membership applications (Admin)
 */
const fetchFullMembershipApplications = async (filters = {}) => {
  console.log('🔍 Fetching full membership applications with filters:', filters);
  
  const params = new URLSearchParams({
    status: 'pending',
    limit: 50,
    offset: 0,
    ...filters
  });
  
  const res = await api.get(`/admin/membership/applications?${params}`, { 
    withCredentials: true 
  });
  
  console.log('✅ Full membership applications response:', res.data);
  return res.data;
};

/**
 * Review full membership application (Admin approve/decline)
 */
const reviewFullMembershipApplication = async ({ applicationId, status, adminNotes }) => {
  console.log('🔍 Reviewing full membership application:', { applicationId, status, adminNotes });
  
  if (!['approved', 'declined'].includes(status)) {
    throw new Error('Invalid status. Must be "approved" or "declined"');
  }
  
  const res = await api.put(`/admin/membership/review/${applicationId}`, {
    status,
    adminNotes
  }, { 
    withCredentials: true 
  });
  
  console.log('✅ Application review response:', res.data);
  return res.data;
};

/**
 * Get application statistics (Admin)
 */
const getApplicationStatistics = async () => {
  console.log('🔍 Fetching application statistics...');
  
  const res = await api.get('/admin/applications/stats', { 
    withCredentials: true 
  });
  
  console.log('✅ Application statistics response:', res.data);
  return res.data;
};

/**
 * Send feedback email for application decision
 */
const sendApplicationFeedbackEmail = async ({ email, status, applicantName, membershipTicket, customMessage }) => {
  console.log('🔍 Sending application feedback email:', { email, status, applicantName });
  
  const res = await api.post('/email/send-membership-feedback', {
    email,
    status,
    applicantName,
    membershipTicket,
    customMessage,
    template: status === 'approved' ? 'full_membership_approved' : 'full_membership_declined'
  }, { 
    withCredentials: true 
  });
  
  console.log('✅ Feedback email response:', res.data);
  return res.data;
};

/**
 * Bulk operations for multiple applications (Admin)
 */
const bulkReviewApplications = async ({ applicationIds, action, adminNotes }) => {
  console.log('🔍 Bulk reviewing applications:', { applicationIds, action, adminNotes });
  
  const res = await api.post('/admin/membership/bulk-review', {
    applicationIds,
    action,
    adminNotes
  }, { 
    withCredentials: true 
  });
  
  console.log('✅ Bulk review response:', res.data);
  return res.data;
};

/**
 * Export applications data (Admin)
 */
const exportApplicationsData = async (filters = {}) => {
  console.log('🔍 Exporting applications data with filters:', filters);
  
  const params = new URLSearchParams(filters);
  const res = await api.get(`/admin/membership/export?${params}`, { 
    withCredentials: true,
    responseType: 'blob' // For file download
  });
  
  console.log('✅ Export completed');
  return res.data;
};

// =====================================================
// REACT QUERY HOOKS FOR APPLICANTS
// =====================================================

/**
 * Hook for submitting full membership application
 */
export const useSubmitFullMembershipApplication = () => {
  return useMutation({
    mutationFn: submitFullMembershipApplication,
    onSuccess: (data) => {
      console.log('✅ Full membership application submitted successfully:', data);
    },
    onError: (error) => {
      console.error('❌ Full membership application submission failed:', error);
    }
  });
};

/**
 * Hook for reapplying for full membership
 */
export const useReapplyFullMembership = () => {
  return useMutation({
    mutationFn: reapplyFullMembership,
    onSuccess: (data) => {
      console.log('✅ Full membership reapplication submitted successfully:', data);
    },
    onError: (error) => {
      console.error('❌ Full membership reapplication failed:', error);
    }
  });
};

/**
 * Hook for fetching user's full membership status
 */
export const useFullMembershipStatus = (userId, options = {}) => {
  return useQuery({
    queryKey: ['fullMembershipStatus', userId],
    queryFn: () => getFullMembershipStatus(userId),
    enabled: !!userId,
    staleTime: 5 * 60 * 1000, // 5 minutes
    cacheTime: 10 * 60 * 1000, // 10 minutes
    ...options
  });
};

// =====================================================
// REACT QUERY HOOKS FOR ADMIN REVIEW
// =====================================================

/**
 * Hook for fetching full membership applications (Admin)
 */
export const useFullMembershipApplications = (filters = {}, options = {}) => {
  return useQuery({
    queryKey: ['fullMembershipApplications', filters],
    queryFn: () => fetchFullMembershipApplications(filters),
    staleTime: 2 * 60 * 1000, // 2 minutes
    cacheTime: 5 * 60 * 1000, // 5 minutes
    ...options
  });
};

/**
 * Hook for reviewing full membership application (Admin)
 */
export const useReviewFullMembershipApplication = () => {
  return useMutation({
    mutationFn: reviewFullMembershipApplication,
    onSuccess: (data, variables) => {
      console.log('✅ Application review completed:', variables.status);
    },
    onError: (error) => {
      console.error('❌ Application review failed:', error);
    }
  });
};

/**
 * Hook for fetching application statistics (Admin)
 */
export const useApplicationStatistics = (options = {}) => {
  return useQuery({
    queryKey: ['applicationStatistics'],
    queryFn: getApplicationStatistics,
    staleTime: 5 * 60 * 1000, // 5 minutes
    cacheTime: 10 * 60 * 1000, // 10 minutes
    ...options
  });
};

/**
 * Hook for sending feedback emails
 */
export const useSendApplicationFeedback = () => {
  return useMutation({
    mutationFn: sendApplicationFeedbackEmail,
    onSuccess: (data) => {
      console.log('✅ Feedback email sent successfully');
    },
    onError: (error) => {
      console.error('❌ Feedback email failed:', error);
    }
  });
};

/**
 * Hook for bulk reviewing applications (Admin)
 */
export const useBulkReviewApplications = () => {
  return useMutation({
    mutationFn: bulkReviewApplications,
    onSuccess: (data, variables) => {
      console.log('✅ Bulk review completed:', variables.action);
    },
    onError: (error) => {
      console.error('❌ Bulk review failed:', error);
    }
  });
};

/**
 * Hook for exporting applications data (Admin)
 */
export const useExportApplicationsData = () => {
  return useMutation({
    mutationFn: exportApplicationsData,
    onSuccess: (data) => {
      console.log('✅ Applications data exported successfully');
      
      // Trigger file download
      const blob = new Blob([data], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `full_membership_applications_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(url);
    },
    onError: (error) => {
      console.error('❌ Export failed:', error);
    }
  });
};

// =====================================================
// UTILITY FUNCTIONS
// =====================================================

/**
 * Format application status for display
 */
export const formatApplicationStatus = (status) => {
  const statusMap = {
    'not_applied': { text: 'Not Applied', color: 'gray', icon: '📋' },
    'pending': { text: 'Under Review', color: 'yellow', icon: '⏳' },
    'approved': { text: 'Approved', color: 'green', icon: '✅' },
    'declined': { text: 'Declined', color: 'red', icon: '❌' }
  };
  
  return statusMap[status] || { text: status, color: 'gray', icon: '❓' };
};

/**
 * Calculate days since application submission
 */
export const calculateDaysPending = (submittedAt) => {
  if (!submittedAt) return 0;
  
  const submissionDate = new Date(submittedAt);
  const now = new Date();
  const diffTime = Math.abs(now - submissionDate);
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  return diffDays;
};

/**
 * Validate application data before submission
 */
export const validateApplicationData = (applicationData) => {
  const errors = [];
  
  if (!applicationData.answers || !Array.isArray(applicationData.answers)) {
    errors.push('Application answers are required');
  }
  
  if (!applicationData.membershipTicket) {
    errors.push('Membership ticket is required');
  }
  
  if (applicationData.answers && applicationData.answers.length === 0) {
    errors.push('At least one application answer is required');
  }
  
  return {
    isValid: errors.length === 0,
    errors
  };
};

/**
 * Generate membership ticket (utility function)
 */
export const generateMembershipTicket = () => {
  const timestamp = Date.now().toString(36);
  const randomStr = Math.random().toString(36).substr(2, 5);
  return `FM-${timestamp}-${randomStr}`.toUpperCase();
};

// =====================================================
// DEFAULT EXPORT WITH ALL FUNCTIONS
// =====================================================

export default {
  // Service functions
  submitFullMembershipApplication,
  reapplyFullMembership,
  getFullMembershipStatus,
  fetchFullMembershipApplications,
  reviewFullMembershipApplication,
  getApplicationStatistics,
  sendApplicationFeedbackEmail,
  bulkReviewApplications,
  exportApplicationsData,
  
  // React Query hooks
  useSubmitFullMembershipApplication,
  useReapplyFullMembership,
  useFullMembershipStatus,
  useFullMembershipApplications,
  useReviewFullMembershipApplication,
  useApplicationStatistics,
  useSendApplicationFeedback,
  useBulkReviewApplications,
  useExportApplicationsData,
  
  // Utility functions
  formatApplicationStatus,
  calculateDaysPending,
  validateApplicationData,
  generateMembershipTicket
};


//====================================


//ikootaclient\src\components\service\commentServices.js
import api from './api.js';

export const postComment = async ({ chatId, userId, comment, mediaData }) => {
    try {
      const response = await api.post("/comments", {
        userId,
        chatId,
        comment,
        media: mediaData, // Send structured media data
      });
     
      return response.data;

    } catch (error) {
      console.error("Error posting comment:", error.response?.data || error.message);
      throw error;
    }
  };

export const getCommentData = async (commentId) => {
    try {
      const response = await api.get(`/comments/${commentId}`);
     
      return response.data;
    } catch (error) {
      console.error("Error fetching comment data:", error.response?.data || error.message);
      throw error;
    }
  };
  


//====================================


//ikootaclient\src\components\service\api.js
// Create this file: /service/api.js (or wherever your path expects it)

import axios from 'axios';

const API_BASE_URL = 'http://localhost:3000/api';

const api = axios.create({
  baseURL: API_BASE_URL,
  headers: {
    'Content-Type': 'application/json',
  },
});


// Add auth interceptor
api.interceptors.request.use(
  (config) => {
    const token = localStorage.getItem('token');
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);

// Add request interceptor to include token
api.interceptors.request.use(
  (config) => {
    const token = localStorage.getItem('token') || sessionStorage.getItem('token');
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    
    console.log('🔍 API Request:', {
      method: config.method?.toUpperCase(),
      url: config.url,
      fullURL: config.baseURL + config.url,
      hasToken: !!token
    });
    
    return config;
  },
  (error) => {
    console.error('❌ Request interceptor error:', error);
    return Promise.reject(error);
  }
);

// Add response interceptor to handle errors
api.interceptors.response.use(
  (response) => {
    console.log('✅ API Response:', {
      status: response.status,
      url: response.config.url,
      data: response.data
    });
    return response;
  },
  (error) => {
    console.error('❌ API Response Error:', {
      status: error.response?.status,
      url: error.config?.url,
      data: error.response?.data,
      message: error.message
    });
    
    // If we get HTML instead of JSON, it's likely a routing issue
    if (error.response?.data && typeof error.response.data === 'string' && error.response.data.includes('<!doctype')) {
      console.error('❌ Received HTML instead of JSON - this is likely a routing issue');
    }
    
    return Promise.reject(error);
  }
);

export default api;







//======================================
//search FOLDER

//======================================


import React, { useState } from 'react';
import './searchcontrols.css';

const SearchControls = ({ onSearch }) => {
  const [query, setQuery] = useState('');

  const handleSearch = (e) => {
    e.preventDefault();
    onSearch(query);
  };

  return (
    <div className="search-controls">
      <form onSubmit={handleSearch}>
        <input
          type="text"
          placeholder="Search..."
          value={query}
          onChange={(e) => setQuery(e.target.value)}
        />
        <button type="submit">Search</button>
      </form>
    </div>
  );
};

export default SearchControls;


//=======================================
//membership  FOLDER
//=======================================


// ikootaclient/src/components/membership/FullMembershipSurvey.jsx - WITH AUTOSAVE
import React, { useState, useEffect, useCallback } from "react";
import { useNavigate } from "react-router-dom";
import { useUser } from '../auth/UserStatus';
import api from "../service/api";
import './fullMembershipSurvey.css';

const FullMembershipSurvey = () => {
  const navigate = useNavigate();
  const { user, isAuthenticated } = useUser();
  const [answers, setAnswers] = useState(['', '', '', '', '', '', '', '']);
  const [loading, setLoading] = useState(false);
  const [hasSubmitted, setHasSubmitted] = useState(false);
  const [currentStep, setCurrentStep] = useState(0);
  const [lastSaved, setLastSaved] = useState(null);
  const [autoSaveStatus, setAutoSaveStatus] = useState('saved'); // 'saving', 'saved', 'error'

  // ✅ AUTOSAVE: Storage keys
  const STORAGE_KEY = `full_membership_survey_${user?.id || 'guest'}`;
  const PROGRESS_KEY = `${STORAGE_KEY}_progress`;

  // Full Membership Survey Questions
  const questions = [
    {
      id: 1,
      question: "Describe your current role in education and your professional experience in teaching, learning, or educational administration.",
      placeholder: "Include your current position, years of experience, institutions you've worked with, and any educational leadership roles...",
      required: true
    },
    {
      id: 2, 
      question: "What specific educational expertise or specialization do you bring to our community? What subjects or areas are you most passionate about?",
      placeholder: "Detail your areas of expertise, specialized knowledge, subjects you teach or research, and what makes you unique...",
      required: true
    },
    {
      id: 3,
      question: "How do you envision contributing to the Ikoota community? What kind of content, discussions, or collaborations would you like to initiate or participate in?",
      placeholder: "Describe specific ways you plan to contribute, types of content you'd create, discussions you'd lead, or projects you'd collaborate on...",
      required: true
    },
    {
      id: 4,
      question: "Describe a challenging educational situation you've encountered and how you addressed it. What did you learn from this experience?",
      placeholder: "Share a specific example that demonstrates your problem-solving skills, adaptability, and learning mindset in educational contexts...",
      required: true
    },
    {
      id: 5,
      question: "What is your philosophy on collaborative learning and knowledge sharing? How do you approach working with diverse groups of educators and learners?",
      placeholder: "Explain your beliefs about collaboration, how you handle different perspectives, and your approach to inclusive education...",
      required: true
    },
    {
      id: 6,
      question: "What are your professional development goals, and how do you see Ikoota helping you achieve them? What do you hope to learn from other community members?",
      placeholder: "Outline your growth objectives, areas where you want to improve, and how you plan to leverage the community for development...",
      required: true
    },
    {
      id: 7,
      question: "How would you handle disagreements or conflicts within educational discussions? Describe your approach to maintaining professionalism in challenging conversations.",
      placeholder: "Explain your conflict resolution strategies, how you maintain respect during disagreements, and your commitment to professional discourse...",
      required: true
    },
    {
      id: 8,
      question: "Is there anything else you'd like to share about yourself, your educational journey, or your commitment to being an active and valuable member of our community?",
      placeholder: "Add any additional information that would help us understand your passion for education and community involvement...",
      required: false
    }
  ];

  // ✅ AUTOSAVE: Load saved data on component mount
  useEffect(() => {
    if (user?.id) {
      const savedData = localStorage.getItem(STORAGE_KEY);
      const savedProgress = localStorage.getItem(PROGRESS_KEY);
      
      if (savedData) {
        try {
          const parsedData = JSON.parse(savedData);
          if (parsedData.answers && Array.isArray(parsedData.answers)) {
            setAnswers(parsedData.answers);
            setLastSaved(new Date(parsedData.timestamp));
            console.log('✅ Loaded saved application data:', parsedData);
          }
        } catch (error) {
          console.error('❌ Error loading saved data:', error);
        }
      }
      
      if (savedProgress) {
        try {
          const step = parseInt(savedProgress);
          if (step >= 0 && step < questions.length) {
            setCurrentStep(step);
          }
        } catch (error) {
          console.error('❌ Error loading saved progress:', error);
        }
      }
    }
  }, [user?.id]);

  // ✅ AUTOSAVE: Save data to localStorage
  const saveToLocalStorage = useCallback((answersToSave, stepToSave) => {
    if (!user?.id) return;
    
    try {
      const dataToSave = {
        answers: answersToSave,
        timestamp: new Date().toISOString(),
        currentStep: stepToSave,
        userId: user.id,
        username: user.username
      };
      
      localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
      localStorage.setItem(PROGRESS_KEY, stepToSave.toString());
      setLastSaved(new Date());
      setAutoSaveStatus('saved');
      
      console.log('💾 Auto-saved application data');
    } catch (error) {
      console.error('❌ Error saving to localStorage:', error);
      setAutoSaveStatus('error');
    }
  }, [user?.id, STORAGE_KEY, PROGRESS_KEY]);

  // ✅ AUTOSAVE: Auto-save when answers change
  useEffect(() => {
    if (answers.some(answer => answer.trim().length > 0)) {
      setAutoSaveStatus('saving');
      const timeoutId = setTimeout(() => {
        saveToLocalStorage(answers, currentStep);
      }, 2000); // Save 2 seconds after user stops typing
      
      return () => clearTimeout(timeoutId);
    }
  }, [answers, currentStep, saveToLocalStorage]);

  // ✅ MANUAL SAVE: Function for manual save button
  const handleManualSave = () => {
    setAutoSaveStatus('saving');
    saveToLocalStorage(answers, currentStep);
  };

  // ✅ CLEAR SAVED DATA: Function to clear localStorage
  const clearSavedData = () => {
    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(PROGRESS_KEY);
    setLastSaved(null);
    console.log('🗑️ Cleared saved application data');
  };

  useEffect(() => {
    if (!isAuthenticated) {
      alert('Please sign in first to access the full membership survey.');
      navigate('/login');
      return;
    }

    // Check if user has already submitted
    checkSubmissionStatus();
  }, [isAuthenticated, navigate]);

  // const checkSubmissionStatus = async () => {
  //   try {
  //     // ✅ FIXED: Use the correct endpoint with userId
  //     const response = await api.get(`/membership/full-membership-status/${user.id}`);
  //     if (response.data.hasSubmitted || response.data.status === 'pending' || response.data.status === 'approved') {
  //       setHasSubmitted(true);
  //       // Clear saved data if already submitted
  //       clearSavedData();
  //       alert('You have already submitted a full membership application.');
  //       navigate('/full-membership-info');
  //     }
  //   } catch (error) {
  //     console.error('Error checking submission status:', error);
  //     // Continue to show the form if there's an error checking status
  //   }
  // };


const checkSubmissionStatus = async () => {
  try {
    // ✅ FIXED: Properly extract userId and handle undefined case
    const userId = user?.user_id || user?.id;
    
    if (!userId) {
      console.log('No user ID available');
      return;
    }

    console.log('🔍 Checking submission status for user:', userId);
    
    const response = await api.get(`/membership/full-membership-status/${userId}`);
    
    console.log('✅ Submission status response:', response.data);
    
    if (response.data.hasApplication || 
        response.data.status === 'pending' || 
        response.data.status === 'approved') {
      setHasSubmitted(true);
      // Clear saved data if already submitted
      clearSavedData();
      alert('You have already submitted a full membership application.');
      navigate('/full-membership-info');
    }
  } catch (error) {
    console.log('Error checking submission status:', error);
    
    // If it's a 404 or 403, that means no application exists, so continue
    if (error.response?.status === 404 || error.response?.status === 403) {
      console.log('No existing application found, proceeding with form');
      return;
    }
    
    // For other errors, continue to show the form
    console.log('API error, but continuing to show form');
  }
};

  const generateMembershipTicket = () => {
    const username = user?.username || 'USER';
    const email = user?.email || 'user@example.com';
    const usernamePrefix = username.substring(0, 3).toUpperCase();
    const emailPrefix = email.split('@')[0].substring(0, 3).toUpperCase();
    const now = new Date();
    const dateStr = now.toISOString().slice(2, 10).replace(/-/g, ''); // YYMMDD
    const timeStr = now.toTimeString().slice(0, 5).replace(':', ''); // HHMM
    
    return `FM${usernamePrefix}${emailPrefix}${dateStr}${timeStr}`; // FM = Full Membership
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    // Validate required answers
    const requiredAnswers = questions.filter(q => q.required).map((q, index) => answers[index]);
    if (requiredAnswers.some(answer => !answer.trim())) {
      alert('Please answer all required questions before submitting.');
      return;
    }

    setLoading(true);
    
    try {
      const membershipTicket = generateMembershipTicket();
      
      const response = await api.post('/membership/submit-full-membership', {
        answers: answers,
        membershipTicket: membershipTicket,
        userId: user.id,
        userEmail: user.email,
        username: user.username,
        applicationType: 'full_membership'
      });

      if (response.status === 200 || response.status === 201) {
        // ✅ SUCCESS: Clear saved data after successful submission
        clearSavedData();
        
        alert(`Full Membership application submitted successfully!\n\nYour Membership Ticket: ${membershipTicket}\n\nPlease save this number for your records.`);
        
        navigate('/full-membership-submitted', { 
          state: { 
            membershipTicket: membershipTicket,
            username: user.username 
          }
        });
      }
    } catch (error) {
      console.error('Error submitting full membership survey:', error);
      alert(`Failed to submit application: ${error.response?.data?.message || 'Please try again. Your progress has been saved.'}`);
    } finally {
      setLoading(false);
    }
  };

  const handleInputChange = (index, value) => {
    const updatedAnswers = [...answers];
    updatedAnswers[index] = value;
    setAnswers(updatedAnswers);
  };

  const nextStep = () => {
    if (currentStep < questions.length - 1) {
      const newStep = currentStep + 1;
      setCurrentStep(newStep);
      saveToLocalStorage(answers, newStep);
    }
  };

  const prevStep = () => {
    if (currentStep > 0) {
      const newStep = currentStep - 1;
      setCurrentStep(newStep);
      saveToLocalStorage(answers, newStep);
    }
  };

  const goToStep = (step) => {
    setCurrentStep(step);
    saveToLocalStorage(answers, step);
  };

  const getCompletionPercentage = () => {
    const answeredCount = answers.filter(answer => answer.trim()).length;
    return Math.round((answeredCount / questions.length) * 100);
  };

  const getAutoSaveStatusDisplay = () => {
    switch (autoSaveStatus) {
      case 'saving':
        return { text: '💾 Saving...', color: '#f59e0b' };
      case 'saved':
        return lastSaved ? { 
          text: `✅ Saved ${lastSaved.toLocaleTimeString()}`, 
          color: '#10b981' 
        } : { text: '✅ Saved', color: '#10b981' };
      case 'error':
        return { text: '⚠️ Save failed', color: '#ef4444' };
      default:
        return { text: '', color: '#6b7280' };
    }
  };

  if (hasSubmitted) {
    return (
      <div className="survey-container">
        <div className="submitted-message">
          <h2>Application Already Submitted</h2>
          <p>You have already submitted your full membership application.</p>
          <button onClick={() => navigate('/full-membership-info')} className="btn-primary">
            View Application Status
          </button>
        </div>
      </div>
    );
  }

  const autoSaveDisplay = getAutoSaveStatusDisplay();

  return (
    <div className="full-membership-survey-container">
      <div className="survey-card">
        <div className="survey-header">
          <h1>🎓 Full Membership Application Survey</h1>
          <p>Complete this comprehensive survey to apply for full membership</p>
          
          <div className="progress-section">
            <div className="progress-bar">
              <div 
                className="progress-fill" 
                style={{ width: `${getCompletionPercentage()}%` }}
              ></div>
            </div>
            <div className="progress-info">
              <span>{getCompletionPercentage()}% Complete</span>
              <span>{answers.filter(a => a.trim()).length} of {questions.length} answered</span>
            </div>
          </div>

          {/* ✅ AUTOSAVE STATUS DISPLAY */}
          <div className="autosave-status" style={{ 
            marginTop: '10px', 
            fontSize: '0.9rem',
            color: autoSaveDisplay.color 
          }}>
            {autoSaveDisplay.text}
          </div>
        </div>

        <div className="applicant-info">
          <p><strong>Applicant:</strong> {user?.username} ({user?.email})</p>
          <p><strong>Current Status:</strong> Pre-Member</p>
          <p><strong>Application Type:</strong> Full Membership</p>
        </div>

        <form onSubmit={handleSubmit} className="survey-form">
          {/* ✅ SAVE CONTROLS */}
          <div className="save-controls" style={{
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            padding: '15px',
            backgroundColor: '#f8fafc',
            borderRadius: '8px',
            marginBottom: '20px',
            border: '1px solid #e2e8f0'
          }}>
            <div style={{ fontSize: '0.9rem', color: '#64748b' }}>
              Your progress is automatically saved as you type
            </div>
            <button 
              type="button"
              onClick={handleManualSave}
              className="btn-save"
              style={{
                padding: '8px 16px',
                fontSize: '0.9rem',
                backgroundColor: '#667eea',
                color: 'white',
                border: 'none',
                borderRadius: '6px',
                cursor: 'pointer'
              }}
            >
              💾 Save Now
            </button>
          </div>

          <div className="question-navigation">
            <div className="question-tabs">
              {questions.map((_, index) => (
                <button
                  key={index}
                  type="button"
                  className={`question-tab ${currentStep === index ? 'active' : ''} ${answers[index].trim() ? 'completed' : ''}`}
                  onClick={() => goToStep(index)}
                >
                  {index + 1}
                </button>
              ))}
            </div>
          </div>

          <div className="current-question">
            <div className="question-header">
              <span className="question-number">Question {currentStep + 1} of {questions.length}</span>
              {questions[currentStep].required && <span className="required-indicator">* Required</span>}
            </div>
            
            <label className="question-label">
              {questions[currentStep].question}
            </label>
            
            <textarea
              value={answers[currentStep]}
              onChange={(e) => handleInputChange(currentStep, e.target.value)}
              placeholder={questions[currentStep].placeholder}
              className="answer-input"
              rows="6"
              required={questions[currentStep].required}
            />
            
            <div className="character-count">
              {answers[currentStep].length} characters
              {answers[currentStep].length < 50 && questions[currentStep].required && (
                <span className="min-length-warning"> (Minimum 50 characters recommended)</span>
              )}
            </div>
          </div>

          <div className="navigation-buttons">
            <button 
              type="button" 
              onClick={prevStep} 
              disabled={currentStep === 0}
              className="btn-nav prev"
            >
              ← Previous
            </button>
            
            {currentStep < questions.length - 1 ? (
              <button 
                type="button" 
                onClick={nextStep}
                className="btn-nav next"
              >
                Next →
              </button>
            ) : (
              <button 
                type="submit" 
                disabled={loading || answers.filter((a, i) => questions[i].required).some(a => !a.trim())}
                className="btn-submit"
              >
                {loading ? 'Submitting Application...' : 'Submit Full Membership Application'}
              </button>
            )}
          </div>

          <div className="survey-overview">
            <h4>📋 Questions Overview</h4>
            <div className="questions-list">
              {questions.map((q, index) => (
                <div 
                  key={q.id} 
                  className={`question-overview-item ${answers[index].trim() ? 'answered' : ''} ${currentStep === index ? 'current' : ''}`}
                  onClick={() => goToStep(index)}
                >
                  <span className="question-num">Q{index + 1}</span>
                  <span className="question-brief">{q.question.substring(0, 60)}...</span>
                  <span className="question-status">
                    {answers[index].trim() ? '✓' : (q.required ? '*' : '○')}
                  </span>
                </div>
              ))}
            </div>
          </div>

          <div className="application-info">
            <h4>ℹ️ Application Information</h4>
            <div className="info-grid">
              <div className="info-item">
                <strong>Review Timeline:</strong> 5-7 business days
              </div>
              <div className="info-item">
                <strong>Decision Notification:</strong> Via email
              </div>
              <div className="info-item">
                <strong>Application Tracking:</strong> Unique ticket number provided
              </div>
              <div className="info-item">
                <strong>Support Contact:</strong> support@ikoota.com
              </div>
            </div>
          </div>

          <div className="form-actions">
            <button 
              type="button" 
              onClick={() => navigate('/full-membership-info')}
              className="btn-cancel"
            >
              ← Back to Information
            </button>
            
            <button 
              type="button" 
              onClick={() => navigate('/towncrier')}
              className="btn-cancel"
            >
              Cancel & Return to Towncrier
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

export default FullMembershipSurvey;


//=======================================


// ikootaclient/src/components/membership/FullMembershipSubmitted.jsx
import React, { useState, useEffect } from 'react';
import { useNavigate, useLocation } from 'react-router-dom';
import { useUser } from '../auth/UserStatus';
import './fullMembershipSubmitted.css';

const FullMembershipSubmitted = () => {
  const navigate = useNavigate();
  const location = useLocation();
  const { user } = useUser();
  const [membershipTicket, setMembershipTicket] = useState('');
  const [username, setUsername] = useState('');

  useEffect(() => {
    if (location.state) {
      setMembershipTicket(location.state.membershipTicket || '');
      setUsername(location.state.username || '');
    } else if (user) {
      setUsername(user.username || user.email || 'User');
    }
  }, [location.state, user]);

  const copyTicketToClipboard = () => {
    if (membershipTicket) {
      navigator.clipboard.writeText(membershipTicket);
      alert('Membership ticket copied to clipboard!');
    }
  };

  return (
    <div className="membership-submitted-container">
      <div className="submitted-card">
        <div className="success-animation">
          <div className="checkmark">✓</div>
        </div>

        <div className="submitted-header">
          <h1>🎉 Full Membership Application Submitted!</h1>
          <h2>Thank you, {username}!</h2>
        </div>

        <div className="submitted-content">
          <div className="confirmation-message">
            <p>
              Your full membership application has been submitted successfully and is now 
              <strong> under review</strong> by our membership committee.
            </p>
          </div>

          {membershipTicket && (
            <div className="ticket-section">
              <h3>🎫 Your Membership Application Ticket</h3>
              <div className="ticket-display">
                <div className="ticket-number" onClick={copyTicketToClipboard}>
                  {membershipTicket}
                </div>
                <button onClick={copyTicketToClipboard} className="copy-btn">
                  📋 Copy
                </button>
              </div>
              <p className="ticket-note">
                <strong>Important:</strong> Save this ticket number! You'll need it for:
              </p>
              <ul className="ticket-uses">
                <li>Tracking your full membership application status</li>
                <li>Any inquiries about your application</li>
                <li>Contacting support if needed</li>
                <li>Reference during the review process</li>
              </ul>
            </div>
          )}

          <div className="timeline-section">
            <h3>📅 Full Membership Review Process</h3>
            <div className="timeline">
              <div className="timeline-item completed">
                <div className="timeline-marker">✅</div>
                <div className="timeline-content">
                  <h4>Application Submitted</h4>
                  <p>Your full membership survey is in our system</p>
                  <span className="timestamp">Just now</span>
                </div>
              </div>
              
              <div className="timeline-item pending">
                <div className="timeline-marker">👥</div>
                <div className="timeline-content">
                  <h4>Committee Review</h4>
                  <p>Membership committee evaluating your application</p>
                  <span className="timestamp">5-7 business days</span>
                </div>
              </div>
              
              <div className="timeline-item future">
                <div className="timeline-marker">📧</div>
                <div className="timeline-content">
                  <h4>Decision Notification</h4>
                  <p>Email notification with final decision</p>
                  <span className="timestamp">After review</span>
                </div>
              </div>
              
              <div className="timeline-item future">
                <div className="timeline-marker">💎</div>
                <div className="timeline-content">
                  <h4>Full Member Access</h4>
                  <p>If approved, complete platform access granted</p>
                  <span className="timestamp">Upon approval</span>
                </div>
              </div>
            </div>
          </div>

          <div className="review-outcomes">
            <h3>📊 Possible Review Outcomes</h3>
            <div className="outcomes-grid">
              <div className="outcome-item approved">
                <span className="outcome-icon">✅</span>
                <div className="outcome-content">
                  <h4>Approved - Full Member</h4>
                  <p>Complete access to Iko chat, commenting, and content creation</p>
                </div>
              </div>
              <div className="outcome-item suspended">
                <span className="outcome-icon">⚠️</span>
                <div className="outcome-content">
                  <h4>Suspended - More Info Needed</h4>
                  <p>Additional information or clarification required</p>
                </div>
              </div>
              <div className="outcome-item declined">
                <span className="outcome-icon">❌</span>
                <div className="outcome-content">
                  <h4>Declined - Reapply Later</h4>
                  <p>Application not approved, with guidance for future applications</p>
                </div>
              </div>
            </div>
          </div>

          <div className="current-access">
            <h3>📚 Current Access Level</h3>
            <div className="access-info">
              <div className="access-status">
                <span className="status-icon">🌟</span>
                <div>
                  <h4>Pre-Member Status</h4>
                  <p>You continue to have read-only access to Towncrier educational content while your full membership application is under review.</p>
                </div>
              </div>
              
              <div className="access-limitations">
                <h4>⚠️ Current Limitations (Until Full Membership Approval):</h4>
                <ul>
                  <li>❌ No access to Iko chat system</li>
                  <li>❌ Cannot comment on posts or discussions</li>
                  <li>❌ Cannot create or share content</li>
                  <li>❌ Limited interaction with other members</li>
                </ul>
              </div>
            </div>
          </div>

          <div className="during-review">
            <h3>⏰ During the Review Period</h3>
            <div className="review-guidelines">
              <div className="guideline-item">
                <span className="guideline-icon">📧</span>
                <div>
                  <h4>Monitor Your Email</h4>
                  <p>We'll send updates to {user?.email}</p>
                </div>
              </div>
              <div className="guideline-item">
                <span className="guideline-icon">🚫</span>
                <div>
                  <h4>No Additional Applications</h4>
                  <p>Please do not submit multiple full membership applications</p>
                </div>
              </div>
              <div className="guideline-item">
                <span className="guideline-icon">📞</span>
                <div>
                  <h4>Contact Support if Needed</h4>
                  <p>Email support@ikoota.com with your ticket number for urgent matters</p>
                </div>
              </div>
            </div>
          </div>

          <div className="urgent-contact">
            <h3>🚨 Need Urgent Consideration?</h3>
            <div className="urgent-info">
              <p>
                If you have compelling reasons why your full membership application should be expedited, 
                you can contact our membership committee:
              </p>
              
              <div className="contact-details">
                <div className="contact-method">
                  <span className="contact-icon">📧</span>
                  <div>
                    <strong>Email:</strong> membership@ikoota.com
                    <br />
                    <strong>Subject:</strong> Urgent Full Membership Review - {membershipTicket}
                  </div>
                </div>
              </div>
              <p className="urgent-note">
                <strong>Please include:</strong> Your membership ticket number and specific, compelling reasons 
                why expedited review is necessary for your educational goals or professional requirements.
              </p>
            </div>
          </div>

          <div className="action-buttons">
            <button 
              onClick={() => navigate('/towncrier')} 
              className="btn-primary"
            >
              📚 Continue Browsing Content
            </button>
            
            <button 
              onClick={() => navigate('/full-membership-info')} 
              className="btn-secondary"
            >
              📊 Check Application Status
            </button>
            
            <button 
              onClick={() => navigate('/')} 
              className="btn-secondary"
            >
              🏠 Return to Home
            </button>
          </div>

          <div className="final-note">
            <div className="note-content">
              <h4>📝 Important Reminders</h4>
              <ul>
                <li>Keep your membership ticket number ({membershipTicket}) safe</li>
                <li>Check your email regularly for review updates</li>
                <li>Continue engaging with pre-member content during review</li>
                <li>Do not submit duplicate applications</li>
                <li>Contact support only for urgent matters</li>
              </ul>
            </div>
          </div>
        </div>

        <div className="submitted-footer">
          <p>
            Thank you for your commitment to becoming a full member of the Ikoota educational community. 
            We appreciate your patience during our thorough review process.
          </p>
        </div>
      </div>
    </div>
  );
};

export default FullMembershipSubmitted;

//========================================


//ikootaclient\src\components\membership\FullMembershipStatus.jsx
import './fullMembershipStatus.css';
import React from 'react';  
import { useNavigate } from 'react-router-dom';
import { useMembershipStatus } from '../../hooks/useMembershipStatus';

const FullMembershipStatus = () => {
  const navigate = useNavigate();
  const { isFullMember, isLoading } = useMembershipStatus();

  if (isLoading) {
    return <div>Loading...</div>;
  }

  if (!isFullMember) {
    return (
      <div>
        <h2>Membership Required</h2>
        <p>You need a full membership to access this content.</p>
        <button onClick={() => navigate('/upgrade')}>Upgrade Membership</button>
      </div>
    );
  }

  return (
    <div>
      <h2>Full Membership Status</h2>
      <p>Congratulations! You have full access to all features.</p>
    </div>
  );
};

export default FullMembershipStatus;

//========================================


// ===============================================
// ikootaclient/src/components/membership/FullMembershipPending.jsx
// ===============================================
import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useUser } from '../auth/UserStatus';
import api from '../service/api';
import './fullMembershipStatus.css';

const FullMembershipPending = () => {
  const navigate = useNavigate();
  const { user, refreshUser } = useUser();
  const [applicationData, setApplicationData] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchApplicationStatus();
  }, []);

  const fetchApplicationStatus = async () => {
    try {
      const response = await api.get(`/membership/full-membership-status/${user?.user_id}`);
      setApplicationData(response.data);
    } catch (error) {
      console.error('Error fetching application status:', error);
    } finally {
      setLoading(false);
    }
  };

  const getTimeAgo = (dateString) => {
    const date = new Date(dateString);
    const now = new Date();
    const diffTime = Math.abs(now - date);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 1) return '1 day ago';
    if (diffDays < 7) return `${diffDays} days ago`;
    if (diffDays < 30) return `${Math.ceil(diffDays / 7)} weeks ago`;
    return `${Math.ceil(diffDays / 30)} months ago`;
  };

  if (loading) {
    return (
      <div className="full-membership-status-container">
        <div className="status-card loading">
          <div className="loading-spinner"></div>
          <p>Loading application status...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="full-membership-status-container">
      <div className="status-card pending">
        <div className="status-header">
          <div className="pending-icon">⏳</div>
          <h1>Application Under Review</h1>
          <h2>Your Full Membership Application is Being Processed</h2>
        </div>

        <div className="status-content">
          <div className="application-summary">
            <div className="summary-grid">
              <div className="summary-item">
                <strong>Applicant:</strong> {user?.username}
              </div>
              <div className="summary-item">
                <strong>Email:</strong> {user?.email}
              </div>
              {applicationData?.ticket && (
                <div className="summary-item">
                  <strong>Application Ticket:</strong> 
                  <span className="ticket-number">{applicationData.ticket}</span>
                </div>
              )}
              <div className="summary-item">
                <strong>Current Status:</strong> 
                <span className="status-badge pending">Under Review</span>
              </div>
              {applicationData?.submittedAt && (
                <div className="summary-item">
                  <strong>Submitted:</strong> 
                  {new Date(applicationData.submittedAt).toLocaleDateString()} 
                  <small>({getTimeAgo(applicationData.submittedAt)})</small>
                </div>
              )}
            </div>
          </div>

          <div className="review-timeline">
            <h3>📋 Review Process Timeline</h3>
            <div className="timeline">
              <div className="timeline-item completed">
                <div className="timeline-icon">✅</div>
                <div className="timeline-content">
                  <h4>Application Submitted</h4>
                  <p>Your application has been received and is in our review queue</p>
                  {applicationData?.submittedAt && (
                    <small>{new Date(applicationData.submittedAt).toLocaleDateString()}</small>
                  )}
                </div>
              </div>
              
              <div className="timeline-item active">
                <div className="timeline-icon">🔍</div>
                <div className="timeline-content">
                  <h4>Admin Review</h4>
                  <p>Our team is carefully reviewing your application and responses</p>
                  <small>Typical review time: 3-5 business days</small>
                </div>
              </div>
              
              <div className="timeline-item pending">
                <div className="timeline-icon">📧</div>
                <div className="timeline-content">
                  <h4>Decision Notification</h4>
                  <p>You'll receive an email with the decision and next steps</p>
                  <small>Notification will be sent to {user?.email}</small>
                </div>
              </div>
            </div>
          </div>

          <div className="while-you-wait">
            <h3>⏰ While You Wait</h3>
            <div className="activities-grid">
              <div className="activity-card">
                <div className="activity-icon">📚</div>
                <h4>Continue Learning</h4>
                <p>Access Towncrier content and stay engaged with the community</p>
                <button 
                  onClick={() => navigate('/towncrier')}
                  className="btn-secondary small"
                >
                  Browse Content
                </button>
              </div>
              
              <div className="activity-card">
                <div className="activity-icon">👤</div>
                <h4>Update Profile</h4>
                <p>Enhance your profile while waiting for the review</p>
                <button 
                  onClick={() => navigate('/profile')}
                  className="btn-secondary small"
                >
                  Edit Profile
                </button>
              </div>
              
              <div className="activity-card">
                <div className="activity-icon">❓</div>
                <h4>Have Questions?</h4>
                <p>Contact our support team if you need assistance</p>
                <button 
                  onClick={() => window.location.href = 'mailto:support@ikoota.com'}
                  className="btn-secondary small"
                >
                  Contact Support
                </button>
              </div>
            </div>
          </div>

          <div className="important-notes">
            <h4>📌 Important Notes</h4>
            <ul>
              <li>Please do not submit multiple applications - this may delay processing</li>
              <li>Check your email regularly for updates on your application status</li>
              <li>You can continue accessing all pre-member features while under review</li>
              <li>The review process is thorough to ensure the best community experience</li>
            </ul>
          </div>
        </div>

        <div className="status-actions">
          <button 
            onClick={() => navigate('/dashboard')}
            className="btn-primary"
          >
            📊 Go to Dashboard
          </button>
          
          <button 
            onClick={() => navigate('/towncrier')}
            className="btn-secondary"
          >
            📚 Continue Learning
          </button>
          
          <button 
            onClick={fetchApplicationStatus}
            className="btn-secondary"
          >
            🔄 Refresh Status
          </button>
        </div>
      </div>
    </div>
  );
};

export default FullMembershipPending;


//=====================================


// ikootaclient/src/components/membership/FullMembershipInfo.jsx
import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useUser } from '../auth/UserStatus';
import api from '../service/api';
import './fullMembershipInfo.css';

const FullMembershipInfo = () => {
  const navigate = useNavigate();
  const { user, isAuthenticated } = useUser();
  const [hasAccessedBefore, setHasAccessedBefore] = useState(false);
  const [hasSubmittedApplication, setHasSubmittedApplication] = useState(false);
  const [applicationStatus, setApplicationStatus] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!isAuthenticated) {
      alert('Please sign in first to access membership applications.');
      navigate('/login');
      return;
    }

    // Check if user is eligible for full membership application
    checkMembershipEligibility();
  }, [isAuthenticated, navigate]);

  const checkMembershipEligibility = async () => {
    try {
      const response = await api.get('/membership/full-membership-status');
      const { hasAccessed, hasSubmitted, status, isPreMember } = response.data;
      
      if (!isPreMember) {
        alert('You must be a pre-member first before applying for full membership.');
        navigate('/towncrier');
        return;
      }

      setHasAccessedBefore(hasAccessed);
      setHasSubmittedApplication(hasSubmitted);
      setApplicationStatus(status);

      // Log first-time access
      if (!hasAccessed) {
        await api.post('/membership/log-full-membership-access');
      }
    } catch (error) {
      console.error('Error checking membership status:', error);
      alert('Error checking your membership status. Please try again.');
      navigate('/towncrier');
    } finally {
      setLoading(false);
    }
  };

  const handleProceedToSurvey = () => {
    navigate('/full-membership-survey');
  };

  const handleGoBack = () => {
    navigate('/towncrier');
  };

  if (loading) {
    return (
      <div className="membership-info-container">
        <div className="loading-message">
          <p>Loading membership information...</p>
        </div>
      </div>
    );
  }

  // If user has already submitted application
  if (hasSubmittedApplication) {
    return (
      <div className="membership-info-container">
        <div className="membership-card submitted-state">
          <div className="membership-header">
            <h1>📋 Full Membership Application Status</h1>
          </div>

          <div className="status-display">
            <div className={`status-badge ${applicationStatus}`}>
              {applicationStatus === 'pending' && '⏳ Under Review'}
              {applicationStatus === 'suspended' && '⚠️ Additional Info Required'}
              {applicationStatus === 'approved' && '✅ Approved'}
              {applicationStatus === 'declined' && '❌ Declined'}
            </div>
          </div>

          <div className="status-content">
            {applicationStatus === 'pending' && (
              <div className="pending-info">
                <h3>Your Application is Under Review</h3>
                <p>Our team is currently reviewing your full membership application. You'll receive an email notification once the review is complete.</p>
                <div className="timeline">
                  <div className="timeline-item completed">✅ Application Submitted</div>
                  <div className="timeline-item current">🔍 Under Review</div>
                  <div className="timeline-item future">📧 Decision Notification</div>
                </div>
              </div>
            )}

            {applicationStatus === 'suspended' && (
              <div className="suspended-info">
                <h3>Additional Information Required</h3>
                <p>Your application has been temporarily suspended pending additional information. Please check your email for specific requirements.</p>
                <button onClick={() => navigate('/full-membership-suspended')} className="btn-primary">
                  View Requirements
                </button>
              </div>
            )}

            {applicationStatus === 'approved' && (
              <div className="approved-info">
                <h3>🎉 Congratulations! You're Now a Full Member</h3>
                <p>Your full membership has been approved. You now have access to all platform features including the Iko chat system.</p>
                <button onClick={() => navigate('/iko')} className="btn-primary">
                  Access Iko Chat System
                </button>
              </div>
            )}

            {applicationStatus === 'declined' && (
              <div className="declined-info">
                <h3>Application Not Approved</h3>
                <p>Your full membership application was not approved at this time. Please check your email for feedback and reapplication guidelines.</p>
                <button onClick={() => navigate('/full-membership-declined')} className="btn-secondary">
                  View Feedback
                </button>
              </div>
            )}
          </div>

          <div className="back-action">
            <button onClick={handleGoBack} className="btn-back">
              ← Back to Towncrier
            </button>
          </div>
        </div>
      </div>
    );
  }

  // Main membership information page
  return (
    <div className="membership-info-container">
      <div className="membership-card">
        <div className="membership-header">
          <h1>🎓 Full Membership Application</h1>
          <h2>Join the Complete Ikoota Community</h2>
        </div>

        <div className="welcome-message">
          <p>
            <strong>Welcome, {user?.username}!</strong>
          </p>
          <p>
            As a pre-member, you've already experienced our educational content in Towncrier. 
            Now you can apply for full membership to unlock the complete Ikoota experience.
          </p>
        </div>

        <div className="membership-benefits">
          <h3>🌟 Full Membership Benefits</h3>
          <div className="benefits-grid">
            <div className="benefit-item">
              <span className="benefit-icon">💬</span>
              <div className="benefit-content">
                <h4>Iko Chat System Access</h4>
                <p>Join exclusive member discussions and real-time conversations</p>
              </div>
            </div>
            <div className="benefit-item">
              <span className="benefit-icon">💭</span>
              <div className="benefit-content">
                <h4>Comment & Engage</h4>
                <p>Participate in discussions on educational content and posts</p>
              </div>
            </div>
            <div className="benefit-item">
              <span className="benefit-icon">✍️</span>
              <div className="benefit-content">
                <h4>Create & Share</h4>
                <p>Contribute your own educational content and teaching materials</p>
              </div>
            </div>
            <div className="benefit-item">
              <span className="benefit-icon">🤝</span>
              <div className="benefit-content">
                <h4>Community Collaboration</h4>
                <p>Work directly with other educators and learners</p>
              </div>
            </div>
            <div className="benefit-item">
              <span className="benefit-icon">📚</span>
              <div className="benefit-content">
                <h4>Advanced Resources</h4>
                <p>Access member-only educational materials and tools</p>
              </div>
            </div>
            <div className="benefit-item">
              <span className="benefit-icon">🎯</span>
              <div className="benefit-content">
                <h4>Personalized Learning</h4>
                <p>Customized content recommendations and learning paths</p>
              </div>
            </div>
          </div>
        </div>

        <div className="membership-expectations">
          <h3>📋 Membership Expectations</h3>
          <div className="expectations-content">
            <div className="expectation-section">
              <h4>🎯 Our Mission</h4>
              <p>
                Ikoota is dedicated to creating a high-quality educational community where 
                verified educators and serious learners collaborate to advance education 
                through innovative teaching methods and meaningful discussions.
              </p>
            </div>
            
            <div className="expectation-section">
              <h4>🌟 Community Values</h4>
              <ul>
                <li><strong>Excellence:</strong> Commitment to high-quality educational content</li>
                <li><strong>Respect:</strong> Treating all community members with dignity</li>
                <li><strong>Collaboration:</strong> Working together for mutual growth</li>
                <li><strong>Innovation:</strong> Embracing new educational technologies and methods</li>
                <li><strong>Integrity:</strong> Honest and ethical participation in all activities</li>
              </ul>
            </div>

            <div className="expectation-section">
              <h4>👥 Member Responsibilities</h4>
              <ul>
                <li>Contribute meaningfully to discussions and content</li>
                <li>Maintain professional and respectful communication</li>
                <li>Share knowledge and expertise with the community</li>
                <li>Follow community guidelines and platform rules</li>
                <li>Support fellow members' learning and growth</li>
              </ul>
            </div>
          </div>
        </div>

        <div className="platform-overview">
          <h3>🏛️ About Our Educational Platform</h3>
          <div className="platform-content">
            <div className="platform-section">
              <h4>📚 Educational Focus</h4>
              <p>
                Our platform serves as a comprehensive educational ecosystem where 
                teachers, students, researchers, and lifelong learners come together 
                to share knowledge, collaborate on projects, and advance the field of education.
              </p>
            </div>

            <div className="platform-section">
              <h4>💬 Chat & Discussion System</h4>
              <p>
                The Iko chat system facilitates real-time collaboration, allowing members 
                to engage in focused educational discussions, share resources instantly, 
                and build lasting professional relationships.
              </p>
            </div>

            <div className="platform-section">
              <h4>🔐 Quality Assurance</h4>
              <p>
                Our two-stage membership process ensures that all full members are 
                committed to maintaining the high standards of educational discourse 
                and collaborative learning that define our community.
              </p>
            </div>
          </div>
        </div>

        <div className="application-process">
          <h3>📝 Application Process Overview</h3>
          <div className="process-steps">
            <div className="process-step">
              <span className="step-number">1</span>
              <div className="step-content">
                <h4>Complete Membership Survey</h4>
                <p>Answer detailed questions about your educational background and goals</p>
              </div>
            </div>
            <div className="process-step">
              <span className="step-number">2</span>
              <div className="step-content">
                <h4>Application Review</h4>
                <p>Our team evaluates your responses and commitment to education</p>
              </div>
            </div>
            <div className="process-step">
              <span className="step-number">3</span>
              <div className="step-content">
                <h4>Decision & Access</h4>
                <p>Receive notification and gain full platform access upon approval</p>
              </div>
            </div>
          </div>
        </div>

        <div className="important-notes">
          <h3>⚠️ Important Information</h3>
          <div className="notes-list">
            <div className="note-item">
              <span className="note-icon">📋</span>
              <div>
                <h4>Application Requirements</h4>
                <p>All questions in the membership survey must be answered thoroughly and honestly.</p>
              </div>
            </div>
            <div className="note-item">
              <span className="note-icon">⏰</span>
              <div>
                <h4>Review Timeline</h4>
                <p>Full membership applications typically take 5-7 business days to review.</p>
              </div>
            </div>
            <div className="note-item">
              <span className="note-icon">🔄</span>
              <div>
                <h4>One Application Only</h4>
                <p>You may only submit one full membership application. Make it count!</p>
              </div>
            </div>
          </div>
        </div>

        <div className="action-buttons">
          <button 
            onClick={handleProceedToSurvey} 
            className="btn-primary application-btn"
          >
            📝 Begin Full Membership Application
          </button>
          
          <button 
            onClick={handleGoBack} 
            className="btn-secondary"
          >
            ← Back to Towncrier
          </button>
        </div>

        <div className="first-access-note">
          {!hasAccessedBefore && (
            <div className="access-logged">
              <p>
                📊 <strong>Note:</strong> Your access to this membership information page has been 
                logged for record-keeping purposes.
              </p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default FullMembershipInfo;


//=======================================

// ikootaclient/src/components/membership/FullMembershipDeclined.jsx
import React from 'react';
import { useNavigate } from 'react-router-dom';
import { useUser } from '../auth/UserStatus';
import './fullMembershipDeclined.css';

const FullMembershipDeclined = () => {
  const navigate = useNavigate();
  const { user } = useUser();

  return (
    <div className="membership-declined-container">
      <div className="declined-card">
        <div className="declined-header">
          <div className="declined-icon">📋</div>
          <h1>Full Membership Application Decision</h1>
          <h2>Application Not Approved</h2>
        </div>

        <div className="declined-content">
          <div className="decision-message">
            <p>
              <strong>Dear {user?.username || 'Applicant'},</strong>
            </p>
            <p>
              After careful review by our membership committee, we regret to inform you that 
              your full membership application has not been approved at this time.
            </p>
          </div>

          <div className="feedback-section">
            <h3>📧 Detailed Feedback</h3>
            <div className="email-notice">
              <p>
                We have sent detailed feedback to your email address ({user?.email}) 
                explaining the specific reasons for this decision and providing guidance 
                for future applications.
              </p>
              <button 
                onClick={() => window.open(`mailto:${user?.email}`)} 
                className="check-email-btn"
              >
                📧 Check Your Email
              </button>
            </div>
          </div>

          <div className="reapplication-info">
            <h3>🔄 Future Application Opportunities</h3>
            <div className="reapplication-content">
              <p>
                This decision does not permanently exclude you from full membership. 
                You may reapply in the future when you have addressed the areas highlighted in our feedback.
              </p>
              
              <div className="reapplication-timeline">
                <h4>📅 Reapplication Guidelines:</h4>
                <ul>
                  <li>Wait at least 90 days before submitting a new application</li>
                  <li>Address all concerns mentioned in our feedback email</li>
                  <li>Demonstrate growth in the areas we've identified</li>
                  <li>Continue engaging as a pre-member to show commitment</li>
                </ul>
              </div>
            </div>
          </div>

          <div className="current-status">
            <h3>📚 Your Current Access</h3>
            <div className="status-info">
              <div className="status-item">
                <span className="status-icon">🌟</span>
                <div>
                  <h4>Pre-Member Status Maintained</h4>
                  <p>You retain your current pre-member access to Towncrier educational content</p>
                </div>
              </div>
              <div className="access-details">
                <h4>✅ You Can Continue To:</h4>
                <ul>
                  <li>Browse all public educational content</li>
                  <li>Read community posts and resources</li>
                  <li>Learn from teaching materials</li>
                  <li>Prepare for future full membership application</li>
                </ul>
              </div>
            </div>
          </div>

          <div className="improvement-suggestions">
            <h3>💡 General Improvement Areas</h3>
            <div className="suggestions-grid">
              <div className="suggestion-item">
                <span className="suggestion-icon">📖</span>
                <div>
                  <h4>Deepen Educational Expertise</h4>
                  <p>Continue developing your knowledge in your field of interest</p>
                </div>
              </div>
              <div className="suggestion-item">
                <span className="suggestion-icon">🤝</span>
                <div>
                  <h4>Community Engagement</h4>
                  <p>Show commitment to collaborative learning principles</p>
                </div>
              </div>
              <div className="suggestion-item">
                <span className="suggestion-icon">💬</span>
                <div>
                  <h4>Communication Skills</h4>
                  <p>Develop clear, professional communication abilities</p>
                </div>
              </div>
              <div className="suggestion-item">
                <span className="suggestion-icon">🎯</span>
                <div>
                  <h4>Clear Contribution Plan</h4>
                  <p>Articulate specific ways you'll contribute to the community</p>
                </div>
              </div>
            </div>
          </div>

          <div className="support-contact">
            <h3>❓ Questions About This Decision?</h3>
            <div className="contact-info">
              <p>
                If you have questions about this decision or need clarification about the feedback, 
                you may contact our membership committee:
              </p>
              <div className="contact-method">
                <span className="contact-icon">📧</span>
                <div>
                  <strong>Email:</strong> membership@ikoota.com
                  <br />
                  <strong>Subject:</strong> Question About Full Membership Decision
                </div>
              </div>
              <p className="contact-note">
                Please reference your membership ticket number in any correspondence.
              </p>
            </div>
          </div>

          <div className="action-buttons">
            <button 
              onClick={() => navigate('/towncrier')} 
              className="btn-primary"
            >
              📚 Continue as Pre-Member
            </button>
            
            <button 
              onClick={() => window.open(`mailto:${user?.email}`)} 
              className="btn-secondary"
            >
              📧 Check Email for Details
            </button>
            
            <button 
              onClick={() => navigate('/')} 
              className="btn-secondary"
            >
              🏠 Return to Home
            </button>
          </div>
        </div>

        <div className="declined-footer">
          <p>
            We encourage you to continue your educational journey with us as a pre-member 
            and look forward to potentially welcoming you as a full member in the future.
          </p>
        </div>
      </div>
    </div>
  );
};

export default FullMembershipDeclined;

//========================================

// ===============================================
// ikootaclient/src/components/membership/FullMembershipApproved.jsx
// ===============================================
import React, { useEffect } from 'react';
import { useNavigate, useLocation } from 'react-router-dom';
import { useUser } from '../auth/UserStatus';
import './fullMembershipStatus.css';

const FullMembershipApproved = () => {
  const navigate = useNavigate();
  const location = useLocation();
  const { user, refreshUser } = useUser();
  
  const membershipTicket = location.state?.membershipTicket || user?.fullMembershipTicket;
  const username = user?.username;

  useEffect(() => {
    // Refresh user status to get latest membership data
    refreshUser();
  }, [refreshUser]);

  return (
    <div className="full-membership-status-container">
      <div className="status-card approved">
        <div className="status-header">
          <div className="success-icon">🎉</div>
          <h1>Congratulations!</h1>
          <h2>Your Full Membership Application Has Been Approved</h2>
        </div>

        <div className="status-content">
          <div className="approval-details">
            <div className="detail-item">
              <strong>Applicant:</strong> {username}
            </div>
            {membershipTicket && (
              <div className="detail-item">
                <strong>Application Ticket:</strong> 
                <span className="ticket-number">{membershipTicket}</span>
              </div>
            )}
            <div className="detail-item">
              <strong>New Status:</strong> 
              <span className="status-badge success">Full Member</span>
            </div>
            <div className="detail-item">
              <strong>Effective Date:</strong> {new Date().toLocaleDateString()}
            </div>
          </div>

          <div className="membership-benefits">
            <h3>🎊 Your New Full Member Benefits:</h3>
            <ul className="benefits-list">
              <li>✅ <strong>Iko Chat Access:</strong> Participate in our exclusive member chat platform</li>
              <li>✅ <strong>Advanced Content:</strong> Access to premium educational materials</li>
              <li>✅ <strong>Direct Mentorship:</strong> Connect with experienced mentors</li>
              <li>✅ <strong>Community Projects:</strong> Collaborate on member-only initiatives</li>
              <li>✅ <strong>Priority Support:</strong> Faster response times for assistance</li>
              <li>✅ <strong>Networking Events:</strong> Invitations to exclusive member gatherings</li>
            </ul>
          </div>

          <div className="next-steps">
            <h3>🚀 What's Next?</h3>
            <div className="steps-grid">
              <div className="step-card">
                <div className="step-icon">💬</div>
                <h4>Start Chatting</h4>
                <p>Jump into Iko Chat and introduce yourself to the community</p>
                <button 
                  onClick={() => navigate('/iko')}
                  className="btn-primary"
                >
                  Access Iko Chat
                </button>
              </div>
              
              <div className="step-card">
                <div className="step-icon">👤</div>
                <h4>Complete Profile</h4>
                <p>Update your profile with your interests and expertise</p>
                <button 
                  onClick={() => navigate('/profile')}
                  className="btn-secondary"
                >
                  Edit Profile
                </button>
              </div>
              
              <div className="step-card">
                <div className="step-icon">📚</div>
                <h4>Explore Content</h4>
                <p>Access advanced educational materials and resources</p>
                <button 
                  onClick={() => navigate('/towncrier')}
                  className="btn-secondary"
                >
                  Browse Content
                </button>
              </div>
            </div>
          </div>

          <div className="support-info">
            <h4>📞 Need Help?</h4>
            <p>If you have any questions about your new membership benefits, please contact our support team:</p>
            <div className="contact-options">
              <span>📧 support@ikoota.com</span>
              <span>💬 Use the help chat in your dashboard</span>
            </div>
          </div>
        </div>

        <div className="status-actions">
          <button 
            onClick={() => navigate('/iko')}
            className="btn-primary large"
          >
            🚀 Start Your Full Member Journey
          </button>
          
          <button 
            onClick={() => navigate('/dashboard')}
            className="btn-secondary"
          >
            📊 Go to Dashboard
          </button>
        </div>
      </div>
    </div>
  );
};

export default FullMembershipApproved;








//==========================================
//info FOLDER
//==========================================


//ikootaclient\src\components\info\Thankyou.jsx
import React from 'react'

const Thankyou = () => {
  return (
    <div>Thankyou for applying for chatting membership in this training!</div>
  )
}

export default Thankyou

//================================


// ikootaclient/src/components/info/Suspendedverifyinfo.jsx
import React from 'react';
import { useNavigate } from 'react-router-dom';
import { useUser } from '../auth/UserStatus';
import './suspendedverifyinfo.css';

const Suspendedverifyinfo = () => {
  const navigate = useNavigate();
  const { user } = useUser();

  return (
    <div className="suspended-verify-container">
      <div className="suspended-card">
        <div className="suspended-header">
          <div className="suspended-icon">⚠️</div>
          <h1>Application Suspended</h1>
          <h2>Additional Information Required</h2>
        </div>

        <div className="suspended-content">
          <div className="status-message">
            <p>
              <strong>Hello {user?.username || 'Applicant'},</strong>
            </p>
            <p>
              Your application review has been temporarily suspended. This typically means 
              we need additional information or clarification before proceeding.
            </p>
          </div>

          <div className="suspension-reasons">
            <h3>🔍 Common Reasons for Suspension</h3>
            <div className="reasons-list">
              <div className="reason-item">
                <span className="reason-icon">📝</span>
                <div>
                  <h4>Incomplete Information</h4>
                  <p>Some survey responses may need more detail</p>
                </div>
              </div>
              <div className="reason-item">
                <span className="reason-icon">❓</span>
                <div>
                  <h4>Clarification Needed</h4>
                  <p>Certain answers require additional explanation</p>
                </div>
              </div>
              <div className="reason-item">
                <span className="reason-icon">📋</span>
                <div>
                  <h4>Additional Documentation</h4>
                  <p>Supporting documents may be required</p>
                </div>
              </div>
            </div>
          </div>

          <div className="next-actions">
            <h3>📧 Check Your Email</h3>
            <div className="email-instructions">
              <p>
                We have sent detailed instructions to <strong>{user?.email}</strong> 
                explaining what additional information is needed.
              </p>
              <div className="email-checklist">
                <h4>📋 Please Check:</h4>
                <ul>
                  <li>Your inbox for our latest email</li>
                  <li>Spam/junk folder (emails might be filtered)</li>
                  <li>Promotions tab (if using Gmail)</li>
                </ul>
              </div>
            </div>
          </div>

          <div className="resolution-steps">
            <h3>🔧 How to Resolve</h3>
            <div className="resolution-timeline">
              <div className="resolution-step">
                <span className="step-number">1</span>
                <div className="step-content">
                  <h4>Read Our Email Carefully</h4>
                  <p>Review the specific requirements mentioned</p>
                </div>
              </div>
              <div className="resolution-step">
                <span className="step-number">2</span>
                <div className="step-content">
                  <h4>Prepare Required Information</h4>
                  <p>Gather any additional documents or details</p>
                </div>
              </div>
              <div className="resolution-step">
                <span className="step-number">3</span>
                <div className="step-content">
                  <h4>Respond to Our Email</h4>
                  <p>Reply with the requested information</p>
                </div>
              </div>
              <div className="resolution-step">
                <span className="step-number">4</span>
                <div className="step-content">
                  <h4>Resume Review Process</h4>
                  <p>We'll continue evaluating your application</p>
                </div>
              </div>
            </div>
          </div>

          <div className="contact-support">
            <h3>❓ Need Help?</h3>
            <div className="support-options">
              <div className="support-option">
                <span className="support-icon">📧</span>
                <div>
                  <h4>Email Support</h4>
                  <p><strong>support@ikoota.com</strong></p>
                  <p>For questions about suspension requirements</p>
                </div>
              </div>
              <div className="support-option">
                <span className="support-icon">💬</span>
                <div>
                  <h4>Reply to Our Email</h4>
                  <p>Best method for application-specific questions</p>
                </div>
              </div>
            </div>
          </div>

          <div className="action-buttons">
            <button 
              onClick={() => window.open('mailto:' + user?.email)} 
              className="btn-primary"
            >
              📧 Check Email
            </button>
            
            <button 
              onClick={() => navigate('/towncrier')} 
              className="btn-secondary"
            >
              📚 Browse Content Meanwhile
            </button>
          </div>
        </div>

        <div className="suspended-footer">
          <p>
            <strong>Timeline:</strong> Most suspensions are resolved within 24-48 hours 
            after receiving the requested information.
          </p>
        </div>
      </div>
    </div>
  );
};

export default Suspendedverifyinfo;

//===========================================

// ikootaclient/src/components/info/SurveySubmitted.jsx
import React, { useState, useEffect } from 'react';
import { useNavigate, useLocation } from 'react-router-dom';
import { useUser } from '../auth/UserStatus';
import './surveySubmitted.css';

const SurveySubmitted = () => {
  const navigate = useNavigate();
  const location = useLocation();
  const { user } = useUser();
  const [applicationTicket, setApplicationTicket] = useState('');
  const [username, setUsername] = useState('');

  useEffect(() => {
    if (location.state) {
      setApplicationTicket(location.state.applicationTicket || '');
      setUsername(location.state.username || '');
    } else if (user) {
      setUsername(user.username || user.email || 'User');
    }
  }, [location.state, user]);

  const copyTicketToClipboard = () => {
    if (applicationTicket) {
      navigator.clipboard.writeText(applicationTicket);
      alert('Application ticket copied to clipboard!');
    }
  };

  return (
    <div className="survey-submitted-container">
      <div className="submitted-card">
        <div className="success-animation">
          <div className="checkmark">✓</div>
        </div>

        <div className="submitted-header">
          <h1>🎉 Survey Submitted Successfully!</h1>
          <h2>Thank you, {username}!</h2>
        </div>

        <div className="submitted-content">
          <div className="confirmation-message">
            <p>
              Your application survey has been submitted successfully and is now 
              <strong> pending review</strong> by our admissions team.
            </p>
          </div>

          {applicationTicket && (
            <div className="ticket-section">
              <h3>📋 Your Application Ticket</h3>
              <div className="ticket-display">
                <div className="ticket-number" onClick={copyTicketToClipboard}>
                  {applicationTicket}
                </div>
                <button onClick={copyTicketToClipboard} className="copy-btn">
                  📋 Copy
                </button>
              </div>
              <p className="ticket-note">
                <strong>Important:</strong> Save this ticket number! You'll need it for:
              </p>
              <ul className="ticket-uses">
                <li>Tracking your application status</li>
                <li>Any inquiries about your application</li>
                <li>Contacting support if needed</li>
              </ul>
            </div>
          )}

          <div className="timeline-section">
            <h3>📅 What Happens Next?</h3>
            <div className="timeline">
              <div className="timeline-item completed">
                <div className="timeline-marker">✅</div>
                <div className="timeline-content">
                  <h4>Survey Submitted</h4>
                  <p>Your application is now in our system</p>
                  <span className="timestamp">Just now</span>
                </div>
              </div>
              
              <div className="timeline-item pending">
                <div className="timeline-marker">⏳</div>
                <div className="timeline-content">
                  <h4>Under Review</h4>
                  <p>Our team will review your responses</p>
                  <span className="timestamp">3-5 business days</span>
                </div>
              </div>
              
              <div className="timeline-item future">
                <div className="timeline-marker">📧</div>
                <div className="timeline-content">
                  <h4>Decision Notification</h4>
                  <p>You'll receive an email with our decision</p>
                  <span className="timestamp">After review</span>
                </div>
              </div>
              
              <div className="timeline-item future">
                <div className="timeline-marker">🎓</div>
                <div className="timeline-content">
                  <h4>Platform Access</h4>
                  <p>If approved, access educational content</p>
                  <span className="timestamp">Upon approval</span>
                </div>
              </div>
            </div>
          </div>

          <div className="review-process">
            <h3>🔍 Review Process</h3>
            <div className="process-info">
              <div className="process-step">
                <h4>Pending Verification</h4>
                <p>Initial review of application completeness</p>
              </div>
              <div className="process-step">
                <h4>Suspended Verification</h4>
                <p>Additional information may be requested</p>
              </div>
              <div className="process-step">
                <h4>Approved-Verified</h4>
                <p>Welcome to the Ikoota community!</p>
              </div>
            </div>
          </div>

          <div className="waiting-period-info">
            <h3>⏰ During the Waiting Period</h3>
            <div className="waiting-actions">
              <div className="action-item">
                <span className="action-icon">📧</span>
                <div>
                  <h4>Check Your Email</h4>
                  <p>We'll send updates to {user?.email}</p>
                </div>
              </div>
              <div className="action-item">
                <span className="action-icon">🔍</span>
                <div>
                  <h4>Monitor Application Status</h4>
                  <p>Sign in periodically to check for updates</p>
                </div>
              </div>
              <div className="action-item">
                <span className="action-icon">📞</span>
                <div>
                  <h4>Contact Support if Urgent</h4>
                  <p>Email support@ikoota.com with your ticket number</p>
                </div>
              </div>
            </div>
          </div>

          <div className="access-restrictions">
            <h3>🚫 Current Access Level</h3>
            <div className="restriction-info">
              <p>
                <strong>During Review Period:</strong> Your account has limited access. 
                You cannot access the full platform until your application is approved.
              </p>
              <div className="access-levels">
                <div className="access-level denied">
                  <span className="access-icon">❌</span>
                  <span>Iko Chat System</span>
                </div>
                <div className="access-level denied">
                  <span className="access-icon">❌</span>
                  <span>Member Discussions</span>
                </div>
                <div className="access-level denied">
                  <span className="access-icon">❌</span>
                  <span>Content Creation</span>
                </div>
              </div>
            </div>
          </div>

          <div className="urgent-contact">
            <h3>🚨 Need Urgent Access?</h3>
            <div className="urgent-info">
              <p>
                If you feel there's an urgent need for your application to be prioritized, 
                you can contact our management team:
              </p>
              <div className="contact-details">
                <div className="contact-method">
                  <span className="contact-icon">📧</span>
                  <div>
                    <strong>Email:</strong> admin@ikoota.com
                    <br />
                    <strong>Subject:</strong> Urgent Application Review - {applicationTicket}
                  </div>
                </div>
                <div className="contact-method">
                  <span className="contact-icon">📱</span>
                  <div>
                    <strong>SMS:</strong> +1 (555) 123-4567
                    <br />
                    <strong>Include:</strong> Your application ticket number
                  </div>
                </div>
              </div>
              <p className="urgent-note">
                <strong>Please include:</strong> Your application ticket number and 
                a clear reason why urgent access is needed for platform participation.
              </p>
            </div>
          </div>

          <div className="action-buttons">
            <button 
              onClick={() => navigate('/towncrier')} 
              className="btn-primary"
            >
              📚 Browse Public Content
            </button>
            
            <button 
              onClick={() => navigate('/login')} 
              className="btn-secondary"
            >
              🔑 Sign In to Check Status
            </button>
            
            <button 
              onClick={() => navigate('/')} 
              className="btn-secondary"
            >
              🏠 Return to Home
            </button>
          </div>

          <div className="final-note">
            <div className="note-content">
              <h4>📝 Important Reminders</h4>
              <ul>
                <li>Keep your application ticket number safe</li>
                <li>Check your email regularly for updates</li>
                <li>Do not submit multiple applications</li>
                <li>Contact support only if urgent</li>
              </ul>
            </div>
          </div>
        </div>

        <div className="submitted-footer">
          <p>
            Thank you for your interest in joining the Ikoota educational community. 
            We appreciate your patience during the review process.
          </p>
        </div>
      </div>
    </div>
  );
};

export default SurveySubmitted;

//========================================

//ikootaclient\src\components\info\ReviewSurvey.jsx
import React from 'react'
import './reviewsurvey.css'

const ReviewSurvey = () => {
  return (
    <div>ReviewSurvey</div>
  )
}

export default ReviewSurvey

//==============================

// ikootaclient/src/components/info/Pendverifyinfo.jsx - SAFE VERSION WITH NO AUTO REDIRECTS
import React from 'react';
import { useNavigate } from 'react-router-dom';
import { useUser } from '../auth/UserStatus';
import './pendverifyinfo.css';

const Pendverifyinfo = () => {
  const navigate = useNavigate();
  const { user, membershipStatus, getUserStatus } = useUser();

  // ✅ Get actual survey completion status from API data
  const surveyCompleted = user?.survey_completed || membershipStatus?.survey_completed;
  const approvalStatus = user?.approval_status || membershipStatus?.approval_status;
  const needsSurvey = user?.needs_survey || membershipStatus?.needs_survey;
  const currentUserStatus = getUserStatus();

  console.log('📊 Pendverifyinfo Status Check:', {
    currentUserStatus,
    surveyCompleted,
    needsSurvey,
    approvalStatus,
    userMemberStatus: user?.is_member,
    membershipStage: user?.membership_stage
  });

  // ✅ COMPLETELY REMOVED useEffect WITH AUTOMATIC REDIRECT
  // No more automatic redirects that cause loops
  // Users must manually choose to complete the survey

  return (
    <div className="pending-verify-container">
      <div className="pending-card">
        <div className="pending-header">
          <div className="pending-icon">⏳</div>
          <h1>Application Under Review</h1>
          <h2>Pending Verification</h2>
        </div>

        <div className="pending-content">
          <div className="status-message">
            <p>
              <strong>Hello {user?.username || 'Applicant'},</strong>
            </p>
            <p>
              Your application and survey responses are currently being reviewed by our admissions team. 
              We appreciate your patience during this process.
            </p>
          </div>

          <div className="review-status">
            <h3>📊 Current Status: <span className="status-badge pending">Pending Review</span></h3>
            <div className="status-details">
              <div className="detail-item">
                <span className="detail-label">Application Submitted:</span>
                <span className="detail-value">✅ Complete</span>
              </div>
              <div className="detail-item">
                <span className="detail-label">Survey Completed:</span>
                <span className="detail-value">
                  {surveyCompleted ? '✅ Complete' : '⏳ In Progress'}
                </span>
              </div>
              <div className="detail-item">
                <span className="detail-label">Review Status:</span>
                <span className="detail-value">
                  {approvalStatus === 'pending' ? '⏳ In Progress' : '🔍 Under Review'}
                </span>
              </div>
              <div className="detail-item">
                <span className="detail-label">Expected Timeline:</span>
                <span className="detail-value">3-5 Business Days</span>
              </div>
            </div>
          </div>

          <div className="access-restrictions">
            <h3>🚫 Current Access Limitations</h3>
            <p>
              While your application is pending, you have limited access to the platform:
            </p>
            <div className="restrictions-list">
              <div className="restriction-item denied">
                <span className="restriction-icon">❌</span>
                <span>Iko Chat System Access</span>
              </div>
              <div className="restriction-item denied">
                <span className="restriction-icon">❌</span>
                <span>Member Discussions</span>
              </div>
              <div className="restriction-item denied">
                <span className="restriction-icon">❌</span>
                <span>Content Creation & Posting</span>
              </div>
              <div className="restriction-item allowed">
                <span className="restriction-icon">✅</span>
                <span>Browse Public Educational Content</span>
              </div>
              <div className="restriction-item allowed">
                <span className="restriction-icon">✅</span>
                <span>Access Landing Page & Public Information</span>
              </div>
            </div>
          </div>

          {/* ✅ Show survey completion section if not completed - MANUAL NAVIGATION ONLY */}
          {!surveyCompleted && needsSurvey && (
            <div className="incomplete-survey" style={{
              background: '#fff3cd',
              border: '1px solid #ffeaa7',
              borderRadius: '8px',
              padding: '20px',
              margin: '20px 0'
            }}>
              <h3 style={{ color: '#856404', marginTop: '0' }}>📋 Complete Your Application Survey</h3>
              <p style={{ color: '#856404' }}>
                <strong>Action Required:</strong> Your application survey is not yet complete. 
                To expedite your review process and move forward, please complete your application survey.
              </p>
              <button 
                onClick={() => {
                  console.log('🔄 Manual navigation to application survey');
                  navigate('/applicationsurvey');
                }} 
                className="btn-primary"
                style={{ 
                  marginBottom: '10px',
                  background: '#dc3545',
                  color: 'white',
                  border: 'none',
                  padding: '12px 24px',
                  borderRadius: '6px',
                  fontWeight: 'bold',
                  cursor: 'pointer',
                  fontSize: '16px'
                }}
              >
                📝 Complete Application Survey Now
              </button>
              <p style={{ fontSize: '14px', color: '#856404', margin: '10px 0 0 0', fontWeight: 'bold' }}>
                <strong>Important:</strong> Your application cannot proceed without completing the survey.
              </p>
            </div>
          )}

          {/* ✅ Show different message if survey is completed */}
          {surveyCompleted && (
            <div className="survey-completed" style={{
              background: '#d4edda',
              border: '1px solid #c3e6cb',
              borderRadius: '8px',
              padding: '20px',
              margin: '20px 0'
            }}>
              <h3 style={{ color: '#155724', marginTop: '0' }}>✅ Survey Completed</h3>
              <p style={{ color: '#155724' }}>
                <strong>Great!</strong> Your application survey has been completed and submitted. 
                Your application is now under review by our admissions team.
              </p>
            </div>
          )}

          <div className="urgent-access">
            <h3>🚨 Need Urgent Access?</h3>
            <div className="urgent-content">
              <p>
                If you believe there's an urgent need for your application to be prioritized 
                for platform participation, you can contact our management team:
              </p>
              
              <div className="contact-methods">
                <div className="contact-method">
                  <div className="method-header">
                    <span className="method-icon">📧</span>
                    <strong>Email Support</strong>
                  </div>
                  <div className="method-details">
                    <p><strong>Address:</strong> admin@ikoota.com</p>
                    <p><strong>Subject:</strong> Urgent Application Review Request</p>
                  </div>
                </div>
                
                <div className="contact-method">
                  <div className="method-header">
                    <span className="method-icon">📱</span>
                    <strong>SMS/WhatsApp</strong>
                  </div>
                  <div className="method-details">
                    <p><strong>Number:</strong> +1 (555) 123-4567</p>
                    <p><strong>Hours:</strong> 9 AM - 5 PM EST</p>
                  </div>
                </div>
              </div>

              <div className="urgent-requirements">
                <h4>📋 Include in Your Message:</h4>
                <ul>
                  <li>Your full name and username</li>
                  <li>Email address used for registration</li>
                  <li>Application ticket number (if available)</li>
                  <li>Clear reason for urgency</li>
                  <li>Specific need for platform participation</li>
                </ul>
              </div>
            </div>
          </div>

          <div className="next-steps">
            <h3>⏭️ What to Expect</h3>
            <div className="steps-timeline">
              <div className="step completed">
                <span className="step-icon">✅</span>
                <div className="step-content">
                  <h4>Application Received</h4>
                  <p>Your registration is in our system</p>
                </div>
              </div>
              <div className={`step ${surveyCompleted ? 'completed' : 'current'}`}>
                <span className="step-icon">{surveyCompleted ? '✅' : '📝'}</span>
                <div className="step-content">
                  <h4>Survey Completion</h4>
                  <p>{surveyCompleted ? 'Survey responses submitted' : 'Complete your application survey'}</p>
                </div>
              </div>
              <div className={`step ${surveyCompleted ? 'current' : 'future'}`}>
                <span className="step-icon">🔍</span>
                <div className="step-content">
                  <h4>Under Review</h4>
                  <p>Team is evaluating your application</p>
                </div>
              </div>
              <div className="step future">
                <span className="step-icon">📧</span>
                <div className="step-content">
                  <h4>Decision Notification</h4>
                  <p>Email notification with final decision</p>
                </div>
              </div>
            </div>
          </div>

          <div className="action-buttons">
            <button 
              onClick={() => navigate('/dashboard')} 
              className="btn-primary"
            >
              📊 My Dashboard
            </button>
            
            <button 
              onClick={() => navigate('/')} 
              className="btn-secondary"
            >
              🏠 Return to Home
            </button>
          </div>
        </div>

        <div className="pending-footer">
          <p>
            <strong>Important:</strong> Attempting to create multiple accounts or 
            resubmit applications will not expedite the review process.
          </p>
          <p>
            <strong>Note:</strong> You can return to the home page at any time to learn more about our platform 
            while waiting for your application review.
          </p>
        </div>
      </div>
    </div>
  );
};

export default Pendverifyinfo;

//=====================================


// ikootaclient/src/components/info/Approveverifyinfo.jsx
import React, { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { useUser } from '../auth/UserStatus';
import './approveverifyinfo.css';

const Approveverifyinfo = () => {
  const navigate = useNavigate();
  const { user } = useUser();
  const [showConfetti, setShowConfetti] = useState(false);

  useEffect(() => {
    // Trigger celebration animation
    setShowConfetti(true);
    const timer = setTimeout(() => setShowConfetti(false), 3000);
    return () => clearTimeout(timer);
  }, []);

  const handleProceedToTowncrier = () => {
    navigate('/towncrier');
  };

  return (
    <div className="approved-verify-container">
      {showConfetti && <div className="confetti-animation"></div>}
      
      <div className="approved-card">
        <div className="approved-header">
          <div className="success-icon">🎉</div>
          <h1>Congratulations!</h1>
          <h2>Application Approved</h2>
          <div className="celebration-text">Welcome to the Ikoota Community!</div>
        </div>

        <div className="approved-content">
          <div className="approval-message">
            <p>
              <strong>Excellent news, {user?.username || 'New Member'}!</strong>
            </p>
            <p>
              Your initial application has been <span className="highlight-success">approved</span> by our admissions team. 
              You are now a <strong>Pre-Member</strong> of the Ikoota community with access to our educational content platform.
            </p>
          </div>

          <div className="new-status">
            <h3>🔰 Your New Status</h3>
            <div className="status-upgrade">
              <div className="status-from">
                <span className="status-label">From:</span>
                <span className="status-badge applicant">Applicant</span>
              </div>
              <div className="status-arrow">→</div>
              <div className="status-to">
                <span className="status-label">To:</span>
                <span className="status-badge pre-member">Pre-Member</span>
              </div>
            </div>
          </div>

          <div className="new-access">
            <h3>🔓 What You Now Have Access To</h3>
            <div className="access-list">
              <div className="access-item granted">
                <span className="access-icon">✅</span>
                <div className="access-details">
                  <strong>Towncrier Content Platform</strong>
                  <p>Browse and read all educational teachings and community announcements</p>
                </div>
              </div>
              <div className="access-item granted">
                <span className="access-icon">✅</span>
                <div className="access-details">
                  <strong>Community Updates</strong>
                  <p>Stay informed with the latest community news and events</p>
                </div>
              </div>
              <div className="access-item granted">
                <span className="access-icon">✅</span>
                <div className="access-details">
                  <strong>Educational Resources</strong>
                  <p>Access to curated learning materials and teachings</p>
                </div>
              </div>
            </div>
          </div>

          <div className="future-access">
            <h3>🚀 Path to Full Membership</h3>
            <p>
              As a Pre-Member, you're on the path to becoming a Full Member with even more benefits:
            </p>
            <div className="future-benefits">
              <div className="benefit-item">
                <span className="benefit-icon">💬</span>
                <span>Iko Chat System Access</span>
              </div>
              <div className="benefit-item">
                <span className="benefit-icon">🤝</span>
                <span>Interactive Community Participation</span>
              </div>
              <div className="benefit-item">
                <span className="benefit-icon">📝</span>
                <span>Content Creation & Sharing</span>
              </div>
              <div className="benefit-item">
                <span className="benefit-icon">🎯</span>
                <span>Advanced Learning Features</span>
              </div>
            </div>
            <div className="full-membership-note">
              <p>
                <strong>Next Step:</strong> After participating as a Pre-Member, you'll be eligible 
                to apply for Full Membership with enhanced community privileges.
              </p>
            </div>
          </div>

          <div className="action-section">
            <h3>🎯 Ready to Get Started?</h3>
            <p>
              Your journey in the Ikoota community begins now. Click below to access 
              the Towncrier platform and start exploring our educational content.
            </p>
            
            <div className="action-buttons">
              <button 
                onClick={handleProceedToTowncrier}
                className="btn-primary main-action"
              >
                🚀 Enter Towncrier Platform
              </button>
              
              <button 
                onClick={() => navigate('/')} 
                className="btn-secondary"
              >
                🏠 Return to Home
              </button>
            </div>
          </div>

          <div className="welcome-tips">
            <h3>💡 Getting Started Tips</h3>
            <div className="tips-grid">
              <div className="tip-item">
                <span className="tip-icon">📖</span>
                <div className="tip-content">
                  <strong>Explore Content</strong>
                  <p>Browse through various teachings and educational materials</p>
                </div>
              </div>
              <div className="tip-item">
                <span className="tip-icon">🔄</span>
                <div className="tip-content">
                  <strong>Stay Active</strong>
                  <p>Regular engagement helps with Full Membership eligibility</p>
                </div>
              </div>
              <div className="tip-item">
                <span className="tip-icon">📧</span>
                <div className="tip-content">
                  <strong>Check Updates</strong>
                  <p>Keep an eye on your email for community announcements</p>
                </div>
              </div>
              <div className="tip-item">
                <span className="tip-icon">❓</span>
                <div className="tip-content">
                  <strong>Need Help?</strong>
                  <p>Contact support if you have any questions</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div className="approved-footer">
          <div className="footer-message">
            <p>
              <strong>Welcome to Ikoota!</strong> We're excited to have you as part of our learning community.
            </p>
          </div>
        </div>
      </div>
    </div>
  );
};

export default Approveverifyinfo;

//======================================


// ikootaclient/src/components/info/ApplicationThankyou.jsx
import React, { useState, useEffect } from 'react';
import { useNavigate, useLocation } from 'react-router-dom';
import { useUser } from '../auth/UserStatus';
import './applicationThankyou.css';

const ApplicationThankyou = () => {
  const navigate = useNavigate();
  const location = useLocation();
  const { user, isAuthenticated } = useUser();
  const [applicationTicket, setApplicationTicket] = useState('');
  const [username, setUsername] = useState('');

  useEffect(() => {
    // Get data from navigation state or generate if needed
    if (location.state) {
      setApplicationTicket(location.state.applicationTicket || '');
      setUsername(location.state.username || '');
    } else if (user) {
      // Generate ticket if not provided but user is authenticated
      setUsername(user.username || user.email || 'User');
      // You could generate a ticket here if needed
    }
  }, [location.state, user]);

  const handleApplicationSurvey = () => {
    if (!isAuthenticated) {
      alert('Please sign in first to access the application survey.');
      navigate('/login');
      return;
    }
    navigate('/applicationsurvey');
  };

  const handleGoToLogin = () => {
    navigate('/login');
  };

  const handleGoHome = () => {
    navigate('/');
  };

  return (
    <div className="application-thankyou-container">
      <div className="thankyou-card">
        <div className="thankyou-header">
          <h1>🎉 Welcome to Ikoota!</h1>
          <h2>Registration Successful</h2>
        </div>

        <div className="thankyou-content">
          <div className="welcome-message">
            <p>
              <strong>Congratulations {username}!</strong>
            </p>
            <p>
              Thank you for signing up and showing interest in becoming a member of our educational platform! 
              We greatly appreciate your intention to join our community.
            </p>
          </div>

          {applicationTicket && (
            <div className="ticket-info">
              <h3>📋 Your Application Details</h3>
              <div className="ticket-display">
                <span className="ticket-label">Application Ticket:</span>
                <span className="ticket-number">{applicationTicket}</span>
              </div>
              <p className="ticket-note">
                Please save this ticket number for your records. You'll need it for any inquiries about your application.
              </p>
            </div>
          )}

          <div className="next-steps">
            <h3>🚀 Next Steps to Membership</h3>
            <div className="steps-list">
              <div className="step">
                <span className="step-number">1</span>
                <div className="step-content">
                  <h4>Complete Application Survey</h4>
                  <p>
                    Fill out our detailed application survey to help us understand your background 
                    and interest in our educational community.
                  </p>
                </div>
              </div>
              
              <div className="step">
                <span className="step-number">2</span>
                <div className="step-content">
                  <h4>Application Review</h4>
                  <p>
                    Our team will review your application and survey responses. This process 
                    typically takes 3-5 business days.
                  </p>
                </div>
              </div>
              
              <div className="step">
                <span className="step-number">3</span>
                <div className="step-content">
                  <h4>Approval Notification</h4>
                  <p>
                    You'll receive an email notification about your application status. 
                    If approved, you'll gain access to our educational content.
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div className="membership-info">
            <h3>📚 About Ikoota Membership</h3>
            <div className="membership-levels">
              <div className="level">
                <h4>🌟 Pre-Member Access</h4>
                <p>After approval, you'll have access to:</p>
                <ul>
                  <li>View public educational content in Towncrier</li>
                  <li>Read community posts and resources</li>
                  <li>Browse teaching materials</li>
                </ul>
                <p className="note">Note: Commenting and chat access requires full membership.</p>
              </div>
              
              <div className="level featured">
                <h4>💎 Full Membership</h4>
                <p>Apply for full membership to unlock:</p>
                <ul>
                  <li>Access to exclusive Iko chat system</li>
                  <li>Participate in discussions and comments</li>
                  <li>Create and share educational content</li>
                  <li>Direct interaction with community members</li>
                </ul>
              </div>
            </div>
          </div>

          <div className="action-buttons">
            <button 
              onClick={handleApplicationSurvey} 
              className="btn-primary survey-btn"
            >
              📝 Fill Out Application Survey
            </button>
            
            <div className="secondary-actions">
              {!isAuthenticated && (
                <button 
                  onClick={handleGoToLogin} 
                  className="btn-secondary"
                >
                  🔑 Sign In to Continue
                </button>
              )}
              
              <button 
                onClick={handleGoHome} 
                className="btn-secondary"
              >
                🏠 Return to Home
              </button>
            </div>
          </div>

          <div className="important-notes">
            <h3>⚠️ Important Notes</h3>
            <div className="notes-list">
              <div className="note">
                <strong>Application Status:</strong> You can check your application status by signing in to your account.
              </div>
              <div className="note">
                <strong>Survey Completion:</strong> The application survey is required for membership consideration. 
                You can complete it anytime after registration.
              </div>
              <div className="note">
                <strong>Contact Support:</strong> For urgent matters, contact us at support@ikoota.com with your application ticket number.
              </div>
            </div>
          </div>
        </div>

        <div className="thankyou-footer">
          <p>
            Use the link above to fill out the application survey. We will review your application shortly 
            and notify you of the decision via email.
          </p>
          <div className="contact-info">
            <p>Questions? Contact us at: <strong>support@ikoota.com</strong></p>
          </div>
        </div>
      </div>
    </div>
  );
};

export default ApplicationThankyou;


//========================================  
//iko FOLDER
//=========================================

//ikootaclient\src\components\iko\Userinfo.jsx
import React, { useEffect, useState } from 'react';
import api from '../service/api';
import {jwtDecode} from 'jwt-decode';
import './userinfo.css';

const Userinfo = () => {
  const [userInfo, setUserInfo] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [user_id, setUserId] = useState(null);
  const [activeTime, setActiveTime] = useState('0m ago');

  useEffect(() => {
    const token = localStorage.getItem("token");
    if (token) {
      setUserId(jwtDecode(token).user_id);
    } else {
      const tokenCookie = document.cookie.split("; ").find((row) => row.startsWith("access_token="));
      if (tokenCookie) {
        setUserId(jwtDecode(tokenCookie.split("=")[1]).user_id);
      } else {
        throw new Error("Access token not found");
      }
    }
  }, []);

  useEffect(() => {
    if (!user_id) return;

    const fetchUserInfo = async () => {
      try {
        const response = await api.get('/users/profile', {
          headers: {
            Authorization: `Bearer ${localStorage.getItem("token")}`,
          },
        });
        setUserInfo(response.data);
        setLoading(false);
      } catch (error) {
        setError(error.message);
        setLoading(false);
      }
    };

    fetchUserInfo();
  }, [user_id]);

  useEffect(() => {
    const startTime = Date.now();

    const updateActiveTime = () => {
      const elapsedTime = Date.now() - startTime;
      const minutes = Math.floor(elapsedTime / 60000);
      const hours = Math.floor(minutes / 60);
      const displayTime = hours > 0 ? `${hours}h ${minutes % 60}m ago` : `${minutes}m ago`;
      setActiveTime(displayTime);
    };

    const intervalId = setInterval(updateActiveTime, 60000); // Update every minute

    return () => clearInterval(intervalId); // Cleanup on unmount
  }, []);

  if (loading) return <p>Loading user info...</p>;
  if (error) return <p>Error fetching user info: {error}</p>;

  return (
    <>
      <div className='userinfo'>
        <div className="user">
          <img src={userInfo.avatar || "./avatar.png"} alt="User Avatar" />
          <h4>{userInfo.username}</h4>
        </div>
        <div className="icons">
          <img src="./more.png" alt="More" />
          <img src="./video.png" alt="Video" />
          <img src="./edit.png" alt="Edit" />
        </div>
      </div>
      <p>Email: {userInfo.email}</p>
      <p>Class ID: {userInfo.class_id}</p>
      <p>User ID: {userInfo.id}</p>
      <p>Active {activeTime}</p>
    </>
  );
};

export default Userinfo;


//=====================================

//ikootaclient\src\components\iko\MediaGallery.jsx
import React, { useState } from "react";
import ReactPlayer from "react-player";

const MediaGallery = ({ mediaFiles }) => {
  const [currentMedia, setCurrentMedia] = useState(null);
  const [playing, setPlaying] = useState(false);

  const handleMediaClick = (file) => {
    if (currentMedia === file) {
      setPlaying(!playing);
    } else {
      setCurrentMedia(file);
      setPlaying(true);
    }
  };

  return (
    <div className="grid grid-cols-3 gap-4">
      {mediaFiles.map((file, index) => (
        <div key={index} className="p-2 border rounded-md">
          {file.type.includes("image") ? (
            <img
              src={file.url}
              alt={file.name}
              className="w-full h-auto cursor-pointer"
              onClick={() => handleMediaClick(file)}
            />
          ) : file.type.includes("video") ? (
            <ReactPlayer
              url={file.url}
              controls
              playing={currentMedia === file && playing}
              width="100%"
              height="auto"
              onClick={() => handleMediaClick(file)}
            />
          ) : file.type.includes("audio") ? (
            <ReactPlayer
              url={file.url}
              controls
              playing={currentMedia === file && playing}
              width="100%"
              height="50px"
              onClick={() => handleMediaClick(file)}
            />
          ) : (
            <p>Unsupported format</p>
          )}
        </div>
      ))}
    </div>
  );
};

export default MediaGallery;


//===========================================

//ikootaclient\src\components\iko\ListComments.jsx
import React, { useEffect, useState } from 'react';
import SearchControls from '../search/SearchControls';
import { jwtDecode } from 'jwt-decode';
import './listcomments.css';
import { useFetchParentChatsAndTeachingsWithComments } from '../service/useFetchComments';

const ListComments = ({ setActiveItem, activeItem = {}, deactivateListChats }) => {
  const [addMode, setAddMode] = useState(false);
  const [user_id, setUserId] = useState(null);
  const [filteredData, setFilteredData] = useState([]);

  useEffect(() => {
    try {
      const token = localStorage.getItem("token");
      if (token) {
        setUserId(jwtDecode(token).user_id);
      } else {
        const tokenCookie = document.cookie.split("; ").find((row) => row.startsWith("access_token="));
        if (tokenCookie) {
          setUserId(jwtDecode(tokenCookie.split("=")[1]).user_id);
        } else {
          console.error("Access token not found");
        }
      }
    } catch (error) {
      console.error("Error decoding token:", error);
    }
  }, []);

  const { data: fetchedData, isLoading: isLoadingComments, error } = useFetchParentChatsAndTeachingsWithComments(user_id);
  console.log("this is the data from list comment component ", fetchedData);

  const handleSearch = (query) => {
    if (!fetchedData?.comments || !Array.isArray(fetchedData.comments)) {
      setFilteredData([]);
      return;
    }

    const filtered = fetchedData.comments.filter(item =>
      (item.comment && item.comment.toLowerCase().includes(query.toLowerCase())) || 
      (item.chat_title && item.chat_title.toLowerCase().includes(query.toLowerCase())) ||
      (item.teaching_title && item.teaching_title.toLowerCase().includes(query.toLowerCase()))
    );
    setFilteredData(filtered);
  };

  const handleItemClick = (item) => {
    if (deactivateListChats) deactivateListChats();
    setActiveItem(item);
  };

  // Group comments by chat_id and teaching_id for easier rendering
  const groupCommentsByParent = () => {
    const groupedComments = {};
    
    // Check if fetchedData and comments exist and is an array
    if (!fetchedData?.comments || !Array.isArray(fetchedData.comments)) {
      console.warn('No comments available or comments is not an array:', fetchedData?.comments);
      return groupedComments;
    }

    fetchedData.comments.forEach(comment => {
      try {
        if (comment.chat_id) {
          if (!groupedComments[comment.chat_id]) {
            groupedComments[comment.chat_id] = [];
          }
          groupedComments[comment.chat_id].push(comment);
        } else if (comment.teaching_id) {
          if (!groupedComments[comment.teaching_id]) {
            groupedComments[comment.teaching_id] = [];
          }
          groupedComments[comment.teaching_id].push(comment);
        }
      } catch (err) {
        console.warn('Error processing comment:', comment, err);
      }
    });
    
    return groupedComments;
  };

  // Loading state
  if (isLoadingComments) {
    return (
      <div className='listcomments_container'>
        <div className="loading-message">
          <p>Loading comments...</p>
        </div>
      </div>
    );
  }

  // Error state
  if (error) {
    return (
      <div className='listcomments_container'>
        <div className="error-message">
          <p style={{color: 'red'}}>Error loading comments: {error.message}</p>
        </div>
      </div>
    );
  }

  // No data state
  if (!fetchedData) {
    return (
      <div className='listcomments_container'>
        <div className="search">
          <div className="searchbar">
            <img src="./search.png" alt="" />
            <SearchControls onSearch={handleSearch} />
          </div>
          <img src={addMode ? "./minus.png" : "./plus.png"} alt="" className='add' onClick={() => setAddMode(!addMode)} />
        </div>
        <p>No data available</p>
      </div>
    );
  }

  const groupedComments = groupCommentsByParent();

  return (
    <div className='listcomments_container'>
      <div className="search">
        <div className="searchbar">
          <img src="./search.png" alt="" />
          <SearchControls onSearch={handleSearch} />
        </div>
        <img src={addMode ? "./minus.png" : "./plus.png"} alt="" className='add' onClick={() => setAddMode(!addMode)} />
      </div>

      {(!fetchedData?.chats || fetchedData.chats.length === 0) && 
       (!fetchedData?.teachings || fetchedData.teachings.length === 0) && 
       <p>No chats or teachings available</p>}
      
      {/* Render Chats */}
      {fetchedData?.chats && Array.isArray(fetchedData.chats) && fetchedData.chats.map((chat) => {
        const commentsForChat = groupedComments[chat.id] || [];
        
        return (
          <div key={chat.updatedAt || chat.id} className={`chat-item ${activeItem?.updatedAt === chat.updatedAt ? 'active' : ''}`} onClick={() => handleItemClick(chat)}>
            <div className="texts">
              <span>Topic: {chat.title || 'No title'}</span>
              <p>Description: {chat.summary || 'No description'}</p>
              <p>Lesson#: {chat.id}</p>
              <p>Audience: {chat.audience || 'No audience'}</p>
              <p>Post By: {chat.created_by || 'Admin'}</p>
              <p>Date Posted: {chat.createdAt ? new Date(chat.createdAt).toLocaleString() : 'Unknown date'}</p>
              <p>Date Updated: {chat.updatedAt ? new Date(chat.updatedAt).toLocaleString() : 'Unknown date'}</p>
            </div>

            {/* Render the comments for this chat */}
            {commentsForChat.length > 0 ? (
              <div className="comments">
                <h4>Comments:</h4>
                {commentsForChat.map((comment) => (
                  <div key={comment.updatedAt || comment.id} className="comment-item">
                    <p>{comment.comment}</p>
                    <p>CreatedBy: {comment.user_id}</p>
                    <p>Date created: {comment.createdAt ? new Date(comment.createdAt).toLocaleString() : 'Unknown date'}</p>
                    <p>Date updated: {comment.updatedAt ? new Date(comment.updatedAt).toLocaleString() : 'Unknown date'}</p>
                  </div>
                ))}
              </div>
            ) : (
              <p>No comments for this chat</p>
            )}
          </div>
        );
      })}

      {/* Render Teachings */}
      {fetchedData?.teachings && Array.isArray(fetchedData.teachings) && fetchedData.teachings.map((teaching) => {
        const commentsForTeaching = groupedComments[teaching.id] || [];
        
        return (
          <div key={teaching.updatedAt || teaching.id} className={`teaching-item ${activeItem?.id === teaching.id ? 'active' : ''}`} onClick={() => handleItemClick(teaching)}>
            <div className="texts">
              <span>Topic: {teaching.topic || 'No topic'}</span>
              <p>Description: {teaching.description || 'No description'}</p>
              <p>Lesson#: {teaching.id}</p>
              <p>Audience: {teaching.audience || 'No audience'}</p>
              <p>Post By: {teaching.created_by || 'Admin'}</p>
              <p>Date Posted: {teaching.createdAt ? new Date(teaching.createdAt).toLocaleString() : 'Unknown date'}</p>
              <p>Date Updated: {teaching.updatedAt ? new Date(teaching.updatedAt).toLocaleString() : 'Unknown date'}</p>
            </div>

            {/* Render the comments for this teaching */}
            {commentsForTeaching && commentsForTeaching.length > 0 ? (
              <div className="comments">
                <h4>Comments:</h4>
                {commentsForTeaching.map((comment) => (
                  <div key={comment?.updatedAt || comment?.id} className="comment-item">
                    <p>{comment?.comment}</p>
                    <p>CreatedBy: {comment.user_id}</p>
                    <p>Date created: {comment.createdAt ? new Date(comment.createdAt).toLocaleString() : 'Unknown date'}</p>
                    <p>Date updated: {comment.updatedAt ? new Date(comment.updatedAt).toLocaleString() : 'Unknown date'}</p>
                  </div>
                ))}
              </div>
            ) : (
              <p>No comments for this teaching</p>
            )}
          </div>
        );
      })}

      {/* Show filtered comments if search is active */}
      {filteredData.length > 0 && (
        <div className="filtered-comments">
          <h3>Search Results ({filteredData.length} comments)</h3>
          {filteredData.map((comment, index) => (
            <div key={comment.id || index} className="comment-search-result">
              <div className="comment-content">
                <p>"{comment.comment}"</p>
                <div className="comment-details">
                  <span>By: {comment.user_id}</span>
                  <span>Created: {comment.createdAt ? new Date(comment.createdAt).toLocaleString() : 'Unknown date'}</span>
                  <span>
                    On: {comment.chat_title ? `Chat - ${comment.chat_title}` : 
                         comment.teaching_title ? `Teaching - ${comment.teaching_title}` : 'Unknown'}
                  </span>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

export default ListComments;

//================================

//ikootaclient\src\components\iko\ListChats.jsx
import React, { useState, useEffect } from 'react';
import SearchControls from '../search/SearchControls';
import './listchats.css';
import api from '../service/api';

const ListChats = ({ setActiveItem, deactivateListComments }) => {
  const [addMode, setAddMode] = useState(false);
  const [activeItem, setActiveItemState] = useState({ id: null, type: null });
  const [content, setContent] = useState([]);
  const [comments, setComments] = useState([]);
  const [filteredItems, setFilteredItems] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const fetchData = async () => {
      setLoading(true);
      setError(null);

      try {
        console.log('Fetching combined content...');
        
        const [contentResponse, commentsResponse] = await Promise.all([
          api.get('/chats/combinedcontent'),
          api.get('/comments/all')
        ]);
        
        console.log('Combined content response:', contentResponse);

        const contentData = contentResponse.data?.data || contentResponse.data || [];
        const commentsData = commentsResponse.data || [];

        console.log('Processed content data:', contentData);
        console.log('Comments data:', commentsData);

        // Clean and normalize the data
        const cleanedContent = contentData.map(item => ({
          ...item,
          // Normalize content properties
          content_title: item.content_title || item.title || item.topic || 'Untitled',
          content_type: item.content_type || (item.title ? 'chat' : 'teaching'),
          audience: item.audience === 'undefined' ? '' : item.audience,
          summary: item.summary?.startsWith('undefined') ? 
            item.summary.replace('undefined', '').trim() : item.summary,
          // Ensure consistent date fields
          display_date: item.updatedAt || item.createdAt,
          // Create fallback prefixed_id if missing
          prefixed_id: item.prefixed_id || `${item.content_type?.[0] || 'c'}${item.id}`
        }));

        setContent(cleanedContent);
        setComments(commentsData);
        setFilteredItems(cleanedContent);
      } catch (error) {
        console.error('Error fetching combined content:', error);
        setError('Failed to fetch content. Please try again.');
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, []);

  // Enhanced comment grouping with better error handling
  const groupCommentsByParent = () => {
    const groupedComments = {};

    if (!Array.isArray(comments)) {
      console.warn('Comments is not an array:', comments);
      return groupedComments;
    }
    
    comments.forEach(comment => {
      try {
        if (comment.chat_id) {
          const keys = [comment.chat_id, `c${comment.chat_id}`];
          keys.forEach(key => {
            if (!groupedComments[key]) groupedComments[key] = [];
            groupedComments[key].push(comment);
          });
        }
        
        if (comment.teaching_id) {
          const keys = [comment.teaching_id, `t${comment.teaching_id}`];
          keys.forEach(key => {
            if (!groupedComments[key]) groupedComments[key] = [];
            groupedComments[key].push(comment);
          });
        }
      } catch (err) {
        console.warn('Error grouping comment:', comment, err);
      }
    });
    
    return groupedComments;
  };

  const groupedComments = groupCommentsByParent();

  const handleSearch = (query) => {
    if (!Array.isArray(content)) {
      console.warn('Content is not an array for search:', content);
      return;
    }
    
    const lowercaseQuery = query.toLowerCase();
    const filtered = content.filter(item => {
      const searchFields = [
        item.content_title,
        item.title,
        item.topic,
        item.summary,
        item.description,
        item.prefixed_id,
        item.subjectMatter,
        item.audience
      ];
      
      return searchFields.some(field => 
        field && field.toString().toLowerCase().includes(lowercaseQuery)
      );
    });
    
    setFilteredItems(filtered);
  };

  const handleItemClick = (item) => {
    try {
      if (deactivateListComments) deactivateListComments();
      
      const itemData = {
        id: item.prefixed_id || item.id,
        type: item.content_type || (item.title ? 'chat' : 'teaching'),
        prefixed_id: item.prefixed_id,
        ...item
      };
      
      setActiveItemState(itemData);
      if (setActiveItem) setActiveItem(itemData);
    } catch (error) {
      console.error('Error handling item click:', error);
    }
  };

  // Helper functions
  const getContentTitle = (item) => {
    return item?.content_title || item?.title || item?.topic || 'Untitled';
  };

  const getCreationDate = (item) => {
    const dateStr = item?.display_date || item?.createdAt;
    if (!dateStr) return 'Unknown date';
    
    try {
      return new Date(dateStr).toLocaleDateString();
    } catch (error) {
      return 'Invalid date';
    }
  };

  const getContentIdentifier = (item) => {
    return item?.prefixed_id || `${item?.content_type?.[0] || 'c'}${item?.id}`;
  };

  if (loading) {
    return (
      <div className='listchats_container' style={{border:"3px solid brown"}}>
        <div className="loading-message">
          <p>Loading content...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className='listchats_container' style={{border:"3px solid brown"}}>
        <div className="error-message">
          <p style={{color: 'red'}}>{error}</p>
          <button onClick={() => window.location.reload()}>Retry</button>
        </div>
      </div>
    );
  }

  return (
    <div className='listchats_container' style={{border:"3px solid brown"}}>
      <div className="search">
        <div className="searchbar">
          <img src="./search.png" alt="Search" />
          <SearchControls onSearch={handleSearch} />
        </div>
        <img 
          src={addMode ? "./minus.png" : "./plus.png"} 
          alt="Toggle" 
          className='add' 
          onClick={() => setAddMode(!addMode)} 
        />
      </div>

      {!Array.isArray(filteredItems) || filteredItems.length === 0 ? (
        <p>No content available</p>
      ) : (
        filteredItems.map((item, index) => {
          const itemKey = item.prefixed_id || item.id;
          const commentsForItem = groupedComments[itemKey] || groupedComments[item.id] || [];
          const uniqueKey = item.prefixed_id || `${item.content_type || 'item'}-${item.id}-${index}`;
          
          return (
            <div 
              key={uniqueKey}
              className={`item ${activeItem?.prefixed_id === item.prefixed_id ? 'active' : ''}`} 
              onClick={() => handleItemClick(item)}
            >
              <div className="texts">
                <div className="item-header">
                  <span className="content-type-badge">{item.content_type}</span>
                  <span className="content-id">{getContentIdentifier(item)}</span>
                </div>
                
                <span className="content-title">Title: {getContentTitle(item)}</span>
                <p>Lesson#: {item.lessonNumber || item.id}</p>
                <p>Audience: {item.audience || 'General'}</p>
                <p>By: {item.user_id || item.created_by || 'Admin'}</p>
                <p>Date: {getCreationDate(item)}</p>
                
                {item.subjectMatter && (
                  <p>Subject: {item.subjectMatter}</p>
                )}
              </div>

              {/* Comments Preview */}
              <div className="comments-preview">
                {commentsForItem && commentsForItem.length > 0 ? (
                  <div className="comments">
                    <h4>Comments ({commentsForItem.length}):</h4>
                    {commentsForItem.slice(0, 2).map((comment, commentIndex) => (
                      <div key={comment.id || `comment-${commentIndex}`} className="comment-item">
                        <p>By: {comment.user_id || 'Unknown'}</p>
                        <p>Created: {new Date(comment.createdAt).toLocaleDateString()}</p>
                        {comment.comment && comment.comment.length > 50 ? (
                          <p>"{comment.comment.substring(0, 50)}..."</p>
                        ) : (
                          <p>"{comment.comment}"</p>
                        )}
                      </div>
                    ))}
                    {commentsForItem.length > 2 && (
                      <p className="more-comments">+{commentsForItem.length - 2} more comments</p>
                    )}
                  </div>
                ) : (
                  <div className="no-comments">
                    <p>No comments for {getContentIdentifier(item)}</p>
                  </div>
                )}
              </div>
            </div>
          );
        })
      )}
    </div>
  );
};

export default ListChats;

//=======================================

//ikootaclient\src\components\iko\List.jsx
import React from 'react';
import './list.css';
import Userinfo from './Userinfo';
import ListComments from './ListComments';

const List = ({ teachings = [], chats = [], comments = [], setActiveItem }) => {
  return (
    <div className='list_container' style={{border:"3px solid black"}}>
      <Userinfo />
      <ListComments teachings={teachings} chats={chats} comments={comments} setActiveItem={setActiveItem} />
    </div>
  );
};

export default List;
//====================================

//ikootaclient\src\components\iko\IkoControls.jsx
import React, { useEffect, useState } from 'react';
import axios from 'axios';
import './ikocontrols.css';
// import Chat from "./Chat";

const IkoControls = () => {
  const [messages, setMessages] = useState([]);
  const [comments, setComments] = useState([]);
  const [chats, setChats] = useState([]);
  const [filter, setFilter] = useState('pending'); // Default filter for messages

  // Fetch data based on filter
  const fetchData = async (type) => {
    try {
      let response;
      switch (type) {
        case 'messages':
          response = await axios.get(`/api/messages?status=${filter}`);
          setMessages(response.data);
          break;
        case 'comments':
          response = await axios.get(`/api/comments?status=${filter}`);
          setComments(response.data);
          break;
        case 'chats':
          response = await axios.get(`/api/chats`);
          setChats(response.data);
          break;
        default:
          break;
      }
    } catch (err) {
      console.error(err);
    }
  };

  // Approve, Reject, or Delete items
  const handleAction = async (type, id, action) => {
    try {
      await axios.put(`/api/${type}/${id}`, { status: action });
      fetchData(type);
    } catch (err) {
      console.error(err);
    }
  };

  useEffect(() => {
    fetchData('messages');
    fetchData('comments');
    fetchData('chats');
  }, [filter]);

  return (
    <div className="iko-controls">
       <h2>Admin Chat Controls</h2>
       {/* <Chat /> */}
      <h1>Iko Controls</h1>
      <div className="controls-container">
        <div className="messages-section">
          <h2>Manage Messages</h2>
          <div className="filters">
            <button onClick={() => setFilter('pending')}>Pending</button>
            <button onClick={() => setFilter('approved')}>Approved</button>
            <button onClick={() => setFilter('rejected')}>Rejected</button>
            <button onClick={() => setFilter('deleted')}>Deleted</button>
          </div>
          <ul>
            { Array.isArray(messages) && messages?.map((msg) => (
              <li key={msg.id}>
                <p><strong>{msg.topic}</strong>: {msg.description}</p>
                <div>
                  <button onClick={() => handleAction('messages', msg.id, 'approved')}>Approve</button>
                  <button onClick={() => handleAction('messages', msg.id, 'rejected')}>Reject</button>
                  <button onClick={() => handleAction('messages', msg.id, 'deleted')}>Delete</button>
                </div>
              </li>
            ))}
          </ul>
        </div>

        <div className="comments-section">
          <h2>Manage Comments</h2>
          <ul>
            { Array.isArray(comments) && comments.map((comment) => (
              <li key={comment.id}>
                <p>{comment.content}</p>
                <div>
                  <button onClick={() => handleAction('comments', comment.id, 'approved')}>Approve</button>
                  <button onClick={() => handleAction('comments', comment.id, 'rejected')}>Reject</button>
                  <button onClick={() => handleAction('comments', comment.id, 'deleted')}>Delete</button>
                </div>
              </li>
            ))}
          </ul>
        </div>

        <div className="chats-section">
          <h2>Manage Chats</h2>
          <ul>
            { Array.isArray(chats) && chats.map((chat) => (
              <li key={chat.id}>
                <p><strong>{chat.topic}</strong>: {chat.description}</p>
                <div>
                  <button onClick={() => handleAction('chats', chat.id, 'deleted')}>Delete</button>
                </div>
              </li>
            ))}
          </ul>
        </div>
      </div>
    </div>
  );
};

export default IkoControls;

//=====================================

// ikootaclient/src/components/iko/IkoAuthWrapper.jsx
// ✅ Authorization wrapper for Iko component

import React from 'react';
import { useUser } from '../auth/UserStatus';
import { Navigate } from 'react-router-dom';
import Iko from './Iko';

const IkoAuthWrapper = ({ isNested = false }) => {
  const { user, loading, isAuthenticated } = useUser();

  // Show loading state
  if (loading) {
    return (
      <div style={{ 
        display: 'flex', 
        justifyContent: 'center', 
        alignItems: 'center', 
        height: '100vh',
        flexDirection: 'column'
      }}>
        <p>🔄 Checking member privileges...</p>
        <p style={{ fontSize: '0.8em', color: '#666' }}>Verifying access to Iko Chat System</p>
      </div>
    );
  }

  // Check if user is authenticated
  if (!isAuthenticated || !user) {
    console.log('❌ User not authenticated for Iko access');
    return <Navigate to="/login" replace />;
  }

  // ✅ Check member privileges based on your database structure
  const hasIkoAccess = () => {
    const membershipStage = user.membership_stage?.toLowerCase();
    const memberStatus = user.is_member?.toLowerCase();
    const userRole = user.role?.toLowerCase();

    console.log('🔍 Checking Iko access for user:', {
      id: user.id,
      username: user.username,
      membershipStage,
      memberStatus,
      userRole
    });

    // ✅ PRIORITY 1: Admin users always have access
    if (['admin', 'super_admin'].includes(userRole)) {
      console.log('✅ Admin access granted to Iko');
      return true;
    }

    // ✅ PRIORITY 2: Full members have access
    if (membershipStage === 'member' && memberStatus === 'member') {
      console.log('✅ Full member access granted to Iko');
      return true;
    }

    // ✅ PRIORITY 3: Check alternative member statuses
    if (memberStatus === 'granted' || memberStatus === 'member') {
      console.log('✅ Granted member access to Iko');
      return true;
    }

    // ❌ Deny access for others
    console.log('❌ Iko access denied:', {
      reason: 'Insufficient privileges',
      requiredStatus: 'member',
      currentStage: membershipStage,
      currentStatus: memberStatus
    });
    return false;
  };

  // Check access
  if (!hasIkoAccess()) {
    return (
      <div style={{ 
        padding: '40px', 
        textAlign: 'center',
        maxWidth: '600px',
        margin: '0 auto',
        background: '#f5f5f5',
        borderRadius: '8px',
        marginTop: '50px'
      }}>
        <h2 style={{ color: '#e74c3c' }}>🚫 Access Restricted</h2>
        <p style={{ fontSize: '1.1em', marginBottom: '20px' }}>
          <strong>Iko Chat System</strong> is available to full members only.
        </p>
        
        <div style={{ 
          background: 'white', 
          padding: '20px', 
          borderRadius: '4px', 
          marginBottom: '20px',
          border: '1px solid #ddd'
        }}>
          <h3>Your Current Status:</h3>
          <p><strong>Membership Stage:</strong> {user.membership_stage || 'Not set'}</p>
          <p><strong>Member Status:</strong> {user.is_member || 'Not set'}</p>
          <p><strong>Role:</strong> {user.role || 'User'}</p>
        </div>

        <div style={{ 
          background: '#e8f5e8', 
          padding: '15px', 
          borderRadius: '4px',
          marginBottom: '20px'
        }}>
          <h4>To Access Iko Chat:</h4>
          <ul style={{ textAlign: 'left', maxWidth: '400px', margin: '0 auto' }}>
            <li>Complete your membership application</li>
            <li>Wait for admin approval</li>
            <li>Check your email for updates</li>
          </ul>
        </div>

        <div style={{ marginTop: '30px' }}>
          <button 
            onClick={() => window.location.href = '/towncrier'}
            style={{
              padding: '12px 24px',
              backgroundColor: '#3498db',
              color: 'white',
              border: 'none',
              borderRadius: '4px',
              cursor: 'pointer',
              marginRight: '10px'
            }}
          >
            📖 Browse Public Content
          </button>
          
          <button 
            onClick={() => window.location.href = '/dashboard'}
            style={{
              padding: '12px 24px',
              backgroundColor: '#95a5a6',
              color: 'white',
              border: 'none',
              borderRadius: '4px',
              cursor: 'pointer'
            }}
          >
            🏠 Dashboard
          </button>
        </div>
      </div>
    );
  }

  // ✅ User has access, render Iko component
  console.log('✅ Iko access granted, rendering component');
  return <Iko isNested={isNested} />;
};

export default IkoAuthWrapper;

//=======================================


// ikootaclient\src\components\iko\Iko.jsx
// COMPLETE IKO JSX FIX
// Updated Iko.jsx with proper admin layout support
// ==================================================

import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import './iko.css';
import ListChats from './ListChats';
import Chat from './Chat';
import ListComments from './ListComments';
import { useFetchChats } from '../service/useFetchChats';
import { useFetchComments } from '../service/useFetchComments';
import { useFetchTeachings } from '../service/useFetchTeachings';
import { useUser } from '../auth/UserStatus';

const Iko = ({ isNested = false }) => {
  const { data: chats = [], isLoading: isLoadingChats, error: errorChats } = useFetchChats();
  const { data: teachings = [], isLoading: isLoadingTeachings, error: errorTeachings } = useFetchTeachings();
  const { data: comments = [], isLoading: isLoadingComments, error: errorComments } = useFetchComments();
  const [activeItem, setActiveItem] = useState(null);
  
  const { user, logout, isAdmin } = useUser();
  const navigate = useNavigate();

  // Detect if we're inside admin layout
  const [isInAdmin, setIsInAdmin] = useState(false);

  useEffect(() => {
    // Check if we're rendered inside admin layout
    const checkAdminContext = () => {
      const adminContainer = document.querySelector('.adminContainer, .mainContent, .mainCOntent');
      setIsInAdmin(!!adminContainer);
    };

    checkAdminContext();
    
    // Also check on window resize
    window.addEventListener('resize', checkAdminContext);
    return () => window.removeEventListener('resize', checkAdminContext);
  }, []);

  useEffect(() => {
    if (!activeItem && chats.length > 0) {
      setActiveItem({ type: "chat", id: chats[0]?.id });
    }
  }, [chats, activeItem]);

  const deactivateListComments = () => {
    setActiveItem(null);
  };

  const deactivateListChats = () => {
    setActiveItem(null);
  };

  // Navigation handlers
  const handleNavigateToTowncrier = () => {
    const confirmNavigation = window.confirm(
      "Leave Iko Chat and go to public content?"
    );
    if (confirmNavigation) {
      navigate('/towncrier');
    }
  };

  const handleSignOut = () => {
    const confirmSignOut = window.confirm("Sign out of your account?");
    if (confirmSignOut) {
      logout();
      navigate('/');
    }
  };

  const handleNavigateToAdmin = () => {
    if (isAdmin) {
      navigate('/admin');
    } else {
      alert("You don't have admin privileges.");
    }
  };

  // Determine container style based on context
  const getContainerStyle = () => {
    if (isNested || isInAdmin) {
      return {
        '--iko-width': '100%',
        '--iko-height': '100%',
      };
    }
    return {
      '--iko-width': '90vw',
      '--iko-height': '90vh',
    };
  };

  // Loading state
  if (isLoadingChats || isLoadingComments || isLoadingTeachings) {
    return (
      <div 
        className="iko_container" 
        style={getContainerStyle()}
      >
        <div className="nav">
          <div className="nav-left">
            <span>Iko Chat - Loading...</span>
          </div>
          <div className="nav-right">
            <span className="status-badge loading">⏳ Loading...</span>
          </div>
        </div>
        <div className="iko_viewport">
          <div className="status loading">
            <div>
              <p>🔄 Loading member chat system...</p>
              <p style={{ fontSize: '0.8em', marginTop: '10px' }}>
                Fetching chats, comments, and teachings...
              </p>
            </div>
          </div>
        </div>
        <div className="footnote">
          <span>Iko - Member Chat System</span>
          <span>Loading...</span>
        </div>
      </div>
    );
  }

  // Error state
  if (errorChats || errorComments || errorTeachings) {
    const errors = [
      errorChats && 'Chats',
      errorComments && 'Comments', 
      errorTeachings && 'Teachings'
    ].filter(Boolean);

    return (
      <div 
        className="iko_container" 
        style={getContainerStyle()}
      >
        <div className="nav">
          <div className="nav-left">
            <span>Iko Chat - Error</span>
          </div>
          <div className="nav-right">
            <span className="status-badge error">❌ Error</span>
          </div>
        </div>
        <div className="iko_viewport">
          <div className="status error">
            <div>
              <p>⚠️ Error loading member chat data!</p>
              <p style={{ fontSize: '0.8em', marginTop: '10px' }}>
                Failed to load: {errors.join(', ')}
              </p>
              <button 
                onClick={() => window.location.reload()} 
                style={{
                  marginTop: '15px',
                  padding: '8px 16px',
                  backgroundColor: '#f44336',
                  color: 'white',
                  border: 'none',
                  borderRadius: '4px',
                  cursor: 'pointer'
                }}
              >
                🔄 Retry
              </button>
            </div>
          </div>
        </div>
        <div className="footnote">
          <span>Iko - Member Chat System</span>
          <span>Error State</span>
        </div>
      </div>
    );
  }

  // Main render
  return (
    <div
      className="iko_container"
      style={getContainerStyle()}
    >
      {/* Navigation Bar */}
      <div className="nav">
        <div className="nav-left">
          <span>Iko Chat - Member System</span>
          <div className="member-status">
            <span className="status-badge member">✅ Member</span>
            <span className="user-info">
              👤 {user?.username || user?.email || 'Member'}
              {isAdmin && <span className="admin-badge">🛡️ Admin</span>}
            </span>
          </div>
        </div>
        
        <div className="nav-right">
          <span className="chat-count">💬 {chats.length}</span>
          <span className="teaching-count">📚 {teachings.length}</span>
          {isInAdmin && (
            <span className="status-badge" style={{ background: '#9c27b0', color: 'white' }}>
              📱 Admin View
            </span>
          )}
        </div>
      </div>
      
      {/* Main Chat Viewport */}
      <div className="iko_viewport">
        <ListChats 
          setActiveItem={setActiveItem} 
          deactivateListComments={deactivateListComments}
          isInAdmin={isInAdmin}
        />
        <Chat 
          activeItem={activeItem} 
          chats={chats} 
          teachings={teachings}
          isInAdmin={isInAdmin}
        />
        <ListComments 
          setActiveItem={setActiveItem} 
          deactivateListChats={deactivateListChats}
          isInAdmin={isInAdmin}
        />
      </div>
      
      {/* Footer */}
      <div className="footnote">
        <div className="footer-left">
          <span>Iko - Member Chat</span>
          {activeItem && (
            <span> | {activeItem.type} #{activeItem.id}</span>
          )}
        </div>
        
        <div className="footer-center">
          <div className="activity-indicator">
            <span className="online-status">🟢 Online</span>
            {isInAdmin && (
              <span style={{ fontSize: '0.7em', marginLeft: '8px', color: '#ccc' }}>
                Admin Layout
              </span>
            )}
          </div>
        </div>
        
        <div className="footer-right">
          <div className="footer-controls">
            {!isInAdmin && (
              <button 
                onClick={handleNavigateToTowncrier} 
                className="footer-btn towncrier-btn"
                title="View public content"
              >
                📖 Public
              </button>
            )}
            
            {isAdmin && !isInAdmin && (
              <button 
                onClick={handleNavigateToAdmin} 
                className="footer-btn admin-btn"
                title="Admin Panel"
              >
                ⚙️ Admin
              </button>
            )}
            
            <button 
              onClick={() => window.location.reload()} 
              className="footer-btn refresh-btn"
              title="Refresh chat system"
            >
              🔄 Refresh
            </button>
            
            <button 
              onClick={handleSignOut} 
              className="footer-btn signout-btn"
              title="Sign out"
            >
              👋 Out
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

export default Iko;

//========================================

//ikootaclient\src\components\iko\Chat.jsx
import React, { useState } from "react";
import { useForm } from "react-hook-form";
import useUpload from "../../hooks/useUpload";
import EmojiPicker from "emoji-picker-react";
import DOMPurify from "dompurify";
import ReactPlayer from "react-player";
import "./chat.css";
import { useFetchParentChatsAndTeachingsWithComments } from "../service/useFetchComments";
import { jwtDecode } from "jwt-decode";
import MediaGallery from "./MediaGallery";
import { useUploadCommentFiles } from "../../hooks/useUploadCommentFiles";
import { postComment } from "../service/commentServices";
import { useQueries, Mutation } from "@tanstack/react-query"

const Chat = ({ activeItem, chats = [], teachings = [] }) => {
  const { handleSubmit, register, reset } = useForm();
  const { validateFiles, mutation: chatMutation } = useUpload("/chats");
  const { validateFiles: validateCommentFiles, mutation: commentMutation } = useUpload("/comments");
  const uploadCommentFiles = useUploadCommentFiles();

  const token = localStorage.getItem("token");
  const user_id = token ? jwtDecode(token).user_id : null;

  const { data: fetchedComments, isLoading: isLoadingComments } = useFetchParentChatsAndTeachingsWithComments(activeItem?.user_id);
  
  const [formData, setFormData] = useState({});
  const [openEmoji, setOpenEmoji] = useState(false);
  const [addMode, setAddMode] = useState(false);
  const [step, setStep] = useState(0);
  const [playingMedia, setPlayingMedia] = useState(null);

  // Simple activeContent finder with proper error handling
  const findActiveContent = () => {
    if (!activeItem) {
      console.log('No active item provided');
      return null;
    }

    try {
      // Make sure chats and teachings are arrays
      const chatsArray = Array.isArray(chats) ? chats : [];
      const teachingsArray = Array.isArray(teachings) ? teachings : [];

      console.log('Finding content for:', activeItem);
      console.log('Chats available:', chatsArray.length);
      console.log('Teachings available:', teachingsArray.length);

      // Try to find by prefixed_id first
      if (activeItem.prefixed_id) {
        if (activeItem.prefixed_id.startsWith('c') || activeItem.type === "chat") {
          const foundChat = chatsArray.find((chat) => 
            chat.prefixed_id === activeItem.prefixed_id || 
            chat.id === activeItem.id ||
            chat.updatedAt === activeItem.updatedAt
          );
          if (foundChat) {
            console.log('Found chat:', foundChat);
            return foundChat;
          }
        } else if (activeItem.prefixed_id.startsWith('t') || activeItem.type === "teaching") {
          const foundTeaching = teachingsArray.find((teaching) => 
            teaching.prefixed_id === activeItem.prefixed_id || 
            teaching.id === activeItem.id ||
            teaching.updatedAt === activeItem.updatedAt
          );
          if (foundTeaching) {
            console.log('Found teaching:', foundTeaching);
            return foundTeaching;
          }
        }
      }

      // Fallback to original method
      if (activeItem.type === "chat") {
        const foundChat = chatsArray.find((chat) => 
          chat.updatedAt === activeItem.updatedAt || 
          chat.id === activeItem.id
        );
        if (foundChat) {
          console.log('Found chat by fallback:', foundChat);
          return foundChat;
        }
      } else if (activeItem.type === "teaching") {
        const foundTeaching = teachingsArray.find((teaching) => 
          teaching.updatedAt === activeItem.updatedAt || 
          teaching.id === activeItem.id
        );
        if (foundTeaching) {
          console.log('Found teaching by fallback:', foundTeaching);
          return foundTeaching;
        }
      }

      // Last resort - return activeItem itself if it has content
      if (activeItem.title || activeItem.topic || activeItem.content || activeItem.text) {
        console.log('Using activeItem as content:', activeItem);
        return activeItem;
      }

      console.log('No content found for activeItem:', activeItem);
      return null;

    } catch (error) {
      console.error('Error in findActiveContent:', error);
      return null;
    }
  };

  const activeContent = findActiveContent();

  console.log("Active item:", activeItem);
  console.log("Active content:", activeContent);

  if (!activeItem) {
    return <p className="status">Select a chat or teaching to start.</p>;
  }

  const handleNextStep = () => {
    if (step < 6) setStep(step + 1);
  };

  const handlePrevStep = () => {
    if (step > 0) setStep(step - 1);
  };

  const handleEmoji = (e) => {
    setFormData({ ...formData, comment: (formData.comment || "") + e.emoji });
    setOpenEmoji(false);
  };

  const sanitizeMessage = (message) => {
    if (!message) return "";
    return DOMPurify.sanitize(message, { ALLOWED_TAGS: ["b", "i", "em", "strong", "a"] });
  };

  const handleSendChat = (data) => {
    const formData = new FormData();
    formData.append("created_by", user_id || "anonymous");
    formData.append("title", data.title);
    formData.append("audience", data.audience);
    formData.append("summary", data.summary);
    formData.append("text", data.text);
    formData.append("is_flagged", false);

    ["media1", "media2", "media3"].forEach((file) => {
      if (data[file]?.[0]) {
        formData.append(file, data[file][0]);
      }
    });

    chatMutation.mutate(formData, {
      onSuccess: (response) => {
        console.log("Chat created with prefixed ID:", response.data?.prefixed_id);
        reset();
        setStep(0);
        alert("Chat created successfully!");
      },
      onError: (error) => {
        console.error("Error uploading chat:", error);
        alert("Error creating chat. Please try again.");
      },
    });
  };

  const handleSendComment = async (data) => {
    try {
      if (!user_id) {
        alert("Please log in to comment");
        return;
      }

      const contentId = activeContent?.id || activeItem?.id;
      const contentType = activeContent?.content_type || activeContent?.type || activeItem?.type;

      if (!contentId || !contentType) {
        console.error("Missing content ID or type");
        alert("Error: Unable to identify content");
        return;
      }

      const files = [data.media1, data.media2, data.media3].filter(Boolean).flat();
      let mediaData = [];
      
      if (files.length > 0) {
        try {
          const uploadResponse = await uploadCommentFiles.mutateAsync(files);
          mediaData = uploadResponse.map((file) => ({
            url: file.url,
            type: file.type,
          }));
        } catch (error) {
          console.error("Error uploading media:", error);
        }
      }

      const formData = new FormData();
      formData.append("comment", data.comment);
      formData.append(contentType === "chat" ? "chat_id" : "teaching_id", contentId);
      formData.append("user_id", user_id);

      ["media1", "media2", "media3"].forEach((file) => {
        if (data[file]?.[0]) {
          formData.append(file, data[file][0]);
        }
      });

      const uploadResponse = await commentMutation.mutateAsync(formData);
      
      const commentData = {
        user_id,
        comment: data.comment,
        media: mediaData,
      };

      if (contentType === "chat") {
        commentData.chat_id = contentId;
      } else if (contentType === "teaching") {
        commentData.teaching_id = contentId;
      }

      await postComment(commentData);
      
      reset();
      setStep(0);
      alert("Comment posted successfully!");
    } catch (error) {
      console.error("Error posting comment:", error);
      alert("Error posting comment. Please try again.");
    }
  };

  const handleMediaClick = (url) => {
    setPlayingMedia(url);
  };

  // Helper function to render media based on type and URL
  const renderMedia = (url, type, alt = "media") => {
    if (!url || !type) return null;

    switch (type) {
      case "image":
        return <img src={url} alt={alt} width="100%" style={{ maxHeight: "300px", objectFit: "contain" }} onClick={() => handleMediaClick(url)} />;
      case "video":
        return <ReactPlayer url={url} controls width="100%" height="200px" />;
      case "audio":
        return (
          <audio controls style={{ width: "100%" }}>
            <source src={url} type="audio/mpeg" />
            Your browser does not support the audio element.
          </audio>
        );
      default:
        return <p>Unsupported media type: {type}</p>;
    }
  };

  // Helper function to get content identifier
  const getContentIdentifier = (content) => {
    if (!content) return 'Unknown';
    return content.prefixed_id || `${content.content_type || content.type || 'item'}${content.id}` || 'Unknown';
  };

  return (
    <div className="chat_container" style={{border:"3px solid red"}}>
      <div className="top">
        <div className="user">
          <img src="./avatar.png" alt="Avatar" />
        </div>
        <div className="texts">
          <span>{activeContent?.user_id || activeContent?.created_by || "Admin"}</span>
          <p>{activeContent?.title || activeContent?.topic || "No title"}</p>
          <span className="content-id">ID: {getContentIdentifier(activeContent)}</span>
        </div>
        <div className="icons">
          <img src="./phone.png" alt="Phone" />
          <img src="./video.png" alt="Video" />
          <img src="./info.png" alt="Info" />
        </div>
      </div>

      <div className="center" style={{border:"3px solid yellow"}}>
        <div className="message-heading" style={{border:"5px solid brown"}}>
          <div className="content-header">
            <span className="content-type-badge">
              {activeContent?.content_type || activeContent?.type || activeItem?.type || 'content'}
            </span>
            <span className="content-id-display">
              {getContentIdentifier(activeContent)}
            </span>
          </div>
          
          <h3>Topic: {activeContent?.topic || activeContent?.title || "No topic"}</h3>
          <p>Descr: {activeContent?.description || activeContent?.summary || "No description"}</p>
          {activeContent?.subjectMatter && <p>Subject: {activeContent.subjectMatter}</p>}
          
          <div style={{border:"5px solid blue", display:"flex", flexDirection:"row", gap:"10px"}}>
            <p>Lesson #: {activeContent?.lessonNumber || activeContent?.id}</p>
            <p>Audience: {activeContent?.audience || "General"}</p>
            <p>Created By: {activeContent?.user_id || activeContent?.created_by || "Admin"}</p>
          </div>
          <p>Posted: {activeContent?.createdAt ? new Date(activeContent.createdAt).toLocaleString() : "Unknown date"}</p>
        </div>

        <div className="texts" style={{border:"5px solid green"}}>
          <p>{sanitizeMessage(activeContent?.text || activeContent?.content || "No content available")}</p>
          <span>Updated: {activeContent?.updatedAt ? new Date(activeContent.updatedAt).toLocaleString() : "Unknown date"}</span>
        </div>
          
        <div className="media-container" style={{border:"5px solid gray"}}>
          {renderMedia(activeContent?.media_url1, activeContent?.media_type1, "Media 1")}
          {renderMedia(activeContent?.media_url2, activeContent?.media_type2, "Media 2")}
          {renderMedia(activeContent?.media_url3, activeContent?.media_type3, "Media 3")}
        </div>

        {/* Comments Section */}
        <div className="comments-section" style={{border:"5px solid purple"}}>
          <h4>Comments</h4>
          {isLoadingComments ? (
            <p>Loading comments...</p>
          ) : (
            fetchedComments?.comments && Array.isArray(fetchedComments.comments) ? (
              fetchedComments.comments
                .filter((comment) => {
                  const contentId = activeContent?.id || activeItem?.id;
                  const contentType = activeContent?.content_type || activeContent?.type || activeItem?.type;
                  
                  if (contentType === "chat") {
                    return comment.chat_id === contentId;
                  } else if (contentType === "teaching") {
                    return comment.teaching_id === contentId;
                  }
                  return false;
                })
                .map((comment) => (
                  <div key={comment.id} className="message Own" style={{border:"5px solid pink"}}>
                    <div className="texts" style={{border:"5px solid magenta"}}>
                      <p>{sanitizeMessage(comment.comment)}</p>
                      <span>By: {comment.user_id}</span>
                      <span>{comment.createdAt ? new Date(comment.createdAt).toLocaleString() : "Unknown date"}</span>
                    </div>
                    <div className="media-container-comments" style={{border:"5px solid orange"}}>
                      {renderMedia(comment.media_url1, comment.media_type1, "Comment Media 1")}
                      {renderMedia(comment.media_url2, comment.media_type2, "Comment Media 2")}
                      {renderMedia(comment.media_url3, comment.media_type3, "Comment Media 3")}
                    </div>
                  </div>
                ))
            ) : (
              <p>No comments available</p>
            )
          )}
        </div>
      </div>

      <div className="bottom">
        <div className="toggle_buttons">
          <button className={!addMode ? 'active' : ''} onClick={() => setAddMode(false)}>Comment</button>
          <button className={addMode ? 'active' : ''} onClick={() => setAddMode(true)}>Start New Chat</button>
        </div>

        {!addMode ? (
          <form className="bottom_comment" onSubmit={handleSubmit(handleSendComment)} noValidate>
            <div className="step-indicator">
              Step {step + 1} of 4: {['Comment', 'Media 1', 'Media 2', 'Media 3'][step]}
            </div>
            
            <div className="icons">
              <img src="./img.png" alt="Upload" />
              <img src="./camera.png" alt="Camera" />
              <img src="./mic.png" alt="Mic" />
            </div>
            
            {step === 0 && (
              <input
                type="text"
                placeholder="Type a message..."
                {...register("comment", { required: "Comment is required" })}
              />
            )}
            {step === 1 && (
              <input
                type="file"
                multiple
                accept="image/*,video/*,audio/*"
                {...register("media1", { validate: validateFiles })}
              />
            )}
            {step === 2 && (
              <input
                type="file"
                multiple
                accept="image/*,video/*,audio/*"
                {...register("media2", { validate: validateFiles })}
              />
            )}
            {step === 3 && (
              <input
                type="file"
                multiple
                accept="image/*,video/*,audio/*"
                {...register("media3", { validate: validateFiles })}
              />
            )}
            
            <div className="emoji">
              <img src="./emoji.png" alt="Emoji Picker" onClick={() => setOpenEmoji(!openEmoji)} />
              {openEmoji && <EmojiPicker onEmojiClick={handleEmoji} />}
            </div>
            
            <div className="input-buttons">
              {step < 3 && <button type="button" onClick={handleNextStep}>Next</button>}
              {step > 0 && <button type="button" onClick={handlePrevStep}>Previous</button>}
            </div>
            <button className="SendButton" type="submit">Send Comment</button>
          </form>
        ) : (
          <form className="bottom_presentation" onSubmit={handleSubmit(handleSendChat)} noValidate>
            <div className="step-indicator">
              Step {step + 1} of 7: {['Title', 'Summary', 'Audience', 'Content', 'Media 1', 'Media 2', 'Media 3'][step]}
            </div>
            
            {step === 0 && (
              <input
                type="text"
                placeholder="Enter Title"
                {...register("title", { required: "Title is required" })}
              />
            )}
            {step === 1 && (
              <input
                type="text"
                placeholder="Enter Summary"
                {...register("summary", { required: "Summary is required" })}
              />
            )}
            {step === 2 && (
              <input
                type="text"
                placeholder="Enter Audience"
                {...register("audience", { required: "Audience is required" })}
              />
            )}
            {step === 3 && (
              <textarea
                placeholder="Enter Main Text"
                rows="4"
                {...register("text", { required: "Main text is required" })}
              />
            )}
            {step === 4 && (
              <input
                type="file"
                multiple
                accept="image/*,video/*,audio/*"
                {...register("media1", { validate: validateFiles })}
              />
            )}
            {step === 5 && (
              <input
                type="file"
                multiple
                accept="image/*,video/*,audio/*"
                {...register("media2", { validate: validateFiles })}
              />
            )}
            {step === 6 && (
              <input
                type="file"
                multiple
                accept="image/*,video/*,audio/*"
                {...register("media3", { validate: validateFiles })}
              />
            )}
            
            <div className="icons">
              <img src="./img.png" alt="Upload" />
              <img src="./camera.png" alt="Camera" />
              <img src="./mic.png" alt="Mic" />
            </div>
            
            <div className="input-buttons">
              {step < 6 && <button type="button" onClick={handleNextStep}>Next</button>}
              {step > 0 && <button type="button" onClick={handlePrevStep}>Previous</button>}
            </div>
            <button className="SendButton" type="submit">Create Chat</button>
          </form>
        )}
      </div>
    </div>
  );
};

export default Chat;

//==================================
//debug and config FOLDER
//===================================


// ikootaclient/src/components/debug/DebugUserInfo.jsx
// ✅ DEBUG COMPONENT - Add this temporarily to see user state

import React from 'react';
import { useUser } from '../auth/UserStatus';
import { getUserAccess, getUserStatusString } from '../config/accessMatrix';

const DebugUserInfo = () => {
  const { user, isAuthenticated, loading, error, membershipStatus } = useUser();

  if (!process.env.NODE_ENV || process.env.NODE_ENV === 'development') {
    return (
      <div style={{
        position: 'fixed',
        top: '10px',
        right: '10px',
        background: '#f0f0f0',
        border: '1px solid #ccc',
        padding: '10px',
        fontSize: '12px',
        maxWidth: '300px',
        zIndex: 9999,
        borderRadius: '5px'
      }}>
        <h4>🐛 Debug Info</h4>
        <div><strong>Loading:</strong> {loading ? 'Yes' : 'No'}</div>
        <div><strong>Authenticated:</strong> {isAuthenticated ? 'Yes' : 'No'}</div>
        <div><strong>Membership Status:</strong> {membershipStatus}</div>
        <div><strong>Error:</strong> {error || 'None'}</div>
        
        {user && (
          <>
            <div><strong>User ID:</strong> {user.user_id}</div>
            <div><strong>Username:</strong> {user.username}</div>
            <div><strong>Role:</strong> {user.role}</div>
            <div><strong>Member Status:</strong> {user.is_member}</div>
            <div><strong>Membership Stage:</strong> {user.membership_stage}</div>
            <div><strong>User Status:</strong> {getUserStatusString(user)}</div>
            <div><strong>Default Route:</strong> {getUserAccess(user).defaultRoute}</div>
            <div><strong>Survey Completed:</strong> {user.survey_completed ? 'Yes' : 'No'}</div>
            <div><strong>Needs Survey:</strong> {user.needs_survey ? 'Yes' : 'No'}</div>
          </>
        )}
        
        {!user && <div>No user data</div>}
      </div>
    );
  }

  return null;
};

export default DebugUserInfo;


//========================================

// ikootaclient/src/components/config/accessMatrix.js
// ✅ STANDARDIZED VERSION - Two Clear Levels: pre_member and member

const ACCESS_MATRIX = {
  // Super Admin - Full access to everything
  super_admin: {
    routes: ['/', '/admin/*', '/iko', '/towncrier', '/application-survey', '/dashboard', '/full-membership/*'],
    api_endpoints: ['ALL'],
    default_redirect: '/admin',
    dashboard_redirect: '/dashboard',
    permissions: ['admin', 'iko', 'towncrier', 'dashboard', 'membership_management', 'all'],
    userType: 'admin',
    canAccess: {
      iko: true,
      towncrier: true,
      admin: true,
      dashboard: true,
      membershipApplication: true
    }
  },

  // Admin - Most access
  admin: {
    routes: ['/', '/admin/*', '/iko', '/towncrier', '/dashboard', '/full-membership/*'],
    api_endpoints: [
      '/admin/*',
      '/membership/*', 
      '/users/*',
      '/classes/*',
      '/teachings/*',
      '/chats/*'
    ],
    default_redirect: '/admin',
    dashboard_redirect: '/dashboard',
    permissions: ['admin', 'iko', 'towncrier', 'dashboard', 'membership_management'],
    userType: 'admin',
    canAccess: {
      iko: true,
      towncrier: true,
      admin: true,
      dashboard: true,
      membershipApplication: true
    }
  },

  // ✅ MEMBER - Full access (highest non-admin level)
  member: {
    conditions: {
      membership_stage: 'member',
      is_member: 'member',
      status: 'member'
    },
    routes: ['/', '/iko', '/towncrier', '/dashboard', '/profile'],
    api_endpoints: [
      '/teachings/*',
      '/chats/*',
      '/users/profile',
      '/membership/dashboard'
    ],
    default_redirect: '/iko',
    dashboard_redirect: '/dashboard',
    permissions: ['iko', 'towncrier', 'dashboard'],
    userType: 'member',
    canAccess: {
      iko: true,
      towncrier: true,
      admin: false,
      dashboard: true,
      membershipApplication: false // Already a member
    }
  },

  // ✅ PRE-MEMBER with Pending Membership Application
  pre_member_pending_upgrade: {
    conditions: {
      status: 'pre_member_pending_upgrade',
      membershipApplicationStatus: 'pending'
    },
    routes: ['/', '/towncrier', '/dashboard', '/full-membership/status', '/full-membership/pending'],
    api_endpoints: [
      '/teachings/*',
      '/membership/dashboard',
      '/membership/full-membership-status/*'
    ],
    default_redirect: '/towncrier',
    dashboard_redirect: '/dashboard',
    permissions: ['towncrier', 'dashboard', 'membership_status'],
    userType: 'pre_member',
    canAccess: {
      iko: false,
      towncrier: true,
      admin: false,
      dashboard: true,
      membershipApplication: false // Cannot apply while pending
    },
    statusMessage: 'Your membership application is under review'
  },

  // ✅ PRE-MEMBER with Declined Application (can reapply)
  pre_member_can_reapply: {
    conditions: {
      status: 'pre_member_can_reapply',
      membershipApplicationStatus: 'declined'
    },
    routes: ['/', '/towncrier', '/dashboard', '/full-membership/info', '/full-membership/apply', '/full-membership/declined'],
    api_endpoints: [
      '/teachings/*',
      '/membership/dashboard',
      '/membership/full-membership-status/*',
      '/membership/full-membership/apply'
    ],
    default_redirect: '/towncrier',
    dashboard_redirect: '/dashboard',
    permissions: ['towncrier', 'dashboard', 'membership_reapply'],
    userType: 'pre_member',
    canAccess: {
      iko: false,
      towncrier: true,
      admin: false,
      dashboard: true,
      membershipApplication: true // Can reapply
    },
    statusMessage: 'You can reapply for full membership'
  },

  // ✅ PRE-MEMBER - Eligible for membership application
  pre_member: {
    conditions: {
      membership_stage: 'pre_member',
      status: 'pre_member',
      membershipApplicationStatus: ['not_applied', null, undefined]
    },
    routes: ['/', '/towncrier', '/dashboard', '/full-membership/info', '/full-membership/apply'],
    api_endpoints: [
      '/teachings/*',
      '/membership/dashboard',
      '/membership/full-membership-status/*',
      '/membership/full-membership/apply'
    ],
    default_redirect: '/towncrier',
    dashboard_redirect: '/dashboard',
    permissions: ['towncrier', 'dashboard', 'membership_apply'],
    userType: 'pre_member',
    canAccess: {
      iko: false,
      towncrier: true,
      admin: false,
      dashboard: true,
      membershipApplication: true // Can apply
    },
    statusMessage: 'You are eligible to apply for full membership'
  },

  // Applicant - Very limited access
  applicant: {
    conditions: {
      membership_stage: 'applicant'
    },
    routes: ['/', '/towncrier', '/application-survey', '/application-status', '/dashboard'],
    api_endpoints: [
      '/membership/survey/*',
      '/teachings/*'
    ],
    default_redirect: '/application-survey',
    dashboard_redirect: '/dashboard',
    permissions: ['towncrier', 'dashboard'],
    userType: 'applicant',
    canAccess: {
      iko: false,
      towncrier: true,
      admin: false,
      dashboard: true,
      membershipApplication: false
    }
  },

  // Applied/Pending users (initial application)
  applied: {
    conditions: {
      is_member: ['applied', 'pending']
    },
    routes: ['/', '/towncrier', '/application-status', '/pending-verification', '/dashboard'],
    api_endpoints: [
      '/membership/survey/*',
      '/teachings/*'
    ],
    default_redirect: '/towncrier',
    dashboard_redirect: '/dashboard',
    permissions: ['towncrier', 'dashboard'],
    userType: 'pending',
    canAccess: {
      iko: false,
      towncrier: true,
      admin: false,
      dashboard: true,
      membershipApplication: false
    }
  },

  // Non-authenticated users
  guest: {
    routes: ['/', '/login', '/register', '/signup', '/forgot-password'],
    api_endpoints: [
      '/auth/*',
      '/teachings/public'
    ],
    default_redirect: '/login',
    dashboard_redirect: '/login',
    permissions: [],
    userType: 'guest',
    canAccess: {
      iko: false,
      towncrier: true,
      admin: false,
      dashboard: false,
      membershipApplication: false
    }
  }
};

// ✅ STANDARDIZED: Helper function with clear member/pre_member logic
const checkUserAccess = (user, requestedRoute = null, requestedEndpoint = null) => {
  if (!user) {
    return ACCESS_MATRIX.guest;
  }

  console.log('🔍 Checking user access with standardized levels for:', {
    role: user.role,
    membership_stage: user.membership_stage,
    is_member: user.is_member,
    status: user.status,
    membershipApplicationStatus: user.membershipApplicationStatus
  });

  const role = user.role?.toLowerCase();
  const status = user.status || user.finalStatus;

  // ✅ Admin checks (preserved from original)
  if (role === 'super_admin' && ACCESS_MATRIX.super_admin) {
    console.log('👑 Super admin access granted');
    return ACCESS_MATRIX.super_admin;
  }
  
  if (role === 'admin' && ACCESS_MATRIX.admin) {
    console.log('👑 Admin access granted');
    return ACCESS_MATRIX.admin;
  }

  // ✅ STANDARDIZED: Status-based access
  switch (status) {
    case 'member':
      console.log('💎 Member access granted');
      return ACCESS_MATRIX.member;
      
    case 'pre_member_pending_upgrade':
      console.log('⏳ Pre-member with pending upgrade access');
      return ACCESS_MATRIX.pre_member_pending_upgrade;
      
    case 'pre_member_can_reapply':
      console.log('🔄 Pre-member can reapply access');
      return ACCESS_MATRIX.pre_member_can_reapply;
      
    case 'pre_member':
      console.log('👤 Pre-member access granted');
      return ACCESS_MATRIX.pre_member;
      
    case 'pending_verification':
    case 'applied':
      console.log('⏳ Applied/Pending access granted');
      return ACCESS_MATRIX.applied;
      
    default:
      console.log('📝 Default applicant access granted');
      return ACCESS_MATRIX.applicant;
  }
};

// ✅ STANDARDIZED: Usage function (preserving original structure)
const getUserAccess = (userData) => {
  if (!userData) {
    return {
      userType: 'guest',
      defaultRoute: '/',
      dashboardRoute: '/login',
      permissions: [],
      canAccess: ACCESS_MATRIX.guest.canAccess,
      canAccessIko: false,
      canAccessAdmin: false,
      canAccessTowncrier: true,
      canApplyForMembership: false,
      membershipApplicationStatus: 'not_eligible',
      allowedRoutes: ACCESS_MATRIX.guest.routes,
      allowedEndpoints: ACCESS_MATRIX.guest.api_endpoints
    };
  }

  const access = checkUserAccess(userData);
  
  return {
    userType: access.userType,
    defaultRoute: access.default_redirect,
    dashboardRoute: access.dashboard_redirect,
    permissions: access.permissions || [],
    canAccess: access.canAccess,
    statusMessage: access.statusMessage,
    
    // ✅ PRESERVED: Original properties
    canAccessIko: access.routes.includes('/iko'),
    canAccessAdmin: access.routes.some(route => route.startsWith('/admin')),
    canAccessTowncrier: access.routes.includes('/towncrier'),
    
    // ✅ STANDARDIZED: Membership properties
    canApplyForMembership: access.canAccess?.membershipApplication === true && 
                          userData.membershipApplicationStatus === 'not_applied',
    canReapplyForMembership: access.canAccess?.membershipApplication === true && 
                            userData.membershipApplicationStatus === 'declined',
    membershipApplicationStatus: userData.membershipApplicationStatus || 'not_applied',
    membershipTicket: userData.membershipTicket,
    
    allowedRoutes: access.routes,
    allowedEndpoints: access.api_endpoints
  };
};

// ✅ STANDARDIZED: Membership application route function
export const getMembershipApplicationRoute = (userData) => {
  const access = getUserAccess(userData);
  const status = userData?.membershipApplicationStatus;
  
  switch (status) {
    case 'not_applied':
      return access.canApplyForMembership ? '/full-membership/info' : '/towncrier';
    case 'pending':
      return '/full-membership/pending';
    case 'approved':
      return '/iko'; // Members go to Iko
    case 'declined':
      return '/full-membership/declined';
    default:
      return '/dashboard';
  }
};

export const canAccessMembershipFeature = (userData, feature) => {
  const access = getUserAccess(userData);
  
  switch (feature) {
    case 'apply':
      return access.canApplyForMembership;
    case 'reapply':
      return access.canReapplyForMembership;
    case 'status':
      return access.userType !== 'guest';
    case 'iko_chat':
      return access.canAccessIko;
    default:
      return false;
  }
};

// ✅ PRESERVED: Route checking from original
export const canAccessRoute = (userData, route) => {
  const access = getUserAccess(userData);
  
  // Check direct route access
  if (access.allowedRoutes.includes(route)) {
    return true;
  }
  
  // Check wildcard routes
  const hasWildcardAccess = access.allowedRoutes.some(allowedRoute => {
    if (allowedRoute.endsWith('/*')) {
      const basePath = allowedRoute.replace('/*', '');
      return route.startsWith(basePath);
    }
    return false;
  });
  
  if (hasWildcardAccess) {
    return true;
  }
  
  // ✅ STANDARDIZED: Membership route checks
  if (route.startsWith('/full-membership/')) {
    const subRoute = route.replace('/full-membership/', '');
    
    switch (subRoute) {
      case 'info':
      case 'apply':
        return access.canApplyForMembership || access.canReapplyForMembership;
      case 'pending':
        return userData?.membershipApplicationStatus === 'pending';
      case 'approved':
        return userData?.membershipApplicationStatus === 'approved';
      case 'declined':
        return userData?.membershipApplicationStatus === 'declined';
      case 'status':
        return access.userType !== 'guest';
      default:
        return access.canAccess.membershipApplication;
    }
  }
  
  // ✅ PRESERVED: Original route checks
  switch (route) {
    case '/admin':
      return access.canAccess.admin;
    case '/iko':
      return access.canAccess.iko;
    case '/towncrier':
      return access.canAccess.towncrier;
    case '/dashboard':
      return access.canAccess.dashboard;
    default:
      return false;
  }
};

// ✅ STANDARDIZED: User status with clear levels (updated for member vs full_member)
export const getUserStatusString = (userData) => {
  if (!userData) return 'guest';
  
  const role = userData.role?.toLowerCase();
  const memberStatus = userData.is_member?.toLowerCase();
  const membershipStage = userData.membership_stage?.toLowerCase();
  const status = userData.status || userData.finalStatus;

  // Admin users
  if (role === 'admin' || role === 'super_admin') return 'admin';
  
  // ✅ STANDARDIZED: Member (no more "full_member")
  if (status === 'member' || 
      (memberStatus === 'member' && membershipStage === 'member')) {
    return 'member';
  }
  
  // ✅ STANDARDIZED: Pre-member states
  if (status === 'pre_member_pending_upgrade') return 'pre_member_pending_upgrade';
  if (status === 'pre_member_can_reapply') return 'pre_member_can_reapply';
  
  if (status === 'pre_member' || 
      memberStatus === 'approved' && membershipStage === 'pre' ||
      membershipStage === 'pre_member') {
    return 'pre_member';
  }
  
  // Pending/Applied
  if (memberStatus === 'applied' || memberStatus === 'pending') return 'pending_verification';
  
  // Denied
  if (memberStatus === 'declined' || memberStatus === 'denied') return 'denied';
  
  return 'authenticated';
};

// ✅ PRESERVED: Dashboard route function
export const getDashboardRoute = (userData) => {
  const access = getUserAccess(userData);
  return access.dashboardRoute || '/dashboard';
};

// ✅ PRESERVED: Default route function
export const getDefaultRoute = (userData) => {
  const access = getUserAccess(userData);
  return access.defaultRoute;
};

// ✅ PRESERVED: Endpoint access check
export const canAccessEndpoint = (userData, endpoint) => {
  const access = checkUserAccess(userData);
  
  if (access.api_endpoints.includes('ALL')) {
    return true;
  }
  
  if (access.api_endpoints.includes(endpoint)) {
    return true;
  }
  
  return access.api_endpoints.some(allowedEndpoint => {
    if (allowedEndpoint.endsWith('/*')) {
      const basePath = allowedEndpoint.replace('/*', '');
      return endpoint.startsWith(basePath);
    }
    return false;
  });
};

// ✅ PRESERVED: Export everything (maintaining backward compatibility)
export { 
  ACCESS_MATRIX, 
  checkUserAccess, 
  getUserAccess 
};

// ✅ PRESERVED: Default export for modern import styles
export default {
  ACCESS_MATRIX,
  checkUserAccess,
  getUserAccess,
  getDefaultRoute,
  getDashboardRoute,
  canAccessRoute,
  getUserStatusString,
  canAccessEndpoint,
  getMembershipApplicationRoute,
  canAccessMembershipFeature
};

//===========================================
//auth FOLDER
//============================================

// ikootaclient/src/components/auth/UserStatus.jsx - FIXED LOGIC
import React, { createContext, useContext, useState, useEffect, useRef } from 'react';
import { jwtDecode } from 'jwt-decode';
import api from '../service/api';

const UserContext = createContext();

export const useUser = () => {
  const context = useContext(UserContext);
  if (!context) {
    throw new Error('useUser must be used within a UserProvider');
  }
  return context;
};

// ✅ STANDARDIZED: Two clear levels - pre_member and member
const determineUserStatus = ({ 
  role, 
  memberStatus, 
  membershipStage, 
  userId, 
  approvalStatus,
  fullMembershipApplicationStatus, // This tracks the APPLICATION, not a separate membership level
  fullMembershipAppliedAt 
}) => {
  console.log('🔍 Status determination with standardized levels:', { 
    role, memberStatus, membershipStage, userId, approvalStatus, fullMembershipApplicationStatus 
  });

  // Normalize empty strings
  const normalizedMemberStatus = memberStatus === '' ? null : memberStatus;
  const normalizedMembershipStage = membershipStage === '' ? null : membershipStage;
  const normalizedRole = role === '' ? 'user' : role;
  const normalizedApplicationStatus = fullMembershipApplicationStatus === '' ? 'not_applied' : fullMembershipApplicationStatus;

  console.log('🔧 Normalized values:', { 
    normalizedRole, 
    normalizedMemberStatus, 
    normalizedMembershipStage, 
    approvalStatus,
    normalizedApplicationStatus
  });

  // ✅ Admin check
  if (normalizedRole === 'admin' || normalizedRole === 'super_admin') {
    console.log('👑 Admin user detected');
    return {
      isMember: true, // Admins have full access
      isPendingMember: false,
      userType: 'admin',
      status: 'admin',
      canApplyForMembership: false,
      membershipApplicationStatus: 'admin_exempt',
      canAccessTowncrier: true,
      canAccessIko: true
    };
  }

  // ✅ FULL MEMBER CHECK (member level - highest non-admin level)
  if (normalizedMemberStatus === 'member' && normalizedMembershipStage === 'member') {
    console.log('💎 Full member detected');
    return {
      isMember: true,
      isPendingMember: false,
      userType: 'member',
      status: 'member',
      canApplyForMembership: false,
      membershipApplicationStatus: 'approved', // They already are members
      canAccessTowncrier: true,
      canAccessIko: true
    };
  }

  // ✅ PRE-MEMBER WITH MEMBERSHIP APPLICATION LOGIC
  if (normalizedMemberStatus === 'pre_member' || 
      normalizedMembershipStage === 'pre_member' ||
      (normalizedMemberStatus === 'granted' && normalizedMembershipStage === 'pre_member') ||
      ((normalizedMemberStatus === 'applied' || normalizedMemberStatus === null) && 
       (approvalStatus === 'granted' || approvalStatus === 'approved'))) {
    
    console.log('👤 Pre-member detected, checking membership application status...');
    
    // Handle different application states for pre-members
    switch (normalizedApplicationStatus) {
      case 'pending':
        console.log('⏳ Pre-member with pending membership application');
        return {
          isMember: false,
          isPendingMember: true,
          userType: 'pre_member',
          status: 'pre_member_pending_upgrade',
          canApplyForMembership: false, // Already applied
          membershipApplicationStatus: 'pending',
          canAccessTowncrier: true,
          canAccessIko: false
        };
        
      case 'approved':
        // If application approved, they should be upgraded to member
        console.log('✅ Pre-member with approved application - should be member now');
        return {
          isMember: true,
          isPendingMember: false,
          userType: 'member',
          status: 'member',
          canApplyForMembership: false,
          membershipApplicationStatus: 'approved',
          canAccessTowncrier: true,
          canAccessIko: true
        };
        
      case 'declined':
        console.log('❌ Pre-member with declined application');
        return {
          isMember: false,
          isPendingMember: true,
          userType: 'pre_member',
          status: 'pre_member_can_reapply',
          canApplyForMembership: true, // Can reapply
          membershipApplicationStatus: 'declined',
          canAccessTowncrier: true,
          canAccessIko: false
        };
        
      case 'not_applied':
      default:
        console.log('📝 Pre-member eligible for membership application');
        return {
          isMember: false,
          isPendingMember: true,
          userType: 'pre_member',
          status: 'pre_member',
          canApplyForMembership: true,
          membershipApplicationStatus: 'not_applied',
          canAccessTowncrier: true,
          canAccessIko: false
        };
    }
  }

  // ✅ Applied/Pending check (for initial applications)
  if (normalizedMemberStatus === 'applied' || normalizedMemberStatus === 'pending' || normalizedMemberStatus === null) {
    console.log('⏳ Applicant detected');
    return {
      isMember: false,
      isPendingMember: true,
      userType: 'applicant',
      status: 'pending_verification',
      canApplyForMembership: false,
      membershipApplicationStatus: 'not_eligible',
      canAccessTowncrier: false,
      canAccessIko: false
    };
  }
  
  // Denied/Suspended check
  if (normalizedMemberStatus === 'denied' || normalizedMemberStatus === 'suspended' || normalizedMemberStatus === 'declined') {
    console.log('❌ Denied user detected');
    return {
      isMember: false,
      isPendingMember: false,
      userType: 'denied',
      status: 'denied',
      canApplyForMembership: false,
      membershipApplicationStatus: 'not_eligible',
      canAccessTowncrier: false,
      canAccessIko: false
    };
  }

  // Default fallback
  console.log('⚠️ Using fallback status for authenticated user');
  return {
    isMember: false,
    isPendingMember: false,
    userType: 'authenticated',
    status: 'authenticated',
    canApplyForMembership: false,
    membershipApplicationStatus: 'unknown',
    canAccessTowncrier: false,
    canAccessIko: false
  };
};

export const UserProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  const [membershipStatus, setMembershipStatus] = useState('not loaded');
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  const initializationRef = useRef(false);
  const membershipFetchRef = useRef(false);
  const lastFetchTime = useRef(0);
  const RATE_LIMIT_MS = 5000;

  console.log('🚀 Initializing UserProvider with standardized levels');

  const updateUserState = (newState) => {
    console.log('👤 User state updated:', newState);
    setUser(newState.user || null);
    setMembershipStatus(newState.membershipStatus || 'not loaded');
    setLoading(newState.loading || false);
    setError(newState.error || null);
  };

  // ✅ RENAMED: Fetch membership application status (not a separate membership level)
  const fetchMembershipApplicationStatus = async (userId) => {
    try {
      const response = await api.get(`/membership/full-membership-status/${userId}`);
      console.log('✅ Membership application status response:', response.data);
      return {
        membershipApplicationStatus: response.data.status || 'not_applied',
        membershipAppliedAt: response.data.appliedAt,
        membershipReviewedAt: response.data.reviewedAt,
        membershipTicket: response.data.ticket,
        membershipAdminNotes: response.data.adminNotes
      };
    } catch (error) {
      console.log('⚠️ Membership application status not available:', error.message);
      return {
        membershipApplicationStatus: 'not_applied',
        membershipAppliedAt: null,
        membershipReviewedAt: null,
        membershipTicket: null,
        membershipAdminNotes: null
      };
    }
  };

  // ✅ STANDARDIZED: fetchMembershipStatus
  const fetchMembershipStatus = async () => {
    const now = Date.now();
    if (now - lastFetchTime.current < RATE_LIMIT_MS) {
      console.log('🚫 Rate limited - skipping membership status fetch');
      return;
    }

    if (membershipFetchRef.current) {
      console.log('🚫 Membership fetch already in progress');
      return;
    }

    membershipFetchRef.current = true;
    lastFetchTime.current = now;

    console.log('🔍 Fetching comprehensive membership status...');
    
    try {
      const tokenData = getTokenUserData();
      if (!tokenData) {
        console.log('❌ No token data available');
        membershipFetchRef.current = false;
        return;
      }

      // Fetch both initial status and membership application status
      const [surveyResponse, membershipApplicationData] = await Promise.allSettled([
        api.get('/membership/survey/check-status'),
        fetchMembershipApplicationStatus(tokenData.user_id)
      ]);

      let surveyData = {};
      if (surveyResponse.status === 'fulfilled') {
        surveyData = surveyResponse.value.data;
      }

      let membershipApplicationInfo = {};
      if (membershipApplicationData.status === 'fulfilled') {
        membershipApplicationInfo = membershipApplicationData.value;
      }

      // ✅ STANDARDIZED: Combine all data sources
      const combinedUserData = {
        user_id: tokenData.user_id,
        username: tokenData.username,
        email: tokenData.email,
        membership_stage: tokenData.membership_stage,
        is_member: tokenData.is_member,
        role: tokenData.role,
        // Initial membership data
        survey_completed: surveyData.survey_completed,
        approval_status: surveyData.approval_status,
        needs_survey: surveyData.needs_survey,
        survey_data: surveyData.survey_data,
        // ✅ STANDARDIZED: Membership application data (not separate membership level)
        ...membershipApplicationInfo
      };

      console.log('✅ Combined user data with membership application status:', combinedUserData);

      // ✅ STANDARDIZED: Status determination
      const statusResult = determineUserStatus({
        role: combinedUserData.role,
        memberStatus: combinedUserData.is_member,
        membershipStage: combinedUserData.membership_stage,
        userId: combinedUserData.user_id,
        approvalStatus: combinedUserData.approval_status,
        fullMembershipApplicationStatus: combinedUserData.membershipApplicationStatus,
        fullMembershipAppliedAt: combinedUserData.membershipAppliedAt
      });

      console.log('✅ Standardized status determined:', statusResult);

      let finalStatus = statusResult.status;

      // Additional checks for survey requirements (excluding admins and members)
      if (finalStatus !== 'admin' && finalStatus !== 'member') {
        if (surveyData.needs_survey === true || surveyData.survey_completed === false) {
          finalStatus = 'needs_application';
          console.log('🚨 User needs to complete initial application survey');
        }
      }

      updateUserState({
        user: {
          ...combinedUserData,
          ...statusResult,
          finalStatus
        },
        membershipStatus: 'loaded',
        status: finalStatus,
        loading: false,
        error: null
      });

    } catch (error) {
      console.error('❌ Error fetching membership status:', error);
      
      const tokenData = getTokenUserData();
      if (tokenData) {
        const fallbackStatus = determineUserStatus({
          role: tokenData.role,
          memberStatus: tokenData.is_member,
          membershipStage: tokenData.membership_stage,
          userId: tokenData.user_id,
          approvalStatus: null,
          fullMembershipApplicationStatus: 'not_applied'
        });
        
        updateUserState({
          user: {
            ...tokenData,
            ...fallbackStatus
          },
          membershipStatus: 'error',
          status: fallbackStatus.status,
          loading: false,
          error: `API Error: ${error.message}`
        });
      } else {
        updateUserState({
          user: null,
          membershipStatus: 'error',
          status: 'error',
          loading: false,
          error: error.message
        });
      }
    } finally {
      membershipFetchRef.current = false;
    }
  };

  const getTokenUserData = () => {
    const token = localStorage.getItem('token');
    if (!token) return null;

    try {
      const decoded = jwtDecode(token);
      
      if (decoded.exp * 1000 < Date.now()) {
        console.log('⚠️ Token expired, removing...');
        localStorage.removeItem('token');
        return null;
      }

      console.log('🔍 Token user data:', decoded);
      return decoded;
    } catch (error) {
      console.error('❌ Error decoding token:', error);
      localStorage.removeItem('token');
      return null;
    }
  };

  const initializeUser = async () => {
    if (initializationRef.current) {
      console.log('🚫 User already initialized');
      return;
    }

    initializationRef.current = true;
    console.log('🔄 Initializing user with standardized levels...');

    const tokenData = getTokenUserData();
    
    if (!tokenData) {
      console.log('❌ No valid token found');
      updateUserState({
        user: null,
        membershipStatus: 'not loaded',
        status: 'guest',
        loading: false,
        error: null
      });
      return;
    }

    const initialStatus = determineUserStatus({
      role: tokenData.role,
      memberStatus: tokenData.is_member,
      membershipStage: tokenData.membership_stage,
      userId: tokenData.user_id,
      approvalStatus: null,
      fullMembershipApplicationStatus: 'not_applied'
    });

    updateUserState({
      user: {
        ...tokenData,
        ...initialStatus
      },
      membershipStatus: 'loading',
      status: initialStatus.status,
      loading: true,
      error: null
    });

    await fetchMembershipStatus();
  };

  useEffect(() => {
    if (!initializationRef.current) {
      initializeUser();
    }
  }, []);

  const isAuthenticated = () => {
    return !!user && !!localStorage.getItem('token');
  };

  const getUserStatus = () => {
    if (!user) return 'guest';
    
    if (user.finalStatus) {
      return user.finalStatus;
    }
    
    if (user.status) {
      return user.status;
    }
    
    const fallbackStatus = determineUserStatus({
      role: user.role,
      memberStatus: user.is_member,
      membershipStage: user.membership_stage,
      userId: user.user_id,
      approvalStatus: user.approval_status,
      fullMembershipApplicationStatus: user.membershipApplicationStatus || 'not_applied'
    });
    
    return fallbackStatus.status;
  };

  const refreshUser = async () => {
    console.log('🔄 Refreshing user data...');
    
    const now = Date.now();
    if (now - lastFetchTime.current > RATE_LIMIT_MS) {
      membershipFetchRef.current = false;
      await fetchMembershipStatus();
    } else {
      console.log('🚫 Refresh rate limited');
    }
  };

  const logout = () => {
    localStorage.removeItem('token');
    
    initializationRef.current = false;
    membershipFetchRef.current = false;
    lastFetchTime.current = 0;
    
    updateUserState({
      user: null,
      membershipStatus: 'not loaded',
      status: 'guest',
      loading: false,
      error: null
    });
  };

  // ✅ FIXED: Context value with correct member/pre_member distinction
  const value = {
    user,
    membershipStatus,
    loading,
    error,
    isAuthenticated: isAuthenticated(),
    getUserStatus,
    refreshUser,
    updateUser: refreshUser,
    logout,
    // ✅ FIXED: Clear status checks based on the actual user status
    isAdmin: () => getUserStatus() === 'admin',
    isMember: () => {
      const status = getUserStatus();
      // ✅ FIXED: Only return true for actual full members
      return status === 'member';
    },
    isPreMember: () => {
      const status = getUserStatus();
      return status === 'pre_member' || status === 'pre_member_pending_upgrade' || status === 'pre_member_can_reapply';
    },
    // ✅ FIXED: isPending should return true for pre-members (they are "pending" full membership)
    isPending: () => {
      const status = getUserStatus();
      return status === 'pre_member' || status === 'pre_member_pending_upgrade' || status === 'pre_member_can_reapply' || status === 'pending_verification';
    },
    needsApplication: () => getUserStatus() === 'needs_application',
    // ✅ STANDARDIZED: Application status checks
    isPendingUpgrade: () => getUserStatus() === 'pre_member_pending_upgrade',
    canReapplyForMembership: () => getUserStatus() === 'pre_member_can_reapply',
    canApplyForMembership: () => user?.canApplyForMembership === true,
    getMembershipApplicationStatus: () => user?.membershipApplicationStatus || 'not_applied',
    getMembershipTicket: () => user?.membershipTicket || null,
    canAccessIko: () => user?.canAccessIko === true,
    canAccessTowncrier: () => user?.canAccessTowncrier === true
  };

  return (
    <UserContext.Provider value={value}>
      {children}
    </UserContext.Provider>
  );
};


//===========================================

// ikootaclient/src/components/auth/Signup.jsx - COMPLETE FIXED WITH ENHANCED DEBUGGING
import React, { useState } from "react";
import { Link, useNavigate } from "react-router-dom";
import axios from "axios";
import './signup.css';

const Signup = () => {
  const [values, setValues] = useState({
    username: "",
    email: "",
    password: "",
    confirmPassword: "",
    phone: "",
  });
  
  const [verificationStep, setVerificationStep] = useState('form'); // 'form', 'verification', 'success'
  const [verificationMethod, setVerificationMethod] = useState(''); // 'email' or 'phone'
  const [verificationCode, setVerificationCode] = useState('');
  const [loading, setLoading] = useState(false);
  const [devCode, setDevCode] = useState(''); // For development
  
  axios.defaults.withCredentials = true;
  const navigate = useNavigate();

  // Step 1: Submit initial signup form and send verification code
  const handleInitialSubmit = async (event) => {
    event.preventDefault();
    
    // Validation
    if (values.password !== values.confirmPassword) {
      alert("Passwords do not match!");
      return;
    }
    
    if (!values.username || !values.email || !values.password || !values.phone) {
      alert("Please fill in all required fields!");
      return;
    }
    
    if (!verificationMethod) {
      alert("Please select a verification method!");
      return;
    }

    try {
      setLoading(true);
      
      console.log('🔍 Sending verification request:', {
        email: values.email,
        phone: values.phone,
        method: verificationMethod
      });
      
      // ✅ UPDATED: Use auth endpoint instead of membership endpoint
      const verificationResponse = await axios.post("http://localhost:3000/api/auth/send-verification", {
        email: values.email,
        phone: values.phone,
        method: verificationMethod, // ✅ Use 'method' to match database
        username: values.username
      });
      
      console.log('✅ Verification response:', verificationResponse.data);
      
      if (verificationResponse.status === 200) {
        // ✅ Store dev code if provided (development mode)
        if (verificationResponse.data.devCode) {
          setDevCode(verificationResponse.data.devCode);
          console.log('🛠️ Dev code received:', verificationResponse.data.devCode);
        }
        
        setVerificationStep('verification');
        alert(`Verification code sent to your ${verificationMethod}!`);
      }
    } catch (err) {
      console.error('❌ Verification error:', err);
      
      let errorMessage = 'Failed to send verification code.';
      
      if (err.response?.status === 404) {
        errorMessage = 'The verification endpoint is not available. Please check the server.';
      } else if (err.response?.data?.error) {
        errorMessage = err.response.data.error;
      } else if (err.response?.data?.message) {
        errorMessage = err.response.data.message;
      }
      
      alert(`${errorMessage} Please try again.`);
    } finally {
      setLoading(false);
    }
  };

  // ✅ ENHANCED: Step 2 - Verify code and complete registration with extensive debugging
  const handleVerificationSubmit = async (event) => {
    event.preventDefault();
    
    if (!verificationCode) {
      alert("Please enter the verification code!");
      return;
    }

    try {
      setLoading(true);
      
      // ✅ ENHANCED: Clean and validate the verification code
      const cleanedCode = verificationCode.trim();
      
      const requestData = {
        username: values.username,
        email: values.email,
        password: values.password,
        phone: values.phone,
        verificationCode: cleanedCode,
        verificationMethod
      };
      
      console.log('🔍 Submitting registration with data:', {
        ...requestData,
        password: '***HIDDEN***' // Don't log the actual password
      });
      
      // ✅ ENHANCED: Log verification code details for debugging
      console.log('🔍 Verification code details:', {
        original: verificationCode,
        trimmed: cleanedCode,
        length: cleanedCode.length,
        type: typeof cleanedCode,
        charCodes: [...cleanedCode].map(char => char.charCodeAt(0)),
        isNumeric: /^\d+$/.test(cleanedCode),
        devCodeMatch: devCode ? (cleanedCode === devCode) : 'No dev code available'
      });
      
      // ✅ ENHANCED: Additional validation
      if (cleanedCode.length !== 6) {
        alert("Verification code must be exactly 6 digits!");
        return;
      }
      
      if (!/^\d+$/.test(cleanedCode)) {
        alert("Verification code must contain only numbers!");
        return;
      }
      
      // ✅ UPDATED: Use auth endpoint instead of membership endpoint
      const registerResponse = await axios.post("http://localhost:3000/api/auth/register", requestData, { 
        withCredentials: true 
      });
      
      console.log('✅ Registration response:', registerResponse.data);
      
      if (registerResponse.status === 201) {
        setVerificationStep('success');
        
        // Use server-provided application ticket or generate fallback
        const applicationTicket = registerResponse.data.user?.application_ticket || 
                                generateApplicationTicket(values.username, values.email);
        
        setTimeout(() => {
          navigate('/application-thankyou', { 
            state: { 
              applicationTicket,
              username: values.username,
              userId: registerResponse.data.user?.id
            }
          });
        }, 2000);
      }
    } catch (err) {
      console.error('❌ Registration error:', err);
      console.error('❌ Full error response:', err.response);
      
      // ✅ ENHANCED: Enhanced error logging and debugging
      if (err.response?.data?.debug) {
        console.error('🔍 Server debug info:', err.response.data.debug);
      }
      
      let errorMessage = 'Registration failed.';
      
      if (err.response?.status === 400) {
        if (err.response.data?.error?.includes('verification')) {
          errorMessage = "Invalid verification code. Please try again.";
          
          // ✅ ENHANCED: Show debug info in development
          if (process.env.NODE_ENV === 'development' && err.response.data?.debug) {
            console.log('🔍 Debug info from server:', err.response.data.debug);
            const debugInfo = err.response.data.debug;
            errorMessage += `\n\nDEBUG INFO (Development Mode):\nStored: ${debugInfo.storedCode}\nSubmitted: ${debugInfo.submittedCode}\nTypes: ${debugInfo.storedType} vs ${debugInfo.submittedType}`;
          }
          
          // ✅ ENHANCED: Additional debugging for development
          if (process.env.NODE_ENV === 'development') {
            console.log('🔍 Local verification analysis:', {
              enteredCode: verificationCode.trim(),
              devCode: devCode,
              match: verificationCode.trim() === devCode,
              expectedLength: 6,
              actualLength: verificationCode.trim().length
            });
          }
        } else {
          errorMessage = err.response.data?.error || 'Invalid input data.';
        }
      } else if (err.response?.status === 409) {
        errorMessage = "User already exists with this email or username. Please try logging in.";
      } else if (err.response?.data?.error) {
        errorMessage = err.response.data.error;
      } else if (err.response?.data?.message) {
        errorMessage = err.response.data.message;
      }
      
      alert(`${errorMessage} Please try again.`);
    } finally {
      setLoading(false);
    }
  };

  // Generate application ticket number (fallback)
  const generateApplicationTicket = (username, email) => {
    const timestamp = Date.now().toString(36);
    const random = Math.random().toString(36).substr(2, 5);
    return `APP-${username.substr(0, 3).toUpperCase()}-${timestamp}-${random}`.toUpperCase();
  };

  // Resend verification code
  const handleResendCode = async () => {
    try {
      setLoading(true);
      
      console.log('🔍 Resending verification code...');
      
      // ✅ UPDATED: Use auth endpoint instead of membership endpoint
      const response = await axios.post("http://localhost:3000/api/auth/send-verification", {
        email: values.email,
        phone: values.phone,
        method: verificationMethod, // ✅ Use 'method' field
        username: values.username
      });
      
      console.log('✅ Resend response:', response.data);
      
      // ✅ Update dev code if provided
      if (response.data.devCode) {
        setDevCode(response.data.devCode);
        console.log('🛠️ New dev code received:', response.data.devCode);
      }
      
      alert(`Verification code resent to your ${verificationMethod}!`);
    } catch (err) {
      console.error('❌ Resend error:', err);
      alert("Failed to resend code. Please try again.");
    } finally {
      setLoading(false);
    }
  };

  // ✅ ENHANCED: Auto-fill verification code with validation
  const handleDevCodeFill = () => {
    if (devCode) {
      setVerificationCode(devCode);
      console.log('🛠️ Auto-filled verification code:', devCode);
    } else {
      console.warn('⚠️ No dev code available to auto-fill');
    }
  };

  // ✅ ENHANCED: Input handler for verification code with real-time validation
  const handleVerificationCodeChange = (e) => {
    const value = e.target.value;
    // Only allow numeric input and limit to 6 characters
    if (/^\d*$/.test(value) && value.length <= 6) {
      setVerificationCode(value);
    }
  };

  // Render based on current step
  if (verificationStep === 'success') {
    return (
      <div className="signup-form success-message">
        <h2>🎉 Registration Successful!</h2>
        <div className="success-content">
          <p>Welcome to Ikoota, {values.username}!</p>
          <p>Your account has been created successfully.</p>
          <div className="loading-spinner">
            <p>Redirecting you to complete your application...</p>
          </div>
        </div>
      </div>
    );
  }

  if (verificationStep === 'verification') {
    return (
      <div className="signup-form verification-form">
        <h2>Verify Your Account</h2>
        <p>We've sent a verification code to your {verificationMethod}.</p>
        
        {/* ✅ ENHANCED: Development debug info */}
        {process.env.NODE_ENV === 'development' && (
          <div className="dev-code-info" style={{
            background: '#f0f8ff', 
            padding: '15px', 
            margin: '15px 0', 
            borderRadius: '8px',
            border: '1px solid #b0d4ff'
          }}>
            <p><strong>🛠️ Development Mode Debug Info:</strong></p>
            {devCode ? (
              <>
                <p>Latest verification code: <code style={{
                  background: '#ffe6e6', 
                  padding: '2px 6px', 
                  borderRadius: '4px',
                  fontWeight: 'bold',
                  fontSize: '16px'
                }}>{devCode}</code></p>
                <button 
                  type="button" 
                  onClick={handleDevCodeFill} 
                  className="dev-fill-btn"
                  style={{
                    background: '#4CAF50',
                    color: 'white',
                    border: 'none',
                    padding: '8px 12px',
                    borderRadius: '4px',
                    cursor: 'pointer',
                    marginTop: '5px'
                  }}
                >
                  Auto-fill Code
                </button>
                <p style={{fontSize: '12px', color: '#666', marginTop: '5px'}}>
                  Current input: "{verificationCode}" | Match: {verificationCode.trim() === devCode ? '✅' : '❌'}
                </p>
              </>
            ) : (
              <p style={{color: '#ff6600'}}>No dev code available. Check server logs.</p>
            )}
          </div>
        )}
        
        <form onSubmit={handleVerificationSubmit}>
          <div className="verification-input">
            <label htmlFor="verificationCode">
              <strong>Enter Verification Code:</strong>
            </label>
            <input
              type="text"
              placeholder="Enter 6-digit code"
              value={verificationCode}
              onChange={handleVerificationCodeChange} // ✅ ENHANCED: Use new handler
              maxLength="6"
              className="form-control verification-code-input"
              autoComplete="off"
              style={{
                fontSize: '18px',
                textAlign: 'center',
                letterSpacing: '3px',
                fontFamily: 'monospace'
              }}
            />
            {/* ✅ ENHANCED: Real-time validation feedback */}
            {verificationCode && (
              <div style={{fontSize: '12px', marginTop: '5px'}}>
                {verificationCode.length === 6 ? (
                  <span style={{color: 'green'}}>✅ Code length correct</span>
                ) : (
                  <span style={{color: 'orange'}}>⚠️ Code must be 6 digits ({verificationCode.length}/6)</span>
                )}
              </div>
            )}
          </div>
          
          <div className="verification-actions">
            <button 
              type="submit" 
              disabled={loading || !verificationCode || verificationCode.length !== 6}
              style={{
                opacity: (loading || !verificationCode || verificationCode.length !== 6) ? 0.6 : 1
              }}
            >
              {loading ? 'Verifying...' : 'Verify & Complete Registration'}
            </button>
            
            <button type="button" onClick={handleResendCode} disabled={loading} className="resend-btn">
              {loading ? 'Resending...' : 'Resend Code'}
            </button>
            
            <button type="button" onClick={() => setVerificationStep('form')} className="back-btn">
              ← Back to Form
            </button>
          </div>
        </form>
        
        <div className="verification-help">
          <p>Didn't receive the code? Check your spam folder or try resending.</p>
          <p>Code sent to: {verificationMethod === 'email' ? values.email : values.phone}</p>
          
          {/* ✅ ENHANCED: Additional help in development */}
          {process.env.NODE_ENV === 'development' && (
            <div style={{marginTop: '15px', padding: '10px', background: '#fff3cd', borderRadius: '5px'}}>
              <p><strong>🔧 Development Tips:</strong></p>
              <ul style={{fontSize: '14px', marginBottom: '0'}}>
                <li>Check browser console for detailed debugging information</li>
                <li>Server logs show the generated verification code</li>
                <li>Use the auto-fill button above for quick testing</li>
              </ul>
            </div>
          )}
        </div>
      </div>
    );
  }

  // Initial signup form
  return (
    <div className="signup-form">
      <h2>Join Ikoota Platform</h2>
      <p>Create your account to apply for membership</p>
      
      <form onSubmit={handleInitialSubmit}>
        <div className="form-group">
          <label htmlFor="username"><strong>Username:</strong></label>
          <input
            type="text"
            placeholder="Enter Username"
            name="username"
            value={values.username}
            onChange={e => setValues({ ...values, username: e.target.value })}
            className="form-control"
            required
          />
        </div>
        
        <div className="form-group">
          <label htmlFor="email"><strong>Email:</strong></label>
          <input
            type="email"
            autoComplete="off"
            placeholder="Enter Email"
            name="email"
            value={values.email}
            onChange={e => setValues({ ...values, email: e.target.value })}
            className="form-control"
            required
          />
        </div>
        
        <div className="form-group">
          <label htmlFor="phone"><strong>Phone:</strong></label>
          <input
            type="tel"
            autoComplete="off"
            placeholder="Enter WhatsApp Phone Number"
            name="phone"
            value={values.phone}
            onChange={e => setValues({ ...values, phone: e.target.value })}
            className="form-control"
            required
          />
        </div>
        
        <div className="form-group">
          <label htmlFor="password"><strong>Password:</strong></label>
          <input
            type="password"
            placeholder="Enter Password"
            name="password"
            value={values.password}
            onChange={e => setValues({ ...values, password: e.target.value })}
            className="form-control"
            autoComplete="off"
            required
          />
        </div>
        
        <div className="form-group">
          <label htmlFor="confirmPassword"><strong>Confirm Password:</strong></label>
          <input
            type="password"
            placeholder="Confirm Password"
            name="confirmPassword"
            value={values.confirmPassword}
            onChange={e => setValues({ ...values, confirmPassword: e.target.value })}
            className="form-control"
            autoComplete="off"
            required
          />
        </div>
        
        {/* ✅ FIXED: Verification Method Selection */}
        <div className="form-group verification-method">
          <label><strong>Verify account via:</strong></label>
          <div className="method-options">
            <label className="radio-option">
              <input
                type="radio"
                name="verificationMethod"
                value="email"
                checked={verificationMethod === 'email'}
                onChange={e => setVerificationMethod(e.target.value)}
                required
              />
              <span>Email</span>
            </label>
            <label className="radio-option">
              <input
                type="radio"
                name="verificationMethod"
                value="phone"
                checked={verificationMethod === 'phone'}
                onChange={e => setVerificationMethod(e.target.value)}
                required
              />
              <span>Phone/SMS</span>
            </label>
          </div>
        </div>
        
        <button type="submit" disabled={loading || !verificationMethod}>
          {loading ? 'Sending Code...' : 'Send Verification Code'}
        </button>
        
        <div className="next-step-info">
          <p>📋 Next: Complete application survey for membership consideration</p>
        </div>
      </form>
      
      <div className="form-footer">
        <Link to="/login">Already have an account? <strong>Sign In</strong></Link>
        <br />
        <Link to="/">← Back to Home</Link>
      </div>
    </div>
  );
};

export default Signup;


//===========================================

//ikootaclient\src\components\auth\RoleProtectedRoute.jsx
const RoleProtectedRoute = ({ children, requiredRole, requiredMembership }) => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const checkUserAccess = async () => {
      try {
        // Get user data from token or API
        const token = localStorage.getItem('token');
        if (!token) {
          navigate('/login');
          return;
        }

        // Decode token to get user info
        const payload = JSON.parse(atob(token.split('.')[1]));
        
        // Check role access
        if (requiredRole && payload.role !== requiredRole) {
          console.error('❌ Insufficient role permissions');
          navigate('/unauthorized');
          return;
        }

        // Check membership access
        if (requiredMembership && payload.membership_stage !== requiredMembership) {
          console.error('❌ Insufficient membership permissions');
          navigate('/application-survey');
          return;
        }

        setUser(payload);
      } catch (error) {
        console.error('❌ Access check failed:', error);
        navigate('/login');
      } finally {
        setLoading(false);
      }
    };

    checkUserAccess();
  }, [requiredRole, requiredMembership]);

  if (loading) return <div>Checking permissions...</div>;
  if (!user) return null;

  return children;
};

export default RoleProtectedRoute;


//=========================================

// ikootaclient/src/components/auth/ProtectedRoute.jsx
// ✅ PRESERVES ALL EXISTING FUNCTIONALITY + adds standardized membership support

import React, { useEffect, useState } from 'react';
import { Navigate, useLocation } from 'react-router-dom';
import { useUser } from './UserStatus';
import { getUserAccess, getUserStatusString } from '../config/accessMatrix';

const ProtectedRoute = ({ 
  children, 
  // ✅ PRESERVED: All your existing props
  requireAuth = false,
  requireMember = false,        // ✅ ENHANCED: Now means "member" (highest level)
  requirePreMember = false,     // ✅ PRESERVED: Your existing logic
  requireAdmin = false,         // ✅ PRESERVED: Your existing logic
  allowedUserTypes = [],        // ✅ PRESERVED: Your existing logic
  redirectTo = '/login',        // ✅ PRESERVED: Your existing logic
  // ✅ NEW: Additional props for standardized membership
  allowPending = false          // ✅ NEW: Allow pending applications
}) => {
  const { user, isAuthenticated, loading, membershipStatus } = useUser();
  const location = useLocation();
  const [isReady, setIsReady] = useState(false);

  // ✅ PRESERVED: Your exact loading logic
  useEffect(() => {
    if (!loading && (membershipStatus === 'loaded' || !user)) {
      setIsReady(true);
    } else {
      setIsReady(false);
    }
  }, [loading, membershipStatus, user]);

  // ✅ PRESERVED: Your exact loading component with styles
  if (!isReady) {
    return (
      <div className="route-loading">
        <div className="loading-spinner"></div>
        <p>Loading user status...</p>
        <style>
          {`
            .route-loading {
              display: flex;
              justify-content: center;
              align-items: center;
              height: 100vh;
              flex-direction: column;
            }
            .loading-spinner {
              border: 4px solid #f3f3f3;
              border-top: 4px solid #3498db;
              border-radius: 50%;
              width: 40px;
              height: 40px;
              animation: spin 2s linear infinite;
            }
            @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
            }
          `}
        </style>
      </div>
    );
  }

  // ✅ ENHANCED: Use standardized status but preserve all your logic
  const userStatus = getUserStatusString(user);
  
  console.log('🔐 ProtectedRoute Check:', {
    path: location.pathname,
    userStatus,
    requireAuth,
    requireMember,
    requirePreMember,
    requireAdmin,
    allowedUserTypes,
    allowPending, // ✅ NEW
    isAuthenticated,
    membershipStatus,
    isReady
  });

  // ✅ PRESERVED: Your exact public routes logic
  const publicRoutes = ['/', '/login', '/signup', '/forgot-password', '/towncrier'];
  const isPublicRoute = publicRoutes.includes(location.pathname);

  // ✅ PRESERVED: Your exact public route handling
  if (!requireAuth && !requireMember && !requirePreMember && !requireAdmin && allowedUserTypes.length === 0 && !allowPending) {
    console.log('✅ Public route access granted');
    return children;
  }

  // ✅ PRESERVED: Your exact authentication check
  if (requireAuth && !isAuthenticated) {
    console.log('🚨 SECURITY: Authentication required but user not authenticated');
    return <Navigate to={redirectTo} state={{ from: location }} replace />;
  }

  // ✅ ENHANCED: Authenticated user checks with standardized statuses
  if (isAuthenticated && user) {
    const access = getUserAccess(user);
    
    // ✅ PRESERVED: Your exact admin requirement check
    if (requireAdmin) {
      if (userStatus === 'admin') {
        console.log('✅ Admin access granted');
        return children;
      } else {
        console.log('🚨 SECURITY: Admin access required but user is not admin');
        return <Navigate to="/towncrier" replace />;
      }
    }

    // ✅ ENHANCED: Member requirement check (now standardized to "member" only)
    if (requireMember) {
      if (userStatus === 'member' || userStatus === 'admin') {
        console.log('✅ Member access granted');
        return children;
      } else {
        console.log('🚨 SECURITY: Member access required but user is not member');
        // ✅ ENHANCED: Better redirects based on current status
        if (userStatus === 'pre_member') {
          return <Navigate to="/full-membership/info" replace />;
        }
        if (userStatus === 'pre_member_pending_upgrade') {
          return <Navigate to="/full-membership/pending" replace />;
        }
        if (userStatus === 'pre_member_can_reapply') {
          return <Navigate to="/full-membership/declined" replace />;
        }
        return <Navigate to="/towncrier" replace />;
      }
    }

    // ✅ ENHANCED: Pre-member requirement check with ALL pre-member states
    if (requirePreMember) {
      const allowedForPreMember = [
        'pre_member', 
        'pre_member_pending_upgrade', 
        'pre_member_can_reapply', 
        'member', 
        'admin'
      ];
      
      if (allowedForPreMember.includes(userStatus)) {
        console.log('✅ Pre-member access granted for userStatus:', userStatus);
        return children;
      } else {
        console.log('🚨 SECURITY: Pre-member access required but user status insufficient:', {
          currentStatus: userStatus,
          expectedStatuses: allowedForPreMember,
          userObject: {
            role: user.role,
            is_member: user.is_member,
            membership_stage: user.membership_stage,
            approval_status: user.approval_status
          }
        });
        return <Navigate to="/towncrier" replace />;
      }
    }

    // ✅ NEW: Allow pending applications
    if (allowPending) {
      const allowedForPending = [
        'admin',
        'member',
        'pre_member',
        'pre_member_pending_upgrade', 
        'pre_member_can_reapply',
        'pending_verification',
        'needs_application'
      ];
      
      if (allowedForPending.includes(userStatus)) {
        console.log('✅ Pending access granted');
        return children;
      } else {
        console.log('❌ Pending access denied for status:', userStatus);
        return <Navigate to="/login" replace />;
      }
    }

    // ✅ PRESERVED: Your exact user types check
    if (allowedUserTypes.length > 0) {
      if (allowedUserTypes.includes(userStatus)) {
        console.log('✅ User type access granted');
        return children;
      } else {
        console.log('🚨 SECURITY: User type not in allowed list');
        return <Navigate to={access.defaultRoute} replace />;
      }
    }

    // ✅ PRESERVED: Your exact auth-only check
    if (requireAuth && isAuthenticated) {
      console.log('✅ Authenticated access granted');
      return children;
    }
  }

  // ✅ PRESERVED: Your exact default case logic
  if (isAuthenticated && user) {
    const access = getUserAccess(user);
    
    // ✅ PRESERVED: Your exact dashboard route handling
    if (location.pathname === '/dashboard') {
      // ✅ ENHANCED: Include all membership states that can access dashboard
      const dashboardAllowed = ['admin', 'member', 'pre_member', 'pre_member_pending_upgrade', 'pre_member_can_reapply'];
      if (dashboardAllowed.includes(userStatus)) {
        console.log('✅ Dashboard access granted');
        return children;
      } else {
        console.log('🚨 SECURITY: Dashboard access denied for user status:', userStatus);
        return <Navigate to={access.defaultRoute} replace />;
      }
    }

    // ✅ PRESERVED: Your exact default authenticated access
    console.log('✅ Default authenticated access granted');
    return children;
  }

  // ✅ PRESERVED: Your exact final fallback
  console.log('🚨 SECURITY: Access denied, redirecting to login');
  return <Navigate to={redirectTo} state={{ from: location }} replace />;
};

export default ProtectedRoute;


//============================================

//ikootaclient\src\components\auth\Passwordreset.jsx
import React, { useState } from "react";
import axios from "axios";
import "./passwordreset.css";

const Passwordreset = () => {
  const [step, setStep] = useState(1);
  const [values, setValues] = useState({
    emailOrPhone: "",
    newPassword: "",
    confirmNewPassword: "",
    verificationCode: "",
  });

  const handleResetRequest = async (e) => {
    e.preventDefault();
    try {
      await axios.post("http://localhost:3000/api/auth/passwordreset/request", {
        emailOrPhone: values.emailOrPhone,
      });
      setStep(2); // Move to password reset step
    } catch (err) {
      console.error(err.response.data.message);
    }
  };

  const handlePasswordReset = async (e) => {
    e.preventDefault();
    try {
      await axios.post("http://localhost:3000/api/auth/passwordreset/reset", {
        ...values,
      });
      setStep(3); // Move to verification step
    } catch (err) {
      console.error(err.response.data.message);
    }
  };

  const handleVerification = async (e) => {
    e.preventDefault();
    try {
      await axios.post("http://localhost:3000/api/auth/passwordreset/verify", {
        emailOrPhone: values.emailOrPhone,
        verificationCode: values.verificationCode,
      });
      alert("Password reset successful!");
    } catch (err) {
      console.error(err.response.data.message);
    }
  };

  return (
    <div className="password-reset-container">
      {step === 1 && (
        <form onSubmit={handleResetRequest}>
          <h2>Request Password Reset</h2>
          <input
            type="text"
            placeholder="Enter Email or Phone"
            onChange={(e) => setValues({ ...values, emailOrPhone: e.target.value })}
            required
          />
          <button type="submit">Send Reset Link</button>
        </form>
      )}
      {step === 2 && (
        <form onSubmit={handlePasswordReset}>
          <h2>Reset Password</h2>
          <input
            type="password"
            placeholder="New Password"
            onChange={(e) => setValues({ ...values, newPassword: e.target.value })}
            required
          />
          <input
            type="password"
            placeholder="Confirm New Password"
            onChange={(e) => setValues({ ...values, confirmNewPassword: e.target.value })}
            required
          />
          <button type="submit">Reset Password</button>
        </form>
      )}
      {step === 3 && (
        <form onSubmit={handleVerification}>
          <h2>Verify Reset</h2>
          <input
            type="text"
            placeholder="Enter Verification Code"
            onChange={(e) => setValues({ ...values, verificationCode: e.target.value })}
            required
          />
          <button type="submit">Verify</button>
        </form>
      )}
    </div>
  );
};

export default Passwordreset;


//===========================================

// ikootaclient/src/components/auth/NavigationWrapper.jsx
import React from 'react';
import { Navigate } from 'react-router-dom';
import { useUser } from './UserStatus';

const NavigationWrapper = ({ children }) => {
  const { loading, isAuthenticated, getUserStatus, getDefaultRoute } = useUser();

  if (loading) {
    return (
      <div className="loading-container">
        <div className="loading-spinner">Loading...</div>
      </div>
    );
  }

  // Auto-redirect logic based on user status
  const userStatus = getUserStatus();
  const currentPath = window.location.pathname;

  // Define which paths are allowed for each user status
  const allowedPaths = {
    guest: ['/', '/login', '/signup', '/towncrier'],
    pending: ['/towncrier', '/applicationsurvey', '/thankyou'],
    member: ['/iko', '/iko/*'],
    admin: ['/admin', '/admin/*', '/iko', '/iko/*', '/towncrier']
  };

  // Check if current path is allowed for user status
  const isPathAllowed = (status, path) => {
    const allowed = allowedPaths[status] || [];
    return allowed.some(allowedPath => {
      if (allowedPath.endsWith('/*')) {
        return path.startsWith(allowedPath.slice(0, -2));
      }
      return path === allowedPath;
    });
  };

  // Auto-redirect if user is on wrong path for their status
  if (!isPathAllowed(userStatus, currentPath)) {
    return <Navigate to={getDefaultRoute()} replace />;
  }

  return children;
};

export default NavigationWrapper;

//================================================

// ikootaclient/src/components/auth/Login.jsx
// ✅ FIXED VERSION - Proper routing based on user status and privileges

import React, { useState, useEffect } from "react";
import { Link, useNavigate } from "react-router-dom";
import axios from "axios";
import { useUser } from "./UserStatus";
import './login.css';
import { getUserAccess } from '../config/accessMatrix';

const Login = () => {
  const [values, setValues] = useState({
    email: "",
    password: "",
  });
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  
  const navigate = useNavigate();
  const { updateUser, isAuthenticated } = useUser();
  
  axios.defaults.withCredentials = true;

  // Redirect if already authenticated
  useEffect(() => {
    if (isAuthenticated) {
      navigate('/');
    }
  }, [isAuthenticated, navigate]);

  const handleSubmit = async (event) => {
    event.preventDefault();
    setError('');
    
    if (!values.email || !values.password) {
      setError("Please fill in all fields.");
      return;
    }

    try {
      setLoading(true);
      
      const response = await axios.post("http://localhost:3000/api/auth/login", {
        email: values.email,
        password: values.password
      }, { 
        withCredentials: true,
        timeout: 15000
      });

      console.log('🔍 Login response:', response.data);

      if (response.status === 200) {
        const responseData = response.data;
        let token, user;

        // Handle multiple response formats
        if (responseData.token && responseData.user) {
          token = responseData.token;
          user = responseData.user;
        } else if (responseData.data?.token && responseData.data?.user) {
          token = responseData.data.token;
          user = responseData.data.user;
        } else if (responseData.access_token || responseData.accessToken) {
          token = responseData.access_token || responseData.accessToken;
          user = responseData.user || responseData.data?.user;
        } else if (responseData.success && responseData.data) {
          token = responseData.data.token || responseData.data.access_token;
          user = responseData.data.user;
        } else {
          user = responseData.user || responseData.data || responseData;
          token = responseData.token || responseData.access_token || responseData.accessToken;
        }

        console.log('🔍 Extracted token:', token ? 'Present' : 'Missing');
        console.log('🔍 Extracted user:', user);

        if (!user) {
          console.error('❌ No user data received from login response');
          setError('Login failed: Invalid response from server');
          return;
        }

        // Store token properly
        if (token) {
          localStorage.setItem("token", token);
          axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
        }
        
        // Update user context first
        try {
          console.log('🔄 Updating user context...');
          await updateUser();
          
          // Small delay to ensure context is updated
          await new Promise(resolve => setTimeout(resolve, 500));
        } catch (updateError) {
          console.warn('⚠️ Failed to update user context:', updateError);
        }
        
        // ✅ FIXED: Smart routing based on user status
        await handleUserRouting(user, token);
      }
    } catch (err) {
      console.error('❌ Login error:', err);
      
      if (err.response?.status === 401) {
        setError("Invalid email or password.");
      } else if (err.response?.status === 403) {
        const message = err.response.data?.message || '';
        if (message.includes('banned')) {
          setError("Your account has been banned. Contact support for assistance.");
        } else if (message.includes('pending')) {
          handlePendingUser(err.response.data);
        } else {
          setError("Access denied. Please contact support.");
        }
      } else if (err.response?.status === 404) {
        setError("No account found with this email. Please sign up first.");
      } else if (err.code === 'ECONNABORTED') {
        setError("Login request timed out. Please check your connection and try again.");
      } else {
        setError("Login failed. Please check your network and try again.");
      }
    } finally {
      setLoading(false);
    }
  };

  // ✅ COMPLETELY REWRITTEN: Smart user routing based on membership status
  const handleUserRouting = async (userData, token) => {
    if (!userData) {
      console.error('❌ No user data provided to handleUserRouting');
      setError('Login failed: Invalid user data received');
      return;
    }
    
    console.log('🔍 Routing user based on data:', userData);
    
    try {
      const role = userData.role?.toLowerCase();
      const memberStatus = userData.is_member?.toLowerCase();
      const membershipStage = userData.membership_stage?.toLowerCase();
      
      console.log('🔍 User routing analysis:', {
        role,
        memberStatus, 
        membershipStage,
        userId: userData.id
      });

      // ✅ PRIORITY 1: Admin users - Go straight to admin panel
      if (role === 'admin' || role === 'super_admin') {
        console.log('👑 Admin user detected - routing to admin panel');
        navigate('/admin', { replace: true });
        return;
      }

      // ✅ PRIORITY 2: Full Members - Go to Iko Chat
      if ((memberStatus === 'member' && membershipStage === 'member') || 
          (memberStatus === 'active' && membershipStage === 'member')) {
        console.log('💎 Full member detected - routing to Iko Chat');
        navigate('/iko', { replace: true });
        return;
      }

      // ✅ PRIORITY 3: Pre-Members - Go to Towncrier  
      if (memberStatus === 'pre_member' || membershipStage === 'pre_member') {
        console.log('👤 Pre-member detected - routing to Towncrier');
        navigate('/towncrier', { replace: true });
        return;
      }

      // ✅ PRIORITY 4: Check if user needs to complete application survey
      if (token) {
        const needsSurvey = await checkIfUserNeedsApplication(token, userData);
        
        if (needsSurvey) {
          console.log('📝 User needs to complete application - routing to survey');
          navigate('/applicationsurvey', { replace: true });
          return;
        }
      }

      // ✅ PRIORITY 5: Other authenticated users - Go to dashboard
      console.log('🏠 Default routing - going to dashboard');
      navigate('/dashboard', { replace: true });
      
    } catch (error) {
      console.error('❌ Error in user routing:', error);
      setError('Login successful but routing failed. Redirecting to dashboard...');
      
      // Last resort fallback
      setTimeout(() => {
        navigate('/dashboard', { replace: true });
      }, 2000);
    }
  };

  // ✅ NEW: More precise check for application survey requirement
  const checkIfUserNeedsApplication = async (token, userData) => {
    try {
      console.log('🔍 Checking if user needs application survey...');
      
      // Skip survey check for known member statuses
      const memberStatus = userData.is_member?.toLowerCase();
      const membershipStage = userData.membership_stage?.toLowerCase();
      
      // Users who definitely don't need survey
      if (memberStatus === 'pre_member' || 
          memberStatus === 'member' || 
          memberStatus === 'active' ||
          membershipStage === 'pre_member' || 
          membershipStage === 'member') {
        console.log('✅ User has confirmed membership status - no survey needed');
        return false;
      }

      // Check survey status via API for edge cases
      const response = await axios.get('http://localhost:3000/api/membership/survey/check-status', {
        headers: { 'Authorization': `Bearer ${token}` },
        timeout: 5000
      });
      
      const statusData = response.data;
      console.log('📋 Survey status check:', statusData);
      
      // Only require survey if explicitly needed and not completed
      const needsSurvey = statusData.needs_survey === true && 
                         statusData.survey_completed === false &&
                         memberStatus === 'applied' &&
                         membershipStage === 'none';
      
      console.log('🎯 Survey requirement decision:', {
        needsSurvey,
        reason: needsSurvey ? 'New user needs to complete application' : 'User has existing status'
      });
      
      return needsSurvey;
      
    } catch (error) {
      console.warn('⚠️ Survey status check failed:', error);
      
      // Conservative fallback: only require survey for clearly new users
      const memberStatus = userData.is_member?.toLowerCase();
      const membershipStage = userData.membership_stage?.toLowerCase();
      
      const isNewUser = memberStatus === 'applied' && 
                       membershipStage === 'none' &&
                       !userData.application_submittedAt;
      
      console.log('🔄 Fallback survey check:', {
        isNewUser,
        memberStatus,
        membershipStage
      });
      
      return isNewUser;
    }
  };

  const handlePendingUser = (data) => {
    const { applicationStatus, applicationTicket } = data;
    
    switch (applicationStatus) {
      case 'pending':
        alert(`Your application is still under review.\n\nApplication Ticket: ${applicationTicket || 'N/A'}\n\nYou'll receive an email notification once the review is complete.`);
        navigate('/pending-verification');
        break;
      case 'suspended':
        alert(`Your application review is suspended and requires additional information.\n\nPlease check your email for details on what's needed.\n\nApplication Ticket: ${applicationTicket || 'N/A'}`);
        navigate('/suspended-verification');
        break;
      default:
        setError("Your application is being processed. Please check your email for updates.");
    }
  };

  const handleForgotPassword = () => {
    const email = values.email;
    if (!email) {
      alert("Please enter your email address first, then click 'Forgot Password'.");
      return;
    }
    
    navigate('/forgot-password', { state: { email } });
  };

  const handleChange = (e) => {
    setValues({ ...values, [e.target.name]: e.target.value });
  };

  return (
    <div className="login-container">
      <div className="login-form">
        <div className="login-header">
          <h2>Sign In to Ikoota</h2>
          <p>Access your educational community account</p>
        </div>

        {error && (
          <div className="error-message">
            <span className="error-icon">⚠️</span>
            {error}
          </div>
        )}

        <form onSubmit={handleSubmit}>
          <div className="form-group">
            <label htmlFor="email">
              <strong>Email Address:</strong>
            </label>
            <input
              type="email"
              name="email"
              value={values.email}
              onChange={handleChange}
              placeholder="Enter your email"
              className="form-control"
              autoComplete="email"
              required
            />
          </div>

          <div className="form-group">
            <label htmlFor="password">
              <strong>Password:</strong>
            </label>
            <input
              type="password"
              name="password"
              value={values.password}
              onChange={handleChange}
              placeholder="Enter your password"
              className="form-control"
              autoComplete="current-password"
              required
            />
          </div>

          <div className="form-actions">
            <button 
              type="submit" 
              disabled={loading}
              className="btn-login"
            >
              {loading ? 'Signing In...' : 'Sign In'}
            </button>
            
            <button 
              type="button" 
              onClick={handleForgotPassword}
              className="btn-forgot"
            >
              Forgot Password?
            </button>
          </div>
        </form>

        <div className="login-divider">
          <span>New to Ikoota?</span>
        </div>

        <div className="signup-section">
          <p>Join our educational community</p>
          <Link to="/signup" className="btn-signup">
            Create Account
          </Link>
        </div>

        <div className="login-help">
          <h3>Having trouble signing in?</h3>
          <div className="help-options">
            <div className="help-item">
              <span className="help-icon">📧</span>
              <div>
                <h4>Check Your Application Status</h4>
                <p>If you've applied for membership, check your email for status updates</p>
              </div>
            </div>
            <div className="help-item">
              <span className="help-icon">⏳</span>
              <div>
                <h4>Application Under Review</h4>
                <p>Pending applications typically take 3-5 business days to review</p>
              </div>
            </div>
            <div className="help-item">
              <span className="help-icon">❓</span>
              <div>
                <h4>Need Help?</h4>
                <p>Contact support@ikoota.com with your application ticket number</p>
              </div>
            </div>
          </div>
        </div>

        <div className="login-footer">
          <div className="footer-links">
            <Link to="/">← Back to Home</Link>
            <Link to="/towncrier">Browse Public Content</Link>
          </div>
          <p className="footer-note">
            By signing in, you agree to our Terms of Service and Privacy Policy.
          </p>
        </div>
      </div>
    </div>
  );
};

export default Login;

//====================================

// ikootaclient/src/components/auth/LandingPage.jsx - FIXED WITH DASHBOARD REDIRECT & PRESERVED FUNCTIONALITY
import React, { useState, useEffect } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import { jwtDecode } from 'jwt-decode';
import { useUser } from './UserStatus';
import { getUserAccess, getDashboardRoute } from '../config/accessMatrix'; // ✅ ADDED: getDashboardRoute import
import './LandingPage.css';

const LandingPage = () => {
  const [isScrolled, setIsScrolled] = useState(false);
  const [activeFeature, setActiveFeature] = useState(0);
  const navigate = useNavigate();
  const { isAuthenticated, loading, user, logout, getUserStatus } = useUser();

  // ✅ Get user status and access properly
  const userStatus = getUserStatus();
  const userAccess = user ? getUserAccess(user) : null;

  console.log('🔍 LandingPage - User Status:', userStatus);
  console.log('🔍 LandingPage - User Access:', userAccess);
  console.log('🔍 LandingPage - User Data:', user);

  // ✅ FIXED: Dashboard redirect handler using new function
  const handleDashboardRedirect = () => {
    const dashboardRoute = getDashboardRoute(user);
    console.log('🎯 Dashboard redirect to:', dashboardRoute);
    navigate(dashboardRoute); // Will always be '/dashboard' for authenticated users
  };

  // ✅ FIXED: Safer redirect logic with proper error handling
  useEffect(() => {
    // Don't redirect while still loading user data
    if (loading) return;
    
    try {
      // ✅ IMPORTANT: Allow pending users to freely access the landing page
      // Only redirect users who have full access to other areas
      if (isAuthenticated && !loading && user) {
        // ✅ Only redirect users who are NOT pending verification
        // Pending users should be able to browse the landing page freely
        if (userStatus === 'admin' || userStatus === 'full_member') {
          const defaultRoute = userAccess?.defaultRoute;
          if (defaultRoute && defaultRoute !== '/') {
            console.log('🔄 Active user on landing page, redirecting to:', defaultRoute);
            // Don't auto-redirect from landing page - let user choose
            // navigate(defaultRoute);
            // return;
          }
        }
        // ✅ Applicants and pending users can stay on landing page
        console.log('✅ Pending/applicant user can access landing page freely');
      }
    } catch (error) {
      console.error('Error in landing page redirect logic:', error);
      // Don't redirect on error - let user stay on landing page
    }
  }, [isAuthenticated, loading, navigate, userAccess, user, userStatus]);

  // Handle scroll effect for navbar
  useEffect(() => {
    const handleScroll = () => {
      setIsScrolled(window.scrollY > 50);
    };

    window.addEventListener('scroll', handleScroll);
    return () => window.removeEventListener('scroll', handleScroll);
  }, []);

  // Auto-rotate features
  useEffect(() => {
    const interval = setInterval(() => {
      setActiveFeature((prev) => (prev + 1) % 4);
    }, 4000);

    return () => clearInterval(interval);
  }, []);

  const features = [
    {
      id: 1,
      title: "Interactive Teaching",
      description: "Create engaging lessons with multimedia content including videos, images, and audio.",
      icon: "🎓",
      color: "#3498db"
    },
    {
      id: 2,
      title: "Real-time Chat",
      description: "Connect with students and colleagues through our integrated chat system.",
      icon: "💬",
      color: "#e74c3c"
    },
    {
      id: 3,
      title: "Content Management",
      description: "Organize and manage your teaching materials with our smart content system.",
      icon: "📚",
      color: "#2ecc71"
    },
    {
      id: 4,
      title: "Community Learning",
      description: "Join a community of educators sharing knowledge and best practices.",
      icon: "🌟",
      color: "#f39c12"
    }
  ];

  const handleGetStarted = () => {
    navigate('/signup');
  };

  const handleLogin = () => {
    navigate('/login');
  };

  const handleJoinCommunity = () => {
    navigate('/signup');
  };

  const handleViewPublicContent = () => {
    // ✅ FIXED: For public content viewing, we can navigate to towncrier
    // but we should handle this more gracefully for non-authenticated users
    try {
      navigate('/towncrier');
    } catch (error) {
      console.log('Error navigating to public content:', error);
      // Fallback - could show a modal or scroll to features section
      document.getElementById('features')?.scrollIntoView({ behavior: 'smooth' });
    }
  };

  // ✅ NEW: Handle logout functionality
  const handleLogout = async () => {
    try {
      console.log('🔓 Logging out user...');
      await logout(); // Call the logout function from UserStatus
      alert('You have been logged out successfully. Others can now use this system to sign up or log in.');
      // The page will automatically update to show login/signup buttons
    } catch (error) {
      console.error('Logout error:', error);
      alert('Logout completed. You can now use the system for other accounts.');
    }
  };

  // ✅ PRESERVED: Navigate to user's appropriate area (but using dashboard for dashboard buttons)
  const navigateToUserArea = () => {
    try {
      // ✅ FIXED: Use getDashboardRoute for dashboard buttons instead of defaultRoute
      const dashboardRoute = getDashboardRoute(user);
      console.log('🎯 Navigating to user dashboard:', dashboardRoute);
      navigate(dashboardRoute);
    } catch (error) {
      console.error('Navigation error:', error);
      navigate('/dashboard');
    }
  };

  // ✅ Show loading state while determining user authentication status
  if (loading) {
    return (
      <div style={{ 
        display: 'flex', 
        justifyContent: 'center', 
        alignItems: 'center', 
        height: '100vh',
        flexDirection: 'column'
      }}>
        <div style={{
          width: '40px',
          height: '40px',
          border: '4px solid #f3f3f3',
          borderTop: '4px solid #667eea',
          borderRadius: '50%',
          animation: 'spin 1s linear infinite'
        }}></div>
        <p style={{ marginTop: '20px', color: '#666' }}>Loading...</p>
        <style>{`
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
        `}</style>
      </div>
    );
  }

  return (
    <div className="landing-page">
      {/* Navigation */}
      <nav className={`landing-nav ${isScrolled ? 'scrolled' : ''}`}>
        <div className="nav-container">
          <div className="nav-brand">
            <h2>Ikoota</h2>
            <span className="brand-tagline">Teaching System</span>
          </div>
          
          <div className="nav-links">
            <a href="#features" className="nav-link">Features</a>
            <a href="#membership" className="nav-link">Membership</a>
            <a href="#about" className="nav-link">About</a>
            <a href="#contact" className="nav-link">Contact</a>
          </div>
          
          <div className="nav-actions">
            {/* ✅ ENHANCED: Show different buttons based on authentication status */}
            {isAuthenticated && user ? (
              <div className="authenticated-actions">
                <button 
                  onClick={handleDashboardRedirect} // ✅ FIXED: Use dashboard redirect handler
                  className="btn-primary"
                >
                  Go to Dashboard
                </button>
                {/* ✅ NEW: Logout button for authenticated users */}
                <button 
                  onClick={handleLogout} 
                  className="btn-logout"
                  title="Logout to allow others to use this system"
                >
                  🔓 Logout
                </button>
              </div>
            ) : (
              <>
                <button onClick={handleLogin} className="btn-secondary">
                  Sign In
                </button>
                <button onClick={handleGetStarted} className="btn-primary">
                  Join Community
                </button>
              </>
            )}
          </div>
        </div>
      </nav>

      {/* Hero Section */}
      <section className="hero">
        <div className="hero-background">
          <div className="hero-shapes">
            <div className="shape shape-1"></div>
            <div className="shape shape-2"></div>
            <div className="shape shape-3"></div>
          </div>
        </div>
        
        <div className="hero-content">
          <div className="hero-text">
            <h1 className="hero-title">
              Join the Future of
              <span className="gradient-text"> Educational Community</span>
            </h1>
            <p className="hero-description">
              Ikoota is an exclusive educational platform where approved members 
              collaborate, share knowledge, and build the future of learning together. 
              Apply for membership to join our growing community of educators.
            </p>
            
            <div className="hero-actions">
              {/* ✅ ENHANCED: Conditional rendering with logout option */}
              {isAuthenticated && user ? (
                <div className="authenticated-hero-actions">
                  <button 
                    onClick={handleDashboardRedirect} // ✅ FIXED: Use dashboard redirect handler
                    className="btn-hero-primary"
                  >
                    Go to Your Dashboard
                    <span className="btn-icon">→</span>
                  </button>
                  {/* ✅ NEW: Logout option in hero section */}
                  <button onClick={handleLogout} className="btn-hero-logout">
                    <span className="logout-icon">🔓</span>
                    Allow Others to Sign Up
                  </button>
                </div>
              ) : (
                <>
                  <button onClick={handleJoinCommunity} className="btn-hero-primary">
                    Apply for Membership
                    <span className="btn-icon">→</span>
                  </button>
                  <button onClick={handleViewPublicContent} className="btn-hero-secondary">
                    <span className="play-icon">👁</span>
                    View Public Content
                  </button>
                </>
              )}
            </div>
            
            <div className="hero-stats">
              <div className="stat">
                <span className="stat-number">1,000+</span>
                <span className="stat-label">Active Members</span>
              </div>
              <div className="stat">
                <span className="stat-number">50K+</span>
                <span className="stat-label">Students Impacted</span>
              </div>
              <div className="stat">
                <span className="stat-number">10K+</span>
                <span className="stat-label">Collaborative Projects</span>
              </div>
            </div>
          </div>
          
          <div className="hero-visual">
            <div className="dashboard-preview">
              <div className="preview-header">
                <div className="preview-dots">
                  <span></span>
                  <span></span>
                  <span></span>
                </div>
                <span className="preview-title">Ikoota Member Dashboard</span>
              </div>
              <div className="preview-content">
                <div className="preview-sidebar">
                  <div className="sidebar-item active">💬 Community Chat</div>
                  <div className="sidebar-item">📚 Shared Resources</div>
                  <div className="sidebar-item">👥 Member Directory</div>
                  <div className="sidebar-item">📊 Collaboration Tools</div>
                </div>
                <div className="preview-main">
                  <div className="content-card">
                    <div className="card-header">
                      <span className="content-type">Discussion</span>
                      <span className="content-id">d{Math.floor(Math.random() * 100)}</span>
                    </div>
                    <h4>Advanced Teaching Methodologies</h4>
                    <p>Collaborative discussion with verified educators...</p>
                  </div>
                  <div className="content-card">
                    <div className="card-header">
                      <span className="content-type resource">Resource</span>
                      <span className="content-id">r{Math.floor(Math.random() * 100)}</span>
                    </div>
                    <h4>Exclusive Educational Materials</h4>
                    <p>Member-only content and resources...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      {/* Membership Section */}
      <section id="membership" className="membership">
        <div className="container">
          <div className="section-header">
            <h2>Exclusive Membership Community</h2>
            <p>Join a curated community of verified educators and educational professionals</p>
          </div>
          
          <div className="membership-tiers">
            {/* ✅ PUBLIC ACCESS TIER */}
            <div className="tier-card">
              <h3>🌟 Public Access</h3>
              <p>View our public content and community announcements</p>
              <ul>
                <li>Access to Towncrier public feed</li>
                <li>View community announcements</li>
                <li>See public educational content</li>
              </ul>
              <button onClick={handleViewPublicContent} className="btn-tier">
                View Public Content
              </button>
            </div>
            
            {/* ✅ MEMBER ACCESS TIER - ENHANCED WITH CONDITIONAL BUTTONS */}
            <div className="tier-card featured">
              <h3>🎓 Member Access</h3>
              <p>Full access to our exclusive educational community</p>
              <ul>
                <li>Join internal Iko chat system</li>
                <li>Access exclusive resources</li>
                <li>Collaborate with verified educators</li>
                <li>Create and share content</li>
                <li>Participate in member discussions</li>
              </ul>
              
              {/* ✅ FIXED: Show appropriate buttons based on user status */}
              <div className="tier-buttons">
                {isAuthenticated && user ? (
                  <>
                    {/* ✅ FIXED: Dashboard button using new handler */}
                    <button 
                      onClick={handleDashboardRedirect} // ✅ FIXED: Use dashboard redirect handler
                      className="btn-tier primary"
                    >
                      User Dashboard
                    </button>
                    
                    {/* ✅ IKO CHAT BUTTON - Show for full members and admins */}
                    {(userStatus === 'full_member' || userStatus === 'admin') && (
                      <button 
                        onClick={() => navigate('/iko')} 
                        className="btn-tier iko-btn"
                        style={{ marginTop: '10px', backgroundColor: '#e74c3c' }}
                      >
                        💬 Access Iko Chat
                      </button>
                    )}
                  </>
                ) : (
                  <button onClick={handleJoinCommunity} className="btn-tier primary">
                    Apply for Membership
                  </button>
                )}
              </div>
            </div>
            
            {/* ✅ ADMIN ACCESS TIER - ENHANCED WITH WORKING BUTTON */}
            <div className="tier-card">
              <h3>⚡ Admin Access</h3>
              <p>Leadership and management privileges</p>
              <ul>
                <li>All member privileges</li>
                <li>Community management tools</li>
                <li>User approval system</li>
                <li>Analytics and reporting</li>
              </ul>
              
              {/* ✅ FIXED: Show working admin button for admin users */}
              {isAuthenticated && user && userStatus === 'admin' ? (
                <button 
                  onClick={() => navigate('/admin')} 
                  className="btn-tier admin-btn"
                  style={{ backgroundColor: '#f39c12', color: 'white' }}
                >
                  🔧 Access Admin Panel
                </button>
              ) : (
                <button disabled className="btn-tier">
                  By Invitation Only
                </button>
              )}
            </div>
          </div>
        </div>
      </section>

      {/* Features Section */}
      <section id="features" className="features">
        <div className="container">
          <div className="section-header">
            <h2>Powerful Features for Educational Collaboration</h2>
            <p>Everything you need to connect, create, and collaborate with fellow educators</p>
          </div>
          
          <div className="features-grid">
            {features.map((feature, index) => (
              <div 
                key={feature.id}
                className={`feature-card ${activeFeature === index ? 'active' : ''}`}
                onMouseEnter={() => setActiveFeature(index)}
                style={{'--feature-color': feature.color}}
              >
                <div className="feature-icon">{feature.icon}</div>
                <h3>{feature.title}</h3>
                <p>{feature.description}</p>
                <div className="feature-arrow">→</div>
              </div>
            ))}
          </div>
        </div>
      </section>

      {/* About Section */}
      <section id="about" className="about">
        <div className="container">
          <div className="about-content">
            <div className="about-text">
              <h2>Built for Educators, by Educators</h2>
              <p>
                Ikoota is a curated community platform designed specifically for 
                educational professionals. Our membership-based approach ensures 
                high-quality discussions, verified expertise, and meaningful 
                collaborative opportunities.
              </p>
              
              <div className="about-highlights">
                <div className="highlight">
                  <div className="highlight-icon">🔐</div>
                  <div>
                    <h4>Verified Members Only</h4>
                    <p>All members go through an application and verification process</p>
                  </div>
                </div>
                <div className="highlight">
                  <div className="highlight-icon">🚀</div>
                  <div>
                    <h4>Quality Discussions</h4>
                    <p>Curated community ensures meaningful educational conversations</p>
                  </div>
                </div>
                <div className="highlight">
                  <div className="highlight-icon">🔒</div>
                  <div>
                    <h4>Secure & Private</h4>
                    <p>Member data and discussions are protected with enterprise-grade security</p>
                  </div>
                </div>
              </div>
            </div>
            
            <div className="about-visual">
              <div className="testimonial-card">
                <div className="testimonial-content">
                  <p>"Being part of Ikoota's exclusive community has elevated my teaching practice. The quality of discussions and resources is unmatched."</p>
                </div>
                <div className="testimonial-author">
                  <div className="author-avatar">👩‍🏫</div>
                  <div>
                    <h5>Dr. Sarah Johnson</h5>
                    <span>Verified Member - Mathematics Education</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      {/* CTA Section */}
      <section className="cta">
        <div className="container">
          <div className="cta-content">
            <h2>Ready to Join Our Educational Community?</h2>
            <p>
              {isAuthenticated && user
                ? "Welcome back! Access your dashboard to continue your educational journey."
                : "Apply for membership and become part of an exclusive network of verified educators."
              }
            </p>
            
            <div className="cta-actions">
              {isAuthenticated && user ? (
                <div className="authenticated-cta-actions">
                  <button 
                    onClick={handleDashboardRedirect} // ✅ FIXED: Use dashboard redirect handler
                    className="btn-cta-primary"
                  >
                    Go to Dashboard
                  </button>
                  {/* ✅ NEW: Logout option in CTA section */}
                  <button onClick={handleLogout} className="btn-cta-logout">
                    🔓 Logout & Allow Others to Join
                  </button>
                </div>
              ) : (
                <>
                  <button onClick={handleJoinCommunity} className="btn-cta-primary">
                    Apply for Membership
                  </button>
                  <Link to="/login" className="btn-cta-secondary">
                    Already a member? Sign in
                  </Link>
                </>
              )}
            </div>
          </div>
        </div>
      </section>

      {/* Footer */}
      <footer id="contact" className="footer">
        <div className="container">
          <div className="footer-content">
            <div className="footer-section">
              <h3>Ikoota</h3>
              <p>Exclusive community for educational professionals.</p>
              <div className="social-links">
                <a href="#" aria-label="Facebook">📘</a>
                <a href="#" aria-label="Twitter">🐦</a>
                <a href="#" aria-label="LinkedIn">💼</a>
                <a href="#" aria-label="YouTube">📺</a>
              </div>
            </div>
            
            <div className="footer-section">
              <h4>Community</h4>
              <ul>
                <li><a href="#features">Features</a></li>
                <li><a href="#membership">Membership</a></li>
                <li><a href="#about">About</a></li>
                <li>
                  {/* ✅ ENHANCED: Footer Apply Now with logout option if authenticated */}
                  {isAuthenticated && user ? (
                    <div className="footer-auth-actions">
                      <Link to="/signup">Apply Now (Others)</Link>
                      <button onClick={handleLogout} className="footer-logout-btn">
                        🔓 Logout First
                      </button>
                    </div>
                  ) : (
                    <Link to="/signup">Apply Now</Link>
                  )}
                </li>
              </ul>
            </div>
            
            <div className="footer-section">
              <h4>Support</h4>
              <ul>
                <li><a href="#">Help Center</a></li>
                <li><a href="#">Application Process</a></li>
                <li><a href="#">Contact Us</a></li>
                <li><a href="#">Privacy Policy</a></li>
              </ul>
            </div>
            
            <div className="footer-section">
              <h4>Contact</h4>
              <ul>
                <li>📧 membership@ikoota.com</li>
                <li>📞 +1 (555) 123-4567</li>
                <li>📍 123 Education St, Learning City</li>
              </ul>
            </div>
          </div>
          
          <div className="footer-bottom">
            <p>&copy; 2025 Ikoota. All rights reserved.</p>
            <div className="footer-links">
              <a href="#">Terms of Service</a>
              <a href="#">Privacy Policy</a>
              <a href="#">Membership Agreement</a>
            </div>
          </div>
        </div>
      </footer>
    </div>
  );
};

export default LandingPage;


//===========================================

//ikootaclient/src/components/auth/AuthControls.jsx
import React, { useState, useEffect } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { useLocation } from "react-router-dom";
import api from "../service/api";
import "./authControls.css";

const AuthControls = () => {
  const queryClient = useQueryClient();
  const location = useLocation();
  const [surveyQuestions, setSurveyQuestions] = useState([]);
  const [selectedSurvey, setSelectedSurvey] = useState(null);
  const [userRoleUpdates, setUserRoleUpdates] = useState({ userId: "", role: "" });

  // ✅ Detect if we're in admin context
  const isInAdminContext = location.pathname.includes('/admin');

  // ✅ Add context class to body for CSS targeting
  useEffect(() => {
    const bodyClass = 'auth-controls-in-admin';
    
    if (isInAdminContext) {
      document.body.classList.add(bodyClass);
    } else {
      document.body.classList.remove(bodyClass);
    }

    // Cleanup on unmount
    return () => {
      document.body.classList.remove(bodyClass);
    };
  }, [isInAdminContext]);

  // ✅ Fetch question labels
  const { data: questionLabels, refetch: fetchQuestionLabels, isLoading: labelsLoading } = useQuery({
    queryKey: ["fetchQuestionLabels"],
    queryFn: async () => {
      console.log('🔍 Fetching question labels...');
      const res = await api.get("/survey/question-labels");
      console.log("✅ Question labels response:", res.data);
      
      // Handle different response formats from API
      if (res.data?.success && res.data?.data) {
        return res.data.data; // New format: {success: true, data: {...}}
      } else if (res.data?.labels) {
        return res.data.labels; // Backup format with labels field
      } else if (typeof res.data === 'object') {
        return res.data; // Direct object format
      } else {
        console.warn('⚠️ Unexpected labels format:', res.data);
        return {}; // Fallback to empty object
      }
    },
    retry: 2,
    retryDelay: 1000,
  });

  // ✅ Fetch survey logs with enhanced error handling
  const { 
    data: surveys, 
    refetch: fetchSurveyLogs, 
    isLoading: surveysLoading,
    error: surveysError 
  } = useQuery({
    queryKey: ["fetchSurveyLogs"],
    queryFn: async () => {
      console.log('🔍 Fetching survey logs...');
      try {
        const res = await api.get("/survey/logs");
        console.log("✅ Survey logs response:", res.data);
        
        // Handle different response formats
        if (res.data?.success && res.data?.data) {
          return res.data.data; // New format with success wrapper
        } else if (Array.isArray(res.data)) {
          return res.data; // Direct array format
        } else if (res.data?.logs) {
          return res.data.logs; // Alternative format
        } else {
          console.warn('⚠️ Unexpected survey logs format:', res.data);
          return [];
        }
      } catch (error) {
        console.error('❌ Survey logs fetch error:', error);
        if (error.response?.status === 403) {
          throw new Error('Admin privileges required to view survey logs');
        }
        throw error;
      }
    },
    retry: 2,
    retryDelay: 1000,
    onError: (error) => {
      console.error('❌ Survey logs query error:', error);
    }
  });

  // ✅ Update question labels mutation
  const { mutate: updateLabels, isLoading: updatingLabels } = useMutation({
    mutationFn: (labels) => {
      console.log('🔍 Updating question labels:', labels);
      
      if (!labels || Object.keys(labels).length === 0) {
        throw new Error('Please provide at least one question label before saving');
      }
      
      return api.put("/survey/question-labels", { labels });
    },
    onSuccess: () => {
      console.log('✅ Question labels updated successfully');
      fetchQuestionLabels();
      alert('Survey question labels updated successfully!');
    },
    onError: (error) => {
      console.error('❌ Error updating question labels:', error);
      const errorMessage = error.response?.data?.error || error.message || 'Failed to update question labels';
      alert('Failed to update question labels: ' + errorMessage);
    }
  });

  // ✅ Update approval status mutation
  const { mutate: updateApprovalStatus, isLoading: updatingApproval } = useMutation({
    mutationFn: ({ surveyId, userId, status }) => {
      console.log('🔍 Updating approval status:', { surveyId, userId, status });
      return api.put("/survey/approve", { surveyId, userId, status });
    },
    onSuccess: (data, variables) => {
      console.log('✅ Approval status updated:', variables);
      fetchSurveyLogs();
      alert(`Application ${variables.status} successfully!`);
    },
    onError: (error) => {
      console.error('❌ Error updating approval status:', error);
      alert('Failed to update approval status: ' + error.message);
    }
  });

  // ✅ Update user role mutation
  const { mutate: updateUserRole, isLoading: updatingRole } = useMutation({
    mutationFn: ({ userId, role }) => {
      console.log('🔍 Updating user role:', { userId, role });
      return api.put("/users/role", { userId, role });
    },
    onSuccess: () => {
      console.log('✅ User role updated successfully');
      alert("User role updated successfully.");
      setUserRoleUpdates({ userId: "", role: "" });
    },
    onError: (error) => {
      console.error('❌ Error updating user role:', error);
      alert('Failed to update user role: ' + error.message);
    }
  });

  // ✅ Convert question labels to editable format
  useEffect(() => {
    if (questionLabels) {
      console.log('🔍 Setting question labels:', questionLabels);
      // Convert labels object to editable array format for the UI
      if (typeof questionLabels === 'object') {
        const labelsArray = Object.entries(questionLabels).map(([field, label]) => ({
          field,
          label
        }));
        setSurveyQuestions(labelsArray.length > 0 ? labelsArray : [{ field: '', label: '' }]);
      } else {
        setSurveyQuestions([{ field: '', label: '' }]);
      }
    } else {
      // If no labels loaded, start with one empty entry
      setSurveyQuestions([{ field: '', label: '' }]);
    }
  }, [questionLabels]);

  // ✅ Handle question label changes
  const handleQuestionChange = (index, field, value) => {
    const updatedQuestions = [...surveyQuestions];
    updatedQuestions[index] = {
      ...updatedQuestions[index],
      [field]: value
    };
    setSurveyQuestions(updatedQuestions);
  };

  // ✅ Add new question label
  const addQuestionLabel = () => {
    setSurveyQuestions([...surveyQuestions, { field: '', label: '' }]);
  };

  // ✅ Remove question label
  const removeQuestionLabel = (index) => {
    if (surveyQuestions.length > 1) {
      const newQuestions = surveyQuestions.filter((_, i) => i !== index);
      setSurveyQuestions(newQuestions);
    }
  };

  // ✅ Load current form labels from your actual form
  const loadCurrentFormLabels = () => {
    const currentFormLabels = [
      { field: 'fullName', label: 'Full Name' },
      { field: 'dateOfBirth', label: 'Date of Birth' },
      { field: 'nationality', label: 'Nationality' },
      { field: 'currentLocation', label: 'Current Location' },
      { field: 'phoneNumber', label: 'Phone Number' },
      { field: 'highestEducation', label: 'Highest Level of Education' },
      { field: 'fieldOfStudy', label: 'Field of Study' },
      { field: 'currentInstitution', label: 'Current/Most Recent Institution' },
      { field: 'graduationYear', label: 'Graduation Year' },
      { field: 'currentOccupation', label: 'Current Occupation' },
      { field: 'workExperience', label: 'Years of Work Experience' },
      { field: 'reasonForJoining', label: 'Why do you want to join Ikoota?' },
      { field: 'educationalGoals', label: 'What are your educational goals?' },
      { field: 'expectedContributions', label: 'How do you plan to contribute to the community?' },
      { field: 'howDidYouHear', label: 'How did you hear about Ikoota?' },
      { field: 'languagesSpoken', label: 'Languages Spoken' },
      { field: 'agreeToTerms', label: 'I agree to the Terms and Conditions' },
      { field: 'agreeToCodeOfConduct', label: 'I agree to follow the Community Code of Conduct' },
      { field: 'agreeToDataProcessing', label: 'I consent to processing of my personal data' }
    ];
    setSurveyQuestions(currentFormLabels);
  };

  // ✅ Save question labels
  const saveQuestionLabels = () => {
    // Convert array format back to object format for API
    const labelsObject = {};
    surveyQuestions.forEach(item => {
      if (item.field && item.field.trim() && item.label && item.label.trim()) {
        labelsObject[item.field.trim()] = item.label.trim();
      }
    });
    
    updateLabels(labelsObject);
  };

  // ✅ Handle approval/decline actions
  const handleApproveOrDecline = (surveyId, userId, status) => {
    console.log('🔍 Handling approval/decline:', { surveyId, userId, status });
    updateApprovalStatus({ surveyId, userId, status });
  };

  // ✅ Send feedback email
  const handleSendFeedback = (email, status) => {
    console.log('🔍 Sending feedback:', { email, status });
    const feedbackTemplate = status === "granted" ? "approveverifyinfo" : "suspendedverifyinfo";
    api.post("/email/send", { email, template: feedbackTemplate, status })
      .then(() => {
        console.log('✅ Feedback sent successfully');
        alert('Feedback email sent successfully!');
      })
      .catch((error) => {
        console.error('❌ Error sending feedback:', error);
        alert('Failed to send feedback email: ' + error.message);
      });
  };

  // ✅ Enhanced survey answers rendering with proper formatting
  const renderSurveyAnswers = (answers) => {
    try {
      console.log('🔍 Raw answers data:', answers, typeof answers);
      
      if (!answers) {
        return (
          <div className="no-answers">
            <em>No answers provided</em>
          </div>
        );
      }

      let parsedAnswers;

      // Handle string JSON data
      if (typeof answers === 'string') {
        try {
          parsedAnswers = JSON.parse(answers);
        } catch (parseError) {
          console.warn('⚠️ Error parsing JSON string:', parseError);
          return (
            <div className="invalid-answers">
              <strong>Raw Answer Data:</strong>
              <pre style={{ whiteSpace: 'pre-wrap', fontSize: '0.9em' }}>
                {answers}
              </pre>
            </div>
          );
        }
      } else {
        parsedAnswers = answers;
      }

      console.log('🔍 Parsed answers:', parsedAnswers);

      // Handle array of question-answer objects (new format)
      if (Array.isArray(parsedAnswers)) {
        // Check if it's array of objects with question/answer structure
        if (parsedAnswers.length > 0 && typeof parsedAnswers[0] === 'object' && parsedAnswers[0].question) {
          return (
            <div className="survey-answers-detailed">
              {parsedAnswers.map((item, index) => (
                <div key={index} className="answer-item">
                  <div className="question-label">
                    <strong>{formatQuestionLabel(item.question)}:</strong>
                  </div>
                  <div className="answer-value">
                    {formatAnswerValue(item.answer)}
                  </div>
                </div>
              ))}
            </div>
          );
        } 
        // Handle simple array format (old format)
        else {
          return (
            <div className="survey-answers-simple">
              <div className="answer-list">
                {parsedAnswers.map((answer, index) => (
                  <div key={index} className="simple-answer">
                    <strong>Answer {index + 1}:</strong> {answer || 'No response'}
                  </div>
                ))}
              </div>
            </div>
          );
        }
      }

      // Handle object format (alternative format)
      if (typeof parsedAnswers === 'object') {
        return (
          <div className="survey-answers-object">
            {Object.entries(parsedAnswers).map(([key, value], index) => (
              <div key={index} className="answer-item">
                <div className="question-label">
                  <strong>{formatQuestionLabel(key)}:</strong>
                </div>
                <div className="answer-value">
                  {formatAnswerValue(value)}
                </div>
              </div>
            ))}
          </div>
        );
      }

      // Fallback for any other format
      return (
        <div className="fallback-answers">
          <strong>Survey Response:</strong>
          <pre style={{ whiteSpace: 'pre-wrap', fontSize: '0.9em' }}>
            {JSON.stringify(parsedAnswers, null, 2)}
          </pre>
        </div>
      );

    } catch (error) {
      console.error('❌ Critical error in renderSurveyAnswers:', error);
      return (
        <div className="error-answers">
          <em style={{ color: 'red' }}>Error displaying answers: {error.message}</em>
          <details style={{ marginTop: '10px' }}>
            <summary>Raw Data (for debugging)</summary>
            <pre style={{ fontSize: '0.8em', background: '#f5f5f5', padding: '10px' }}>
              {JSON.stringify(answers, null, 2)}
            </pre>
          </details>
        </div>
      );
    }
  };

  // ✅ Helper function to format question labels
  const formatQuestionLabel = (questionKey) => {
    const labelMap = {
      fullName: 'Full Name',
      dateOfBirth: 'Date of Birth',
      nationality: 'Nationality',
      currentLocation: 'Current Location',
      phoneNumber: 'Phone Number',
      highestEducation: 'Highest Education',
      fieldOfStudy: 'Field of Study',
      currentInstitution: 'Current Institution',
      graduationYear: 'Graduation Year',
      currentOccupation: 'Current Occupation',
      workExperience: 'Work Experience',
      professionalSkills: 'Professional Skills',
      careerGoals: 'Career Goals',
      howDidYouHear: 'How Did You Hear About Us',
      reasonForJoining: 'Reason for Joining',
      expectedContributions: 'Expected Contributions',
      educationalGoals: 'Educational Goals',
      previousMemberships: 'Previous Memberships',
      specialSkills: 'Special Skills',
      languagesSpoken: 'Languages Spoken',
      availabilityForEvents: 'Availability for Events',
      agreeToTerms: 'Agree to Terms',
      agreeToCodeOfConduct: 'Agree to Code of Conduct',
      agreeToDataProcessing: 'Agree to Data Processing'
    };

    return labelMap[questionKey] || questionKey.charAt(0).toUpperCase() + questionKey.slice(1);
  };

  // ✅ Helper function to format answer values
  const formatAnswerValue = (answer) => {
    if (answer === true || answer === 'true') {
      return <span style={{ color: 'green' }}>✅ Yes</span>;
    }
    if (answer === false || answer === 'false') {
      return <span style={{ color: 'red' }}>❌ No</span>;
    }
    if (!answer || answer === '') {
      return <em style={{ color: '#888' }}>Not provided</em>;
    }
    return answer;
  };

  return (
    <div className="auth_controls_body">
      {/* ✅ Context-aware header */}
      <div className="admin_controls_header">
        Auth Controls
        {isInAdminContext && (
          <small style={{ fontSize: '0.8rem', color: '#666', marginLeft: '10px' }}>
            (Admin Panel)
          </small>
        )}
      </div>

      {/* Section: Edit Survey Question Labels */}
      <div className="section">
        <h3>Edit Survey Question Labels</h3>
        <p style={{ color: '#666', marginBottom: '20px', fontSize: '14px' }}>
          Update the labels/text that appear in your survey form. These changes will be reflected in the 
          Applicationsurvey.jsx form that users fill out.
        </p>
        
        {labelsLoading && <p>Loading question labels...</p>}
        
        {/* ✅ Question label management interface */}
        <div className="question-labels-container">
          {Array.isArray(surveyQuestions) && surveyQuestions.map((item, index) => (
            <div key={index} className="question-label-item" style={{ 
              marginBottom: '15px', 
              padding: '15px', 
              border: '1px solid #ddd', 
              borderRadius: '6px',
              backgroundColor: '#f9f9f9'
            }}>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                  <span style={{ minWidth: '60px', fontWeight: 'bold', color: '#666' }}>
                    #{index + 1}
                  </span>
                  <div style={{ flex: 1, display: 'flex', gap: '10px' }}>
                    <div style={{ flex: '0 0 200px' }}>
                      <label style={{ fontSize: '12px', color: '#666', display: 'block', marginBottom: '4px' }}>
                        Field Name
                      </label>
                      <input
                        type="text"
                        value={item.field || ''}
                        onChange={(e) => handleQuestionChange(index, 'field', e.target.value)}
                        disabled={updatingLabels}
                        placeholder="e.g., fullName"
                        style={{ 
                          width: '100%', 
                          padding: '8px', 
                          border: '1px solid #ccc', 
                          borderRadius: '4px',
                          fontSize: '13px'
                        }}
                      />
                    </div>
                    <div style={{ flex: 1 }}>
                      <label style={{ fontSize: '12px', color: '#666', display: 'block', marginBottom: '4px' }}>
                        Label Text (What users see)
                      </label>
                      <input
                        type="text"
                        value={item.label || ''}
                        onChange={(e) => handleQuestionChange(index, 'label', e.target.value)}
                        disabled={updatingLabels}
                        placeholder="e.g., Full Name"
                        style={{ 
                          width: '100%', 
                          padding: '8px', 
                          border: '1px solid #ccc', 
                          borderRadius: '4px',
                          fontSize: '13px'
                        }}
                      />
                    </div>
                  </div>
                  {surveyQuestions.length > 1 && (
                    <button
                      type="button"
                      onClick={() => removeQuestionLabel(index)}
                      disabled={updatingLabels}
                      style={{
                        padding: '6px 10px',
                        backgroundColor: '#dc3545',
                        color: 'white',
                        border: 'none',
                        borderRadius: '4px',
                        cursor: 'pointer',
                        fontSize: '12px'
                      }}
                      title="Remove this question label"
                    >
                      ✕
                    </button>
                  )}
                </div>
              </div>
            </div>
          ))}
        </div>
        
        {/* ✅ Action buttons */}
        <div className="question-labels-actions" style={{ 
          marginTop: '20px', 
          display: 'flex', 
          gap: '10px', 
          flexWrap: 'wrap',
          alignItems: 'center'
        }}>
          <button
            type="button"
            onClick={addQuestionLabel}
            disabled={updatingLabels}
            style={{
              padding: '10px 15px',
              backgroundColor: '#28a745',
              color: 'white',
              border: 'none',
              borderRadius: '4px',
              cursor: 'pointer',
              fontSize: '14px'
            }}
          >
            ➕ Add Label
          </button>
          
          <button
            type="button"
            onClick={loadCurrentFormLabels}
            disabled={updatingLabels}
            style={{
              padding: '10px 15px',
              backgroundColor: '#17a2b8',
              color: 'white',
              border: 'none',
              borderRadius: '4px',
              cursor: 'pointer',
              fontSize: '14px'
            }}
          >
            📋 Load Current Form Labels
          </button>
          
          <button 
            onClick={saveQuestionLabels}
            disabled={updatingLabels || !Array.isArray(surveyQuestions)}
            style={{
              padding: '10px 20px',
              backgroundColor: updatingLabels ? '#6c757d' : '#007bff',
              color: 'white',
              border: 'none',
              borderRadius: '4px',
              cursor: updatingLabels ? 'not-allowed' : 'pointer',
              fontSize: '14px',
              fontWeight: 'bold'
            }}
          >
            {updatingLabels ? '⏳ Saving...' : '💾 Save Labels'}
          </button>
        </div>
        
        {/* ✅ Helpful info */}
        <div style={{ 
          marginTop: '20px', 
          padding: '15px', 
          backgroundColor: '#e8f4f8', 
          borderRadius: '6px',
          fontSize: '14px',
          color: '#0c5460'
        }}>
          <strong>📌 How This Works:</strong>
          <ul style={{ marginLeft: '20px', marginBottom: '0', marginTop: '8px' }}>
            <li><strong>Field Name:</strong> Must match the field names in your Applicationsurvey.jsx component</li>
            <li><strong>Label Text:</strong> This is what users will see as the question/label text</li>
            <li><strong>Dynamic Updates:</strong> Changes here will update the actual survey form users fill out</li>
            <li><strong>Load Current:</strong> Use "Load Current Form Labels" to see your existing form fields</li>
          </ul>
        </div>
        
        {/* ✅ Preview section */}
        <div style={{ 
          marginTop: '20px', 
          padding: '15px', 
          backgroundColor: '#f8f9fa', 
          borderRadius: '6px',
          border: '1px solid #dee2e6'
        }}>
          <h4 style={{ margin: '0 0 15px 0', color: '#495057' }}>📋 Preview of Current Labels:</h4>
          <div style={{ fontSize: '13px', color: '#6c757d' }}>
            {surveyQuestions.filter(item => item.field && item.label).length > 0 ? (
              <div style={{ maxHeight: '200px', overflowY: 'auto' }}>
                {surveyQuestions
                  .filter(item => item.field && item.label)
                  .map((item, index) => (
                    <div key={index} style={{ marginBottom: '5px' }}>
                      <strong>{item.field}:</strong> "{item.label}"
                    </div>
                  ))
                }
              </div>
            ) : (
              <em>No valid labels configured yet. Use "Load Current Form Labels" to get started.</em>
            )}
          </div>
        </div>
      </div>

      {/* Section: Fetch and Vet Survey Forms */}
      <div className="section">
        <h3>Vetting Survey Forms</h3>
        
        {/* ✅ Survey logs loading and error states */}
        {surveysLoading && (
          <div className="loading-state">
            <p>Loading survey submissions...</p>
          </div>
        )}
        
        {surveysError && (
          <div className="error-state" style={{ color: 'red', padding: '10px', border: '1px solid red', borderRadius: '4px', marginBottom: '10px' }}>
            <strong>Error loading surveys:</strong> {surveysError.message}
            <button 
              onClick={() => fetchSurveyLogs()} 
              style={{ marginLeft: '10px', padding: '5px 10px' }}
            >
              Retry
            </button>
          </div>
        )}

        {/* ✅ Display survey submissions */}
        {surveys && surveys.length > 0 ? (
          <div className="surveys-list">
            {surveys.map((survey, index) => (
              <div key={survey.id || index} className="survey-item" style={{
                border: '1px solid #ddd',
                borderRadius: '8px',
                padding: '15px',
                marginBottom: '15px',
                backgroundColor: survey.approval_status === 'approved' ? '#f0f8f0' : 
                               survey.approval_status === 'declined' ? '#fff0f0' : '#fff'
              }}>
                {/* ✅ Survey header with user info */}
                <div className="survey-header" style={{ 
                  display: 'flex', 
                  justifyContent: 'space-between', 
                  alignItems: 'center',
                  marginBottom: '10px',
                  paddingBottom: '10px',
                  borderBottom: '1px solid #eee'
                }}>
                  <div className="user-info">
                    <h4 style={{ margin: '0 0 5px 0' }}>
                      Survey #{survey.id} - {survey.username || 'Unknown User'}
                    </h4>
                    <p style={{ margin: '0', color: '#666', fontSize: '0.9em' }}>
                      Email: {survey.user_email || 'No email'}
                    </p>
                    <p style={{ margin: '0', color: '#666', fontSize: '0.9em' }}>
                      Submitted: {survey.createdAt ? new Date(survey.createdAt).toLocaleDateString() : 'Unknown date'}
                    </p>
                    {survey.application_ticket && (
                      <p style={{ margin: '0', color: '#666', fontSize: '0.8em' }}>
                        Ticket: {survey.application_ticket}
                      </p>
                    )}
                  </div>
                  
                  <div className="status-badge">
                    <span style={{
                      padding: '5px 10px',
                      borderRadius: '15px',
                      fontSize: '0.8em',
                      fontWeight: 'bold',
                      backgroundColor: survey.approval_status === 'approved' ? '#d4edda' : 
                                     survey.approval_status === 'declined' ? '#f8d7da' : 
                                     survey.approval_status === 'granted' ? '#d4edda' : '#fff3cd',
                      color: survey.approval_status === 'approved' ? '#155724' : 
                             survey.approval_status === 'declined' ? '#721c24' : 
                             survey.approval_status === 'granted' ? '#155724' : '#856404'
                    }}>
                      {survey.approval_status?.toUpperCase() || 'PENDING'}
                    </span>
                  </div>
                </div>

                {/* ✅ Basic Info Grid */}
                <div className="survey-info" style={{
                  display: 'grid',
                  gridTemplateColumns: '1fr 1fr',
                  gap: '10px',
                  marginBottom: '20px'
                }}>
                  <div><strong>User ID:</strong> {survey.user_id}</div>
                  <div><strong>Email:</strong> {survey.user_email || 'N/A'}</div>
                  <div><strong>Application Type:</strong> {survey.application_type || 'initial_application'}</div>
                  <div><strong>Membership Stage:</strong> {survey.membership_stage || 'N/A'}</div>
                </div>

                {/* ✅ Survey answers display */}
                <div className="survey-answers-section" style={{
                  backgroundColor: '#f8f9fa',
                  padding: '15px',
                  borderRadius: '5px',
                  marginBottom: '15px'
                }}>
                  <h5 style={{ marginTop: '0', marginBottom: '15px', color: '#495057' }}>
                    📝 Survey Responses:
                  </h5>
                  {renderSurveyAnswers(survey.answers)}
                </div>

                {/* Admin Notes */}
                {survey.admin_notes && (
                  <div style={{ 
                    backgroundColor: '#e8f4fd', 
                    padding: '10px', 
                    borderRadius: '5px',
                    marginBottom: '15px'
                  }}>
                    <strong>Admin Notes:</strong> {survey.admin_notes}
                  </div>
                )}

                {/* ✅ Action buttons */}
                <div className="survey-actions" style={{ 
                  marginTop: '15px', 
                  paddingTop: '15px', 
                  borderTop: '1px solid #eee',
                  display: 'flex',
                  gap: '10px',
                  flexWrap: 'wrap'
                }}>
                  <button
                    onClick={() => handleApproveOrDecline(survey.id, survey.user_id, 'approved')}
                    disabled={updatingApproval || survey.approval_status === 'approved' || survey.approval_status === 'granted'}
                    style={{
                      padding: '8px 16px',
                      backgroundColor: (survey.approval_status === 'approved' || survey.approval_status === 'granted') ? '#95a5a6' : '#28a745',
                      color: 'white',
                      border: 'none',
                      borderRadius: '4px',
                      cursor: (survey.approval_status === 'approved' || survey.approval_status === 'granted') ? 'not-allowed' : 'pointer'
                    }}
                  >
                    {(survey.approval_status === 'approved' || survey.approval_status === 'granted') ? '✅ Already Approved' : 
                     updatingApproval ? 'Processing...' : '✅ Approve'}
                  </button>
                  
                  <button
                    onClick={() => handleApproveOrDecline(survey.id, survey.user_id, 'declined')}
                    disabled={updatingApproval || survey.approval_status === 'declined'}
                    style={{
                      padding: '8px 16px',
                      backgroundColor: survey.approval_status === 'declined' ? '#95a5a6' : '#dc3545',
                      color: 'white',
                      border: 'none',
                      borderRadius: '4px',
                      cursor: survey.approval_status === 'declined' ? 'not-allowed' : 'pointer'
                    }}
                  >
                    {survey.approval_status === 'declined' ? '❌ Already Declined' : 
                     updatingApproval ? 'Processing...' : '❌ Decline'}
                  </button>
                  
                  {survey.user_email && (
                    <button
                      onClick={() => handleSendFeedback(survey.user_email, survey.approval_status)}
                      style={{
                        padding: '8px 16px',
                        backgroundColor: '#007bff',
                        color: 'white',
                        border: 'none',
                        borderRadius: '4px',
                        cursor: 'pointer'
                      }}
                    >
                      📧 Send Feedback
                    </button>
                  )}

                  <button
                    onClick={() => setSelectedSurvey(selectedSurvey === survey.id ? null : survey.id)}
                    style={{
                      padding: '8px 16px',
                      backgroundColor: '#6c757d',
                      color: 'white',
                      border: 'none',
                      borderRadius: '4px',
                      cursor: 'pointer'
                    }}
                  >
                    {selectedSurvey === survey.id ? 'Hide Details' : 'View Details'}
                  </button>
                </div>

                {/* ✅ Detailed view when selected */}
                {selectedSurvey === survey.id && (
                  <div className="survey-details" style={{
                    marginTop: '15px',
                    padding: '15px',
                    backgroundColor: '#f8f9fa',
                    borderRadius: '4px'
                  }}>
                    <h5>Full Survey Details:</h5>
                    <pre style={{ 
                      whiteSpace: 'pre-wrap', 
                      fontSize: '0.85em',
                      maxHeight: '300px',
                      overflow: 'auto'
                    }}>
                      {JSON.stringify(survey, null, 2)}
                    </pre>
                  </div>
                )}
              </div>
            ))}
          </div>
        ) : (
          !surveysLoading && !surveysError && (
            <div className="no-surveys" style={{ 
              textAlign: 'center', 
              padding: '20px', 
              color: '#666',
              fontStyle: 'italic'
            }}>
              No survey submissions found.
            </div>
          )
        )}

        {/* ✅ Refresh button */}
        <div style={{ marginTop: '20px' }}>
          <button 
            onClick={() => fetchSurveyLogs()}
            disabled={surveysLoading}
            style={{
              padding: '10px 20px',
              backgroundColor: '#17a2b8',
              color: 'white',
              border: 'none',
              borderRadius: '4px',
              cursor: 'pointer'
            }}
          >
            {surveysLoading ? 'Refreshing...' : 'Refresh Survey List'}
          </button>
        </div>
      </div>

      {/* Section: Update User Roles */}
      <div className="section">
        <h3>Update User Roles</h3>
        <div style={{ display: 'flex', gap: '10px', marginBottom: '10px', flexWrap: 'wrap' }}>
          <input
            type="text"
            placeholder="User ID"
            value={userRoleUpdates.userId}
            onChange={(e) => setUserRoleUpdates({ ...userRoleUpdates, userId: e.target.value })}
            disabled={updatingRole}
            style={{ padding: '8px', minWidth: '200px' }}
          />
          <select
            value={userRoleUpdates.role}
            onChange={(e) => setUserRoleUpdates({ ...userRoleUpdates, role: e.target.value })}
            disabled={updatingRole}
            style={{ padding: '8px', minWidth: '150px' }}
          >
            <option value="">Select Role</option>
            <option value="user">User</option>
            <option value="admin">Admin</option>
            <option value="moderator">Moderator</option>
            <option value="member">Member</option>
          </select>
          <button
            onClick={() => updateUserRole(userRoleUpdates)}
            disabled={updatingRole || !userRoleUpdates.userId || !userRoleUpdates.role}
            style={{
              padding: '8px 16px',
              backgroundColor: '#28a745',
              color: 'white',
              border: 'none',
              borderRadius: '4px',
              cursor: 'pointer'
            }}
          >
            {updatingRole ? 'Updating...' : 'Update Role'}
          </button>
        </div>
        <small style={{ color: '#666' }}>
          Enter the user ID and select a new role to update user permissions.
        </small>
      </div>

      {/* ✅ Context-aware footer */}
      <div className="auth-controls-footer" style={{ 
        marginTop: '30px', 
        paddingTop: '20px', 
        borderTop: '1px solid #eee',
        fontSize: '0.9em',
        color: '#666'
      }}>
        {isInAdminContext ? (
          <p>You are viewing AuthControls in Admin Panel context with full administrative privileges.</p>
        ) : (
          <p>AuthControls running in standalone mode.</p>
        )}
      </div>
    </div>
  );
};

export default AuthControls;



//==========================================

// ikootaclient/src/components/auth/Applicationsurvey.jsx - CORRECTED TO STOP AUTO REDIRECTS
import React, { useState, useEffect, useCallback, useRef } from 'react';
import { useNavigate } from 'react-router-dom';
import { useUser } from './UserStatus';
import './applicationSurvey.css';
import api from '../service/api';
import { useDynamicLabels } from '../../hooks/useDynamicLabels';


const ApplicationSurvey = () => {
  const navigate = useNavigate();
  const { labels: dynamicLabels, loading: labelsLoading } = useDynamicLabels();
  const { user, isAuthenticated } = useUser();
  const [loading, setLoading] = useState(false);
  const [submitSuccess, setSubmitSuccess] = useState(false);
  const [error, setError] = useState('');
  const [currentStep, setCurrentStep] = useState(1);
  const [lastSaved, setLastSaved] = useState(null);
  const [isAutoSaving, setIsAutoSaving] = useState(false);
  const totalSteps = 4;

  // ✅ ADD REFS TO PREVENT API LOOPS
  const statusCheckRef = useRef(false);
  const hasCheckedStatus = useRef(false);
  const initialLoadComplete = useRef(false);

  // Storage key for this user's application data
  const STORAGE_KEY = `ikoota_application_${user?.id || 'guest'}`;
  const STEP_STORAGE_KEY = `ikoota_application_step_${user?.id || 'guest'}`;

  // Initial form data
  const initialFormData = {
    // Personal Information
    fullName: '',
    dateOfBirth: '',
    nationality: '',
    currentLocation: '',
    phoneNumber: '',
    
    // Educational Background
    highestEducation: '',
    fieldOfStudy: '',
    currentInstitution: '',
    graduationYear: '',
    
    // Professional Background
    currentOccupation: '',
    workExperience: '',
    professionalSkills: [],
    careerGoals: '',
    
    // Interest in Ikoota
    howDidYouHear: '',
    reasonForJoining: '',
    expectedContributions: '',
    educationalGoals: '',
    
    // Additional Information
    previousMemberships: '',
    specialSkills: '',
    languagesSpoken: [],
    availabilityForEvents: '',
    
    // Agreements
    agreeToTerms: false,
    agreeToCodeOfConduct: false,
    agreeToDataProcessing: false
  };

  // Form state with auto-save functionality
  const [formData, setFormData] = useState(initialFormData);

  // Load saved data from localStorage
  const loadSavedData = useCallback(() => {
    try {
      const savedData = localStorage.getItem(STORAGE_KEY);
      const savedStep = localStorage.getItem(STEP_STORAGE_KEY);
      
      if (savedData) {
        const parsedData = JSON.parse(savedData);
        console.log('📂 Loading saved application data:', Object.keys(parsedData).length, 'fields');
        
        setFormData(prev => ({
          ...prev,
          ...parsedData
        }));
        
        const savedTime = parsedData._savedAt;
        if (savedTime) {
          setLastSaved(new Date(savedTime));
        }
      }
      
      if (savedStep) {
        const stepNumber = parseInt(savedStep, 10);
        if (stepNumber >= 1 && stepNumber <= totalSteps) {
          setCurrentStep(stepNumber);
          console.log('📂 Resuming from step:', stepNumber);
        }
      }
    } catch (error) {
      console.error('❌ Error loading saved data:', error);
      // If there's corrupted data, clear it
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(STEP_STORAGE_KEY);
    }
  }, [STORAGE_KEY, STEP_STORAGE_KEY, totalSteps]);

  // Save data to localStorage
  const saveToStorage = useCallback((dataToSave, stepToSave = currentStep) => {
    try {
      const saveData = {
        ...dataToSave,
        _savedAt: new Date().toISOString(),
        _version: '1.0' // For future migrations if needed
      };
      
      localStorage.setItem(STORAGE_KEY, JSON.stringify(saveData));
      localStorage.setItem(STEP_STORAGE_KEY, stepToSave.toString());
      setLastSaved(new Date());
      
      console.log('💾 Auto-saved application data');
    } catch (error) {
      console.error('❌ Error saving data:', error);
      // Handle storage quota exceeded
      if (error.name === 'QuotaExceededError') {
        alert('Storage space is full. Please clear some browser data and try again.');
      }
    }
  }, [STORAGE_KEY, STEP_STORAGE_KEY, currentStep]);

  // Clear saved data
  const clearSavedData = useCallback(() => {
    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(STEP_STORAGE_KEY);
    setLastSaved(null);
    console.log('🗑️ Cleared saved application data');
  }, [STORAGE_KEY, STEP_STORAGE_KEY]);

  // ✅ FIXED: Status check with NO AUTO-REDIRECT
  const checkApplicationStatus = useCallback(async () => {
    // Prevent multiple simultaneous calls
    if (statusCheckRef.current || hasCheckedStatus.current) {
      console.log('🚫 Skipping status check - already in progress or completed');
      return;
    }

    statusCheckRef.current = true;
    hasCheckedStatus.current = true;

    try {
      console.log('🔍 Checking application status... (ONE TIME ONLY)');
      
      const response = await api.get('/membership/survey/check-status');
      console.log('✅ Response data:', response.data);
      
      // ✅ CRITICAL FIX: DO NOT REDIRECT IF SURVEY NOT COMPLETED
      // Let the user stay on the survey page to complete it
      if (response.data.survey_completed) {
        console.log('✅ Survey already completed, redirecting to status page');
        clearSavedData();
        navigate('/application-status');
        return;
      }

      // ✅ If survey not completed, let user fill it out - DON'T REDIRECT
      console.log('📝 Survey not completed - allowing user to fill it out');
      
      // Only load saved data if survey not completed and we haven't loaded yet
      if (!initialLoadComplete.current) {
        loadSavedData();
        initialLoadComplete.current = true;
      }
      
      return response.data;
      
    } catch (error) {
      console.error('❌ Error checking application status:', error);
      // Don't block the user from continuing with their saved data
      if (!initialLoadComplete.current) {
        loadSavedData();
        initialLoadComplete.current = true;
      }
    } finally {
      statusCheckRef.current = false;
    }
  }, [clearSavedData, loadSavedData, navigate]);

  // Auto-save with debouncing
  useEffect(() => {
    if (!user?.id || !initialLoadComplete.current) return; // Don't save if no user or not loaded

    const timeoutId = setTimeout(() => {
      setIsAutoSaving(true);
      saveToStorage(formData, currentStep);
      setTimeout(() => setIsAutoSaving(false), 500);
    }, 2000); // Auto-save after 2 seconds of no changes

    return () => clearTimeout(timeoutId);
  }, [formData, currentStep, saveToStorage, user?.id]);

  // ✅ FIXED: Check authentication and application status ONCE
  useEffect(() => {
    if (!isAuthenticated) {
      navigate('/login');
      return;
    }

    // Only check status once on mount
    if (!hasCheckedStatus.current) {
      console.log('🚀 Applicationsurvey mounted - checking status once');
      checkApplicationStatus();
    }
  }, [isAuthenticated, navigate, checkApplicationStatus]);

  const handleInputChange = (e) => {
    const { name, value, type, checked } = e.target;
    
    setFormData(prev => {
      let newData = { ...prev };
      
      if (type === 'checkbox') {
        if (name === 'professionalSkills' || name === 'languagesSpoken') {
          // Handle array checkboxes
          newData[name] = checked 
            ? [...prev[name], value]
            : prev[name].filter(item => item !== value);
        } else {
          newData[name] = checked;
        }
      } else {
        newData[name] = value;
      }
      
      return newData;
    });
  };

  const validateStep = (step) => {
    const errors = [];
    
    switch (step) {
      case 1: // Personal Information
        if (!formData.fullName) errors.push('Full name is required');
        if (!formData.dateOfBirth) errors.push('Date of birth is required');
        if (!formData.nationality) errors.push('Nationality is required');
        if (!formData.currentLocation) errors.push('Current location is required');
        break;
        
      case 2: // Educational Background
        if (!formData.highestEducation) errors.push('Highest education is required');
        if (!formData.fieldOfStudy) errors.push('Field of study is required');
        break;
        
      case 3: // Professional Background & Interest
        if (!formData.currentOccupation) errors.push('Current occupation is required');
        if (!formData.reasonForJoining) errors.push('Reason for joining is required');
        if (!formData.educationalGoals) errors.push('Educational goals are required');
        break;
        
      case 4: // Agreements
        if (!formData.agreeToTerms) errors.push('You must agree to terms and conditions');
        if (!formData.agreeToCodeOfConduct) errors.push('You must agree to code of conduct');
        if (!formData.agreeToDataProcessing) errors.push('You must agree to data processing');
        break;
    }
    
    if (errors.length > 0) {
      setError(errors.join(', '));
      return false;
    }
    
    setError('');
    return true;
  };

  const nextStep = () => {
    if (validateStep(currentStep)) {
      const newStep = Math.min(currentStep + 1, totalSteps);
      setCurrentStep(newStep);
      // Save immediately when moving to next step
      saveToStorage(formData, newStep);
    }
  };

  const prevStep = () => {
    const newStep = Math.max(currentStep - 1, 1);
    setCurrentStep(newStep);
    setError('');
    // Save immediately when moving to previous step
    saveToStorage(formData, newStep);
  };

  // const handleSubmit = async (e) => {
  //   e.preventDefault();
    
  //   if (!validateStep(currentStep)) {
  //     return;
  //   }

  //   setLoading(true);
  //   setError('');

  //   try {
  //     // Prepare answers array for backend
  //     const answers = Object.entries(formData)
  //       .filter(([key]) => !key.startsWith('_')) // Exclude internal keys like _savedAt
  //       .map(([key, value]) => ({
  //         question: key,
  //         answer: Array.isArray(value) ? value.join(', ') : value.toString()
  //       }));

  //     const response = await api.post('/membership/survey/submit-application', {
  //       answers,
  //       applicationTicket: `APP-${user.username?.substring(0,3).toUpperCase()}-${Date.now().toString(36)}`
  //     });

  //     const data = response.data;

  //     // Clear saved data after successful submission
  //     clearSavedData();
      
  //     setSubmitSuccess(true);
      
  //     // Redirect to success page after delay
  //     setTimeout(() => {
  //       navigate('/pending-verification', {
  //         state: {
  //           applicationTicket: data.applicationTicket,
  //           username: user.username
  //         }
  //       });
  //     }, 3000);

  //   } catch (error) {
  //     console.error('Error submitting application:', error);
      
  //     if (error.response) {
  //       setError(error.response.data?.error || error.response.data?.message || 'Failed to submit application');
  //     } else if (error.request) {
  //       setError('Network error. Please check your connection and try again.');
  //     } else {
  //       setError('An unexpected error occurred. Please try again.');
  //     }
  //   } finally {
  //     setLoading(false);
  //   }
  // };

  // Manual save function
  
  const handleSubmit = async (e) => {
  e.preventDefault();
  
  if (!validateStep(currentStep)) {
    return;
  }

  setLoading(true);
  setError('');

  try {
    // Prepare answers array for backend
    const answers = Object.entries(formData)
      .filter(([key]) => !key.startsWith('_')) // Exclude internal keys like _savedAt
      .map(([key, value]) => ({
        question: key,
        answer: Array.isArray(value) ? value.join(', ') : value.toString()
      }));

    const response = await api.post('/membership/survey/submit-application', {
      answers,
      applicationTicket: `APP-${user.username?.substring(0,3).toUpperCase()}-${Date.now().toString(36)}`,
      username: user.username, // ADD THIS LINE
      userId: user.id || user.user_id // ADD THIS LINE TOO
    });

    const data = response.data;

    // Clear saved data after successful submission
    clearSavedData();
    
    setSubmitSuccess(true);
    
    // Redirect to success page after delay
    setTimeout(() => {
      navigate('/pending-verification', {
        state: {
          applicationTicket: data.applicationTicket,
          username: user.username
        }
      });
    }, 3000);

  } catch (error) {
    console.error('Error submitting application:', error);
    
    if (error.response) {
      setError(error.response.data?.error || error.response.data?.message || 'Failed to submit application');
    } else if (error.request) {
      setError('Network error. Please check your connection and try again.');
    } else {
      setError('An unexpected error occurred. Please try again.');
    }
  } finally {
    setLoading(false);
  }
};
  
  
  const handleManualSave = () => {
    setIsAutoSaving(true);
    saveToStorage(formData, currentStep);
    setTimeout(() => setIsAutoSaving(false), 1000);
  };

  // Clear data confirmation
  const handleClearData = () => {
    if (window.confirm('Are you sure you want to clear all saved data? This action cannot be undone.')) {
      clearSavedData();
      setFormData(initialFormData);
      setCurrentStep(1);
    }
  };

  // Auto-save indicator component
  const AutoSaveIndicator = () => {
    if (isAutoSaving) {
      return (
        <div className="auto-save-indicator saving">
          <span className="save-spinner">⟳</span>
          Saving...
        </div>
      );
    }
    
    if (lastSaved) {
      const timeDiff = Date.now() - lastSaved.getTime();
      const minutes = Math.floor(timeDiff / 60000);
      const seconds = Math.floor((timeDiff % 60000) / 1000);
      
      let timeText;
      if (minutes > 0) {
        timeText = `${minutes}m ago`;
      } else if (seconds > 5) {
        timeText = `${seconds}s ago`;
      } else {
        timeText = 'just now';
      }
      
      return (
        <div className="auto-save-indicator saved">
          <span className="save-icon">✓</span>
          Saved {timeText}
        </div>
      );
    }
    
    return null;
  };


 const renderStep1 = () => (
    <div className="survey-step">
      <h3>📋 Personal Information</h3>
      
      <div className="form-group">
        <label htmlFor="fullName">{dynamicLabels.fullName} *</label>
        <input
          type="text"
          id="fullName"
          name="fullName"
          value={formData.fullName}
          onChange={handleInputChange}
          placeholder="Enter your full legal name"
          required
        />
      </div>

      <div className="form-row">
        <div className="form-group">
          <label htmlFor="dateOfBirth">{dynamicLabels.dateOfBirth} *</label>
          <input
            type="date"
            id="dateOfBirth"
            name="dateOfBirth"
            value={formData.dateOfBirth}
            onChange={handleInputChange}
            required
          />
        </div>
        
        <div className="form-group">
          <label htmlFor="nationality">{dynamicLabels.nationality} *</label>
          <input
            type="text"
            id="nationality"
            name="nationality"
            value={formData.nationality}
            onChange={handleInputChange}
            placeholder="Your nationality"
            required
          />
        </div>
      </div>

      <div className="form-group">
        <label htmlFor="currentLocation">{dynamicLabels.currentLocation} *</label>
        <input
          type="text"
          id="currentLocation"
          name="currentLocation"
          value={formData.currentLocation}
          onChange={handleInputChange}
          placeholder="City, Country"
          required
        />
      </div>

      <div className="form-group">
        <label htmlFor="phoneNumber">{dynamicLabels.phoneNumber}</label>
        <input
          type="tel"
          id="phoneNumber"
          name="phoneNumber"
          value={formData.phoneNumber}
          onChange={handleInputChange}
          placeholder="+1 (555) 123-4567"
        />
      </div>
    </div>
  );

  const renderStep2 = () => (
    <div className="survey-step">
      <h3>🎓 Educational Background</h3>
      
      <div className="form-group">
        <label htmlFor="highestEducation">{dynamicLabels.highestEducation} *</label>
        <select
          id="highestEducation"
          name="highestEducation"
          value={formData.highestEducation}
          onChange={handleInputChange}
          required
        >
          <option value="">Select your highest education</option>
          <option value="high_school">High School</option>
          <option value="associate">Associate Degree</option>
          <option value="bachelor">Bachelor's Degree</option>
          <option value="master">Master's Degree</option>
          <option value="doctorate">Doctorate/PhD</option>
          <option value="other">Other</option>
        </select>
      </div>

      <div className="form-row">
        <div className="form-group">
          <label htmlFor="fieldOfStudy">{dynamicLabels.fieldOfStudy} *</label>
          <input
            type="text"
            id="fieldOfStudy"
            name="fieldOfStudy"
            value={formData.fieldOfStudy}
            onChange={handleInputChange}
            placeholder="e.g., Computer Science, Business, etc."
            required
          />
        </div>
        
        <div className="form-group">
          <label htmlFor="graduationYear">{dynamicLabels.graduationYear}</label>
          <input
            type="number"
            id="graduationYear"
            name="graduationYear"
            value={formData.graduationYear}
            onChange={handleInputChange}
            placeholder="YYYY"
            min="1950"
            max="2030"
          />
        </div>
      </div>

      <div className="form-group">
        <label htmlFor="currentInstitution">{dynamicLabels.currentInstitution}</label>
        <input
          type="text"
          id="currentInstitution"
          name="currentInstitution"
          value={formData.currentInstitution}
          onChange={handleInputChange}
          placeholder="University or institution name"
        />
      </div>
    </div>
  );

  const renderStep3 = () => (
    <div className="survey-step">
      <h3>💼 Professional Background & Interests</h3>
      
      <div className="form-group">
        <label htmlFor="currentOccupation">{dynamicLabels.currentOccupation} *</label>
        <input
          type="text"
          id="currentOccupation"
          name="currentOccupation"
          value={formData.currentOccupation}
          onChange={handleInputChange}
          placeholder="Your current job title or status"
          required
        />
      </div>

      <div className="form-group">
        <label htmlFor="workExperience">{dynamicLabels.workExperience}</label>
        <select
          id="workExperience"
          name="workExperience"
          value={formData.workExperience}
          onChange={handleInputChange}
        >
          <option value="">Select experience level</option>
          <option value="0-1">0-1 years</option>
          <option value="2-5">2-5 years</option>
          <option value="6-10">6-10 years</option>
          <option value="11-15">11-15 years</option>
          <option value="16+">16+ years</option>
        </select>
      </div>

      <div className="form-group">
        <label htmlFor="reasonForJoining">{dynamicLabels.reasonForJoining} *</label>
        <textarea
          id="reasonForJoining"
          name="reasonForJoining"
          value={formData.reasonForJoining}
          onChange={handleInputChange}
          placeholder="Tell us what motivates you to join our educational community..."
          rows="4"
          required
        />
      </div>

      <div className="form-group">
        <label htmlFor="educationalGoals">{dynamicLabels.educationalGoals} *</label>
        <textarea
          id="educationalGoals"
          name="educationalGoals"
          value={formData.educationalGoals}
          onChange={handleInputChange}
          placeholder="Describe what you hope to learn or achieve through Ikoota..."
          rows="4"
          required
        />
      </div>

      <div className="form-group">
        <label htmlFor="expectedContributions">{dynamicLabels.expectedContributions}</label>
        <textarea
          id="expectedContributions"
          name="expectedContributions"
          value={formData.expectedContributions}
          onChange={handleInputChange}
          placeholder="Share your skills, knowledge, or ways you'd like to help..."
          rows="3"
        />
      </div>
    </div>
  );

  const renderStep4 = () => (
    <div className="survey-step">
      <h3>📄 Additional Information & Agreements</h3>
      
      <div className="form-group">
        <label htmlFor="howDidYouHear">{dynamicLabels.howDidYouHear}</label>
        <select
          id="howDidYouHear"
          name="howDidYouHear"
          value={formData.howDidYouHear}
          onChange={handleInputChange}
        >
          <option value="">Please select</option>
          <option value="social_media">Social Media</option>
          <option value="friend_referral">Friend/Colleague Referral</option>
          <option value="web_search">Web Search</option>
          <option value="online_community">Online Community</option>
          <option value="educational_institution">Educational Institution</option>
          <option value="other">Other</option>
        </select>
      </div>

      <div className="form-group">
        <label>{dynamicLabels.languagesSpoken}</label>
        <div className="checkbox-group">
          {['English', 'Spanish', 'French', 'German', 'Chinese', 'Japanese', 'Arabic', 'Other'].map(lang => (
            <label key={lang} className="checkbox-label">
              <input
                type="checkbox"
                name="languagesSpoken"
                value={lang}
                checked={formData.languagesSpoken.includes(lang)}
                onChange={handleInputChange}
              />
              {lang}
            </label>
          ))}
        </div>
      </div>

      <div className="agreements-section">
        <h4>📋 Required Agreements</h4>
        
        <div className="agreement-item">
          <label className="agreement-label">
            <input
              type="checkbox"
              name="agreeToTerms"
              checked={formData.agreeToTerms}
              onChange={handleInputChange}
              required
            />
            <span className="checkmark"></span>
            {dynamicLabels.agreeToTerms} * <a href="/terms" target="_blank">(View Terms)</a>
          </label>
        </div>

        <div className="agreement-item">
          <label className="agreement-label">
            <input
              type="checkbox"
              name="agreeToCodeOfConduct"
              checked={formData.agreeToCodeOfConduct}
              onChange={handleInputChange}
              required
            />
            <span className="checkmark"></span>
            {dynamicLabels.agreeToCodeOfConduct} * <a href="/code-of-conduct" target="_blank">(View Code)</a>
          </label>
        </div>

        <div className="agreement-item">
          <label className="agreement-label">
            <input
              type="checkbox"
              name="agreeToDataProcessing"
              checked={formData.agreeToDataProcessing}
              onChange={handleInputChange}
              required
            />
            <span className="checkmark"></span>
            {dynamicLabels.agreeToDataProcessing} * <a href="/privacy" target="_blank">(View Policy)</a>
          </label>
        </div>
      </div>
    </div>
  );

  // ✅ Show loading state while labels are being fetched
  if (labelsLoading) {
    return (
      <div className="survey-container">
        <div className="survey-card">
          <div style={{ textAlign: 'center', padding: '40px' }}>
            <div className="loading-spinner"></div>
            <p>Loading survey form...</p>
          </div>
        </div>
      </div>
    );
  }


  if (submitSuccess) {
    return (
      <div className="survey-container">
        <div className="survey-card success-card">
          <div className="success-icon">🎉</div>
          <h2>Application Submitted Successfully!</h2>
          <p>Thank you for completing your membership application. You will be redirected shortly...</p>
          <div className="loading-spinner"></div>
        </div>
      </div>
    );
  }

  return (
    <div className="survey-container">
      <div className="survey-card">
        <div className="survey-header">
          <div className="header-top">
            <h1>🎯 Membership Application Survey</h1>
            <div className="header-actions">
              <AutoSaveIndicator />
              <button 
                type="button" 
                onClick={handleManualSave}
                className="btn-save-manual"
                disabled={isAutoSaving}
                title="Save progress manually"
              >
                💾
              </button>
              <button 
                type="button" 
                onClick={handleClearData}
                className="btn-clear-data"
                title="Clear all saved data"
              >
                🗑️
              </button>
            </div>
          </div>
          <p>Help us get to know you better and understand your educational goals.</p>
          
          <div className="progress-bar">
            <div className="progress-steps">
              {[1, 2, 3, 4].map(step => (
                <div 
                  key={step} 
                  className={`progress-step ${currentStep >= step ? 'active' : ''} ${currentStep > step ? 'completed' : ''}`}
                >
                  <span className="step-number">{step}</span>
                  <span className="step-label">
                    {step === 1 && 'Personal'}
                    {step === 2 && 'Education'}
                    {step === 3 && 'Professional'}
                    {step === 4 && 'Agreements'}
                  </span>
                </div>
              ))}
            </div>
            <div className="progress-fill" style={{ width: `${(currentStep / totalSteps) * 100}%` }}></div>
          </div>
        </div>

        <form onSubmit={handleSubmit} className="survey-form">
          {currentStep === 1 && renderStep1()}
          {currentStep === 2 && renderStep2()}
          {currentStep === 3 && renderStep3()}
          {currentStep === 4 && renderStep4()}

          {error && (
            <div className="error-message">
              <span className="error-icon">⚠️</span>
              {error}
            </div>
          )}

          <div className="form-navigation">
            {currentStep > 1 && (
              <button 
                type="button" 
                onClick={prevStep}
                className="btn-secondary"
                disabled={loading}
              >
                ← Previous
              </button>
            )}
            
            <div className="nav-spacer"></div>
            
            {currentStep < totalSteps ? (
              <button 
                type="button" 
                onClick={nextStep}
                className="btn-primary"
                disabled={loading}
              >
                Next →
              </button>
            ) : (
              <button 
                type="submit" 
                className="btn-primary submit-btn"
                disabled={loading}
              >
                {loading ? (
                  <>
                    <span className="loading-spinner"></span>
                    Submitting...
                  </>
                ) : (
                  '📤 Submit Application'
                )}
              </button>
            )}
          </div>
        </form>

        <div className="survey-footer">
          <p>Step {currentStep} of {totalSteps} • All required fields marked with *</p>
          {lastSaved && (
            <p className="auto-save-info">
              💾 Your progress is automatically saved as you type
            </p>
          )}
        </div>
      </div>
    </div>
  );
};

export default ApplicationSurvey;


//=====================================

// ikootaclient/src/components/auth/AdminRoute.jsx
import React from 'react';
import { Navigate } from 'react-router-dom';
import { jwtDecode } from 'jwt-decode';
import ProtectedRoute from './ProtectedRoute';

const AdminRoute = ({ children }) => {
  const isAdmin = () => {
    const token = localStorage.getItem("token");
    
    if (!token) {
      // Check for token in cookies
      const tokenCookie = document.cookie.split("; ").find((row) => row.startsWith("access_token="));
      if (!tokenCookie) return false;
      
      const cookieToken = tokenCookie.split("=")[1];
      if (!cookieToken) return false;
      
      try {
        const decoded = jwtDecode(cookieToken);
        return decoded.role === 'admin' || decoded.isAdmin === true;
      } catch (error) {
        return false;
      }
    }
    
    try {
      const decoded = jwtDecode(token);
      return decoded.role === 'admin' || decoded.isAdmin === true;
    } catch (error) {
      return false;
    }
  };

  return (
    <ProtectedRoute>
      {isAdmin() ? children : <Navigate to="/iko" replace />}
    </ProtectedRoute>
  );
};

export default AdminRoute;




//=================================
//admin FOLDER
//================================


// ikootaclient/src/components/admin/UserManagement.jsx
// ==================================================
// This component merges ALL functionalities from both:
// - /auth/UserManagement.jsx (legacy user management)
// - /admin/UserManagement.jsx (converse ID & identity masking)
// - NEW: Two-stage membership system management

import React, { useState, useMemo } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import api from '../service/api';
import './userManagement.css';
import { 
  generateUniqueConverseId, 
  generateRandomId, 
  validateIdFormat, 
  formatIdForDisplay 
} from '../service/idGenerationService';

// ==================================================
// API FUNCTIONS - ALL SYSTEMS
// ==================================================

// NEW: Two-Stage Membership System APIs
// const fetchMembershipOverview = async () => {
//   const { data } = await api.get('/membership/admin/membership-overview');
//   return data;
// };

const fetchMembershipOverview = async () => {
  try {
    const { data } = await api.get('/membership/admin/membership-overview');
    return data?.overview || {};
  } catch (error) {
    console.error('❌ Error fetching membership overview:', error);
    return {};
  }
};


// const fetchPendingApplications = async (filters = {}) => {
//   const params = new URLSearchParams(filters);
//   const { data } = await api.get(`/membership/admin/pending-applications?${params}`);
//   return data;
// };


const fetchPendingApplications = async (filters = {}) => {
  try {
    const params = new URLSearchParams(filters);
    const { data } = await api.get(`/membership/admin/pending-applications?${params}`);
    return data || { applications: [], pagination: { total: 0, page: 1, totalPages: 1 } };
  } catch (error) {
    console.error('❌ Error fetching pending applications:', error);
    return { applications: [], pagination: { total: 0, page: 1, totalPages: 1 } };
  }
};


const bulkApproveApplications = async ({ userIds, action, adminNotes }) => {
  const { data } = await api.post('/membership/admin/bulk-approve', {
    userIds,
    action,
    adminNotes
  });
  return data;
};
// THis fxn also exist at membershipcontroller.js
const updateApplicationStatus = async ({ userId, status, adminNotes }) => {
  const { data } = await api.put(`/membership/admin/update-user-status/${userId}`, {
    status,
    adminNotes
  });
  return data;
};



// Legacy APIs (preserve existing functionality)
// const fetchUsers = async () => {
//   const { data } = await api.get('/admin/users');
//   return data;
// };



// const fetchUsers = async () => {
//   try {
//     const { data } = await api.get('/admin/users');
//     // Handle different response formats
//     if (data?.success && Array.isArray(data.users)) {
//       return data.users;
//     }
//     if (Array.isArray(data)) {
//       return data;
//     }
//     return [];
//   } catch (error) {
//     console.error('Error fetching users:', error);
//     return [];
//   }
// };


const fetchUsers = async () => {
  try {
    const { data } = await api.get('/admin/users');
    console.log('👤 Users API Response:', data);
    
    // Handle different response formats safely
    if (data?.success && Array.isArray(data.users)) {
      return data.users;
    }
    if (data?.users && Array.isArray(data.users)) {
      return data.users;
    }
    if (Array.isArray(data)) {
      return data;
    }
    
    console.warn('⚠️ Unexpected users API response format:', data);
    return [];
  } catch (error) {
    console.error('❌ Error fetching users:', error);
    // Return empty array instead of throwing to prevent crash
    return [];
  }
};

// const fetchClasses = async () => {
//   const { data } = await api.get('/classes');
//   return data;
// };

const fetchClasses = async () => {
  try {
    const { data } = await api.get('/classes');
    return Array.isArray(data?.classes) ? data.classes : [];
  } catch (error) {
    console.error('❌ Error fetching classes:', error);
    return [];
  }
};


// const fetchMentors = async () => {
//   const { data } = await api.get('/admin/mentors');
//   return data;
// };

const fetchMentors = async () => {
  try {
    const { data } = await api.get('/admin/mentors');
    return Array.isArray(data?.mentors) ? data.mentors : [];
  } catch (error) {
    console.error('❌ Error fetching mentors:', error);
    return [];
  }
};


// const fetchReports = async () => {
//   const { data } = await api.get('/admin/reports');
//   return data;
// };

const fetchReports = async () => {
  try {
    const { data } = await api.get('/admin/reports');
    console.log('📊 Reports API Response:', data);
    
    // Handle different response formats safely
    if (data?.success && Array.isArray(data.reports)) {
      return data.reports;
    }
    if (data?.reports && Array.isArray(data.reports)) {
      return data.reports;
    }
    if (Array.isArray(data)) {
      return data;
    }
    
    console.warn('⚠️ Unexpected reports API response format:', data);
    return [];
  } catch (error) {
    console.error('❌ Error fetching reports:', error);
    // Return empty array instead of throwing to prevent crash
    return [];
  }
};

const updateUser = async ({ id, formData }) => {
  const { data } = await api.put(`/admin/update-user/${id}`, formData);
  return data;
};

const maskUserIdentity = async ({ userId, adminConverseId, mentorConverseId, classId }) => {
  const { data } = await api.post('/admin/mask-identity', {
    userId,
    adminConverseId,
    mentorConverseId,
    classId
  });
  return data;
};

const deleteUser = async (userId) => {
  const { data } = await api.delete(`/admin/delete-user/${userId}`);
  return data;
};

const createUser = async (userData) => {
  const { data } = await api.post('/admin/create-user', userData);
  return data;
};

const sendNotification = async ({ userId, message, type }) => {
  const { data } = await api.post('/admin/send-notification', {
    userId,
    message,
    type
  });
  return data;
};

const updateReportStatus = async ({ reportId, status, adminNotes }) => {
  const { data } = await api.put(`/admin/update-report/${reportId}`, {
    status,
    adminNotes
  });
  return data;
};

const exportUserData = async (filters = {}) => {
  const params = new URLSearchParams(filters);
  const { data } = await api.get(`/admin/export-users?${params}`);
  return data;
};



// ==================================================
// MAIN COMPONENT WITH ENHANCED ERROR BOUNDARIES
// ==================================================

const UserManagement = () => {
  const queryClient = useQueryClient();
  
  // Tab management
  const [activeTab, setActiveTab] = useState('membership_overview');
  
  // State management
  const [selectedUsers, setSelectedUsers] = useState([]);
  const [bulkAction, setBulkAction] = useState('');
  const [adminNotes, setAdminNotes] = useState('');
  const [filters, setFilters] = useState({
    page: 1,
    limit: 20,
    search: '',
    sortBy: 'submittedAt',
    sortOrder: 'ASC'
  });

  // Legacy state
  const [selectedUser, setSelectedUser] = useState(null);
  const [selectedReport, setSelectedReport] = useState(null);
  const [showCreateForm, setShowCreateForm] = useState(false);
  const [formData, setFormData] = useState({
    converse_id: '',
    mentor_id: '',
    class_id: '',
    is_member: '',
    role: '',
    username: '',
    email: '',
    password: '',
    isblocked: false,
    isbanned: false
  });

  // ===== REACT QUERY HOOKS WITH SAFE DEFAULTS =====

  // ✅ FIXED: Safe users query with proper error handling
  const { 
    data: rawUsers, 
    isLoading: usersLoading, 
    isError: usersError, 
    error: usersErrorData 
  } = useQuery({
    queryKey: ['users'],
    queryFn: fetchUsers,
    staleTime: 3 * 60 * 1000,
    cacheTime: 10 * 60 * 1000,
    retry: (failureCount, error) => {
      if (failureCount < 2) return true;
      return false;
    },
    onError: (error) => {
      console.error('❌ Users query error:', error);
    }
  });

  // ✅ CRITICAL FIX: Safe users array with memoization
  const users = useMemo(() => {
    if (!rawUsers) return [];
    if (Array.isArray(rawUsers)) return rawUsers;
    if (rawUsers.users && Array.isArray(rawUsers.users)) return rawUsers.users;
    return [];
  }, [rawUsers]);

  // ✅ FIXED: Safe reports query
  const { 
    data: rawReports, 
    isLoading: reportsLoading, 
    error: reportsError 
  } = useQuery({
    queryKey: ['reports'],
    queryFn: fetchReports,
    staleTime: 2 * 60 * 1000,
    cacheTime: 5 * 60 * 1000,
    retry: 1,
    onError: (error) => {
      console.error('❌ Reports query error:', error);
    }
  });

  // ✅ CRITICAL FIX: Safe reports array with memoization  
  const reports = useMemo(() => {
    if (!rawReports) return [];
    if (Array.isArray(rawReports)) return rawReports;
    if (rawReports.reports && Array.isArray(rawReports.reports)) return rawReports.reports;
    return [];
  }, [rawReports]);

  // Other queries with safe defaults
  const { data: membershipOverview, isLoading: overviewLoading, error: overviewError } = useQuery({
    queryKey: ['membershipOverview'],
    queryFn: fetchMembershipOverview,
    staleTime: 5 * 60 * 1000,
    retry: 1
  });

  const { data: pendingApplications, isLoading: applicationsLoading, error: applicationsError } = useQuery({
    queryKey: ['pendingApplications', activeTab, filters],
    queryFn: () => fetchPendingApplications({
      ...filters,
      stage: activeTab === 'membership_pending' ? 'initial' : 'full_membership'
    }),
    enabled: activeTab === 'membership_pending' || activeTab === 'membership_full',
    staleTime: 2 * 60 * 1000,
    retry: 1
  });

  const { data: classes, isLoading: classesLoading, error: classesError } = useQuery({
    queryKey: ['classes'],
    queryFn: fetchClasses,
    staleTime: 10 * 60 * 1000,
    retry: 1
  });

  const { data: mentors, isLoading: mentorsLoading, error: mentorsError } = useQuery({
    queryKey: ['mentors'],
    queryFn: fetchMentors,
    staleTime: 5 * 60 * 1000,
    retry: 1
  });

  // ===== SAFE FILTERED USERS WITH MEMOIZATION =====

  // ✅ CRITICAL FIX: Safe filtered users computation
  const filteredUsers = useMemo(() => {
    try {
      const userArray = Array.isArray(users) ? users : [];
      
      switch (activeTab) {
        case 'legacy_pending':
          return userArray.filter(user => user?.is_member === 'applied');
        case 'legacy_granted':
          return userArray.filter(user => user?.is_member === 'granted');
        case 'legacy_declined':
          return userArray.filter(user => user?.is_member === 'declined');
        default:
          return userArray;
      }
    } catch (error) {
      console.error('❌ Error filtering users:', error);
      return [];
    }
  }, [users, activeTab]);

  // ===== HELPER FUNCTIONS =====

  const resetFormData = () => {
    setFormData({
      converse_id: '',
      mentor_id: '',
      class_id: '',
      is_member: '',
      role: '',
      username: '',
      email: '',
      password: '',
      isblocked: false,
      isbanned: false
    });
  };

  const formatUserDisplayName = (user) => {
    if (!user) return 'Unknown User';
    if (user.is_identity_masked && user.converse_id) {
      return user.converse_id;
    }
    return user.username || user.email || 'Unknown User';
  };

  const getStatusBadgeClass = (status) => {
    switch (status?.toLowerCase()) {
      case 'approved':
      case 'granted':
        return 'status-success';
      case 'rejected':
      case 'declined':
        return 'status-danger';
      case 'pending':
      case 'applied':
        return 'status-warning';
      default:
        return 'status-default';
    }
  };

  // ===== EVENT HANDLERS =====

  const handleRefreshData = () => {
    queryClient.invalidateQueries();
    alert('Data refreshed successfully!');
  };

  const handleTabChange = (newTab) => {
    try {
      setActiveTab(newTab);
      setSelectedUsers([]);
      setSelectedUser(null);
      setSelectedReport(null);
    } catch (error) {
      console.error('❌ Error changing tab:', error);
    }
  };

  // ===== ERROR BOUNDARY COMPONENT =====
  
  if (usersError && reportsError) {
    return (
      <div className="user-management-container">
        <div className="error-state major">
          <div className="error-icon">⚠️</div>
          <h3>System Error</h3>
          <p>Unable to load essential data. Please try refreshing the page.</p>
          <div className="error-details">
            <details>
              <summary>Error Details</summary>
              <pre>
                Users Error: {usersErrorData?.message || 'Unknown error'}
                Reports Error: {reportsError?.message || 'Unknown error'}
              </pre>
            </details>
          </div>
          <div className="error-actions">
            <button onClick={handleRefreshData} className="btn-retry">
              🔄 Retry
            </button>
            <button onClick={() => window.location.reload()} className="btn-reload">
              🔃 Reload Page
            </button>
          </div>
        </div>
      </div>
    );
  }

  // ===== MAIN RENDER =====

  return (
    <div className="user-management-container">
      <div className="header-section">
        <h2>User Management System</h2>
        <div className="header-actions">
          <button onClick={handleRefreshData} className="btn-refresh">
            🔄 Refresh All
          </button>
        </div>
      </div>

      {/* Enhanced Tab Navigation */}
      <div className="tab-navigation">
        <button 
          className={`tab-btn ${activeTab === 'membership_overview' ? 'active' : ''}`} 
          onClick={() => handleTabChange('membership_overview')}
        >
          <span>Overview</span>
        </button>
        <button 
          className={`tab-btn ${activeTab === 'membership_pending' ? 'active' : ''}`} 
          onClick={() => handleTabChange('membership_pending')}
        >
          <span>Pending Applications</span>
          <span className="tab-count">({pendingApplications?.pagination?.total || 0})</span>
        </button>
        <button 
          className={`tab-btn ${activeTab === 'all_users' ? 'active' : ''}`} 
          onClick={() => handleTabChange('all_users')}
        >
          <span>All Users</span>
          <span className="tab-count">({users?.length || 0})</span>
        </button>
        <button 
          className={`tab-btn ${activeTab === 'reports' ? 'active' : ''}`} 
          onClick={() => handleTabChange('reports')}
        >
          <span>Reports</span>
          <span className="tab-count">({reports?.length || 0})</span>
        </button>
      </div>

      {/* ===== OVERVIEW TAB ===== */}
      {activeTab === 'membership_overview' && (
        <div className="overview-section">
          <h3>System Overview</h3>
          {overviewLoading ? (
            <div className="loading-state">
              <div className="loading-spinner"></div>
              <p>Loading overview...</p>
            </div>
          ) : overviewError ? (
            <div className="error-state">
              <p>Error loading overview: {overviewError.message}</p>
            </div>
          ) : (
            <div className="stats-grid">
              <div className="stat-card">
                <div className="stat-icon">👥</div>
                <div className="stat-content">
                  <h4>Total Users</h4>
                  <span className="stat-number">{users?.length || 0}</span>
                </div>
              </div>
              <div className="stat-card">
                <div className="stat-icon">✅</div>
                <div className="stat-content">
                  <h4>Active Members</h4>
                  <span className="stat-number">
                    {users?.filter(u => u?.is_member === 'granted').length || 0}
                  </span>
                </div>
              </div>
              <div className="stat-card">
                <div className="stat-icon">⏳</div>
                <div className="stat-content">
                  <h4>Pending Applications</h4>
                  <span className="stat-number">
                    {users?.filter(u => u?.is_member === 'applied').length || 0}
                  </span>
                </div>
              </div>
              <div className="stat-card">
                <div className="stat-icon">📊</div>
                <div className="stat-content">
                  <h4>Reports</h4>
                  <span className="stat-number">{reports?.length || 0}</span>
                </div>
              </div>
            </div>
          )}
        </div>
      )}

      {/* ===== ALL USERS TAB ===== */}
      {activeTab === 'all_users' && (
        <div className="all-users-section">
          <div className="section-header">
            <h3>All Users ({users?.length || 0})</h3>
          </div>
          
          {usersLoading ? (
            <div className="loading-state">
              <div className="loading-spinner"></div>
              <p>Loading users...</p>
            </div>
          ) : usersError ? (
            <div className="error-state">
              <div className="error-icon">⚠️</div>
              <p>Error loading users: {usersErrorData?.message || 'Unknown error'}</p>
              <button 
                onClick={() => queryClient.invalidateQueries(['users'])}
                className="retry-btn"
              >
                Retry Loading
              </button>
            </div>
          ) : !users?.length ? (
            <div className="empty-state">
              <div className="empty-icon">👥</div>
              <h4>No Users Found</h4>
              <p>No users are registered in the system yet.</p>
            </div>
          ) : (
            <div className="users-table-container">
              <table className="users-table">
                <thead>
                  <tr>
                    <th>User</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Joined</th>
                  </tr>
                </thead>
                <tbody>
                  {users.map((user) => (
                    <tr key={user.id} className="user-row">
                      <td className="user-cell">
                        <div className="user-info">
                          <div className="user-avatar small">
                            {(user.username || 'U').charAt(0).toUpperCase()}
                          </div>
                          <div className="user-details">
                            <span className="username">{formatUserDisplayName(user)}</span>
                            <span className="user-id">ID: {user.id}</span>
                          </div>
                        </div>
                      </td>
                      <td className="email-cell">{user.email}</td>
                      <td className="role-cell">
                        <span className={`role-badge role-${user.role}`}>{user.role}</span>
                      </td>
                      <td className="status-cell">
                        <span className={`status-badge ${getStatusBadgeClass(user.is_member)}`}>
                          {user.is_member}
                        </span>
                        {user.isblocked && <span className="status-badge blocked">Blocked</span>}
                        {user.isbanned && <span className="status-badge banned">Banned</span>}
                      </td>
                      <td className="joined-cell">
                        {user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A'}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      )}

      {/* ===== REPORTS TAB ===== */}
      {activeTab === 'reports' && (
        <div className="reports-section">
          <div className="section-header">
            <h3>User Reports ({reports?.length || 0})</h3>
          </div>
          
          {reportsLoading ? (
            <div className="loading-state">
              <div className="loading-spinner"></div>
              <p>Loading reports...</p>
            </div>
          ) : reportsError ? (
            <div className="error-state">
              <div className="error-icon">⚠️</div>
              <p>Error loading reports: {reportsError.message}</p>
              <button 
                onClick={() => queryClient.invalidateQueries(['reports'])}
                className="retry-btn"
              >
                Retry Loading
              </button>
            </div>
          ) : !reports?.length ? (
            <div className="empty-state">
              <div className="empty-icon">📋</div>
              <h4>No Reports Found</h4>
              <p>No user reports have been submitted yet.</p>
            </div>
          ) : (
            <div className="reports-list">
              {reports.map(report => (
                <div key={report.id} className="report-card">
                  <div className="report-header">
                    <span className="report-id">Report #{report.id}</span>
                    <span className={`status-badge ${getStatusBadgeClass(report.status)}`}>
                      {report.status}
                    </span>
                    <span className="report-date">
                      {new Date(report.createdAt).toLocaleDateString()}
                    </span>
                  </div>
                  <div className="report-content">
                    <p><strong>Reporter:</strong> {report.reporter_id}</p>
                    <p><strong>Reported User:</strong> {report.reported_id}</p>
                    <p><strong>Reason:</strong> {report.reason}</p>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {/* ===== PENDING APPLICATIONS TAB ===== */}
      {activeTab === 'membership_pending' && (
        <div className="pending-applications-section">
          <div className="section-header">
            <h3>Pending Applications ({pendingApplications?.pagination?.total || 0})</h3>
          </div>
          
          {applicationsLoading ? (
            <div className="loading-state">
              <div className="loading-spinner"></div>
              <p>Loading applications...</p>
            </div>
          ) : applicationsError ? (
            <div className="error-state">
              <div className="error-icon">⚠️</div>
              <p>Error loading applications: {applicationsError.message}</p>
              <button 
                onClick={() => queryClient.invalidateQueries(['pendingApplications'])}
                className="retry-btn"
              >
                Retry Loading
              </button>
            </div>
          ) : !pendingApplications?.applications?.length ? (
            <div className="empty-state">
              <div className="empty-icon">📋</div>
              <h4>No Applications Found</h4>
              <p>No pending applications at this time.</p>
            </div>
          ) : (
            <div className="applications-list">
              {pendingApplications.applications.map((application) => (
                <div key={application.application_id} className="application-card">
                  <div className="application-header">
                    <div className="user-info">
                      <h4 className="username">{application.username}</h4>
                      <p className="email">{application.email}</p>
                      <span className="user-id">ID: {application.user_id}</span>
                    </div>
                    
                    <div className="application-meta">
                      <div className="timing-info">
                        <span className="days-pending">
                          {application.days_pending} day{application.days_pending !== 1 ? 's' : ''} pending
                        </span>
                        <span className="submitted-date">
                          Submitted: {new Date(application.submittedAt).toLocaleDateString()}
                        </span>
                      </div>
                      <span className={`status-badge ${getStatusBadgeClass(application.status)}`}>
                        {application.status}
                      </span>
                    </div>
                  </div>
                  
                  <div className="application-details">
                    <div className="detail-grid">
                      <div className="detail-item">
                        <strong>Stage:</strong> 
                        <span>{application.membership_stage || 'Initial Application'}</span>
                      </div>
                      {application.application_ticket && (
                        <div className="detail-item">
                          <strong>Ticket:</strong> 
                          <span className="ticket-number">{application.application_ticket}</span>
                        </div>
                      )}
                      {application.admin_notes && (
                        <div className="detail-item">
                          <strong>Admin Notes:</strong> 
                          <span className="admin-note">{application.admin_notes}</span>
                        </div>
                      )}
                    </div>
                  </div>

                  <div className="application-answers">
                    <details className="answers-details">
                      <summary className="answers-summary">
                        View Application Answers
                        <span className="expand-icon">▼</span>
                      </summary>
                      <div className="answers-content">
                        {typeof application.answers === 'string' ? (
                          <pre className="answers-text">{application.answers}</pre>
                        ) : (
                          <pre className="answers-json">
                            {JSON.stringify(application.answers, null, 2)}
                          </pre>
                        )}
                      </div>
                    </details>
                  </div>

                  <div className="application-actions">
                    <button 
                      onClick={() => console.log('Approve', application.user_id)}
                      className="btn-approve"
                      title="Approve this application"
                    >
                      <span className="btn-icon">✅</span>
                      Approve
                    </button>
                    <button 
                      onClick={() => console.log('Reject', application.user_id)}
                      className="btn-reject"
                      title="Reject this application"
                    >
                      <span className="btn-icon">❌</span>
                      Reject
                    </button>
                    <button 
                      onClick={() => console.log('View', application.user_id)}
                      className="btn-view"
                      title="View detailed information"
                    >
                      <span className="btn-icon">👁️</span>
                      View
                    </button>
                  </div>
                </div>
              ))}
            </div>
          )}

          {/* Pagination for applications */}
          {pendingApplications?.pagination && pendingApplications.pagination.totalPages > 1 && (
            <div className="pagination">
              <div className="pagination-controls">
                <button 
                  onClick={() => setFilters(prev => ({ ...prev, page: 1 }))}
                  disabled={filters.page <= 1}
                  className="pagination-btn first"
                  title="First page"
                >
                  ⏮️
                </button>
                <button 
                  onClick={() => setFilters(prev => ({ ...prev, page: prev.page - 1 }))}
                  disabled={filters.page <= 1}
                  className="pagination-btn prev"
                  title="Previous page"
                >
                  ◀️
                </button>
                
                <div className="pagination-info">
                  <span className="current-page">
                    Page {pendingApplications.pagination.page} of {pendingApplications.pagination.totalPages}
                  </span>
                  <span className="total-items">
                    ({pendingApplications.pagination.total} total items)
                  </span>
                </div>
                
                <button 
                  onClick={() => setFilters(prev => ({ ...prev, page: prev.page + 1 }))}
                  disabled={filters.page >= pendingApplications.pagination.totalPages}
                  className="pagination-btn next"
                  title="Next page"
                >
                  ▶️
                </button>
                <button 
                  onClick={() => setFilters(prev => ({ ...prev, page: pendingApplications.pagination.totalPages }))}
                  disabled={filters.page >= pendingApplications.pagination.totalPages}
                  className="pagination-btn last"
                  title="Last page"
                >
                  ⏭️
                </button>
              </div>
            </div>
          )}
        </div>
      )}

      {/* ===== GLOBAL LOADING STATES ===== */}
      {(usersLoading || reportsLoading || overviewLoading) && (
        <div className="global-loading-overlay">
          <div className="loading-container">
            <div className="loading-spinner large"></div>
            <p>Loading system data...</p>
            <small>This may take a few moments</small>
          </div>
        </div>
      )}

      {/* ===== GLOBAL ERROR STATES ===== */}
      {(usersError || reportsError || overviewError) && (
        <div className="global-error-banner">
          <div className="error-content">
            <span className="error-icon">⚠️</span>
            <div className="error-details">
              <strong>System Error Detected</strong>
              <p>Some components may not function properly. Please try refreshing the page.</p>
            </div>
            <div className="error-actions">
              <button 
                onClick={handleRefreshData}
                className="btn-retry"
              >
                Refresh Data
              </button>
              <button 
                onClick={() => window.location.reload()}
                className="btn-reload"
              >
                Reload Page
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Footer Information */}
      <div className="footer-info">
        <div className="system-stats">
          <span>Total Users: {users?.length || 0}</span>
          <span>•</span>
          <span>Active Members: {users?.filter(u => u?.is_member === 'granted').length || 0}</span>
          <span>•</span>
          <span>Pending Reports: {reports?.filter(r => r?.status === 'pending').length || 0}</span>
          <span>•</span>
          <span>Last Updated: {new Date().toLocaleTimeString()}</span>
        </div>
        <div className="version-info">
          <small>User Management System v3.0 - Enhanced Error Handling</small>
        </div>
      </div>
    </div>
  );
};

export default UserManagement;


//============================================

// ikootaclient/src/components/admin/Sidebar.jsx
import React from 'react';
import { Link, useLocation } from 'react-router-dom';
import { useQuery } from '@tanstack/react-query';
import api from '../service/api';
import './sidbar.css';

const Sidebar = ({ selectedItem, setSelectedItem, isMobile, closeMobileMenu }) => {
  const location = useLocation();

  // ✅ ADD: Fetch pending full membership applications count
  const { data: pendingFullMembershipCount } = useQuery({
    queryKey: ['pendingFullMembershipCount'],
    queryFn: async () => {
      try {
        const { data } = await api.get('/admin/membership/pending-count', { withCredentials: true });
        return data?.count || 0;
      } catch (error) {
        console.error('Failed to fetch pending full membership count:', error);
        return 0;
      }
    },
    refetchInterval: 30000, // Refresh every 30 seconds
    retry: 1
  });

  // ✅ UPDATED: Add Full Membership Review to sidebar items
  const sidebarItems = [
    { name: 'Dashboard', to: '', label: 'Dashboard', icon: '📊' },
    { name: 'Towncrier', to: 'towncrier', label: 'Towncrier', icon: '📢' },
    { name: 'Towncrier Controls', to: 'towncriercontrols', label: 'Towncrier Controls', icon: '🎛️' },
    { name: 'Iko', to: 'iko', label: 'Iko', icon: '🤖' },
    { name: 'Iko Controls', to: 'ikocontrols', label: 'Iko Controls', icon: '⚙️' },
    { name: 'AuthControls', to: 'authcontrols', label: 'AuthControls', icon: '🔐' },
    { name: 'SearchControls', to: 'searchcontrols', label: 'SearchControls', icon: '🔍' },
    { name: 'Reports', to: 'reports', label: 'Reports', icon: '📈' },
    { name: 'UserManagement', to: 'usermanagement', label: 'UserManagement', icon: '👥' },
    { name: 'AudienceClassMgr', to: 'audienceclassmgr', label: 'AudienceClassMgr', icon: '🎯' },
    // ✅ ADD: Full Membership Review item
    { 
      name: 'Full Membership Review', 
      to: 'full-membership-review', 
      label: 'Full Membership Review', 
      icon: '🎓',
      badge: pendingFullMembershipCount // Add badge count
    }
  ];

  const handleItemClick = (itemName) => {
    setSelectedItem(itemName);
    
    // Close mobile menu when item is clicked on mobile
    if (isMobile && closeMobileMenu) {
      setTimeout(() => {
        closeMobileMenu();
      }, 150); // Small delay for better UX
    }
  };

  return (
    <div className="admin_sidebar">
      {sidebarItems.map((item) => (
        <Link
          key={item.name}
          to={item.to}
          className={`admin_sidebar_item ${selectedItem === item.name ? 'active' : ''}`}
          onClick={() => handleItemClick(item.name)}
          data-discover="true"
        >
          {/* Icon */}
          <span className="sidebar-icon" style={{ marginRight: '8px' }}>
            {item.icon}
          </span>
          
          {/* Label */}
          <span className="sidebar-label">
            {item.label}
          </span>
          
          {/* ✅ ADD: Badge for pending count */}
          {item.badge && item.badge > 0 && (
            <span className="sidebar-badge">
              {item.badge}
            </span>
          )}
        </Link>
      ))}
    </div>
  );
};

export default Sidebar;

//======================================

//ikootaclient\src\components\admin\Reports.jsx
import React from 'react'

const Reports = () => {
  return (
    <div>Reports</div>
  )
}

export default Reports

//========================================

//ikootaclient\src\components\admin\PendingReports.jsx
import React from 'react'

const PendingReports = () => {
  return (
    <div>PendingReports</div>
  )
}

export default PendingReports

//==================================

// ikootaclient/src/components/admin/Navbar.jsx
// ==================================================

import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import './navbar.css';

const Navbar = () => {
  const [currentUser, setCurrentUser] = useState(null);
  const [currentTime, setCurrentTime] = useState(new Date());
  const [notificationCount, setNotificationCount] = useState(3); // Example notification count
  const [showNotifications, setShowNotifications] = useState(false);
  const [notifications, setNotifications] = useState([
    { id: 1, message: "New user registration pending approval", time: "5 min ago", type: "info" },
    { id: 2, message: "System backup completed successfully", time: "1 hour ago", type: "success" },
    { id: 3, message: "Server maintenance scheduled for tonight", time: "2 hours ago", type: "warning" }
  ]);
  
  const navigate = useNavigate();

  // Update time every minute
  useEffect(() => {
    const timer = setInterval(() => {
      setCurrentTime(new Date());
    }, 60000);

    return () => clearInterval(timer);
  }, []);

  // Get current user info (replace with your auth logic)
  useEffect(() => {
    // Replace this with your actual user fetching logic
    const user = {
      name: 'Admin User',
      role: 'Administrator',
      email: 'admin@ikoota.com'
    };
    setCurrentUser(user);
  }, []);

  // Close notifications when clicking outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (showNotifications && !event.target.closest('.notifications-dropdown') && !event.target.closest('.notifications-btn')) {
        setShowNotifications(false);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [showNotifications]);

  const formatTime = (date) => {
    return date.toLocaleTimeString('en-US', { 
      hour: '2-digit', 
      minute: '2-digit',
      hour12: true 
    });
  };

  const formatDate = (date) => {
    return date.toLocaleDateString('en-US', { 
      weekday: 'short',
      month: 'short', 
      day: 'numeric',
      year: 'numeric'
    });
  };

  // ✅ Enhanced action button handlers
  const handleNotifications = () => {
    console.log('Notifications clicked');
    setShowNotifications(!showNotifications);
    
    // Reset notification count when opened
    if (!showNotifications) {
      setNotificationCount(0);
    }
  };

  const handleSettings = () => {
    console.log('Settings clicked');
    // Navigate to settings page
    navigate('/admin/settings');
    // Or you could show a settings modal instead
  };

  const handleLogout = () => {
    console.log('Logout clicked');
    const confirmLogout = window.confirm('Are you sure you want to logout?');
    
    if (confirmLogout) {
      // Clear user session/tokens
      localStorage.removeItem('authToken');
      localStorage.removeItem('userRole');
      localStorage.removeItem('userData');
      sessionStorage.clear();
      
      // Optional: Call logout API
      // api.post('/auth/logout').then(() => {
      //   navigate('/login');
      // }).catch(() => {
      //   navigate('/login'); // Still navigate even if API fails
      // });
      
      // Redirect to login page
      navigate('/login');
      
      // Show success message
      alert('Successfully logged out!');
    }
  };

  const markNotificationAsRead = (notificationId) => {
    setNotifications(prev => 
      prev.filter(notification => notification.id !== notificationId)
    );
  };

  const clearAllNotifications = () => {
    setNotifications([]);
    setNotificationCount(0);
    setShowNotifications(false);
  };

  return (
    <nav className="admin-navbar-content">
      {/* Left side - Page title area */}
      <div className="navbar-left">
        <h1 className="navbar-title">Admin Dashboard</h1>
      </div>

      {/* Center - Status indicators (hidden on mobile) */}
      <div className="navbar-center">
        <div className="status-indicators">
          <span className="status-indicator online">
            <span className="status-dot"></span>
            System Online
          </span>
        </div>
      </div>

      {/* Right side - User info and actions */}
      <div className="navbar-right">
        {/* Time display (hidden on small mobile) */}
        <div className="time-display">
          <span className="current-time">{formatTime(currentTime)}</span>
          <span className="current-date">{formatDate(currentTime)}</span>
        </div>

        {/* User info */}
        {currentUser && (
          <div className="user-info">
            <span className="user-name">{currentUser.name}</span>
            <span className="user-role">{currentUser.role}</span>
          </div>
        )}

        {/* ✅ Enhanced Actions with full functionality */}
        <div className="navbar-actions">
          {/* Notifications Button with Dropdown */}
          <div className="notifications-container">
            <button 
              className="action-btn notifications-btn" 
              onClick={handleNotifications}
              aria-label="Notifications"
              title="Notifications"
            >
              🔔
              {notificationCount > 0 && (
                <span className="notification-badge">{notificationCount}</span>
              )}
            </button>

            {/* Notifications Dropdown */}
            {showNotifications && (
              <div className="notifications-dropdown">
                <div className="notifications-header">
                  <h4>Notifications</h4>
                  {notifications.length > 0 && (
                    <button 
                      className="clear-all-btn"
                      onClick={clearAllNotifications}
                    >
                      Clear All
                    </button>
                  )}
                </div>
                
                <div className="notifications-list">
                  {notifications.length > 0 ? (
                    notifications.map(notification => (
                      <div key={notification.id} className={`notification-item ${notification.type}`}>
                        <div className="notification-content">
                          <p className="notification-message">{notification.message}</p>
                          <span className="notification-time">{notification.time}</span>
                        </div>
                        <button 
                          className="dismiss-btn"
                          onClick={() => markNotificationAsRead(notification.id)}
                          aria-label="Dismiss notification"
                        >
                          ×
                        </button>
                      </div>
                    ))
                  ) : (
                    <div className="no-notifications">
                      <p>No new notifications</p>
                    </div>
                  )}
                </div>
                
                {notifications.length > 3 && (
                  <div className="notifications-footer">
                    <button 
                      className="view-all-btn"
                      onClick={() => navigate('/admin/notifications')}
                    >
                      View All Notifications
                    </button>
                  </div>
                )}
              </div>
            )}
          </div>
          
          {/* Settings Button */}
          <button 
            className="action-btn settings-btn" 
            onClick={handleSettings}
            aria-label="Settings"
            title="Settings"
          >
            ⚙️
          </button>
          
          {/* Logout Button */}
          <button 
            className="action-btn logout-btn" 
            onClick={handleLogout}
            aria-label="Logout"
            title="Logout"
          >
            🚪
          </button>
        </div>
      </div>
    </nav>
  );
};

export default Navbar;


//===============================================

//ikootaclient\src\components\admin\KeyStats.jsx
import React from 'react';

const KeyStats = () => {
  return (
    <div className="key_stats">
      <h3>Key Statistics</h3>
      <p>Total Users: 500</p>
      <p>Active Chats: 50</p>
      <p>Pending Reports: 10</p>
    </div>
  );
};

export default KeyStats;

//======================================

// ikootaclient/src/components/admin/FullMembershipReviewControls.jsx
// FIXED VERSION: Corrected API endpoints and error handling

import React, { useState, useEffect } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useLocation } from 'react-router-dom';
import './FullMembershipReviewControls.css';

// ✅ Use your existing API service
let api;
try {
  api = require('../service/api').default;
} catch (error) {
  console.log('Custom API service not found, using fetch');
  api = null;
}

const FullMembershipReviewControls = () => {
  const [selectedApplications, setSelectedApplications] = useState([]);
  const [selectedApplication, setSelectedApplication] = useState(null);
  const [filterStatus, setFilterStatus] = useState('pending');
  const [searchTerm, setSearchTerm] = useState('');
  const queryClient = useQueryClient();
  const location = useLocation();

  // Detect if we're in admin context
  const isInAdminContext = location.pathname.includes('/admin');

  // Add context class to body for CSS targeting
  useEffect(() => {
    const bodyClass = 'full-membership-review-in-admin';
    
    if (isInAdminContext) {
      document.body.classList.add(bodyClass);
    } else {
      document.body.classList.remove(bodyClass);
    }

    return () => {
      document.body.classList.remove(bodyClass);
    };
  }, [isInAdminContext]);

  // ✅ FIXED: Enhanced API call function with proper endpoint detection
  const makeApiCall = async (endpoint, options = {}) => {
    try {
      console.log('🔍 API: Making request to endpoint:', endpoint);
      
      if (api) {
        // Use custom API service if available
        const method = options.method?.toLowerCase() || 'get';
        if (method === 'get') {
          return await api.get(endpoint);
        } else if (method === 'put') {
          return await api.put(endpoint, options.body);
        } else if (method === 'post') {
          return await api.post(endpoint, options.body);
        }
      } else {
        // ✅ FIXED: Build correct URL based on server setup
        let fullUrl;
        
        // Check if endpoint already starts with /api
        if (endpoint.startsWith('/api/')) {
          fullUrl = endpoint; // Use as-is
        } else if (endpoint.startsWith('/admin/')) {
          // Admin endpoints need /api prefix
          fullUrl = `/api${endpoint}`;
        } else if (endpoint.startsWith('/')) {
          // Other endpoints need /api prefix
          fullUrl = `/api${endpoint}`;
        } else {
          // No leading slash, add /api/
          fullUrl = `/api/${endpoint}`;
        }

        console.log('🔍 FETCH: Final URL:', fullUrl);
        
        const response = await fetch(fullUrl, {
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json',
            ...options.headers
          },
          ...options
        });
        
        console.log('📡 FETCH: Response status:', response.status, response.statusText);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const text = await response.text();
        console.log('📄 FETCH: Raw response preview:', text.substring(0, 100) + '...');
        
        // Check if response is JSON
        try {
          const jsonData = JSON.parse(text);
          return { data: jsonData };
        } catch (parseError) {
          console.error('❌ FETCH: Failed to parse JSON. Response was:', text.substring(0, 500));
          throw new Error(`Invalid JSON response from ${fullUrl}. Got: ${text.substring(0, 100)}...`);
        }
      }
    } catch (error) {
      console.error('❌ API Call failed for endpoint:', endpoint, error);
      throw error;
    }
  };

  // ✅ FIXED: Applications query with corrected endpoint
  const { 
    data: applicationsData, 
    isLoading: applicationsLoading, 
    error: applicationsError, 
    refetch: refetchApplications 
  } = useQuery({
    queryKey: ['admin', 'membership', 'applications', filterStatus],
    queryFn: async () => {
      try {
        console.log('🔍 QUERY: Fetching applications with status:', filterStatus);
        
        // ✅ Try multiple endpoint patterns to find the working one
        const endpoints = [
          `/admin/membership/applications?status=${filterStatus}`,
          `/api/admin/membership/applications?status=${filterStatus}`,
          `/admin/membership/full-membership-applications?status=${filterStatus}`
        ];

        let lastError;
        for (const endpoint of endpoints) {
          try {
            console.log('🔍 TRYING: Endpoint:', endpoint);
            const response = await makeApiCall(endpoint);
            console.log("✅ SUCCESS: Response from", endpoint, ":", response);
            
            // Handle different response structures
            if (response?.data?.success && response.data?.data) {
              return Array.isArray(response.data.data) ? response.data.data : [];
            } else if (Array.isArray(response?.data)) {
              return response.data;
            } else if (response?.data) {
              return [];
            }
          } catch (error) {
            console.log('❌ FAILED: Endpoint', endpoint, 'error:', error.message);
            lastError = error;
            continue;
          }
        }
        
        // If all endpoints failed, throw the last error
        throw lastError || new Error('All endpoint attempts failed');
        
      } catch (error) {
        console.error('❌ Applications query failed:', error);
        return []; // Return empty array instead of throwing
      }
    },
    retry: 1,
    retryDelay: 1000,
    initialData: [],
    keepPreviousData: true
  });

  // ✅ FIXED: Stats query with corrected endpoint
  const { 
    data: stats, 
    isLoading: statsLoading, 
    error: statsError 
  } = useQuery({
    queryKey: ['admin', 'membership', 'stats'],
    queryFn: async () => {
      try {
        console.log('🔍 QUERY: Fetching membership stats');
        
        // ✅ Try multiple endpoint patterns for stats
        const endpoints = [
          '/admin/membership/full-membership-stats',
          '/api/admin/membership/full-membership-stats',
          '/admin/membership/stats'
        ];

        let lastError;
        for (const endpoint of endpoints) {
          try {
            console.log('🔍 TRYING: Stats endpoint:', endpoint);
            const response = await makeApiCall(endpoint);
            console.log("✅ STATS SUCCESS: Response from", endpoint, ":", response);
            
            // Handle different response structures
            if (response?.data?.success && response.data?.data) {
              return response.data.data;
            } else if (response?.data) {
              // Try to extract stats from response
              const data = response.data;
              return {
                pending: data.pending || data.pendingCount || 0,
                approved: data.approved || data.approvedCount || 0,
                declined: data.declined || data.declinedCount || 0,
                total: data.total || data.totalApplications || 0
              };
            }
          } catch (error) {
            console.log('❌ FAILED: Stats endpoint', endpoint, 'error:', error.message);
            lastError = error;
            continue;
          }
        }
        
        // Return default stats if all endpoints failed
        console.warn('⚠️ All stats endpoints failed, using defaults');
        return { pending: 0, approved: 0, declined: 0, total: 0 };
        
      } catch (error) {
        console.error('❌ Stats query failed, using defaults:', error);
        return { pending: 0, approved: 0, declined: 0, total: 0 };
      }
    },
    retry: 1,
    retryDelay: 1000,
    initialData: { pending: 0, approved: 0, declined: 0, total: 0 }
  });

  // ✅ Ensure applications is always an array
  const applications = React.useMemo(() => {
    if (!applicationsData) {
      console.log('📋 No applications data, returning empty array');
      return [];
    }
    
    if (Array.isArray(applicationsData)) {
      console.log('📋 Applications is array with', applicationsData.length, 'items');
      return applicationsData;
    }
    
    console.warn('⚠️ Applications data is not array:', applicationsData);
    return [];
  }, [applicationsData]);

  // ✅ Review individual application mutation
  const reviewMutation = useMutation({
    mutationFn: async ({ applicationId, decision, notes }) => {
      console.log('🔍 REVIEW: Reviewing application:', { applicationId, decision, notes });
      
      const endpoints = [
        `/admin/membership/review/${applicationId}`,
        `/admin/membership/full-membership/review/${applicationId}`
      ];

      let lastError;
      for (const endpoint of endpoints) {
        try {
          const response = await makeApiCall(endpoint, {
            method: 'PUT',
            body: JSON.stringify({ 
              status: decision, 
              adminNotes: notes || ''
            })
          });
          return response.data;
        } catch (error) {
          lastError = error;
          continue;
        }
      }
      
      throw lastError || new Error('Review failed');
    },
    onSuccess: (data, variables) => {
      console.log('✅ Application review completed:', variables);
      queryClient.invalidateQueries(['admin', 'membership']);
      setSelectedApplications([]);
      alert(`Application ${variables.decision}d successfully!`);
    },
    onError: (error) => {
      console.error('❌ Error reviewing application:', error);
      const errorMessage = error.response?.data?.message || error.message || 'Unknown error';
      alert('Failed to review application: ' + errorMessage);
    }
  });

  // ✅ Bulk review mutation
  const bulkReviewMutation = useMutation({
    mutationFn: async ({ applicationIds, decision, notes }) => {
      console.log('🔍 BULK: Bulk reviewing applications:', { applicationIds, decision, notes });
      
      const endpoints = [
        '/admin/membership/bulk-review',
        '/admin/membership/full-membership/bulk-review'
      ];

      let lastError;
      for (const endpoint of endpoints) {
        try {
          const response = await makeApiCall(endpoint, {
            method: 'POST',
            body: JSON.stringify({ 
              applicationIds, 
              decision, 
              notes: notes || '' 
            })
          });
          return response.data;
        } catch (error) {
          lastError = error;
          continue;
        }
      }
      
      throw lastError || new Error('Bulk review failed');
    },
    onSuccess: (data, variables) => {
      console.log('✅ Bulk review completed:', variables);
      queryClient.invalidateQueries(['admin', 'membership']);
      setSelectedApplications([]);
      alert(`${variables.applicationIds.length} applications ${variables.decision}d successfully!`);
    },
    onError: (error) => {
      console.error('❌ Error in bulk review:', error);
      const errorMessage = error.response?.data?.message || error.message || 'Unknown error';
      alert('Failed to bulk review: ' + errorMessage);
    }
  });

  // Handle individual review
  const handleReview = (applicationId, decision, notes = '') => {
    if (!applicationId) {
      alert('Invalid application ID');
      return;
    }

    const confirmMessage = `Are you sure you want to ${decision} this application?`;
    if (window.confirm(confirmMessage)) {
      reviewMutation.mutate({ applicationId, decision, notes });
    }
  };

  // Handle bulk review
  const handleBulkReview = (decision, notes = '') => {
    if (selectedApplications.length === 0) {
      alert('Please select applications to review');
      return;
    }
    
    const confirmMessage = `Are you sure you want to ${decision} ${selectedApplications.length} application(s)?`;
    if (window.confirm(confirmMessage)) {
      bulkReviewMutation.mutate({ 
        applicationIds: selectedApplications, 
        decision, 
        notes 
      });
    }
  };

  // Toggle application selection
  const toggleSelection = (applicationId) => {
    setSelectedApplications(prev => 
      prev.includes(applicationId)
        ? prev.filter(id => id !== applicationId)
        : [...prev, applicationId]
    );
  };

  // Select all applications
  const selectAll = () => {
    if (filteredApplications && filteredApplications.length > 0) {
      const allIds = filteredApplications.map(app => app.id || app.user_id);
      setSelectedApplications(allIds);
    }
  };

  // Clear selection
  const clearSelection = () => {
    setSelectedApplications([]);
  };

  // ✅ Enhanced application answers rendering
  const renderApplicationAnswers = (answers) => {
    try {
      if (!answers) {
        return (
          <div className="no-answers">
            <em>No answers provided</em>
          </div>
        );
      }

      let parsedAnswers;

      // Handle string JSON data
      if (typeof answers === 'string') {
        try {
          parsedAnswers = JSON.parse(answers);
        } catch (parseError) {
          return (
            <div className="invalid-answers">
              <strong>Application Response:</strong>
              <pre style={{ whiteSpace: 'pre-wrap', fontSize: '0.9em' }}>
                {answers}
              </pre>
            </div>
          );
        }
      } else {
        parsedAnswers = answers;
      }

      // Handle array format (most common)
      if (Array.isArray(parsedAnswers)) {
        return (
          <div className="full-membership-answers">
            {parsedAnswers.map((answer, index) => (
              <div key={index} className="answer-item">
                <div className="question-label">
                  <strong>Question {index + 1}:</strong>
                </div>
                <div className="answer-value">
                  {answer || 'No response provided'}
                </div>
              </div>
            ))}
          </div>
        );
      }

      // Handle object format
      if (typeof parsedAnswers === 'object') {
        return (
          <div className="full-membership-answers-object">
            {Object.entries(parsedAnswers).map(([key, value], index) => (
              <div key={index} className="answer-item">
                <div className="question-label">
                  <strong>{formatQuestionLabel(key)}:</strong>
                </div>
                <div className="answer-value">
                  {formatAnswerValue(value)}
                </div>
              </div>
            ))}
          </div>
        );
      }

      // Fallback
      return (
        <div className="fallback-answers">
          <strong>Application Response:</strong>
          <pre style={{ whiteSpace: 'pre-wrap', fontSize: '0.9em' }}>
            {JSON.stringify(parsedAnswers, null, 2)}
          </pre>
        </div>
      );

    } catch (error) {
      console.error('❌ Error rendering answers:', error);
      return (
        <div className="error-answers">
          <em style={{ color: 'red' }}>Error displaying answers: {error.message}</em>
        </div>
      );
    }
  };

  // Helper function to format question labels
  const formatQuestionLabel = (questionKey) => {
    const labelMap = {
      whyFullMembership: 'Why do you want full membership?',
      contributionPlans: 'How will you contribute as a full member?',
      educationalGoals: 'What are your educational goals?',
      communityInvolvement: 'How do you plan to be involved in the community?',
      previousExperience: 'Previous relevant experience?',
      availability: 'What is your availability?',
      specialSkills: 'What special skills do you bring?',
      mentorshipInterest: 'Interest in mentoring others?',
      researchInterests: 'Research interests and areas of expertise?',
      collaborationStyle: 'Preferred collaboration style?'
    };

    return labelMap[questionKey] || 
           questionKey.charAt(0).toUpperCase() + questionKey.slice(1);
  };

  // Helper function to format answer values
  const formatAnswerValue = (answer) => {
    if (answer === true || answer === 'true') {
      return <span style={{ color: 'green' }}>✅ Yes</span>;
    }
    if (answer === false || answer === 'false') {
      return <span style={{ color: 'red' }}>❌ No</span>;
    }
    if (!answer || answer === '') {
      return <em style={{ color: '#888' }}>Not provided</em>;
    }
    return answer;
  };

  // ✅ Filter applications
  const filteredApplications = React.useMemo(() => {
    if (!Array.isArray(applications)) {
      return [];
    }
    
    return applications.filter(app => {
      if (!searchTerm) return true;
      
      const searchLower = searchTerm.toLowerCase();
      
      // Check various possible field names for compatibility
      const searchableFields = [
        app?.user_email,
        app?.user_name,
        app?.username,
        app?.email,
        app?.membership_ticket,
        app?.ticket
      ].filter(Boolean);
      
      // Check if any field contains the search term
      const fieldMatch = searchableFields.some(field => 
        field.toLowerCase().includes(searchLower)
      );
      
      // Check answers/responses
      const answersMatch = (
        (typeof app?.answers === 'string' && app.answers.toLowerCase().includes(searchLower)) ||
        (typeof app?.responses === 'object' && JSON.stringify(app.responses).toLowerCase().includes(searchLower)) ||
        (Array.isArray(app?.answers) && app.answers.some(answer => 
          typeof answer === 'string' && answer.toLowerCase().includes(searchLower)
        ))
      );
      
      return fieldMatch || answersMatch;
    });
  }, [applications, searchTerm]);

  if (applicationsLoading) {
    return (
      <div className="loading-container">
        <div className="loading-spinner"></div>
        <p>Loading membership applications...</p>
      </div>
    );
  }

  return (
    <div className="membership-review-container">
      {/* Context-aware header */}
      <div className="review-header">
        <h2>Full Membership Review</h2>
        {isInAdminContext && (
          <small style={{ fontSize: '0.8rem', color: '#666', marginLeft: '10px' }}>
            (Admin Panel - Pre-member → Member Applications)
          </small>
        )}
        
        {/* ✅ Enhanced error display with debugging info */}
        {applicationsError && (
          <div style={{ backgroundColor: '#fee', padding: '10px', borderRadius: '5px', marginTop: '10px', border: '1px solid #fcc' }}>
            <details>
              <summary style={{ cursor: 'pointer', fontWeight: 'bold' }}>
                ⚠️ API Error: {applicationsError.message}
              </summary>
              <div style={{ marginTop: '10px', fontSize: '0.9em' }}>
                <p><strong>Debugging Information:</strong></p>
                <ul>
                  <li>Error Type: {applicationsError.name}</li>
                  <li>Error Message: {applicationsError.message}</li>
                  <li>Applications Count: {applications.length}</li>
                  <li>Current Filter: {filterStatus}</li>
                </ul>
                <button 
                  onClick={() => refetchApplications()} 
                  style={{ marginTop: '10px', padding: '5px 10px' }}
                >
                  🔄 Retry Fetch
                </button>
              </div>
            </details>
          </div>
        )}
        
        {/* Stats Overview */}
        {stats && !statsError && (
          <div className="stats-overview">
            <div className="stat-card">
              <h4>Pending</h4>
              <span className="stat-number">{stats?.pending || 0}</span>
            </div>
            <div className="stat-card">
              <h4>Approved</h4>
              <span className="stat-number approved">{stats?.approved || 0}</span>
            </div>
            <div className="stat-card">
              <h4>Declined</h4>
              <span className="stat-number declined">{stats?.declined || 0}</span>
            </div>
            <div className="stat-card">
              <h4>Total</h4>
              <span className="stat-number">{stats?.total || 0}</span>
            </div>
          </div>
        )}

        {statsError && (
          <div style={{ backgroundColor: '#fff3cd', padding: '10px', borderRadius: '5px', marginTop: '10px' }}>
            <small>⚠️ Stats temporarily unavailable: {statsError.message}</small>
          </div>
        )}
      </div>

      {/* Enhanced Controls */}
      <div className="review-controls">
        <div className="control-group">
          <label>Filter by Status:</label>
          <select 
            value={filterStatus} 
            onChange={(e) => setFilterStatus(e.target.value)}
            className="status-filter"
          >
            <option value="pending">Pending</option>
            <option value="approved">Approved</option>
            <option value="declined">Declined</option>
            <option value="all">All</option>
          </select>
        </div>

        <div className="control-group">
          <label>Search Applications:</label>
          <input
            type="text"
            placeholder="Search by email, name, ticket, or responses..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="search-input"
          />
        </div>

        {/* Bulk Actions */}
        {selectedApplications.length > 0 && (
          <div className="bulk-actions">
            <span className="selection-count">
              {selectedApplications.length} selected
            </span>
            <button 
              onClick={() => handleBulkReview('approve')}
              className="bulk-btn approve-btn"
              disabled={bulkReviewMutation.isPending}
            >
              Approve Selected
            </button>
            <button 
              onClick={() => handleBulkReview('decline')}
              className="bulk-btn decline-btn"
              disabled={bulkReviewMutation.isPending}
            >
              Decline Selected
            </button>
            <button onClick={clearSelection} className="bulk-btn clear-btn">
              Clear Selection
            </button>
          </div>
        )}
      </div>

      {/* Selection Controls */}
      <div className="selection-controls">
        <button onClick={selectAll} className="select-all-btn">
          Select All ({filteredApplications.length})
        </button>
        <button onClick={clearSelection} className="clear-selection-btn">
          Clear Selection
        </button>
      </div>

      {/* Applications List */}
      <div className="applications-list">
        {filteredApplications.length === 0 ? (
          <div className="no-applications">
            <div style={{ fontSize: '3rem', marginBottom: '15px' }}>📋</div>
            <h4>No Full Membership Applications</h4>
            <p>No applications found for the current filters.</p>
            <div style={{ marginTop: '20px', fontSize: '0.9em', color: '#666' }}>
              <p><strong>Debug Info:</strong></p>
              <ul style={{ textAlign: 'left', display: 'inline-block' }}>
                <li>Raw applications data: {Array.isArray(applications) ? `Array(${applications.length})` : typeof applications}</li>
                <li>Current filter: "{filterStatus}"</li>
                <li>Search term: "{searchTerm}"</li>
                <li>Has error: {!!applicationsError}</li>
                <li>Is loading: {applicationsLoading}</li>
                <li>Database has 1 pending application (user_id: 7, status: pending)</li>
              </ul>
              <button 
                onClick={() => {
                  console.log('📊 Debug dump:', { 
                    applications, 
                    applicationsData, 
                    filteredApplications, 
                    applicationsError,
                    applicationsLoading 
                  });
                  alert('Check browser console for debug info');
                }}
                style={{ marginTop: '10px', padding: '5px 10px', fontSize: '0.8em' }}
              >
                🔍 Debug Data
              </button>
              <button 
                onClick={() => refetchApplications()}
                style={{ marginTop: '10px', marginLeft: '10px', padding: '5px 10px', fontSize: '0.8em' }}
              >
                🔄 Retry Fetch
              </button>
            </div>
          </div>
        ) : (
          filteredApplications.map((application) => (
            <EnhancedApplicationCard
              key={application.id || application.user_id}
              application={application}
              isSelected={selectedApplications.includes(application.id || application.user_id)}
              onToggleSelection={() => toggleSelection(application.id || application.user_id)}
              onReview={handleReview}
              isReviewing={reviewMutation.isPending}
              renderAnswers={renderApplicationAnswers}
              selectedForDetails={selectedApplication}
              onToggleDetails={setSelectedApplication}
            />
          ))
        )}
      </div>

      {/* Loading states */}
      {(reviewMutation.isPending || bulkReviewMutation.isPending) && (
        <div className="review-loading-overlay">
          <div className="loading-spinner"></div>
          <p>
            {reviewMutation.isPending && 'Processing review...'}
            {bulkReviewMutation.isPending && 'Processing bulk review...'}
          </p>
        </div>
      )}
    </div>
  );
};

// ✅ Enhanced Application Card Component
const EnhancedApplicationCard = ({ 
  application, 
  isSelected, 
  onToggleSelection, 
  onReview, 
  isReviewing,
  renderAnswers,
  selectedForDetails,
  onToggleDetails
}) => {
  const [reviewNotes, setReviewNotes] = useState('');
  const applicationId = application.id || application.user_id;
  const showDetails = selectedForDetails === applicationId;

  return (
    <div className={`application-card ${isSelected ? 'selected' : ''}`}>
      <div className="application-header">
        <div className="application-info">
          <input
            type="checkbox"
            checked={isSelected}
            onChange={onToggleSelection}
            className="selection-checkbox"
          />
          <div className="user-info">
            <h4>
              {application.user_name || application.username || 'Unknown User'}
              <span style={{ fontSize: '0.8em', color: '#666', marginLeft: '10px' }}>
                #{applicationId}
              </span>
            </h4>
            <p className="user-email">{application.user_email || application.email}</p>
            <p className="submission-date">
              Submitted: {
                application.createdAt ? new Date(application.createdAt).toLocaleDateString() : 
                application.submittedAt ? new Date(application.submittedAt).toLocaleDateString() : 
                'Unknown date'
              }
            </p>
            {(application.membership_ticket || application.ticket) && (
              <p style={{ margin: '0', color: '#666', fontSize: '0.8em' }}>
                <strong>Ticket:</strong> 
                <span style={{ 
                  fontFamily: 'monospace', 
                  backgroundColor: '#f0f0f0', 
                  padding: '2px 6px', 
                  borderRadius: '3px',
                  marginLeft: '5px'
                }}>
                  {application.membership_ticket || application.ticket}
                </span>
              </p>
            )}
          </div>
        </div>
        
        <div className="application-status">
          <span className={`status-badge ${application.status || 'pending'}`}>
            {(application.status || 'pending').toUpperCase()}
          </span>
        </div>
      </div>

      {/* Enhanced application answers display */}
      <div className="application-answers-section">
        <h5>📝 Application Responses:</h5>
        {renderAnswers(application.answers || application.responses)}
      </div>

      {/* Admin Notes */}
      {(application.admin_notes || application.adminNotes) && (
        <div style={{ 
          backgroundColor: '#e8f4fd', 
          padding: '10px', 
          borderRadius: '5px',
          marginBottom: '15px'
        }}>
          <strong>Admin Notes:</strong> {application.admin_notes || application.adminNotes}
        </div>
      )}

      <div className="application-actions">
        <button 
          onClick={() => onToggleDetails(showDetails ? null : applicationId)}
          className="toggle-details-btn"
        >
          {showDetails ? 'Hide Details' : 'Show Details'}
        </button>
        
        {(application.status === 'pending' || !application.status) && (
          <div className="review-actions">
            <button 
              onClick={() => onReview(applicationId, 'approved', reviewNotes)}
              className="approve-btn"
              disabled={isReviewing}
            >
              {isReviewing ? '⏳ Processing...' : '✅ Approve'}
            </button>
            <button 
              onClick={() => onReview(applicationId, 'declined', reviewNotes)}
              className="decline-btn"
              disabled={isReviewing}
            >
              {isReviewing ? '⏳ Processing...' : '❌ Decline'}
            </button>
          </div>
        )}
      </div>

      {showDetails && (
        <div className="application-details">
          <h5>Full Application Details:</h5>
          <div className="review-notes-section">
            <label>Review Notes:</label>
            <textarea
              value={reviewNotes}
              onChange={(e) => setReviewNotes(e.target.value)}
              placeholder="Add notes for this review..."
              className="review-notes-input"
            />
          </div>
          <details style={{ marginTop: '15px' }}>
            <summary style={{ cursor: 'pointer', fontWeight: 'bold' }}>Raw Application Data</summary>
            <pre style={{ 
              whiteSpace: 'pre-wrap', 
              fontSize: '0.85em',
              maxHeight: '300px',
              overflow: 'auto',
              backgroundColor: '#f8f9fa',
              padding: '10px',
              borderRadius: '4px',
              marginTop: '10px'
            }}>
              {JSON.stringify(application, null, 2)}
            </pre>
          </details>
        </div>
      )}
    </div>
  );
};

export default FullMembershipReviewControls;


//====================================================

// ikootaclient/src/components/admin/Dashboard.jsx
import KeyStats from './KeyStats';
import PendingReports from './PendingReports';
import Analytics from './Analytics';
import React, { useState } from 'react';
import { useQuery } from '@tanstack/react-query';
import api from '../service/api';

// Update your API functions to handle errors better
const fetchMembershipAnalytics = async (period = '30d') => {
  try {
    const { data } = await api.get(`/membership/admin/analytics?period=${period}&detailed=true`);
    return data;
  } catch (error) {
    console.error('Failed to fetch membership analytics:', error);
    // Return empty structure instead of throwing
    return {
      conversionFunnel: {
        total_registrations: 0,
        started_application: 0,
        approved_initial: 0,
        full_members: 0
      },
      timeSeries: []
    };
  }
};

const fetchMembershipStats = async () => {
  try {
    const { data } = await api.get('/membership/admin/membership-stats');
    return data;
  } catch (error) {
    console.error('Failed to fetch membership stats:', error);
    return {
      stats: {
        total_users: 0,
        new_registrations: 0,
        conversion_to_pre_member: 0,
        conversion_to_full_member: 0,
        avg_approval_days: 0
      }
    };
  }
};

// ✅ ADD: Fetch full membership specific stats
const fetchFullMembershipStats = async () => {
  try {
    const { data } = await api.get('/admin/membership/full-membership-stats');
    return data;
  } catch (error) {
    console.error('Failed to fetch full membership stats:', error);
    return {
      pendingCount: 0,
      approvedCount: 0,
      declinedCount: 0,
      totalApplications: 0,
      avgReviewTime: 0
    };
  }
};

// Update your queries to handle errors better
const Dashboard = () => {
  const [analyticsPeriod, setAnalyticsPeriod] = useState('30d');

  // Legacy audit logs query with error handling
  const { data: auditLogs, isLoading: auditLoading, error: auditError } = useQuery({
    queryKey: ['auditLogs'],
    queryFn: async () => {
      try {
        const { data } = await api.get('/admin/audit-logs');
        return data;
      } catch (error) {
        console.error('Failed to fetch audit logs:', error);
        return []; // Return empty array instead of throwing
      }
    },
    retry: 3,
    retryDelay: attemptIndex => Math.min(1000 * 2 ** attemptIndex, 30000)
  });

  // Membership analytics queries with error handling
  const { data: membershipAnalytics, isLoading: analyticsLoading, error: analyticsError } = useQuery({
    queryKey: ['membershipAnalytics', analyticsPeriod],
    queryFn: () => fetchMembershipAnalytics(analyticsPeriod),
    retry: 3,
    retryDelay: attemptIndex => Math.min(1000 * 2 ** attemptIndex, 30000)
  });

  const { data: membershipStats, isLoading: statsLoading, error: statsError } = useQuery({
    queryKey: ['membershipStats'],
    queryFn: fetchMembershipStats,
    retry: 3,
    retryDelay: attemptIndex => Math.min(1000 * 2 ** attemptIndex, 30000)
  });

  // ✅ ADD: Full membership stats query
  const { data: fullMembershipStats, isLoading: fullMembershipLoading, error: fullMembershipError } = useQuery({
    queryKey: ['fullMembershipStats'],
    queryFn: fetchFullMembershipStats,
    retry: 3,
    retryDelay: attemptIndex => Math.min(1000 * 2 ** attemptIndex, 30000),
    refetchInterval: 60000 // Refresh every minute
  });

  // Helper function for safe access
  const safeAccess = (obj, path, fallback = 0) => {
    try {
      return path.split('.').reduce((current, key) => current?.[key], obj) ?? fallback;
    } catch {
      return fallback;
    }
  };

  return (
    <div className="dashboard">
      <h2>Admin Dashboard</h2>
      
      {/* Existing components */}
      <KeyStats />
      
      {/* ✅ ADD: Full Membership Stats Section */}
      <div className="full-membership-stats-section">
        <h3>Full Membership Overview</h3>
        
        {fullMembershipError && (
          <div className="error-banner">
            <span className="error-icon">⚠️</span>
            <span>Full membership stats temporarily unavailable.</span>
          </div>
        )}

        {fullMembershipLoading ? (
          <div className="loading-state">
            <div className="loading-spinner"></div>
            <p>Loading full membership stats...</p>
          </div>
        ) : (
          <div className="full-membership-cards">
            <div className="stat-card pending">
              <div className="stat-icon">⏳</div>
              <div className="stat-content">
                <h4>Pending Full Membership</h4>
                <span className="stat-number">{fullMembershipStats?.pendingCount || 0}</span>
                <small>Applications awaiting review</small>
              </div>
            </div>
            
            <div className="stat-card approved">
              <div className="stat-icon">✅</div>
              <div className="stat-content">
                <h4>Approved This Month</h4>
                <span className="stat-number">{fullMembershipStats?.approvedCount || 0}</span>
                <small>New full members</small>
              </div>
            </div>
            
            <div className="stat-card declined">
              <div className="stat-icon">❌</div>
              <div className="stat-content">
                <h4>Declined This Month</h4>
                <span className="stat-number">{fullMembershipStats?.declinedCount || 0}</span>
                <small>Applications declined</small>
              </div>
            </div>
            
            <div className="stat-card total">
              <div className="stat-icon">📊</div>
              <div className="stat-content">
                <h4>Total Applications</h4>
                <span className="stat-number">{fullMembershipStats?.totalApplications || 0}</span>
                <small>All time applications</small>
              </div>
            </div>
            
            <div className="stat-card review-time">
              <div className="stat-icon">⏱️</div>
              <div className="stat-content">
                <h4>Avg Review Time</h4>
                <span className="stat-number">{(fullMembershipStats?.avgReviewTime || 0).toFixed(1)}</span>
                <small>Days to review</small>
              </div>
            </div>
          </div>
        )}
        
        {/* Quick Actions */}
        <div className="quick-actions">
          <h4>Quick Actions</h4>
          <div className="action-buttons">
            <a href="/admin/full-membership-review" className="action-btn primary">
              🎓 Review Applications ({fullMembershipStats?.pendingCount || 0})
            </a>
            <a href="/admin/usermanagement" className="action-btn secondary">
              👥 Manage Users
            </a>
            <button 
              onClick={() => window.location.reload()} 
              className="action-btn tertiary"
            >
              🔄 Refresh Stats
            </button>
          </div>
        </div>
      </div>

      {/* Enhanced Membership Analytics Section with Error Handling */}
      <div className="membership-analytics-section">
        <h3>Membership Analytics</h3>
        
        <div className="period-selector">
          <label>Time Period:</label>
          <select 
            value={analyticsPeriod} 
            onChange={(e) => setAnalyticsPeriod(e.target.value)}
          >
            <option value="7d">Last 7 Days</option>
            <option value="30d">Last 30 Days</option>
            <option value="90d">Last 90 Days</option>
            <option value="1y">Last Year</option>
          </select>
        </div>

        {/* Error States */}
        {analyticsError && (
          <div className="error-banner">
            <span className="error-icon">⚠️</span>
            <span>Analytics temporarily unavailable. Some features may be limited.</span>
          </div>
        )}

        {analyticsLoading ? (
          <div className="loading-state">
            <div className="loading-spinner"></div>
            <p>Loading analytics...</p>
          </div>
        ) : (
          <div className="analytics-grid">
            {/* Safe Conversion Funnel */}
            <div className="funnel-chart">
              <h4>Membership Conversion Funnel</h4>
              <div className="funnel-steps">
                <div className="funnel-step">
                  <span className="step-label">Total Registrations</span>
                  <span className="step-value">
                    {safeAccess(membershipAnalytics, 'conversionFunnel.total_registrations')}
                  </span>
                </div>
                <div className="funnel-step">
                  <span className="step-label">Started Application</span>
                  <span className="step-value">
                    {safeAccess(membershipAnalytics, 'conversionFunnel.started_application')}
                  </span>
                  <span className="step-percentage">
                    {membershipAnalytics?.conversionFunnel?.total_registrations > 0 
                      ? ((safeAccess(membershipAnalytics, 'conversionFunnel.started_application') / 
                          safeAccess(membershipAnalytics, 'conversionFunnel.total_registrations')) * 100).toFixed(1)
                      : 0}%
                  </span>
                </div>
                <div className="funnel-step">
                  <span className="step-label">Approved Initial</span>
                  <span className="step-value">
                    {safeAccess(membershipAnalytics, 'conversionFunnel.approved_initial')}
                  </span>
                  <span className="step-percentage">
                    {membershipAnalytics?.conversionFunnel?.started_application > 0 
                      ? ((safeAccess(membershipAnalytics, 'conversionFunnel.approved_initial') / 
                          safeAccess(membershipAnalytics, 'conversionFunnel.started_application')) * 100).toFixed(1)
                      : 0}%
                  </span>
                </div>
                <div className="funnel-step">
                  <span className="step-label">Full Members</span>
                  <span className="step-value">
                    {safeAccess(membershipAnalytics, 'conversionFunnel.full_members')}
                  </span>
                  <span className="step-percentage">
                    {membershipAnalytics?.conversionFunnel?.approved_initial > 0 
                      ? ((safeAccess(membershipAnalytics, 'conversionFunnel.full_members') / 
                          safeAccess(membershipAnalytics, 'conversionFunnel.approved_initial')) * 100).toFixed(1)
                      : 0}%
                  </span>
                </div>
              </div>
            </div>

            {/* Safe Time Series Chart */}
            <div className="time-series-chart">
              <h4>Registration & Approval Trends</h4>
              <div className="chart-container">
                <div className="simple-chart">
                  {membershipAnalytics?.timeSeries?.length > 0 ? (
                    membershipAnalytics.timeSeries.map((point, index) => (
                      <div key={index} className="chart-point">
                        <span>{new Date(point.date).toLocaleDateString()}</span>
                        <span>Registrations: {point.registrations || 0}</span>
                        <span>Approvals: {point.approvals || 0}</span>
                      </div>
                    ))
                  ) : (
                    <div className="no-data">No trend data available</div>
                  )}
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Safe Membership Stats Overview */}
        {statsError && (
          <div className="error-banner">
            <span className="error-icon">⚠️</span>
            <span>Stats temporarily unavailable.</span>
          </div>
        )}

        {statsLoading ? (
          <div className="loading-state">
            <div className="loading-spinner"></div>
            <p>Loading stats...</p>
          </div>
        ) : (
          <div className="membership-stats">
            <h4>Current Status Distribution</h4>
            <div className="stats-breakdown">
              <div className="stat-item">
                <span>Total Users:</span>
                <span>{safeAccess(membershipStats, 'stats.total_users')}</span>
              </div>
              <div className="stat-item">
                <span>New Registrations ({analyticsPeriod}):</span>
                <span>{safeAccess(membershipStats, 'stats.new_registrations')}</span>
              </div>
              <div className="stat-item">
                <span>Pre-Members:</span>
                <span>{safeAccess(membershipStats, 'stats.conversion_to_pre_member')}</span>
              </div>
              <div className="stat-item">
                <span>Full Members:</span>
                <span>{safeAccess(membershipStats, 'stats.conversion_to_full_member')}</span>
              </div>
              <div className="stat-item">
                <span>Avg. Approval Time:</span>
                <span>{safeAccess(membershipStats, 'stats.avg_approval_days', 0).toFixed(1)} days</span>
              </div>
            </div>
          </div>
        )}
      </div>

      {/* Existing components */}
      <Analytics />
      <PendingReports />

      {/* Safe Audit Logs */}
      <div className="audit-logs-section">
        <h3>Audit Logs</h3>
        
        {auditError && (
          <div className="error-banner">
            <span className="error-icon">⚠️</span>
            <span>Audit logs temporarily unavailable.</span>
          </div>
        )}

        {auditLoading ? (
          <div className="loading-state">
            <div className="loading-spinner"></div>
            <p>Loading audit logs...</p>
          </div>
        ) : (
          <div className="audit-table-container">
            {auditLogs?.length > 0 ? (
              <table>
                <thead>
                  <tr>
                    <th>Action</th>
                    <th>Target</th>
                    <th>Details</th>
                    <th>Timestamp</th>
                  </tr>
                </thead>
                <tbody>
                  {auditLogs.map(log => (
                    <tr key={log.id}>
                      <td>{log.action || 'N/A'}</td>
                      <td>{log.target_id || 'N/A'}</td>
                      <td>{log.details || 'N/A'}</td>
                      <td>{log.updatedAt ? new Date(log.updatedAt).toLocaleString() : 'N/A'}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            ) : (
              <div className="no-data">No audit logs available</div>
            )}
          </div>
        )}
      </div>
    </div>
  );
};

export default Dashboard;


//==============================================

// ikootaclient/src/components/admin/AudienceClassMgr.jsx
// Updated for 10-character format (OTU#XXXXXX)

import React, { useState } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import api from '../service/api';
import './audienceclassmgr.css';
import { generateUniqueClassId, validateIdFormat } from '../service/idGenerationService';
import './converseId.css';


const AudienceClassMgr = () => {
  const queryClient = useQueryClient();
  const [formData, setFormData] = useState({
    class_id: '',
    name: '',
    description: '',
  });

  const { data: classes, isLoading, isError } = useQuery({
    queryKey: ['classes'],
    queryFn: async () => {
      const { data } = await api.get('/classes');
      return data;
    },
  });

  const mutation = useMutation({
    mutationFn: async (classData) => {
      // Validate ID format before sending
      if (!validateIdFormat(classData.class_id, 'class')) {
        throw new Error('Invalid class ID format. Must be OTU# followed by 6 alphanumeric characters.');
      }
      
      if (classData.id) {
        return await api.put(`/classes/${classData.id}`, classData);
      } else {
        return await api.post('/classes', classData);
      }
    },
    onSuccess: () => {
      alert('Class saved successfully!');
      queryClient.invalidateQueries(['classes']);
      setFormData({ class_id: '', name: '', description: '' });
    },
    onError: (error) => {
      alert(`Failed to save the class: ${error.message}`);
    },
  });

  const handleGenerateNewClassId = async () => {
    try {
      const newId = await generateUniqueClassId();
      setFormData((prev) => ({ ...prev, class_id: newId }));
    } catch (error) {
      console.error('Failed to generate class ID:', error);
      alert('Failed to generate unique class ID. Please try again.');
    }
  };

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData((prev) => ({ ...prev, [name]: value }));
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    mutation.mutate(formData);
  };

  return (
    <div className="audience-class-mgr-container">
      <h2>Manage Classes</h2>
      
      <form onSubmit={handleSubmit} className="audience-class-form">
        <label>
          Class ID:
          <input
            type="text"
            name="class_id"
            value={formData.class_id}
            onChange={handleInputChange}
            placeholder="OTU#XXXXXX (10 characters)"
            pattern="^OTU#[A-Z0-9]{6}$"
            title="Class ID must be OTU# followed by 6 alphanumeric characters (total 10 characters)"
            maxLength="10"
            readOnly
          />
          <button type="button" onClick={handleGenerateNewClassId}>
            Generate Class ID
          </button>
          {formData.class_id && (
            <span className={validateIdFormat(formData.class_id, 'class') ? 'valid' : 'invalid'}>
              {validateIdFormat(formData.class_id, 'class') ? '✓ Valid format (OTU#XXXXXX)' : '✗ Invalid format'}
            </span>
          )}
        </label>
        
        <label>
          Class Name:
          <input
            type="text"
            name="name"
            value={formData.name}
            onChange={handleInputChange}
            placeholder="Enter class name"
            required
          />
        </label>
        
        <label>
          Description:
          <textarea
            name="description"
            value={formData.description}
            onChange={handleInputChange}
            placeholder="Enter class description"
          />
        </label>
        
        <button type="submit" disabled={mutation.isLoading}>
          {mutation.isLoading ? 'Saving...' : 'Save Class'}
        </button>
      </form>

      <div className="class-list">
        <h3>Existing Classes</h3>
        {isLoading && <p>Loading classes...</p>}
        {isError && <p>Error loading classes.</p>}
        <ul>
          {classes?.map((cls) => (
            <li key={cls.class_id}>
              <strong>{cls.name}</strong> ({cls.class_id}) - {cls.description}
              <div className="id-info">
                <small>Format: {cls.class_id.length === 10 ? '✓ 10 chars' : '✗ Invalid length'}</small>
              </div>
            </li>
          ))}
        </ul>
      </div>
    </div>
  );
};

export default AudienceClassMgr;


//====================================

//ikootaclient\src\components\admin\Analytics.jsx
import React from 'react';
import { Bar } from 'react-chartjs-2';
import { Chart as ChartJS, CategoryScale, LinearScale, BarElement, Title, Tooltip, Legend } from 'chart.js';

ChartJS.register(CategoryScale, LinearScale, BarElement, Title, Tooltip, Legend);

const Analytics = () => {
  const data = {
    labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July'],
    datasets: [
      {
        label: 'Dataset 1',
        data: [65, 59, 80, 81, 56, 55, 40],
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        borderColor: 'rgba(75, 192, 192, 1)',
        borderWidth: 1,
      },
    ],
  };

  const options = {
    responsive: true,
    plugins: {
      legend: {
        position: 'top',
      },
      title: {
        display: true,
        text: 'Chart.js Bar Chart',
      },
    },
  };

  return (
    <div>
      <h2>Analytics</h2>
      <Bar data={data} options={options} />
    </div>
  );
};

export default Analytics;

//==============================================


// ikootaclient/src/components/admin/Admin.jsx
import React, { useState, useEffect } from 'react';
import './admin.css';
import Navbar from './Navbar';
import Sidebar from './Sidebar';
import { Outlet, useLocation } from "react-router-dom";
import FullMembershipReviewControls from './FullMembershipReviewControls';

const Admin = () => {
  const [selectedItem, setSelectedItem] = useState('Dashboard');
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
  const [isMobile, setIsMobile] = useState(false);
  const location = useLocation();

  // Check if device is mobile
  useEffect(() => {
    const checkMobile = () => {
      setIsMobile(window.innerWidth <= 768);
      // Close mobile menu when switching to desktop
      if (window.innerWidth > 768) {
        setIsMobileMenuOpen(false);
      }
    };

    checkMobile();
    window.addEventListener('resize', checkMobile);
    return () => window.removeEventListener('resize', checkMobile);
  }, []);

  // Update selected item based on current route
  useEffect(() => {
    const path = location.pathname;
    
    if (path === '/admin' || path === '/admin/') {
      setSelectedItem('Dashboard');
    } else if (path.includes('towncrier')) {
      setSelectedItem(path.includes('controls') ? 'Towncrier Controls' : 'Towncrier');
    } else if (path.includes('iko')) {
      setSelectedItem(path.includes('controls') ? 'Iko Controls' : 'Iko');
    } else if (path.includes('authcontrols')) {
      setSelectedItem('AuthControls');
    } else if (path.includes('searchcontrols')) {
      setSelectedItem('SearchControls');
    } else if (path.includes('reports')) {
      setSelectedItem('Reports');
    } else if (path.includes('usermanagement')) {
      setSelectedItem('UserManagement');
    } else if (path.includes('audienceclassmgr')) {
      setSelectedItem('AudienceClassMgr');
    } else if (path.includes('full-membership-review')) {
      // ✅ ADD: Handle full membership review route
      setSelectedItem('Full Membership Review');
    }
  }, [location.pathname]);

  // Close mobile menu when route changes
  useEffect(() => {
    if (isMobile) {
      setIsMobileMenuOpen(false);
    }
  }, [location.pathname, isMobile]);

  // Handle mobile menu toggle
  const toggleMobileMenu = () => {
    setIsMobileMenuOpen(!isMobileMenuOpen);
  };

  // Handle overlay click (close menu)
  const handleOverlayClick = () => {
    setIsMobileMenuOpen(false);
  };

  // Handle escape key press
  useEffect(() => {
    const handleEscape = (e) => {
      if (e.key === 'Escape' && isMobileMenuOpen) {
        setIsMobileMenuOpen(false);
      }
    };

    document.addEventListener('keydown', handleEscape);
    return () => document.removeEventListener('keydown', handleEscape);
  }, [isMobileMenuOpen]);

  // Prevent body scroll when mobile menu is open
  useEffect(() => {
    if (isMobileMenuOpen) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = 'unset';
    }

    return () => {
      document.body.style.overflow = 'unset';
    };
  }, [isMobileMenuOpen]);

  return (
    <div className='adminContainer'>
      {/* Mobile Overlay */}
      {isMobile && (
        <div 
          className={`mobile-overlay ${isMobileMenuOpen ? 'active' : ''}`}
          onClick={handleOverlayClick}
        />
      )}

      {/* Sidebar */}
      <div className={`adminSidebar ${isMobileMenuOpen ? 'mobile-open' : ''}`}>
        {/* Mobile Sidebar Header */}
        {isMobile && (
          <div className="mobile-sidebar-header">
            <span className="mobile-sidebar-title">Admin Menu</span>
            <button 
              className="mobile-close-btn"
              onClick={toggleMobileMenu}
              aria-label="Close menu"
            >
              ×
            </button>
          </div>
        )}

        <Sidebar 
          selectedItem={selectedItem} 
          setSelectedItem={setSelectedItem}
          isMobile={isMobile}
          closeMobileMenu={() => setIsMobileMenuOpen(false)}
        />
      </div>

      <div className='headerContent'>
        <div className='adminNav'>
          {/* Mobile Menu Toggle Button */}
          {isMobile && (
            <button 
              className="mobile-menu-toggle"
              onClick={toggleMobileMenu}
              aria-label="Toggle menu"
            >
              ☰
            </button>
          )}
          
          {/* ✅ Navbar component now contains all action buttons */}
          <Navbar />
        </div>
        
        <div className="mainContent">
          <Outlet />
        </div>
      </div>
    </div>
  );
};

export default Admin;

//==================================

















//index.js and routes

// File: ikootaapi/routes/index.js
// ===============================================

import express from 'express';
import cors from 'cors';
import helmet from 'helmet';
import compression from 'compression';
import rateLimit from 'express-rate-limit';

// ===============================================
// IMPORT REORGANIZED ROUTE MODULES
// ===============================================

// Phase 1 Routes - Core System
import authRoutes from './authRoutes.js';
import userRoutes from './userRoutes.js';
import systemRoutes from './systemRoutes.js';

// Phase 2 Routes - Membership & Admin
import membershipApplicationRoutes from './membershipApplicationRoutes.js';
import surveyRoutes from './surveyRoutes.js';
import adminUserRoutes from './adminUserRoutes.js';
import adminMembershipRoutes from './adminMembershipRoutes.js';
import adminContentRoutes from './adminContentRoutes.js';

// Phase 3 Routes - Content & Communication
import contentRoutes from './contentRoutes.js';
import communicationRoutes from './communicationRoutes.js';
import identityRoutes from './identityRoutes.js';

// ===============================================
// 🚨 CRITICAL MISSING ROUTES - NOW ADDED
// ===============================================
import userStatusRoutes from './userStatusRoutes.js';
import analyticsRoutes from './analyticsRoutes.js';

// ===============================================
// LEGACY/EXISTING ROUTES (PROPER NAMES - NO "legacy" PREFIX)
// ===============================================
import membershipRoutes from './membershipRoutes.js';        // ✅ RENAMED: was legacyMembershipRoutes
import teachingsRoutes from './teachingsRoutes.js';          // ✅ RENAMED: was legacyTeachingsRoutes  
import chatRoutes from './chatRoutes.js';                    // ✅ RENAMED: was legacyChatRoutes
import commentRoutes from './commentRoutes.js';              // ✅ RENAMED: was legacyCommentRoutes
import classRoutes from './classRoutes.js';                  // ✅ RENAMED: was legacyClassRoutes

// ===============================================
// NOTE: THESE CAN BE SAFELY DELETED (FULLY DUPLICATED)
// ===============================================
// adminRoutes.js - All endpoints covered in specialized admin routes
// fullMembershipRoutes.js - All endpoints covered in membershipApplicationRoutes.js
// adminApplicationRoutes.js - Mostly covered, but check for system config endpoints first

const router = express.Router();

// ===============================================
// GLOBAL MIDDLEWARE SETUP (UNCHANGED)
// ===============================================

// Security middleware
router.use(helmet({
  contentSecurityPolicy: false,
  crossOriginEmbedderPolicy: false
}));

// CORS configuration
router.use(cors({
  origin: process.env.NODE_ENV === 'production' 
    ? process.env.ALLOWED_ORIGINS?.split(',') || []
    : true,
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With']
}));

router.use(compression());

// Rate limiting
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: process.env.NODE_ENV === 'production' ? 100 : 1000,
  message: {
    error: 'Too many requests from this IP, please try again later.',
    retryAfter: '15 minutes'
  },
  standardHeaders: true,
  legacyHeaders: false
});

router.use(limiter);

// Request logging middleware
router.use((req, res, next) => {
  const startTime = Date.now();
  
  if (process.env.NODE_ENV === 'development') {
    console.log(`📥 ${new Date().toISOString()} - ${req.method} ${req.originalUrl}`, {
      ip: req.ip,
      userAgent: req.get('User-Agent')?.substring(0, 50) + '...'
    });
  }
  
  const originalSend = res.send;
  res.send = function(data) {
    const duration = Date.now() - startTime;
    
    if (process.env.NODE_ENV === 'development') {
      const statusColor = res.statusCode < 400 ? '✅' : '❌';
      console.log(`📤 ${statusColor} ${res.statusCode} - ${req.method} ${req.originalUrl} (${duration}ms)`);
    }
    
    originalSend.call(this, data);
  };
  
  next();
});

// ===============================================
// ROUTE MOUNTING - LOGICAL ORDER
// ===============================================

console.log('🔧 Mounting reorganized API routes...');

// ===== 1. SYSTEM ROUTES (Health, Info, Testing) =====
router.use('/', systemRoutes);

// ===== 2. AUTHENTICATION (Critical - Must be early) =====
router.use('/auth', authRoutes);

// ===== 3. USER MANAGEMENT =====
router.use('/users', userRoutes);

// ===== 🚨 4. USER STATUS (CRITICAL MISSING ROUTE) =====
router.use('/user-status', userStatusRoutes);

// ===== 5. MEMBERSHIP & APPLICATIONS =====
router.use('/membership', membershipApplicationRoutes);
router.use('/survey', surveyRoutes);

// ===== 6. ADMIN ROUTES (Grouped by function) =====
router.use('/admin/users', adminUserRoutes);
router.use('/admin/membership', adminMembershipRoutes);
router.use('/admin/content', adminContentRoutes);

// ===== 🚨 7. ANALYTICS (MISSING IMPORTANT ROUTE) =====
router.use('/analytics', analyticsRoutes);

// ===== 8. CONTENT & COMMUNITY =====
router.use('/content', contentRoutes);

// ===== 9. COMMUNICATION =====
router.use('/communication', communicationRoutes);

// ===== 10. IDENTITY VERIFICATION =====
router.use('/identity', identityRoutes);

// ===============================================
// BACKWARD COMPATIBILITY ROUTES (PROPER NAMES)
// ===============================================

console.log('🔄 Mounting backward compatibility routes...');

// ✅ RENAMED: Comprehensive membership routes (no "legacy" prefix)
router.use('/membership-complete', membershipRoutes);

// ✅ RENAMED: Individual content type routes (no "legacy" prefix)  
router.use('/teachings', teachingsRoutes);
router.use('/chats', chatRoutes);
router.use('/comments', commentRoutes);
router.use('/classes', classRoutes);

// Content route aliases (redirect to new structure)
router.use('/chat', (req, res, next) => {
  req.url = '/communication' + req.url;
  communicationRoutes(req, res, next);
});

// ===============================================
// API INFORMATION ENDPOINTS (UPDATED)
// ===============================================

router.get('/info', (req, res) => {
  res.json({
    success: true,
    message: 'Ikoota API - Complete Reorganized Architecture',
    version: '2.1.0',
    timestamp: new Date().toISOString(),
    environment: process.env.NODE_ENV || 'development',
    architecture: {
      description: 'Modular route organization with zero legacy naming',
      phases: {
        phase1: 'Core system routes (auth, users, system, user-status)',
        phase2: 'Membership applications and admin management',
        phase3: 'Content, communication, identity, and analytics',
        phase4: 'Backward compatibility with proper naming'
      }
    },
    routes: {
      // New organized routes
      core: {
        authentication: '/api/auth/*',
        users: '/api/users/*',
        userStatus: '/api/user-status/*',      // ✅ ADDED
        system: '/api/health, /api/info'
      },
      membership: {
        applications: '/api/membership/*',
        surveys: '/api/survey/*'
      },
      admin: {
        users: '/api/admin/users/*',
        membership: '/api/admin/membership/*',
        content: '/api/admin/content/*'
      },
      content: {
        unified: '/api/content/*',
        communication: '/api/communication/*'
      },
      analytics: '/api/analytics/*',           // ✅ ADDED
      identity: '/api/identity/*',
      
      // Backward compatibility routes (proper names)
      compatibility: {
        membershipComplete: '/api/membership-complete/*',  // ✅ RENAMED
        teachings: '/api/teachings/*',
        chats: '/api/chats/*', 
        comments: '/api/comments/*',
        classes: '/api/classes/*'
      }
    },
    features: {
      security: ['Helmet protection', 'CORS configured', 'Rate limiting'],
      performance: ['Response compression', 'Request caching', 'Response time logging'],
      monitoring: ['Request logging', 'Error tracking', 'Performance metrics'],
      compatibility: ['No legacy prefixes', 'Gradual migration path', 'Zero downtime deployment']
    },
    improvements: {
      added: ['User status routes', 'Analytics routes', 'Proper route naming'],
      removed: ['Legacy prefixes', 'Redundant route files'],
      enhanced: ['Complete API coverage', 'Better organization', 'Clear naming']
    }
  });
});

// Route discovery endpoint (updated)
router.get('/routes', (req, res) => {
  const routes = [];
  
  function extractRoutes(router, basePath = '') {
    if (router.stack) {
      router.stack.forEach(layer => {
        if (layer.route) {
          const methods = Object.keys(layer.route.methods);
          routes.push({
            path: basePath + layer.route.path,
            methods: methods.map(m => m.toUpperCase())
          });
        } else if (layer.name === 'router') {
          const path = layer.regexp.source
            .replace('^\\/(?=\\/|$)', '')
            .replace('\\', '')
            .replace('$', '')
            .replace('?', '');
          extractRoutes(layer.handle, basePath + '/' + path);
        }
      });
    }
  }
  
  extractRoutes(router);
  
  res.json({
    success: true,
    message: 'Complete API Route Discovery',
    totalRoutes: routes.length,
    routes: routes.slice(0, 50),
    criticalRoutes: {
      userStatus: '/api/user-status/*',
      analytics: '/api/analytics/*',
      membershipComplete: '/api/membership-complete/*'
    },
    note: 'All legacy prefixes removed. Showing first 50 routes.',
    timestamp: new Date().toISOString()
  });
});

// ===============================================
// PERFORMANCE MONITORING ENDPOINTS (UNCHANGED)
// ===============================================

router.get('/metrics', (req, res) => {
  const memUsage = process.memoryUsage();
  
  res.json({
    success: true,
    metrics: {
      uptime: process.uptime(),
      memory: {
        rss: Math.round(memUsage.rss / 1024 / 1024) + 'MB',
        heapTotal: Math.round(memUsage.heapTotal / 1024 / 1024) + 'MB',
        heapUsed: Math.round(memUsage.heapUsed / 1024 / 1024) + 'MB',
        external: Math.round(memUsage.external / 1024 / 1024) + 'MB'
      },
      cpu: process.cpuUsage(),
      platform: process.platform,
      nodeVersion: process.version,
      environment: process.env.NODE_ENV
    },
    timestamp: new Date().toISOString()
  });
});

// ===============================================
// ENHANCED 404 HANDLER (UPDATED)
// ===============================================

router.use('*', (req, res) => {
  console.log(`❌ API route not found: ${req.method} ${req.originalUrl}`);
  
  const requestedPath = req.originalUrl.toLowerCase();
  const suggestions = [];
  
  if (requestedPath.includes('user')) {
    suggestions.push('/api/users', '/api/user-status', '/api/auth');
  }
  if (requestedPath.includes('status')) {
    suggestions.push('/api/user-status', '/api/users/status');
  }
  if (requestedPath.includes('member')) {
    suggestions.push('/api/membership', '/api/membership-complete', '/api/admin/membership');
  }
  if (requestedPath.includes('admin')) {
    suggestions.push('/api/admin/users', '/api/admin/membership', '/api/admin/content');
  }
  if (requestedPath.includes('analytics') || requestedPath.includes('stats')) {
    suggestions.push('/api/analytics', '/api/admin/membership');
  }
  if (requestedPath.includes('chat') || requestedPath.includes('message')) {
    suggestions.push('/api/communication', '/api/chats');
  }
  if (requestedPath.includes('content') || requestedPath.includes('teaching')) {
    suggestions.push('/api/content', '/api/teachings');
  }
  
  res.status(404).json({
    success: false,
    message: 'API endpoint not found',
    path: req.originalUrl,
    method: req.method,
    suggestions: suggestions.length > 0 ? suggestions : undefined,
    availableRoutes: {
      core: {
        authentication: '/api/auth/*',
        users: '/api/users/*',
        userStatus: '/api/user-status/*',        // ✅ ADDED
        system: '/api/health, /api/info, /api/routes'
      },
      membership: {
        applications: '/api/membership/*',
        surveys: '/api/survey/*',
        complete: '/api/membership-complete/*'   // ✅ ADDED
      },
      admin: {
        users: '/api/admin/users/*',
        membership: '/api/admin/membership/*',
        content: '/api/admin/content/*'
      },
      analytics: '/api/analytics/*',             // ✅ ADDED
      content: {
        unified: '/api/content/*',
        communication: '/api/communication/*',
        identity: '/api/identity/*'
      },
      compatibility: {
        note: 'Individual content routes available',
        routes: '/api/teachings/*, /api/chats/*, /api/comments/*, /api/classes/*'
      }
    },
    help: {
      documentation: '/api/info',
      routeDiscovery: '/api/routes',
      healthCheck: '/api/health',
      performance: '/api/metrics'
    },
    timestamp: new Date().toISOString()
  });
});

// ===============================================
// GLOBAL ERROR HANDLER (UNCHANGED)
// ===============================================

router.use((error, req, res, next) => {
  const errorId = Date.now().toString(36) + Math.random().toString(36).substr(2);
  
  console.error('🚨 Global API Error:', {
    errorId,
    error: error.message,
    stack: process.env.NODE_ENV === 'development' ? error.stack : undefined,
    path: req.originalUrl,
    method: req.method,
    ip: req.ip,
    userAgent: req.get('User-Agent'),
    timestamp: new Date().toISOString()
  });
  
  let statusCode = error.statusCode || error.status || 500;
  let errorType = 'server_error';
  
  if (error.message.includes('validation') || error.message.includes('required')) {
    statusCode = 400;
    errorType = 'validation_error';
  } else if (error.message.includes('authentication') || error.message.includes('token')) {
    statusCode = 401;
    errorType = 'authentication_error';
  } else if (error.message.includes('permission') || error.message.includes('access denied')) {
    statusCode = 403;
    errorType = 'authorization_error';
  } else if (error.message.includes('not found')) {
    statusCode = 404;
    errorType = 'not_found_error';
  } else if (error.message.includes('database') || error.message.includes('connection')) {
    statusCode = 503;
    errorType = 'database_error';
  } else if (error.message.includes('timeout')) {
    statusCode = 504;
    errorType = 'timeout_error';
  }
  
  const errorResponse = {
    success: false,
    error: error.message || 'Internal server error',
    errorType,
    errorId,
    path: req.originalUrl,
    method: req.method,
    timestamp: new Date().toISOString()
  };
  
  // Add debug info in development
  if (process.env.NODE_ENV === 'development') {
    errorResponse.debug = {
      stack: error.stack,
      details: error
    };
  }
  
  // Add helpful suggestions based on error type
  if (statusCode === 401) {
    errorResponse.help = {
      message: 'Authentication required',
      endpoint: '/api/auth/login',
      documentation: '/api/auth'
    };
  } else if (statusCode === 403) {
    errorResponse.help = {
      message: 'Insufficient permissions',
      note: 'Contact administrator if you believe this is an error'
    };
  } else if (statusCode === 404) {
    errorResponse.help = {
      message: 'Endpoint not found',
      routeDiscovery: '/api/routes',
      documentation: '/api/info'
    };
  }
  
  res.status(statusCode).json(errorResponse);
});

// ===============================================
// DEVELOPMENT LOGGING & STARTUP (UPDATED)
// ===============================================

if (process.env.NODE_ENV === 'development') {
  console.log('\n🚀 IKOOTA API - COMPLETE REORGANIZED ARCHITECTURE LOADED');
  console.log('================================================================================');
  console.log('✅ PHASE 1: Core system routes (auth, users, system, user-status)');
  console.log('✅ PHASE 2: Membership applications and admin management');
  console.log('✅ PHASE 3: Content, communication, identity, and analytics');
  console.log('✅ PHASE 4: Backward compatibility with proper naming');
  console.log('================================================================================');
  
  console.log('\n📊 COMPLETE ROUTE ORGANIZATION:');
  console.log('   🔐 Authentication & Authorization: /api/auth/*');
  console.log('   👤 User Management: /api/users/*');
  console.log('   📊 User Status & Dashboard: /api/user-status/*      ✅ CRITICAL ADDITION');
  console.log('   📋 Membership Applications: /api/membership/*');
  console.log('   📊 Surveys & Questionnaires: /api/survey/*');
  console.log('   👨‍💼 Admin User Management: /api/admin/users/*');
  console.log('   🏛️ Admin Membership Review: /api/admin/membership/*');
  console.log('   📄 Admin Content Management: /api/admin/content/*');
  console.log('   📈 Analytics & Reporting: /api/analytics/*          ✅ CRITICAL ADDITION');
  console.log('   📚 Content & Community: /api/content/*');
  console.log('   💬 Communication & Messaging: /api/communication/*');
  console.log('   🆔 Identity Verification: /api/identity/*');
  console.log('   🔧 System & Health: /api/health, /api/info, /api/routes');
  
  console.log('\n🔄 BACKWARD COMPATIBILITY (PROPER NAMES):');
  console.log('   📚 Complete Membership System: /api/membership-complete/*  ✅ RENAMED');
  console.log('   📚 Individual Teachings: /api/teachings/*                  ✅ RENAMED');
  console.log('   💬 Individual Chats: /api/chats/*                         ✅ RENAMED');
  console.log('   💭 Individual Comments: /api/comments/*                    ✅ RENAMED');
  console.log('   🎓 Individual Classes: /api/classes/*                     ✅ RENAMED');
  
  console.log('\n🛡️ SECURITY & PERFORMANCE:');
  console.log('   • Helmet security headers enabled');
  console.log('   • CORS configured for development/production');
  console.log('   • Rate limiting: 100 req/15min (prod), 1000 req/15min (dev)');
  console.log('   • Response compression enabled');
  console.log('   • Request/response logging enabled');
  console.log('   • Global error handling with categorization');
  
  console.log('\n📈 MONITORING ENDPOINTS:');
  console.log('   📋 API Information: /api/info');
  console.log('   🗺️ Route Discovery: /api/routes');
  console.log('   ❤️ Health Check: /api/health');
  console.log('   📊 Performance Metrics: /api/metrics');
  
  console.log('\n🎯 CRITICAL FIXES IMPLEMENTED:');
  console.log('   ✅ Added missing userStatusRoutes.js (/api/user-status/*)');
  console.log('   ✅ Added missing analyticsRoutes.js (/api/analytics/*)');
  console.log('   ✅ Removed all "legacy" prefixes from route names');
  console.log('   ✅ Proper backward compatibility with clear naming');
  console.log('   ✅ Complete API endpoint coverage verified');
  console.log('   ✅ Zero functionality loss during reorganization');
  
  console.log('\n📁 ROUTE FILES STATUS:');
  console.log('   ✅ MOUNTED: authRoutes.js, userRoutes.js, systemRoutes.js');
  console.log('   ✅ MOUNTED: membershipApplicationRoutes.js, surveyRoutes.js');  
  console.log('   ✅ MOUNTED: adminUserRoutes.js, adminMembershipRoutes.js, adminContentRoutes.js');
  console.log('   ✅ MOUNTED: contentRoutes.js, communicationRoutes.js, identityRoutes.js');
  console.log('   ✅ MOUNTED: userStatusRoutes.js, analyticsRoutes.js          ← CRITICAL ADDITIONS');
  console.log('   ✅ MOUNTED: membershipRoutes.js, teachingsRoutes.js, chatRoutes.js, commentRoutes.js, classRoutes.js');
  
  console.log('\n🗑️ SAFE TO DELETE (FULLY DUPLICATED):');
  console.log('   ❌ adminRoutes.js - All endpoints covered in specialized admin routes');
  console.log('   ❌ fullMembershipRoutes.js - All endpoints covered in membershipApplicationRoutes.js');
  console.log('   ⚠️ adminApplicationRoutes.js - Mostly covered, check system config endpoints first');
  
  console.log('\n🚀 BENEFITS ACHIEVED:');
  console.log('   ✅ Complete API endpoint coverage');
  console.log('   ✅ Zero downtime migration path');
  console.log('   ✅ Eliminated route duplication');
  console.log('   ✅ Clear separation of concerns');
  console.log('   ✅ Enhanced security and monitoring');
  console.log('   ✅ Improved performance and caching');
  console.log('   ✅ Comprehensive error handling');
  console.log('   ✅ Better developer experience');
  console.log('   ✅ Clean naming without legacy prefixes');
  
  console.log('================================================================================');
  console.log('🌟 API READY FOR PRODUCTION DEPLOYMENT WITH COMPLETE ENDPOINT COVERAGE!');
  console.log('================================================================================\n');
}

export default router;



//======================//============================//

// File: ikootaapi/routes/adminContentRoutes.js
// ADMIN CONTENT ROUTES - ADMIN CONTENT & COMMUNICATION

import express from 'express';
import { authenticate, authorize, cacheMiddleware } from '../middlewares/auth.middleware.js';

// Import admin controllers
import {
  getPendingContent,
  manageContent,
  approveContent,
  rejectContent,
  getReports,
  updateReportStatus,
  getAuditLogs,
  sendNotification
} from '../controllers/adminControllers.js';

const adminContentRouter = express.Router();

// ===== BASIC MIDDLEWARE =====
adminContentRouter.use(authenticate);
adminContentRouter.use(authorize(['admin', 'super_admin']));

// ===============================================
// CONTENT MANAGEMENT ROUTES
// ===============================================

// Get pending content
adminContentRouter.get('/pending', cacheMiddleware(300), getPendingContent);

// Get all content for management
adminContentRouter.get('/all', cacheMiddleware(300), manageContent);
adminContentRouter.get('/', cacheMiddleware(300), manageContent); // Alias

// Bulk content actions
adminContentRouter.post('/bulk-manage', manageContent);

// Approve/reject specific content
adminContentRouter.post('/:id/approve', approveContent);
adminContentRouter.post('/:id/reject', rejectContent);

// ===============================================
// REPORTS MANAGEMENT ROUTES
// ===============================================

// Get all reports
adminContentRouter.get('/reports', cacheMiddleware(600), getReports);

// Update report status
adminContentRouter.put('/reports/:reportId/status', updateReportStatus);

// ===============================================
// NOTIFICATIONS & COMMUNICATION ROUTES
// ===============================================

// Send general notifications
adminContentRouter.post('/notifications/send', sendNotification);

// Send membership-specific notifications
adminContentRouter.post('/notifications/membership', async (req, res) => {
  // This would integrate with membership notification controller
  res.json({ message: 'Membership notification endpoint - integrate with membership controller' });
});

// Send bulk notifications
adminContentRouter.post('/notifications/bulk', async (req, res) => {
  // This would integrate with bulk notification controller
  res.json({ message: 'Bulk notification endpoint - integrate with communication controller' });
});

// ===============================================
// AUDIT LOGS ROUTES
// ===============================================

// Get audit logs
adminContentRouter.get('/audit-logs', cacheMiddleware(300), getAuditLogs);

// ===============================================
// ERROR HANDLING
// ===============================================

// 404 handler for admin content routes
adminContentRouter.use('*', (req, res) => {
  res.status(404).json({
    success: false,
    error: 'Admin content route not found',
    path: req.path,
    method: req.method,
    availableRoutes: {
      content: [
        'GET /pending - Get pending content',
        'GET /all - Get all content',
        'POST /bulk-manage - Bulk content actions',
        'POST /:id/approve - Approve content',
        'POST /:id/reject - Reject content'
      ],
      reports: [
        'GET /reports - Get all reports',
        'PUT /reports/:reportId/status - Update report status'
      ],
      notifications: [
        'POST /notifications/send - Send notification',
        'POST /notifications/membership - Send membership notification',
        'POST /notifications/bulk - Send bulk notifications'
      ],
      audit: [
        'GET /audit-logs - Get audit logs'
      ]
    },
    timestamp: new Date().toISOString()
  });
});

// Global error handler for admin content routes
adminContentRouter.use((error, req, res, next) => {
  console.error('❌ Admin content route error:', {
    error: error.message,
    stack: error.stack,
    route: req.originalUrl,
    method: req.method,
    user: req.user?.username,
    timestamp: new Date().toISOString()
  });
  
  res.status(error.status || 500).json({
    success: false,
    message: error.message || 'Internal server error',
    error: process.env.NODE_ENV === 'development' ? {
      stack: error.stack
    } : undefined,
    timestamp: new Date().toISOString()
  });
});

if (process.env.NODE_ENV === 'development') {
  console.log('📄 Admin content routes loaded with content management and communication');
}

export default adminContentRouter;


//======================//============================//


// File: ikootaapi/routes/adminMembershipRoutes.js
// ADMIN MEMBERSHIP ROUTES - COMPLETE ADMIN MEMBERSHIP REVIEW SYSTEM
// Handles all admin review functionality for full membership applications

import express from 'express';
import { authenticate, authorize } from '../middlewares/auth.middleware.js';
import db from '../config/db.js';

const adminMembershipRouter = express.Router();

// Basic admin authentication middleware
adminMembershipRouter.use(authenticate);
adminMembershipRouter.use(authorize(['admin', 'super_admin']));

// ===============================================
// FULL MEMBERSHIP APPLICATION MANAGEMENT
// ===============================================

// Get full membership applications
adminMembershipRouter.get('/applications', async (req, res) => {
  try {
    console.log('🔍 ADMIN: Fetching full membership applications');
    const { status = 'pending' } = req.query;

    let query = `
      SELECT 
        fma.id,
        fma.user_id,
        fma.membership_ticket,
        fma.answers,
        fma.status,
        fma.submittedAt,
        fma.reviewedAt,
        fma.reviewed_by,
        fma.admin_notes,
        u.username as user_name,
        u.email as user_email,
        reviewer.username as reviewer_name
      FROM full_membership_applications fma
      JOIN users u ON fma.user_id = u.id
      LEFT JOIN users reviewer ON fma.reviewed_by = reviewer.id
    `;

    let queryParams = [];

    if (status !== 'all') {
      query += ' WHERE fma.status = ?';
      queryParams = [status];
    }

    query += ' ORDER BY fma.submittedAt DESC';

    const applications = await db.query(query, queryParams);
    
    console.log('✅ Found', applications.length, 'applications');

    res.json({
      success: true,
      data: applications,
      meta: {
        count: applications.length,
        status: status,
        timestamp: new Date().toISOString()
      }
    });

  } catch (error) {
    console.error('❌ Error fetching applications:', error);
    res.status(500).json({
      success: false,
      error: error.message,
      count: 0
    });
  }
});

// Get specific application details
adminMembershipRouter.get('/applications/:id', async (req, res) => {
  try {
    const { id } = req.params;
    
    console.log('🔍 ADMIN: Getting application details for ID:', id);
    
    const applications = await db.query(`
      SELECT 
        fma.*,
        u.username,
        u.email,
        u.membership_stage,
        u.is_member,
        reviewer.username as reviewer_name
      FROM full_membership_applications fma
      JOIN users u ON fma.user_id = u.id
      LEFT JOIN users reviewer ON fma.reviewed_by = reviewer.id
      WHERE fma.id = ?
    `, [id]);

    if (applications.length === 0) {
      return res.status(404).json({
        success: false,
        error: 'Application not found'
      });
    }

    res.json({
      success: true,
      data: applications[0],
      timestamp: new Date().toISOString()
    });

  } catch (error) {
    console.error('❌ Error getting application details:', error);
    res.status(500).json({
      success: false,
      error: error.message,
      details: 'Failed to get application details'
    });
  }
});

// Alternative route for application details (from clean version)
adminMembershipRouter.get('/application/:id', async (req, res) => {
  try {
    const { id } = req.params;
    
    console.log('🔍 ADMIN: Getting application details for ID:', id);
    
    const applications = await db.query(`
      SELECT 
        fma.*,
        u.username,
        u.email,
        u.membership_stage,
        u.is_member,
        reviewer.username as reviewer_name
      FROM full_membership_applications fma
      JOIN users u ON fma.user_id = u.id
      LEFT JOIN users reviewer ON fma.reviewed_by = reviewer.id
      WHERE fma.id = ?
    `, [id]);

    if (applications.length === 0) {
      return res.status(404).json({
        success: false,
        error: 'Application not found'
      });
    }

    res.json({
      success: true,
      data: applications[0],
      timestamp: new Date().toISOString()
    });

  } catch (error) {
    console.error('❌ Error getting application details:', error);
    res.status(500).json({
      success: false,
      error: error.message,
      details: 'Failed to get application details'
    });
  }
});

// ===============================================
// APPLICATION REVIEW ACTIONS
// ===============================================

// Review individual application (approve/decline)
adminMembershipRouter.put('/applications/:id/review', async (req, res) => {
  try {
    const { id } = req.params;
    const { status, adminNotes } = req.body;
    
    console.log('🔍 ADMIN: Reviewing application:', { id, status, adminNotes });
    
    // Validate status
    if (!['approved', 'declined', 'suspended'].includes(status)) {
      return res.status(400).json({
        success: false,
        error: 'Invalid status. Must be approved, declined, or suspended'
      });
    }

    // Start transaction
    await db.query('START TRANSACTION');

    try {
      // Update the application
      await db.query(`
        UPDATE full_membership_applications 
        SET 
          status = ?,
          admin_notes = ?,
          reviewedAt = NOW(),
          reviewed_by = ?
        WHERE id = ?
      `, [status, adminNotes || '', req.user?.id || 1, id]);

      // If approved, update user's membership status
      if (status === 'approved') {
        await db.query(`
          UPDATE users 
          SET 
            is_member = 'member',
            membership_stage = 'member',
            full_membership_status = 'approved',
            fullMembershipReviewedAt = NOW()
          WHERE id = (
            SELECT user_id 
            FROM full_membership_applications 
            WHERE id = ?
          )
        `, [id]);

        console.log('✅ User promoted to full member');
      }

      // Commit transaction
      await db.query('COMMIT');

      console.log('✅ Application reviewed successfully');

      res.json({
        success: true,
        message: `Application ${status} successfully`,
        applicationId: id,
        newStatus: status,
        timestamp: new Date().toISOString()
      });

    } catch (error) {
      await db.query('ROLLBACK');
      throw error;
    }

  } catch (error) {
    console.error('❌ Error reviewing application:', error);
    res.status(500).json({
      success: false,
      error: error.message,
      details: 'Failed to review application'
    });
  }
});

// Alternative review route (from clean version)
adminMembershipRouter.put('/review/:id', async (req, res) => {
  try {
    const { id } = req.params;
    const { status, adminNotes } = req.body;
    
    console.log('🔍 ADMIN: Reviewing application:', { id, status, adminNotes });
    
    // Validate status
    if (!['approved', 'declined', 'suspended'].includes(status)) {
      return res.status(400).json({
        success: false,
        error: 'Invalid status. Must be approved, declined, or suspended'
      });
    }

    // Start transaction
    await db.query('START TRANSACTION');

    try {
      // Update the application
      await db.query(`
        UPDATE full_membership_applications 
        SET 
          status = ?,
          admin_notes = ?,
          reviewedAt = NOW(),
          reviewed_by = ?
        WHERE id = ?
      `, [status, adminNotes || '', req.user?.id || 1, id]);

      // If approved, update user's membership status
      if (status === 'approved') {
        await db.query(`
          UPDATE users 
          SET 
            is_member = 'member',
            membership_stage = 'member',
            full_membership_status = 'approved',
            fullMembershipReviewedAt = NOW()
          WHERE id = (
            SELECT user_id 
            FROM full_membership_applications 
            WHERE id = ?
          )
        `, [id]);

        console.log('✅ User promoted to full member');
      }

      // Commit transaction
      await db.query('COMMIT');

      console.log('✅ Application reviewed successfully');

      res.json({
        success: true,
        message: `Application ${status} successfully`,
        applicationId: id,
        newStatus: status,
        timestamp: new Date().toISOString()
      });

    } catch (error) {
      await db.query('ROLLBACK');
      throw error;
    }

  } catch (error) {
    console.error('❌ Error reviewing application:', error);
    res.status(500).json({
      success: false,
      error: error.message,
      details: 'Failed to review application'
    });
  }
});

// Bulk review applications
adminMembershipRouter.post('/applications/bulk-review', async (req, res) => {
  try {
    const { applicationIds, decision, notes } = req.body;
    
    console.log('🔍 ADMIN: Bulk reviewing applications:', { applicationIds, decision, notes });
    
    // Validate input
    if (!Array.isArray(applicationIds) || applicationIds.length === 0) {
      return res.status(400).json({
        success: false,
        error: 'applicationIds must be a non-empty array'
      });
    }

    if (!['approved', 'declined', 'suspended'].includes(decision)) {
      return res.status(400).json({
        success: false,
        error: 'Invalid decision. Must be approved, declined, or suspended'
      });
    }

    // Start transaction
    await db.query('START TRANSACTION');

    try {
      // Bulk update applications
      const placeholders = applicationIds.map(() => '?').join(',');
      await db.query(`
        UPDATE full_membership_applications 
        SET 
          status = ?,
          admin_notes = ?,
          reviewedAt = NOW(),
          reviewed_by = ?
        WHERE id IN (${placeholders})
      `, [decision, notes || '', req.user?.id || 1, ...applicationIds]);

      // If approved, update users' membership status
      if (decision === 'approved') {
        await db.query(`
          UPDATE users 
          SET 
            is_member = 'member',
            membership_stage = 'member',
            full_membership_status = 'approved',
            fullMembershipReviewedAt = NOW()
          WHERE id IN (
            SELECT user_id 
            FROM full_membership_applications 
            WHERE id IN (${placeholders})
          )
        `, applicationIds);

        console.log(`✅ ${applicationIds.length} users promoted to full members`);
      }

      // Commit transaction
      await db.query('COMMIT');

      console.log('✅ Bulk review completed successfully');

      res.json({
        success: true,
        message: `${applicationIds.length} applications ${decision} successfully`,
        processedCount: applicationIds.length,
        applicationIds: applicationIds,
        decision: decision,
        timestamp: new Date().toISOString()
      });

    } catch (error) {
      await db.query('ROLLBACK');
      throw error;
    }

  } catch (error) {
    console.error('❌ Error in bulk review:', error);
    res.status(500).json({
      success: false,
      error: error.message,
      details: 'Failed to bulk review applications'
    });
  }
});

// Alternative bulk review route (from clean version)
adminMembershipRouter.post('/bulk-review', async (req, res) => {
  try {
    const { applicationIds, decision, notes } = req.body;
    
    console.log('🔍 ADMIN: Bulk reviewing applications:', { applicationIds, decision, notes });
    
    // Validate input
    if (!Array.isArray(applicationIds) || applicationIds.length === 0) {
      return res.status(400).json({
        success: false,
        error: 'applicationIds must be a non-empty array'
      });
    }

    if (!['approved', 'declined', 'suspended'].includes(decision)) {
      return res.status(400).json({
        success: false,
        error: 'Invalid decision. Must be approved, declined, or suspended'
      });
    }

    // Start transaction
    await db.query('START TRANSACTION');

    try {
      // Bulk update applications
      const placeholders = applicationIds.map(() => '?').join(',');
      await db.query(`
        UPDATE full_membership_applications 
        SET 
          status = ?,
          admin_notes = ?,
          reviewedAt = NOW(),
          reviewed_by = ?
        WHERE id IN (${placeholders})
      `, [decision, notes || '', req.user?.id || 1, ...applicationIds]);

      // If approved, update users' membership status
      if (decision === 'approved') {
        await db.query(`
          UPDATE users 
          SET 
            is_member = 'member',
            membership_stage = 'member',
            full_membership_status = 'approved',
            fullMembershipReviewedAt = NOW()
          WHERE id IN (
            SELECT user_id 
            FROM full_membership_applications 
            WHERE id IN (${placeholders})
          )
        `, applicationIds);

        console.log(`✅ ${applicationIds.length} users promoted to full members`);
      }

      // Commit transaction
      await db.query('COMMIT');

      console.log('✅ Bulk review completed successfully');

      res.json({
        success: true,
        message: `${applicationIds.length} applications ${decision} successfully`,
        processedCount: applicationIds.length,
        applicationIds: applicationIds,
        decision: decision,
        timestamp: new Date().toISOString()
      });

    } catch (error) {
      await db.query('ROLLBACK');
      throw error;
    }

  } catch (error) {
    console.error('❌ Error in bulk review:', error);
    res.status(500).json({
      success: false,
      error: error.message,
      details: 'Failed to bulk review applications'
    });
  }
});

// ===============================================
// MEMBERSHIP STATISTICS
// ===============================================

// Get full membership statistics
adminMembershipRouter.get('/stats', async (req, res) => {
  try {
    console.log('🔍 ADMIN: Fetching membership stats');
    
    const stats = await db.query(`
      SELECT 
        status,
        COUNT(*) as count
      FROM full_membership_applications 
      GROUP BY status
    `);

    const result = {
      pending: 0,
      approved: 0,
      declined: 0,
      suspended: 0,
      total: 0
    };

    stats.forEach(stat => {
      result[stat.status] = stat.count;
      result.total += stat.count;
    });

    console.log('✅ Stats result:', result);

    res.json({
      success: true,
      data: result,
      timestamp: new Date().toISOString()
    });

  } catch (error) {
    console.error('❌ Error fetching stats:', error);
    res.status(500).json({
      success: false,
      error: error.message,
      details: 'Failed to fetch membership statistics'
    });
  }
});

// Alternative stats route (from adminRoutes)
adminMembershipRouter.get('/full-membership-stats', async (req, res) => {
  try {
    console.log('🔍 ADMIN: Fetching membership stats');
    
    const stats = await db.query(`
      SELECT 
        status,
        COUNT(*) as count
      FROM full_membership_applications 
      GROUP BY status
    `);

    const result = {
      pending: 0,
      approved: 0,
      declined: 0,
      suspended: 0,
      total: 0
    };

    stats.forEach(stat => {
      result[stat.status] = stat.count;
      result.total += stat.count;
    });

    console.log('✅ Stats result:', result);

    res.json({
      success: true,
      data: result,
      timestamp: new Date().toISOString()
    });

  } catch (error) {
    console.error('❌ Error fetching stats:', error);
    res.status(500).json({
      success: false,
      error: error.message,
      details: 'Failed to fetch membership statistics'
    });
  }
});

// Get pending count (for sidebar badge)
adminMembershipRouter.get('/pending-count', async (req, res) => {
  try {
    console.log('🔍 ADMIN: Getting pending count');
    
    const result = await db.query(`
      SELECT COUNT(*) as count 
      FROM full_membership_applications 
      WHERE status = 'pending'
    `);

    const count = result[0]?.count || 0;
    console.log('✅ Pending count:', count);

    res.json({
      success: true,
      count: count,
      timestamp: new Date().toISOString()
    });

  } catch (error) {
    console.error('❌ Error getting pending count:', error);
    res.status(500).json({
      success: false,
      error: error.message,
      count: 0
    });
  }
});

// ===============================================
// MEMBERSHIP OVERVIEW & ANALYTICS
// ===============================================

// Get membership overview
adminMembershipRouter.get('/overview', async (req, res) => {
  // This would integrate with analytics controller
  res.json({ message: 'Membership overview endpoint - integrate with analyticsController' });
});

// Get membership analytics
adminMembershipRouter.get('/analytics', async (req, res) => {
  // This would integrate with analytics controller
  res.json({ message: 'Membership analytics endpoint - integrate with analyticsController' });
});

// Export membership data
adminMembershipRouter.get('/export', async (req, res) => {
  // This would integrate with analytics controller
  res.json({ message: 'Export membership data endpoint - integrate with analyticsController' });
});

// ===============================================
// ADMIN APPLICATION ROUTES (FROM adminApplicationRoutes)
// ===============================================

// Enhanced admin application management routes
adminMembershipRouter.get('/admin/pending-applications', async (req, res) => {
  try {
    console.log('🔍 ADMIN: Getting pending applications');
    
    const applications = await db.query(`
      SELECT 
        fma.id,
        fma.user_id,
        fma.membership_ticket,
        fma.answers,
        fma.status,
        fma.submittedAt,
        u.username,
        u.email
      FROM full_membership_applications fma
      JOIN users u ON fma.user_id = u.id
      WHERE fma.status = 'pending'
      ORDER BY fma.submittedAt ASC
    `);

    res.json({
      success: true,
      data: applications,
      count: applications.length,
      timestamp: new Date().toISOString()
    });

  } catch (error) {
    console.error('❌ Error getting pending applications:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

adminMembershipRouter.get('/admin/applications', async (req, res) => {
  try {
    console.log('🔍 ADMIN: Getting all applications');
    
    const applications = await db.query(`
      SELECT 
        fma.id,
        fma.user_id,
        fma.membership_ticket,
        fma.answers,
        fma.status,
        fma.submittedAt,
        fma.reviewedAt,
        u.username,
        u.email
      FROM full_membership_applications fma
      JOIN users u ON fma.user_id = u.id
      ORDER BY fma.submittedAt DESC
    `);

    res.json({
      success: true,
      data: applications,
      count: applications.length,
      timestamp: new Date().toISOString()
    });

  } catch (error) {
    console.error('❌ Error getting applications:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

adminMembershipRouter.get('/admin/membership/applications', async (req, res) => {
  try {
    console.log('🔍 ADMIN: Getting membership applications');
    
    const applications = await db.query(`
      SELECT 
        fma.id,
        fma.user_id,
        fma.membership_ticket,
        fma.answers,
        fma.status,
        fma.submittedAt,
        fma.reviewedAt,
        u.username,
        u.email
      FROM full_membership_applications fma
      JOIN users u ON fma.user_id = u.id
      ORDER BY fma.submittedAt DESC
    `);

    res.json({
      success: true,
      data: applications,
      count: applications.length,
      timestamp: new Date().toISOString()
    });

  } catch (error) {
    console.error('❌ Error getting membership applications:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// Review membership application with validation
adminMembershipRouter.put('/admin/membership/review/:applicationId', async (req, res) => {
  try {
    const { applicationId } = req.params;
    const { status, adminNotes } = req.body;
    
    console.log('🔍 ADMIN: Reviewing membership application:', { applicationId, status, adminNotes });
    
    // Validate status
    if (!['approved', 'declined', 'suspended'].includes(status)) {
      return res.status(400).json({
        success: false,
        error: 'Invalid status. Must be approved, declined, or suspended'
      });
    }

    // Start transaction
    await db.query('START TRANSACTION');

    try {
      // Update the application
      await db.query(`
        UPDATE full_membership_applications 
        SET 
          status = ?,
          admin_notes = ?,
          reviewedAt = NOW(),
          reviewed_by = ?
        WHERE id = ?
      `, [status, adminNotes || '', req.user?.id || 1, applicationId]);

      // If approved, update user's membership status
      if (status === 'approved') {
        await db.query(`
          UPDATE users 
          SET 
            is_member = 'member',
            membership_stage = 'member',
            full_membership_status = 'approved',
            fullMembershipReviewedAt = NOW()
          WHERE id = (
            SELECT user_id 
            FROM full_membership_applications 
            WHERE id = ?
          )
        `, [applicationId]);

        console.log('✅ User promoted to full member');
      }

      // Commit transaction
      await db.query('COMMIT');

      console.log('✅ Membership application reviewed successfully');

      res.json({
        success: true,
        message: `Application ${status} successfully`,
        applicationId: applicationId,
        newStatus: status,
        timestamp: new Date().toISOString()
      });

    } catch (error) {
      await db.query('ROLLBACK');
      throw error;
    }

  } catch (error) {
    console.error('❌ Error reviewing membership application:', error);
    res.status(500).json({
      success: false,
      error: error.message,
      details: 'Failed to review membership application'
    });
  }
});

// Application statistics with access control
adminMembershipRouter.get('/admin/applications/stats', async (req, res) => {
  try {
    console.log('🔍 ADMIN: Getting application statistics');
    
    const stats = await db.query(`
      SELECT 
        status,
        COUNT(*) as count,
        AVG(TIMESTAMPDIFF(DAY, submittedAt, reviewedAt)) as avg_review_days
      FROM full_membership_applications 
      GROUP BY status
    `);

    const totalCount = await db.query(`
      SELECT COUNT(*) as total FROM full_membership_applications
    `);

    const recentStats = await db.query(`
      SELECT 
        COUNT(*) as recent_count
      FROM full_membership_applications 
      WHERE submittedAt >= DATE_SUB(NOW(), INTERVAL 30 DAY)
    `);

    res.json({
      success: true,
      data: {
        statusBreakdown: stats,
        totalApplications: totalCount[0].total,
        recentApplications: recentStats[0].recent_count
      },
      timestamp: new Date().toISOString()
    });

  } catch (error) {
    console.error('❌ Error getting application statistics:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// ===============================================
// DEBUG ROUTES (DEVELOPMENT ONLY)
// ===============================================

if (process.env.NODE_ENV === 'development') {
  
  // Test database connectivity
  adminMembershipRouter.get('/debug/test', async (req, res) => {
    try {
      const result = await db.query('SELECT COUNT(*) as count FROM full_membership_applications');
      res.json({
        success: true,
        message: 'Database connection working',
        totalApplications: result[0].count,
        timestamp: new Date().toISOString()
      });
    } catch (error) {
      res.status(500).json({
        success: false,
        error: error.message
      });
    }
  });

  // Get all available routes
  adminMembershipRouter.get('/debug/routes', (req, res) => {
    res.json({
      success: true,
      message: 'Admin membership routes',
      routes: [
        'GET /applications - Get all applications (query: ?status=pending|approved|declined|all)',
        'GET /applications/:id - Get application details',
        'GET /application/:id - Alternative application details route',
        'PUT /applications/:id/review - Review individual application',
        'PUT /review/:id - Alternative review route',
        'POST /applications/bulk-review - Bulk review applications',
        'POST /bulk-review - Alternative bulk review route',
        'GET /stats - Get membership statistics',
        'GET /full-membership-stats - Alternative stats route',
        'GET /pending-count - Get pending applications count',
        'GET /overview - Get membership overview',
        'GET /analytics - Get membership analytics',
        'GET /export - Export membership data',
        'GET /admin/pending-applications - Enhanced pending applications',
        'GET /admin/applications - Enhanced all applications',
        'GET /admin/membership/applications - Enhanced membership applications',
        'PUT /admin/membership/review/:applicationId - Enhanced review with validation',
        'GET /admin/applications/stats - Enhanced application statistics',
        'GET /debug/test - Test database connectivity',
        'GET /debug/routes - This route list'
      ],
      timestamp: new Date().toISOString()
    });
  });
}

// ===============================================
// ERROR HANDLING
// ===============================================

// 404 handler for admin membership routes
adminMembershipRouter.use('*', (req, res) => {
  res.status(404).json({
    success: false,
    error: 'Admin membership route not found',
    path: req.path,
    method: req.method,
    availableRoutes: {
      applications: [
        'GET /applications - Get all applications',
        'GET /applications/:id - Get application details',
        'GET /application/:id - Alternative application details',
        'PUT /applications/:id/review - Review application',
        'PUT /review/:id - Alternative review route',
        'POST /applications/bulk-review - Bulk review applications',
        'POST /bulk-review - Alternative bulk review'
      ],
      statistics: [
        'GET /stats - Get membership statistics',
        'GET /full-membership-stats - Alternative stats',
        'GET /pending-count - Get pending count'
      ],
      analytics: [
        'GET /overview - Get membership overview',
        'GET /analytics - Get membership analytics',
        'GET /export - Export membership data'
      ],
      enhanced: [
        'GET /admin/pending-applications - Enhanced pending applications',
        'GET /admin/applications - Enhanced all applications',
        'GET /admin/membership/applications - Enhanced membership applications',
        'PUT /admin/membership/review/:applicationId - Enhanced review',
        'GET /admin/applications/stats - Enhanced statistics'
      ]
    },
    timestamp: new Date().toISOString()
  });
});

// Global error handler for admin membership routes
adminMembershipRouter.use((error, req, res, next) => {
  console.error('❌ Admin membership route error:', {
    error: error.message,
    stack: error.stack,
    route: req.originalUrl,
    method: req.method,
    user: req.user?.username,
    timestamp: new Date().toISOString()
  });

  res.status(error.status || 500).json({
    success: false,
    message: error.message || 'Internal server error',
    timestamp: new Date().toISOString()
  });
});

if (process.env.NODE_ENV === 'development') {
  console.log('🏛️ Admin membership routes loaded with full membership review capabilities');
  console.log('📊 Total endpoints: 21 (19 production + 2 debug)');
  console.log('🔧 Features: Complete application management, bulk operations, enhanced admin routes');
}

export default adminMembershipRouter;




//======================//============================//

// File: ikootaapi/routes/adminUserRoutes.js
// ADMIN USER ROUTES - ADMIN USER & APPLICATION MANAGEMENT

import express from 'express';
import { authenticate } from '../middlewares/auth.middleware.js';

// Import membership middleware
import { 
  canReviewApplications,
  validateApplicationReview,
  logMembershipAction 
} from '../middlewares/membershipMiddleware.js';

// Import existing middleware
import { 
  requireAdmin, 
  requireSuperAdmin 
} from '../controllers/membershipControllers_1.OLD.js/index.js';

// Import updated controllers
import {
  getAllPendingMembershipApplications,
  reviewMembershipApplication,
  setupDevAdmin,
  getSystemConfig,
  emergencyUserReset,
  getApplicationStats
} from '../controllers/adminApplicationController.js';

// Import existing controller functions
import {
  getPendingApplications,
  updateApplicationStatus,
  bulkApproveApplications,
  approvePreMemberApplication,
  declinePreMemberApplication,
  getAvailableMentors,
  getAvailableClasses,
  testUserLookup
} from '../controllers/membershipControllers.OLD.js';

// Import admin controllers
import {
  getUsers,
  updateUserById,
  updateUser,
  banUser,
  unbanUser,
  manageUsers,
  grantPostingRights,
  deleteUser,
  createUser,
  exportUserData,
  maskUserIdentity
} from '../controllers/adminControllers.js';

import { verifyApplicationStatusConsistency } from '../controllers/membershipControllers_2.OLD.js/index.js';

const adminUserRouter = express.Router();

// ===== BASIC MIDDLEWARE =====
adminUserRouter.use(authenticate);
adminUserRouter.use(requireAdmin);

// ===============================================
// USER MANAGEMENT ROUTES
// ===============================================

// GET /admin/users - Get all users
adminUserRouter.get('/', getUsers);

// PUT /admin/users/:id - Update user by ID
adminUserRouter.put('/:id', updateUserById);

// POST /admin/users/update - Update user
adminUserRouter.post('/update', updateUser);

// POST /admin/users/create - Create new user
adminUserRouter.post('/create', createUser);

// DELETE /admin/users/:id - Delete user (super admin only)
adminUserRouter.delete('/:id', requireSuperAdmin, deleteUser);

// POST /admin/users/ban - Ban user
adminUserRouter.post('/ban', banUser);

// POST /admin/users/unban - Unban user
adminUserRouter.post('/unban', unbanUser);

// POST /admin/users/grant-posting-rights - Grant posting rights
adminUserRouter.post('/grant-posting-rights', grantPostingRights);

// POST /admin/users/mask-identity - Mask user identity
adminUserRouter.post('/mask-identity', maskUserIdentity);

// GET /admin/users/manage - Get all users for management
adminUserRouter.get('/manage', manageUsers);

// POST /admin/users/manage - Bulk user actions
adminUserRouter.post('/manage', manageUsers);

// GET /admin/users/search - Search users
adminUserRouter.get('/search', async (req, res) => {
  // Implement user search functionality
  res.json({ message: 'User search endpoint - implement with search controller' });
});

// GET /admin/users/export - Export user data
adminUserRouter.get('/export', exportUserData);

// ===============================================
// APPLICATION REVIEW ROUTES
// ===============================================

// Get pending applications with middleware protection
adminUserRouter.get('/applications/pending',
  canReviewApplications,
  logMembershipAction('view_pending_applications'),
  getAllPendingMembershipApplications
);

adminUserRouter.get('/applications',
  canReviewApplications,
  logMembershipAction('view_applications'),
  getAllPendingMembershipApplications
);

// Application statistics with access control
adminUserRouter.get('/applications/stats',
  canReviewApplications,
  logMembershipAction('view_application_stats'),
  getApplicationStats
);

// Update application status - Multiple endpoints for compatibility
adminUserRouter.put('/applications/:userId/status', updateApplicationStatus);

// Pre-member specific approval/decline
adminUserRouter.post('/applications/:userId/approve', approvePreMemberApplication);
adminUserRouter.post('/applications/:userId/decline', declinePreMemberApplication);

// Bulk operations
adminUserRouter.post('/applications/bulk-approve', bulkApproveApplications);

// ===============================================
// SYSTEM CONFIGURATION ROUTES
// ===============================================

// System configuration (Admin only)
adminUserRouter.get('/config', getSystemConfig);
adminUserRouter.get('/config/super', requireSuperAdmin, getSystemConfig);

// ===============================================
// SUPER ADMIN ROUTES
// ===============================================

adminUserRouter.post('/super/emergency-reset/:userId', requireSuperAdmin, emergencyUserReset);
adminUserRouter.get('/super/debug/user/:userId', requireSuperAdmin, testUserLookup);

// ===============================================
// DEVELOPMENT ROUTES
// ===============================================

if (process.env.NODE_ENV === 'development') {
  adminUserRouter.post('/dev/setup-admin/:userId', setupDevAdmin);
  adminUserRouter.get('/debug/status-consistency', verifyApplicationStatusConsistency);
  adminUserRouter.get('/test-user-lookup/:userId', testUserLookup);
  adminUserRouter.get('/test-user-lookup', testUserLookup);
}

// ===============================================
// ERROR HANDLING
// ===============================================

// 404 handler for admin user routes
adminUserRouter.use('*', (req, res) => {
  res.status(404).json({
    success: false,
    error: 'Admin user route not found',
    path: req.path,
    method: req.method,
    availableRoutes: {
      users: [
        'GET / - Get all users',
        'PUT /:id - Update user by ID',
        'POST /create - Create new user',
        'DELETE /:id - Delete user (super admin)',
        'POST /ban - Ban user',
        'POST /unban - Unban user',
        'GET /export - Export user data'
      ],
      applications: [
        'GET /applications/pending - Get pending applications',
        'GET /applications/stats - Get application statistics',
        'PUT /applications/:userId/status - Update application status',
        'POST /applications/:userId/approve - Approve application',
        'POST /applications/bulk-approve - Bulk approve applications'
      ],
      system: [
        'GET /config - Get system configuration',
        'GET /config/super - Get super admin configuration'
      ]
    },
    timestamp: new Date().toISOString()
  });
});

// Global error handler for admin user routes
adminUserRouter.use((error, req, res, next) => {
  console.error('❌ Admin user route error:', {
    error: error.message,
    path: req.path,
    method: req.method,
    user: req.user?.username,
    timestamp: new Date().toISOString()
  });
  
  res.status(error.status || 500).json({
    success: false,
    message: error.message || 'Internal server error',
    timestamp: new Date().toISOString()
  });
});

if (process.env.NODE_ENV === 'development') {
  console.log('👨‍💼 Admin user routes loaded with user management and application review');
}

export default adminUserRouter;



//======================//============================//

// ikootaapi/routes/analyticsRoutes.js
// ===============================================
// ANALYTICS AND REPORTING ROUTES
// Handles all analytics, statistics, and data export routes
// ===============================================

import express from 'express';
import { authenticate, cacheMiddleware } from '../middlewares/auth.middleware.js';
import { requireAdmin } from '../controllers/membershipControllers_1.OLD.js/index.js';
import {
  getMembershipAnalytics,
  getMembershipOverview,
  getMembershipStats,
  exportMembershipData
} from '../controllers/analyticsController.js';

const router = express.Router();

// ===============================================
// ANALYTICS & REPORTING ROUTES
// All routes require admin authentication and use caching
// ===============================================

// Main analytics endpoints
router.get('/admin/membership-overview', 
  authenticate, 
  requireAdmin, 
  cacheMiddleware(600), 
  getMembershipOverview
);

router.get('/admin/overview', 
  authenticate, 
  requireAdmin, 
  getMembershipOverview
);

router.get('/admin/applications-overview', 
  authenticate, 
  requireAdmin, 
  getMembershipOverview
);

router.get('/admin/membership-stats', 
  authenticate, 
  requireAdmin, 
  cacheMiddleware(600), 
  getMembershipStats
);

router.get('/admin/stats', 
  authenticate, 
  requireAdmin, 
  getMembershipStats
);

router.get('/admin/analytics', 
  authenticate, 
  requireAdmin, 
  cacheMiddleware(600), 
  getMembershipAnalytics
);

router.get('/admin/membership-analytics', 
  authenticate, 
  requireAdmin, 
  getMembershipAnalytics
);

// Data export routes
router.get('/admin/export-membership-data', 
  authenticate, 
  requireAdmin, 
  exportMembershipData
);

router.get('/admin/export', 
  authenticate, 
  requireAdmin, 
  exportMembershipData
);

export default router;



//======================//============================//

// File: ikootaapi/routes/authRoutes.js
// AUTH ROUTES - CONSOLIDATED AUTHENTICATION

import express from 'express';
import {
  // Enhanced authentication functions from membership
  sendVerificationCode,
  registerWithVerification,
  enhancedLogin,
  logoutUser,
  
  // Existing password reset functions
  requestPasswordReset,
  resetPassword,
  verifyPasswordReset,
  verifyUser,
  getAuthenticatedUser,
} from '../controllers/authControllers.js';
import { authenticate } from '../middlewares/auth.middleware.js';
import { sendEmail } from '../utils/notifications.js';

const authRouter = express.Router();

// ===============================================
// PRIMARY AUTHENTICATION ROUTES (Enhanced versions)
// ===============================================

// Enhanced verification and registration system
authRouter.post('/send-verification', sendVerificationCode);
authRouter.post('/register', registerWithVerification);
authRouter.post('/login', enhancedLogin);
authRouter.get('/logout', logoutUser);

// ===============================================
// PASSWORD RESET ROUTES
// ===============================================

authRouter.post('/passwordreset/request', requestPasswordReset);
authRouter.post('/passwordreset/reset', resetPassword);
authRouter.post('/passwordreset/verify', verifyPasswordReset);

// ===============================================
// USER VERIFICATION ROUTES
// ===============================================

authRouter.get('/verify/:token', verifyUser);

// ===============================================
// AUTHENTICATED USER ROUTES
// ===============================================

authRouter.get('/', authenticate, getAuthenticatedUser);

// ===============================================
// DEVELOPMENT & TESTING ROUTES
// ===============================================

// Simple test route to verify auth routes work
authRouter.get('/test-simple', (req, res) => {
  res.json({
    success: true,
    message: 'Authentication routes are working!',
    timestamp: new Date().toISOString(),
    path: req.path,
    method: req.method
  });
});

// Test route with authentication
authRouter.get('/test-auth', authenticate, (req, res) => {
  res.json({
    success: true,
    message: 'Authentication is working!',
    user: req.user,
    timestamp: new Date().toISOString()
  });
});

// ===== DEVELOPMENT EMAIL TEST ROUTES =====
if (process.env.NODE_ENV === 'development') {
  
  // Test basic email sending
  authRouter.post('/test-email', async (req, res) => {
    try {
      const { email } = req.body;
      
      if (!email) {
        return res.status(400).json({ 
          success: false,
          error: 'Email address required',
          example: { email: 'your-email@gmail.com' }
        });
      }
      
      console.log('🧪 Testing email to:', email);
      
      const result = await sendEmail(email, 'verification_code', {
        VERIFICATION_CODE: '123456',
        EXPIRES_IN: '10 minutes'
      });
      
      res.json({
        success: true,
        message: 'Test email sent successfully',
        result,
        timestamp: new Date().toISOString()
      });
      
    } catch (error) {
      console.error('❌ Test email failed:', error);
      res.status(500).json({
        success: false,
        error: error.message,
        help: 'Check your Gmail App Password configuration',
        instructions: [
          '1. Enable 2FA on Gmail',
          '2. Generate App Password',
          '3. Set MAIL_USER and MAIL_PASS in .env',
          '4. Restart server'
        ]
      });
    }
  });

  // Test email configuration
  authRouter.get('/test-email-config', async (req, res) => {
    try {
      const { testEmailConnection, getEmailConfig } = await import('../utils/email.js');
      
      const config = getEmailConfig();
      const connectionTest = await testEmailConnection();
      
      res.json({
        success: true,
        configuration: config,
        connectionTest,
        timestamp: new Date().toISOString()
      });
      
    } catch (error) {
      console.error('❌ Email config test failed:', error);
      res.status(500).json({
        success: false,
        error: error.message
      });
    }
  });

  // Test all notification services
  authRouter.get('/test-notifications', async (req, res) => {
    try {
      const { testNotificationServices } = await import('../utils/notifications.js');
      
      const results = await testNotificationServices();
      
      res.json({
        success: true,
        services: results,
        timestamp: new Date().toISOString()
      });
      
    } catch (error) {
      console.error('❌ Notification services test failed:', error);
      res.status(500).json({
        success: false,
        error: error.message
      });
    }
  });
}

// ===============================================
// ERROR HANDLING & LOGGING
// ===============================================

// 404 handler for unmatched auth routes
authRouter.use('*', (req, res) => {
  res.status(404).json({
    success: false,
    error: 'Authentication route not found',
    path: req.path,
    method: req.method,
    availableRoutes: {
      primary: [
        'POST /send-verification',
        'POST /register',
        'POST /login',
        'GET /logout'
      ],
      passwordReset: [
        'POST /passwordreset/request',
        'POST /passwordreset/reset',
        'POST /passwordreset/verify'
      ],
      verification: [
        'GET /verify/:token'
      ],
      user: [
        'GET /'
      ],
      testing: [
        'GET /test-simple',
        'GET /test-auth'
      ]
    }
  });
});

// Global error handler for auth routes
authRouter.use((error, req, res, next) => {
  console.error('Authentication route error:', error);
  
  res.status(error.statusCode || 500).json({
    success: false,
    error: error.message || 'Internal server error',
    path: req.path,
    method: req.method,
    timestamp: new Date().toISOString()
  });
});

// Log routes in development
if (process.env.NODE_ENV === 'development') {
  console.log('🔐 Authentication routes loaded:');
  console.log('   Primary Auth: /send-verification, /register, /login, /logout');
  console.log('   Password Reset: /passwordreset/request, /passwordreset/reset, /passwordreset/verify');
  console.log('   User Verification: /verify/:token');
  console.log('   Authenticated User: /');
  console.log('   Test: /test-simple, /test-auth');
}

export default authRouter;





//======================//============================//

//ikootaapi\routes\chatRoutes.js
import express from 'express';
import { uploadMiddleware, uploadToS3 } from '../middlewares/upload.middleware.js';
import {
  fetchAllChats,
  fetchChatsByUserId,
  createChat,
  addCommentToChat,
  getChatHistory,
  editChat,
  removeChat,
  fetchChatsByIds, // New controller function
  fetchChatByPrefixedId, // NEW
  fetchCombinedContent,  // NEW
} from '../controllers/chatControllers.js';
import { authenticate } from '../middlewares/auth.middleware.js';

const router = express.Router();

// Fetch all chats
router.get('/', authenticate, fetchAllChats);

// Fetch chats by user_id
router.get('/user', authenticate, fetchChatsByUserId);

// Fetch chats by IDs
router.get('/ids', authenticate, fetchChatsByIds); // New route

// Create new chat
router.post('/', authenticate, uploadMiddleware, uploadToS3, createChat);

// Add comment to specific chat
router.post('/:chatId/comments', authenticate, uploadMiddleware, uploadToS3, addCommentToChat);

// Get chat history between two users
router.get('/:userId1/:userId2', authenticate, getChatHistory);

// Update a chat by ID
router.put('/:id', authenticate, editChat);

// Delete a chat by ID
router.delete('/:id', authenticate, removeChat);

// NEW routes for prefixed IDs
router.get('/prefixed/:prefixedId', authenticate, fetchChatByPrefixedId);
router.get('/combinedcontent', authenticate, fetchCombinedContent);


export default router;




//======================//============================//

// ikootaapi/routes/classRoutes.js
import express from 'express';
import { getClasses, postClass, putClass, assignUserToClass, getClassContent } from '../controllers/classControllers.js';
import { authenticate } from '../middlewares/auth.middleware.js';


const router = express.Router();

// Fetch all classes
router.get('/', getClasses);

// Create a new class
router.post('/', postClass);

// Update an existing class
router.put('/:id', putClass);

// Assign user to class
router.post('/assign', authenticate, assignUserToClass);

// Get content for a specific class
router.get('/:classId/content', authenticate, getClassContent);

export default router;





//======================//============================//

// ikootaapi/routes/commentRoutes.js
import express from 'express';
import { uploadMiddleware, uploadToS3 } from '../middlewares/upload.middleware.js';
import {
  createComment,
  uploadCommentFiles,
  fetchParentChatsAndTeachingsWithComments,
  fetchCommentsByParentIds,
  fetchCommentsByUserId,
  fetchAllComments,
  fetchCommentStats,
  fetchCommentById,
  updateComment,
  deleteComment
} from '../controllers/commentControllers.js';
import { authenticate } from '../middlewares/auth.middleware.js';

const router = express.Router();

// Routes in order of specificity (most specific first)

// GET /comments/stats - Get comment statistics (admin only)
router.get('/stats', authenticate, fetchCommentStats);

// GET /comments/all - Fetch all comments (admin only)
router.get('/all', authenticate, fetchAllComments);

// GET /comments/parent-comments - Fetch parent chats and teachings with comments
router.get('/parent-comments', authenticate, fetchParentChatsAndTeachingsWithComments);

// GET /comments/comments - Fetch comments using parent IDs (legacy route)
router.get('/comments', authenticate, fetchCommentsByParentIds);

// GET /comments/user/:user_id - Fetch comments by user_id
router.get('/user/:user_id', authenticate, fetchCommentsByUserId);

// POST /comments/upload - Upload files for comments
router.post('/upload', authenticate, uploadMiddleware, uploadToS3, uploadCommentFiles);

// POST /comments - Create a new comment
router.post('/', authenticate, uploadMiddleware, uploadToS3, createComment);

// GET /comments/:commentId - Get specific comment by ID (must be after other GET routes)
router.get('/:commentId', authenticate, fetchCommentById);

// PUT /comments/:commentId - Update a comment
router.put('/:commentId', authenticate, uploadMiddleware, uploadToS3, updateComment);

// DELETE /comments/:commentId - Delete a comment
router.delete('/:commentId', authenticate, deleteComment);

export default router;

//======================//============================//

// 2. COMMUNICATION ROUTES - CHAT & MESSAGING
// File: ikootaapi/routes/communicationRoutes.js
// ===============================================

import express from 'express';
import {
  sendEmailHandler,
  sendSMSHandler,
  sendBulkEmailHandler,
  sendBulkSMSHandler,
  sendNotificationHandler,
  checkCommunicationHealthHandler,
  getCommunicationStatsHandler,
  getAvailableTemplatesHandler
} from '../controllers/communicationControllers.js';
import { authenticate } from '../middlewares/auth.middleware.js';

const communicationRouter = express.Router();

// ===============================================
// COMMUNICATION SETTINGS & UTILITIES
// ===============================================

// GET /communication/settings - Get communication settings
communicationRouter.get('/settings', authenticate, async (req, res) => {
  // This would integrate with user communication settings
  res.json({ message: 'Communication settings endpoint - implement with settings controller' });
});

// PUT /communication/settings - Update communication settings
communicationRouter.put('/settings', authenticate, async (req, res) => {
  // This would integrate with user communication settings
  res.json({ message: 'Update communication settings endpoint - implement with settings controller' });
});

// GET /communication/notifications - Get notification preferences
communicationRouter.get('/notifications', authenticate, async (req, res) => {
  // This would integrate with notification preferences
  res.json({ message: 'Notification preferences endpoint - implement with preferences controller' });
});

// PUT /communication/notifications - Update notification preferences
communicationRouter.put('/notifications', authenticate, async (req, res) => {
  // This would integrate with notification preferences
  res.json({ message: 'Update notification preferences endpoint - implement with preferences controller' });
});

// ===============================================
// EMAIL SERVICES
// ===============================================

// POST /communication/email/send - Send single email
communicationRouter.post('/email/send', authenticate, sendEmailHandler);

// POST /communication/email/bulk - Send bulk emails (admin only)
communicationRouter.post('/email/bulk', authenticate, sendBulkEmailHandler);

// ===============================================
// SMS SERVICES
// ===============================================

// POST /communication/sms/send - Send single SMS
communicationRouter.post('/sms/send', authenticate, sendSMSHandler);

// POST /communication/sms/bulk - Send bulk SMS (admin only)
communicationRouter.post('/sms/bulk', authenticate, sendBulkSMSHandler);

// ===============================================
// COMBINED NOTIFICATIONS
// ===============================================

// POST /communication/notification - Send combined notification (email + SMS)
communicationRouter.post('/notification', authenticate, sendNotificationHandler);

// ===============================================
// COMMUNICATION MANAGEMENT
// ===============================================

// GET /communication/templates - Get available email and SMS templates
communicationRouter.get('/templates', authenticate, getAvailableTemplatesHandler);

// GET /communication/health - Check communication services health (admin only)
communicationRouter.get('/health', authenticate, checkCommunicationHealthHandler);

// GET /communication/stats - Get communication statistics (admin only)
communicationRouter.get('/stats', authenticate, getCommunicationStatsHandler);

// ===============================================
// CHAT ROOM MANAGEMENT
// ===============================================

// GET /communication/rooms - Get chat rooms
communicationRouter.get('/rooms', authenticate, async (req, res) => {
  // This would integrate with chat room controller
  res.json({ message: 'Chat rooms endpoint - implement with chat room controller' });
});

// POST /communication/rooms - Create chat room
communicationRouter.post('/rooms', authenticate, async (req, res) => {
  // This would integrate with chat room controller
  res.json({ message: 'Create chat room endpoint - implement with chat room controller' });
});

// GET /communication/rooms/:id/messages - Get chat room messages
communicationRouter.get('/rooms/:id/messages', authenticate, async (req, res) => {
  // This would integrate with chat room messages controller
  res.json({ message: 'Chat room messages endpoint - implement with chat room controller' });
});

// POST /communication/rooms/:id/messages - Send message to chat room
communicationRouter.post('/rooms/:id/messages', authenticate, async (req, res) => {
  // This would integrate with chat room messages controller
  res.json({ message: 'Send chat room message endpoint - implement with chat room controller' });
});

// PUT /communication/rooms/:id/messages/:messageId - Update chat room message
communicationRouter.put('/rooms/:id/messages/:messageId', authenticate, async (req, res) => {
  // This would integrate with chat room messages controller
  res.json({ message: 'Update chat room message endpoint - implement with chat room controller' });
});

// DELETE /communication/rooms/:id/messages/:messageId - Delete chat room message
communicationRouter.delete('/rooms/:id/messages/:messageId', authenticate, async (req, res) => {
  // This would integrate with chat room messages controller
  res.json({ message: 'Delete chat room message endpoint - implement with chat room controller' });
});

// ===============================================
// DIRECT MESSAGING
// ===============================================

// GET /communication/conversations - Get conversations
communicationRouter.get('/conversations', authenticate, async (req, res) => {
  // This would integrate with direct messaging controller
  res.json({ message: 'Conversations endpoint - implement with messaging controller' });
});

// POST /communication/conversations - Create conversation
communicationRouter.post('/conversations', authenticate, async (req, res) => {
  // This would integrate with direct messaging controller
  res.json({ message: 'Create conversation endpoint - implement with messaging controller' });
});

// GET /communication/conversations/:id - Get specific conversation
communicationRouter.get('/conversations/:id', authenticate, async (req, res) => {
  // This would integrate with direct messaging controller
  res.json({ message: 'Get conversation endpoint - implement with messaging controller' });
});

// POST /communication/conversations/:id/messages - Send message in conversation
communicationRouter.post('/conversations/:id/messages', authenticate, async (req, res) => {
  // This would integrate with direct messaging controller
  res.json({ message: 'Send conversation message endpoint - implement with messaging controller' });
});

// ===============================================
// LEGACY COMPATIBILITY
// ===============================================

// Legacy route support for backward compatibility
communicationRouter.post('/send', authenticate, sendEmailHandler);

// ===============================================
// ERROR HANDLING
// ===============================================

// 404 handler for communication routes
communicationRouter.use('*', (req, res) => {
  res.status(404).json({
    success: false,
    error: 'Communication route not found',
    path: req.path,
    method: req.method,
    availableRoutes: {
      settings: [
        'GET /settings - Get communication settings',
        'PUT /settings - Update communication settings',
        'GET /notifications - Get notification preferences',
        'PUT /notifications - Update notification preferences'
      ],
      email: [
        'POST /email/send - Send single email',
        'POST /email/bulk - Send bulk emails (admin)'
      ],
      sms: [
        'POST /sms/send - Send single SMS',
        'POST /sms/bulk - Send bulk SMS (admin)'
      ],
      notifications: [
        'POST /notification - Send combined notification'
      ],
      management: [
        'GET /templates - Get available templates',
        'GET /health - Check service health (admin)',
        'GET /stats - Get communication statistics (admin)'
      ],
      chatRooms: [
        'GET /rooms - Get chat rooms',
        'POST /rooms - Create chat room',
        'GET /rooms/:id/messages - Get room messages',
        'POST /rooms/:id/messages - Send room message'
      ],
      directMessaging: [
        'GET /conversations - Get conversations',
        'POST /conversations - Create conversation',
        'GET /conversations/:id - Get specific conversation',
        'POST /conversations/:id/messages - Send message'
      ]
    },
    timestamp: new Date().toISOString()
  });
});

// Global error handler for communication routes
communicationRouter.use((error, req, res, next) => {
  console.error('❌ Communication route error:', error);
  
  res.status(error.statusCode || 500).json({
    success: false,
    error: error.message || 'Internal server error',
    path: req.path,
    method: req.method,
    timestamp: new Date().toISOString()
  });
});

if (process.env.NODE_ENV === 'development') {
  console.log('💬 Communication routes loaded with email, SMS, chat rooms, and messaging');
}

export default communicationRouter;



//======================//============================//

// 1. CONTENT ROUTES - COMMUNITY CONTENT MANAGEMENT
// File: ikootaapi/routes/contentRoutes.js
// ===============================================

import express from 'express';
import { uploadMiddleware, uploadToS3 } from '../middlewares/upload.middleware.js';
import { authenticate, cacheMiddleware } from '../middlewares/auth.middleware.js';

// Import teachings controllers
import {
  createTeaching,
  fetchAllTeachings,
  fetchTeachingsByUserId,
  editTeaching,
  removeTeaching,
  fetchTeachingsByIds,
  fetchTeachingByPrefixedId,
  searchTeachingsController,
  fetchTeachingStats,
} from '../controllers/teachingsControllers.js';

// Import chat controllers
import {
  fetchAllChats,
  fetchChatsByUserId,
  createChat,
  addCommentToChat,
  getChatHistory,
  editChat,
  removeChat,
  fetchChatsByIds,
  fetchChatByPrefixedId,
  fetchCombinedContent,
} from '../controllers/chatControllers.js';

// Import comment controllers
import {
  createComment,
  uploadCommentFiles,
  fetchParentChatsAndTeachingsWithComments,
  fetchCommentsByParentIds,
  fetchCommentsByUserId,
  fetchAllComments,
  fetchCommentStats,
  fetchCommentById,
  updateComment,
  deleteComment
} from '../controllers/commentControllers.js';

// Import class controllers
import {
  getClasses,
  postClass,
  putClass,
  assignUserToClass,
  getClassContent
} from '../controllers/classControllers.js';

const contentRouter = express.Router();

// ===============================================
// TEACHINGS/CONTENT ROUTES
// ===============================================

// GET /content/teachings - Fetch all teachings with optional pagination and filtering
contentRouter.get('/teachings', authenticate, fetchAllTeachings);

// GET /content/teachings/search - Search teachings (dedicated search endpoint)
contentRouter.get('/teachings/search', authenticate, cacheMiddleware(120), searchTeachingsController);

// GET /content/teachings/stats - Get teaching statistics
contentRouter.get('/teachings/stats', authenticate, cacheMiddleware(120), fetchTeachingStats);

// GET /content/teachings/user - Fetch teachings by user_id
contentRouter.get('/teachings/user', authenticate, fetchTeachingsByUserId);

// GET /content/teachings/ids - Fetch teachings by multiple IDs
contentRouter.get('/teachings/ids', authenticate, fetchTeachingsByIds);

// GET /content/teachings/prefixed/:prefixedId - Fetch teaching by prefixed ID or numeric ID
contentRouter.get('/teachings/prefixed/:prefixedId', authenticate, fetchTeachingByPrefixedId);

// GET /content/teachings/:id - Fetch single teaching by ID (alternative endpoint)
contentRouter.get('/teachings/:id', authenticate, fetchTeachingByPrefixedId);

// POST /content/teachings - Create a new teaching
contentRouter.post('/teachings', authenticate, uploadMiddleware, uploadToS3, createTeaching);

// PUT /content/teachings/:id - Update a teaching by ID
contentRouter.put('/teachings/:id', authenticate, uploadMiddleware, uploadToS3, editTeaching);

// DELETE /content/teachings/:id - Delete a teaching by ID
contentRouter.delete('/teachings/:id', authenticate, removeTeaching);

// ===============================================
// CHAT ROUTES
// ===============================================

// GET /content/chats - Fetch all chats
contentRouter.get('/chats', authenticate, fetchAllChats);

// GET /content/chats/user - Fetch chats by user_id
contentRouter.get('/chats/user', authenticate, fetchChatsByUserId);

// GET /content/chats/ids - Fetch chats by IDs
contentRouter.get('/chats/ids', authenticate, fetchChatsByIds);

// GET /content/chats/prefixed/:prefixedId - NEW routes for prefixed IDs
contentRouter.get('/chats/prefixed/:prefixedId', authenticate, fetchChatByPrefixedId);

// GET /content/chats/combinedcontent - Combined content endpoint
contentRouter.get('/chats/combinedcontent', authenticate, fetchCombinedContent);

// GET /content/chats/:userId1/:userId2 - Get chat history between two users
contentRouter.get('/chats/:userId1/:userId2', authenticate, getChatHistory);

// POST /content/chats - Create new chat
contentRouter.post('/chats', authenticate, uploadMiddleware, uploadToS3, createChat);

// POST /content/chats/:chatId/comments - Add comment to specific chat
contentRouter.post('/chats/:chatId/comments', authenticate, uploadMiddleware, uploadToS3, addCommentToChat);

// PUT /content/chats/:id - Update a chat by ID
contentRouter.put('/chats/:id', authenticate, editChat);

// DELETE /content/chats/:id - Delete a chat by ID
contentRouter.delete('/chats/:id', authenticate, removeChat);

// ===============================================
// COMMENTS ROUTES
// ===============================================

// GET /content/comments/stats - Get comment statistics (admin only)
contentRouter.get('/comments/stats', authenticate, fetchCommentStats);

// GET /content/comments/all - Fetch all comments (admin only)
contentRouter.get('/comments/all', authenticate, fetchAllComments);

// GET /content/comments/parent-comments - Fetch parent chats and teachings with comments
contentRouter.get('/comments/parent-comments', authenticate, fetchParentChatsAndTeachingsWithComments);

// GET /content/comments/comments - Fetch comments using parent IDs (legacy route)
contentRouter.get('/comments/comments', authenticate, fetchCommentsByParentIds);

// GET /content/comments/user/:user_id - Fetch comments by user_id
contentRouter.get('/comments/user/:user_id', authenticate, fetchCommentsByUserId);

// POST /content/comments/upload - Upload files for comments
contentRouter.post('/comments/upload', authenticate, uploadMiddleware, uploadToS3, uploadCommentFiles);

// POST /content/comments - Create a new comment
contentRouter.post('/comments', authenticate, uploadMiddleware, uploadToS3, createComment);

// GET /content/comments/:commentId - Get specific comment by ID (must be after other GET routes)
contentRouter.get('/comments/:commentId', authenticate, fetchCommentById);

// PUT /content/comments/:commentId - Update a comment
contentRouter.put('/comments/:commentId', authenticate, uploadMiddleware, uploadToS3, updateComment);

// DELETE /content/comments/:commentId - Delete a comment
contentRouter.delete('/comments/:commentId', authenticate, deleteComment);

// ===============================================
// CLASSES ROUTES
// ===============================================

// GET /content/classes - Fetch all classes
contentRouter.get('/classes', getClasses);

// POST /content/classes - Create a new class
contentRouter.post('/classes', postClass);

// PUT /content/classes/:id - Update an existing class
contentRouter.put('/classes/:id', putClass);

// POST /content/classes/assign - Assign user to class
contentRouter.post('/classes/assign', authenticate, assignUserToClass);

// GET /content/classes/:classId/content - Get content for a specific class
contentRouter.get('/classes/:classId/content', authenticate, getClassContent);

// GET /content/classes/:classId/participants - Get class participants
contentRouter.get('/classes/:classId/participants', authenticate, async (req, res) => {
  // This would integrate with class participant controller
  res.json({ message: 'Class participants endpoint - implement with class controller' });
});

// POST /content/classes/:id/join - Join a class
contentRouter.post('/classes/:id/join', authenticate, async (req, res) => {
  // This would integrate with class joining controller
  res.json({ message: 'Join class endpoint - implement with class controller' });
});

// POST /content/classes/:id/leave - Leave a class
contentRouter.post('/classes/:id/leave', authenticate, async (req, res) => {
  // This would integrate with class leaving controller
  res.json({ message: 'Leave class endpoint - implement with class controller' });
});

// ===============================================
// CONTENT CATEGORIES ROUTES
// ===============================================

// GET /content/categories - Get all content categories
contentRouter.get('/categories', authenticate, async (req, res) => {
  // This would integrate with categories controller
  res.json({ message: 'Content categories endpoint - implement with categories controller' });
});

// GET /content/teachings/categories - Get teaching categories (alias)
contentRouter.get('/teachings/categories', authenticate, async (req, res) => {
  // This would integrate with categories controller
  res.json({ message: 'Teaching categories endpoint - implement with categories controller' });
});

// ===============================================
// CONTENT INTERACTION ROUTES
// ===============================================

// POST /content/comments/:id/like - Like a comment
contentRouter.post('/comments/:id/like', authenticate, async (req, res) => {
  // This would integrate with like/reaction controller
  res.json({ message: 'Like comment endpoint - implement with reaction controller' });
});

// ===============================================
// ERROR HANDLING
// ===============================================

// Enhanced 404 handler for content routes
contentRouter.use('*', (req, res) => {
  console.warn(`❌ 404 - Content route not found: ${req.method} ${req.path}`);
  
  res.status(404).json({
    success: false,
    error: 'Content route not found',
    path: req.path,
    method: req.method,
    availableEndpoints: {
      teachings: [
        'GET /teachings - Get all teachings',
        'GET /teachings/search - Search teachings',
        'GET /teachings/stats - Get teaching statistics',
        'POST /teachings - Create new teaching',
        'PUT /teachings/:id - Update teaching',
        'DELETE /teachings/:id - Delete teaching'
      ],
      chats: [
        'GET /chats - Get all chats',
        'GET /chats/user - Get user chats',
        'POST /chats - Create new chat',
        'PUT /chats/:id - Update chat',
        'DELETE /chats/:id - Delete chat'
      ],
      comments: [
        'GET /comments/all - Get all comments',
        'GET /comments/stats - Get comment statistics',
        'POST /comments - Create new comment',
        'PUT /comments/:id - Update comment',
        'DELETE /comments/:id - Delete comment'
      ],
      classes: [
        'GET /classes - Get all classes',
        'POST /classes - Create new class',
        'PUT /classes/:id - Update class',
        'POST /classes/assign - Assign user to class',
        'POST /classes/:id/join - Join class'
      ]
    },
    timestamp: new Date().toISOString()
  });
});

// Enhanced global error handler for content routes
contentRouter.use((error, req, res, next) => {
  const errorId = Date.now().toString(36) + Math.random().toString(36).substr(2);
  
  console.error('❌ Content route error:', {
    errorId,
    error: error.message,
    path: req.path,
    method: req.method,
    user: req.user?.id || 'not authenticated',
    timestamp: new Date().toISOString()
  });
  
  res.status(error.statusCode || 500).json({
    success: false,
    error: error.message || 'Internal server error',
    errorId,
    path: req.path,
    method: req.method,
    timestamp: new Date().toISOString()
  });
});

if (process.env.NODE_ENV === 'development') {
  console.log('📚 Content routes loaded with teachings, chats, comments, and classes');
}

export default contentRouter;


//======================//============================//

// File: ikootaapi/routes/identityRoutes.js
// 3. IDENTITY ROUTES - IDENTITY VERIFICATION & MANAGEMENT

import express from 'express';
import { 
    maskUserIdentity, 
    unmaskUserIdentity, 
    getClassMembers, 
    getMentees 
} from '../controllers/identityController.js';
import { authenticate, requireSuperAdmin, requireAdmin } from '../middlewares/auth.middleware.js';

const identityRouter = express.Router();

// ===============================================
// IDENTITY VERIFICATION ROUTES
// ===============================================

// POST /identity/verify - Start identity verification process
identityRouter.post('/verify', authenticate, async (req, res) => {
  // This would integrate with identity verification service
  res.json({ message: 'Identity verification endpoint - implement with verification service' });
});

// GET /identity/status - Get identity verification status
identityRouter.get('/status', authenticate, async (req, res) => {
  // This would integrate with identity verification status
  res.json({ message: 'Identity verification status endpoint - implement with verification service' });
});

// POST /identity/documents/upload - Upload identity documents
identityRouter.post('/documents/upload', authenticate, async (req, res) => {
  // This would integrate with document upload service
  res.json({ message: 'Document upload endpoint - implement with document service' });
});

// GET /identity/documents - Get uploaded documents
identityRouter.get('/documents', authenticate, async (req, res) => {
  // This would integrate with document retrieval service
  res.json({ message: 'Get documents endpoint - implement with document service' });
});

// DELETE /identity/documents/:id - Delete uploaded document
identityRouter.delete('/documents/:id', authenticate, async (req, res) => {
  // This would integrate with document deletion service
  res.json({ message: 'Delete document endpoint - implement with document service' });
});

// ===============================================
// IDENTITY MANAGEMENT ROUTES
// ===============================================

// PUT /identity/update - Update identity information
identityRouter.put('/update', authenticate, async (req, res) => {
  // This would integrate with identity update service
  res.json({ message: 'Update identity endpoint - implement with identity service' });
});

// GET /identity/verification-requirements - Get verification requirements
identityRouter.get('/verification-requirements', authenticate, async (req, res) => {
  // This would integrate with verification requirements service
  res.json({ message: 'Verification requirements endpoint - implement with requirements service' });
});

// POST /identity/re-verify - Re-verify identity
identityRouter.post('/re-verify', authenticate, async (req, res) => {
  // This would integrate with re-verification service
  res.json({ message: 'Re-verify identity endpoint - implement with verification service' });
});

// ===============================================
// ADMIN IDENTITY MANAGEMENT ROUTES
// ===============================================

// POST /identity/mask-identity - Mask user identity (admin only)
identityRouter.post('/mask-identity', authenticate, requireAdmin, maskUserIdentity);

// POST /identity/unmask-identity - Unmask user identity (super admin only)
identityRouter.post('/unmask-identity', authenticate, requireSuperAdmin, unmaskUserIdentity);

// ===============================================
// CLASS & MENTOR IDENTITY ROUTES
// ===============================================

// GET /identity/class/:classId/members - Get class members
identityRouter.get('/class/:classId/members', authenticate, getClassMembers);

// GET /identity/mentor/:mentorConverseId/mentees - Get mentees for a mentor
identityRouter.get('/mentor/:mentorConverseId/mentees', authenticate, getMentees);

// ===============================================
// PRIVACY & ANONYMIZATION ROUTES
// ===============================================

// POST /identity/anonymize - Anonymize user data
identityRouter.post('/anonymize', authenticate, async (req, res) => {
  // This would integrate with data anonymization service
  res.json({ message: 'Anonymize data endpoint - implement with anonymization service' });
});

// GET /identity/privacy-settings - Get privacy settings
identityRouter.get('/privacy-settings', authenticate, async (req, res) => {
  // This would integrate with privacy settings service
  res.json({ message: 'Privacy settings endpoint - implement with privacy service' });
});

// PUT /identity/privacy-settings - Update privacy settings
identityRouter.put('/privacy-settings', authenticate, async (req, res) => {
  // This would integrate with privacy settings service
  res.json({ message: 'Update privacy settings endpoint - implement with privacy service' });
});

// ===============================================
// ERROR HANDLING
// ===============================================

// 404 handler for identity routes
identityRouter.use('*', (req, res) => {
  res.status(404).json({
    success: false,
    error: 'Identity route not found',
    path: req.path,
    method: req.method,
    availableRoutes: {
      verification: [
        'POST /verify - Start identity verification',
        'GET /status - Get verification status',
        'POST /documents/upload - Upload documents',
        'GET /documents - Get documents',
        'DELETE /documents/:id - Delete document'
      ],
      management: [
        'PUT /update - Update identity information',
        'GET /verification-requirements - Get requirements',
        'POST /re-verify - Re-verify identity'
      ],
      admin: [
        'POST /mask-identity - Mask user identity (admin)',
        'POST /unmask-identity - Unmask user identity (super admin)'
      ],
      classAndMentor: [
        'GET /class/:classId/members - Get class members',
        'GET /mentor/:mentorConverseId/mentees - Get mentees'
      ],
      privacy: [
        'POST /anonymize - Anonymize user data',
        'GET /privacy-settings - Get privacy settings',
        'PUT /privacy-settings - Update privacy settings'
      ]
    },
    timestamp: new Date().toISOString()
  });
});

// Global error handler for identity routes
identityRouter.use((error, req, res, next) => {
  console.error('❌ Identity route error:', error);
  
  res.status(error.statusCode || 500).json({
    success: false,
    error: error.message || 'Internal server error',
    path: req.path,
    method: req.method,
    timestamp: new Date().toISOString()
  });
});

if (process.env.NODE_ENV === 'development') {
  console.log('🆔 Identity routes loaded with verification, management, and privacy features');
}

export default identityRouter;


//======================//============================//

// File: ikootaapi/routes/membershipApplicationRoutes.js
// MEMBERSHIP APPLICATION ROUTES - CONSOLIDATED

import express from 'express';
import { authenticate, cacheMiddleware } from '../middlewares/auth.middleware.js';

// Import membership-specific middleware
import { 
  canApplyForMembership, 
  validateMembershipApplication,
  rateLimitApplications,
  logMembershipAction,
  requirePreMemberOrHigher
} from '../middlewares/membershipMiddleware.js';

// Import core utilities
import { 
  requireAdmin, 
  requireSuperAdmin,
  validateRequest 
} from '../controllers/membershipCore.js';

// Import pre-member application functions
import {
  getUserDashboard,
  checkApplicationStatus,
  getCurrentMembershipStatus,
  submitInitialApplication,
  updateApplicationAnswers,
  updateInitialApplication,
  withdrawApplication,
  getApplicationRequirements,
  getApplicationHistory,
  getUserPermissions,
  verifyApplicationStatusConsistency
} from '../controllers/preMemberApplicationController.js';

// Import user status functions
import {
  checkSurveyStatus,
  getBasicProfile,
  getLegacyMembershipStatus,
  getUserStatus
} from '../controllers/userStatusController.js';

// Import full membership functions
import {
  getFullMembershipStatusById,
  submitFullMembershipApplication,
  reapplyFullMembership,
  logFullMembershipAccess
} from '../controllers/fullMembershipController.js';

// Import existing controller functions for compatibility
import { getFullMembershipStatus } from '../controllers/membershipControllers_2.OLD.js/index.js';

const membershipApplicationRouter = express.Router();

// ===============================================
// MIDDLEWARE CHAINS FOR REUSE
// ===============================================

// Basic protected route (authenticated + logging)
const basicProtected = [
  authenticate,
  logMembershipAction('access_membership_content')
];

// Status check route (authenticated + pre-member access + logging)
const statusCheck = [
  authenticate,
  requirePreMemberOrHigher,
  logMembershipAction('check_membership_status')
];

// Application submission (full protection)
const applicationSubmission = [
  authenticate,
  rateLimitApplications,           // Prevent spam
  canApplyForMembership,           // Check eligibility
  validateMembershipApplication,   // Validate input
  logMembershipAction('submit_membership_application')
];

// Reapplication (similar to submission but different logging)
const reapplication = [
  authenticate,
  rateLimitApplications,
  canApplyForMembership,
  validateMembershipApplication,
  logMembershipAction('reapply_membership_application')
];

// ===============================================
// USER DASHBOARD & STATUS ROUTES
// ===============================================

// Primary dashboard
membershipApplicationRouter.get('/dashboard', authenticate, getUserDashboard);

// Status checking routes - Multiple endpoints for compatibility
membershipApplicationRouter.get('/status', authenticate, getCurrentMembershipStatus);
membershipApplicationRouter.get('/application/status', authenticate, checkApplicationStatus);
membershipApplicationRouter.get('/survey/check-status', authenticate, checkSurveyStatus);

// Legacy compatibility endpoints
membershipApplicationRouter.get('/membership/status', authenticate, getLegacyMembershipStatus);
membershipApplicationRouter.get('/user/status', authenticate, getUserStatus);

// User profile and permissions
membershipApplicationRouter.get('/profile/basic', authenticate, getBasicProfile);
membershipApplicationRouter.get('/permissions', authenticate, getUserPermissions);
membershipApplicationRouter.get('/application-history', authenticate, getApplicationHistory);
membershipApplicationRouter.get('/history', authenticate, getApplicationHistory);

// ===============================================
// INITIAL APPLICATION ROUTES (PRE-MEMBER)
// ===============================================

// Submit initial application - Multiple endpoints for compatibility
membershipApplicationRouter.post('/application/submit', authenticate, submitInitialApplication);
membershipApplicationRouter.post('/application', authenticate, submitInitialApplication);
membershipApplicationRouter.post('/submit-initial-application', authenticate, submitInitialApplication);

// Application management
membershipApplicationRouter.put('/application/update', authenticate, updateInitialApplication);
membershipApplicationRouter.put('/application/update-answers', authenticate, updateApplicationAnswers);
membershipApplicationRouter.put('/application/answers', authenticate, updateApplicationAnswers);

// Application control
membershipApplicationRouter.post('/application/withdraw', authenticate, withdrawApplication);
membershipApplicationRouter.delete('/application', authenticate, withdrawApplication);

// Application information
membershipApplicationRouter.get('/application/requirements', authenticate, getApplicationRequirements);
membershipApplicationRouter.get('/application/info', authenticate, getApplicationRequirements);
membershipApplicationRouter.get('/application-requirements', authenticate, getApplicationRequirements);

// Validated application routes with input validation
membershipApplicationRouter.put('/application/answers/validated',
  authenticate,
  validateRequest(['answers']),
  updateApplicationAnswers
);

membershipApplicationRouter.post('/application/withdraw/validated',
  authenticate,
  validateRequest(['reason']),
  withdrawApplication
);

// ===============================================
// FULL MEMBERSHIP APPLICATION ROUTES
// ===============================================

// Get full membership status - Multiple endpoints for compatibility
membershipApplicationRouter.get('/full-membership/status/:userId', ...statusCheck, getFullMembershipStatusById);
membershipApplicationRouter.get('/full-membership/status', ...statusCheck, getFullMembershipStatus);
membershipApplicationRouter.get('/full-membership-status', ...statusCheck, getFullMembershipStatus);

// Submit full membership application - Primary endpoint with full protection
membershipApplicationRouter.post('/full-membership/submit', ...applicationSubmission, submitFullMembershipApplication);
membershipApplicationRouter.post('/full-membership/apply', ...applicationSubmission, submitFullMembershipApplication);
membershipApplicationRouter.post('/submit-full-membership', ...applicationSubmission, submitFullMembershipApplication);

// Reapplication for declined applications
membershipApplicationRouter.post('/full-membership/reapply', ...reapplication, reapplyFullMembership);

// Access logging routes
membershipApplicationRouter.post('/full-membership/access-log', ...basicProtected, logFullMembershipAccess);

// Enhanced status endpoints
membershipApplicationRouter.get('/full-membership/detailed-status', 
  authenticate,
  requirePreMemberOrHigher,
  logMembershipAction('check_detailed_membership_status'),
  getFullMembershipStatus
);

// Quick status check (minimal logging for frequent calls)
membershipApplicationRouter.get('/full-membership/quick-status', authenticate, getFullMembershipStatus);

// ===============================================
// APPLICATION SUPPORT ROUTES
// ===============================================

// Get available mentors and classes
membershipApplicationRouter.get('/mentors/available', authenticate, async (req, res) => {
  // This would call the mentor controller
  res.json({ message: 'Available mentors endpoint - implement with mentor controller' });
});

membershipApplicationRouter.get('/classes/available', authenticate, async (req, res) => {
  // This would call the classes controller
  res.json({ message: 'Available classes endpoint - implement with classes controller' });
});

// ===============================================
// DEBUG ROUTES (DEVELOPMENT ONLY)
// ===============================================

if (process.env.NODE_ENV === 'development') {
  membershipApplicationRouter.get('/debug/status-consistency', authenticate, verifyApplicationStatusConsistency);
}

// ===============================================
// ERROR HANDLING
// ===============================================

// Enhanced 404 handler for membership application routes
membershipApplicationRouter.use('*', (req, res) => {
  console.warn(`❌ 404 - Membership application route not found: ${req.method} ${req.path}`);
  
  res.status(404).json({
    success: false,
    error: 'Membership application route not found',
    path: req.path,
    method: req.method,
    availableEndpoints: {
      dashboard: [
        'GET /dashboard - User dashboard with comprehensive status',
        'GET /status - Current membership status',
        'GET /application/status - Application status check',
        'GET /survey/check-status - Survey status check'
      ],
      initialApplication: [
        'POST /application/submit - Submit initial application',
        'PUT /application/update - Update application',
        'PUT /application/answers - Update application answers',
        'POST /application/withdraw - Withdraw application',
        'GET /application/requirements - Get requirements'
      ],
      fullMembership: [
        'GET /full-membership/status - Get full membership status',
        'POST /full-membership/submit - Submit full membership application',
        'POST /full-membership/reapply - Reapply for full membership',
        'POST /full-membership/access-log - Log access'
      ],
      support: [
        'GET /mentors/available - Get available mentors',
        'GET /classes/available - Get available classes'
      ]
    },
    timestamp: new Date().toISOString()
  });
});

// Enhanced global error handler
membershipApplicationRouter.use((error, req, res, next) => {
  const errorId = Date.now().toString(36) + Math.random().toString(36).substr(2);
  
  console.error('❌ Membership application route error:', {
    errorId,
    error: error.message,
    path: req.path,
    method: req.method,
    user: req.user?.id || 'not authenticated',
    timestamp: new Date().toISOString()
  });
  
  res.status(error.statusCode || 500).json({
    success: false,
    error: error.message || 'Internal server error',
    errorId,
    path: req.path,
    method: req.method,
    timestamp: new Date().toISOString()
  });
});

if (process.env.NODE_ENV === 'development') {
  console.log('📋 Membership application routes loaded with full workflow support');
}

export default membershipApplicationRouter;


//======================//============================//

// ikootaapi/routes/membershipRoutes.js
// ===============================================
// MAIN MEMBERSHIP ROUTES - COMPLETE MODULAR ARCHITECTURE
// Imports from the 4 new modular controllers
// ===============================================

import express from 'express';
import { authenticate, cacheMiddleware } from '../middlewares/auth.middleware.js';

// ===============================================
// IMPORT FROM NEW MODULAR CONTROLLERS
// ===============================================

// Core utilities and middleware
import { 
  requireAdmin, 
  requireSuperAdmin,
  validateRequest 
} from '../controllers/membershipCore.js';

// Pre-member application functions
import {
  getUserDashboard,
  checkApplicationStatus,
  getCurrentMembershipStatus,
  submitInitialApplication,
  updateApplicationAnswers,
  updateInitialApplication,
  withdrawApplication,
  getApplicationRequirements,
  getApplicationHistory,
  getUserPermissions,
  verifyApplicationStatusConsistency
} from '../controllers/preMemberApplicationController.js';

import {checkSurveyStatus} from '../controllers/userStatusController.js';

// Admin management functions
import {
  approvePreMemberApplication,
  declinePreMemberApplication,
  getPendingApplications,
  updateApplicationStatus,
  bulkApproveApplications,
  getPendingFullMemberships,
  updateFullMembershipStatus,
  getAvailableMentors,
  getAvailableClasses,
  sendNotification,
  sendMembershipNotification,
  getAllReports,
  searchUsers,
  deleteUserAccount,
  getMembershipOverview,
  exportMembershipData,
  getSystemConfig
} from '../controllers/adminManagementController.js';

// User status and basic operations
import {
  healthCheck,
  testSimple,
  testAuth,
  testDashboard,
  testUserLookup,
  debugApplicationStatus,
  getSystemStatus,
  getBasicProfile,
  getLegacyMembershipStatus,
  getUserStatus
} from '../controllers/userStatusController.js';

// Full membership functions (keeping existing controller)
import {
  getFullMembershipStatusById,
  submitFullMembershipApplication,
  reapplyFullMembership,
  logFullMembershipAccess
} from '../controllers/fullMembershipController.js';

// Analytics functions (keeping existing controller)
import {
  getMembershipAnalytics,
  getMembershipStats
} from '../controllers/analyticsController.js';

const router = express.Router();

// ===============================================
// SECTION 1: SYSTEM & HEALTH ROUTES
// ===============================================

// Health and system status
router.get('/health', healthCheck);
router.get('/system/status', getSystemStatus);

// Development & testing routes
router.get('/test-simple', testSimple);
router.get('/test-auth', authenticate, testAuth);
router.get('/test-dashboard', authenticate, testDashboard);
router.get('/test-user-lookup/:userId', authenticate, requireAdmin, testUserLookup);
router.get('/test-user-lookup', authenticate, testUserLookup);

// Debug routes (development only)
if (process.env.NODE_ENV === 'development') {
  router.get('/debug/application-status/:userId', authenticate, debugApplicationStatus);
  router.get('/debug/status-consistency', authenticate, verifyApplicationStatusConsistency);
}

// ===============================================
// SECTION 2: USER DASHBOARD & STATUS ROUTES
// ===============================================

// Primary dashboard
router.get('/dashboard', authenticate, getUserDashboard);

// Status checking routes - Multiple endpoints for compatibility
router.get('/status', authenticate, getCurrentMembershipStatus);
router.get('/application/status', authenticate, checkApplicationStatus);
router.get('/survey/check-status', authenticate, checkSurveyStatus);

// Legacy compatibility endpoints
router.get('/membership/status', authenticate, getLegacyMembershipStatus);
router.get('/user/status', authenticate, getUserStatus);

// User profile and permissions
router.get('/profile/basic', authenticate, getBasicProfile);
router.get('/permissions', authenticate, getUserPermissions);
router.get('/application-history', authenticate, getApplicationHistory);
router.get('/history', authenticate, getApplicationHistory);

// ===============================================
// SECTION 3: INITIAL APPLICATION ROUTES (PRE-MEMBER)
// ===============================================

// Submit initial application - Multiple endpoints for compatibility
router.post('/survey/submit-application', authenticate, submitInitialApplication);
router.post('/application', authenticate, submitInitialApplication);
router.post('/submit-initial-application', authenticate, submitInitialApplication);

// Application management
router.put('/application/update-answers', authenticate, updateApplicationAnswers);
router.put('/application/answers', authenticate, updateApplicationAnswers);
router.put('/application/update', authenticate, updateInitialApplication);

// Application control
router.post('/application/withdraw', authenticate, withdrawApplication);
router.delete('/application', authenticate, withdrawApplication);

// Application information
router.get('/application/requirements', authenticate, getApplicationRequirements);
router.get('/application/info', authenticate, getApplicationRequirements);
router.get('/application-requirements', authenticate, getApplicationRequirements);

// Validated application routes with input validation
router.put('/application/answers/validated',
  authenticate,
  validateRequest(['answers']),
  updateApplicationAnswers
);

router.post('/application/withdraw/validated',
  authenticate,
  validateRequest(['reason']),
  withdrawApplication
);

// ===============================================
// SECTION 4: FULL MEMBERSHIP ROUTES
// ===============================================

// Get full membership status - Multiple endpoints for compatibility
router.get('/full-membership-status/:userId', authenticate, getFullMembershipStatusById);
router.get('/full-membership-status', authenticate, getFullMembershipStatusById);
router.get('/membership/full-membership-status', authenticate, getFullMembershipStatusById);
router.get('/full-membership/status', authenticate, getFullMembershipStatusById);

// Submit full membership application
router.post('/submit-full-membership', authenticate, submitFullMembershipApplication);
router.post('/membership/submit-full-membership', authenticate, submitFullMembershipApplication);
router.post('/full-membership/apply', authenticate, submitFullMembershipApplication);
router.post('/submit-full-membership-application', authenticate, submitFullMembershipApplication);

// Reapplication for declined applications
router.post('/reapply-full-membership', authenticate, reapplyFullMembership);

// Log full membership access
router.post('/membership/log-full-membership-access', authenticate, logFullMembershipAccess);
router.post('/full-membership/access', authenticate, logFullMembershipAccess);

// ===============================================
// SECTION 5: ADMIN APPLICATION MANAGEMENT ROUTES
// ===============================================

// System configuration (Admin only)
router.get('/admin/config', authenticate, requireAdmin, getSystemConfig);
router.get('/admin/super/config', authenticate, requireSuperAdmin, getSystemConfig);

// Get pending applications - Multiple endpoints for compatibility
router.get('/admin/pending-applications', authenticate, requireAdmin, getPendingApplications);
router.get('/admin/applications', authenticate, requireAdmin, getPendingApplications);
router.get('/admin/membership/applications', authenticate, requireAdmin, getPendingApplications);

// Update application status - Multiple endpoints for compatibility
router.put('/admin/update-user-status/:userId', authenticate, requireAdmin, updateApplicationStatus);
router.put('/admin/applications/:userId/status', authenticate, requireAdmin, updateApplicationStatus);

// Pre-member specific approval/decline
router.post('/approve/:userId', authenticate, requireAdmin, approvePreMemberApplication);
router.post('/decline/:userId', authenticate, requireAdmin, declinePreMemberApplication);

// Bulk operations
router.post('/admin/bulk-approve', authenticate, requireAdmin, bulkApproveApplications);
router.post('/admin/applications/bulk', authenticate, requireAdmin, bulkApproveApplications);

// ===============================================
// SECTION 6: ADMIN FULL MEMBERSHIP MANAGEMENT
// ===============================================

// Get pending full memberships
router.get('/admin/pending-full-memberships', authenticate, requireAdmin, getPendingFullMemberships);
router.get('/admin/full-memberships', authenticate, requireAdmin, getPendingFullMemberships);

// Review full membership applications
router.put('/admin/review-full-membership/:applicationId', authenticate, requireAdmin, updateFullMembershipStatus);
router.put('/admin/full-memberships/:applicationId/status', authenticate, requireAdmin, updateFullMembershipStatus);

// ===============================================
// SECTION 7: ADMIN RESOURCES & UTILITIES
// ===============================================

// Get available mentors and classes
router.get('/admin/mentors', authenticate, requireAdmin, getAvailableMentors);
router.get('/admin/classes', authenticate, requireAdmin, getAvailableClasses);

// Reports and admin data
router.get('/admin/reports', authenticate, requireAdmin, getAllReports);
router.get('/admin/membership-overview', authenticate, requireAdmin, cacheMiddleware(600), getMembershipOverview);
router.get('/admin/overview', authenticate, requireAdmin, getMembershipOverview);

// Analytics and statistics
router.get('/admin/analytics', authenticate, requireAdmin, cacheMiddleware(600), getMembershipAnalytics);
router.get('/admin/membership-analytics', authenticate, requireAdmin, getMembershipAnalytics);
router.get('/admin/membership-stats', authenticate, requireAdmin, cacheMiddleware(600), getMembershipStats);
router.get('/admin/stats', authenticate, requireAdmin, getMembershipStats);

// Data export
router.get('/admin/export-membership-data', authenticate, requireAdmin, exportMembershipData);
router.get('/admin/export', authenticate, requireAdmin, exportMembershipData);

// ===============================================
// SECTION 8: COMMUNICATION & NOTIFICATIONS
// ===============================================

// General notifications
router.post('/admin/send-notification', authenticate, requireAdmin, sendNotification);
router.post('/admin/notifications/send', authenticate, requireAdmin, sendNotification);

// Membership-specific notifications
router.post('/admin/send-membership-notification', authenticate, requireAdmin, sendMembershipNotification);
router.post('/admin/notifications/membership', authenticate, requireAdmin, sendMembershipNotification);

// Validated notification routes
router.post('/admin/notifications/validated-send', 
  authenticate, 
  requireAdmin,
  validateRequest(['recipients', 'subject', 'message']),
  sendNotification
);

// ===============================================
// SECTION 9: USER MANAGEMENT ROUTES (SUPER ADMIN)
// ===============================================

// User search and management
router.get('/admin/search-users', authenticate, requireAdmin, searchUsers);

// User account deletion (Super Admin only)
router.delete('/admin/users/:userId', authenticate, requireSuperAdmin, deleteUserAccount);
router.delete('/user/account', authenticate, deleteUserAccount); // Self-deletion

// ===============================================
// SECTION 10: ENHANCED ERROR HANDLING & LOGGING
// ===============================================

// Request logging middleware for all membership routes
router.use((req, res, next) => {
  const startTime = Date.now();
  
  // Log request in development
  if (process.env.NODE_ENV === 'development') {
    console.log(`🛣️ ${req.method} ${req.path}`, {
      user: req.user?.id || 'unauthenticated',
      timestamp: new Date().toISOString(),
      ip: req.ip
    });
  }
  
  // Log response time
  const originalSend = res.send;
  res.send = function(data) {
    const duration = Date.now() - startTime;
    if (process.env.NODE_ENV === 'development') {
      console.log(`✅ Response sent in ${duration}ms for ${req.method} ${req.path}`);
    }
    originalSend.call(this, data);
  };
  
  next();
});

// Enhanced 404 handler for membership routes
router.use('*', (req, res) => {
  console.warn(`❌ 404 - Route not found: ${req.method} ${req.path}`);
  
  res.status(404).json({
    success: false,
    error: 'Membership route not found',
    path: req.path,
    method: req.method,
    message: 'The requested membership endpoint does not exist',
    availableEndpoints: {
      user: [
        'GET /dashboard - User dashboard with comprehensive status',
        'GET /status - Current membership status',
        'GET /application/status - Application status check',
        'POST /survey/submit-application - Submit initial application',
        'GET /full-membership-status - Full membership application status',
        'POST /submit-full-membership - Submit full membership application'
      ],
      admin: [
        'GET /admin/pending-applications - Get pending applications',
        'GET /admin/membership-overview - Membership overview dashboard',
        'POST /admin/bulk-approve - Bulk approve applications',
        'GET /admin/analytics - Advanced analytics and reporting',
        'POST /approve/:userId - Approve specific application',
        'POST /decline/:userId - Decline specific application'
      ],
      system: [
        'GET /health - System health check',
        'GET /test-simple - Simple connectivity test',
        'GET /admin/config - System configuration'
      ]
    },
    suggestion: 'Check the API documentation for correct endpoint paths',
    timestamp: new Date().toISOString()
  });
});

// Enhanced global error handler for membership routes
router.use((error, req, res, next) => {
  const errorId = Date.now().toString(36) + Math.random().toString(36).substr(2);
  
  console.error('❌ Membership route error:', {
    errorId,
    error: error.message,
    stack: error.stack,
    path: req.path,
    method: req.method,
    user: req.user?.id || 'not authenticated',
    timestamp: new Date().toISOString()
  });
  
  // Categorize errors for better handling
  let statusCode = error.statusCode || 500;
  let errorType = 'server_error';
  
  if (error.message.includes('validation') || error.message.includes('required')) {
    statusCode = 400;
    errorType = 'validation_error';
  } else if (error.message.includes('authentication') || error.message.includes('token')) {
    statusCode = 401;
    errorType = 'authentication_error';
  } else if (error.message.includes('permission') || error.message.includes('admin') || error.message.includes('access denied')) {
    statusCode = 403;
    errorType = 'authorization_error';
  } else if (error.message.includes('not found')) {
    statusCode = 404;
    errorType = 'not_found_error';
  } else if (error.message.includes('database') || error.message.includes('connection') || error.message.includes('MySQL')) {
    statusCode = 503;
    errorType = 'database_error';
  } else if (error.message.includes('timeout')) {
    statusCode = 504;
    errorType = 'timeout_error';
  }
  
  const errorResponse = {
    success: false,
    error: error.message || 'Internal server error',
    errorType,
    errorId,
    path: req.path,
    method: req.method,
    timestamp: new Date().toISOString()
  };
  
  // Add debug info in development
  if (process.env.NODE_ENV === 'development') {
    errorResponse.debug = {
      stack: error.stack,
      user: req.user
    };
  }
  
  res.status(statusCode).json(errorResponse);
});

// ===============================================
// DEVELOPMENT LOGGING & DOCUMENTATION
// ===============================================

if (process.env.NODE_ENV === 'development') {
  console.log('\n🛣️ COMPLETE MODULAR MEMBERSHIP ROUTES LOADED:');
  console.log('================================================================================');
  console.log('✅ ARCHITECTURE: Complete modular organization - 4 controllers + utilities');
  console.log('✅ PRESERVED: All existing functionality with zero breaking changes');
  console.log('✅ ENHANCED: Better error handling, validation, and transaction safety');
  console.log('✅ ORGANIZED: Clear separation of concerns for maintainability');
  console.log('================================================================================');
  
  console.log('\n📁 NEW MODULAR STRUCTURE:');
  console.log('   1. membershipCore.js              - All utilities and shared functions');
  console.log('   2. preMemberApplicationController.js - Pre-member application flow');
  console.log('   3. adminManagementController.js   - All admin functions');
  console.log('   4. userStatusController.js        - Status checks and basic operations');
  console.log('   5. fullMembershipController.js    - Full membership (existing)');
  console.log('   6. analyticsController.js         - Analytics (existing)');
  
  console.log('\n🔧 KEY IMPROVEMENTS:');
  console.log('   • Zero functionality loss - all functions preserved');
  console.log('   • Enhanced error handling with proper HTTP status codes');
  console.log('   • Database transaction safety for critical operations');
  console.log('   • Comprehensive input validation and sanitization');
  console.log('   • Proper admin/super_admin role-based access control');
  console.log('   • Non-blocking email notifications');
  console.log('   • Complete audit logging for all admin actions');
  
  console.log('\n📊 ROUTES ORGANIZATION:');
  console.log('   • 80+ endpoints across all modules');
  console.log('   • Complete pre-member → full member flow');
  console.log('   • Comprehensive admin management tools');
  console.log('   • Enhanced analytics and reporting');
  console.log('   • Robust error handling and logging');
  console.log('   • Multiple compatibility endpoints for legacy support');
  
  console.log('\n🚀 BENEFITS ACHIEVED:');
  console.log('   • Eliminated duplication between application survey and membership');
  console.log('   • Clear separation of concerns for easier maintenance');
  console.log('   • Enhanced code reusability and testing capability');
  console.log('   • Improved scalability for future feature additions');
  console.log('   • Better debugging and error tracking capabilities');
  
  console.log('================================================================================\n');
}

export default router;


//======================//============================//

// File: ikootaapi/routes/surveyRoutes.js
// SURVEY ROUTES - CONSOLIDATED SURVEY MANAGEMENT

import express from 'express';
import { 
  submitSurvey, 
  getSurveyQuestions, 
  updateSurveyQuestions, 
  getSurveyLogs, 
  approveSurvey,
  getQuestionLabels,
  updateSurveyQuestionLabels
} from '../controllers/surveyControllers.js';
import { authenticate } from '../middlewares/auth.middleware.js';

const surveyRouter = express.Router();

// ===============================================
// SURVEY SUBMISSION ROUTES
// ===============================================

// Submit application survey form
surveyRouter.post('/submit', authenticate, submitSurvey);
surveyRouter.post('/application/submit', authenticate, submitSurvey);
surveyRouter.post('/submit_applicationsurvey', authenticate, submitSurvey); // Legacy compatibility

// ===============================================
// SURVEY MANAGEMENT ROUTES
// ===============================================

// Question labels endpoints for dynamic survey management
surveyRouter.get('/question-labels', authenticate, getQuestionLabels);
surveyRouter.put('/question-labels', authenticate, updateSurveyQuestionLabels);

// Legacy endpoints (backward compatibility)
surveyRouter.get('/questions', authenticate, getSurveyQuestions);
surveyRouter.put('/questions', authenticate, updateSurveyQuestions);

// ===============================================
// SURVEY STATUS & LOGS ROUTES
// ===============================================

// Survey status check
surveyRouter.get('/status', authenticate, async (req, res) => {
  // This would integrate with the survey status controller
  res.json({ message: 'Survey status endpoint - integrate with userStatusController' });
});

// Survey logs and approval (admin only)
surveyRouter.get('/logs', authenticate, getSurveyLogs);
surveyRouter.put('/approve', authenticate, approveSurvey);

// ===============================================
// ERROR HANDLING
// ===============================================

// 404 handler for survey routes
surveyRouter.use('*', (req, res) => {
  res.status(404).json({
    success: false,
    error: 'Survey route not found',
    path: req.path,
    method: req.method,
    availableRoutes: {
      submission: [
        'POST /submit - Submit survey',
        'POST /application/submit - Submit application survey'
      ],
      management: [
        'GET /question-labels - Get question labels',
        'PUT /question-labels - Update question labels',
        'GET /questions - Get survey questions',
        'PUT /questions - Update survey questions'
      ],
      status: [
        'GET /status - Get survey status',
        'GET /logs - Get survey logs (admin)',
        'PUT /approve - Approve survey (admin)'
      ]
    },
    timestamp: new Date().toISOString()
  });
});

// Global error handler for survey routes
surveyRouter.use((error, req, res, next) => {
  console.error('❌ Survey route error:', error);
  
  res.status(error.statusCode || 500).json({
    success: false,
    error: error.message || 'Internal server error',
    path: req.path,
    method: req.method,
    timestamp: new Date().toISOString()
  });
});

if (process.env.NODE_ENV === 'development') {
  console.log('📊 Survey routes loaded with question management and submission');
}

export default surveyRouter;


//======================//============================//

// 3. SYSTEM ROUTES - HEALTH CHECKS & UTILITIES
// File: ikootaapi/routes/systemRoutes.js
// ===============================================

import express from 'express';
import { authenticate } from '../middlewares/auth.middleware.js';

// Import system-related functions
import {
  healthCheck,
  testSimple,
  testAuth,
  testDashboard,
  getSystemStatus
} from '../controllers/userStatusController.js';

const systemRouter = express.Router();

// ===============================================
// MAIN SYSTEM ENDPOINTS
// ===============================================

// Health check endpoint
systemRouter.get('/health', (req, res) => {
  res.json({
    success: true,
    message: 'API is healthy',
    timestamp: new Date().toISOString(),
    environment: process.env.NODE_ENV || 'development',
    uptime: process.uptime(),
    memory: process.memoryUsage(),
    version: '1.0.0'
  });
});

// API info endpoint
systemRouter.get('/info', (req, res) => {
  res.json({
    success: true,
    message: 'API Information',
    version: '1.0.0',
    routes: {
      authentication: '/api/auth/*',
      users: '/api/users/*',
      membership: '/api/membership/*',
      admin: '/api/admin/*',
      content: '/api/content/*',
      communication: '/api/chat/*',
      identity: '/api/identity/*',
      system: '/api/health, /api/info'
    },
    timestamp: new Date().toISOString()
  });
});

// System status endpoint
systemRouter.get('/system/status', getSystemStatus);

// ===============================================
// DEVELOPMENT & TESTING ENDPOINTS
// ===============================================

// Simple connectivity test
systemRouter.get('/test/simple', testSimple);

// Authentication test
systemRouter.get('/test/auth', authenticate, testAuth);

// Dashboard connectivity test
systemRouter.get('/test/dashboard', authenticate, testDashboard);

// ===============================================
// DEBUG ROUTES (DEVELOPMENT ONLY)
// ===============================================

if (process.env.NODE_ENV === 'development') {
  
  // Debug route list
  systemRouter.get('/debug/routes', (req, res) => {
    res.json({
      success: true,
      message: 'Available system routes',
      routes: {
        main: [
          'GET /health - System health check',
          'GET /info - API information',
          'GET /system/status - System status overview'
        ],
        testing: [
          'GET /test/simple - Simple connectivity test',
          'GET /test/auth - Authentication test (requires login)',
          'GET /test/dashboard - Dashboard connectivity test (requires login)'
        ],
        debug: [
          'GET /debug/routes - This route list'
        ]
      },
      timestamp: new Date().toISOString()
    });
  });
}

// ===============================================
// ERROR HANDLING
// ===============================================

// System routes error handler
systemRouter.use((error, req, res, next) => {
  console.error('❌ System route error:', {
    error: error.message,
    stack: error.stack,
    path: req.path,
    method: req.method,
    timestamp: new Date().toISOString()
  });
  
  res.status(error.statusCode || 500).json({
    success: false,
    error: error.message || 'System error',
    path: req.path,
    method: req.method,
    timestamp: new Date().toISOString()
  });
});

if (process.env.NODE_ENV === 'development') {
  console.log('🔧 System routes loaded: health checks, API info, and testing endpoints');
}

export default systemRouter;



//======================//============================//

// File: ikootaapi/routes/teachingsRoutes.js
import express from 'express';
import { uploadMiddleware, uploadToS3 } from '../middlewares/upload.middleware.js';
import {
  createTeaching,
  fetchAllTeachings,
  fetchTeachingsByUserId,
  editTeaching,
  removeTeaching,
  fetchTeachingsByIds,
  fetchTeachingByPrefixedId,
  searchTeachingsController,
  fetchTeachingStats,
} from '../controllers/teachingsControllers.js';
import { authenticate, cacheMiddleware } from '../middlewares/auth.middleware.js';

const router = express.Router();

// GET /teachings - Fetch all teachings with optional pagination and filtering
router.get('/', authenticate, fetchAllTeachings);

// GET /teachings/search - Search teachings (dedicated search endpoint)
router.get('/search', authenticate, cacheMiddleware(120), searchTeachingsController);

// GET /teachings/stats - Get teaching statistics
router.get('/stats', authenticate, cacheMiddleware(120), fetchTeachingStats);

// GET /teachings/user - Fetch teachings by user_id
router.get('/user', authenticate, fetchTeachingsByUserId);

// GET /teachings/ids - Fetch teachings by multiple IDs
router.get('/ids', authenticate, fetchTeachingsByIds);

// GET /teachings/prefixed/:prefixedId - Fetch teaching by prefixed ID or numeric ID
router.get('/prefixed/:prefixedId', authenticate, fetchTeachingByPrefixedId);

// GET /teachings/:id - Fetch single teaching by ID (alternative endpoint)
router.get('/:id', authenticate, fetchTeachingByPrefixedId);

// POST /teachings - Create a new teaching
router.post('/', authenticate, uploadMiddleware, uploadToS3, createTeaching);

// PUT /teachings/:id - Update a teaching by ID
router.put('/:id', authenticate, uploadMiddleware, uploadToS3, editTeaching);

// DELETE /teachings/:id - Delete a teaching by ID
router.delete('/:id', authenticate, removeTeaching);

export default router;





//======================//============================//


// File: ikootaapi/routes/userRoutes.js
// 2. USER ROUTES - CONSOLIDATED USER MANAGEMENT

import express from 'express';
import {
  // Existing user controller functions
  getUserProfile,
  updateUserProfile,
  updateUserRole,
  fetchAllUsers,
  fetchUserStats,
  fetchUserActivity,
  fetchUserById,
  removeUser,
  
  // Admin management functions
  getAllUsers,
  getAllMentors,
  updateUser,
  getMembershipOverview,
  getClasses
} from '../controllers/userControllers.js';

// Import from userStatusController for status-related functions
import {
  checkSurveyStatus,
  getCurrentMembershipStatus,
  getBasicProfile,
  getLegacyMembershipStatus,
  getUserStatus,
  debugApplicationStatus,
  getSystemStatus
} from '../controllers/userStatusController.js';

// Import from preMemberApplicationController for dashboard functions
import {
  getUserDashboard,
  getApplicationHistory,
  getUserPermissions,
  checkApplicationStatus
} from '../controllers/preMemberApplicationController.js';

import { 
  authenticate,  
  requireAdmin  
} from '../middlewares/auth.middleware.js';

const userRouter = express.Router();

// ===============================================
// USER PROFILE MANAGEMENT ROUTES
// ===============================================

// GET /users/profile - Get current user's profile
userRouter.get('/profile', authenticate, getUserProfile);

// PUT /users/profile - Update current user's profile
userRouter.put('/profile', authenticate, updateUserProfile);

// GET /users/profile/basic - Get basic profile info
userRouter.get('/profile/basic', authenticate, getBasicProfile);

// DELETE /users/profile - Delete user profile (self-deletion)
userRouter.delete('/profile', authenticate, removeUser);

// ===============================================
// USER STATUS & DASHBOARD ROUTES
// ===============================================

// GET /users/dashboard - Primary user dashboard
userRouter.get('/dashboard', authenticate, getUserDashboard);

// GET /users/status - Current membership status
userRouter.get('/status', authenticate, getCurrentMembershipStatus);

// GET /users/permissions - User permissions
userRouter.get('/permissions', authenticate, getUserPermissions);

// GET /users/application/status - Application status check
userRouter.get('/application/status', authenticate, checkApplicationStatus);

// GET /users/survey/check-status - Enhanced survey status check
userRouter.get('/survey/check-status', authenticate, checkSurveyStatus);

// ===============================================
// USER HISTORY & ACTIVITY ROUTES
// ===============================================

// GET /users/history - Application history
userRouter.get('/history', authenticate, getApplicationHistory);

// GET /users/application-history - Application history (alias)
userRouter.get('/application-history', authenticate, getApplicationHistory);

// GET /users/activity - User activity
userRouter.get('/activity', authenticate, fetchUserActivity);

// GET /users/:user_id/activity - Get specific user activity
userRouter.get('/:user_id/activity', authenticate, fetchUserActivity);

// ===============================================
// USER SETTINGS ROUTES
// ===============================================

// PUT /users/settings - Update user settings
userRouter.put('/settings', authenticate, updateUserProfile);

// GET /users/settings - Get user settings
userRouter.get('/settings', authenticate, getUserProfile);

// PUT /users/password - Update user password
userRouter.put('/password', authenticate, updateUserProfile);

// ===============================================
// USER LOOKUP & MANAGEMENT ROUTES
// ===============================================

// GET /users/stats - Get user statistics (admin only)
userRouter.get('/stats', authenticate, requireAdmin, fetchUserStats);

// GET /users - Get all users with filtering (admin only)
userRouter.get('/', authenticate, requireAdmin, fetchAllUsers);

// GET /users/:user_id - Get user by ID
userRouter.get('/:user_id', authenticate, fetchUserById);

// PUT /users/role - Update user role and properties (admin only)
userRouter.put('/role', authenticate, requireAdmin, updateUserRole);

// PUT /users/:user_id - Update specific user (admin only)
userRouter.put('/:user_id', authenticate, requireAdmin, updateUserRole);

// DELETE /users/:user_id - Soft delete user (super admin only)
userRouter.delete('/:user_id', authenticate, requireAdmin, removeUser);

// ===============================================
// ADMIN USER MANAGEMENT ROUTES (Legacy Support)
// ===============================================

// Admin Users Management Routes
userRouter.get('/admin/users', 
  authenticate, 
  requireAdmin, 
  getAllUsers
);

userRouter.get('/admin/mentors', 
  authenticate, 
  requireAdmin, 
  getAllMentors
);

userRouter.put('/admin/update-user/:id', 
  authenticate, 
  requireAdmin, 
  updateUser
);

userRouter.get('/admin/membership-overview', 
  authenticate, 
  requireAdmin, 
  getMembershipOverview
);

userRouter.get('/classes', 
  authenticate, 
  getClasses
);

// ===============================================
// COMPATIBILITY ALIASES
// ===============================================

// Legacy compatibility endpoints
userRouter.get('/membership/status', authenticate, getLegacyMembershipStatus);
userRouter.get('/user/status', authenticate, getUserStatus);

// ===============================================
// DEVELOPMENT & DEBUG ROUTES
// ===============================================

if (process.env.NODE_ENV === 'development') {
  userRouter.get('/debug/application-status/:userId', authenticate, debugApplicationStatus);
}

// ===============================================
// ERROR HANDLING
// ===============================================

// Enhanced 404 handler for user routes
userRouter.use('*', (req, res) => {
  console.warn(`❌ 404 - User route not found: ${req.method} ${req.path}`);
  
  res.status(404).json({
    success: false,
    error: 'User route not found',
    path: req.path,
    method: req.method,
    availableEndpoints: {
      profile: [
        'GET /profile - Get current user profile',
        'PUT /profile - Update user profile',
        'GET /profile/basic - Get basic profile info',
        'DELETE /profile - Delete user profile'
      ],
      status: [
        'GET /dashboard - User dashboard',
        'GET /status - Current membership status',
        'GET /permissions - User permissions',
        'GET /application/status - Application status',
        'GET /survey/check-status - Survey status'
      ],
      history: [
        'GET /history - Application history',
        'GET /activity - User activity'
      ],
      settings: [
        'PUT /settings - Update settings',
        'GET /settings - Get settings',
        'PUT /password - Update password'
      ],
      admin: [
        'GET / - Get all users (admin)',
        'GET /stats - User statistics (admin)',
        'PUT /:user_id - Update user (admin)'
      ]
    },
    timestamp: new Date().toISOString()
  });
});

// Enhanced global error handler for user routes
userRouter.use((error, req, res, next) => {
  const errorId = Date.now().toString(36) + Math.random().toString(36).substr(2);
  
  console.error('❌ User route error:', {
    errorId,
    error: error.message,
    stack: error.stack,
    path: req.path,
    method: req.method,
    user: req.user?.id || 'not authenticated',
    timestamp: new Date().toISOString()
  });
  
  res.status(error.statusCode || 500).json({
    success: false,
    error: error.message || 'Internal server error',
    errorId,
    path: req.path,
    method: req.method,
    timestamp: new Date().toISOString()
  });
});

if (process.env.NODE_ENV === 'development') {
  console.log('👤 User routes loaded with profile, status, history, and admin management');
}

export default userRouter;



//======================//============================//

// ikootaapi/routes/userStatusRoutes.js
// ===============================================
// USER STATUS ROUTES
// Handles basic user status, health checks, and test endpoints
// ===============================================

import express from 'express';
import { authenticate } from '../middlewares/auth.middleware.js';

// ✅ UPDATED: Import functions from the correct controllers
import {
  checkSurveyStatus,           // ✅ NOW from userStatusController.js
  getCurrentMembershipStatus,  // ✅ NOW from userStatusController.js  
  healthCheck,
  testSimple,
  testAuth,
  testDashboard,
  getLegacyMembershipStatus,
  getUserStatus,
  debugApplicationStatus,
  getSystemStatus,
  getBasicProfile
} from '../controllers/userStatusController.js';

// ✅ UPDATED: Import dashboard and application functions from preMemberApplicationController.js
import {
  getUserDashboard,           // ✅ Dashboard function stays in preMemberApplicationController.js
  getApplicationHistory,      // ✅ Application history stays in preMemberApplicationController.js
  getUserPermissions,         // ✅ Permissions stay in preMemberApplicationController.js
  checkApplicationStatus      // ✅ Application status check stays in preMemberApplicationController.js
} from '../controllers/preMemberApplicationController.js';

const router = express.Router();

// ===============================================
// SYSTEM & HEALTH ROUTES
// ===============================================
router.get('/health', healthCheck);
router.get('/system/status', getSystemStatus);

// ===============================================
// DEVELOPMENT & TESTING ROUTES
// ===============================================
router.get('/test-simple', testSimple);
router.get('/test-auth', authenticate, testAuth);
router.get('/test-dashboard', authenticate, testDashboard);

// Debug routes (development only)
if (process.env.NODE_ENV === 'development') {
  router.get('/debug/application-status/:userId', authenticate, debugApplicationStatus);
}

// ===============================================
// USER STATUS ROUTES
// ===============================================

// Primary dashboard (from preMemberApplicationController.js)
router.get('/dashboard', authenticate, getUserDashboard);

// ✅ UPDATED: Status checking routes - now using improved functions
router.get('/status', authenticate, getCurrentMembershipStatus);  // ✅ From userStatusController.js
router.get('/application/status', authenticate, checkApplicationStatus);  // ✅ From preMemberApplicationController.js  
router.get('/survey/check-status', authenticate, checkSurveyStatus);  // ✅ NOW from userStatusController.js (improved version)

// User profile and permissions (from preMemberApplicationController.js)
router.get('/profile/basic', authenticate, getBasicProfile);  // ✅ From userStatusController.js
router.get('/permissions', authenticate, getUserPermissions);  // ✅ From preMemberApplicationController.js

// User history (from preMemberApplicationController.js)
router.get('/application-history', authenticate, getApplicationHistory);
router.get('/history', authenticate, getApplicationHistory);

// ===============================================
// COMPATIBILITY ALIASES
// ===============================================
router.get('/membership/status', authenticate, getLegacyMembershipStatus);  // ✅ From userStatusController.js
router.get('/user/status', authenticate, getUserStatus);  // ✅ From userStatusController.js

// ===============================================
// ENHANCED ERROR HANDLING
// ===============================================

// Enhanced 404 handler for user status routes
router.use('*', (req, res) => {
  console.warn(`❌ 404 - User status route not found: ${req.method} ${req.path}`);
  
  res.status(404).json({
    success: false,
    error: 'User status route not found',
    path: req.path,
    method: req.method,
    message: 'The requested user status endpoint does not exist',
    availableEndpoints: {
      user: [
        'GET /dashboard - User dashboard with comprehensive status',
        'GET /status - Current membership status',
        'GET /application/status - Application status check',
        'GET /survey/check-status - Enhanced survey status check',
        'GET /permissions - User permissions',
        'GET /application-history - Application history',
        'GET /profile/basic - Basic profile information'
      ],
      system: [
        'GET /health - System health check',
        'GET /system/status - System status overview',
        'GET /test-simple - Simple connectivity test',
        'GET /test-auth - Authentication test (requires login)',
        'GET /test-dashboard - Dashboard connectivity test (requires login)'
      ],
      compatibility: [
        'GET /membership/status - Legacy membership status',
        'GET /user/status - Alternative user status endpoint'
      ]
    },
    suggestion: 'Check the API documentation for correct endpoint paths',
    timestamp: new Date().toISOString()
  });
});

// Enhanced global error handler for user status routes
router.use((error, req, res, next) => {
  const errorId = Date.now().toString(36) + Math.random().toString(36).substr(2);
  
  console.error('❌ User status route error:', {
    errorId,
    error: error.message,
    stack: error.stack,
    path: req.path,
    method: req.method,
    user: req.user?.id || 'not authenticated',
    timestamp: new Date().toISOString()
  });
  
  // Categorize errors for better handling
  let statusCode = error.statusCode || 500;
  let errorType = 'server_error';
  
  if (error.message.includes('validation') || error.message.includes('required')) {
    statusCode = 400;
    errorType = 'validation_error';
  } else if (error.message.includes('authentication') || error.message.includes('token')) {
    statusCode = 401;
    errorType = 'authentication_error';
  } else if (error.message.includes('permission') || error.message.includes('access denied')) {
    statusCode = 403;
    errorType = 'authorization_error';
  } else if (error.message.includes('not found')) {
    statusCode = 404;
    errorType = 'not_found_error';
  } else if (error.message.includes('database') || error.message.includes('connection') || error.message.includes('MySQL')) {
    statusCode = 503;
    errorType = 'database_error';
  } else if (error.message.includes('timeout')) {
    statusCode = 504;
    errorType = 'timeout_error';
  }
  
  const errorResponse = {
    success: false,
    error: error.message || 'Internal server error',
    errorType,
    errorId,
    path: req.path,
    method: req.method,
    timestamp: new Date().toISOString()
  };
  
  // Add debug info in development
  if (process.env.NODE_ENV === 'development') {
    errorResponse.debug = {
      stack: error.stack,
      user: req.user
    };
  }
  
  res.status(statusCode).json(errorResponse);
});

// ===============================================
// DEVELOPMENT LOGGING
// ===============================================

if (process.env.NODE_ENV === 'development') {
  console.log('\n🛣️ USER STATUS ROUTES LOADED:');
  console.log('================================================================================');
  console.log('✅ REORGANIZED: Functions properly distributed between controllers');
  console.log('✅ IMPROVED: checkSurveyStatus now in userStatusController.js with enhancements');
  console.log('✅ MAINTAINED: All existing functionality with better organization');
  console.log('✅ ENHANCED: Better error handling and route documentation');
  console.log('================================================================================');
  
  console.log('\n📁 FUNCTION DISTRIBUTION:');
  console.log('   userStatusController.js:');
  console.log('   • checkSurveyStatus (✅ ENHANCED - transferred from preMemberApplicationController)');
  console.log('   • getCurrentMembershipStatus');
  console.log('   • healthCheck, testSimple, testAuth, testDashboard');
  console.log('   • getLegacyMembershipStatus, getUserStatus');
  console.log('   • debugApplicationStatus, getSystemStatus');
  console.log('   • getBasicProfile');
  
  console.log('\n   preMemberApplicationController.js:');
  console.log('   • getUserDashboard (comprehensive dashboard)');
  console.log('   • checkApplicationStatus (application-specific status)');
  console.log('   • getApplicationHistory, getUserPermissions');
  console.log('   • verifyApplicationStatusConsistency (debug)');
  console.log('   • submitInitialApplication, updateApplicationAnswers');
  console.log('   • withdrawApplication, getApplicationRequirements');
  
  console.log('\n🔧 KEY IMPROVEMENTS:');
  console.log('   • Enhanced checkSurveyStatus with full membership application data');
  console.log('   • Proper database result format handling');
  console.log('   • Comprehensive error responses with categorization');
  console.log('   • Clear separation between status checks and application management');
  console.log('   • Maintained backward compatibility with all existing endpoints');
  
  console.log('\n📊 ROUTE ORGANIZATION:');
  console.log('   • System & Health: 2 endpoints');
  console.log('   • Development & Testing: 4 endpoints (including debug)');
  console.log('   • User Status: 7 core endpoints');
  console.log('   • Compatibility Aliases: 2 endpoints');
  console.log('   • Enhanced error handling and documentation');
  
  console.log('================================================================================\n');
}

export default router;



//======================//============================//

















# Frontend-Backend API Alignment Analysis

## 📊 Summary Statistics

- **Frontend API Calls**: 85+ distinct calls across 32 components
- **Backend Endpoints**: 200+ endpoints across 14 route categories
- **Matched Endpoints**: ~60% alignment
- **Unmatched Frontend Calls**: ~15 calls
- **Unmatched Backend Endpoints**: ~80 endpoints

---

## 🔗 Aligned Frontend Calls to Backend Endpoints

| Frontend Component | Frontend API Call | Backend Endpoint | Status |
|-------------------|-------------------|------------------|---------|
| **Authentication** | | | |
| Login.jsx | `POST /api/auth/login` | `POST /api/auth/login` | ✅ **Matched** |
| Login.jsx | `GET /membership/survey/check-status` | `GET /api/membership/survey/check-status` | ✅ **Matched** |
| Signup.jsx | `POST /api/auth/send-verification` | `POST /api/auth/send-verification` | ✅ **Matched** |
| Signup.jsx | `POST /api/auth/register` | `POST /api/auth/register` | ✅ **Matched** |
| Passwordreset.jsx | `POST /api/auth/passwordreset/request` | `POST /api/auth/passwordreset/request` | ✅ **Matched** |
| Passwordreset.jsx | `POST /api/auth/passwordreset/reset` | `POST /api/auth/passwordreset/reset` | ✅ **Matched** |
| Passwordreset.jsx | `POST /api/auth/passwordreset/verify` | `POST /api/auth/passwordreset/verify` | ✅ **Matched** |
| **User Management** | | | |
| Userinfo.jsx | `GET /users/profile` | `GET /api/users/profile` | ✅ **Matched** |
| UserStatus.jsx | `GET /membership/survey/check-status` | `GET /api/membership/survey/check-status` | ✅ **Matched** |
| UserStatus.jsx | `GET /membership/full-membership-status/{userId}` | `GET /api/membership/full-membership-status` | ✅ **Matched** |
| Applicationsurvey.jsx | `POST /membership/survey/submit-application` | `POST /api/membership/application/submit` | ✅ **Matched** |
| **Admin Routes** | | | |
| UserManagement.jsx | `GET /membership/admin/membership-overview` | `GET /api/admin/membership/overview` | ✅ **Matched** |
| UserManagement.jsx | `GET /membership/admin/pending-applications` | `GET /api/admin/membership/admin/pending-applications` | ✅ **Matched** |
| UserManagement.jsx | `POST /membership/admin/bulk-approve` | `POST /api/admin/membership/admin/applications/bulk-review` | ✅ **Matched** |
| UserManagement.jsx | `PUT /membership/admin/update-user-status/{userId}` | `PUT /api/admin/membership/applications/{id}/review` | ✅ **Matched** |
| UserManagement.jsx | `GET /admin/users` | `GET /api/admin/users/` | ✅ **Matched** |
| UserManagement.jsx | `GET /classes` | `GET /api/classes/` | ✅ **Matched** |
| UserManagement.jsx | `GET /admin/mentors` | `GET /api/admin/users/mentors` | ✅ **Matched** |
| UserManagement.jsx | `GET /admin/reports` | `GET /api/admin/content/reports` | ✅ **Matched** |
| UserManagement.jsx | `PUT /admin/update-user/{id}` | `PUT /api/admin/users/{id}` | ✅ **Matched** |
| UserManagement.jsx | `POST /admin/mask-identity` | `POST /api/identity/mask-identity` | ✅ **Matched** |
| UserManagement.jsx | `DELETE /admin/delete-user/{userId}` | `DELETE /api/admin/users/{id}` | ✅ **Matched** |
| UserManagement.jsx | `POST /admin/create-user` | `POST /api/admin/users/create` | ✅ **Matched** |
| UserManagement.jsx | `POST /admin/send-notification` | `POST /api/communication/notification` | ✅ **Matched** |
| UserManagement.jsx | `PUT /admin/update-report/{reportId}` | `PUT /api/admin/content/reports/{reportId}/status` | ✅ **Matched** |
| Sidebar.jsx | `GET /admin/membership/pending-count` | `GET /api/admin/membership/pending-count` | ✅ **Matched** |
| Dashboard.jsx | `GET /membership/admin/analytics` | `GET /api/admin/membership/analytics` | ✅ **Matched** |
| Dashboard.jsx | `GET /membership/admin/membership-stats` | `GET /api/admin/membership/stats` | ✅ **Matched** |
| Dashboard.jsx | `GET /admin/membership/full-membership-stats` | `GET /api/admin/membership/full-membership-stats` | ✅ **Matched** |
| Dashboard.jsx | `GET /admin/audit-logs` | `GET /api/admin/content/audit-logs` | ✅ **Matched** |
| AudienceClassMgr.jsx | `PUT /classes/{id}` | `PUT /api/classes/{id}` | ✅ **Matched** |
| AudienceClassMgr.jsx | `POST /classes` | `POST /api/classes/` | ✅ **Matched** |
| **Content Management** | | | |
| ListChats.jsx | `GET /chats/combinedcontent` | `GET /api/chats/combinedcontent` | ✅ **Matched** |
| ListChats.jsx | `GET /comments/all` | `GET /api/comments/all` | ✅ **Matched** |
| IkoControls.jsx | `GET /api/messages?status={filter}` | *No direct match* | ❌ **Missing Backend** |
| IkoControls.jsx | `GET /api/comments?status={filter}` | `GET /api/comments/all` (partial) | ⚠️ **Partial Match** |
| IkoControls.jsx | `GET /api/chats` | `GET /api/chats/` | ✅ **Matched** |
| IkoControls.jsx | `PUT /api/{type}/{id}` (status updates) | Various PUT endpoints | ✅ **Matched** |
| **Survey & Auth Controls** | | | |
| AuthControls.jsx | `GET /survey/question-labels` | `GET /api/survey/question-labels` | ✅ **Matched** |
| AuthControls.jsx | `GET /survey/logs` | `GET /api/survey/logs` | ✅ **Matched** |
| AuthControls.jsx | `PUT /survey/question-labels` | `PUT /api/survey/question-labels` | ✅ **Matched** |
| AuthControls.jsx | `PUT /survey/approve` | `PUT /api/survey/approve` | ✅ **Matched** |
| AuthControls.jsx | `PUT /users/role` | `PUT /api/users/role` | ✅ **Matched** |
| AuthControls.jsx | `POST /email/send` | `POST /api/communication/email/send` | ✅ **Matched** |

---

## ❌ Frontend API Calls WITHOUT Backend Endpoints

| Frontend Component | API Call | Issue |
|-------------------|----------|-------|
| IkoControls.jsx | `GET /api/messages?status={filter}` | No messages endpoint exists |
| FullMembershipReviewControls.jsx | Multiple endpoint attempts with different paths | Inconsistent endpoint structure |
| UserManagement.jsx | `GET /admin/export-users` | Missing export functionality |
| Custom Hooks | `useFetchChats()`, `useFetchComments()`, `useFetchTeachings()` | Implementation unknown - may have missing endpoints |
| Custom Hooks | `useFetchParentChatsAndTeachingsWithComments()` | Complex aggregation may be missing |
| Custom Hooks | `useUpload()`, `useUploadCommentFiles()` | File upload endpoints unclear |
| Service Functions | `postComment()`, `generateUniqueClassId()` | Implementation details missing |

---

## 🔍 Backend Endpoints WITHOUT Frontend API Calls

### Authentication & User Management (Unused)
| Endpoint | Purpose | Priority |
|----------|---------|----------|
| `GET /api/auth/logout` | User logout | 🔴 **High** |
| `GET /api/auth/verify/:token` | Email verification | 🔴 **High** |
| `GET /api/auth/` | Get authenticated user | 🟡 **Medium** |
| `PUT /api/users/profile` | Update user profile | 🔴 **High** |
| `DELETE /api/users/profile` | Delete user profile | 🟡 **Medium** |
| `GET /api/users/dashboard` | User dashboard | 🔴 **High** |
| `GET /api/users/permissions` | User permissions | 🟡 **Medium** |
| `PUT /api/users/settings` | Update user settings | 🟡 **Medium** |
| `PUT /api/users/password` | Update password | 🔴 **High** |

### Content Management (Unused)
| Endpoint | Purpose | Priority |
|----------|---------|----------|
| `GET /api/content/teachings/*` | All teaching endpoints | 🔴 **High** |
| `POST /api/content/chats` | Create chat | 🔴 **High** |
| `PUT /api/content/chats/:id` | Update chat | 🟡 **Medium** |
| `DELETE /api/content/chats/:id` | Delete chat | 🟡 **Medium** |
| `POST /api/content/comments` | Create comment | 🔴 **High** |
| `PUT /api/content/comments/:id` | Update comment | 🟡 **Medium** |
| `DELETE /api/content/comments/:id` | Delete comment | 🟡 **Medium** |
| `GET /api/content/classes/:id/*` | Class management | 🔴 **High** |

### Communication System (Unused)
| Endpoint | Purpose | Priority |
|----------|---------|----------|
| `GET /api/communication/settings` | Communication settings | 🟡 **Medium** |
| `PUT /api/communication/settings` | Update comm settings | 🟡 **Medium** |
| `POST /api/communication/sms/send` | SMS functionality | 🟢 **Low** |
| `GET /api/communication/rooms/*` | Chat rooms | 🔴 **High** |
| `GET /api/communication/conversations/*` | Direct messaging | 🔴 **High** |

### Identity & Privacy (Unused)
| Endpoint | Purpose | Priority |
|----------|---------|----------|
| `POST /api/identity/verify` | Identity verification | 🟡 **Medium** |
| `POST /api/identity/documents/upload` | Document upload | 🟡 **Medium** |
| `PUT /api/identity/privacy-settings` | Privacy controls | 🟡 **Medium** |
| `POST /api/identity/anonymize` | Data anonymization | 🟢 **Low** |

### Advanced Admin Features (Unused)
| Endpoint | Purpose | Priority |
|----------|---------|----------|
| `POST /api/admin/users/ban` | User banning | 🔴 **High** |
| `POST /api/admin/users/grant-posting-rights` | Rights management | 🟡 **Medium** |
| `GET /api/admin/users/search` | User search | 🔴 **High** |
| `GET /api/admin/users/export` | Data export | 🟡 **Medium** |
| `POST /api/admin/content/bulk-manage` | Bulk content management | 🔴 **High** |
| `GET /api/analytics/admin/*` | Advanced analytics | 🟡 **Medium** |

### System & Debug (Unused)
| Endpoint | Purpose | Priority |
|----------|---------|----------|
| `GET /api/health` | System health | 🟡 **Medium** |
| `GET /api/info` | API information | 🟢 **Low** |
| `GET /api/routes` | Route discovery | 🟢 **Low** |
| `GET /api/metrics` | Performance monitoring | 🟢 **Low** |

---

## 🔧 Recommendations for Implementation

### 1. **Critical Missing Frontend Components** (High Priority)
- **User logout functionality** - Frontend needs logout button/handler
- **Profile management UI** - Update profile, change password
- **Teaching content management** - Complete CRUD interface
- **Chat/messaging system** - Real-time chat interface
- **Advanced user search** - Admin search functionality

### 2. **Backend Endpoints Needing Frontend** (Medium Priority)
- **User dashboard** - Comprehensive user dashboard UI
- **Communication settings** - User communication preferences
- **Class management** - Full class admin interface
- **Content moderation** - Bulk content management tools

### 3. **Inconsistent Endpoint Patterns** (Needs Fixing)
- **FullMembershipReviewControls.jsx** - Multiple endpoint attempts suggest unclear API structure
- **File upload endpoints** - Inconsistent upload handling across components
- **Status filtering** - Messages endpoint missing but referenced in frontend

### 4. **Potential Optimization Opportunities**
- **Custom hooks** - Consolidate similar data fetching patterns
- **Bulk operations** - Leverage existing bulk endpoints more effectively
- **Caching strategy** - Implement frontend caching for frequently accessed data






MISSING API ENDPOINTS (Need to be created):
Based on frontend calls vs. available routes:
Potentially Missing:

/api/full-membership/* - Several components call this, but index.js doesn't show it
/api/email/send-membership-feedback - Email service endpoint
/api/admin/applications/stats - Application statistics
/api/membership/log-full-membership-access - Access logging

Messages API - IkoControls.jsx calls /api/messages but no backend endpoint exists

//table
Frontend ComponentAPI CallIssueIkoControls.jsxGET /api/messages?status={filter}No messages endpoint existsFullMembershipReviewControls.jsxMultiple endpoint attempts with different pathsInconsistent endpoint structureUserManagement.jsxGET /admin/export-usersMissing export functionalityCustom HooksuseFetchChats(), useFetchComments(), useFetchTeachings()Implementation unknown - may have missing endpointsCustom HooksuseFetchParentChatsAndTeachingsWithComments()Complex aggregation may be missingCustom HooksuseUpload(), useUploadCommentFiles()File upload endpoints unclearService FunctionspostComment(), generateUniqueClassId()Implementation details missing

Some endpoints have both /api/ prefixed and non-prefixed versions

Debug components (DebugWrapper.jsx, apiTracer.js)

🚀 Immediate Action Items:
Fix broken import in useUploadCommentFiles.js
Broken Import - useUploadCommentFiles.js missing API import (will cause runtime errors)
Add 3 ID generation routes to adminUserRoutes.js
Missing ID Generation Routes - Your IdDisplay.jsx component calls endpoints that don't exist
Add notification routes to userRoutes.js
Notification Routes Missing - Dashboard tries to mark notifications as read but route doesn't exist

IMMEDIATE FIXES (Priority 1)

Add Missing ID Generation Routes
javascript// Add to adminUserRoutes.js
router.post('/generate-bulk-ids', generateBulkIds);
router.post('/generate-converse-id', generateConverseId);
router.post('/generate-class-id', generateClassId);

Add User Notifications Routes
javascript// Add to userRoutes.js
router.get('/notifications', getUserNotifications);
router.put('/notifications/:id/read', markNotificationAsRead);

Fix Import in useUploadCommentFiles.js
javascript// Add missing import
import api from '../components/service/api';


MEDIUM PRIORITY (Priority 2)

Standardize Full Membership Routes

Create consistent /api/full-membership/* pattern
Add alias routes for backward compatibility


Add Email Service Routes
javascript// Add to communicationRoutes.js
router.post('/email/send-membership-feedback', sendMembershipFeedback);

Implement Missing Messages Endpoints
javascript// Add to communicationRoutes.js or create messageRoutes.js
router.get('/messages', getMessages);
router.put('/messages/:id', updateMessage);


O