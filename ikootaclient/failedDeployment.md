
FIX: Handle missing staging task definitions in
Deploy to AWS #41: Commit 73f5b5d pushed by Petersomond1
main	
37 minutes ago
 24m 10s
CRITICAL FIX: Resolve deployment pipeline preventing
Deploy to AWS #40: Commit 3c1e59b pushed by Petersomond1
main	
Today at 4:04 PM
 3m 27s
Fix nginx ALB port configuration 3000â†’8080
Deploy to AWS #39: Commit cab7c3a pushed by Petersomond1
main	
Today at 2:37 PM
 26m 17s
CRITICAL FIX: Resolve frontend API URL configuration
Deploy to AWS #38: Commit af4f340 pushed by Petersomond1
main	
Today at 9:48 AM
 25m 5s
Fix staging health check endpoint
Deploy to AWS #37: Commit add00cc pushed by Petersomond1
main	
Today at 9:03 AM
 25m 46s
Deploy to AWS
Deploy to AWS #36: by Petersomond1
main	
Today at 8:43 AM
 9m 34s
Fix critical production nginx proxy configuration for authentication â”‚
Deploy to AWS #35: Commit a9dec75 pushed by Petersomond1
main	
Today at 7:37 AM
 23m 42s
MAJOR FIX: Complete deployment pipeline and all four core systems
Deploy to AWS #34: Commit 001598b pushed by Petersomond1
main	
Today at 6:33 AM
 25m 43s
CRITICAL FIX: Resolve production â”‚
Deploy to AWS #33: Commit fecea84 pushed by Petersomond1
main	
Today at 4:55 AM
 25m 31s
Standardize production API port to 3000 across all environments â”‚
Deploy to AWS #32: Commit a9b21dc pushed by Petersomond1
main	
Today at 3:36 AM
 23m 32s
Fix critical React hooks rules violations for deployment â”‚
Deploy to AWS #31: Commit c876c43 pushed by Petersomond1
main	
Today at 2:43 AM
 21m 21s
Complete frontend integration testing and critical linting fixes â”‚
Deploy to AWS #30: Commit e2c7e58 pushed by Petersomond1
main	
Today at 2:30 AM
 59s
Fix critical production authentication issue: JWT token missing conveâ€¦
Deploy to AWS #29: Commit a948519 pushed by Petersomond1
main	
Sep 17, 9:25 PM EDT
 26m 27s
CRITICAL FIX: Add missing converse_id to JWT token payload for â”‚
Deploy to AWS #28: Commit fc75105 pushed by Petersomond1
main	
Sep 17, 8:16 PM EDT
 50s
Replace port configuration with deployment-safe system status displayâ€¦
Deploy to AWS #27: Commit ef41073 pushed by Petersomond1
main	
Sep 17, 6:39 AM EDT
 26m 8s
Critical fix: Production API endpoints and privacy protection
Deploy to AWS #26: Commit 078a3a1 pushed by Petersomond1
main	
Sep 15, 3:38 PM EDT
 26m 26s
Fix remaining hardcoded localhost URLs in auth components, - Updateâ€¦
Deploy to AWS #25: Commit 3d2c579 pushed by Petersomond1
main	
Sep 15, 1:58 PM EDT
 19m 39s
Implement secure production-first API configuration
Deploy to AWS #24: Commit 7edd12f pushed by Petersomond1
main	
Sep 15, 7:48 AM EDT
 24m 23s
Fix .dockerignore to allow production environment files
Deploy to AWS #23: Commit 2d05320 pushed by Petersomond1
main	
Sep 15, 7:19 AM EDT
 18m 53s
Fix remaining hardcoded localhost URLs in auth components, - Updateâ€¦
Deploy to AWS #22: Commit a1cce27 pushed by Petersomond1
main	
Sep 15, 6:15 AM EDT
 22m 26s
Fix Docker environment variable injection for production build â€¦
Deploy to AWS #21: Commit 9bde26b pushed by Petersomond1
main	
Sep 15, 4:22 AM EDT
 26m 3s
Fix hardcoded localhost URLs in Login.jsx for production deployment â€¦
Deploy to AWS #20: Commit b3f23eb pushed by Petersomond1
main	
Sep 15, 2:01 AM EDT
 23m 47s
Fix: Set Vite environment variables directly during build command
Deploy to AWS #19: Commit bce819a pushed by Petersomond1
main	
Sep 15, 1:15 AM EDT
 25m 59s
Debug: Add logging to Dockerfile environment variable handling
Deploy to AWS #18: Commit 286c67d pushed by Petersomond1
main	
Sep 15, 12:38 AM EDT
 21m 0s
Deploy-ready: Fix Dockerfile environment handling and disable mock daâ€¦
Deploy to AWS #17: Commit 8b2fd86 pushed by Petersomond1
main	
Sep 14, 11:03 PM EDT
 26m 8s


Fix frontend API configuration: Environment-aware API endpoints â€¦
Deploy to AWS #16: Commit f81ec44 pushed by Petersomond1
main	
Sep 14, 9:50 PM EDT
 3m 49s
Trigger frontend deployment: Deploy converse_id display and timestampâ€¦
Deploy to AWS #15: Commit 22e1342 pushed by Petersomond1
main	
Sep 14, 7:34 PM EDT
 26m 24s
Fix login authentication: Remove converse_id dependency from JWT and â€¦
Deploy to AWS #14: Commit 7140ebc pushed by Petersomond1
main	
Sep 14, 4:32 PM EDT
 26m 19s
Fix converse_id display and standardize timestamp formats across â€¦
Deploy to AWS #13: Commit e965a03 pushed by Petersomond1
main	
Sep 14, 10:37 AM EDT
 25m 52s
Implement complete CI/CD pipeline with HTTPS production deployment â€¦
Deploy to AWS #12: Commit a210f8c pushed by Petersomond1
main	
Sep 9, 4:57 PM EDT
 19m 36s
Fix deployment workflow and client nginx configuration
Deploy to AWS #11: Commit c36886b pushed by Petersomond1
main	
Sep 9, 3:47 PM EDT
 17m 49s
Fix client nginx configuration to proxy to ALB instead of local hostnâ€¦
Deploy to AWS #10: Commit 0f52853 pushed by Petersomond1
main	
Sep 9, 3:29 PM EDT
 9m 52s
Fix deployment: Add security group rules for database connectivity
Deploy to AWS #9: Commit 73eb908 pushed by Petersomond1
main	
Sep 9, 2:30 PM EDT
 14m 24s
Trigger deployment with ALB integration
Deploy to AWS #8: Commit 249068b pushed by Petersomond1
main	
Sep 9, 8:58 AM EDT
 13m 36s
Fix all critical ESLint errors - ready for AWS deployment
Deploy to AWS #7: Commit b71cb0f pushed by Petersomond1
main	
Sep 9, 5:27 AM EDT
 13m 40s
Fix all critical React Hooks and ESLint errors for deployment
Deploy to AWS #6: Commit a21e9e7 pushed by Petersomond1
main	
Sep 9, 4:44 AM EDT
 37s
Fix critical React Hooks and ESLint errors for deployment
Deploy to AWS #5: Commit c066821 pushed by Petersomond1
main	
Sep 9, 4:34 AM EDT
 41s
Fix ESLint errors to enable â”‚
Deploy to AWS #4: Commit 2e686af pushed by Petersomond1
main	
Sep 9, 4:02 AM EDT
 45s
Update README - trigger deployment with ECS infrastructure ready
Deploy to AWS #3: Commit 0457f94 pushed by Petersomond1
main	
Sep 9, 3:40 AM EDT
 46s
Update AWS infrastructure: ECS services and task definitions ready for
Deploy to AWS #2: Commit 91f1e3f pushed by Petersomond1
main	
Sep 9, 3:29 AM EDT
 38s
Configure Docker for AWS deployment with RDS connection to existing aâ€¦
Deploy to AWS #1: Commit d971ae9 pushed by Petersomond1
main	
Sep 9, 3:12 AM EDT
 44s




XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

.github/workflows/deploy.yml

name: Deploy to AWS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY_API: ikoota-api
  ECR_REPOSITORY_CLIENT: ikoota-client

jobs:
  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          ikootaapi/package-lock.json
          ikootaclient/package-lock.json

    # Test and build API
    - name: Install API dependencies
      working-directory: ./ikootaapi
      run: npm ci

    - name: Lint API code
      working-directory: ./ikootaapi
      run: npm run lint || echo "No lint script found, skipping..."

    - name: Test API
      working-directory: ./ikootaapi
      run: npm test || echo "No test script found, skipping..."

    # Test and build Client
    - name: Install Client dependencies
      working-directory: ./ikootaclient
      run: npm ci

    - name: Lint Client code
      working-directory: ./ikootaclient
      run: npm run lint

    - name: Build Client
      working-directory: ./ikootaclient
      run: npm run build

    # Security scanning
    - name: Run security audit on API
      working-directory: ./ikootaapi
      run: npm audit --audit-level=high || true

    - name: Run security audit on Client  
      working-directory: ./ikootaclient
      run: npm audit --audit-level=high || true

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: test-and-build
    if: github.ref == 'refs/heads/main'
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build and push API image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "ðŸ”¨ Building API image with SHA: $IMAGE_TAG"
        docker build --no-cache -t $ECR_REGISTRY/$ECR_REPOSITORY_API:$IMAGE_TAG ./ikootaapi
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY_API:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY_API:latest
        docker push $ECR_REGISTRY/$ECR_REPOSITORY_API:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY_API:latest

    - name: Build and push Client image (staging)
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "ðŸ”¨ Building CLIENT image for staging with SHA: $IMAGE_TAG"
        docker build --no-cache --build-arg ENVIRONMENT=staging -t $ECR_REGISTRY/$ECR_REPOSITORY_CLIENT:$IMAGE_TAG-staging ./ikootaclient
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY_CLIENT:$IMAGE_TAG-staging $ECR_REGISTRY/$ECR_REPOSITORY_CLIENT:latest-staging
        docker push $ECR_REGISTRY/$ECR_REPOSITORY_CLIENT:$IMAGE_TAG-staging
        docker push $ECR_REGISTRY/$ECR_REPOSITORY_CLIENT:latest-staging

    - name: Deploy to ECS Staging
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        # Skip staging task definition updates - use simple force deployment for now
        echo "ðŸš€ Forcing staging deployments with latest images..."

        # Update ECS services with force new deployment (will use latest image tags)
        aws ecs update-service \
          --cluster ikoota-staging \
          --service ikoota-api-staging \
          --force-new-deployment || echo "âš ï¸ Staging API service update failed, continuing..."

        aws ecs update-service \
          --cluster ikoota-staging \
          --service ikoota-client-staging \
          --force-new-deployment || echo "âš ï¸ Staging CLIENT service update failed, continuing..."

    - name: Wait for deployment
      run: |
        # Use shorter timeout to avoid GitHub Actions timeout
        timeout 600 aws ecs wait services-stable \
          --cluster ikoota-staging \
          --services ikoota-api-staging ikoota-client-staging || echo "Services may still be stabilizing but continuing..."

    - name: Run health checks
      run: |
        # Wait for services to be healthy
        sleep 60
        
        # Check API health through ALB (staging uses same ALB, different target group)
        curl -f http://api.staging.ikoota.com/api/health || exit 1
        
        # Check Client health  
        curl -f http://staging.ikoota.com/ || exit 1

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build and push Client image (production)
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "ðŸ”¨ Building CLIENT image for production with SHA: $IMAGE_TAG"
        docker build --no-cache --build-arg ENVIRONMENT=production -t $ECR_REGISTRY/$ECR_REPOSITORY_CLIENT:$IMAGE_TAG-production ./ikootaclient

        # Verify the build contains new code by checking build timestamp
        echo "ðŸ” Verifying new build..."
        docker run --rm $ECR_REGISTRY/$ECR_REPOSITORY_CLIENT:$IMAGE_TAG-production find /usr/share/nginx/html -name "index-*.js" -exec stat {} \;

        docker tag $ECR_REGISTRY/$ECR_REPOSITORY_CLIENT:$IMAGE_TAG-production $ECR_REGISTRY/$ECR_REPOSITORY_CLIENT:latest-production

        echo "ðŸ“¤ Pushing images to ECR..."
        docker push $ECR_REGISTRY/$ECR_REPOSITORY_CLIENT:$IMAGE_TAG-production
        docker push $ECR_REGISTRY/$ECR_REPOSITORY_CLIENT:latest-production

        echo "âœ… Production image build and push completed: $IMAGE_TAG-production"

    - name: Deploy to ECS Production
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        # Update API task definition with new SHA-tagged image
        API_TASK_DEFINITION=$(aws ecs describe-task-definition --task-definition ikoota-api --query 'taskDefinition')
        NEW_API_IMAGE="$ECR_REGISTRY/$ECR_REPOSITORY_API:$IMAGE_TAG"
        UPDATED_API_TASK_DEFINITION=$(echo $API_TASK_DEFINITION | jq --arg IMAGE "$NEW_API_IMAGE" '.containerDefinitions[0].image = $IMAGE | del(.taskDefinitionArn) | del(.revision) | del(.status) | del(.requiresAttributes) | del(.placementConstraints) | del(.compatibilities) | del(.registeredAt) | del(.registeredBy)')

        # Register new API task definition and capture ARN
        API_TASK_DEF_ARN=$(aws ecs register-task-definition --cli-input-json "$UPDATED_API_TASK_DEFINITION" --query 'taskDefinition.taskDefinitionArn' --output text)
        echo "âœ… Registered new API task definition: $API_TASK_DEF_ARN"

        # Update CLIENT task definition with new SHA-tagged image
        CLIENT_TASK_DEFINITION=$(aws ecs describe-task-definition --task-definition ikoota-client --query 'taskDefinition')
        NEW_CLIENT_IMAGE="$ECR_REGISTRY/$ECR_REPOSITORY_CLIENT:$IMAGE_TAG-production"
        UPDATED_CLIENT_TASK_DEFINITION=$(echo $CLIENT_TASK_DEFINITION | jq --arg IMAGE "$NEW_CLIENT_IMAGE" '.containerDefinitions[0].image = $IMAGE | del(.taskDefinitionArn) | del(.revision) | del(.status) | del(.requiresAttributes) | del(.placementConstraints) | del(.compatibilities) | del(.registeredAt) | del(.registeredBy)')

        # Register new CLIENT task definition and capture ARN
        CLIENT_TASK_DEF_ARN=$(aws ecs register-task-definition --cli-input-json "$UPDATED_CLIENT_TASK_DEFINITION" --query 'taskDefinition.taskDefinitionArn' --output text)
        echo "âœ… Registered new CLIENT task definition: $CLIENT_TASK_DEF_ARN"

        # Update ECS services to use specific new task definition revisions
        echo "ðŸš€ Updating API service with new task definition..."
        aws ecs update-service \
          --cluster ikoota-production \
          --service ikoota-api-production \
          --task-definition "$API_TASK_DEF_ARN" \
          --force-new-deployment

        echo "ðŸš€ Updating CLIENT service with new task definition..."
        aws ecs update-service \
          --cluster ikoota-production \
          --service ikoota-client-production \
          --task-definition "$CLIENT_TASK_DEF_ARN" \
          --force-new-deployment

    - name: Wait for production deployment
      run: |
        # Use shorter timeout to avoid GitHub Actions timeout
        timeout 600 aws ecs wait services-stable \
          --cluster ikoota-production \
          --services ikoota-api-production ikoota-client-production || echo "Services may still be stabilizing but continuing..."

    - name: Run production health checks
      run: |
        sleep 60
        # Test HTTPS API endpoint through frontend nginx proxy (correct architecture)
        curl -f https://www.ikoota.com/api/health || exit 1
        # Test HTTPS client site on port 443 (default)
        curl -f https://ikoota.com/ || exit 1
        # Also test www subdomain
        curl -f https://www.ikoota.com/ || exit 1

    - name: Notify deployment success
      if: success()
      run: |
        echo "ðŸš€ Production deployment successful!"
        echo "ðŸ” API: https://www.ikoota.com/api/health (through nginx proxy)"
        echo "ðŸ” Client: https://ikoota.com"
        echo "ðŸ” Client (www): https://www.ikoota.com"
        echo "ðŸ”“ Staging: http://staging.ikoota.com (for development)"

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: failure()
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Rollback ECS services
      run: |
        echo "ðŸ”„ Rolling back to previous deployment..."
        
        # Get previous task definition ARN
        PREV_TASK_DEF=$(aws ecs describe-services \
          --cluster ikoota-production \
          --services ikoota-api-production \
          --query 'services[0].deployments[1].taskDefinition' \
          --output text)
        
        # Rollback to previous version
        aws ecs update-service \
          --cluster ikoota-production \
          --service ikoota-api-production \
          --task-definition $PREV_TASK_DEF


          XXXXXXXXXXXXXXXXXXXXXXXXXXX

          THis are the first four deployment that succeeded! 

          Trigger frontend deployment: Deploy converse_id display and timestampâ€¦
Deploy to AWS #15: Commit 22e1342 pushed by Petersomond1
main	
Sep 14, 7:34 PM EDT
 26m 24s
Fix login authentication: Remove converse_id dependency from JWT and â€¦
Deploy to AWS #14: Commit 7140ebc pushed by Petersomond1
main	
Sep 14, 4:32 PM EDT
 26m 19s
Fix converse_id display and standardize timestamp formats across â€¦
Deploy to AWS #13: Commit e965a03 pushed by Petersomond1
main	
Sep 14, 10:37 AM EDT
 25m 52s
Implement complete CI/CD pipeline with HTTPS production deployment â€¦
Deploy to AWS #12: Commit a210f8c pushed by Petersomond1
main	
Sep 9, 4:57 PM EDT
 19m 36s  



 Which of these would you like to see deeper ?



 6s
Run npm run build
  npm run build
  shell: /usr/bin/bash -e {0}
  env:
    AWS_REGION: us-east-1
    ECR_REPOSITORY_API: ikoota-api
    ECR_REPOSITORY_CLIENT: ikoota-client

> ikootaclient@0.0.0 build
> vite build

vite v6.0.6 building for production...
transforming...
âœ“ 309 modules transformed.
rendering chunks...
computing gzip size...
dist/index.html                          0.46 kB â”‚ gzip:   0.29 kB
dist/assets/sky-C-eMabB2.png         1,221.96 kB
dist/assets/index-7chQAR6T.css         350.67 kB â”‚ gzip:  57.11 kB
dist/assets/Mixcloud-ZB4xYTE5.js         2.75 kB â”‚ gzip:   1.35 kB â”‚ map:     8.05 kB
dist/assets/Kaltura-oxByuN4Y.js          2.90 kB â”‚ gzip:   1.39 kB â”‚ map:     8.41 kB
dist/assets/Vidyard-D44Y6rbH.js          2.96 kB â”‚ gzip:   1.41 kB â”‚ map:     8.71 kB
dist/assets/SoundCloud-CIczyi4V.js       3.03 kB â”‚ gzip:   1.44 kB â”‚ map:     8.94 kB
dist/assets/Streamable-lJR_cBs5.js       3.04 kB â”‚ gzip:   1.41 kB â”‚ map:     8.64 kB
dist/assets/DailyMotion-CbxzsKXa.js      3.07 kB â”‚ gzip:   1.46 kB â”‚ map:     9.07 kB
dist/assets/Preview-C8PKLbC0.js          3.11 kB â”‚ gzip:   1.52 kB â”‚ map:     8.92 kB
dist/assets/Twitch-DrO4dEEG.js           3.19 kB â”‚ gzip:   1.50 kB â”‚ map:     9.26 kB
dist/assets/Facebook-C8uAbaDy.js         3.32 kB â”‚ gzip:   1.52 kB â”‚ map:     9.31 kB
dist/assets/Wistia-YXl80GJS.js           3.62 kB â”‚ gzip:   1.61 kB â”‚ map:    10.34 kB
dist/assets/Vimeo-BqaRJlaH.js            3.73 kB â”‚ gzip:   1.59 kB â”‚ map:    10.66 kB
dist/assets/YouTube-HJowXN47.js          4.55 kB â”‚ gzip:   2.13 kB â”‚ map:    13.94 kB
dist/assets/Mux-4bZD8AiF.js              5.46 kB â”‚ gzip:   2.01 kB â”‚ map:    14.67 kB

(!) Some chunks are larger than 500 kB after minification. Consider:
- Using dynamic import() to code-split the application
- Use build.rollupOptions.output.manualChunks to improve chunking: https://rollupjs.org/configuration-options/#output-manualchunks
- Adjust chunk size limit for this warning via build.chunkSizeWarningLimit.
dist/assets/FilePlayer-C_fikteS.js       9.15 kB â”‚ gzip:   3.16 kB â”‚ map:    24.88 kB
dist/assets/index-zjJahbYl.js        1,361.60 kB â”‚ gzip: 359.63 kB â”‚ map: 4,525.61 kB
âœ“ built in 5.32s
1s
Run npm audit --audit-level=high || true
  npm audit --audit-level=high || true
  shell: /usr/bin/bash -e {0}
  env:
    AWS_REGION: us-east-1
    ECR_REPOSITORY_API: ikoota-api
    ECR_REPOSITORY_CLIENT: ikoota-client
# npm audit report

node-fetch  <=2.6.6
Severity: high
node-fetch forwards secure headers to untrusted sites - https://github.com/advisories/GHSA-r683-j2x4-v87g
The `size` option isn't honored after following a redirect in node-fetch - https://github.com/advisories/GHSA-w7rc-rwvf-8q5r
fix available via `npm audit fix --force`
Will install face-api.js@0.20.0, which is a breaking change
node_modules/face-api.js/node_modules/node-fetch
  @tensorflow/tfjs-core  1.1.0 - 2.4.0
  Depends on vulnerable versions of node-fetch
  node_modules/face-api.js/node_modules/@tensorflow/tfjs-core
    face-api.js  >=0.20.1
    Depends on vulnerable versions of @tensorflow/tfjs-core
    node_modules/face-api.js

3 vulnerabilities (2 low, 1 high)

To address all issues (including breaking changes), run:
  npm audit fix --force
1s
Run npm audit --audit-level=high || true
  npm audit --audit-level=high || true
  shell: /usr/bin/bash -e {0}
  env:
    AWS_REGION: us-east-1
    ECR_REPOSITORY_API: ikoota-api
    ECR_REPOSITORY_CLIENT: ikoota-client
# npm audit report

@babel/helpers  <7.26.10
Severity: moderate
Babel has inefficient RegExp complexity in generated code with .replace when transpiling named capturing groups - https://github.com/advisories/GHSA-968p-4wvh-cqc8
fix available via `npm audit fix`
node_modules/@babel/helpers

@eslint/plugin-kit  <0.3.4
@eslint/plugin-kit is vulnerable to Regular Expression Denial of Service attacks through ConfigCommentParser - https://github.com/advisories/GHSA-xffm-g5w8-qvg7
fix available via `npm audit fix`
node_modules/@eslint/plugin-kit
  eslint  9.10.0 - 9.26.0
  Depends on vulnerable versions of @eslint/plugin-kit
  node_modules/eslint

axios  <=1.11.0
Severity: high
axios Requests Vulnerable To Possible SSRF and Credential Leakage via Absolute URL - https://github.com/advisories/GHSA-jr5f-v2jv-69x6
Axios is vulnerable to DoS attack through lack of data size check - https://github.com/advisories/GHSA-4hjh-wcwx-xvwj
fix available via `npm audit fix`
node_modules/axios

brace-expansion  1.0.0 - 1.1.11
brace-expansion Regular Expression Denial of Service vulnerability - https://github.com/advisories/GHSA-v6h2-p8h4-qcjw
fix available via `npm audit fix`
node_modules/brace-expansion

dompurify  <3.2.4
Severity: moderate
DOMPurify allows Cross-site Scripting (XSS) - https://github.com/advisories/GHSA-vhxf-7vqr-mrjg
fix available via `npm audit fix`
node_modules/dompurify

esbuild  <=0.24.2
Severity: moderate
esbuild enables any website to send any requests to the development server and read the response - https://github.com/advisories/GHSA-67mh-4wv8-2f99
fix available via `npm audit fix`
node_modules/esbuild
  vite  0.11.0 - 6.3.5
  Depends on vulnerable versions of esbuild
  node_modules/vite

form-data  4.0.0 - 4.0.3
Severity: critical
form-data uses unsafe random function in form-data for choosing boundary - https://github.com/advisories/GHSA-fjxv-7rqg-78g4
fix available via `npm audit fix`
node_modules/form-data

react-router  >=7.0 <=7.5.1
Severity: high
React Router allows pre-render data spoofing on React-Router framework mode - https://github.com/advisories/GHSA-cpj6-fhp6-mr6j
fix available via `npm audit fix`
node_modules/react-router
  react-router-dom  7.0.0-pre.0 - 7.5.1
  Depends on vulnerable versions of react-router
  node_modules/react-router-dom


11 vulnerabilities (3 low, 4 moderate, 3 high, 1 critical)

To address all issues, run:
  npm audit fix
0s
Post job cleanup.
Cache hit occurred on the primary key node-cache-Linux-x64-npm-df254174bdeef4ffa4a7e8774b453a1a82e7cf33d5022a399d1155e8c70c2cc8, not saving cache.



XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX   


env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY_API: ikoota-api
  ECR_REPOSITORY_CLIENT: ikoota-client

jobs:
  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          ikootaapi/package-lock.json
          ikootaclient/package-lock.json

    # Test and build API
    - name: Install API dependencies
      working-directory: ./ikootaapi
:
name: Deploy to AWS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY_API: ikoota-api
  ECR_REPOSITORY_CLIENT: ikoota-client

jobs:
  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          ikootaapi/package-lock.json
          ikootaclient/package-lock.json

    # Test and build API
    - name: Install API dependencies
      working-directory: ./ikootaapi
      run: npm ci

:
name: Deploy to AWS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY_API: ikoota-api
  ECR_REPOSITORY_CLIENT: ikoota-client

jobs:
  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          ikootaapi/package-lock.json
          ikootaclient/package-lock.json

    # Test and build API
    - name: Install API dependencies
      working-directory: ./ikootaapi
      run: npm ci

    - name: Lint API code
:
name: Deploy to AWS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY_API: ikoota-api
  ECR_REPOSITORY_CLIENT: ikoota-client

jobs:
  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          ikootaapi/package-lock.json
          ikootaclient/package-lock.json

    # Test and build API
    - name: Install API dependencies
      working-directory: ./ikootaapi
      run: npm ci

    - name: Lint API code
      working-directory: ./ikootaapi
      run: npm run lint || echo "No lint script found, skipping..."
:
name: Deploy to AWS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY_API: ikoota-api
  ECR_REPOSITORY_CLIENT: ikoota-client

jobs:
  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          ikootaapi/package-lock.json
          ikootaclient/package-lock.json

    # Test and build API
    - name: Install API dependencies
      working-directory: ./ikootaapi
      run: npm ci

    - name: Lint API code
      working-directory: ./ikootaapi
      run: npm run lint || echo "No lint script found, skipping..."

:
name: Deploy to AWS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY_API: ikoota-api
  ECR_REPOSITORY_CLIENT: ikoota-client

jobs:
  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          ikootaapi/package-lock.json
          ikootaclient/package-lock.json

    # Test and build API
    - name: Install API dependencies
      working-directory: ./ikootaapi
      run: npm ci

    - name: Lint API code
      working-directory: ./ikootaapi
      run: npm run lint || echo "No lint script found, skipping..."

    - name: Test API
:
name: Deploy to AWS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY_API: ikoota-api
  ECR_REPOSITORY_CLIENT: ikoota-client

jobs:
  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          ikootaapi/package-lock.json
          ikootaclient/package-lock.json

    # Test and build API
    - name: Install API dependencies
      working-directory: ./ikootaapi
      run: npm ci

    - name: Lint API code
      working-directory: ./ikootaapi
      run: npm run lint || echo "No lint script found, skipping..."

    - name: Test API
      working-directory: ./ikootaapi
:
name: Deploy to AWS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY_API: ikoota-api
  ECR_REPOSITORY_CLIENT: ikoota-client

jobs:
  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          ikootaapi/package-lock.json
          ikootaclient/package-lock.json

    # Test and build API
    - name: Install API dependencies
      working-directory: ./ikootaapi
      run: npm ci

    - name: Lint API code
      working-directory: ./ikootaapi
      run: npm run lint || echo "No lint script found, skipping..."

    - name: Test API
      working-directory: ./ikootaapi
      run: npm test || echo "No test script found, skipping..."
:
name: Deploy to AWS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY_API: ikoota-api
  ECR_REPOSITORY_CLIENT: ikoota-client

jobs:
  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          ikootaapi/package-lock.json
          ikootaclient/package-lock.json

    # Test and build API
    - name: Install API dependencies
      working-directory: ./ikootaapi
      run: npm ci

    - name: Lint API code
      working-directory: ./ikootaapi
      run: npm run lint || echo "No lint script found, skipping..."

    - name: Test API
      working-directory: ./ikootaapi
      run: npm test || echo "No test script found, skipping..."

:
name: Deploy to AWS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY_API: ikoota-api
  ECR_REPOSITORY_CLIENT: ikoota-client

jobs:
  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          ikootaapi/package-lock.json
          ikootaclient/package-lock.json

    # Test and build API
    - name: Install API dependencies
      working-directory: ./ikootaapi
      run: npm ci

    - name: Lint API code
      working-directory: ./ikootaapi
      run: npm run lint || echo "No lint script found, skipping..."

    - name: Test API
      working-directory: ./ikootaapi
      run: npm test || echo "No test script found, skipping..."

    # Test and build Client
:
name: Deploy to AWS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY_API: ikoota-api
  ECR_REPOSITORY_CLIENT: ikoota-client

jobs:
  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          ikootaapi/package-lock.json
          ikootaclient/package-lock.json

    # Test and build API
    - name: Install API dependencies
      working-directory: ./ikootaapi
      run: npm ci

    - name: Lint API code
      working-directory: ./ikootaapi
      run: npm run lint || echo "No lint script found, skipping..."

    - name: Test API
      working-directory: ./ikootaapi
      run: npm test || echo "No test script found, skipping..."

    # Test and build Client
    - name: Install Client dependencies
:
name: Deploy to AWS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY_API: ikoota-api
  ECR_REPOSITORY_CLIENT: ikoota-client

jobs:
  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          ikootaapi/package-lock.json
          ikootaclient/package-lock.json

    # Test and build API
    - name: Install API dependencies
      working-directory: ./ikootaapi
      run: npm ci

    - name: Lint API code
      working-directory: ./ikootaapi
      run: npm run lint || echo "No lint script found, skipping..."

    - name: Test API
      working-directory: ./ikootaapi
      run: npm test || echo "No test script found, skipping..."

    # Test and build Client
    - name: Install Client dependencies
      working-directory: ./ikootaclient
:
name: Deploy to AWS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY_API: ikoota-api
  ECR_REPOSITORY_CLIENT: ikoota-client

jobs:
  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          ikootaapi/package-lock.json
          ikootaclient/package-lock.json

    # Test and build API
    - name: Install API dependencies
      working-directory: ./ikootaapi
      run: npm ci

    - name: Lint API code
      working-directory: ./ikootaapi
      run: npm run lint || echo "No lint script found, skipping..."

    - name: Test API
      working-directory: ./ikootaapi
      run: npm test || echo "No test script found, skipping..."

    # Test and build Client
    - name: Install Client dependencies
      working-directory: ./ikootaclient
      run: npm ci
:
name: Deploy to AWS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY_API: ikoota-api
  ECR_REPOSITORY_CLIENT: ikoota-client

jobs:
  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          ikootaapi/package-lock.json
          ikootaclient/package-lock.json

    # Test and build API
    - name: Install API dependencies
      working-directory: ./ikootaapi
      run: npm ci

    - name: Lint API code
      working-directory: ./ikootaapi
      run: npm run lint || echo "No lint script found, skipping..."

    - name: Test API
      working-directory: ./ikootaapi
      run: npm test || echo "No test script found, skipping..."

    # Test and build Client
    - name: Install Client dependencies
      working-directory: ./ikootaclient
      run: npm ci

:
name: Deploy to AWS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY_API: ikoota-api
  ECR_REPOSITORY_CLIENT: ikoota-client

jobs:
  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          ikootaapi/package-lock.json
          ikootaclient/package-lock.json

    # Test and build API
    - name: Install API dependencies
      working-directory: ./ikootaapi
      run: npm ci

    - name: Lint API code
      working-directory: ./ikootaapi
      run: npm run lint || echo "No lint script found, skipping..."

    - name: Test API
      working-directory: ./ikootaapi
      run: npm test || echo "No test script found, skipping..."

    # Test and build Client
    - name: Install Client dependencies
      working-directory: ./ikootaclient
      run: npm ci

    - name: Lint Client code
:
name: Deploy to AWS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY_API: ikoota-api
  ECR_REPOSITORY_CLIENT: ikoota-client

jobs:
  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          ikootaapi/package-lock.json
          ikootaclient/package-lock.json

    # Test and build API
    - name: Install API dependencies
      working-directory: ./ikootaapi
      run: npm ci

    - name: Lint API code
      working-directory: ./ikootaapi
      run: npm run lint || echo "No lint script found, skipping..."

    - name: Test API
      working-directory: ./ikootaapi
      run: npm test || echo "No test script found, skipping..."

    # Test and build Client
    - name: Install Client dependencies
      working-directory: ./ikootaclient
      run: npm ci

    - name: Lint Client code
      working-directory: ./ikootaclient
:
name: Deploy to AWS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY_API: ikoota-api
  ECR_REPOSITORY_CLIENT: ikoota-client

jobs:
  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          ikootaapi/package-lock.json
          ikootaclient/package-lock.json

    # Test and build API
    - name: Install API dependencies
      working-directory: ./ikootaapi
      run: npm ci

    - name: Lint API code
      working-directory: ./ikootaapi
      run: npm run lint || echo "No lint script found, skipping..."

    - name: Test API
      working-directory: ./ikootaapi
      run: npm test || echo "No test script found, skipping..."

    # Test and build Client
    - name: Install Client dependencies
      working-directory: ./ikootaclient
      run: npm ci

    - name: Lint Client code
      working-directory: ./ikootaclient
      run: npm run lint
:
name: Deploy to AWS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY_API: ikoota-api
  ECR_REPOSITORY_CLIENT: ikoota-client

jobs:
  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          ikootaapi/package-lock.json
          ikootaclient/package-lock.json

    # Test and build API
    - name: Install API dependencies
      working-directory: ./ikootaapi
      run: npm ci

    - name: Lint API code
      working-directory: ./ikootaapi
      run: npm run lint || echo "No lint script found, skipping..."

    - name: Test API
      working-directory: ./ikootaapi
      run: npm test || echo "No test script found, skipping..."

    # Test and build Client
    - name: Install Client dependencies
      working-directory: ./ikootaclient
      run: npm ci

    - name: Lint Client code
      working-directory: ./ikootaclient
      run: npm run lint

    - name: Build Client
      working-directory: ./ikootaclient
      run: npm run build

    # Security scanning
    - name: Run security audit on API
      working-directory: ./ikootaapi
      run: npm audit --audit-level=high || true

    - name: Run security audit on Client
      working-directory: ./ikootaclient
      run: npm audit --audit-level=high || true

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: test-and-build
    if: github.ref == 'refs/heads/main'
    environment: staging

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build and push API image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY_API:$IMAGE_TAG ./ikootaapi
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY_API:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY_API:latest
        docker push $ECR_REGISTRY/$ECR_REPOSITORY_API:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY_API:latest

    - name: Build and push Client image (staging)
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker build --build-arg ENVIRONMENT=staging -t $ECR_REGISTRY/$ECR_REPOSITORY_CLIENT:$IMAGE_TAG-staging ./ikootaclient
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY_CLIENT:$IMAGE_TAG-staging $ECR_REGISTRY/$ECR_REPOSITORY_CLIENT:latest-staging
        docker push $ECR_REGISTRY/$ECR_REPOSITORY_CLIENT:$IMAGE_TAG-staging
        docker push $ECR_REGISTRY/$ECR_REPOSITORY_CLIENT:latest-staging

    - name: Deploy to ECS Staging
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        # Update ECS service with new image
        aws ecs update-service \
          --cluster ikoota-staging \
          --service ikoota-api-staging \
          --force-new-deployment

        aws ecs update-service \
          --cluster ikoota-staging \
          --service ikoota-client-staging \
          --force-new-deployment

    - name: Wait for deployment
      run: |
        # Use shorter timeout to avoid GitHub Actions timeout
        timeout 600 aws ecs wait services-stable \
          --cluster ikoota-staging \
          --services ikoota-api-staging ikoota-client-staging || echo "Services may still be stabilizing but continuing..."

    - name: Run health checks
      run: |
        # Wait for services to be healthy
        sleep 60

        # Check API health
        curl -f http://api.staging.ikoota.com:8080/api/health || exit 1

        # Check Client health
        curl -f http://staging.ikoota.com/ || exit 1

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build and push Client image (production)
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker build --build-arg ENVIRONMENT=production -t $ECR_REGISTRY/$ECR_REPOSITORY_CLIENT:$IMAGE_TAG-production ./ikootaclient
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY_CLIENT:$IMAGE_TAG-production $ECR_REGISTRY/$ECR_REPOSITORY_CLIENT:latest-production
        docker push $ECR_REGISTRY/$ECR_REPOSITORY_CLIENT:$IMAGE_TAG-production
        docker push $ECR_REGISTRY/$ECR_REPOSITORY_CLIENT:latest-production

    - name: Deploy to ECS Production
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        # Update task definition with new image
        aws ecs update-service \
          --cluster ikoota-production \
          --service ikoota-api-production \
          --force-new-deployment

        aws ecs update-service \
          --cluster ikoota-production \
          --service ikoota-client-production \
          --force-new-deployment

    - name: Wait for production deployment
      run: |
        # Use shorter timeout to avoid GitHub Actions timeout
        timeout 600 aws ecs wait services-stable \
          --cluster ikoota-production \
          --services ikoota-api-production ikoota-client-production || echo "Services may still be stabilizing but continuing..."

    - name: Run production health checks
      run: |
        sleep 60
        # Test HTTPS API endpoint on port 8443
        curl -f https://api.ikoota.com:8443/api/health || exit 1
        # Test HTTPS client site on port 443 (default)
        curl -f https://ikoota.com/ || exit 1
        # Also test www subdomain
        curl -f https://www.ikoota.com/ || exit 1

    - name: Notify deployment success
      if: success()
      run: |
        echo "ðŸš€ Production deployment successful!"
        echo "ðŸ” API: https://api.ikoota.com:8443/api/health"
        echo "ðŸ” Client: https://ikoota.com"
        echo "ðŸ” Client (www): https://www.ikoota.com"
        echo "ðŸ”“ Staging: http://staging.ikoota.com (for development)"

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: failure()

    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Rollback ECS services
      run: |
        echo "ðŸ”„ Rolling back to previous deployment..."

        # Get previous task definition ARN
        PREV_TASK_DEF=$(aws ecs describe-services \
          --cluster ikoota-production \
          --services ikoota-api-production \
          --query 'services[0].deployments[1].taskDefinition' \
          --output text)

        # Rollback to previous version
        aws ecs update-service \
          --cluster ikoota-production \
          --service ikoota-api-production \
          --task-definition $PREV_TASK_DEF
(END)
        # Use shorter timeout to avoid GitHub Actions timeout
        timeout 600 aws ecs wait services-stable \
          --cluster ikoota-production \
          --services ikoota-api-production ikoota-client-production || echo "Services may still be stabilizing but continuing..."

    - name: Run production health checks
      run: |
        sleep 60
        # Test HTTPS API endpoint on port 8443
        curl -f https://api.ikoota.com:8443/api/health || exit 1
        # Test HTTPS client site on port 443 (default)
        curl -f https://ikoota.com/ || exit 1
        # Also test www subdomain
        curl -f https://www.ikoota.com/ || exit 1

    - name: Notify deployment success
      if: success()
      run: |
        echo "ðŸš€ Production deployment successful!"
        echo "ðŸ” API: https://api.ikoota.com:8443/api/health"
        echo "ðŸ” Client: https://ikoota.com"
        echo "ðŸ” Client (www): https://www.ikoota.com"
        echo "ðŸ”“ Staging: http://staging.ikoota.com (for development)"

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: failure()

    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Rollback ECS services
      run: |
        echo "ðŸ”„ Rolling back to previous deployment..."

        # Get previous task definition ARN
        PREV_TASK_DEF=$(aws ecs describe-services \
          --cluster ikoota-production \
          --services ikoota-api-production \
          --query 'services[0].deployments[1].taskDefinition' \
          --output text)

        # Rollback to previous version
        aws ecs update-service \
          --cluster ikoota-production \
          --service ikoota-api-production \
          --task-definition $PREV_TASK_DEF
(END)
