<!DOCTYPE html>
<html>
<head>
    <title>Test Nginx Proxy Architecture</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; background: #007bff; color: white; }
        button:hover { background: #0056b3; }
        textarea { width: 100%; height: 200px; font-family: monospace; font-size: 12px; }
        .architecture { background: #e9ecef; padding: 15px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🏗️ Nginx Proxy Architecture Test</h1>

        <div class="architecture">
            <h3>🔧 Expected Architecture:</h3>
            <p><strong>1. Frontend (www.ikoota.com):</strong> Makes calls to <code>/api/...</code></p>
            <p><strong>2. Nginx Proxy:</strong> Routes <code>/api/</code> → <code>https://api.ikoota.com:8443</code></p>
            <p><strong>3. ALB/Backend:</strong> Serves API on <code>api.ikoota.com:8443</code></p>
        </div>

        <div>
            <button onclick="testDirectAPI()">Test Direct API (Should Work)</button>
            <button onclick="testProxySimulation()">Test Proxy Simulation</button>
            <button onclick="testLoginFlow()">Test Complete Login Flow</button>
            <button onclick="runComprehensiveTest()">🚀 Run All Tests</button>
        </div>

        <div id="results"></div>

        <h3>📊 Test Results</h3>
        <textarea id="detailedResults" placeholder="Detailed test results..."></textarea>
    </div>

    <script>
        const results = document.getElementById('results');
        const detailedResults = document.getElementById('detailedResults');

        function addResult(type, message, details = null) {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            results.appendChild(div);

            const logEntry = `[${new Date().toISOString()}] ${type.toUpperCase()}: ${message}`;
            detailedResults.value += logEntry + '\n';

            if (details) {
                detailedResults.value += `  Details: ${JSON.stringify(details, null, 2)}\n`;
            }

            results.scrollTop = results.scrollHeight;
        }

        async function testDirectAPI() {
            addResult('info', '🔍 Testing direct API access...');

            try {
                // Test direct API health
                const response = await fetch('https://api.ikoota.com:8443/api/health');
                const data = await response.json();

                if (response.ok) {
                    addResult('success', '✅ Direct API access working');

                    // Check for our features
                    const healthStr = JSON.stringify(data).toLowerCase();
                    if (healthStr.includes('converse') || healthStr.includes('identity')) {
                        addResult('success', '✅ Converse ID system detected in API');
                    } else {
                        addResult('warning', '⚠️ Converse ID system not detected');
                    }

                    if (healthStr.includes('class') && healthStr.includes('management')) {
                        addResult('success', '✅ Class management system active');
                    }
                } else {
                    addResult('error', `❌ Direct API failed: ${response.status}`);
                }

                addResult('info', 'API Health Response', data);

            } catch (error) {
                addResult('error', `❌ Direct API error: ${error.message}`);
            }
        }

        async function testProxySimulation() {
            addResult('info', '🔄 Testing proxy simulation...');
            addResult('warning', '⚠️ This simulates what nginx should do');

            // Since we can't actually test the nginx proxy from here,
            // we'll test if the backend is ready for proxy requests
            try {
                const response = await fetch('https://api.ikoota.com:8443/api/health', {
                    headers: {
                        'X-Forwarded-For': '192.168.1.1',
                        'X-Forwarded-Proto': 'https',
                        'X-Real-IP': '192.168.1.1'
                    }
                });

                if (response.ok) {
                    addResult('success', '✅ Backend ready for proxy headers');
                } else {
                    addResult('error', `❌ Backend proxy test failed: ${response.status}`);
                }

            } catch (error) {
                addResult('error', `❌ Proxy simulation error: ${error.message}`);
            }
        }

        async function testLoginFlow() {
            addResult('info', '🔐 Testing complete login flow...');

            try {
                // Test login endpoint
                const loginResponse = await fetch('https://api.ikoota.com:8443/api/auth/enhanced-login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'petersomond@gmail.com',
                        password: 'abc123'
                    })
                });

                const loginData = await loginResponse.json();

                if (loginResponse.ok && loginData.token) {
                    addResult('success', '✅ Login successful');

                    // Decode JWT
                    try {
                        const payload = JSON.parse(atob(loginData.token.split('.')[1]));

                        if (payload.converse_id) {
                            addResult('success', `✅ JWT contains converse_id: ${payload.converse_id}`);
                        } else {
                            addResult('error', '❌ JWT missing converse_id (CRITICAL ISSUE!)');
                        }

                        // Test authenticated endpoint
                        const dashboardResponse = await fetch('https://api.ikoota.com:8443/api/user/dashboard', {
                            headers: {
                                'Authorization': `Bearer ${loginData.token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (dashboardResponse.ok) {
                            addResult('success', '✅ Authenticated endpoints working');
                        } else {
                            addResult('warning', `⚠️ Dashboard endpoint returned: ${dashboardResponse.status}`);
                        }

                    } catch (jwtError) {
                        addResult('error', `❌ JWT decode error: ${jwtError.message}`);
                    }

                } else {
                    addResult('error', `❌ Login failed: ${loginData.message || 'Unknown error'}`);
                }

                addResult('info', 'Login Response', loginData);

            } catch (error) {
                addResult('error', `❌ Login flow error: ${error.message}`);
            }
        }

        async function runComprehensiveTest() {
            addResult('info', '🚀 Starting comprehensive architecture test...');
            results.innerHTML = '';
            detailedResults.value = '';

            // Test sequence
            await testDirectAPI();
            await new Promise(resolve => setTimeout(resolve, 1000));

            await testProxySimulation();
            await new Promise(resolve => setTimeout(resolve, 1000));

            await testLoginFlow();

            addResult('info', '✅ Comprehensive test completed');

            // Summary
            const errorCount = (detailedResults.value.match(/ERROR:/g) || []).length;
            const successCount = (detailedResults.value.match(/SUCCESS:/g) || []).length;

            if (errorCount === 0) {
                addResult('success', `🎉 All tests passed! (${successCount} successes)`);
            } else {
                addResult('warning', `⚠️ ${errorCount} errors found, ${successCount} successes`);
            }
        }

        // Auto-start
        window.onload = () => {
            addResult('info', '🌐 Page loaded - Architecture test ready');
            addResult('info', '📋 Click "Run All Tests" to verify nginx proxy setup');
        };
    </script>
</body>
</html>