<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ikoota Frontend Login Test</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .container {
            background: #000;
            padding: 20px;
            border: 1px solid #00ff00;
            border-radius: 5px;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-family: inherit;
        }
        button:hover {
            background: #00cc00;
        }
        input {
            background: #333;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 10px;
            margin: 5px;
            width: 300px;
        }
        .log {
            background: #111;
            border: 1px solid #333;
            padding: 15px;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .info { color: #ffff00; }
        .debug { color: #00ffff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Ikoota Frontend Authentication Test</h1>

        <div>
            <h3>Login Credentials:</h3>
            <input type="email" id="email" value="petersomond@gmail.com" placeholder="Email">
            <input type="password" id="password" value="abc123" placeholder="Password">
        </div>

        <div>
            <button onclick="testApiHealth()">üè• Test API Health</button>
            <button onclick="testLogin()">üîê Test Login</button>
            <button onclick="testProtectedRoute()">üõ°Ô∏è Test Protected Route</button>
            <button onclick="clearLog()">üßπ Clear Log</button>
        </div>

        <div>
            <h3>Configuration Test:</h3>
            <button onclick="testApiConfiguration()">‚öôÔ∏è Check API Config</button>
            <button onclick="testCorsAndHeaders()">üåê Test CORS</button>
            <button onclick="simulateReactLogin()">‚öõÔ∏è Simulate React Login Flow</button>
        </div>

        <div id="log" class="log">Ready for testing...\n</div>
    </div>

    <script>
        let storedToken = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = 'Log cleared...\n';
        }

        // Test API configuration - same as the frontend would use
        function testApiConfiguration() {
            log('üîç Testing API Configuration...', 'info');

            // Simulate the frontend API URL determination logic
            const hostname = window.location.hostname;
            log(`Current hostname: ${hostname}`, 'debug');

            let apiUrl;

            // Same logic as in the frontend api.js
            if (hostname === 'www.ikoota.com' || hostname === 'ikoota.com') {
                apiUrl = '/api';
                log('‚úÖ Production domain detected - using nginx proxy: /api', 'success');
            } else if (hostname === 'localhost' || hostname === '127.0.0.1') {
                apiUrl = 'http://localhost:3000/api';
                log('üõ†Ô∏è Localhost detected - using development API: http://localhost:3000/api', 'info');
            } else {
                apiUrl = '/api';
                log('üåê Other domain - defaulting to nginx proxy: /api', 'info');
            }

            log(`Final API URL: ${apiUrl}`, 'success');
            return apiUrl;
        }

        async function testApiHealth() {
            const apiUrl = testApiConfiguration();

            try {
                log('üè• Testing API Health endpoint...', 'info');

                const response = await fetch(`${apiUrl}/health`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                log(`üìä Health Response Status: ${response.status}`, response.ok ? 'success' : 'error');
                log(`üìä Response Headers: ${JSON.stringify(Object.fromEntries(response.headers))}`, 'debug');

                const data = await response.text();
                log(`üìã Health Response Body: ${data.substring(0, 300)}...`, 'debug');

                if (response.ok) {
                    try {
                        const jsonData = JSON.parse(data);
                        log('‚úÖ API Health Check Successful!', 'success');
                        log(`‚úÖ Message: ${jsonData.message}`, 'success');
                    } catch (e) {
                        log('‚ö†Ô∏è Health endpoint returned non-JSON response', 'error');
                    }
                } else {
                    log('‚ùå API Health Check Failed', 'error');
                    if (data.includes('<html') || data.includes('<!DOCTYPE')) {
                        log('üî¥ CRITICAL ISSUE: API returned HTML instead of JSON - Routing/Proxy Problem!', 'error');
                    }
                }

            } catch (error) {
                log(`‚ùå Health Check Error: ${error.message}`, 'error');
            }
        }

        async function testCorsAndHeaders() {
            const apiUrl = testApiConfiguration();

            try {
                log('üåê Testing CORS and Headers...', 'info');

                const response = await fetch(`${apiUrl}/health`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Origin': window.location.origin
                    }
                });

                log(`üìä CORS Status: ${response.status}`, response.ok ? 'success' : 'error');

                // Check CORS headers
                const corsHeaders = {
                    'access-control-allow-origin': response.headers.get('access-control-allow-origin'),
                    'access-control-allow-credentials': response.headers.get('access-control-allow-credentials'),
                    'access-control-allow-methods': response.headers.get('access-control-allow-methods'),
                    'access-control-allow-headers': response.headers.get('access-control-allow-headers')
                };

                log(`üåê CORS Headers: ${JSON.stringify(corsHeaders, null, 2)}`, 'debug');

                if (corsHeaders['access-control-allow-origin']) {
                    log('‚úÖ CORS is configured', 'success');
                } else {
                    log('‚ö†Ô∏è CORS headers not found - may cause frontend issues', 'error');
                }

            } catch (error) {
                log(`‚ùå CORS Test Error: ${error.message}`, 'error');
            }
        }

        async function testLogin() {
            const apiUrl = testApiConfiguration();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                log('üîê Testing Login Flow...', 'info');
                log(`üìß Email: ${email}`, 'debug');
                log(`üîë Password: ${'*'.repeat(password.length)}`, 'debug');

                const loginData = {
                    email: email,
                    password: password
                };

                log(`üì§ Sending login request to: ${apiUrl}/auth/login`, 'info');
                log(`üì§ Request body: ${JSON.stringify(loginData)}`, 'debug');

                const response = await fetch(`${apiUrl}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    credentials: 'include', // Important for cookies
                    body: JSON.stringify(loginData)
                });

                log(`üìä Login Response Status: ${response.status}`, response.ok ? 'success' : 'error');
                log(`üìä Response Headers: ${JSON.stringify(Object.fromEntries(response.headers))}`, 'debug');

                const responseText = await response.text();
                log(`üìã Login Response Body: ${responseText.substring(0, 500)}...`, 'debug');

                if (response.ok) {
                    try {
                        const jsonData = JSON.parse(responseText);
                        log('üéâ LOGIN SUCCESSFUL!', 'success');
                        log(`‚úÖ Token received: ${jsonData.token ? 'YES' : 'NO'}`, jsonData.token ? 'success' : 'error');

                        if (jsonData.token) {
                            storedToken = jsonData.token;
                            log(`üîë Token stored for testing (length: ${jsonData.token.length})`, 'success');

                            // Test token format
                            const tokenParts = jsonData.token.split('.');
                            log(`üîç Token parts: ${tokenParts.length} (should be 3 for JWT)`, tokenParts.length === 3 ? 'success' : 'error');
                        }

                        if (jsonData.user) {
                            log(`üë§ User Data:`, 'success');
                            log(`   ID: ${jsonData.user.id}`, 'success');
                            log(`   Username: ${jsonData.user.username}`, 'success');
                            log(`   Email: ${jsonData.user.email}`, 'success');
                            log(`   Role: ${jsonData.user.role}`, 'success');
                            log(`   Membership Stage: ${jsonData.user.membership_stage}`, 'success');
                        }

                        if (jsonData.redirectTo) {
                            log(`üîÑ Redirect URL: ${jsonData.redirectTo}`, 'info');
                        }

                    } catch (parseError) {
                        log(`‚ùå Failed to parse login response as JSON: ${parseError.message}`, 'error');
                        log(`üìã Raw response: ${responseText}`, 'error');
                    }
                } else {
                    log('‚ùå LOGIN FAILED', 'error');
                    log(`üìã Error response: ${responseText}`, 'error');

                    if (responseText.includes('<html') || responseText.includes('<!DOCTYPE')) {
                        log('üî¥ CRITICAL ISSUE: Login endpoint returned HTML instead of JSON!', 'error');
                        log('üî¥ This indicates the request is not reaching the API backend.', 'error');
                        log('üî¥ Check nginx configuration and routing.', 'error');
                    } else {
                        try {
                            const errorData = JSON.parse(responseText);
                            log(`‚ùå Error message: ${errorData.error || errorData.message}`, 'error');
                        } catch (e) {
                            log(`‚ùå Non-JSON error response`, 'error');
                        }
                    }
                }

            } catch (error) {
                log(`‚ùå Login Error: ${error.message}`, 'error');
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    log('üî¥ Network error - API server may be unreachable', 'error');
                }
            }
        }

        async function testProtectedRoute() {
            const apiUrl = testApiConfiguration();

            if (!storedToken) {
                log('‚ö†Ô∏è No token available - run login test first', 'error');
                return;
            }

            try {
                log('üõ°Ô∏è Testing Protected Route...', 'info');
                log(`üîë Using token: ${storedToken.substring(0, 20)}...`, 'debug');

                const response = await fetch(`${apiUrl}/auth/`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${storedToken}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    credentials: 'include'
                });

                log(`üìä Protected Route Status: ${response.status}`, response.ok ? 'success' : 'error');

                const responseText = await response.text();
                log(`üìã Protected Route Response: ${responseText.substring(0, 300)}...`, 'debug');

                if (response.ok) {
                    try {
                        const jsonData = JSON.parse(responseText);
                        log('üéâ PROTECTED ROUTE ACCESS SUCCESSFUL!', 'success');

                        if (jsonData.user) {
                            log(`‚úÖ Authenticated user: ${jsonData.user.email}`, 'success');
                            log(`‚úÖ User role: ${jsonData.user.role}`, 'success');
                        }

                    } catch (parseError) {
                        log(`‚ùå Failed to parse protected route response: ${parseError.message}`, 'error');
                    }
                } else {
                    log('‚ùå PROTECTED ROUTE ACCESS FAILED', 'error');
                    log(`üìã Error response: ${responseText}`, 'error');

                    if (response.status === 401) {
                        log('üîê Token is invalid or expired', 'error');
                    } else if (response.status === 403) {
                        log('üö´ Access forbidden - insufficient permissions', 'error');
                    }
                }

            } catch (error) {
                log(`‚ùå Protected Route Error: ${error.message}`, 'error');
            }
        }

        async function simulateReactLogin() {
            log('‚öõÔ∏è Simulating Complete React Login Flow...', 'info');

            // Step 1: Test API configuration
            testApiConfiguration();

            // Step 2: Test CORS
            await testCorsAndHeaders();

            // Step 3: Test login
            await testLogin();

            // Step 4: Test protected route if login succeeded
            if (storedToken) {
                await testProtectedRoute();

                log('üéØ Frontend Login Flow Analysis:', 'info');
                log('1. ‚úÖ API Configuration detected', 'success');
                log('2. ‚úÖ CORS headers checked', 'success');
                log('3. ‚úÖ Login request sent', storedToken ? 'success' : 'error');
                log('4. ‚úÖ Token received and stored', storedToken ? 'success' : 'error');
                log('5. ‚úÖ Protected route tested', 'success');

                if (storedToken) {
                    log('üéâ FRONTEND AUTHENTICATION FLOW IS WORKING!', 'success');
                } else {
                    log('‚ùå Frontend authentication flow has issues', 'error');
                }
            }
        }

        // Auto-run basic tests on page load
        window.onload = function() {
            log('üöÄ Frontend Authentication Test Tool Loaded', 'success');
            log('Click buttons above to run specific tests', 'info');
            log(`üåê Current URL: ${window.location.href}`, 'debug');
            log(`üåê Origin: ${window.location.origin}`, 'debug');
        };
    </script>
</body>
</html>